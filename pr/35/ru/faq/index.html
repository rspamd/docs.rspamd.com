<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-faq" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Frequently asked questions | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/pr/35/ru/faq"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Frequently asked questions | Rspamd Documentation"><meta data-rh="true" name="description" content="{:.no_toc}"><meta data-rh="true" property="og:description" content="{:.no_toc}"><link data-rh="true" rel="icon" href="/docs.rspamd.com/pr/35/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/pr/35/ru/faq"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/faq" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/ru/faq" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/faq" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Frequently asked questions","item":"https://rspamd.com/docs.rspamd.com/pr/35/ru/faq"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/pr/35/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/pr/35/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/pr/35/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/pr/35/ru/assets/js/runtime~main.3df2ef83.js" defer="defer"></script>
<script src="/docs.rspamd.com/pr/35/ru/assets/js/main.f7bfbe55.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_navbar.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs.rspamd.com/pr/35/ru/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/modules/">Modules</a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/pr/35/ru/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a></li></ul></nav><button type="button" title="Свернуть сайдбар" aria-label="Свернуть сайдбар" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/docs.rspamd.com/pr/35/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Frequently asked questions</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Frequently asked questions</h1></header>
<p>{:.no_toc}</p>
<p>This document includes some questions and practical examples that are frequently asked by Rspamd users.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-questions">General questions<a href="#general-questions" class="hash-link" aria-label="Прямая ссылка на General questions" title="Прямая ссылка на General questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-to-get-help-about-rspamd">Where to get help about Rspamd<a href="#where-to-get-help-about-rspamd" class="hash-link" aria-label="Прямая ссылка на Where to get help about Rspamd" title="Прямая ссылка на Where to get help about Rspamd">​</a></h3>
<p>The most convenient places for asking questions about Rspamd are the mailing list and Telegram group. For more information and links to these resources, please check the <a href="/docs.rspamd.com/pr/35/ru/support">support page</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-versions-of-rspamd-are-supported">What versions of Rspamd are supported<a href="#what-versions-of-rspamd-are-supported" class="hash-link" aria-label="Прямая ссылка на What versions of Rspamd are supported" title="Прямая ссылка на What versions of Rspamd are supported">​</a></h3>
<p>Rspamd typically maintains two supported branches in its git repository: the stable branch (<code>rspamd-&lt;version&gt;</code>) and the development branch (known as <code>master</code>). Stable releases are typically created from the stable branch, while unstable or <code>mainline</code> releases come from the <code>master</code> branch. When a new major release is ready to transition to the stable phase, support for the old stable branch is discontinued. Users are encouraged to migrate to the new stable branch at that point. The project does not provide support for old releases and old stable branches.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-of-the-experimental-packages">Using of the experimental packages<a href="#using-of-the-experimental-packages" class="hash-link" aria-label="Прямая ссылка на Using of the experimental packages" title="Прямая ссылка на Using of the experimental packages">​</a></h3>
<p>Experimental packages are typically created from the <code>master</code> branch and do not have precise change logs or release notes. However, all experimental packages are identified by a git hash. You can conveniently access all the changes by using the following command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git log &lt;old_hash&gt;..&lt;new_hash&gt;</span><br></span></code></pre></div></div>
<p>Experimental packages are generally regarded as less stable but are usually built once they successfully pass all internal tests. These packages often include new major and minor features that could be beneficial for your specific setup.</p>
<p>You should consider experimental packages in the following cases:</p>
<ul>
<li>You experience a significant issue with a stable package that is (likely) fixed in experimental packages.</li>
<li>You are running a small system, so you can manage the bleeding-edge version of Rspamd and can manually downgrade the package if needed (e.g., if a fresh package conflicts with your configuration).</li>
<li>You can test a new version using <a href="/docs.rspamd.com/pr/35/ru/workers/rspamd_proxy">mirroring in Rspamd proxy</a>.</li>
</ul>
<p>In fact, the last option is recommended for all users, even if you prefer to use stable packages exclusively. This approach assists in reducing stress and mitigating risks by allowing you to test new versions with your specific configuration and production traffic without impacting your live environment. The only downside is that it requires some computational and mental resources to establish a mirror for experiments, as you need to replicate your entire environment, including local configurations and Redis instances (probably with a reduced <code>maxmemory</code> limit, of course).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-rspamd-packages-are-built">How Rspamd packages are built<a href="#how-rspamd-packages-are-built" class="hash-link" aria-label="Прямая ссылка на How Rspamd packages are built" title="Прямая ссылка на How Rspamd packages are built">​</a></h3>
<p>Rspamd packages are available for a variety of <a href="/docs.rspamd.com/pr/35/ru/downloads">platforms</a>. These packages are constructed based on the following principles:</p>
<ol>
<li>Where possible, enable <code>link time optimizations</code> to enhance overall performance.</li>
<li>Bundle <a href="https://luajit.org" target="_blank" rel="noopener noreferrer">LuaJIT</a> using 2.1 beta versions from the vendor. In certain experiments, this approach has demonstrated a performance boost of up to 30% compared to the stable LuaJIT.</li>
<li>Enable jemalloc.</li>
<li>Support <a href="https://www.hyperscan.io/" target="_blank" rel="noopener noreferrer">Hyperscan</a>.</li>
</ol>
<p>It&#x27;s important to note that some of these options may not be available on older platforms like Debian wheezy, Ubuntu Precise, or CentOS 6, due to limitations in the provided software.</p>
<p>All packages are digitally signed and should be downloaded via <code>https</code>. Additionally, debugging packages are provided (such as <code>rspamd-debuginfo</code> for RPM packages and <code>rspamd-dbg</code> for DEB packages).</p>
<p>For advanced debugging needs, there are ASAN packages. These packages are built with minimal optimizations and incorporate <a href="https://en.wikipedia.org/wiki/AddressSanitizer" target="_blank" rel="noopener noreferrer">Address Sanitizer</a> for issue diagnosis. While they are significantly slower and not recommended for typical production usage (although they could be used), they are indispensable for debugging Rspamd-related problems.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resolver-setup">Resolver setup<a href="#resolver-setup" class="hash-link" aria-label="Прямая ссылка на Resolver setup" title="Прямая ссылка на Resolver setup">​</a></h3>
<p>DNS resolving is a very important part of the spam filtering process as it is a primary source of information from various DNS lists, including IP and URL blacklists, whitelists, and reputation data. In the absence of proper DNS resolution, Rspamd can become entirely non-functional and might even fail to initiate. Moreover, if you rely on your service provider&#x27;s resolver or a public resolver, you could encounter issues such as being blocked by the majority of DNS list providers or receiving inaccurate results.</p>
<p>Please keep in mind that Rspamd does NOT utilize standard resolver libraries for performance and reliability considerations. Consequently, all resolver configurations must either be static, residing in the typical <code>/etc/resolv.conf</code> or specified in <code>local.d/options.inc</code> for Rspamd&#x27;s custom resolvers. Changes to DNS resolvers require Rspamd to be reloaded or restarted. Rspamd does not currently read the <code>/etc/hosts</code> file either.</p>
<p>It&#x27;s essential to note that Rspamd can encounter issues when your provider&#x27;s DNS returns an IP address for browser redirection rather than the actual response.</p>
<p>Therefore, it is strongly advised to employ your own recursive resolver when using Rspamd or any other email-related technology. Our recommended choice is to set up Unbound or, for more advanced setups, the Knot Resolver. You can find basic setup information for Unbound <a href="https://wiki.archlinux.org/index.php/unbound" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Following that, you can configure your local resolver globally via <code>/etc/resolv.conf</code> or explicitly for Rspamd in the <code>local.d/options.inc</code> file:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/options.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver = [&quot;127.0.0.1&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>or, if you want some backup as a last resort, you can use <code>master-slave</code> <a href="/docs.rspamd.com/pr/35/ru/configuration/upstream">rotation</a> as following:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/options.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver = &quot;master-slave:127.0.0.1,8.8.8.8&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>If you use large scale DNS system you might want to set up <code>hash</code> rotation algorithm. It will significantly increase cache hit rate and reduce number of recursive queries if you have more than one upstream resolver:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/options.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nameserver = &quot;hash:10.0.0.1,10.1.0.1,10.3.0.1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Rspamd uses consistent hashing and has some tolerance to the configuration changes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-figure-out-why-rspamd-process-crashed">How to figure out why Rspamd process crashed<a href="#how-to-figure-out-why-rspamd-process-crashed" class="hash-link" aria-label="Прямая ссылка на How to figure out why Rspamd process crashed" title="Прямая ссылка на How to figure out why Rspamd process crashed">​</a></h3>
<p>Similar to other programs written in the <code>C</code> language, the most effective approach for diagnosing these issues is to obtain a <code>core</code> dump. Unfortunately, there is no universal solution suitable for all platforms. However, for FreeBSD (and potentially other BSD-like systems), Linux, or macOS, you can follow these steps:</p>
<p>To begin, create a dedicated directory for core files that is writable by all users on the system:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /coreland</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod 1777 /coreland</span><br></span></code></pre></div></div>
<p>Additionally, it&#x27;s advisable to include the following settings in <code>/etc/sysctl.conf</code> and then execute <code>sysctl -p</code> to apply them:</p>
<p><strong>Linux specific</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kernel.core_pattern=/coreland/%e.core</span><br></span></code></pre></div></div>
<p>or (with PID)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kernel.core_pattern=/coreland/%e-%p.core</span><br></span></code></pre></div></div>
<p>Also add the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kernel.core_uses_pid=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysctl fs.suid_dumpable=2</span><br></span></code></pre></div></div>
<p>You also need to install <code>debuginfo</code> package, that is called <code>rspamd-debuginfo</code> for RPM based Linux distributions and <code>rspamd-dbg</code> for Debian based ones (e.g. Ubuntu).</p>
<p><strong>FreeBSD specific</strong></p>
<p>For FreeBSD you can have either one core for all processes by setting:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kern.corefile=/coreland/%N.core</span><br></span></code></pre></div></div>
<p>or a separate core for each crash (that includes PID of process):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kern.corefile=/coreland/%N-%P.core</span><br></span></code></pre></div></div>
<p>Additional settings:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl kern.sugid_coredump=1</span><br></span></code></pre></div></div>
<p>To automatically set the variables each time the machine boots, add them to <code>/etc/sysctl.conf</code>. For instance,</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kern.corefile=/coreland/%N.core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kern.sugid_coredump=1</span><br></span></code></pre></div></div>
<p><strong>macOS specific</strong></p>
<p>The default settings in macOS disable core dumps and set the sticky bit on the macOS core dump directory /cores. As a result, core dumps can only be appended and not deleted.</p>
<p>To check the existing hard and soft settings on macOS:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sysctl -a | grep core | grep -v cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">launchctl limit | grep core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ls -ld /cores</span><br></span></code></pre></div></div>
<p>Enable core dumps on macOS, and see them in the Finder if desired:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -c unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo launchctl limit core unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># defaults write com.apple.finder AppleShowAllFiles TRUE</span><br></span></code></pre></div></div>
<p>Disable core dumps on macOS, and not show <code>/cores</code> in the Finder:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -c 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo launchctl limit core 0 unlimited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># defaults delete com.apple.finder AppleShowAllFiles</span><br></span></code></pre></div></div>
<p>Delete core dumps on macOS:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo chown root /cores/core.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo rm /cores/core.*</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="asan-builds">ASAN builds<a href="#asan-builds" class="hash-link" aria-label="Прямая ссылка на ASAN builds" title="Прямая ссылка на ASAN builds">​</a></h4>
<p>You should also consider using the <a href="/docs.rspamd.com/pr/35/ru/downloads">ASAN packages</a> if they are available for your system (or rebuild Rspamd from the sources with ASAN support, but this is significantly more complicated). In some cases, it is the only way to debug and fix your issue. Additionally, you may need an ASAN log in case of a crash. Since these logs are dumped to <code>stderr</code> by default, you might need to set a special environment variable on startup:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export ASAN_OPTIONS=&quot;log_path=/tmp/rspamd-asan&quot;</span><br></span></code></pre></div></div>
<p>Or add this to <code>systemctl edit rspamd</code> if using systemd:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=&quot;ASAN_OPTIONS=log_path=/tmp/rspamd-asan&quot;</span><br></span></code></pre></div></div>
<p>If you discover that Rspamd has crashed, you might want to utilize both the core file (backtrace from it) and the <code>/tmp/rspamd-asan.&lt;pid&gt;</code> file (where <code>&lt;pid&gt;</code> is the PID of the crashed process) to report your issue.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setting-system-limits">Setting system limits<a href="#setting-system-limits" class="hash-link" aria-label="Прямая ссылка на Setting system limits" title="Прямая ссылка на Setting system limits">​</a></h4>
<p>In distributions with traditional SysV init, you can utilize the service init file, such as <code>/etc/init.d/rspamd</code>, to enable the dumping of core files by setting the appropriate resource limit. Add the following line:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -c unlimited</span><br></span></code></pre></div></div>
<p>just after the header comment. On FreeBSD, you can use the file <code>/usr/local/etc/rc.d/rspamd</code> in the same way.</p>
<p>A good way to test the core files setup is by sending a <code>SIGILL</code> signal to a process. For example, run <code>pkill --signal 4 rspamd</code> or <code>kill -s 4 &lt;YOUR_PID&gt;</code> and then check the <code>/coreland</code> directory for a core dump.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="systemd-notes">Systemd notes<a href="#systemd-notes" class="hash-link" aria-label="Прямая ссылка на Systemd notes" title="Прямая ссылка на Systemd notes">​</a></h4>
<p>On a distro with systemd (most mainstream Linux distros), the process is a bit different. Firstly, edit the file <code>/etc/systemd/system.conf</code> and uncomment the <code>DefaultLimitCORE</code> parameter to enable systemd core dumps:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DefaultLimitCORE=infinity</span><br></span></code></pre></div></div>
<p>After this, run <code>systemctl daemon-reload</code> to reread the configuration, followed by <code>systemctl daemon-reexec</code> to apply it.</p>
<p>More information about core dumps and systemd can be found <a href="https://wiki.archlinux.org/index.php/Core_dump" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-limit-number-of-core-files">How to limit number of core files<a href="#how-to-limit-number-of-core-files" class="hash-link" aria-label="Прямая ссылка на How to limit number of core files" title="Прямая ссылка на How to limit number of core files">​</a></h3>
<p>Rspamd can halt core dumps upon reaching a specified limit. To enable this functionality, add the following lines to <code>/etc/rspamd/local.d/options.inc</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cores_dir = &quot;/coreland/&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_cores_size = 1G;</span><br></span></code></pre></div></div>
<p>This configuration limits the combined size of files in the <code>/coreland/</code> directory to 1 gigabyte. Once this limit is reached, Rspamd will cease dumping core files. (Please note that Rspamd cannot distinguish its own core files from other core files on the system.)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-can-i-do-with-core-files">What can I do with core files<a href="#what-can-i-do-with-core-files" class="hash-link" aria-label="Прямая ссылка на What can I do with core files" title="Прямая ссылка на What can I do with core files">​</a></h3>
<p>In most cases, it is sufficient to open the core file with <code>gdb</code> or another debugger, such as <code>lldb</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gdb `which rspamd` -c /coreland/rspamd.core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lldb `which rspamd` -c /coreland/rspamd.core</span><br></span></code></pre></div></div>
<p>If the core file is opened without errors, you can type <code>bt full</code> for GDB or <code>bt all</code> for LLDB in the debugger command line to obtain the full stack trace that caused this specific error.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-i-have-zero-score-for-a-spam-message">Why do I have zero score for a spam message<a href="#why-do-i-have-zero-score-for-a-spam-message" class="hash-link" aria-label="Прямая ссылка на Why do I have zero score for a spam message" title="Прямая ссылка на Why do I have zero score for a spam message">​</a></h3>
<p>This is a common question from Rspamd users. A typical log sample looks like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2018-08-27 13:23:11 #29623(normal) &lt;xxx&gt;; task; rspamd_task_write_log: id: &lt;xxx@xxx.com&gt;, qid: &lt;xxx&gt;, ip: xx.xx.xx.xx, from: &lt;info@xxx.xxx&gt;, (default: F (soft reject): [0.00/15.00] [DBL_SPAM(6.50){xxx.dbl.spamhaus.org;},URIBL_SBL_CSS(6.50){xxx.xxx;},RBL_SPAMHAUS_CSS(2.00){xx.xx.xx.xx.zen.spamhaus.org : 127.0.0.3;},RECEIVED_SPAMHAUS_CSS(1.00){116.179.76.62.zen.spamhaus.org : 127.0.0.3;},GREYLIST(0.00){greylisted;Mon, 27 Aug 2018 10:28:11 GMT;new record;}), len: xx, time: 978.464ms real, 15.045ms virtual, dns req: 45, digest: &lt;xxx&gt;, rcpts: &lt;x@x.x&gt;, mime_rcpts: &lt;x@x.x.&gt;</span><br></span></code></pre></div></div>
<p>Rspamd treats scores internally, and no external services should depend on those scores. Generally, you need to use only the <code>action</code> to decide what to do with a message. In the example above, the greylisting module decided to greylist the message to build better confidence about it. The MTA, in turn, should emit a temporary error in this case. Scores should be used to understand the decision process, but they should not be relied upon to take action on a message—this is a rule of thumb.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-my-score-is-not-a-plain-sum">Why my score is not a plain sum<a href="#why-my-score-is-not-a-plain-sum" class="hash-link" aria-label="Прямая ссылка на Why my score is not a plain sum" title="Прямая ссылка на Why my score is not a plain sum">​</a></h3>
<p>In some cases, plugins in Rspamd may trigger a <code>passthrough</code> action. In such instances, the score could be set to a specific value or to the action threshold. Starting from version 1.8.1, you will find a special record in the log:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2018-10-13 09:34:20.03286 #97398(controller) &lt;0260c3&gt;; csession; rspamd_task_write_log: id: &lt;xxxx&gt;, from: &lt;xxx&gt;, (default: T (reject): [100500.00/15.00] [RCPT_COUNT_ONE(0.00){1;},RCVD_COUNT_THREE(0.00){3;},RE_TEST(0.00){},TOP(0.00){},TO_DN_NONE(0.00){}]), len: x, time: 1ms real, 1ms virtual, dns req: 64, digest: &lt;xxx&gt;, mime_rcpts: &lt;xxx&gt;, forced: reject &quot;test&quot;; score=100500.00 (set by bla)</span><br></span></code></pre></div></div>
<p>The <code>forced:</code> section indicates what has occurred. Here is a list of plugins that can set a forced action:</p>
<ul>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/greylisting">greylist</a> - will set <code>soft reject</code> when a message needs to be greylisted</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/ratelimit">ratelimit</a> - will set <code>soft reject</code> when a ratelimit is reached</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/dmarc">dmarc</a> - might set actions if configured to do so (not enabled by default but listed in an example)</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/antivirus">antivirus</a> - can set actions if that&#x27;s explicitly set in rules</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/multimap">multimap</a> - will set actions for maps where <code>action</code> is set</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/replies">replies</a> - can set <code>no action</code> for replies if configured to do so</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/force_actions">force_actions</a> - specific module to define passthrough actions</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/spamtrap">spamtrap</a> - can set specific bypass for spamtrap</li>
<li><a href="/docs.rspamd.com/pr/35/ru/modules/metadata_exporter">metadata_exporter</a> - can set <code>soft reject</code> if cannot send reports if configured specifically</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-can-i-have-different-results-for-the-same-message">Why can I have different results for the same message<a href="#why-can-i-have-different-results-for-the-same-message" class="hash-link" aria-label="Прямая ссылка на Why can I have different results for the same message" title="Прямая ссылка на Why can I have different results for the same message">​</a></h3>
<p>If your message accumulates a <code>reject</code> score, Rspamd will halt further checks to conserve resources. However, certain checks, like network checks, might still proceed as they could be initiated before reaching the threshold for the message. Consequently, you might observe varying results (all exceeding or equal to the <code>reject</code> threshold) for the same message. To mitigate this behavior, set the HTTP header:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pass: all</span><br></span></code></pre></div></div>
<p>when sending a request to Rspamd (equivalent to the <code>-p</code> flag for the <code>rspamc</code> client).</p>
<p>Another potential reason for differing results is a too-low DNS or task timeout setting, preventing asynchronous rules from obtaining results before being terminated by a timeout. For information on the relevant options, use the following commands:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm confighelp options.dns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm confighelp options.dns_max_requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm confighelp workers.normal.task_timeout</span><br></span></code></pre></div></div>
<p>and more generally:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm confighelp -k timeout</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-debug-some-module-in-rspamd">How to debug some module in Rspamd<a href="#how-to-debug-some-module-in-rspamd" class="hash-link" aria-label="Прямая ссылка на How to debug some module in Rspamd" title="Прямая ссылка на How to debug some module in Rspamd">​</a></h3>
<p>If you&#x27;re unfamiliar with certain functionalities of Rspamd <a href="/docs.rspamd.com/pr/35/ru/modules/">modules</a>, enabling debugging for those modules can be quite beneficial. To accomplish this, include the following in your configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/logging.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug_modules = [&quot;module_name&quot;];</span><br></span></code></pre></div></div>
<p>It&#x27;s worth noting that some modules may not generate any useful debug information at this time.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-report-bugs-found-in-rspamd">How to report bugs found in Rspamd<a href="#how-to-report-bugs-found-in-rspamd" class="hash-link" aria-label="Прямая ссылка на How to report bugs found in Rspamd" title="Прямая ссылка на How to report bugs found in Rspamd">​</a></h3>
<p>If your concern pertains to system crashes, it&#x27;s crucial to acquire the core file before submitting a report. Additionally, it proves helpful to elucidate when the crash occurs and, if applicable, furnish a concise test message or the problematic configuration.</p>
<p>In instances concerning rule-related issues, we typically require a <strong>message sample</strong> that triggers the problem. To safeguard your privacy, feel free to redact irrelevant headers and content. For instance, consider anonymizing message sender/recipients, subject, and/or other fields.</p>
<p>If the issue revolves around SPF, we need the SMTP From (or Helo) and the sender&#x27;s IP address.</p>
<p>Regarding problems with statistics, DKIM, or ARC, regrettably, we require a complete message with all headers and content preserved.</p>
<p>Please note that bug reports lacking message samples will not be considered unless accompanied by either a patch or if the bug is inherently straightforward.</p>
<p>Ultimately, we strongly prefer patches/pull requests over plain bug reports.</p>
<p>For reporting bugs or making suggestions about the documentation or the website, please refer to <a href="https://github.com/rspamd/rspamd.com" target="_blank" rel="noopener noreferrer">this Github repository</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-difference-between-rspamc-and-rspamadm">What is the difference between <code>rspamc</code> and <code>rspamadm</code><a href="#what-is-the-difference-between-rspamc-and-rspamadm" class="hash-link" aria-label="Прямая ссылка на what-is-the-difference-between-rspamc-and-rspamadm" title="Прямая ссылка на what-is-the-difference-between-rspamc-and-rspamadm">​</a></h3>
<p>rspamadm is an administration tool that works with the <strong>local</strong> Rspamd daemon via a unix socket and performs management tasks. You can get help for this tool, and its options, by typing:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm help &lt;command&gt;</span><br></span></code></pre></div></div>
<p>rspamc is a client for an Rspamd remote daemon. It can communicate with an Rspamd scanner process or Rspamd controller process using the HTTP (with optional encryption) protocol, getting and displaying the results. It can do tasks such as scanning, learning and getting statistics:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc message.eml # Scan a message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_spam message.eml # Learn message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc -f 1 -w 10 fuzzy_add message.eml # Add message to fuzzy storage</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-rspamd-support-different-characters-sets">How does Rspamd support different characters sets<a href="#how-does-rspamd-support-different-characters-sets" class="hash-link" aria-label="Прямая ссылка на How does Rspamd support different characters sets" title="Прямая ссылка на How does Rspamd support different characters sets">​</a></h3>
<p>By default, Rspamd converts all messages to the <code>UTF-8</code> encoding. This conversion includes text parts (both <code>text/plain</code> and <code>text/html</code>), headers, and MIME elements (such as boundaries and filenames). If there is no information on how to convert something to <code>UTF-8</code>—for example, when there is no <code>charset</code> attribute in the <code>Content-Type</code> header or if there are some broken <code>UTF-8</code> characters—then Rspamd treats this text as raw for safety considerations. The distinction between raw and <code>UTF-8</code> text lies in the fact that for <code>UTF-8</code>, it is possible to use Unicode regular expressions by specifying the <code>/U</code> flag. For raw texts, Rspamd uses raw complementary expressions, which may lack some features.</p>
<p>It is always safe to assume that everything will be encoded in <code>UTF-8</code>; even in the case of raw messages, you might miss some particular features. There is also a module called <a href="/docs.rspamd.com/pr/35/ru/modules/chartable">chartable</a> that checks for different Unicode (or <code>ASCII</code> - non-<code>ASCII</code> characters in raw mode) symbols and tries to determine if there is an attempt to mix character sets.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-report-a-false-positive-with-fuzzy-hit">How can I report a false positive with fuzzy hit<a href="#how-can-i-report-a-false-positive-with-fuzzy-hit" class="hash-link" aria-label="Прямая ссылка на How can I report a false positive with fuzzy hit" title="Прямая ссылка на How can I report a false positive with fuzzy hit">​</a></h3>
<p>Sometimes, the fuzzy lists provided by Rspamd yield false positives (e.g., hits on legitimate messages). Here is the procedure to delist those hashes from the storage:</p>
<ol>
<li><strong>Extract the Short Hash from the Symbol</strong>: The short hash is listed in the symbol&#x27;s options for the fuzzy symbols, e.g., <code>1:xxxxxxfe7x:0.99:txt</code>. In this example, the short hash value is a hexadecimal string like <code>xxxxxxfe7x</code>.</li>
<li><strong>Search for the Log Line</strong>: In your Rspamd logs, look for lines indicating the discovery of fuzzy hashes. These lines typically contain the short hash and the full hash. Search for a log line resembling:</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">found fuzzy hash: &lt;short_hash&gt; -&gt; &lt;full_hash&gt;</span><br></span></code></pre></div></div>
<p>Here, <code>&lt;short_hash&gt;</code> is the short hash you extracted from the symbol, and <code>&lt;full_hash&gt;</code> is the full hash you want to delist.</p>
<ol start="3">
<li>
<p><strong>Use the Log Line as Context</strong>: Once you locate the log line with the full hash, use it as context when submitting the hash for delisting on bl.rspamd.com. This context will help the Rspamd team understand why you believe the hash is a false positive, providing evidence that the hash has been detected in legitimate content.</p>
</li>
<li>
<p><strong>Submit the Full Hash with Context</strong>: Visit the Rspamd Fuzzy List Submission page at <a href="https://bl.rspamd.com" target="_blank" rel="noopener noreferrer">https://bl.rspamd.com</a> and enter the full hash extracted from the logs. In the &quot;Context&quot; or &quot;Comments&quot; field, paste the log line containing the short and full hashes. This context aids the Rspamd team in understanding the situation and reviewing the delisting request more effectively.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="can-i-relearn-messages-for-fuzzy-storage-or-for-statistics">Can I relearn messages for fuzzy storage or for statistics<a href="#can-i-relearn-messages-for-fuzzy-storage-or-for-statistics" class="hash-link" aria-label="Прямая ссылка на Can I relearn messages for fuzzy storage or for statistics" title="Прямая ссылка на Can I relearn messages for fuzzy storage or for statistics">​</a></h3>
<p>If you need to move a hash from one list (e.g., blacklist) to another (e.g., whitelist), follow these steps:</p>
<ol>
<li>Use the <code>rspamc fuzzy_del</code> command for the first list (lists are identified by number).</li>
<li>Follow up with the <code>rspamc fuzzy_add</code> command:</li>
</ol>
<p>For example:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc -f 1 fuzzy_del message.eml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc -f 2 -w &lt;weight&gt; fuzzy_add message.eml</span><br></span></code></pre></div></div>
<p>If you just need to increase a score, call <code>fuzzy_add</code> with the desired score change. Note that it is not possible to decrease a score.</p>
<p>Statistics are treated differently. Rspamd maintains hashes of tokens learned in a storage called the <code>learn_cache</code>. If Rspamd finds that a particular token combination has been learned already, it performs the following actions:</p>
<ul>
<li>if the class of tokens is the same (e.g., spam and spam), Rspamd refuses to learn these tokens again.</li>
<li>otherwise, Rspamd performs a process called <code>relearning</code>:
<ul>
<li>scores in the current class are decreased for this token set.</li>
<li>scores in the opposite class are increased for this token set.</li>
<li>the class of tokens in the learn cache is updated accordingly.</li>
</ul>
</li>
</ul>
<p>All these actions are automatically performed if the <code>learn_cache</code> is enabled. It is highly recommended to enable this setting, as repeated learnings will affect the performance of the statistical module.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-some-symbols-have-different-scores-for-different-messages">Why do some symbols have different scores for different messages<a href="#why-do-some-symbols-have-different-scores-for-different-messages" class="hash-link" aria-label="Прямая ссылка на Why do some symbols have different scores for different messages" title="Прямая ссылка на Why do some symbols have different scores for different messages">​</a></h3>
<p>Rspamd supports what are known as <code>dynamic</code> symbols. In this context, a metric score is multiplied by a value, typically in the range of <code>[0..1]</code>, and then added to the scan result. For instance, the Bayes classifier introduces a score based on probability:</p>
<ul>
<li>if the probability is close to <code>50%</code>, the score is very close to 0.</li>
<li>as the probability increases in the range <code>[50% .. 75%]</code>, the score gradually rises.</li>
<li>when the probability approaches <code>90%</code>, the symbol&#x27;s score is close to 0.95, reaching 1.0 at <code>100%</code>.</li>
<li>this logic is reversed for HAM probability, with the score decreasing from <code>50%</code> to <code>0%</code> for spam probability.</li>
</ul>
<p>Many Rspamd rules, including <code>PHISHING</code> and fuzzy checks, utilize dynamic scoring.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="can-i-check-a-message-with-rspamd-without-rspamc">Can I check a message with Rspamd without rspamc<a href="#can-i-check-a-message-with-rspamd-without-rspamc" class="hash-link" aria-label="Прямая ссылка на Can I check a message with Rspamd without rspamc" title="Прямая ссылка на Can I check a message with Rspamd without rspamc">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl --data-binary @- http://localhost:11333/symbols &lt; file.eml</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-rspamd-spelled-and-capitalized">How is Rspamd spelled and capitalized?<a href="#how-is-rspamd-spelled-and-capitalized" class="hash-link" aria-label="Прямая ссылка на How is Rspamd spelled and capitalized?" title="Прямая ссылка на How is Rspamd spelled and capitalized?">​</a></h3>
<p>Rspamd, as a spam-filtering system or project, is spelled with a capital &#x27;R&#x27; followed by a lowercase &#x27;spamd.&#x27; However, when referring to the process or application, it is not capitalized.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-questions">Configuration questions<a href="#configuration-questions" class="hash-link" aria-label="Прямая ссылка на Configuration questions" title="Прямая ссылка на Configuration questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-get-my-configuration">How to get my configuration<a href="#how-to-get-my-configuration" class="hash-link" aria-label="Прямая ссылка на How to get my configuration" title="Прямая ссылка на How to get my configuration">​</a></h3>
<p>You can achieve this with the <code>rspamadm configdump</code> command. This command links all files together and displays the configuration as Rspamd observes it internally.</p>
<p>To convert it to JSON, use the <code>-j</code> flag. If you want to preserve comments, pass the <code>-c</code> flag. You can also dump specific parts of the configuration by typing:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm configdump multimap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm configdump worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm configdump classifier</span><br></span></code></pre></div></div>
<p>Configuration snippets are often requested when reporting issues found in Rspamd, especially if you are using a non-standard configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-get-the-list-of-the-enabled-plugins">How to get the list of the enabled plugins<a href="#how-to-get-the-list-of-the-enabled-plugins" class="hash-link" aria-label="Прямая ссылка на How to get the list of the enabled plugins" title="Прямая ссылка на How to get the list of the enabled plugins">​</a></h3>
<p>You can use <code>rspamadm configdump -m</code> to check or <code>rspamadm configwizard</code> to check and probably configure some of the plugins.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-change-score-for-some-symbol">How to change score for some symbol<a href="#how-to-change-score-for-some-symbol" class="hash-link" aria-label="Прямая ссылка на How to change score for some symbol" title="Прямая ссылка на How to change score for some symbol">​</a></h3>
<p>Unfortunately, it&#x27;s not a straightforward question. If you are using the <a href="/docs.rspamd.com/pr/35/webui/">WebUI</a>, it redefines all scores and action thresholds. Once you set a symbol&#x27;s score in WebUI, changing it through other means becomes challenging (you can achieve it by modifying or removing the file <code>$DBDIR/rspamd_dynamic</code>, typically located at <code>/var/lib/rspamd_dynamic</code> or <code>/var/db/rspamd_dynamic</code> depending on your OS).</p>
<p>If you intend to modify a symbol&#x27;s score in the configuration, you should do it in the <code>local.d/groups.conf</code> file. This can be accomplished using the following syntax:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/groups.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symbols {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;SOME_SYMBOL&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight = 1.0; # Define your weight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Despite of the name of this file, this syntax does not change the group of the symbol, but it changes it&#x27;s weight. You can also define your own symbols groups in this file:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">group &quot;mygroup&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max_score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbols {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;MY_SYMBOL&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      weight = 1.0; # Define your weight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>To redefine symbols for existing groups, it is recommended to use a specific <code>local.d</code> or <code>override.d</code> file, for example, <code>local.d/rbl_group.conf</code> to add your custom RBLs. To get the full list of such files, you can refer to the <code>groups.conf</code> file in the main Rspamd configuration directory (e.g., <code>/etc/rspamd/groups.conf</code>).</p>
<p>You can check your new scores by using <code>rspamadm configdump -g</code> from version 2.5: this command shows all Rspamd groups, symbols, and their scores. You can add the flag <code>-j</code> for JSON output and use the <code>jq</code> tool to operate with the output.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rspamd-configuration-nesting">Rspamd configuration nesting<a href="#rspamd-configuration-nesting" class="hash-link" aria-label="Прямая ссылка на Rspamd configuration nesting" title="Прямая ссылка на Rspamd configuration nesting">​</a></h3>
<p>Have you added an extra <code>section_name {}</code> to <code>local.d/section.conf</code> file? For example, this one will <strong>NOT</strong> work:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/dkim_signing.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dkim_signing { # !!!! DO NOT ADD THIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> domain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The correct version is the following:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/dkim_signing.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">domain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Rspamd now also reports about this sort of nesting on configuration load and in <code>rspamadm configtest</code> as well.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rspamd-paths">Rspamd paths<a href="#rspamd-paths" class="hash-link" aria-label="Прямая ссылка на Rspamd paths" title="Прямая ссылка на Rspamd paths">​</a></h3>
<p>There are several variables defined in the UCL configuration parser, and they are also exported via the <code>rspamd_paths</code> global table in Lua code, available everywhere. Here are the default meanings and values for those paths (with <code>${PREFIX}</code> denoting the default installation prefix, e.g., <code>/usr</code>):</p>
<ul>
<li><code>CONFDIR</code> = <code>${PREFIX}/etc/rspamd</code> - main path for the configuration</li>
<li><code>LOCAL_CONFDIR</code> = <code>${PREFIX}/etc/rspamd</code> - path for the user-defined configuration</li>
<li><code>RUNDIR</code> = OS specific (<code>/var/run/rspamd</code> on Linux) - used to store volatile runtime data (e.g. PIDs)</li>
<li><code>DBDIR</code> = OS specific (<code>/var/lib/rspamd</code> on Linux) - used to store static runtime data (e.g. databases or cached files)</li>
<li><code>SHAREDIR</code> = <code>${PREFIX}/share/rspamd</code> - used to store shared files</li>
<li><code>LOGDIR</code> = OS specific (<code>/var/log/rspamd</code> on Linux) - used to store Rspamd logs in file logging mode</li>
<li><code>LUALIBDIR</code> = <code>${SHAREDIR}/lualib</code> - used to store shared Lua files (included in Lua path)</li>
<li><code>PLUGINSDIR</code> = <code>${SHAREDIR}/plugins</code> - used to place Lua plugins</li>
<li><code>RULESDIR</code> = <code>${SHAREDIR}/rules</code> - used to place Lua rules</li>
<li><code>LIBDIR</code> = <code>${PREFIX}/lib/rspamd</code> - used to place shared libraries (included in RPATH and Lua CPATH)</li>
<li><code>WWWDIR</code> = <code>${SHAREDIR}/www</code> - used to store static WebUI files</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-rspamd-actions">What are Rspamd actions<a href="#what-are-rspamd-actions" class="hash-link" aria-label="Прямая ссылка на What are Rspamd actions" title="Прямая ссылка на What are Rspamd actions">​</a></h3>
<p>Unlike SpamAssassin, Rspamd <strong>suggests</strong> the desired action for a specific message scanned. This could be treated as a recommendation to MTA what it should do with this message. Here is a list of possible choices that are sent by Rspamd:</p>
<ul>
<li><code>discard</code>: drop an email but return success for sender (should be used merely in special cases)</li>
<li><code>reject</code>: ultimately reject message</li>
<li><code>rewrite subject</code>: rewrite subject to indicate spam</li>
<li><code>add header</code>: add specific header to indicate spam</li>
<li><code>no action</code>: allow message</li>
<li><code>soft reject</code>: temporarily delay message (this is used, for instance, to greylist or ratelimit messages)</li>
</ul>
<p>From version 1.9, there are also some more actions:</p>
<ul>
<li><code>quarantine</code>: push a message to quarantine (must be supported by MTA)</li>
<li><code>discard</code>: silently discard a message</li>
</ul>
<p>From version 1.9, you can also define any action you&#x27;d like with its own threshold or use that in the <code>force_actions</code> module:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">actions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Generic threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_action = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score = 9.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Force action only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  phishing = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags = [&quot;no_threshold&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This might be a bit confusing, but internally Rspamd operates with rules. Each rule can add a positive or negative score to the result. Therefore, it is required to have some thresholds for actions that are applied to a message. These thresholds are defined in the <code>actions</code> section:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">actions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reject = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  add_header = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  greylist = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>As you can see, it is slightly different from the real actions list. The name <code>actions</code> should actually be treated as <code>score thresholds</code>, but it has this name historically. As you can see, there is no <code>discard</code> and <code>soft reject</code> actions, but there is a very special <code>greylist</code> element that specifies the score threshold for the greylisting plugin.</p>
<p>Thresholds usually define when this or that action should be applied. However, some modules can directly set a specific action without regard to the score-based thresholds. Hence, you should never rely on the score when making a decision about what to do with a message scanned by Rspamd. In short, you should always use the action and use scoring just to specify <strong>generic</strong> thresholds and for debugging purposes. There is completely <strong>no guarantee</strong> that the score, action threshold, and the real action will match for a message.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-local-and-override-config-files">What are local and override config files<a href="#what-are-local-and-override-config-files" class="hash-link" aria-label="Прямая ссылка на What are local and override config files" title="Прямая ссылка на What are local and override config files">​</a></h3>
<p>Historically, Rspamd provided user-editable configuration files. However, as the project developed, it became clear that this idea had certain drawbacks. Rspamd configuration defines the overall filtering quality, performance, and other important characteristics. However, it is extremely difficult to maintain merging of local and updated configurations with new releases of Rspamd. Hence, we have decided to add two recommended ways to apply local changes:</p>
<ol>
<li>Override configurations</li>
<li>Local configurations</li>
</ol>
<p>An override configuration (<code>/etc/rspamd/rspamd.conf.override</code>) is used to ultimately redefine the default values in Rspamd. In this file, you can redefine <strong>whole sections</strong> of the default configuration. For example, if you have a module <code>example</code> defined in the default configuration as follows:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">example {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option1 = &quot;value&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option2 = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>and you wanted to override <code>option2</code> by adding the following to <code>/etc/rspamd/rspamd.conf.override</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">example {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option2 = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>this might work unexpectedly: the new config would have an <code>example</code> section with a single key <code>option2</code>, while <code>option1</code> would be ignored. The global local file, namely <code>rspamd.conf.local</code>, has the same limitation: you can add your configuration there but you should <strong>NOT</strong> redefine anything from the default configuration or it will just be ignored. The only exception to this rule is the <em>metric</em> section. So you could use something like:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">metric &quot;default&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbol &quot;MY_SYMBOL&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;my rule&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>and add this to the <code>rspamd.conf.local</code> (but not override).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-the-locald-and-overrided-directories">What are the local.d and override.d directories<a href="#what-are-the-locald-and-overrided-directories" class="hash-link" aria-label="Прямая ссылка на What are the local.d and override.d directories" title="Прямая ссылка на What are the local.d and override.d directories">​</a></h3>
<p>From Rspamd version 1.2 onwards, the default configuration provides two more ways to extend or redefine each configuration file shipped with Rspamd. Each section definition includes two files with different priorities:</p>
<ul>
<li><code>/etc/rspamd/local.d/&lt;conf_file&gt;</code> - included with priority <code>1</code> that allows you to redefine and extend the default rules; but <code>dynamic updates</code> or items redefined via the WebUI will have higher priority and can redefine the values included</li>
<li><code>/etc/rspamd/override.d/&lt;conf_file&gt;</code> - included with priority <code>10</code> that allows you to redefine all other things that could change configuration in Rspamd</li>
</ul>
<p>The types of settings which can be merged are collections (<code>{}</code>) and lists (<code>[]</code>); other settings would be effectively overridden by either file.</p>
<p>An important difference from the global override and local rules is that these files are included within each section. Here is an example of utilizing local.d for the <code>modules.d/example.conf</code> configuration file:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">example {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # WebUI include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .include(try=true,priority=5) &quot;${DBDIR}/dynamic/example.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Local include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .include(try=true,priority=1) &quot;$LOCAL_CONFDIR/local.d/example.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Override include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .include(try=true,priority=10) &quot;$LOCAL_CONFDIR/override.d/example.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option1 = &quot;value&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option2 = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>in <code>local.d/example.conf</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">option2 = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option3 = 1.0;</span><br></span></code></pre></div></div>
<p>in <code>override.d/example.conf</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">option3 = 2.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option4 = [&quot;something&quot;];</span><br></span></code></pre></div></div>
<p>and the target configuration (that you could see using <code>rspamadm configdump example</code>):</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">example {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option1 = &quot;value&quot;; # From default settings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option2 = false; # From local.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option3 = 2.0; # Local is overridden by override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  option4 = [&quot;something&quot;]; # From override.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Here is another example with more complicated structures inside. Here is the original configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># orig.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;something&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key1 = value1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key2 = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subkey1 = &quot;subvalue1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;other&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key3 = value3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>and there is some <code>local.d/orig.conf</code> that looks like this:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/orig.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;something&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key1 = other_value; # overwrite &quot;value1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key2 = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subkey2 = &quot;subvalue2&quot;; # append new value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;local&quot; { # add new rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_local = &quot;value_local&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>then we will have the following merged configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># config with local.d/orig.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;something&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key1 = other_value; # from local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key2 = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subkey1 = &quot;subvalue1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subkey2 = &quot;subvalue2&quot;; # from local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;other&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key3 = value3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;local&quot; { # from local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_local = &quot;value_local&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>If you have the same config but in <code>override.d</code> directory, then it will <strong>completely</strong> override all rules defined in the original file:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># config with override.d/orig.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;something&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key1 = other_value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key2 = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subkey2 = &quot;subvalue2&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_local = &quot;value_local&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This may seem complex, but it facilitates smoother updates and streamlines automatic management. If you&#x27;re uncertain about your configuration, refer to the output of the <code>rspamadm configdump</code> command, which presents the target configuration with numerous available options. Additionally, you can use the <code>rspamadm confighelp</code> command to access help for various Rspamd options.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-rspamdconflocal-and-rspamdconfoverride">What are rspamd.conf.local and rspamd.conf.override<a href="#what-are-rspamdconflocal-and-rspamdconfoverride" class="hash-link" aria-label="Прямая ссылка на What are rspamd.conf.local and rspamd.conf.override" title="Прямая ссылка на What are rspamd.conf.local and rspamd.conf.override">​</a></h3>
<p>While <code>override.d</code> and <code>local.d</code> modify entries within block elements, <code>rspamd.conf.local</code> and <code>rspamd.conf.override</code> act on entire blocks (<code>{}</code>).</p>
<p>The key difference lies in how these files modify the configuration. <code>rspamd.conf.local</code> adds or merges config elements (useful for setting custom metrics, for instance), while <code>rspamd.conf.override</code> adds or replaces config elements (useful for completely redefining settings).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-maps">What are maps<a href="#what-are-maps" class="hash-link" aria-label="Прямая ссылка на What are maps" title="Прямая ссылка на What are maps">​</a></h3>
<p>Maps are files that contain lists of keys or key-value pairs that Rspamd can dynamically reload when changed. The significant distinction from configuration elements is that map reloading is done &#x27;live&#x27; without an expensive restart procedure. Additionally, Rspamd can monitor both file and HTTP maps for changes (modification time for files and HTTP <code>If-Modified-Since</code> header for HTTP maps). Currently, Rspamd supports <code>HTTP</code> and <code>file</code> maps.</p>
<p>All maps operate in a similar way, providing you with choices on how to define a map:</p>
<ol>
<li>Plain path to file or http (like <code>map = &quot;http://example.com/file.txt&quot;</code> or <code>map = &quot;/tmp/mymap&quot;</code>)</li>
<li>Composite path like <code>map = [&quot;http://example.com/file.txt&quot;, &quot;/tmp/mymap&quot;]</code>. Maps data is concatenated from the sources.</li>
<li>An embedded map like <code>map = [&quot;foo bar&quot;];</code> or <code>map = [&quot;foo 1&quot;, &quot;bar b&quot;, &quot;baz bababa&quot;]</code> or <code>map = [&quot;192.168.1.1/24&quot;, &quot;10.0.0.0/8&quot;]</code></li>
<li>A fully decomposed object with lots of options</li>
</ol>
<p>For the second option, it is also possible to have a composite path with fallback:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exceptions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;https://maps.rspamd.com/rspamd/2tld.inc.zst&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;${DBDIR}/2tld.inc.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;fallback+file://${CONFDIR}/2tld.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">];</span><br></span></code></pre></div></div>
<p>In the example above, <code>fallback+file://${CONFDIR}/2tld.inc</code> will be used when the first composite backend is somehow unreachable (e.g. when first load of Rspamd or all elements are invalid).</p>
<p>Bear in mind that (1) and (3) can only be distinguished by making an array like <code>map = [&quot;192.168.1.1/24&quot;]</code>
Historically, just for radix map (ipnetwork ones) you could also use <code>map = &quot;192.168.1.1/24&quot;</code>, but it is not recommended.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-mapsrspamdcom-maintained">How is maps.rspamd.com maintained<a href="#how-is-mapsrspamdcom-maintained" class="hash-link" aria-label="Прямая ссылка на How is maps.rspamd.com maintained" title="Прямая ссылка на How is maps.rspamd.com maintained">​</a></h3>
<p>The Rspamd source code refers to some online maps from <code>maps.rspamd.com</code>.</p>
<p>These are maintained in <a href="https://github.com/rspamd/maps" target="_blank" rel="noopener noreferrer">https://github.com/rspamd/maps</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-can-be-in-the-maps">What can be in the maps<a href="#what-can-be-in-the-maps" class="hash-link" aria-label="Прямая ссылка на What can be in the maps" title="Прямая ссылка на What can be in the maps">​</a></h3>
<p>Maps can have the following objects:</p>
<ul>
<li>spaces and one line comments started by <code>#</code> symbols</li>
<li>keys</li>
<li>optional values separated by a space character</li>
<li>keys with spaces enclosed in double quotes</li>
<li>keys with slashes (regular expressions) enclosed in slashes</li>
<li>IP addresses with optional mask</li>
</ul>
<p>Here are some examples:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key1 # Single key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Comment ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Empty line ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key2 1 # Key and value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key3 with space&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key with \&quot; escaped&quot; value with spaces</span><br></span></code></pre></div></div>
<p>Regexp maps:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/regexp/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/regexp/is some other value</span><br></span></code></pre></div></div>
<p>IP maps:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.1 # Mask is /32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[::1] # Mask is /128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[::1]/64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.1/19</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-http-maps-are-loaded">How HTTP maps are loaded<a href="#how-http-maps-are-loaded" class="hash-link" aria-label="Прямая ссылка на How HTTP maps are loaded" title="Прямая ссылка на How HTTP maps are loaded">​</a></h3>
<p>There is a difference between a hot start and a cold start:</p>
<ul>
<li>on a hot start, Rspamd reuses cached maps for HTTP maps (including their <code>Cache-Control/ETag</code> attributes), so it starts using them immediately after the start.</li>
<li>on a cold start (when new maps are added or when <code>/var/lib/rspamd</code> is cleaned), Rspamd fetches maps right after workers are started. There could be a gap, and this might be covered by the <code>file+fallback</code> backend option if map downtime is unacceptable.</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;https://maps.rspamd.com/rspamd/spf_dkim_whitelist.inc.zst&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;$LOCAL_CONFDIR/local.d/maps.d/spf_dkim_whitelist.inc.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;${DBDIR}/spf_dkim_whitelist.inc.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;fallback+file://${CONFDIR}/maps.d/spf_dkim_whitelist.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">];</span><br></span></code></pre></div></div>
<p>In this case, the first three backends will be used when the HTTP map is available, and all the data will be joined together. The final location defines a cold startup fallback, which will be replaced when/if the HTTP map is downloaded.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-sign-maps">How to sign maps<a href="#how-to-sign-maps" class="hash-link" aria-label="Прямая ссылка на How to sign maps" title="Прямая ссылка на How to sign maps">​</a></h3>
<p>From Rspamd version 1.2 onwards, each map can have a digital signature using the <code>EdDSA</code> algorithm. To sign a map, you can use <code>rspamadm signtool</code>, and to generate a signing keypair, use <code>rspamadm keypair -s -u</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   pubkey = &quot;zo4sejrs9e5idqjp8rn6r3ow3x38o8hi5pyngnz6ktdzgmamy48y&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   privkey = &quot;pwq38sby3yi68xyeeuup788z6suqk3fugrbrxieri637bypqejnqbipt1ec9tsm8h14qerhj1bju91xyxamz5yrcrq7in8qpsozywxy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   id = &quot;bs4zx9tcf1cs5ed5mt4ox8za54984frudpzzny3jwdp8mkt3feh7nz795erfhij16b66piupje4wooa5dmpdzxeh5mi68u688ixu3yd&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   type = &quot;sign&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Then you can use <code>signtool</code> to edit the map file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm signtool -e --editor=vim -k &lt;keypair_file&gt; &lt;map_file&gt;</span><br></span></code></pre></div></div>
<p>To enforce signing policies, you should add a <code>sign+</code> string to your map definition:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;sign+http://example.com/map&quot;</span><br></span></code></pre></div></div>
<p>To specify the trusted key you could either put the <strong>public</strong> key from the keypair in the <code>local.d/options.inc</code> file as following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trusted_keys = [&quot;&lt;public key string&gt;&quot;];</span><br></span></code></pre></div></div>
<p>or add it as a <code>key</code> definition in the map string:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;sign+key=&lt;key_string&gt;+http://example.com/map&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-one-shot-rules">What are one-shot rules<a href="#what-are-one-shot-rules" class="hash-link" aria-label="Прямая ссылка на What are one-shot rules" title="Прямая ссылка на What are one-shot rules">​</a></h3>
<p>In Rspamd, a rule has the potential to be triggered multiple times. Consider a scenario where a message contains 10 URLs, and 8 of them match entries in a URL blacklist, identified by their unique top-level domain (TLD). In this situation, Rspamd would apply the URIBL rule 8 times for the same message. However, there are instances where this behaviour may not be desired. In such cases, simply include <code>one_shot = true</code> in the symbol&#x27;s definition within the metric for that symbol, and the symbol will not be redundantly added multiple times.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-use-of-symbol-groups">What is the use of symbol groups<a href="#what-is-the-use-of-symbol-groups" class="hash-link" aria-label="Прямая ссылка на What is the use of symbol groups" title="Прямая ссылка на What is the use of symbol groups">​</a></h3>
<p>Symbol groups serve the purpose of grouping similar rules together, proving particularly beneficial when employing group names in composite expressions like <code>gr:&lt;group_name&gt;</code>. Additionally, it is viable to establish a collective limit for the score of a specific group:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">group &quot;test&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbol &quot;test1&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbol &quot;test2&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max_score = 15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In this instance, should both <code>test1</code> and <code>test2</code> trigger, their combined score will not exceed <code>15</code>.</p>
<p>To review your group configuration in version 2.5 and beyond, utilize the command <code>rspamadm configdump -g</code>. This command provides a comprehensive display of all Rspamd groups, symbols, and their associated scores. For JSON output, include the <code>-j</code> flag and employ the <code>jq</code> tool for further manipulation of the output.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-are-some-symbols-missing-in-the-metric-configuration">Why are some symbols missing in the metric configuration<a href="#why-are-some-symbols-missing-in-the-metric-configuration" class="hash-link" aria-label="Прямая ссылка на Why are some symbols missing in the metric configuration" title="Прямая ссылка на Why are some symbols missing in the metric configuration">​</a></h3>
<p>It is now feasible to establish rules entirely through Lua, enabling the configuration of all essential attributes without the need to modify the configuration files. Nevertheless, it remains possible to override the default scores in any configuration file. Here is an illustrative example of such a rule:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LONG_SUBJ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> sbj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Subject&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> sbj </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">strlen_utf8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sbj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  group </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;headers&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Subject is too long&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You can use the same approach when writing rules in <code>rspamd.local.lua</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-disable-some-rspamd-rules-safely">How can I disable some Rspamd rules safely<a href="#how-can-i-disable-some-rspamd-rules-safely" class="hash-link" aria-label="Прямая ссылка на How can I disable some Rspamd rules safely" title="Прямая ссылка на How can I disable some Rspamd rules safely">​</a></h3>
<p>The best way is to add a condition for the specific symbol. This could be done, for example, in <code>/etc/rspamd/rspamd.local.lua</code>:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">add_condition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SOME_SYMBOL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>While more intricate conditions can be introduced, this particular one stands out as the simplest in terms of rule management and upgrades.</p>
<p>Furthermore, you have the option to dynamically enable or disable symbols selectively through the <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">settings module</a>.</p>
<p>To deactivate an entire module, simply set <code>enabled = false</code> in its configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-disable-some-rspamd-action">How can I disable some Rspamd action<a href="#how-can-i-disable-some-rspamd-action" class="hash-link" aria-label="Прямая ссылка на How can I disable some Rspamd action" title="Прямая ссылка на How can I disable some Rspamd action">​</a></h3>
<p>You can dynamically enable/disable actions with <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">settings module</a>. From version 1.8.1, you can set <code>null</code> to some module there:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  some_settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authenticated = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      actions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rewrite_subject = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-disable-greylisting">How can I disable greylisting<a href="#how-can-i-disable-greylisting" class="hash-link" aria-label="Прямая ссылка на How can I disable greylisting" title="Прямая ссылка на How can I disable greylisting">​</a></h3>
<p>Just disable <code>greylisting</code> module by adding the following configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/greylist.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enabled = false;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="can-i-scan-outgoing-mail-with-rspamd">Can I scan outgoing mail with Rspamd<a href="#can-i-scan-outgoing-mail-with-rspamd" class="hash-link" aria-label="Прямая ссылка на Can I scan outgoing mail with Rspamd" title="Прямая ссылка на Can I scan outgoing mail with Rspamd">​</a></h3>
<p>Certainly, Rspamd is designed to be inherently secure for outbound scanning by default. For detailed information, please refer to <a href="/docs.rspamd.com/pr/35/ru/tutorials/scanning_outbound">this documentation</a>.</p>
<p>It&#x27;s important to note that this mode is activated <strong>by default</strong> for both <strong>authenticated</strong> senders and senders originating from <strong>local networks</strong> (located in options.inc -&gt; local_networks). The default settings for local networks encompass connections initiated from both loopback/unix sockets and RFC 1918 private networks, such as <code>10.0.0.0/8</code> or <code>192.168.0.0/16</code>. For outbound checks, numerous checks are deactivated. Therefore, exercise caution to prevent unintentional activation of this mode, for instance, by neglecting to use XCLIENT on a proxy MTA or when employing a backup MX.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="can-i-just-sign-messages-using-dkim">Can I just sign messages using DKIM<a href="#can-i-just-sign-messages-using-dkim" class="hash-link" aria-label="Прямая ссылка на Can I just sign messages using DKIM" title="Прямая ссылка на Can I just sign messages using DKIM">​</a></h3>
<p>Yes, use <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">user settings</a> and enable just <code>DKIM_SIGN</code> symbol (and <code>DKIM_SIGNED</code> in case if <code>dkim_signing</code> module is used), e.g.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rspamd.conf.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">settings { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sign_id {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id = &quot;dkim&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      symbols_enabled = [&quot;DKIM_SIGNED&quot;]; # add ARC_SIGNED for ARC signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flags = [&quot;skip_process&quot;]; # To skip message processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sign_authenticated {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authenticated = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      symbols_enabled = [&quot;DKIM_SIGNED&quot;]; # add ARC_SIGNED for ARC signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flags = [&quot;skip_process&quot;]; # To skip message processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sign_networks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip = [&quot;172.16.0.0/16&quot;, &quot;10.0.0.0/8&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      symbols_enabled = [&quot;DKIM_SIGNED&quot;]; # add ARC_SIGNED for ARC signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flags = [&quot;skip_process&quot;]; # To skip message processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In this example, we deactivate all checks, except for the DKIM/ARC check and signing. This configuration is effective for authenticated users, local networks (two networks specified in this instance), or when a specific HTTP header is provided during a manual check:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc --header=&quot;settings-id=dkim&quot; message.eml</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="administration-questions">Administration questions<a href="#administration-questions" class="hash-link" aria-label="Прямая ссылка на Administration questions" title="Прямая ссылка на Administration questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-can-i-find-all-configuration-options-supported-by-rspamd">Where can I find all configuration options supported by Rspamd<a href="#where-can-i-find-all-configuration-options-supported-by-rspamd" class="hash-link" aria-label="Прямая ссылка на Where can I find all configuration options supported by Rspamd" title="Прямая ссылка на Where can I find all configuration options supported by Rspamd">​</a></h3>
<p>To obtain a description of the options supported by Rspamd, utilise the <code>rspamadm confighelp</code> command. You can either specify a particular option or path, such as <code>rspamadm confighelp options</code>, or conduct a keyword search with commands like <code>rspamadm confighelp -k servers</code>. Refer to <code>rspamadm help confighelp</code> for the comprehensive list of command line options associated with this command.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-read-rspamd-logs">How to read Rspamd logs<a href="#how-to-read-rspamd-logs" class="hash-link" aria-label="Прямая ссылка на How to read Rspamd logs" title="Прямая ссылка на How to read Rspamd logs">​</a></h3>
<p>Rspamd logs are augmented, meaning that each log line normally includes a <code>tag</code> which can help to figure out log lines that are related to, for example, a specific task:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># fgrep &#x27;b120f6&#x27; /var/log/rspamd/rspamd.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2016-03-18 15:15:01 #29588(normal) &lt;b120f6&gt;; task; accept_socket: accepted connection from 127.0.0.1 port 52870</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2016-03-18 15:15:01 #29588(normal) &lt;b120f6&gt;; task; rspamd_message_parse: loaded message; id: &lt;201603181414.u2IEEfKL062480@repo.freebsd.org&gt;; queue-id: &lt;D4CFE300135&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2016-03-18 15:15:01 #29588(normal) &lt;b120f6&gt;; task; rspamd_task_write_log: id: &lt;201603181414.u2IEEfKL062480@repo.freebsd.org&gt;, qid: &lt;D4CFE300135&gt;, ip: 2001:1900:2254:206a::19:2, from: &lt;owner-ports-committers@freebsd.org&gt;, (default: F (no action): [-2.11/15.00] [MIME_GOOD,R_SPF_ALLOW,RCVD_IN_DNSWL_HI,MAILLIST,BAYES_HAM,FANN_SCORE,FORGED_RECIPIENTS_MAILLIST,FORGED_SENDER_MAILLIST]), len: 6849, time: 538.803ms real, 26.851ms virtual, dns req: 22</span><br></span></code></pre></div></div>
<p>Normally, you might want to check the final log line, for example, <code>rspamd_task_write_log</code> and subsequently find the tag which is <code>b120f6</code> in this example. Thereafter, you can check all log messages that are associated with this message.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="can-i-customize-log-output-for-logger">Can I customize log output for logger<a href="#can-i-customize-log-output-for-logger" class="hash-link" aria-label="Прямая ссылка на Can I customize log output for logger" title="Прямая ссылка на Can I customize log output for logger">​</a></h3>
<p>Certainly, the <code>logging.inc</code> file includes a <code>log_format</code> option. The following configuration snippet proves useful as it enables the inclusion of additional information compared to the default output from the Rspamd logger:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/logging.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log_format =&lt;&lt;EOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">id: &lt;$mid&gt;, $if_qid{ qid: &lt;$&gt;,} ip: [$ip], $if_user{ user: $,} smtp_from: &lt;$smtp_from&gt;, mime_from: &lt;$mime_from&gt;, smtp_rcpts: &lt;$smtp_rcpts&gt;, mime_rcpts: &lt;$mime_rcpts&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(default: $is_spam ($action): [$scores] [$symbols_scores]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">len: $len, time: $time_real real,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$time_virtual virtual, dns req: $dns_req, url domains:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$lua{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return function(task)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local fun = require &quot;fun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local domains = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local unique = fun.filter(function(dom)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if not domains[dom] then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          domains[dom] = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end, fun.map(function(url) return url:get_host() end, task:get_urls()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local s = table.concat(fun.totable(unique), &#x27;,&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOD</span><br></span></code></pre></div></div>
<p>As evident, you have the flexibility to employ both embedded log variables and Lua code for tailoring log output. Further details can be found in the <a href="/docs.rspamd.com/pr/35/ru/configuration/logging">logger documentation</a>.</p>
<p>For obtaining debug information on a specific module in Rspamd, the <code>debug_modules</code> option within the logging configuration proves to be a valuable resource:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/logging.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug_modules = [&quot;spf&quot;];</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="which-backend-should-i-use-for-statistics">Which backend should I use for statistics<a href="#which-backend-should-i-use-for-statistics" class="hash-link" aria-label="Прямая ссылка на Which backend should I use for statistics" title="Прямая ссылка на Which backend should I use for statistics">​</a></h3>
<p>Currently, we recommend using <code>redis</code> for the statistics and fuzzy storage backend.</p>
<p>For those with existing statistics in <code>sqlite</code>, you can seamlessly convert them using the <code>rspamadm statconvert</code> routine:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rspamadm statconvert --spam-db /var/lib/rspamd/bayes.spam.sqlite --symbol-spam BAYES_SPAM --ham-db /var/lib/rspamd/bayes.ham.sqlite --symbol-ham BAYES_HAM -h localhost</span><br></span></code></pre></div></div>
<p>Importing the learn cache should be done only once.</p>
<p>A notable constraint of the redis backend is its lack of support for per-language statistics. However, it&#x27;s worth noting that this feature is typically unnecessary in the majority of cases. The mechanism for per-user statistics in redis differs from that in sqlite. Detailed information is available in the <a href="/docs.rspamd.com/pr/35/ru/configuration/statistic">relevant documentation</a>.</p>
<p>Additionally, you can convert the fuzzy storage using <code>rspamadm fuzzyconvert</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rspamadm fuzzyconvert -d fuzzy.db -h 127.0.0.1:6379 -e 7776000</span><br></span></code></pre></div></div>
<p>Finally, you need to change the default <code>sqlite</code> backend to <code>redis</code> and restart rspamd.</p>
<p>local.d/classifier-bayes.conf:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">backend = &quot;redis&quot;;</span><br></span></code></pre></div></div>
<p>override.d/worker-fuzzy.inc:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">backend = &quot;redis&quot;;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-redis-keys-are-used-by-rspamd">What Redis keys are used by Rspamd<a href="#what-redis-keys-are-used-by-rspamd" class="hash-link" aria-label="Прямая ссылка на What Redis keys are used by Rspamd" title="Прямая ссылка на What Redis keys are used by Rspamd">​</a></h3>
<p>The statistics module employs <code>&lt;SYMBOL&gt;&lt;username&gt;</code> as keys, with statistical tokens stored within a corresponding hash table bearing the same name. Conversely, the <code>ratelimit</code> module utilises a distinct key for each value stored in Redis, as elaborated in the <a href="/docs.rspamd.com/pr/35/ru/modules/ratelimit">ratelimit module documentation</a>. The DMARC module follows suit, employing multiple keys to store cumulative reports, assigning a separate key for each domain.</p>
<p>It is advisable to establish limits for dynamic Rspamd data stored in Redis, encompassing ratelimits, IP reputation, and DMARC reports. For greater flexibility, you may opt to employ a separate Redis instance for statistical tokens, setting distinct limits or utilising separate databases by specifying the <code>db</code> parameter during the setup of the redis backend.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-delete-multiple-redis-keys-matching-a-glob-style-pattern">How to delete multiple Redis keys matching a glob-style pattern<a href="#how-to-delete-multiple-redis-keys-matching-a-glob-style-pattern" class="hash-link" aria-label="Прямая ссылка на How to delete multiple Redis keys matching a glob-style pattern" title="Прямая ссылка на How to delete multiple Redis keys matching a glob-style pattern">​</a></h3>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli [-p 6379] --scan --pattern &#x27;rn_SHORT_*&#x27; | xargs redis-cli unlink</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-run-rspamd-using-unix-sockets">How to run Rspamd using Unix sockets<a href="#how-to-run-rspamd-using-unix-sockets" class="hash-link" aria-label="Прямая ссылка на How to run Rspamd using Unix sockets" title="Прямая ссылка на How to run Rspamd using Unix sockets">​</a></h3>
<p>From <a href="https://github.com/rspamd/rspamd/issues/1905" target="_blank" rel="noopener noreferrer">https://github.com/rspamd/rspamd/issues/1905</a></p>
<p><strong>Redis</strong></p>
<p><code>/etc/redis/rspamd.conf</code>  (changes only)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bind 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unixsocket /var/run/redis/rspamd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unixsocketperm 770</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile /var/run/redis/rspamd.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logfile /var/log/redis/rspamd.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dir /var/lib/redis/rspamd/</span><br></span></code></pre></div></div>
<p>Ensure the directory <code>/var/lib/redis/rspamd</code> is created and granted write permissions for the user <code>redis</code>.</p>
<p>If there is a necessity to initiate a distinct <code>Redis</code> instance specifically for <code>Rspamd</code>, refer to <a href="https://medium.com/@MauroMorales/running-multiple-redis-on-a-server-472518f3b603" target="_blank" rel="noopener noreferrer">these instructions</a>.</p>
<p><code>/etc/rspamd/local.d/redis.conf</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">servers = &quot;/var/run/redis/rspamd.sock&quot;;</span><br></span></code></pre></div></div>
<p><code>/etc/rspamd/local.d/classifier-bayes.conf</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">backend = &quot;redis&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autolearn = true;</span><br></span></code></pre></div></div>
<p>Don&#x27;t overlook the step of adding the user <code>_rspamd</code> to the <code>redis</code> group by executing the command <code>usermod -a -G redis _rspamd</code>.</p>
<p>To verify the connection, you can use the following command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">myserver:~ # redis-cli -s /run/redis/rspamd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis /run/redis/rspamd.sock&gt; ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PONG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis /run/redis/rspamd.sock&gt; monitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722016.014458 [0 unix:/var/run/redis/rspamd.sock] &quot;SMEMBERS&quot; &quot;BAYES_HAM_keys&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722018.522879 [0 unix:/var/run/redis/rspamd.sock] &quot;SMEMBERS&quot; &quot;BAYES_SPAM_keys&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722018.523305 [0 unix:/var/run/redis/rspamd.sock] &quot;HLEN&quot; &quot;BAYES_SPAM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722018.523334 [0 unix:/var/run/redis/rspamd.sock] &quot;HGET&quot; &quot;BAYES_SPAM&quot; &quot;learns&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722024.892442 [0 unix:/var/run/redis/rspamd.sock] &quot;SMEMBERS&quot; &quot;BAYES_SPAM_keys&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722024.892870 [0 unix:/var/run/redis/rspamd.sock] &quot;HLEN&quot; &quot;BAYES_SPAM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1509722024.892899 [0 unix:/var/run/redis/rspamd.sock] &quot;HGET&quot; &quot;BAYES_SPAM&quot; &quot;learns&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p><strong>Nginx</strong></p>
<p><code>/etc/tmpfiles.d/rspamd.conf</code>  (create this file if needed and run <code>systemd-tmpfiles --create</code>)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">d  /var/run/rspamd  0755  _rspamd  _rspamd  -</span><br></span></code></pre></div></div>
<p><code>/etc/rspamd/local.d/worker-controller.inc</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bind_socket = &quot;/run/rspamd/worker-controller.socket mode=0660 owner=_rspamd group=www&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">password = &quot;$2$paparrytknfm8...&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_password = &quot;$2$paparrytknfm8...&quot;;</span><br></span></code></pre></div></div>
<p><code>nginx.conf</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">location /rspamd/ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth_basic &quot;Restricted Area&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth_basic_user_file /srv/www/.mydomain.tld.htpasswd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map $status $loggable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ~^[23]  0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log /var/log/nginx/rspamd.access.log combined if=$loggable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_log /var/log/nginx/rspamd.error.log warn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_pass http://unix:/run/rspamd/worker-controller.socket:/;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header Host $host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-data-should-be-backed-up">What data should be backed up?<a href="#what-data-should-be-backed-up" class="hash-link" aria-label="Прямая ссылка на What data should be backed up?" title="Прямая ссылка на What data should be backed up?">​</a></h3>
<p>The following directories and files should be included in a backup:</p>





























<table><thead><tr><th>Data</th><th>Location</th></tr></thead><tbody><tr><td>Main configuration directory</td><td><code>CONFDIR</code> = <code>${PREFIX}/etc/rspamd</code></td></tr><tr><td>User-defined configuration directory</td><td><code>LOCAL_CONFDIR</code> = <code>${PREFIX}/etc/rspamd</code></td></tr><tr><td>Static runtime data (e.g. databases)<sup><a href="#Backup_fn1">1</a></sup></td><td><code>DBDIR</code><sup><a href="#Backup_fn2">2</a></sup>: OS specific, <code>/var/lib/rspamd</code> or <code>/var/db/rspamd</code></td></tr><tr><td>Redis configuration</td><td>OS specific, <code>/etc/redis/redis.conf</code> or <code>/usr/local/etc/redis.conf</code><sup><a href="#Backup_fn3">3</a></sup></td></tr><tr><td>Redis database(s)</td><td>OS specific, <code>/var/lib/redis/dump.rdb</code> or <code>/var/db/redis/dump.rdb</code>.<sup><a href="#Backup_fn3">3</a>,<a href="#Backup_fn4">4</a></sup></td></tr></tbody></table>
<p><a name="Backup_fn1">1</a>: You don&#x27;t need to backup cached files: Hyperscan cache files ( <code>*.hs</code>, <code>*.hsmp</code>) and Rspamd maps (<code>*.map</code>) as they will be recreated by Rspamd.</p>
<p><a name="Backup_fn2">2</a>: Some modules allow to set paths for their static data (e.g. ARC and DKIM keys locations) outside the <code>DBDIR</code>. Make sure you have included these custom directories in the backup.</p>
<p><a name="Backup_fn3">3</a>: For multi-instance Redis please consult your Redis configuration.</p>
<p><a name="Backup_fn4">4</a>: Copying RDB files is completely safe while the server is running. You don&#x27;t have to stop <code>redis</code> or <code>rspamd</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-am-i-getting-errors-after-moving-rspamd-to-a-different-platform-cpu-type">Why am I getting errors after moving Rspamd to a different platform (CPU type)?<a href="#why-am-i-getting-errors-after-moving-rspamd-to-a-different-platform-cpu-type" class="hash-link" aria-label="Прямая ссылка на Why am I getting errors after moving Rspamd to a different platform (CPU type)?" title="Прямая ссылка на Why am I getting errors after moving Rspamd to a different platform (CPU type)?">​</a></h3>
<ul>
<li>Hyperscan cannot utilise cache files built for a different platform. Ensure to delete Hyperscan cache files (<code>*.hs</code>, <code>*.hsmp</code>). Failure to do so may result in errors such as:</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cannot open hyperscan cache file /var/lib/rspamd/{...}.hs: compiled for a different platform</span><br></span></code></pre></div></div>
<ul>
<li>Unfortunately, transferring RRD files directly between different architectures is not feasible. Attempting to do so will result in errors appearing in the log:</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...; csession; rspamd_controller_handle_graph: no rrd configured</span><br></span></code></pre></div></div>
<p>and WebUI alerts:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cannot receive throughput data: error 404 No rrd configured for graphs</span><br></span></code></pre></div></div>
<p>To convert RRD, you need to dump the <code>rspamd.rrd</code> file on the server that created it to XML using <code>rrdtool</code>:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rrdtool dump rspamd.rrd &gt; rspamd.rrd.xml</span><br></span></code></pre></div></div>
<p>Then transfer it to the new server and restore it to a binary RRD:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># rrdtool restore -f rspamd.rrd.xml rspamd.rrd</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="plugin-questions">Plugin questions<a href="#plugin-questions" class="hash-link" aria-label="Прямая ссылка на Plugin questions" title="Прямая ссылка на Plugin questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-whitelist-messages-or-skip-spam-checks-for-certain-users">How to whitelist messages or skip spam checks for certain users<a href="#how-to-whitelist-messages-or-skip-spam-checks-for-certain-users" class="hash-link" aria-label="Прямая ссылка на How to whitelist messages or skip spam checks for certain users" title="Прямая ссылка на How to whitelist messages or skip spam checks for certain users">​</a></h3>
<p>You have several options available. Firstly, if you require establishing a whitelist based on <code>SPF</code>, <code>DKIM</code>, or <code>DMARC</code> policies, consider consulting the <a href="/docs.rspamd.com/pr/35/ru/modules/whitelist">whitelist module</a>. Alternatively, the <a href="/docs.rspamd.com/pr/35/ru/modules/multimap">multimap module</a> provides various checks to add symbols based on list matches or to set pre-actions, allowing you to either reject or permit specific messages.</p>
<p>An alternative is to deactivate spam filtering for certain senders or recipients through <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">user settings</a>. By specifying <code>symbols_enabled = [];</code>, Rspamd will bypass all filtering rules that meet specific conditions set in the user settings. It&#x27;s worth noting that the use of the more potent <code>want_spam = yes</code> can be potentially <a href="https://github.com/rspamd/rspamd/issues/3552" target="_blank" rel="noopener noreferrer">confusing</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-blacklist-messages-based-on-extension">How to blacklist messages based on extension<a href="#how-to-blacklist-messages-based-on-extension" class="hash-link" aria-label="Прямая ссылка на How to blacklist messages based on extension" title="Прямая ссылка на How to blacklist messages based on extension">​</a></h3>
<p>In this example, we want to blacklist the following extensions using the <a href="/docs.rspamd.com/pr/35/ru/modules/multimap">multimap module</a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lnk</span><br></span></code></pre></div></div>
<p>Then define the following multimap rule in <code>local.d/multimap.conf</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">file_extension_blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;filename&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;extension&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/local.d/file_extensions.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbol = &quot;FILE_EXTENSION_BLACKLISTED&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefilter = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;reject&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message = &quot;attachment type not allowed&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># skip_archives = true; # Uncomment if filenames in archives should be excluded from this check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-filters-pre-filters-and-post-filters">What are filters, pre-filters and post-filters<a href="#what-are-filters-pre-filters-and-post-filters" class="hash-link" aria-label="Прямая ссылка на What are filters, pre-filters and post-filters" title="Прямая ссылка на What are filters, pre-filters and post-filters">​</a></h3>
<p>Rspamd executes various types of filters depending on the stage of execution:</p>
<ul>
<li><code>pre-filters</code> run before any other processes and can establish a <code>pre-result</code> that ultimately determines the message classification. Filters and post-filters are bypassed in this scenario.</li>
<li><code>filters</code> encompass generic Rspamd rules.</li>
<li><code>post-filters</code> are assured to execute after all filters, allowing the implementation of actions dependent on the scan results.</li>
<li><code>idempotent post-filters</code> operate after all stages and <strong>MUST NOT</strong> alter the metric result in any manner; these filters can be utilised for historical purposes.</li>
</ul>
<p>The overall execution order in Rspamd follows this sequence:</p>
<ol>
<li>pre-filters</li>
<li>filters</li>
<li>classifiers</li>
<li>composite symbols</li>
<li>post-filters</li>
<li>autolearn rules</li>
<li>composites second pass (from 1.7)</li>
<li>idempotent rules (from 1.7)</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-meaning-of-the-uribl_blocked-symbol">What is the meaning of the <code>URIBL_BLOCKED</code> symbol<a href="#what-is-the-meaning-of-the-uribl_blocked-symbol" class="hash-link" aria-label="Прямая ссылка на what-is-the-meaning-of-the-uribl_blocked-symbol" title="Прямая ссылка на what-is-the-meaning-of-the-uribl_blocked-symbol">​</a></h3>
<p>This symbol indicates that you have surpassed the permissible limit of DNS queries for non-commercial use as specified by SURBL services. If you are currently using a public DNS server, such as Google Public DNS, consider switching to your local DNS resolver or establishing one, for instance, using <a href="https://www.unbound.net/" target="_blank" rel="noopener noreferrer">Unbound</a>. Alternatively, if you prefer to continue using the service, it is advisable to procure a <a href="http://www.surbl.org/df" target="_blank" rel="noopener noreferrer">commercial subscription</a> to avoid any disruption. The <code>URIBL_BLOCKED</code> symbol carries a weight of 0 and is solely employed to notify you of this issue.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-use-commercial-feeds-for-surblrbl-others">How can I use commercial feeds for SURBL/RBL others<a href="#how-can-i-use-commercial-feeds-for-surblrbl-others" class="hash-link" aria-label="Прямая ссылка на How can I use commercial feeds for SURBL/RBL others" title="Прямая ссылка на How can I use commercial feeds for SURBL/RBL others">​</a></h3>
<p>The most straightforward approach is to employ your own local resolver with forward zones directed towards a dedicated rbldnsd instance or instances that serve static zones from various vendors, such as Spamhaus or SURBL. Below is an example configuration snippet for the <code>Unbound</code> caching resolver:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">forward-zone:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: &quot;sbl.spamhaus.org.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forward-addr: x.x.x.x # Your rbldnsd instance IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forward-addr: y.y.y.y # Secondary server if needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forward-first: yes</span><br></span></code></pre></div></div>
<p>Additionally, you have the option to modify suffixes in the Rspamd configuration to incorporate custom ones, such as premium zones. To implement this, utilise either <code>local.d/rbl.conf</code> or <code>local.d/surbl.conf</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-monitored-checks">What are monitored checks<a href="#what-are-monitored-checks" class="hash-link" aria-label="Прямая ссылка на What are monitored checks" title="Прямая ссылка на What are monitored checks">​</a></h3>
<p>Rspamd conducts periodic checks on diverse DNS lists to preempt potential issues arising from anomalies in DNS responses, such as unexpected redirects instead of NXDOMAIN errors from your nameserver. Additionally, it monitors the lists themselves to prevent scenarios where certain lists mistakenly blacklist extensive portions of the Internet, as has occurred in the past with specific lists.</p>
<p>Consequently, Rspamd queries the following addresses:</p>
<ul>
<li><code>1.0.0.127.rbl.tld</code> - this <strong>MUST</strong> return <code>NXDOMAIN</code> for all RBLs</li>
<li><code>facebook.com.uribl.tld</code> - it is highly unlikely that any sane URIBL would ever block Facebook, hence, this query is used to check URL black lists sanity</li>
</ul>
<p>If the monitored checks prove unsuccessful, Rspamd will deactivate the affected resource and subsequently reattempt these checks after a designated period (approximately 1 minute). Upon successful checks, the resource will be re-enabled.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-i-have-monitored-errors-in-my-log-files">Why do I have <code>monitored</code> errors in my log files<a href="#why-do-i-have-monitored-errors-in-my-log-files" class="hash-link" aria-label="Прямая ссылка на why-do-i-have-monitored-errors-in-my-log-files" title="Прямая ссылка на why-do-i-have-monitored-errors-in-my-log-files">​</a></h3>
<p>Some users complain about log lines like the following ones:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;xxx&gt;; monitored; rspamd_monitored_dns_cb: DNS reply returned &#x27;no error&#x27; for multi.uribl.com while &#x27;no records with this name&#x27; was expected</span><br></span></code></pre></div></div>
<p>This error typically indicates that you are restricted on <code>uribl.com</code>, suggesting that you might be relying on a public DNS resolver, such as Google DNS. If you are not using a public resolver but experience substantial mail traffic, it&#x27;s possible that you have exceeded the <code>free band</code> for URIBL. In such a scenario, you may want to explore the <a href="http://www.surbl.org/df" target="_blank" rel="noopener noreferrer">commercial subscription</a> option. Nevertheless, it is advisable to utilise dedicated resolvers rather than public ones, as detailed in the <a href="/docs.rspamd.com/pr/35/ru/configuration/options#dns-options">DNS setup documentation</a>.</p>
<p>The second potential cause of this error is a malfunction in RBL/URLBL, wherein it produces positive results for queries that should not be flagged, such as <code>facebook.com</code> or <code>127.0.0.1</code>. This indicates a significant issue with the DNS list.</p>
<p>The third reason may lie with your DNS server. Occasionally, DNS servers may furnish false responses for queries that are not found, redirecting users to a search or informational page. In such instances, Rspamd cannot function optimally and will deactivate DNSBL lookups. It is recommended to consider employing your own forwarding DNS server in such cases.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-meaning-of-the-message-like-inv_chi_square-exp-overflow">What is the meaning of the message like <code>inv_chi_square: exp overflow</code><a href="#what-is-the-meaning-of-the-message-like-inv_chi_square-exp-overflow" class="hash-link" aria-label="Прямая ссылка на what-is-the-meaning-of-the-message-like-inv_chi_square-exp-overflow" title="Прямая ссылка на what-is-the-meaning-of-the-message-like-inv_chi_square-exp-overflow">​</a></h3>
<p>This message usually means that some statistics class is overflowed with tokens and another one is underflowed. You should consider to learn more messages from both Spam and Ham classes for Bayes classifier.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-learn-messages">How can I learn messages<a href="#how-can-i-learn-messages" class="hash-link" aria-label="Прямая ссылка на How can I learn messages" title="Прямая ссылка на How can I learn messages">​</a></h3>
<p>Utilise the <code>rspamc learn_spam</code> and <code>rspamc learn_ham</code> commands to train the Spam and Ham classes, respectively. It&#x27;s crucial to maintain a nearly equal number of learned messages for both classes to enhance the statistical engine&#x27;s performance. Learning necessitates the <code>enable</code> level for the controller, and you must specify either an <code>enable_password</code> or employ the <code>secure_ip</code> setting to permit learning and other modifications from specific IP addresses.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-learn-rspamd-automatically">How to learn Rspamd automatically<a href="#how-to-learn-rspamd-automatically" class="hash-link" aria-label="Прямая ссылка на How to learn Rspamd automatically" title="Прямая ссылка на How to learn Rspamd automatically">​</a></h3>
<p>Please check the <a href="/docs.rspamd.com/pr/35/ru/configuration/statistic#autolearning">following document</a> for more details.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-faster-between-custom-lua-rules-and-regular-expressions">What is faster between custom Lua rules and regular expressions<a href="#what-is-faster-between-custom-lua-rules-and-regular-expressions" class="hash-link" aria-label="Прямая ссылка на What is faster between custom Lua rules and regular expressions" title="Прямая ссылка на What is faster between custom Lua rules and regular expressions">​</a></h3>
<p>Migrating from C to Lua can incur expenses. Consequently, it is advisable to utilise regular expressions for straightforward checks whenever feasible. If Rspamd is compiled with <a href="https://www.hyperscan.io/" target="_blank" rel="noopener noreferrer">Hyperscan</a>, the addition of another regular expression is typically cost-effective. However, it&#x27;s essential to avoid constructs not supported by Hyperscan, such as backtracking, lookbehind, and some <a href="http://intel.github.io/hyperscan/dev-reference/compilation.html#unsupported-constructs" target="_blank" rel="noopener noreferrer">others</a>. Conversely, Lua offers distinct functions that regular expressions do not cover. In such instances, it is recommended to opt for Lua.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="webui-questions">WebUI questions<a href="#webui-questions" class="hash-link" aria-label="Прямая ссылка на WebUI questions" title="Прямая ссылка на WebUI questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-enable_password-and-password-for-the-webui">What are <code>enable_password</code> and <code>password</code> for the WebUI<a href="#what-are-enable_password-and-password-for-the-webui" class="hash-link" aria-label="Прямая ссылка на what-are-enable_password-and-password-for-the-webui" title="Прямая ссылка на what-are-enable_password-and-password-for-the-webui">​</a></h3>
<p>Rspamd can limit the functions available through the WebUI in three ways:</p>
<ol>
<li>Allow read-only commands when <code>password</code> is specified</li>
<li>Allow all commands when <code>enable_password</code> is specified</li>
<li>Allow all commands when client IP address matches the <code>secure_ip</code> list in the controller configuration</li>
</ol>
<p>When <code>password</code> is specified but <code>enable_password</code> is missing then <code>password</code> is used for <strong>both</strong> read and write commands.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-store-passwords-securely">How to store passwords securely<a href="#how-to-store-passwords-securely" class="hash-link" aria-label="Прямая ссылка на How to store passwords securely" title="Прямая ссылка на How to store passwords securely">​</a></h3>
<p>Rspamd has the capability to encrypt passwords and store them using <a href="https://en.wikipedia.org/wiki/PBKDF2" target="_blank" rel="noopener noreferrer">PBKDF2</a> or <a href="https://www.uni-weimar.de/de/medien/professuren/mediensicherheit/research/catena/" target="_blank" rel="noopener noreferrer">Catena</a>. Since version <code>1.4</code>, Catena is employed by default as it offers enhanced resistance to brute-force attacks by necessitating additional memory for computation (memory-hard function). To leverage this feature, employ the <code>rspamadm pw</code> command as illustrated below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm pw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enter passphrase:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$1$jhicbyeuiktgikkks7in6mecr5bycmok$boniuegw5zfc77pfbqf14bjdxmzd3yajnngwdekzwhjk1daqjixb</span><br></span></code></pre></div></div>
<p>Subsequently, you can utilise the resulting string (formatted as <code>$&lt;algorithm_id&gt;$&lt;salt&gt;$&lt;encrypted_data&gt;</code>) as either the <code>password</code> or <code>enable_password</code>. It is important to note that this command generates <strong>distinct</strong> encrypted strings even for identical passwords, which is the intended behaviour.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-the-webui-behind-a-proxy-server">How to use the WebUI behind a proxy server<a href="#how-to-use-the-webui-behind-a-proxy-server" class="hash-link" aria-label="Прямая ссылка на How to use the WebUI behind a proxy server" title="Прямая ссылка на How to use the WebUI behind a proxy server">​</a></h3>
<p>Here is an example for nginx:</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:rgb(222, 71, 0)">location</span><span class="token directive"> /rspamd/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">proxy_pass</span><span class="token directive">       http://localhost:11334/</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">proxy_set_header</span><span class="token directive"> Host      </span><span class="token directive variable" style="color:#36acaa">$host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">proxy_set_header</span><span class="token directive"> X-Real-IP </span><span class="token directive variable" style="color:#36acaa">$remote_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">proxy_set_header</span><span class="token directive"> X-Forwarded-For </span><span class="token directive string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Corresponding Apache configuration:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;Location /rspamd&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:rgb(222, 71, 0)">IfVersion</span><span class="token tag" style="color:rgb(222, 71, 0)"> </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">= 2.3&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Require all granted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:rgb(222, 71, 0)">IfVersion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:rgb(222, 71, 0)">IfVersion</span><span class="token tag" style="color:rgb(222, 71, 0)"> </span><span class="token tag attr-name" style="color:rgb(222, 71, 0)">&lt;</span><span class="token tag" style="color:rgb(222, 71, 0)"> </span><span class="token tag attr-name" style="color:rgb(222, 71, 0)">2.3</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Order allow,deny</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Allow from all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:rgb(222, 71, 0)">IfVersion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:rgb(222, 71, 0)">Location</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RewriteRule ^/rspamd$ /rspamd/ [R,L]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RewriteRule ^/rspamd/(.*) http://localhost:11334/$1 [P,L]</span><br></span></code></pre></div></div>
<p>When a connection originates from an IP listed in <code>secure_ip</code> or from a Unix socket, Rspamd examines two headers: <code>X-Forwarded-For</code> and, if not found, <code>X-Real-IP</code>. If either of these headers is present, Rspamd treats the connection as if it originates from the IP specified in that header. For instance, if <code>X-Real-IP: 8.8.8.8</code> is present, it will prompt checks against <code>secure_ip</code> for <code>8.8.8.8</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-does-the-webui-store-settings">Where does the WebUI store settings<a href="#where-does-the-webui-store-settings" class="hash-link" aria-label="Прямая ссылка на Where does the WebUI store settings" title="Прямая ссылка на Where does the WebUI store settings">​</a></h3>
<p>The WebUI sends <code>AJAX</code> requests for Rspamd and Rspamd can store data in a <code>dynamic_conf</code> file. By default, it is defined in <code>options.inc</code> as following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dynamic_conf = &quot;$DBDIR/rspamd_dynamic&quot;;</span><br></span></code></pre></div></div>
<p>Rspamd loads symbols and actions settings from this file with priority 5 which allows you to redefine those settings in an override configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-cant-i-edit-some-maps-with-the-webui">Why can&#x27;t I edit some maps with the WebUI<a href="#why-cant-i-edit-some-maps-with-the-webui" class="hash-link" aria-label="Прямая ссылка на Why can&#x27;t I edit some maps with the WebUI" title="Прямая ссылка на Why can&#x27;t I edit some maps with the WebUI">​</a></h3>
<p>The map file may lack adequate permissions or not exist. It&#x27;s noteworthy that the WebUI disregards all <code>HTTP</code> maps. Additionally, the editing of signed maps is not yet supported.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-setup-cluster-in-webui">How to setup cluster in WebUI<a href="#how-to-setup-cluster-in-webui" class="hash-link" aria-label="Прямая ссылка на How to setup cluster in WebUI" title="Прямая ссылка на How to setup cluster in WebUI">​</a></h3>
<p>You need to add neighbours list to the global options configuration.</p>
<p>Please see the <a href="/docs.rspamd.com/pr/35/ru/configuration/options#neighbours-list">Rspamd options settings</a> for details.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-does-the-user-column-show-undefined">Why does the User column show &#x27;undefined&#x27;?<a href="#why-does-the-user-column-show-undefined" class="hash-link" aria-label="Прямая ссылка на Why does the User column show &#x27;undefined&#x27;?" title="Прямая ссылка на Why does the User column show &#x27;undefined&#x27;?">​</a></h3>
<p>The User column shows the authenticated username of the message sender- you would have to be scanning authenticated outbound mail to see something here.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-exclude-rows-from-the-history-tab">How to exclude rows from the History tab?<a href="#how-to-exclude-rows-from-the-history-tab" class="hash-link" aria-label="Прямая ссылка на How to exclude rows from the History tab?" title="Прямая ссылка на How to exclude rows from the History tab?">​</a></h3>
<p>To exclude some rows from the <code>History</code> tab you could add a <strong>minus sign</strong>  (<strong>-</strong>) before a query value (<code>IP-address</code>, <code>Envelope From</code>, etc) in the <code>Search</code> field, like this one: <code>-sender@test.ru</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lua-questions">Lua questions<a href="#lua-questions" class="hash-link" aria-label="Прямая ссылка на Lua questions" title="Прямая ссылка на Lua questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-difference-between-plugins-and-rules">What is the difference between plugins and rules<a href="#what-is-the-difference-between-plugins-and-rules" class="hash-link" aria-label="Прямая ссылка на What is the difference between plugins and rules" title="Прямая ссылка на What is the difference between plugins and rules">​</a></h3>
<p>Rules are designed to conduct straightforward checks and provide either <code>true</code> when the rule matches or <code>false</code> when it doesn&#x27;t. Typically, rules cannot execute asynchronous requests or insert multiple symbols. While theoretically possible, it&#x27;s advisable to register plugins using <code>rspamd_config:register_symbol</code> functions for such tasks. Plugins are anticipated to independently insert results using the <code>task:insert_result</code> method.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-table-form-of-a-function-call">What is table form of a function call<a href="#what-is-table-form-of-a-function-call" class="hash-link" aria-label="Прямая ссылка на What is table form of a function call" title="Прямая ссылка на What is table form of a function call">​</a></h3>
<p>The difference between table and sequential forms is simple:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- sequential form</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  param1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  param2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  param3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  param4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- table form</span><br></span></code></pre></div></div>
<p>Historically, all Lua methods used the sequential call type. Nevertheless, this approach has evolved and now offers several advantages:</p>
<ul>
<li>Eliminates the need to remember the exact <strong>order</strong> of arguments.</li>
<li>Provides a <code>name = value</code> pair, aiding in debugging.</li>
<li>Facilitates the extension of methods with new features while maintaining backward compatibility.</li>
<li>Simplifies the inclusion of <strong>optional</strong> arguments.</li>
</ul>
<p>However, it is important to note a drawback: table calls incur slightly higher computational costs. Despite this, the difference is negligible in the majority of cases. Consequently, Rspamd now supports the table form for most functions that accept more than two or three arguments. The allowed forms for a specific function can be referenced in the <a href="/docs.rspamd.com/pr/35/ru/lua/">documentation</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-rspamd-modules">How to use rspamd modules<a href="#how-to-use-rspamd-modules" class="hash-link" aria-label="Прямая ссылка на How to use rspamd modules" title="Прямая ссылка на How to use rspamd modules">​</a></h3>
<p>Use a <code>require</code> statement:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rspamd_logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&#x27;rspamd_logger&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rspamd_regexp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&#x27;rspamd_regexp&#x27;</span><br></span></code></pre></div></div>
<p>Rspamd also ships some additional lua modules which you can use in your rules:</p>
<ul>
<li><a href="https://github.com/rtsisyk/luafun" target="_blank" rel="noopener noreferrer">Lua functional</a></li>
<li><a href="https://www.inf.puc-rio.br/~roberto/lpeg/" target="_blank" rel="noopener noreferrer">Lua LPEG</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-write-to-rspamd-log">How to write to Rspamd log<a href="#how-to-write-to-rspamd-log" class="hash-link" aria-label="Прямая ссылка на How to write to Rspamd log" title="Прямая ссылка на How to write to Rspamd log">​</a></h3>
<p>The <a href="/docs.rspamd.com/pr/35/ru/lua/rspamd_logger">Rspamd logger</a> offers numerous convenient methods for logging data from Lua rules and plugins. It is advisable to explore the modern methods (with the <code>x</code> suffix) that enable the use of <code>%s</code> and <code>%1</code> .. <code>%N</code> notation. The <code>%s</code> format is employed to print the <strong>next</strong> argument, while <code>%&lt;number&gt;</code> processes a specific argument (starting from <code>1</code>):</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rspamd_logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&#x27;rspamd_logger&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">infox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s %1 %2 %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;abc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- This will show abc abc 1 [[1] = true, [2] = 1]</span><br></span></code></pre></div></div>
<p>Additionally, you can utilise other objects, such as Rspamd task or Rspamd config, to enhance logger output with a task or config logging tag.</p>
<p>Furthermore, the <code>rspamd_logger.slog</code> function serves as an alternative to the Lua standard function <code>string.format</code> when printing complex objects, such as tables.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="should-i-use-local-for-my-variables">Should I use <code>local</code> for my variables<a href="#should-i-use-local-for-my-variables" class="hash-link" aria-label="Прямая ссылка на should-i-use-local-for-my-variables" title="Прямая ссылка на should-i-use-local-for-my-variables">​</a></h3>
<p>Certainly, always opt for <code>local</code> variables unless it is absolutely necessary. Excessive use of global variables can result in considerable performance degradation for Lua scripts.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-create-regexps-in-lua">How can I create regexps in Lua<a href="#how-can-i-create-regexps-in-lua" class="hash-link" aria-label="Прямая ссылка на How can I create regexps in Lua" title="Прямая ссылка на How can I create regexps in Lua">​</a></h3>
<p>Regexp objects are special in case of Rspamd. Unlike other objects, they do not have garbage collection method and should be explicitly destroyed. For example, if you have this code:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RULE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_regexp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/re/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Memory leak here!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>In this scenario, the <code>re</code> object will persist without destruction, leading to a memory leak. To address this issue, it is crucial to consistently utilise the global regexps cache, which remains available throughout the entire Rspamd process lifetime:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RULE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_regexp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create_cached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/re/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Regexp will be reused from the cache if possible</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>The only situation when you might have a problem with this approach is when you need to create regular expressions dependent on some external data:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">blah</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Return something that depends on task properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RULE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_regexp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create_cached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">blah</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Too many regexps could be created</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>If you cannot avoid this bad pattern (and it is bad since regexp creation is an expensive procedure), then you can explicitly destroy regexp object:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">blah</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Return something that depends on task properties</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RULE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_regexp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">blah</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- This is expensive procedure!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  re</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">destroy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- frees memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>However, you should consider using regexp maps with <a href="/docs.rspamd.com/pr/35/ru/modules/multimap">multimap module</a> when you need something like this.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="integration-questions">Integration questions<a href="#integration-questions" class="hash-link" aria-label="Прямая ссылка на Integration questions" title="Прямая ссылка на Integration questions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-distinguish-inbound-and-outbound-traffic-for-rspamd-instance">How to distinguish inbound and outbound traffic for Rspamd instance<a href="#how-to-distinguish-inbound-and-outbound-traffic-for-rspamd-instance" class="hash-link" aria-label="Прямая ссылка на How to distinguish inbound and outbound traffic for Rspamd instance" title="Прямая ссылка на How to distinguish inbound and outbound traffic for Rspamd instance">​</a></h3>
<p>Starting from version 1.7.0, the proxy worker has the capability to transmit a designated header called <code>settings-id</code> during checks, applicable to both proxy and self-scan modes. This header empowers Rspamd to apply specific settings tailored to a message. Custom scores can be assigned, certain rules or rule groups can be deactivated, and more. For instance, to disable specific rules for outbound scanning, an entry in the <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">settings</a> module can be created:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outbound {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority = high;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id = &quot;outbound&quot;; # Can be omitted as the rule itself is already called `outbound`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      actions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reject = 150.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;add header&quot; = 6.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BAYES_SPAM = 7.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      groups_disabled = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;hfilter&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;spf&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;rbl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Then, we can apply this setting ID on the outbound MTA using the proxy configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upstream &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = yes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self_scan = yes; # Enable self-scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings_id = &quot;outbound&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>An alternative approach is to apply settings based on the sender being authenticated or having an IP address within a specific range. Refer to the <a href="/docs.rspamd.com/pr/35/ru/configuration/settings">documentation</a> for more details.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-restore-the-old-rmilter-spf-behaviour">How can I restore the old Rmilter SPF behaviour<a href="#how-can-i-restore-the-old-rmilter-spf-behaviour" class="hash-link" aria-label="Прямая ссылка на How can I restore the old Rmilter SPF behaviour" title="Прямая ссылка на How can I restore the old Rmilter SPF behaviour">​</a></h3>
<p>Formerly, Rmilter had the capability to reject mail that failed SPF verification for specific domains. This functionality can now be achieved using Rspamd.</p>
<p>One can establish rules in Rspamd to enforce rejection based on selected symbols, among other conditions. The DMARC module, for instance, includes built-in support for such behavior, with <a href="/docs.rspamd.com/pr/35/ru/modules/multimap">multimap</a> being a particularly versatile option.</p>
<p>For instance, add the following to <code>/etc/rspamd/rspamd.local.lua</code>:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> myfunc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">has_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;R_SPF_REJECT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">set_pre_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;reject&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;I rejected it&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;MY_REJECT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> myfunc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_dependency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;R_SPF_REJECT&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Rspamd also provides the capability to test SPF without message data, a feature not currently supported by Rmilter.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/faq.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/pr/35/ru/"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">About Rspamd</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/pr/35/ru/about/"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">About Rspamd</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#general-questions" class="table-of-contents__link toc-highlight">General questions</a><ul><li><a href="#where-to-get-help-about-rspamd" class="table-of-contents__link toc-highlight">Where to get help about Rspamd</a></li><li><a href="#what-versions-of-rspamd-are-supported" class="table-of-contents__link toc-highlight">What versions of Rspamd are supported</a></li><li><a href="#using-of-the-experimental-packages" class="table-of-contents__link toc-highlight">Using of the experimental packages</a></li><li><a href="#how-rspamd-packages-are-built" class="table-of-contents__link toc-highlight">How Rspamd packages are built</a></li><li><a href="#resolver-setup" class="table-of-contents__link toc-highlight">Resolver setup</a></li><li><a href="#how-to-figure-out-why-rspamd-process-crashed" class="table-of-contents__link toc-highlight">How to figure out why Rspamd process crashed</a></li><li><a href="#how-to-limit-number-of-core-files" class="table-of-contents__link toc-highlight">How to limit number of core files</a></li><li><a href="#what-can-i-do-with-core-files" class="table-of-contents__link toc-highlight">What can I do with core files</a></li><li><a href="#why-do-i-have-zero-score-for-a-spam-message" class="table-of-contents__link toc-highlight">Why do I have zero score for a spam message</a></li><li><a href="#why-my-score-is-not-a-plain-sum" class="table-of-contents__link toc-highlight">Why my score is not a plain sum</a></li><li><a href="#why-can-i-have-different-results-for-the-same-message" class="table-of-contents__link toc-highlight">Why can I have different results for the same message</a></li><li><a href="#how-to-debug-some-module-in-rspamd" class="table-of-contents__link toc-highlight">How to debug some module in Rspamd</a></li><li><a href="#how-to-report-bugs-found-in-rspamd" class="table-of-contents__link toc-highlight">How to report bugs found in Rspamd</a></li><li><a href="#what-is-the-difference-between-rspamc-and-rspamadm" class="table-of-contents__link toc-highlight">What is the difference between <code>rspamc</code> and <code>rspamadm</code></a></li><li><a href="#how-does-rspamd-support-different-characters-sets" class="table-of-contents__link toc-highlight">How does Rspamd support different characters sets</a></li><li><a href="#how-can-i-report-a-false-positive-with-fuzzy-hit" class="table-of-contents__link toc-highlight">How can I report a false positive with fuzzy hit</a></li><li><a href="#can-i-relearn-messages-for-fuzzy-storage-or-for-statistics" class="table-of-contents__link toc-highlight">Can I relearn messages for fuzzy storage or for statistics</a></li><li><a href="#why-do-some-symbols-have-different-scores-for-different-messages" class="table-of-contents__link toc-highlight">Why do some symbols have different scores for different messages</a></li><li><a href="#can-i-check-a-message-with-rspamd-without-rspamc" class="table-of-contents__link toc-highlight">Can I check a message with Rspamd without rspamc</a></li><li><a href="#how-is-rspamd-spelled-and-capitalized" class="table-of-contents__link toc-highlight">How is Rspamd spelled and capitalized?</a></li></ul></li><li><a href="#configuration-questions" class="table-of-contents__link toc-highlight">Configuration questions</a><ul><li><a href="#how-to-get-my-configuration" class="table-of-contents__link toc-highlight">How to get my configuration</a></li><li><a href="#how-to-get-the-list-of-the-enabled-plugins" class="table-of-contents__link toc-highlight">How to get the list of the enabled plugins</a></li><li><a href="#how-to-change-score-for-some-symbol" class="table-of-contents__link toc-highlight">How to change score for some symbol</a></li><li><a href="#rspamd-configuration-nesting" class="table-of-contents__link toc-highlight">Rspamd configuration nesting</a></li><li><a href="#rspamd-paths" class="table-of-contents__link toc-highlight">Rspamd paths</a></li><li><a href="#what-are-rspamd-actions" class="table-of-contents__link toc-highlight">What are Rspamd actions</a></li><li><a href="#what-are-local-and-override-config-files" class="table-of-contents__link toc-highlight">What are local and override config files</a></li><li><a href="#what-are-the-locald-and-overrided-directories" class="table-of-contents__link toc-highlight">What are the local.d and override.d directories</a></li><li><a href="#what-are-rspamdconflocal-and-rspamdconfoverride" class="table-of-contents__link toc-highlight">What are rspamd.conf.local and rspamd.conf.override</a></li><li><a href="#what-are-maps" class="table-of-contents__link toc-highlight">What are maps</a></li><li><a href="#how-is-mapsrspamdcom-maintained" class="table-of-contents__link toc-highlight">How is maps.rspamd.com maintained</a></li><li><a href="#what-can-be-in-the-maps" class="table-of-contents__link toc-highlight">What can be in the maps</a></li><li><a href="#how-http-maps-are-loaded" class="table-of-contents__link toc-highlight">How HTTP maps are loaded</a></li><li><a href="#how-to-sign-maps" class="table-of-contents__link toc-highlight">How to sign maps</a></li><li><a href="#what-are-one-shot-rules" class="table-of-contents__link toc-highlight">What are one-shot rules</a></li><li><a href="#what-is-the-use-of-symbol-groups" class="table-of-contents__link toc-highlight">What is the use of symbol groups</a></li><li><a href="#why-are-some-symbols-missing-in-the-metric-configuration" class="table-of-contents__link toc-highlight">Why are some symbols missing in the metric configuration</a></li><li><a href="#how-can-i-disable-some-rspamd-rules-safely" class="table-of-contents__link toc-highlight">How can I disable some Rspamd rules safely</a></li><li><a href="#how-can-i-disable-some-rspamd-action" class="table-of-contents__link toc-highlight">How can I disable some Rspamd action</a></li><li><a href="#how-can-i-disable-greylisting" class="table-of-contents__link toc-highlight">How can I disable greylisting</a></li><li><a href="#can-i-scan-outgoing-mail-with-rspamd" class="table-of-contents__link toc-highlight">Can I scan outgoing mail with Rspamd</a></li><li><a href="#can-i-just-sign-messages-using-dkim" class="table-of-contents__link toc-highlight">Can I just sign messages using DKIM</a></li></ul></li><li><a href="#administration-questions" class="table-of-contents__link toc-highlight">Administration questions</a><ul><li><a href="#where-can-i-find-all-configuration-options-supported-by-rspamd" class="table-of-contents__link toc-highlight">Where can I find all configuration options supported by Rspamd</a></li><li><a href="#how-to-read-rspamd-logs" class="table-of-contents__link toc-highlight">How to read Rspamd logs</a></li><li><a href="#can-i-customize-log-output-for-logger" class="table-of-contents__link toc-highlight">Can I customize log output for logger</a></li><li><a href="#which-backend-should-i-use-for-statistics" class="table-of-contents__link toc-highlight">Which backend should I use for statistics</a></li><li><a href="#what-redis-keys-are-used-by-rspamd" class="table-of-contents__link toc-highlight">What Redis keys are used by Rspamd</a></li><li><a href="#how-to-delete-multiple-redis-keys-matching-a-glob-style-pattern" class="table-of-contents__link toc-highlight">How to delete multiple Redis keys matching a glob-style pattern</a></li><li><a href="#how-to-run-rspamd-using-unix-sockets" class="table-of-contents__link toc-highlight">How to run Rspamd using Unix sockets</a></li><li><a href="#what-data-should-be-backed-up" class="table-of-contents__link toc-highlight">What data should be backed up?</a></li><li><a href="#why-am-i-getting-errors-after-moving-rspamd-to-a-different-platform-cpu-type" class="table-of-contents__link toc-highlight">Why am I getting errors after moving Rspamd to a different platform (CPU type)?</a></li></ul></li><li><a href="#plugin-questions" class="table-of-contents__link toc-highlight">Plugin questions</a><ul><li><a href="#how-to-whitelist-messages-or-skip-spam-checks-for-certain-users" class="table-of-contents__link toc-highlight">How to whitelist messages or skip spam checks for certain users</a></li><li><a href="#how-to-blacklist-messages-based-on-extension" class="table-of-contents__link toc-highlight">How to blacklist messages based on extension</a></li><li><a href="#what-are-filters-pre-filters-and-post-filters" class="table-of-contents__link toc-highlight">What are filters, pre-filters and post-filters</a></li><li><a href="#what-is-the-meaning-of-the-uribl_blocked-symbol" class="table-of-contents__link toc-highlight">What is the meaning of the <code>URIBL_BLOCKED</code> symbol</a></li><li><a href="#how-can-i-use-commercial-feeds-for-surblrbl-others" class="table-of-contents__link toc-highlight">How can I use commercial feeds for SURBL/RBL others</a></li><li><a href="#what-are-monitored-checks" class="table-of-contents__link toc-highlight">What are monitored checks</a></li><li><a href="#why-do-i-have-monitored-errors-in-my-log-files" class="table-of-contents__link toc-highlight">Why do I have <code>monitored</code> errors in my log files</a></li><li><a href="#what-is-the-meaning-of-the-message-like-inv_chi_square-exp-overflow" class="table-of-contents__link toc-highlight">What is the meaning of the message like <code>inv_chi_square: exp overflow</code></a></li><li><a href="#how-can-i-learn-messages" class="table-of-contents__link toc-highlight">How can I learn messages</a></li><li><a href="#how-to-learn-rspamd-automatically" class="table-of-contents__link toc-highlight">How to learn Rspamd automatically</a></li><li><a href="#what-is-faster-between-custom-lua-rules-and-regular-expressions" class="table-of-contents__link toc-highlight">What is faster between custom Lua rules and regular expressions</a></li></ul></li><li><a href="#webui-questions" class="table-of-contents__link toc-highlight">WebUI questions</a><ul><li><a href="#what-are-enable_password-and-password-for-the-webui" class="table-of-contents__link toc-highlight">What are <code>enable_password</code> and <code>password</code> for the WebUI</a></li><li><a href="#how-to-store-passwords-securely" class="table-of-contents__link toc-highlight">How to store passwords securely</a></li><li><a href="#how-to-use-the-webui-behind-a-proxy-server" class="table-of-contents__link toc-highlight">How to use the WebUI behind a proxy server</a></li><li><a href="#where-does-the-webui-store-settings" class="table-of-contents__link toc-highlight">Where does the WebUI store settings</a></li><li><a href="#why-cant-i-edit-some-maps-with-the-webui" class="table-of-contents__link toc-highlight">Why can&#39;t I edit some maps with the WebUI</a></li><li><a href="#how-to-setup-cluster-in-webui" class="table-of-contents__link toc-highlight">How to setup cluster in WebUI</a></li><li><a href="#why-does-the-user-column-show-undefined" class="table-of-contents__link toc-highlight">Why does the User column show &#39;undefined&#39;?</a></li><li><a href="#how-to-exclude-rows-from-the-history-tab" class="table-of-contents__link toc-highlight">How to exclude rows from the History tab?</a></li></ul></li><li><a href="#lua-questions" class="table-of-contents__link toc-highlight">Lua questions</a><ul><li><a href="#what-is-the-difference-between-plugins-and-rules" class="table-of-contents__link toc-highlight">What is the difference between plugins and rules</a></li><li><a href="#what-is-table-form-of-a-function-call" class="table-of-contents__link toc-highlight">What is table form of a function call</a></li><li><a href="#how-to-use-rspamd-modules" class="table-of-contents__link toc-highlight">How to use rspamd modules</a></li><li><a href="#how-to-write-to-rspamd-log" class="table-of-contents__link toc-highlight">How to write to Rspamd log</a></li><li><a href="#should-i-use-local-for-my-variables" class="table-of-contents__link toc-highlight">Should I use <code>local</code> for my variables</a></li><li><a href="#how-can-i-create-regexps-in-lua" class="table-of-contents__link toc-highlight">How can I create regexps in Lua</a></li></ul></li><li><a href="#integration-questions" class="table-of-contents__link toc-highlight">Integration questions</a><ul><li><a href="#how-to-distinguish-inbound-and-outbound-traffic-for-rspamd-instance" class="table-of-contents__link toc-highlight">How to distinguish inbound and outbound traffic for Rspamd instance</a></li><li><a href="#how-can-i-restore-the-old-rmilter-spf-behaviour" class="table-of-contents__link toc-highlight">How can I restore the old Rmilter SPF behaviour</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>