<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-configuration/maps" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Rspamd maps | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/pr/35/ru/configuration/maps"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Rspamd maps | Rspamd Documentation"><meta data-rh="true" name="description" content="Maps are one of the most important and flexible features in Rspamd, allowing for dynamic configuration of various elements without requiring service restarts. This article provides a comprehensive overview of Rspamd maps, their types, configuration options, and best practices."><meta data-rh="true" property="og:description" content="Maps are one of the most important and flexible features in Rspamd, allowing for dynamic configuration of various elements without requiring service restarts. This article provides a comprehensive overview of Rspamd maps, their types, configuration options, and best practices."><link data-rh="true" rel="icon" href="/docs.rspamd.com/pr/35/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/pr/35/ru/configuration/maps"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/configuration/maps" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/ru/configuration/maps" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/configuration/maps" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Configuration","item":"https://rspamd.com/docs.rspamd.com/pr/35/ru/configuration/"},{"@type":"ListItem","position":2,"name":"Rspamd maps","item":"https://rspamd.com/docs.rspamd.com/pr/35/ru/configuration/maps"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/pr/35/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/pr/35/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/pr/35/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/pr/35/ru/assets/js/runtime~main.3df2ef83.js" defer="defer"></script>
<script src="/docs.rspamd.com/pr/35/ru/assets/js/main.f7bfbe55.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_navbar.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/pr/35/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/pr/35/ru/configuration/">Configuration</a><button aria-label="Collapse sidebar category &#x27;Configuration&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/settings">User settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/metrics">Actions and scores</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/logging">Logging settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/options">Common options</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/composites">Composite symbols</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/maps">Rspamd maps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/selectors">Selectors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/statistic">Statistics settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/redis">Redis configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/upstream">Upstreams configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/ru/configuration/ucl">Universal configuration language (UCL)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/modules/">Modules</a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/ru/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/pr/35/ru/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a></li></ul></nav><button type="button" title="Свернуть сайдбар" aria-label="Свернуть сайдбар" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/docs.rspamd.com/pr/35/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/pr/35/ru/configuration/"><span>Configuration</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Rspamd maps</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Rspamd Maps: A Comprehensive Guide</h1></header>
<p>Maps are one of the most important and flexible features in Rspamd, allowing for dynamic configuration of various elements without requiring service restarts. This article provides a comprehensive overview of Rspamd maps, their types, configuration options, and best practices.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Прямая ссылка на Table of Contents" title="Прямая ссылка на Table of Contents">​</a></h2>
<ol>
<li><a href="#what-are-maps">What Are Maps?</a></li>
<li><a href="#map-types">Maps Types</a></li>
<li><a href="#map-configuration-formats">Map Configuration Formats</a></li>
<li><a href="#map-content-format">Map Content Format</a></li>
<li><a href="#http-maps-and-caching">HTTP Maps and Caching</a></li>
<li><a href="#map-loading-lifecycle">Map Loading Lifecycle</a></li>
<li><a href="#external-maps">External Maps</a></li>
<li><a href="#authentication-for-http-maps">Authentication for HTTP Maps</a></li>
<li><a href="#compression-support">Compression Support</a></li>
<li><a href="#fallback-options">Fallback Options</a></li>
<li><a href="#cdb-maps">CDB Maps</a></li>
<li><a href="#map-api-reference">Map API Reference</a></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-maps">What Are Maps?<a href="#what-are-maps" class="hash-link" aria-label="Прямая ссылка на What Are Maps?" title="Прямая ссылка на What Are Maps?">​</a></h2>
<p>Maps in Rspamd are dynamic data sources that contain lists of keys or key-value pairs that can be reloaded at runtime without restarting the service. Maps can be defined using various backends including:</p>
<ul>
<li>Local files</li>
<li>HTTP/HTTPS resources</li>
<li>Static data embedded in the configuration</li>
<li>CDB (Constant Database) files</li>
</ul>
<p>The significant distinction between maps and static configuration elements is that maps can be updated &quot;live&quot; without the costly restart procedure. Rspamd automatically monitors maps for changes:</p>
<ul>
<li>For file maps: checking file modification time and the <code>inotify</code> where available (meaning you must save maps files atomically using <code>rename</code> as otherwise you might end up with an incomplete load)</li>
<li>For HTTP maps: using HTTP caching headers (If-Modified-Since, ETag)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-types">Map Types<a href="#map-types" class="hash-link" aria-label="Прямая ссылка на Map Types" title="Прямая ссылка на Map Types">​</a></h2>
<p>Rspamd supports several map types, each with specific functionality:</p>
<ul>
<li><strong>set</strong>: Simple list of strings, optimized for fast lookups (membership tests)</li>
<li><strong>hash</strong>: Key-value pairs where values can be arbitrary strings</li>
<li><strong>radix</strong>: IP address maps with optional CIDR notation</li>
<li><strong>regexp</strong>: Regular expression patterns</li>
<li><strong>regexp_multi</strong>: Regular expressions that can match multiple captures</li>
<li><strong>glob</strong>: Glob-style pattern matching with wildcard characters</li>
<li><strong>glob_multi</strong>: Glob patterns that can match multiple captures</li>
<li><strong>cdb</strong>: Constant Database format for fast, read-only lookups</li>
</ul>
<p>Maps can specify their type using prefixes in URI definitions, like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">regexp;/path/to/file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hash;http://example.com/map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">radix;/path/to/ip_list</span><br></span></code></pre></div></div>
<p><strong>Performance consideration</strong>: regular expression maps are slower than other type of maps especially if your Rspamd is built without <code>Hyperscan</code> support.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-configuration-formats">Map Configuration Formats<a href="#map-configuration-formats" class="hash-link" aria-label="Прямая ссылка на Map Configuration Formats" title="Прямая ссылка на Map Configuration Formats">​</a></h2>
<p>Maps can be defined in four main ways:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-simple-string-url">1. Simple String URL<a href="#1-simple-string-url" class="hash-link" aria-label="Прямая ссылка на 1. Simple String URL" title="Прямая ссылка на 1. Simple String URL">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;http://example.com/file.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;/path/to/local/file&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-composite-path-array">2. Composite Path Array<a href="#2-composite-path-array" class="hash-link" aria-label="Прямая ссылка на 2. Composite Path Array" title="Прямая ссылка на 2. Composite Path Array">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;http://example.com/file.txt&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;/path/to/local/file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre></div></div>
<p>When using composite paths, data from all sources is concatenated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-embedded-data">3. Embedded Data<a href="#3-embedded-data" class="hash-link" aria-label="Прямая ссылка на 3. Embedded Data" title="Прямая ссылка на 3. Embedded Data">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;foo bar&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;baz qux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># For IP maps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_list = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;192.168.1.1/24&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;10.0.0.0/8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-detailed-configuration-object">4. Detailed Configuration Object<a href="#4-detailed-configuration-object" class="hash-link" aria-label="Прямая ссылка на 4. Detailed Configuration Object" title="Прямая ссылка на 4. Detailed Configuration Object">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;My important map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Contains important data&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url = &quot;http://example.com/map.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = 10.0; # in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Or for multiple URLs:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;Multi-source map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  urls = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;http://example.com/map.txt&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;/local/backup/map.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-content-format">Map Content Format<a href="#map-content-format" class="hash-link" aria-label="Прямая ссылка на Map Content Format" title="Прямая ссылка на Map Content Format">​</a></h2>
<p>Maps can contain various elements depending on their type:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-formats">Basic Formats<a href="#basic-formats" class="hash-link" aria-label="Прямая ссылка на Basic Formats" title="Прямая ссылка на Basic Formats">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key1 # Single key with comment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Full line comment is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Empty line ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key2 1 # Key and value (for hash maps)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key3 with space&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key with \&quot; escaped&quot; value with spaces</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="regular-expression-maps">Regular Expression Maps<a href="#regular-expression-maps" class="hash-link" aria-label="Прямая ссылка на Regular Expression Maps" title="Прямая ссылка на Regular Expression Maps">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/regexp/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/regexp/is some other value</span><br></span></code></pre></div></div>
<p>Options after the final slash:</p>
<ul>
<li><code>i</code> - ignore case</li>
<li><code>u</code> - use UTF-8 regexp</li>
<li><code>m</code> - multi-line regular expression - this flag causes the string to be treated as multiple lines. This means that the <code>^</code> and <code>$</code> symbols match the start and end of each line within the string, rather than just the start and end of the first and last lines.</li>
<li><code>x</code> - extended regular expression - this flag instructs the regular expression parser to ignore most white-space that is not escaped (<code>\</code>) or within a bracketed character class. This makes it possible to break up the regular expression into more readable parts. Additionally, the <code>#</code> character is treated as a meta-character that introduces a comment which runs up to the pattern&#x27;s closing delimiter or to the end of the current line if the pattern extends onto the next line.</li>
<li><code>s</code> - dot-all regular expression - this flag causes the string to be treated as a single line. This means that the <code>.</code> symbol matches any character whatsoever, including a newline, which it would not normally match. When used together as <code>/ms</code>, they allow the <code>.</code> to match any character while still allowing <code>^</code> and <code>$</code> to respectively match just after and just before newlines within the string</li>
<li><code>O</code> - do not optimize regexp (rspamd optimizes regexps by default)</li>
<li><code>r</code> - use non-UTF-8 regular expressions (raw bytes). Defaults to <code>true</code> if <code>raw_mode</code> is set to <code>true</code> in the options section.</li>
<li><code>A</code> - return and process all matches (useful for Lua prefilters)</li>
<li><code>L</code> - match left part of regexp (useful for Lua prefilters in conjunction with Hyperscan)</li>
</ul>
<p>Please note that you <strong>must</strong> use <code>/u</code> modifier if you want to match UTF8 characters or classes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ip-maps">IP Maps<a href="#ip-maps" class="hash-link" aria-label="Прямая ссылка на IP Maps" title="Прямая ссылка на IP Maps">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.1 # Mask is /32 (single IP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[::1] # IPv6, mask is /128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[::1]/64 # IPv6 with CIDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.1/19 # IPv4 with CIDR</span><br></span></code></pre></div></div>
<p>You can mix both IPv4 and IPv6 addresses or networks in a single map.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="http-maps-and-caching">HTTP Maps and Caching<a href="#http-maps-and-caching" class="hash-link" aria-label="Прямая ссылка на HTTP Maps and Caching" title="Прямая ссылка на HTTP Maps and Caching">​</a></h2>
<p>Rspamd implements sophisticated caching for HTTP maps:</p>
<ol>
<li>When a map is first loaded from HTTP, Rspamd caches it locally.</li>
<li>For subsequent requests, Rspamd:
<ul>
<li>Uses HTTP conditional requests (If-Modified-Since, ETag)</li>
<li>Respects Cache-Control and Expires headers</li>
<li>Stores the cached data for quick loading on restart</li>
</ul>
</li>
</ol>
<p>There are two main startup scenarios:</p>
<ul>
<li><strong>Hot start</strong>: Rspamd reuses cached maps immediately, then checks for updates.</li>
<li><strong>Cold start</strong>: Rspamd fetches maps when workers start, which can cause a temporary gap.</li>
</ul>
<p>To provide resilience, you can configure fallback options:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;https://maps.rspamd.com/rspamd/whitelist.inc.zst&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;${DBDIR}/local_whitelist.inc&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;fallback+file://${CONFDIR}/maps.d/whitelist.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">];</span><br></span></code></pre></div></div>
<p>In this example, the <code>fallback+file://</code> option is used only when the HTTP source is unavailable during cold starts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-loading-lifecycle">Map Loading Lifecycle<a href="#map-loading-lifecycle" class="hash-link" aria-label="Прямая ссылка на Map Loading Lifecycle" title="Прямая ссылка на Map Loading Lifecycle">​</a></h2>
<p>When Rspamd is running, maps follow a specific lifecycle:</p>
<ol>
<li><strong>Initialization</strong>: Maps are registered during configuration parsing</li>
<li><strong>Initial Load</strong>:
<ul>
<li>File maps are read directly</li>
<li>HTTP maps are loaded from cache if available, or fetched</li>
</ul>
</li>
<li><strong>Periodic Checks</strong>:
<ul>
<li>File maps: Rspamd watches for file modifications using a filesystem monitoring mechanism</li>
<li>HTTP maps: Rspamd schedules periodic checks based on cache headers or default poll interval</li>
</ul>
</li>
</ol>
<p>The default poll interval can be adjusted in the configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">options {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map_timeout = 60s; # Default HTTP map poll interval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map_file_watch_multiplier = 0.1; # Local files are checked more frequently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-sign-maps">How to sign maps<a href="#how-to-sign-maps" class="hash-link" aria-label="Прямая ссылка на How to sign maps" title="Прямая ссылка на How to sign maps">​</a></h2>
<p>From Rspamd version 1.2 onwards, each map can have a digital signature using the <code>EdDSA</code> algorithm. To sign a map, you can use <code>rspamadm signtool</code>, and to generate a signing keypair, use <code>rspamadm keypair -s -u</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   pubkey = &quot;zo4sejrs9e5idqjp8rn6r3ow3x38o8hi5pyngnz6ktdzgmamy48y&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   privkey = &quot;pwq38sby3yi68xyeeuup788z6suqk3fugrbrxieri637bypqejnqbipt1ec9tsm8h14qerhj1bju91xyxamz5yrcrq7in8qpsozywxy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   id = &quot;bs4zx9tcf1cs5ed5mt4ox8za54984frudpzzny3jwdp8mkt3feh7nz795erfhij16b66piupje4wooa5dmpdzxeh5mi68u688ixu3yd&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   type = &quot;sign&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Then you can use <code>signtool</code> to edit the map file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm signtool -e --editor=vim -k &lt;keypair_file&gt; &lt;map_file&gt;</span><br></span></code></pre></div></div>
<p>To enforce signing policies, you should add a <code>sign+</code> string to your map definition:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;sign+http://example.com/map&quot;</span><br></span></code></pre></div></div>
<p>To specify the trusted key you could either put the <strong>public</strong> key from the keypair in the <code>local.d/options.inc</code> file as following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trusted_keys = [&quot;&lt;public key string&gt;&quot;];</span><br></span></code></pre></div></div>
<p>or add it as a <code>key</code> definition in the map string:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;sign+key=&lt;key_string&gt;+http://example.com/map&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="external-maps">External Maps<a href="#external-maps" class="hash-link" aria-label="Прямая ссылка на External Maps" title="Прямая ссылка на External Maps">​</a></h2>
<p>Rspamd supports &quot;external maps&quot; for dynamic lookups to external services. These maps query an external service for each key lookup rather than loading the entire map into memory.</p>
<p>External maps are configured with the <code>external = true</code> parameter:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">external_map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  external = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;http://lookup-service.local/api&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = &quot;query&quot;; # Can be &quot;query&quot;, &quot;header&quot;, or &quot;body&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout = 1.0;    # Timeout in seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The external map API has three methods for passing lookup keys:</p>
<ul>
<li><strong>query</strong>: Appends the key as a URL query parameter</li>
<li><strong>header</strong>: Sends the key in an HTTP header</li>
<li><strong>body</strong>: Sends the key in the request body</li>
</ul>
<p>For complex data structures, you can specify an encoding:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">external_map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  external = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;http://lookup-service.local/api&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = &quot;body&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encode = &quot;json&quot;;  # Can be &quot;json&quot; or &quot;messagepack&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authentication-for-http-maps">Authentication for HTTP Maps<a href="#authentication-for-http-maps" class="hash-link" aria-label="Прямая ссылка на Authentication for HTTP Maps" title="Прямая ссылка на Authentication for HTTP Maps">​</a></h2>
<p>HTTP maps support two authentication methods:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-basic-auth-in-url">1. Basic Auth in URL<a href="#1-basic-auth-in-url" class="hash-link" aria-label="Прямая ссылка на 1. Basic Auth in URL" title="Прямая ссылка на 1. Basic Auth in URL">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;http://user:password@example.com/map.txt&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-configuration-based-authentication">2. Configuration-based Authentication<a href="#2-configuration-based-authentication" class="hash-link" aria-label="Прямая ссылка на 2. Configuration-based Authentication" title="Прямая ссылка на 2. Configuration-based Authentication">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">options {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http_auth {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    example.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      user = &quot;username&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      password = &quot;secret&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This approach is more secure as credentials aren&#x27;t stored in map URLs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="compression-support">Compression Support<a href="#compression-support" class="hash-link" aria-label="Прямая ссылка на Compression Support" title="Прямая ссылка на Compression Support">​</a></h2>
<p>Rspamd supports compressed maps with Zstandard (.zst or .zstd extension):</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;https://maps.rspamd.com/rspamd/whitelist.inc.zst&quot;</span><br></span></code></pre></div></div>
<p>Compressed maps:</p>
<ul>
<li>Reduce network bandwidth usage</li>
<li>Reduce storage requirements for larger maps</li>
<li>Are automatically decompressed when loaded</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fallback-options">Fallback Options<a href="#fallback-options" class="hash-link" aria-label="Прямая ссылка на Fallback Options" title="Прямая ссылка на Fallback Options">​</a></h2>
<p>For resilience, Rspamd supports fallback options for maps:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;https://maps.rspamd.com/rspamd/whitelist.inc.zst&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;fallback+file://${CONFDIR}/maps.d/whitelist.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">];</span><br></span></code></pre></div></div>
<p>The <code>fallback+</code> prefix indicates this source should only be used if other sources fail:</p>
<ul>
<li>During cold starts when HTTP maps aren&#x27;t available</li>
<li>When the primary source becomes unreachable</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cdb-maps">CDB Maps<a href="#cdb-maps" class="hash-link" aria-label="Прямая ссылка на CDB Maps" title="Прямая ссылка на CDB Maps">​</a></h2>
<p>Rspamd supports Constant Database (CDB) maps, which provide extremely fast, read-only key-value lookups. CDB maps are especially useful for large datasets with frequent lookups.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-cdb-maps">Configuring CDB Maps<a href="#configuring-cdb-maps" class="hash-link" aria-label="Прямая ссылка на Configuring CDB Maps" title="Прямая ссылка на Configuring CDB Maps">​</a></h3>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cdb_map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  external = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cdb = &quot;/var/lib/rspamd/domain_settings.cdb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>CDB maps can be used in regular maps or as external maps for per-key lookups.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-cdb-files">Creating CDB Files<a href="#creating-cdb-files" class="hash-link" aria-label="Прямая ссылка на Creating CDB Files" title="Прямая ссылка на Creating CDB Files">​</a></h3>
<p>CDB files can be created using the Rspamd Lua API:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rspamd_cdb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;rspamd_cdb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> builder </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_cdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/path/to/map.cdb&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;key1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;value1&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;key2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;value2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">finalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Benefits of CDB over other map types:</p>
<ul>
<li>Constant-time lookups (O(1) complexity)</li>
<li>Zero locking requirements for reads</li>
<li>Compact storage format</li>
<li>Atomic updates (by creating a new file and renaming)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-api-reference">Map API Reference<a href="#map-api-reference" class="hash-link" aria-label="Прямая ссылка на Map API Reference" title="Прямая ссылка на Map API Reference">​</a></h2>
<p>Rspamd provides several Lua functions for working with maps programmatically:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-maps">Adding Maps<a href="#adding-maps" class="hash-link" aria-label="Прямая ссылка на Adding Maps" title="Прямая ссылка на Adding Maps">​</a></h3>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> lua_maps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;lua_maps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Add a map from configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> my_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lua_maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;module_name&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;option_name&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;map_type&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;description&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Add a map from UCL object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> my_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lua_maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map_add_from_ucl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ucl_object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;map_type&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;description&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Bulk map configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> map_defs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;set&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;My important list&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;radix&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;IP blocklist&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fill_config_maps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;module_name&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_defs</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-maps">Using Maps<a href="#using-maps" class="hash-link" aria-label="Прямая ссылка на Using Maps" title="Прямая ссылка на Using Maps">​</a></h3>
<p>Once a map is loaded, you can use it for lookups:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Simple lookup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> my_map</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;test_key&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- With callback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_map</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;test_key&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_found</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> is_found </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Use the value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Iterate through all entries</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_map</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">foreach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Process each entry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Continue iteration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>After analyzing the <code>lua_maps_expressions.lua</code> file, I&#x27;ll add information about map expressions to your article. This is an important feature that allows combining multiple maps with selectors in powerful expressions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-expressions">Map Expressions<a href="#map-expressions" class="hash-link" aria-label="Прямая ссылка на Map Expressions" title="Прямая ссылка на Map Expressions">​</a></h2>
<p>Map expressions provide a powerful way to combine multiple maps using boolean logic. This feature allows you to create complex filtering rules by combining simpler components using logical operators.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-map-expressions">What Are Map Expressions?<a href="#what-are-map-expressions" class="hash-link" aria-label="Прямая ссылка на What Are Map Expressions?" title="Прямая ссылка на What Are Map Expressions?">​</a></h3>
<p>Map expressions allow you to:</p>
<ol>
<li>Define multiple maps with different data sources</li>
<li>Associate each map with a selector that extracts values from messages</li>
<li>Combine these maps using logical expressions</li>
<li>Act on the combined result</li>
</ol>
<p>This creates a flexible framework for defining complex conditions without writing custom Lua code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-format">Configuration Format<a href="#configuration-format" class="hash-link" aria-label="Прямая ссылка на Configuration Format" title="Прямая ссылка на Configuration Format">​</a></h3>
<p>Map expressions are defined using a structured format:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">whitelist_ip_from = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;ip&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;/path/to/whitelist_ip.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type = &quot;radix&quot;; # Optional, can be automatically inferred</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;from(smtp)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;/path/to/whitelist_from.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expression = &quot;ip &amp; from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The key components are:</p>
<ul>
<li>
<p><strong>rules</strong>: A collection of named rules, each with:</p>
<ul>
<li><strong>selector</strong>: A selector expression to extract values from the message</li>
<li><strong>map</strong>: A map definition (any format supported by the maps API)</li>
<li><strong>type</strong>: Optional map type (if omitted, it&#x27;s inferred from the rule name)</li>
<li><strong>description</strong>: Optional description for the map</li>
</ul>
</li>
<li>
<p><strong>expression</strong>: A logical expression combining the rules, using rule names as atoms</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expression-syntax">Expression Syntax<a href="#expression-syntax" class="hash-link" aria-label="Прямая ссылка на Expression Syntax" title="Прямая ссылка на Expression Syntax">​</a></h3>
<p>The expression syntax supports the following operators:</p>
<ul>
<li><code>&amp;</code> - logical AND</li>
<li><code>|</code> - logical OR</li>
<li><code>!</code> - logical NOT</li>
<li><code>+</code> - arithmetic plus (can be used for weighted combinations)</li>
<li>Parentheses <code>()</code> for grouping</li>
</ul>
<p>Examples:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip &amp; from           # Both IP and From must match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip | from           # Either IP or From must match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip &amp; !from          # IP matches but From does not match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(ip &amp; from) | asn   # Either both IP and From match, or ASN matches</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selectors">Selectors<a href="#selectors" class="hash-link" aria-label="Прямая ссылка на Selectors" title="Прямая ссылка на Selectors">​</a></h3>
<p>Selectors are functions that extract specific values from a message. Common selectors include:</p>
<ul>
<li><code>ip</code> - IP address of the message sender</li>
<li><code>from(smtp)</code> - SMTP From address</li>
<li><code>from(mime)</code> - From header in the message</li>
<li><code>rcpt(smtp)</code> - SMTP recipient</li>
<li><code>header(name)</code> - Value of a specific header</li>
<li><code>url</code> - URLs in the message</li>
<li><code>asn</code> - Autonomous System Number of the sender</li>
</ul>
<p>You can create custom selectors or use any of Rspamd&#x27;s built-in selectors.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing-and-results">Processing and Results<a href="#processing-and-results" class="hash-link" aria-label="Прямая ссылка на Processing and Results" title="Прямая ссылка на Processing and Results">​</a></h3>
<p>When a task is processed against a map expression:</p>
<ol>
<li>Each rule&#x27;s selector extracts values from the message</li>
<li>Each extracted value is checked against the corresponding map</li>
<li>The expression combines the results of individual map lookups</li>
<li>If the expression evaluates to a positive number, it&#x27;s considered a match</li>
</ol>
<p>When a match occurs, the function returns:</p>
<ol>
<li>The value of the expression (typically 1.0)</li>
<li>A detailed match table containing:
<ul>
<li>Which rules matched</li>
<li>What values were extracted by selectors</li>
<li>What values were returned by maps</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-usage">Example Usage<a href="#example-usage" class="hash-link" aria-label="Прямая ссылка на Example Usage" title="Прямая ссылка на Example Usage">​</a></h3>
<p>Here&#x27;s a complete example of creating and using a map expression:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> lua_maps_expressions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;lua_maps_expressions&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> whitelist_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ip&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/path/to/whitelist_ip.map&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;radix&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;from(smtp)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/path/to/whitelist_from.map&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;set&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;from(smtp).domain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/path/to/whitelist_domains.map&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;set&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expression </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;(ip &amp; from) | domain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;WHITELIST_EXPRESSION&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Optional symbol to register</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> whitelist </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lua_maps_expressions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> whitelist_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;whitelist_module&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Later in the code:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">symbol_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> matched </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> whitelist</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> result </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Matched! We can access details via the &#x27;matched&#x27; table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ip </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">insert_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;IP_WHITELISTED&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">matched</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">insert_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;FROM_WHITELISTED&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">matched</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domain </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">insert_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DOMAIN_WHITELISTED&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> matched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">matched</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CHECK_WHITELIST_EXPRESSION&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> symbol_callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="benefits-of-map-expressions">Benefits of Map Expressions<a href="#benefits-of-map-expressions" class="hash-link" aria-label="Прямая ссылка на Benefits of Map Expressions" title="Прямая ссылка на Benefits of Map Expressions">​</a></h3>
<p>Map expressions offer several advantages:</p>
<ol>
<li><strong>Declarative configuration</strong>: Define complex logic without custom code</li>
<li><strong>Reusability</strong>: The same maps can be reused in different expressions</li>
<li><strong>Maintainability</strong>: Easier to understand and modify than custom code</li>
<li><strong>Performance</strong>: Optimized evaluation of expressions</li>
<li><strong>Detailed results</strong>: Access to which specific rules matched and their values</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-reference">API Reference<a href="#api-reference" class="hash-link" aria-label="Прямая ссылка на API Reference" title="Прямая ссылка на API Reference">​</a></h3>
<p>The main API functions for map expressions include:</p>
<ul>
<li>
<p><strong>lua_maps_expressions.create(cfg, obj, module_name)</strong>: Creates a map expression object</p>
<ul>
<li><code>cfg</code>: Rspamd configuration object</li>
<li><code>obj</code>: Configuration table with <code>rules</code> and <code>expression</code></li>
<li><code>module_name</code>: Optional module name for logging</li>
<li>Returns: An expression object with a <code>process(task)</code> method</li>
</ul>
</li>
<li>
<p><strong>expression:process(task)</strong>: Evaluates the expression against a task</p>
<ul>
<li>Returns: <code>nil</code> if no match, or two values if matched:
<ol>
<li>The expression result (typically 1.0)</li>
<li>A table of match details by rule name</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Прямая ссылка на Conclusion" title="Прямая ссылка на Conclusion">​</a></h2>
<p>Maps are one of the most powerful features in Rspamd, allowing for dynamic configuration and real-time updates without service restarts. By understanding the different map types, configuration options, and best practices, you can build flexible and efficient filtering rules that adapt to changing conditions.</p>
<p>When designing your Rspamd setup, consider:</p>
<ul>
<li>Using HTTP maps for centralized management</li>
<li>Implementing fallback options for resilience</li>
<li>Choosing appropriate map types for your data</li>
<li>Leveraging compression for large maps</li>
<li>Using CDB for high-performance lookups of large datasets</li>
<li>Combining multiple maps with map expressions for complex logic</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/configuration/maps.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/pr/35/ru/configuration/composites"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">Composite symbols</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/pr/35/ru/configuration/selectors"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">Selectors</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#what-are-maps" class="table-of-contents__link toc-highlight">What Are Maps?</a></li><li><a href="#map-types" class="table-of-contents__link toc-highlight">Map Types</a></li><li><a href="#map-configuration-formats" class="table-of-contents__link toc-highlight">Map Configuration Formats</a><ul><li><a href="#1-simple-string-url" class="table-of-contents__link toc-highlight">1. Simple String URL</a></li><li><a href="#2-composite-path-array" class="table-of-contents__link toc-highlight">2. Composite Path Array</a></li><li><a href="#3-embedded-data" class="table-of-contents__link toc-highlight">3. Embedded Data</a></li><li><a href="#4-detailed-configuration-object" class="table-of-contents__link toc-highlight">4. Detailed Configuration Object</a></li></ul></li><li><a href="#map-content-format" class="table-of-contents__link toc-highlight">Map Content Format</a><ul><li><a href="#basic-formats" class="table-of-contents__link toc-highlight">Basic Formats</a></li><li><a href="#regular-expression-maps" class="table-of-contents__link toc-highlight">Regular Expression Maps</a></li><li><a href="#ip-maps" class="table-of-contents__link toc-highlight">IP Maps</a></li></ul></li><li><a href="#http-maps-and-caching" class="table-of-contents__link toc-highlight">HTTP Maps and Caching</a></li><li><a href="#map-loading-lifecycle" class="table-of-contents__link toc-highlight">Map Loading Lifecycle</a></li><li><a href="#how-to-sign-maps" class="table-of-contents__link toc-highlight">How to sign maps</a></li><li><a href="#external-maps" class="table-of-contents__link toc-highlight">External Maps</a></li><li><a href="#authentication-for-http-maps" class="table-of-contents__link toc-highlight">Authentication for HTTP Maps</a><ul><li><a href="#1-basic-auth-in-url" class="table-of-contents__link toc-highlight">1. Basic Auth in URL</a></li><li><a href="#2-configuration-based-authentication" class="table-of-contents__link toc-highlight">2. Configuration-based Authentication</a></li></ul></li><li><a href="#compression-support" class="table-of-contents__link toc-highlight">Compression Support</a></li><li><a href="#fallback-options" class="table-of-contents__link toc-highlight">Fallback Options</a></li><li><a href="#cdb-maps" class="table-of-contents__link toc-highlight">CDB Maps</a><ul><li><a href="#configuring-cdb-maps" class="table-of-contents__link toc-highlight">Configuring CDB Maps</a></li><li><a href="#creating-cdb-files" class="table-of-contents__link toc-highlight">Creating CDB Files</a></li></ul></li><li><a href="#map-api-reference" class="table-of-contents__link toc-highlight">Map API Reference</a><ul><li><a href="#adding-maps" class="table-of-contents__link toc-highlight">Adding Maps</a></li><li><a href="#using-maps" class="table-of-contents__link toc-highlight">Using Maps</a></li></ul></li><li><a href="#map-expressions" class="table-of-contents__link toc-highlight">Map Expressions</a><ul><li><a href="#what-are-map-expressions" class="table-of-contents__link toc-highlight">What Are Map Expressions?</a></li><li><a href="#configuration-format" class="table-of-contents__link toc-highlight">Configuration Format</a></li><li><a href="#expression-syntax" class="table-of-contents__link toc-highlight">Expression Syntax</a></li><li><a href="#selectors" class="table-of-contents__link toc-highlight">Selectors</a></li><li><a href="#processing-and-results" class="table-of-contents__link toc-highlight">Processing and Results</a></li><li><a href="#example-usage" class="table-of-contents__link toc-highlight">Example Usage</a></li><li><a href="#benefits-of-map-expressions" class="table-of-contents__link toc-highlight">Benefits of Map Expressions</a></li><li><a href="#api-reference" class="table-of-contents__link toc-highlight">API Reference</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>