<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorials/fuzzy_storage" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Usage of fuzzy hashes | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/pr/35/tutorials/fuzzy_storage"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Usage of fuzzy hashes | Rspamd Documentation"><meta data-rh="true" name="description" content="Russian version"><meta data-rh="true" property="og:description" content="Russian version"><link data-rh="true" rel="icon" href="/docs.rspamd.com/pr/35/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/pr/35/tutorials/fuzzy_storage"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/tutorials/fuzzy_storage" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/ru/tutorials/fuzzy_storage" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/pr/35/tutorials/fuzzy_storage" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Tutorials","item":"https://rspamd.com/docs.rspamd.com/pr/35/tutorials/"},{"@type":"ListItem","position":2,"name":"Usage of fuzzy hashes","item":"https://rspamd.com/docs.rspamd.com/pr/35/tutorials/fuzzy_storage"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/pr/35/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/pr/35/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/pr/35/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/pr/35/assets/js/runtime~main.c599eb0f.js" defer="defer"></script>
<script src="/docs.rspamd.com/pr/35/assets/js/main.c28d38e0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/pr/35/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/pr/35/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/pr/35/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/pr/35/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/pr/35/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>âŒ˜K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/modules/">Modules</a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/pr/35/tutorials/">Tutorials</a><button aria-label="Collapse sidebar category &#x27;Tutorials&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/quickstart">Quick start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/migration">Upgrading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/migrate_sa">Migrating from SpamAssassin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/scanning_outbound">Scanning outbound mail</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/fuzzy_storage">Usage of fuzzy hashes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/redis_replication">Multi-instance Redis replication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/stunnel_setup">Setup stunnel to protect Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/integration">MTA integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/feedback_from_users_with_IMAPSieve">Getting feedback from users with IMAPSieve</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/site_contributing">Contributing to Rspamd Documentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs.rspamd.com/pr/35/tutorials/multimap_guide">Module Guides</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/pr/35/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/pr/35/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/pr/35/blog">Blog</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/pr/35/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/pr/35/tutorials/"><span>Tutorials</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Usage of fuzzy hashes</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Usage of fuzzy hashes</h1></header>
<p><a href="/docs.rspamd.com/pr/35/tutorials/fuzzy_storage.ru/">Russian version</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">â€‹</a></h2>
<p>Fuzzy hashing can be used to search for similar messages, allowing us to identify messages with the same or slightly modified text. This technique is particularly useful for blocking spam that is sent to many users simultaneously.</p>
<p>The purpose of this page is to explain how to use fuzzy hashes, not to provide extensive details or a thorough understanding of how they work within Rspamd. However, the following summary should provide a basic understanding of the content covered on this page.</p>
<p>Textual content is divided into tokens, also known as chunks or shingles, each of which represents a window of text with a certain number of characters. These tokens are then hashed individually and stored. When new email arrives, it is also tokenized and the hashes of these tokens are compared to the stored corpus of data. Calculations based on the position and number of matches are performed to determine if the current email is similar to or identical to previously encountered emails.</p>
<p>For images and other attachments, a single hash is calculated and used to check for an exact match in storage.</p>
<p>Since the hash function is unidirectional, it is not possible to restore the original text using the hashed data. This allows us to send requests to third-party hash storages without the risk of disclosure and to benefit from a larger corpus of data aggregated from various unrelated sources.</p>
<p>The source data for fuzzy hash storage includes both spam and legitimate (non-spam) emails. Fuzzy hashes are used to match emails, not to classify them as spam or non-spam. First, we determine if an email is similar to other emails, and then we evaluate the significance of this similarity separately. The weight assigned to fuzzy hash matches (that is, the measure of how closely the current email matches or does not match content in the pool of many other emails) is just one factor among many in the determination of whether an email is spam or non-spam.</p>
<p>This page is intended for mail system administrators who want to create and maintain their own hash storage and for those who want to understand how rspamd.com serves as a third-party resource. More details can be found in other pages here, including:</p>
<ul>
<li><a href="/docs.rspamd.com/pr/35/modules/fuzzy_check">Fuzzy Check module</a></li>
<li><a href="/docs.rspamd.com/pr/35/workers/fuzzy_storage">Fuzzy Storage Workers</a></li>
<li><a href="/docs.rspamd.com/pr/35/other/usage_policy">Rspamd.com infrastructure policies</a></li>
</ul>
<hr>
<p><strong>There are three high-level steps toward using fuzzy hashes</strong></p>
<ul>
<li>Step 1: Hash sources selection</li>
<li>Step 2: Configuring storage</li>
<li>Step 3: Configuring fuzzy_check plugin</li>
</ul>
<p><strong>Optional:</strong> Hashes replication<br>
<strong>Suggested:</strong> Storage testing</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-hash-sources-selection">Step 1: Hash sources selection<a href="#step-1-hash-sources-selection" class="hash-link" aria-label="Direct link to Step 1: Hash sources selection" title="Direct link to Step 1: Hash sources selection">â€‹</a></h2>
<p>It is important to carefully select the sources of spam samples for training. The general principle is to use spam messages that are received by a large number of users. There are two main approaches to this task:</p>
<ul>
<li>working with users complaints</li>
<li>creating spam traps (honeypot)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="working-with-user-complaints">Working with user complaints<a href="#working-with-user-complaints" class="hash-link" aria-label="Direct link to Working with user complaints" title="Direct link to Working with user complaints">â€‹</a></h3>
<p>User complaints can be a useful source for improving the quality of the hash storage, but it is important to be aware that users may sometimes complain about legitimate emails that they have subscribed to themselves, such as store newsletters, ticket booking notifications, and even personal emails that they do not like for some reason. Many users do not differentiate between the &quot;Delete&quot; and &quot;Mark as Spam&quot; buttons.</p>
<p>One solution to this issue is to prompt the user for additional information about the complaint, such as why they believe the email is spam. This may draw the user&#x27;s attention to the fact that they can unsubscribe from receiving unwanted emails rather than marking them as spam. Another approach is manual processing of user spam complaints.</p>
<p>A combination of these methods may also be effective: assign greater weight to the emails that have been manually processed and a smaller weight to all other complaints.</p>
<p>There are two features in Rspamd that can help filter out false positives (emails that are mistakenly marked as spam). (Note: In this documentation, FP stands for &quot;False Positive&quot; and FN stands for &quot;False Negative&quot;.)</p>
<ol>
<li>Hash weight</li>
<li>Learning filters</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hash-weight">Hash weight<a href="#hash-weight" class="hash-link" aria-label="Direct link to Hash weight" title="Direct link to Hash weight">â€‹</a></h4>
<p>One method to filter out false positives is to assign a weight to each complaint and add this weight to the stored hash value during each subsequent learning step.</p>
<p>When querying the storage, we will ignore hashes with weights that are less than a defined threshold. For example, if the weight of a complaint is <code>w=1</code> and the threshold is <code>t=20</code>, then we will ignore this hash unless we receive at least 20 user complaints.</p>
<p>Furthermore, Rspamd does not assign the maximum score immediately upon reaching the threshold value. Instead, the score gradually increases from zero to a maximum (up to the metric value) as the weight of the hash increases from the threshold value to twice the threshold value (t .. 2 * t).</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-1.png" width="50%"></center>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="learning-filters">Learning filters<a href="#learning-filters" class="hash-link" aria-label="Direct link to Learning filters" title="Direct link to Learning filters">â€‹</a></h4>
<p>The second method for filtering out false positives based on user complaints involves writing conditions in the Lua language that can skip the learning process or modify the value of a hash for emails from specific domains, for example. These filters offer a wide range of possibilities, but they require manual writing and configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-spam-traps">Configuring spam traps<a href="#configuring-spam-traps" class="hash-link" aria-label="Direct link to Configuring spam traps" title="Direct link to Configuring spam traps">â€‹</a></h3>
<p>The &quot;honeypot&quot; method of improving the value of the hash storage involves using a mailbox that only receives spam emails and does not receive legitimate emails. The idea is that a large volume of fresh, guaranteed spam (possibly 100%) will be continually received, following current patterns, providing a vast corpus of fuzzy hash data for comparison with email received by live mailboxes. As mentioned earlier, user interpretation of spam can be somewhat error-prone. A corpus of user-reported spam is not as reliable as a spam trap, where matches are very likely to indicate that a new incoming email is also spam.</p>
<p>One way to set up a spam trap is to expose addresses to spammer databases, but not to legitimate users. This can be done by placing email addresses in a hidden <em>iframe</em> element on a popular website, for example. The element is not visible to users due to the <em>hidden</em> property or zero size, but it is visible to spam bots. This method is not as effective as it used to be, as spammers have learned how to avoid such traps.</p>
<p>Another way to create a trap is to find domains that were popular in the past but are no longer functional. These domain names can be found in many spam databases. Purchase these domains and allow all incoming mail to go to a catch-all address, where it is processed for fuzzy hashing and then discarded. In general, setting up your own traps like this is only practical for large mail systems, as it can be costly in terms of maintenance and direct expenses such as domain purchases.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-configuring-storage">Step 2: Configuring storage<a href="#step-2-configuring-storage" class="hash-link" aria-label="Direct link to Step 2: Configuring storage" title="Direct link to Step 2: Configuring storage">â€‹</a></h2>
<p>The Rspamd process that is responsible for fuzzy hash storage is called the <a href="/docs.rspamd.com/pr/35/workers/fuzzy_storage"><code>fuzzy_storage</code></a> worker. The information here should be useful whether you are using local or remote storage.</p>
<p>This process performs the following functions which will be detailed below.</p>
<ol>
<li>Data storage</li>
<li>Hash expiration</li>
<li>Access control (read and write)</li>
<li>Transport protocol encryption</li>
<li>Replication</li>
</ol>
<p>The configuration for the <code>worker &quot;fuzzy&quot;</code> section begins in <code>/etc/rspamd/rspamd.conf</code>.<br>
An <code>.include</code> directive there links to <code>/etc/rspamd/local.d/worker-fuzzy.inc</code>, which is where local settings activate and configure this process. (Earlier documentation referred to <code>/etc/rspamd/rspamd.conf.local</code>.)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sample-configuration">Sample configuration<a href="#sample-configuration" class="hash-link" aria-label="Direct link to Sample configuration" title="Direct link to Sample configuration">â€‹</a></h3>
<p>The following is a sample configuration for this fuzzy storage worker process, which will be explained and referred to below. Please refer to <a href="/docs.rspamd.com/pr/35/workers/fuzzy_storage#configuration">this page</a> for any settings not profiled here.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Socket to listen on (UDP and TCP from rspamd 1.3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind_socket = &quot;*:11335&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Number of processes to serve this storage (useful for read scaling)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Backend (&quot;sqlite&quot; or &quot;redis&quot; - default &quot;sqlite&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;sqlite&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # sqlite: Where data file is stored (must be owned by rspamd user)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database = &quot;${DBDIR}/fuzzy.db&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Hashes storage time (3 months)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expire = 90d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Synchronize updates to the storage each minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync = 1min;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This sample shows an entire section, not as you will see it in the file, but as it looks to the controller when the setting details are collected from all files (with the <code>.include</code> directive) : Be sure to put changes in the .inc file, without the <code>worker</code> wrapper.</p>
<p>By default, the fuzzy_storage process is not active, with the <code>count=-1</code> directive found in the core file. To activate fuzzy storage, the local .inc file gets the <code>count=4</code> directive as seen above.</p>
<p>The <code>expire</code> and <code>sync</code> values are related to database cleanup and performance, as described below.</p>
<p>Fuzzy storage works with hashes and not with email messages. A <a href="/docs.rspamd.com/pr/35/workers/normal">worker/scanner process</a> or a <a href="/docs.rspamd.com/pr/35/workers/controller">controller process</a> convert emails to hashes before connecting to this process for fuzzy processing. In this sample, we see the fuzzy storage process that operates on the sqlite database is listening on socket 11335 for UDP requests from the other processes to query or update the storage.</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-2.png" width="75%"></center>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-storage">Data storage<a href="#data-storage" class="hash-link" aria-label="Direct link to Data storage" title="Direct link to Data storage">â€‹</a></h3>
<p>The database engine, sqlite3, has some restrictions on the storage architecture that can impact performance. Specifically, sqlite cannot handle concurrent write requests well, which can lead to significant degradation in database performance.</p>
<p>To address this issue, Rspamd hash storage always writes to the database from a single process, the fuzzy storage worker. This process maintains an updates queue, while all other processes simply forward write requests from clients to this process. By default, the updates queue is written to disk once per minute, but this can be configured using the sync setting in the sample configuration.</p>
<p>This architecture is optimized for read requests and prioritizes them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hash-expiration">Hash expiration<a href="#hash-expiration" class="hash-link" aria-label="Direct link to Hash expiration" title="Direct link to Hash expiration">â€‹</a></h3>
<p>Another important function of the fuzzy storage worker is to remove obsolete hashes using the <code>expire</code> setting.</p>
<p>Spam patterns change as certain tactics become more or less effective. Spammers send out blasts of spam and, after a period of time ranging from days to months, they change the patterns because they know systems like this are analyzing their data. Since the &quot;effective lifetime&quot; of spam emails is always limited, there is no reason to store all hashes permanently. Based on experience, it is recommended to store hashes for no longer than about three months.</p>
<p>It is a good idea to compare the volume of hashes learned over a certain period with the available RAM. For example, 400,000 hashes may occupy about 100 MB, and 1.5 million hashes may occupy 500 MB. To avoid a significant performance degradation, it is not recommended to increase the storage size beyond the available RAM size. That is, do not rely on swap space or allocate too many resources to other processes. If you have a small volume of hashes suitable for learning, start with an expiration time of 90 days. If the volume of data over that time period results in an unacceptable amount of available RAM, such as peak-time available RAM going down to 20%, you may want to reduce the expiration time to 70 days and see if expiring data from storage releases a more acceptable amount of RAM.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="access-control">Access control<a href="#access-control" class="hash-link" aria-label="Direct link to Access control" title="Direct link to Access control">â€‹</a></h3>
<p>By default, Rspamd does not allow changes to the fuzzy storage. Any system that connects to the fuzzy_storage process via UDP must be authorized, and a list of trusted IP addresses and/or networks must be provided to enable learning. In practice, it is better to write from the local address only (127.0.0.1) because fuzzy storage uses UDP, which is not protected from source IP forgery.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow_update = [&quot;127.0.0.1&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # or 10.0.0.0/8, for internal network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The <code>allow_update</code> setting is a comma-delimited array of strings, or a <a href="/docs.rspamd.com/pr/35/modules/multimap">map</a> of IP addresses, that are allowed to perform changes to fuzzy storage - You should also set <code>read_only</code> = no in your fuzzy_check plugin, see step 3 below.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transport-protocol-encryption">Transport protocol encryption<a href="#transport-protocol-encryption" class="hash-link" aria-label="Direct link to Transport protocol encryption" title="Direct link to Transport protocol encryption">â€‹</a></h3>
<p>The fuzzy hashes protocol allows optional (opportunistic) or mandatory encryption based on public-key cryptography. This feature is useful for creating restricted storages where access is allowed exclusively to customers or other business partners who have a generated public key.</p>
<p><strong>How this works:</strong></p>
<ul>
<li>The configuration is modified in <code>/etc/rspamd/local.d/worker-fuzzy.inc</code> of the local system running the fuzzy_storage worker. One public/private keypair is set for each remote UDP client that will connect on port 11335.</li>
<li>One unique <strong>public</strong> key is given to each unique client system, so that only that one system can use that one key.</li>
</ul>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-3.png" width="75%"></center>
<p>The encryption architecture uses cryptobox construction: <a href="https://nacl.cr.yp.to/box.html" target="_blank" rel="noopener noreferrer">https://nacl.cr.yp.to/box.html</a> and it is similar to the algorithm for end-to-end encryption used in the DNSCurve protocol: <a href="https://dnscurve.org/" target="_blank" rel="noopener noreferrer">https://dnscurve.org/</a>.</p>
<p>To configure transport encryption, create a keypair for the storage server, using the command <code>rspamadm keypair -u</code>. Each time this command is run, unique output is returned, as shown in this example (the order of the name=value pairs may change each time this is run) :</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;og3snn8s37znxz53mr5yyyzktt3d5uczxecsp3kkrs495p4iaxzy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;o6wnij9r4wegqjnd46dyifwgf5gwuqguqxzntseectroq7b3gwty&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id = &quot;f5yior1ag3csbzjiuuynff9tczknoj9s9b454kuonqknthrdbwbqj63h3g9dht97fhp4a5jgof1eiifshcsnnrbj73ak8hkq6sbrhed&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The  <strong>public</strong> <code>pubkey</code> should be copied manually to the remote host, or published in any way that guarantees the reliability (e.g. certified digital signature or HTTPS-site hosting). As always the <strong>private</strong> <code>privkey</code> should never be published or shared.</p>
<p>Each storage can use any number of keys simultaneously, one for each remote client (or a group of clients):</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keypair = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This mechanism is optional, but it can be made mandatory by adding the <code>encrypted_only</code> option. In this mode, client systems that do not have a valid public key will be unable to access the storage.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypted_only = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keypair = [ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hashes-replication">Hashes replication<a href="#hashes-replication" class="hash-link" aria-label="Direct link to Hashes replication" title="Direct link to Hashes replication">â€‹</a></h3>
<p>Having a local copy of remote fuzzy storage can be useful in many situations. To facilitate this, Rspamd provides support for hash replication, which is handled by the fuzzy storage worker. Instructions for setting up replication can be found in Step 4 below.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-configuring-fuzzy_check-plugin">Step 3: Configuring <code>fuzzy_check</code> plugin<a href="#step-3-configuring-fuzzy_check-plugin" class="hash-link" aria-label="Direct link to step-3-configuring-fuzzy_check-plugin" title="Direct link to step-3-configuring-fuzzy_check-plugin">â€‹</a></h2>
<p>The <code>fuzzy_check</code> plugin is used by scanner processes for querying a storage, and by controller processes for learning fuzzy hashes.</p>
<p>Plugin functions:</p>
<ol>
<li>Email processing and hash creation from email parts and attachments</li>
<li>Querying from and learning to storage</li>
<li>Transport Encryption</li>
</ol>
<p>Learning is performing by <code>rspamc fuzzy_add</code> command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ rspamc -f 1 -w 10 fuzzy_add &lt;message|directory|stdin&gt;</span><br></span></code></pre></div></div>
<p>The <code>-w</code> parameter is used to set the hash weight, as mentioned earlier, while the <code>-f</code> parameter specifies the flag number.</p>
<p>Flags enable the storage of hashes from different sources. For example, a hash may originate from a spam trap, another hash may be the result of user complaints, and a third hash may come from emails on a whitelist. Each flag can be associated with its own symbol and have a weight when checking emails:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-4.png" width="75%"></center>
<p>A symbol name can be used instead of a numeric flag during learning, for example:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ rspamc -S FUZZY_DENIED -w 10 fuzzy_add &lt;message|directory|stdin&gt;</span><br></span></code></pre></div></div>
<p>The FUZZY_DENIED symbol is equivalent to flag=1, as defined in modules.d/fuzzy_check.conf. To match symbols with the corresponding flags you can use the <code>rule</code> section.</p>
<p>local.d/fuzzy_check.conf example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Fuzzy storage server list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servers = &quot;localhost:11335&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Default symbol for unknown flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol = &quot;LOCAL_FUZZY_UNKNOWN&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Additional mime types to store/check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mime_types = [&quot;*&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Hash weight threshold for all maps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_score = 20.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Whether we can learn this storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_only = no;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Ignore unknown flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    skip_unknown = yes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Hash generation algorithm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;mumhash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Use direct hash for short texts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    short_text_direct_hash = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Map flags to symbols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fuzzy_map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_DENIED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # Local threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 20.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # Flag to match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_PROB {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_WHITE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 2.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 13;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>local.d/fuzzy_group.conf example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">max_score = 12.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symbols = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_UNKNOWN&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 5.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Generic fuzzy hash match&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_DENIED&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 12.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Denied fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_PROB&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 5.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Probable fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_WHITE&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = -2.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Whitelisted fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Here are some useful options that can be set in the module:</p>
<p>One option is <code>max_score</code>, which specifies the threshold for a hash weight:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-1.png" width="50%"></center>
<p>The <code>mime_types</code> option specifies which attachment types are checked (or learned) using this fuzzy rule. This option takes a list of valid types in the following format: <code>[&quot;type/subtype&quot;, &quot;*/subtype&quot;, &quot;type/*&quot;, &quot;*&quot;]</code>, where <code>*</code> represents any valid type. In practice, it can be useful to save the hashes for all <code>application/*</code> attachments. Texts and embedded images are implicitly checked by <code>fuzzy_check</code> plugin, so there is no need to add <code>image/*</code> in the list of scanned attachments. Note that attachments and images are searched for an exact match, while texts are matched using the approximate algorithm (shingles).</p>
<p><code>read_only</code> is quite an important option required for storage learning. It is set to <code>read_only=true</code> by default, restricting thus a storage&#x27;s learning:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read_only = true; # disallow learning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_only = false; # allow learning</span><br></span></code></pre></div></div>
<p><code>Encryption_key</code> parameter specifies the <strong>public</strong> key of a storage and enables encryption for all requests.</p>
<p><code>Algorithm</code> parameter specifies the algorithm for generating hashes from text parts of emails (for attachments and images <a href="https://blake2.net/" target="_blank" rel="noopener noreferrer">blake2b</a> is always used).</p>
<p>Initially, rspamd only supported the <a href="https://en.wikipedia.org/wiki/SipHash" target="_blank" rel="noopener noreferrer">siphash</a> algorithm. However, this algorithm had some performance issues, particularly on older hardware (CPU models up to Intel Haswell). Subsequently, support was added for the following algorithms:</p>
<ul>
<li><code>mumhash</code></li>
<li><code>xxhash</code></li>
<li><code>fasthash</code></li>
</ul>
<p>For the vast majority of configurations we recommend <code>mumhash</code> or <code>fasthash</code> (also called <code>fast</code>). These algorithms perform well on a wide range of platforms, and <code>mumhash</code> is currently the default for all new storage. <code>siphash</code> (also called <code>old</code>) is only supported for legacy purposes.</p>
<p>You can evaluate the performance of different algorithms yourself by <a href="/docs.rspamd.com/pr/35/developers/writing_tests">compiling the tests set</a> from rspamd sources:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ make rspamd-test</span><br></span></code></pre></div></div>
<p>Run the test suite of different variants of hash algorithms on a specific platform:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test/rspamd-test -p /rspamd/shingles</span><br></span></code></pre></div></div>
<p><strong>Important note:</strong> Changing this parameter <strong>will result in losing all data in the fuzzy hash storage</strong>, since only one algorithm can be used for each storage at a time. It is not possible to convert one type of hash to another, as hash functions are designed to be irreversible.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="condition-scripts-for-the-learning">Condition scripts for the learning<a href="#condition-scripts-for-the-learning" class="hash-link" aria-label="Direct link to Condition scripts for the learning" title="Direct link to Condition scripts for the learning">â€‹</a></h3>
<p>As the <code>fuzzy_check</code> plugin is responsible for learning, we create the script within its configuration. This script determines whether an email is suitable for learning. The script should return a Lua function with a single argument of type <a href="/docs.rspamd.com/pr/35/lua/rspamd_task"><code>rspamd_task</code></a> type. The function should return a boolean value (<code>true</code> to learn, <code>false</code> to skip learning), or a pair consisting of a boolean value and a numeric value (to modify the hash flag value, if necessary). Parameter <code>learn_condition</code> is used to setup learn script. The most convenient way to set the script is to write it as a multiline string supported by <code>UCL</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy check plugin configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">learn_condition = &lt;&lt;EOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return function(task)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return true -- Always learn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOD;</span><br></span></code></pre></div></div>
<p>Here are some practical examples of useful scripts. For instance, if we want to restrict learning for messages that come from certain domains:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> skip_domains </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;example.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;google.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> from </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;addr&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d </span><span class="token keyword" style="color:rgb(222, 71, 0)">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ipairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skip_domains</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;addr&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>It can also be useful to split hashes into different flags based on their source. For example, such sources may be encoded in the <code>X-Source</code> title. For instance, we have the following match between flags and sources:</p>
<ul>
<li><code>honeypot</code> - &quot;black&quot; list: 1</li>
<li><code>users_unfiltered</code> - &quot;gray&quot; list: 2</li>
<li><code>users_filtered</code> - &quot;black&quot; list: 1</li>
<li><code>FP</code> - &quot;white&quot; list: 3</li>
</ul>
<p>Then the script that provides this logic may be as following:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> skip_headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;X-Source&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> sources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        honeypot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        users_unfiltered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        users_filtered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FP </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> fl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sources</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> fl </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">fl </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Return true + new flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">f </span><span class="token keyword" style="color:rgb(222, 71, 0)">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skip_headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> hdr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Check for interesting header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> h </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Call its handler and return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Do not learn if specified header is missing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hashes-replication-1">Hashes replication<a href="#hashes-replication-1" class="hash-link" aria-label="Direct link to Hashes replication" title="Direct link to Hashes replication">â€‹</a></h2>
<p>It is often desired to have a local copy of the remote storage. Rspamd supports replication for this purposes that is implemented in the hashes storage since version 1.3:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-5.png" width="75%"></center>
<p>The hashes transfer is initiated by the replication <strong>master</strong>. It sends hash update commands, such as adding, modifying or deleting, to all specified slaves. Therefore, the slaves must be able to accept connections from the master. This should be taken into account when configuring the firewall.</p>
<p>By default, a slave listens on port 11335 over TCP to accept connections. Synchronization between the master and the slave is performed via the HTTP protocol with HTTPCrypt transport encryption. To prevent repeated or invalid updates, the slave checks the update version. If the master&#x27;s version is less than or equal to the local version, the update is rejected. If the master is ahead of the slave by more than one version, the following message will appear in the slave&#x27;s log file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_fuzzy_mirror_process_update: remote revision: XX is newer more than 1 revision than ours: YY, cold sync is recommended</span><br></span></code></pre></div></div>
<p>In this case we recommend to re-create the database through a &quot;cold&quot; synchronization.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-cold-synchronization">The &quot;cold&quot; synchronization<a href="#the-cold-synchronization" class="hash-link" aria-label="Direct link to The &quot;cold&quot; synchronization" title="Direct link to The &quot;cold&quot; synchronization">â€‹</a></h3>
<p>This procedure is used to initialize a new slave or to recover a slave after the communications with the master is interrupted.</p>
<p>To synchronize the master host you need to stop rspamd service and create a dump of hash database. In theory, you can skip this step, however, if a version of the master increases by more than one while database cloning, it will be required to repeat the procedure:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sqlite3 /var/lib/rspamd/fuzzy.db &quot;.backup fuzzy.sql&quot;</span><br></span></code></pre></div></div>
<p>Afterwards, copy the output file <code>fuzzy.sql</code> to all the slaves (it can be done without stopping rspamd service on the slaves):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sqlite3 /var/lib/rspamd/fuzzy.db &quot;.restore fuzzy.sql&quot;</span><br></span></code></pre></div></div>
<p>After all, you can run rspamd on the slaves and then switch on the master.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-setup">Replication setup<a href="#replication-setup" class="hash-link" aria-label="Direct link to Replication setup" title="Direct link to Replication setup">â€‹</a></h3>
<p>You can set the replication in the hashes storage configuration file, namely <code>worker-fuzzy.inc</code>. Master replication is configured as follows:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Local keypair (rspamadm keypair -u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync_keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;xxx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;ppp&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Remote slave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;slave1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hosts = &quot;slave1.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key = &quot;yyy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;slave2&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hosts = &quot;slave2.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key = &quot;zzz&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Letâ€™s focus on configuring the encryption keys. Typically, rspamd automatically generates a keypair for clients and does not require any dedicated setup. However, in replication case, the master acts as the client, so you can set a specific (public) key on the slaves for better access control. The slaves will allow updates merely for hosts that are using this key. It is also possible to set allowed IP-addresses of the master, but public key based protection seems to be more reliable. Alternatively, you can combine these methods.</p>
<p>The slave setup looks similar:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># We assume it is slave1 with pubkey &#x27;yyy&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync_keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;yyy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;PPP&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Allow update from these hosts only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">masters = &quot;master.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Also limit updates to this specific public key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_key = &quot;xxx&quot;;</span><br></span></code></pre></div></div>
<p>To avoid conflicts with local hashes, you can set a flag translation from the master to the slave. For example, the following configuration can be used to translate the flags <code>1</code>, <code>2</code>, and <code>3</code> to <code>10</code>, <code>20</code>, and <code>30</code>, respectively:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_flags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;1&quot; = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;2&quot; = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;3&quot; = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-testing">Storage testing<a href="#storage-testing" class="hash-link" aria-label="Direct link to Storage testing" title="Direct link to Storage testing">â€‹</a></h2>
<p>To test the storage you can use <code>rspamadm control fuzzystat</code> command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Statistics for storage 73ee122ac2cfe0c4f12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invalid_requests: 6.69M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_expired: 35.57k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_found: (v0.6: 0), (v0.8: 0), (v0.9: 0), (v1.0+: 20.10M)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_stored: 425.46k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_shingles: (v0.6: 0), (v0.8: 41.78k), (v0.9: 23.60M), (v1.0+: 380.87M)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_checked: (v0.6: 0), (v0.8: 95.29k), (v0.9: 55.47M), (v1.0+: 1.01G)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Keys statistics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key id: icy63itbhhni8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Checked: 1.00G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Matched: 18.29M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Errors: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Added: 1.81M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Deleted: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IPs stat:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x.x.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Checked: 131.23M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Matched: 1.85M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Errors: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Added: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Deleted: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x.x.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Checked: 119.86M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span></code></pre></div></div>
<p>Primarily, a general storage statistics is shown, such as the number of stored and obsolete hashes, and the distribution of requests for client Protocol versions:</p>
<ul>
<li><code>v0.6</code> - requests from rspamd 0.6 - 0.8 (older versions, compatibility is limited)</li>
<li><code>v0.8</code> - requests from rspamd 0.8 - 0.9 (partially compatible)</li>
<li><code>v0.9</code> - unencrypted requests from rspamd 0.9+ (fully compatible)</li>
<li><code>v1.1</code> - encrypted requests from rspamd 1.1+ (fully compatible)</li>
</ul>
<p>And then detailed statistics is displayed for each of the keys configured in the storage and for the latest requested client IP-addresses. In conclusion, we see the overall statistics on IP-addresses.</p>
<p>To change the output from this command, you can use the following options:</p>
<ul>
<li><code>-n</code>: display raw numbers without reduction</li>
<li><code>--short</code>: do not display detailed statistics on the keys and IP-addresses</li>
<li><code>--no-keys</code>: do not show statistics on keys</li>
<li><code>--no-ips</code>: do not show statistics on IP-addresses</li>
<li><code>--sort</code>: sort:
<ul>
<li><code>checked</code>: by the number of trusted hashes (default)</li>
<li><code>matched</code>: by the number of found hashes</li>
<li><code>errors</code>: by the number of failed requests</li>
<li><code>ip</code>: by IP-address lexicographically</li>
</ul>
</li>
</ul>
<p>e.g.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm control fuzzystat -n</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/fuzzy_storage.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/pr/35/tutorials/scanning_outbound"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scanning outbound mail</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/pr/35/tutorials/redis_replication"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Multi-instance Redis replication</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#step-1-hash-sources-selection" class="table-of-contents__link toc-highlight">Step 1: Hash sources selection</a><ul><li><a href="#working-with-user-complaints" class="table-of-contents__link toc-highlight">Working with user complaints</a></li><li><a href="#configuring-spam-traps" class="table-of-contents__link toc-highlight">Configuring spam traps</a></li></ul></li><li><a href="#step-2-configuring-storage" class="table-of-contents__link toc-highlight">Step 2: Configuring storage</a><ul><li><a href="#sample-configuration" class="table-of-contents__link toc-highlight">Sample configuration</a></li><li><a href="#data-storage" class="table-of-contents__link toc-highlight">Data storage</a></li><li><a href="#hash-expiration" class="table-of-contents__link toc-highlight">Hash expiration</a></li><li><a href="#access-control" class="table-of-contents__link toc-highlight">Access control</a></li><li><a href="#transport-protocol-encryption" class="table-of-contents__link toc-highlight">Transport protocol encryption</a></li><li><a href="#hashes-replication" class="table-of-contents__link toc-highlight">Hashes replication</a></li></ul></li><li><a href="#step-3-configuring-fuzzy_check-plugin" class="table-of-contents__link toc-highlight">Step 3: Configuring <code>fuzzy_check</code> plugin</a><ul><li><a href="#condition-scripts-for-the-learning" class="table-of-contents__link toc-highlight">Condition scripts for the learning</a></li></ul></li><li><a href="#hashes-replication-1" class="table-of-contents__link toc-highlight">Hashes replication</a><ul><li><a href="#the-cold-synchronization" class="table-of-contents__link toc-highlight">The &quot;cold&quot; synchronization</a></li><li><a href="#replication-setup" class="table-of-contents__link toc-highlight">Replication setup</a></li></ul></li><li><a href="#storage-testing" class="table-of-contents__link toc-highlight">Storage testing</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/pr/35/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>