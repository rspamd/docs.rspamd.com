<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-modules/clickhouse" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Clickhouse module | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Clickhouse module | Rspamd Documentation"><meta data-rh="true" name="description" content="{:.no_toc}"><meta data-rh="true" property="og:description" content="{:.no_toc}"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/clickhouse" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Modules","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/"},{"@type":"ListItem","position":2,"name":"Clickhouse module","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/assets/js/runtime~main.d53a0eba.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/assets/js/main.64722b56.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/">Modules</a><button aria-label="Collapse sidebar category &#x27;Modules&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/antivirus">Antivirus module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/arc">ARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/asn">ASN module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/bayes_expiry">Bayes expiry module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/chartable">Chartable module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse">Clickhouse module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dcc">DCC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dkim">DKIM module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dkim_signing">DKIM signing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dmarc">DMARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/elastic">Elasticsearch module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/emails">Emails module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/external_relay">External Relay module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/external_services">External Services module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/force_actions">Force Actions module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/fuzzy_check">Fuzzy check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/gpt">GPT Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/greylisting">Greylisting module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/hfilter">Hfilter module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/history_redis">Redis history module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/ip_score">IP Score module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/known_senders">known_senders module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/maillist">Mailing lists module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/metadata_exporter">Metadata exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/metric_exporter">Metric exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mid">MID module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/milter_headers">Milter headers module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mime_types">Mime types modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/multimap">Multimap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mx_check">MX Check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/neural">Neural network module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/once_received">Once received module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/phishing">Phishing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit">Ratelimit module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/rbl">RBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/regexp">Regexp module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/replies">Replies module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/reputation">Reputation module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/rspamd_update">Rspamd update module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spamassassin">SpamAssassin rules module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spamtrap">Spamtrap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spf">SPF module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/surbl">SURBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/trie">Trie module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/url_redirector">URL redirector module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/whitelist">Whitelist module</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/vstakhov-docs-search/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/"><span>Modules</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Clickhouse module</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Clickhouse module</h1></header>
<p>{:.no_toc}</p>
<p>The Clickhouse module pushes a range of message-related metadata to an instance of <a href="https://clickhouse.yandex/" target="_blank" rel="noopener noreferrer">Clickhouse</a>, an open-source column-oriented database management system for real-time analytics. Information that could be collected includes: senders/recipients/scores of scanned messages and metadata such as DKIM/DMARC/bayes/fuzzy status &amp; information about URLs and attachments.</p>
<p>Additionally, this module enables you to construct your custom analytical dashboard using <a href="https://redash.io" target="_blank" rel="noopener noreferrer">Redash</a>, similar to using Elastic and Kibana.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="module-configuration">Module Configuration<a href="#module-configuration" class="hash-link" aria-label="Direct link to Module Configuration" title="Direct link to Module Configuration">​</a></h2>
<p>Example configuration shown below, for the minimum working configuration you need to define Clickhouse servers:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/clickhouse.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Push update when 1000 records are collected (1000 if unset) (until 2.1, see limits section below for &gt;2.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">limit = 1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP:port of Clickhouse server (&quot;localhost:8123&quot; if unset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server = &quot;localhost:8123&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Timeout to wait for response (5 seconds if unset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timeout = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many bits of sending IP to mask in logs for IPv4 (19 if unset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipmask = 19;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many bits of sending IP to mask in logs for IPv6 (48 if unset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipmask6 = 48;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Record URL paths? (default false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">full_urls = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This parameter points to a map of domain names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If a message has a domain in this map in From: header and DKIM signature,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># record general metadata in a table named after the domain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#from_tables = &quot;/etc/rspamd/clickhouse_from.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># store digest/hash of email (default false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_digest = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># store Symbols.Names, Symbols.Scores, Symbols.Options, Groups.Names and Groups.Scores (default false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_symbols = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># These are symbols of other checks in Rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set these if you use non-default symbol names (unlikely)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#bayes_spam_symbols = [&quot;BAYES_SPAM&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#bayes_ham_symbols = [&quot;BAYES_HAM&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ann_symbols_spam = {&#x27;NEURAL_SPAM&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ann_symbols_ham = {&#x27;NEURAL_HAM&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#fuzzy_symbols = [&quot;FUZZY_DENIED&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#whitelist_symbols = [&quot;WHITELIST_DKIM&quot;, &quot;WHITELIST_SPF_DKIM&quot;, &quot;WHITELIST_DMARC&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dkim_allow_symbols = [&quot;R_DKIM_ALLOW&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dkim_reject_symbols = [&quot;R_DKIM_REJECT&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dkim_dnsfail_symbols = {&#x27;R_DKIM_TEMPFAIL&#x27;, &#x27;R_DKIM_PERMFAIL&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dkim_na_symbols = {&#x27;R_DKIM_NA&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dmarc_allow_symbols = {&#x27;DMARC_POLICY_ALLOW&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dmarc_reject_symbols = {&#x27;DMARC_POLICY_REJECT&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dmarc_quarantine_symbols = {&#x27;DMARC_POLICY_QUARANTINE&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dmarc_softfail_symbols = {&#x27;DMARC_POLICY_SOFTFAIL&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#dmarc_na_symbols = {&#x27;DMARC_NA&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#spf_allow_symbols = {&#x27;R_SPF_ALLOW&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#spf_reject_symbols = {&#x27;R_SPF_FAIL&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#spf_dnsfail_symbols = {&#x27;R_SPF_DNSFAIL&#x27;, &#x27;R_SPF_PERMFAIL&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#spf_neutral_symbols = {&#x27;R_DKIM_TEMPFAIL&#x27;, &#x27;R_DKIM_PERMFAIL&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#spf_na_symbols = {&#x27;R_SPF_NA&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subject related (from 1.9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insert_subject = false; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Privacy is off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy = false; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Default hash-algorithm to obfuscate subject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_alg = &#x27;blake2&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prefix to show it&#x27;s obfuscated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_prefix = &#x27;obf&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cut the length of the hash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_length = 16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Other options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#database = &#x27;default&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#use_https = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Transport compression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#use_gzip = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Store data for local scanes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#allow_local = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Basic auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#user = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#password = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Disable SSL verification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#no_ssl_verify = false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This section configures how long the data will be stored in ClickHouse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#retention {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  # disabled by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  enable = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  # drop | detach, please refer to ClickHouse docs for details</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  # https://clickhouse.com/docs/en/sql-reference/statements/alter/partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  method = &quot;drop&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  # how many month the data should be kept in ClickHouse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  period_months = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  # how often run the cleanup process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  run_every = 7d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This section defines how often Rspamd will send data to Clickhouse (from 2.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#limits {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  max_rows = 1000; # How many rows are allowed (0 for disable this)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  max_memory = 50mb; # How many memory should be occupied before sending collection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  max_interval = 60s; # Maximum collection interval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="main-options">Main options<a href="#main-options" class="hash-link" aria-label="Direct link to Main options" title="Direct link to Main options">​</a></h4>
<ol>
<li><code>limit = 1000;</code>: Set the push update limit to 1000 records (default is 1000).</li>
<li><code>server = &quot;localhost:8123&quot;;</code>: Set the ClickHouse server&#x27;s IP and port (default is &quot;localhost:8123&quot;).</li>
<li><code>timeout = 5;</code>: Set the timeout for waiting for a response (default is 5 seconds).</li>
<li><code>ipmask = 19;</code>: Set the number of bits to mask in logs for IPv4 sender IPs (default is 19).</li>
<li><code>ipmask6 = 48;</code>: Set the number of bits to mask in logs for IPv6 sender IPs (default is 48).</li>
<li><code>full_urls = false;</code>: Disable recording URL paths (default is false).</li>
<li><code>from_tables</code>: (Commented) Points to a map of domain names to record general metadata in a table named after the domain.</li>
<li><code>enable_digest = false;</code>: Disable storing the email&#x27;s digest/hash (default is false).</li>
<li><code>enable_symbols = false;</code>: Disable storing Symbols.Names, Symbols.Scores, Symbols.Options, Groups.Names, and Groups.Scores (default is false).</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="other-options">Other options:<a href="#other-options" class="hash-link" aria-label="Direct link to Other options:" title="Direct link to Other options:">​</a></h4>
<ol>
<li><code>database</code>: Set the ClickHouse database name to be used for storing data (default is &#x27;default&#x27;).</li>
<li><code>use_https</code>: Set this option to &#x27;true&#x27; to enable HTTPS communication with the ClickHouse server (default is &#x27;false&#x27;).</li>
<li><code>use_gzip</code>: Set this option to &#x27;true&#x27; to enable transport compression when sending data to the ClickHouse server (default is &#x27;false&#x27;).</li>
<li><code>allow_local</code>: Set this option to &#x27;true&#x27; to store data for local scans (default is &#x27;false&#x27;).</li>
<li><code>user</code>: Set the username for basic authentication when connecting to the ClickHouse server (default is &#x27;null&#x27;, which means no authentication).</li>
<li><code>password</code>: Set the password for basic authentication when connecting to the ClickHouse server (default is &#x27;null&#x27;, which means no authentication).</li>
<li><code>no_ssl_verify</code>: Set this option to &#x27;true&#x27; to disable SSL certificate verification when connecting to the ClickHouse server over HTTPS (default is &#x27;false&#x27;, which means SSL certificate verification is enabled).</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="limits-section-from-rspamd-21">Limits section (from Rspamd 2.1):<a href="#limits-section-from-rspamd-21" class="hash-link" aria-label="Direct link to Limits section (from Rspamd 2.1):" title="Direct link to Limits section (from Rspamd 2.1):">​</a></h4>
<ol>
<li><code>max_rows</code>: Set the maximum number of rows allowed before sending the collected data to the ClickHouse server. If this limit is reached, the data will be sent immediately. A value of 0 disables this limit (default is not set).</li>
<li><code>max_memory</code>: Set the maximum amount of memory the collected data should occupy before sending it to the ClickHouse server. If this memory limit is reached, the data will be sent immediately. Use a value with a unit like &#x27;50mb&#x27; or &#x27;1gb&#x27; (default is not set).</li>
<li><code>max_interval</code>: Set the maximum time interval between sending collected data to the ClickHouse server. After this interval is reached, the data will be sent regardless of the number of rows or the amount of memory occupied. Use a value with a unit like &#x27;60s&#x27;, &#x27;5m&#x27;, or &#x27;1h&#x27; (default is not set).</li>
</ol>
<p>These options allow you to control how often Rspamd sends data to the ClickHouse server based on the number of rows, memory usage, and time interval. By configuring these limits, you can optimize the performance and resource usage of your Rspamd and ClickHouse instances.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clickhouse-retention">Clickhouse retention<a href="#clickhouse-retention" class="hash-link" aria-label="Direct link to Clickhouse retention" title="Direct link to Clickhouse retention">​</a></h3>
<p>Privacy is a crucial consideration in many email systems. The Clickhouse dumps may contain sensitive client data. Rspamd supports automatic cleanup of the outdated data using <strong>retention policies</strong>. By default, data is not expired in Clickhouse, but expiration can be set to comply with regulations such as the General Data Protection Regulation (GDPR) as follows:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/clickhouse.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retention {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # drop | detach, please refer to ClickHouse docs for details</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://clickhouse.com/docs/en/sql-reference/statements/alter/partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = &quot;drop&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # how many month the data should be kept in ClickHouse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  period_months = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # how often run the cleanup process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_every = 7d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>To remove data for particular users, you might consider using of the <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter#mutations" target="_blank" rel="noopener noreferrer">Clickhouse mutations</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="subject-privacy">Subject privacy<a href="#subject-privacy" class="hash-link" aria-label="Direct link to Subject privacy" title="Direct link to Subject privacy">​</a></h3>
<p>Similarly to previous, from the version 1.9, you can store email subject in Clickhouse (disabled by default). The following settings are available:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">insert_subject = false; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Privacy is off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy = false; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Default hash-algorithm to obfuscate subject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_alg = &#x27;blake2&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prefix to show it&#x27;s obfuscated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_prefix = &#x27;obf&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cut the length of the hash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subject_privacy_length = 16;</span><br></span></code></pre></div></div>
<p>You can use obfuscated subjects to group messages with a same subject for example.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="extra-columns">Extra columns<a href="#extra-columns" class="hash-link" aria-label="Direct link to Extra columns" title="Direct link to Extra columns">​</a></h3>
<p>You can also extract additional data and add it to a set of extra columns. This feature is available from the version Rspamd 2.4 and Clickhouse 19.3.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/clickhouse.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_columns = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mime_From = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                selector = &quot;from(&#x27;mime&#x27;):addr&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                type = &quot;String&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # this is the returning answer if the value is null </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                default_value = &quot;none&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                comment = &quot;Mime from column&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mime_Rcpt = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                selector = &quot;rcpts(&#x27;mime&#x27;):addr&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                type = &quot;Array(String)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clickhouse-usage-examples">Clickhouse usage examples<a href="#clickhouse-usage-examples" class="hash-link" aria-label="Direct link to Clickhouse usage examples" title="Direct link to Clickhouse usage examples">​</a></h2>
<p>Clickhouse module is extremely useful to perform statistical researches for mail flows. For example, to find top sending domains for spam and ham:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Action</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reject&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Action</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;add header&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(222, 71, 0)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─</span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain">────────────┬──────c─┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com         │ </span><span class="token number" style="color:#36acaa">152931</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com         │ </span><span class="token number" style="color:#36acaa">102123</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ gmail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com       │  </span><span class="token number" style="color:#36acaa">60865</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ yahoo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com       │  </span><span class="token number" style="color:#36acaa">58832</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com         │  </span><span class="token number" style="color:#36acaa">58082</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┴────────┘</span><br></span></code></pre></div></div>
<p>Or messages with failed DKIM and DMARC groupped by domain:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IsDkim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reject&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(222, 71, 0)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─</span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain">─────────────────┬─IP─────────────┬─────c─┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xxx              │ xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx    │ </span><span class="token number" style="color:#36acaa">27542</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xxx              │ xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yy    │ </span><span class="token number" style="color:#36acaa">24958</span><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────┴────────────────┴───────┘</span><br></span></code></pre></div></div>
<p>Or perform some attachments analysis (e.g. top attachments types for Spam):</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARRAY </span><span class="token keyword" style="color:rgb(222, 71, 0)">JOIN</span><span class="token plain"> Attachments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContentType </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Action</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reject&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Action</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;add header&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(222, 71, 0)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────c─┬─d────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ddd    │ image</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jpeg               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ddd    │ image</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">png                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ddd    │ application</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">octet</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">stream │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ddd    │ image</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">gif                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ddd    │ application</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">msword       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────┴──────────────────────────┘</span><br></span></code></pre></div></div>
<p>Rspamd also provides the capability to send data copies for specific domains to separate tables, making analytics easier.</p>
<p>For mailing lists, Rspamd sends list ids which allows to provide very precise statistics for each particular mailing list:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ListId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ListId </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ListId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> c </span><span class="token keyword" style="color:rgb(222, 71, 0)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─ListId───────────────────────────────┬─IP──────────────┬──────c─┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ xxx                                  │ xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xx     │ dddd   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────┴─────────────────┴────────┘</span><br></span></code></pre></div></div>
<p>Using extra columns (see <a href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse#extra-columns">Configuration</a>)</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mime_From</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mime_Rcpt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> TS </span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─</span><span class="token keyword" style="color:rgb(222, 71, 0)">From</span><span class="token plain">─────────────────┬─Mime_From─────────────┬─────Mime_Rcpt─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ example</span><span class="token variable" style="color:#36acaa">@example.com</span><span class="token plain">  │ example</span><span class="token variable" style="color:#36acaa">@example.com</span><span class="token plain">   │ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;test@example.com&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ test</span><span class="token variable" style="color:#36acaa">@test.com</span><span class="token plain">        │ hello</span><span class="token variable" style="color:#36acaa">@test.com</span><span class="token plain">        │ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;no@simple.test.com&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────┴───────────────────────┴───────────────────────────┘</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="urls-storage">URLs storage<a href="#urls-storage" class="hash-link" aria-label="Direct link to URLs storage" title="Direct link to URLs storage">​</a></h2>
<p>This text has been contributed by <a href="https://github.com/citrin" target="_blank" rel="noopener noreferrer">Anton Yuzhaninov</a></p>
<p>From version 2.8, Rspamd stores URLs from all sources, together with the corresponding flags.
To differentiate different types we&#x27;ve added <code>Urls.Flags</code> column which will contain all flags as an integer.</p>
<p>All currently used bit flags are listed here:
<a href="https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17" target="_blank" rel="noopener noreferrer">https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17</a></p>
<p>For example, to exclude <code>img_src</code> and <code>PDF</code> URLs and keep all other URLs (old behaviour) one needs to exclude Urls where <code>bit 19</code> (img) or <code>bit 21</code> (content == pdf) are set: <code>bitTest(Flags, 19)</code>. If you don&#x27;t mind having additional urls in <code>Urls.Url</code> column you can continue use it as is.</p>
<p>Here are some examples explained:</p>
<ul>
<li>The first line (regular_urls) is what has been logged originally;</li>
<li>The second line - urls from html img tag src attribue</li>
<li>The third line - urls extracted by content module; currently, it contains only PDF Urls</li>
</ul>
<p>Numbers <code>19</code>, <code>21</code>, <code>22</code> correspond to flags <code>RSPAMD_URL_FLAG_IMAGE</code>, <code>RSPAMD_URL_FLAG_CONTENT</code>, <code>RSPAMD_URL_FLAG_NO_TLD</code>: <a href="https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17" target="_blank" rel="noopener noreferrer">https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17</a></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       MessageId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       arrayMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> bitTestAny</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayZip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> regular_urls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       arrayMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayZip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> img_src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       arrayMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arrayZip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> pdf_urls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021-02-26&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> arrayExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> bitTestAny</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250</span><br></span></code></pre></div></div>
<p>Not all flags are equally interesting, but some are: for example <code>bitTest(Urls.Flags, 1)</code> allows much faster select URls with IP than a regexp for <code>Urls.Url</code>.
<code>Bit 20</code> allows to select for urls that we extract from query args in other urls (e. g. Rspamd extracts <code>to.com</code> in <code>http://example.com/foo?redirect=http://to.com</code>):</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tld</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> phished</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">numeric</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> html_disp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> txt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> subj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> has_port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> no_schema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> not_norm</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> disp_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> img_src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> from_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> pdf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       bitTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">AS</span><span class="token plain"> no_tld</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">FROM</span><span class="token plain"> rspamd ARRAY </span><span class="token keyword" style="color:rgb(222, 71, 0)">JOIN</span><span class="token plain"> Urls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">Date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> today</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> TS </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> subtractHours</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> bitTestAny</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">BY</span><span class="token plain"> TS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/clickhouse.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/chartable"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chartable module</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dcc"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">DCC module</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#module-configuration" class="table-of-contents__link toc-highlight">Module Configuration</a><ul><li><a href="#clickhouse-retention" class="table-of-contents__link toc-highlight">Clickhouse retention</a></li><li><a href="#subject-privacy" class="table-of-contents__link toc-highlight">Subject privacy</a></li><li><a href="#extra-columns" class="table-of-contents__link toc-highlight">Extra columns</a></li></ul></li><li><a href="#clickhouse-usage-examples" class="table-of-contents__link toc-highlight">Clickhouse usage examples</a></li><li><a href="#urls-storage" class="table-of-contents__link toc-highlight">URLs storage</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>