<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-modules/ratelimit" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Ratelimit module | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ratelimit module | Rspamd Documentation"><meta data-rh="true" name="description" content="{:.no_toc}"><meta data-rh="true" property="og:description" content="{:.no_toc}"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/ratelimit" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Modules","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/"},{"@type":"ListItem","position":2,"name":"Ratelimit module","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/assets/js/runtime~main.d53a0eba.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/assets/js/main.64722b56.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/">Modules</a><button aria-label="Collapse sidebar category &#x27;Modules&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/antivirus">Antivirus module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/arc">ARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/asn">ASN module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/bayes_expiry">Bayes expiry module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/chartable">Chartable module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/clickhouse">Clickhouse module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dcc">DCC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dkim">DKIM module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dkim_signing">DKIM signing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/dmarc">DMARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/elastic">Elasticsearch module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/emails">Emails module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/external_relay">External Relay module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/external_services">External Services module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/force_actions">Force Actions module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/fuzzy_check">Fuzzy check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/gpt">GPT Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/greylisting">Greylisting module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/hfilter">Hfilter module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/history_redis">Redis history module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/ip_score">IP Score module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/known_senders">known_senders module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/maillist">Mailing lists module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/metadata_exporter">Metadata exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/metric_exporter">Metric exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mid">MID module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/milter_headers">Milter headers module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mime_types">Mime types modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/multimap">Multimap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/mx_check">MX Check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/neural">Neural network module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/once_received">Once received module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/phishing">Phishing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/ratelimit">Ratelimit module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/rbl">RBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/regexp">Regexp module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/replies">Replies module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/reputation">Reputation module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/rspamd_update">Rspamd update module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spamassassin">SpamAssassin rules module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spamtrap">Spamtrap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/spf">SPF module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/surbl">SURBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/trie">Trie module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/url_redirector">URL redirector module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/whitelist">Whitelist module</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/vstakhov-docs-search/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/"><span>Modules</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Ratelimit module</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ratelimit plugin</h1></header>
<p>{:.no_toc}</p>
<p>Ratelimit plugin is designed to limit messages coming from certain senders, to
certain recipients from certain IP addresses combining these parameters into
a separate limits.</p>
<p>To enable a shared cache across multiple scanners, all the established limits are securely stored within a <a href="https://redis.io" target="_blank" rel="noopener noreferrer">Redis server</a> (or a cluster of servers).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="module-configuration">Module configuration<a href="#module-configuration" class="hash-link" aria-label="Direct link to Module configuration" title="Direct link to Module configuration">​</a></h2>
<p>By default, no cache servers are specified in the configuration, meaning that the module <strong>will not work</strong> until this option is added.</p>
<p><code>Ratelimit</code> module supports the following configuration options:</p>
<ul>
<li><code>servers</code> - list of servers where ratelimit data is stored; <a href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration/redis">global settings</a> used if not set</li>
<li><code>symbol</code> - if this option is specified, then <code>ratelimit</code> plugin just adds the corresponding symbol instead of setting pre-result, the value is scaled as $$ 2 * tanh(\frac{bucket}{threshold * 2}) $$, where <code>tanh</code> is the hyperbolic tangent function</li>
<li><code>info_symbol</code> (1.7.0+) - if this option is specified the corresponding symbol is inserted <em>in addition to</em> setting pre-result.</li>
<li><code>whitelisted_rcpts</code> - comma separated list of whitelisted recipients. By default
the value of this option is &#x27;postmaster, mailer-daemon&#x27;. Supported entries are:
<ul>
<li>user part of the address</li>
<li>full address part of the address (1.7.0+).</li>
</ul>
</li>
<li><code>whitelisted_ip</code> - a map of ip addresses or networks whitelisted</li>
<li><code>whitelisted_user</code> - a map of usernames which are excluded from user ratelimits</li>
<li><code>expire</code> - maximum lifetime for any limit bucket (2 days by default)</li>
<li><code>dynamic_rate_limit</code> (3.9.0+) - enable dynamic ratelimit multipliers (default: false)</li>
<li><code>ham_factor_rate</code> - multiplier for rate when a ham message arrives (default: 1.01)</li>
<li><code>spam_factor_rate</code> - multiplier for rate when a spam message arrives (default: 0.99)</li>
<li><code>ham_factor_burst</code> - multiplier for burst when a ham message arrives (default: 1.02)</li>
<li><code>spam_factor_burst</code> - multiplier for burst when a spam message arrives (default: 0.98)</li>
<li><code>max_rate_mult</code> - maximum and minimum (1/X) dynamic multiplier for rate (default: 5)</li>
<li><code>max_bucket_mult</code> -  maximum and minimum (1/X) dynamic multiplier for rate (default: 10)</li>
<li><code>allow_local</code> - a boolean that enables rate-limiting of local requests from rspamc or controller, including WebUI (default: false)</li>
<li><code>rates</code> - a table of allowed rates in several forms</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ratelimit-record">Ratelimit record<a href="#ratelimit-record" class="hash-link" aria-label="Direct link to Ratelimit record" title="Direct link to Ratelimit record">​</a></h3>
<p>Starting from version 1.8.2, it is possible to define ratelimit buckets using the <a href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration/selectors">selectors framework</a>.
This means that you can opt to use either a selector or one of the predefine ratelimits:</p>
<ul>
<li><code>bounce_to</code>: limit bounces per recipient</li>
<li><code>bounce_to_ip</code>: limit bounces per recipient per ip</li>
<li><code>selector</code>: limit per arbitrary string returned by selector</li>
<li><code>to</code>: limit per recipient</li>
<li><code>to_ip</code>: limit per pair of recipient and sender&#x27;s IP address</li>
<li><code>to_ip_from</code>: limit per triplet: recipient, sender&#x27;s envelope from and sender&#x27;s IP</li>
<li><code>user</code>: limit per authenticated user (useful for outbound limits)</li>
</ul>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/ratelimit.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rates {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Selector based ratelimit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    some_limit = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &#x27;user.lower&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # You can define more than one bucket, however, you need to use array syntax only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      bucket = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        burst = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate = &quot;10 / 1min&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        burst = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate = &quot;100 / 1min&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Predefined ratelimit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      bucket = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        burst = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate = 0.01666666666666666666; # 1 message per minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # or define it with selector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    other_limit_alt = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &#x27;rcpts:addr.take_n(5)&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      bucket = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        burst = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate = &quot;1 / 1m&quot;; # 1 message per minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre></div></div>
<p>The following settings are valid inside <code>bucket</code> configuration:</p>
<ul>
<li><code>burst</code>: numeric value specifying the capacity of the bucket</li>
<li><code>rate</code>: rate at which tokens are added to the bucket, expressed as numeric value (equivalent to messages per second) or string (number per period)
Since version 2.0:</li>
<li><code>skip_recipients</code>: if set to <code>true</code>, the number of recipients is not used as a multiplier
Since version 3.1:</li>
<li><code>message</code>: Message to use for soft-reject</li>
<li><code>symbol</code>: like the top-level <code>symbol</code> option but per-bucket; indicated symbol is inserted instead of applying <code>soft reject</code></li>
<li><code>skip_soft_reject</code>: if set to <code>true</code>, <code>soft reject</code> is not applied</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="principles-of-operation">Principles of operation<a href="#principles-of-operation" class="hash-link" aria-label="Direct link to Principles of operation" title="Direct link to Principles of operation">​</a></h2>
<p>Rspamd utilizes the <strong>token bucket</strong> algorithm for rate-limiting, a mechanism that can be visualized as a finite-capacity bucket. This bucket is periodically replenished with tokens at set intervals. Each message processed by Rspamd expends one token. If the bucket is empty, the message is delayed (soft rejected). This design permits a burst of messages as long as tokens remain in the bucket. Once the bucket reaches its limit (full), no further tokens are added until some of existing ones are consumed. Once the tokens are depleted, subsequent messages are delayed until tokens are replenished over time. This strategy ensures that the flow of messages does not exceed a predefined rate.</p>
<p>The <strong>token bucket</strong> algorithm operates as follows:</p>
<ol>
<li><strong>Checking phase</strong>: During this phase, tokens are incrementally added to the specified bucket at a constant rate. If the bucket is full, incoming tokens are discarded. When a message arrives, Rspamd checks if the message can acquire a token from the designated rate bucket, and if there are sufficient tokens, the message is processed immediately; otherwise, the it is temporarily deferred (leading to a soft reject action).</li>
<li><strong>Bucket state update</strong>: After a message has been processed, whether delivered or rejected, Rspamd updates the bucket&#x27;s state, removing a token per processed message. This phase also includes the adjustment of dynamic multipliers to adapt to varying traffic patterns.</li>
</ol>
<p>Before version 3.9.0, the dynamic rate-limit feature was enabled by default. Starting from version 3.9.0, this feature is disabled by default and requires explicit activation in the configuration. Alternatively, you can configure the <code>ham_factor_rate</code>/<code>spam_factor_rate</code> and/or <code>ham_factor_burst</code>/<code>spam_factor_burst</code> multipliers for individual buckets as needed.</p>
<p>To better illustrate the concept of dynamic multipliers, refer to the sample graph below. It demonstrates how the burst multiplier varies depending on the number of received ham messages (x &gt; 0) and spam messages (x &lt; 0):</p>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" width="75%" src="/img/ratelimit.png">
<p>Specialized buckets are used for managing bounce messages, which lack a <code>from</code> component and have stricter limits. Rspamd recognizes the following as bounce senders:</p>
<ul>
<li>&#x27;postmaster&#x27;</li>
<li>&#x27;mailer-daemon&#x27;</li>
<li>&#x27;&#x27; (empty sender)</li>
<li>&#x27;null&#x27;</li>
<li>&#x27;fetchmail-daemon&#x27;</li>
<li>&#x27;mdaemon&#x27;</li>
</ul>
<p>Each recipient is associated with own set of three buckets, making it advantageous to limit the number of recipients that are being checked.</p>
<p>Each bucket is defined by four parameters:</p>
<ul>
<li><code>capacity</code> - the total number of tokens a bucket can hold, corresponding to the maximum number of messages that can be processed before reaching the limit.</li>
<li><code>rate</code> - the frequency of token insertion into the bucket, measured in tokens (messages) per unit of time, reflecting the steady message rate.</li>
<li><code>dynamic_rate</code> - the current dynamic rate multiplier, which adjusts the token addition rate based on traffic patterns.</li>
<li><code>dynamic_burst</code> - the current dynamic burst multiplier, which affects the maximum burst size under certain conditions.</li>
</ul>
<p>For example, a bucket with a <strong>capacity</strong> of <code>100</code> and a <strong>rate</strong> of <code>1</code> can handle up an initial burst up to 100 messages, and subsequently maintains a steady throughput of one message per second once the bucket is empty.</p>
<p>It is important to note that the ratelimit module does not define any rates that could effectively disable the module by default.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-defined-ratelimits">User-defined ratelimits<a href="#user-defined-ratelimits" class="hash-link" aria-label="Direct link to User-defined ratelimits" title="Direct link to User-defined ratelimits">​</a></h3>
<p>Users can define their own keywords to create ratelimits by following steps as below. Consider using <code>selectors</code> instead.</p>
<p>First, add the <code>custom_keywords</code> setting to the configuration file, pointing to a Lua script that will be created:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   custom_keywords = &quot;/etc/rspamd/custom_ratelimit.lua&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   # other settings ...</span><br></span></code></pre></div></div>
<p>Next, create a Lua script that returns a table containing the custom function(s). For instance, the following table (&quot;custom_keywords&quot;) contains a function (&quot;customrl&quot;) that applies ratelimits to users only when the user is found in a map:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> custom_keywords </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> d </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- create map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;badusers&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">add_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;url&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/etc/rspamd/badusers.map&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;type&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;set&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;description&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bad users&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_keywords</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">customrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rspamd_logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;rspamd_logger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- get authenticated user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_user</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- define a ratelimit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- a ratelimit can be defined in simplified form (10 / 1m) or as a bucket config (table)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> crl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10 / 1m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">not</span><span class="token plain"> user </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- no user, return nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;badusers&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rspamd_logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">infox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;User %s is bad, returning custom ratelimit %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> crl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- return redis hash to store rl data and a ratelimit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- our redis hash will be &quot;rs_custom_rl_john.doe&quot; assuming user == john.doe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rs_customrl_&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">..</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> crl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- user is not in map, return nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> custom_keywords</span><br></span></code></pre></div></div>
<p>The &quot;custom_keywords&quot; table should define one or more functions that receive the <a href="/docs.rspamd.com/branches/vstakhov-docs-search/lua/rspamd_task">task object</a> as input. Each function should return a Redis hash <em>and</em> a limit, for example <code>return my_redis_hash, &quot;10 / 1m&quot;</code>. Alternatively, a function can return <code>nil</code> to indicate that the ratelimit should not be applied. The ratelimit returned can be in simplified form or a bucket config table.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="legacy-ratelimit-record">Legacy ratelimit record<a href="#legacy-ratelimit-record" class="hash-link" aria-label="Direct link to Legacy ratelimit record" title="Direct link to Legacy ratelimit record">​</a></h3>
<p>In versions of Rspamd prior to 1.8, ratelimits were defined as follows:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type = [burst,rate];</span><br></span></code></pre></div></div>
<p>Where <code>type</code> refers to the type of ratelimit, which could be:</p>
<ul>
<li><code>bounce_to</code>: limit bounces per recipient</li>
<li><code>bounce_to_ip</code>: limit bounces per recipient per ip</li>
<li><code>to</code>: limit per recipient</li>
<li><code>to_ip</code>: limit per pair of recipient and sender&#x27;s IP address</li>
<li><code>to_ip_from</code>: limit per triplet: recipient, sender&#x27;s envelope from and sender&#x27;s IP</li>
<li><code>user</code>: limit per authenticated user (useful for outbound limits)</li>
</ul>
<p>The <code>burst</code> attribute represents the bucket&#x27;s capacity, while <code>rate</code> indicates the frequency of token replenishment, measured in messages per second. Both values are expressed as floating-point numbers.</p>
<p>From version <code>1.5</code>, it became possible to define limits using a simplified form. For example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bounce_to = &quot;2 / 5m&quot;;</span><br></span></code></pre></div></div>
<p>This line defines a bucket capable of a 2-message burst and a steady rate of 2 messages within each 5-minute interval.</p>
<p>Suffixes may be used to specify both time and message quantities.</p>
<p>Valid suffixes for periods are:</p>
<ul>
<li><code>s</code>: seconds</li>
<li><code>m</code>: minutes</li>
<li><code>h</code>: hours</li>
<li><code>d</code>: days</li>
</ul>
<p>Valid suffixes for amounts are:</p>
<ul>
<li><code>k</code>: thousands</li>
<li><code>m</code>: millions</li>
<li><code>g</code>: billions</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="changes-in-the-module">Changes in the module<a href="#changes-in-the-module" class="hash-link" aria-label="Direct link to Changes in the module" title="Direct link to Changes in the module">​</a></h2>
<p><strong>From version 3.1</strong>, buckets can also define their custom symbols or messages, for example like this:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/ratelimit.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rates = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_bucket = { symbol = &quot;SOME_NAME&quot;; selector = ...; rate = ...;}  # inserts SOME_NAME symbol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_other_bucket = { symbol = &quot;OTHER_NAME&quot;; selector = ...; rate = ...;}  # inserts OTHER_NAME symbol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>From version 3.9.0</strong>, the <code>dynamic_rate_limit</code> option was introduced, which enables dynamic ratelimit multipliers. This option is disabled by default.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/ratelimit.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/phishing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Phishing module</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules/rbl"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RBL module</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#module-configuration" class="table-of-contents__link toc-highlight">Module configuration</a><ul><li><a href="#ratelimit-record" class="table-of-contents__link toc-highlight">Ratelimit record</a></li></ul></li><li><a href="#principles-of-operation" class="table-of-contents__link toc-highlight">Principles of operation</a><ul><li><a href="#user-defined-ratelimits" class="table-of-contents__link toc-highlight">User-defined ratelimits</a></li><li><a href="#legacy-ratelimit-record" class="table-of-contents__link toc-highlight">Legacy ratelimit record</a></li></ul></li><li><a href="#changes-in-the-module" class="table-of-contents__link toc-highlight">Changes in the module</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>