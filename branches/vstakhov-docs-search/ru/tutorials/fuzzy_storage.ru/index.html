<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorials/fuzzy_storage.ru" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Использование fuzzy хешей | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/fuzzy_storage.ru"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Использование fuzzy хешей | Rspamd Documentation"><meta data-rh="true" name="description" content="English version"><meta data-rh="true" property="og:description" content="English version"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/fuzzy_storage.ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/fuzzy_storage.ru" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/fuzzy_storage.ru" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/tutorials/fuzzy_storage.ru" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/runtime~main.beea35c1.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/main.d2abe2f4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">Documentation</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/usage_policy">Usage Policy</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Использование fuzzy хешей</h1></header>
<p><a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/fuzzy_storage">English version</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="введение">Введение<a href="#введение" class="hash-link" aria-label="Прямая ссылка на Введение" title="Прямая ссылка на Введение">​</a></h2>
<p>Нечеткие хеши (fuzzy hashes) используются для поиска <strong>похожих</strong> писем - то есть, при помощи такого метода можно найти сообщения, которые содержат такой же или незначительно измененный текст. Данная технология хорошо подходит для блокировки спам-рассылок, которые отправляются сразу многим пользователям. Так как хеш функция однонаправлена, то восстановить исходный текст, имея только хеш, невозможно, что позволяет направлять запросы сторонним хранилищам хешей без риска раскрытия информации.</p>
<p>Следует отметить, что rspamd использует нечеткие хеши не только для сравнения текстовых данных, но и изображений и других вложений в письмах. Однако в этом случае отсутсвует элемент нечеткой логики, и rspamd ищет точные соответствия для одинаковых объектов.</p>
<p>Данная статья предназначена для администраторов почтовых систем, которые хотят создать собственное хранилище хешей и обучать его самостоятельно.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="шаг-1-выбор-источников-хешей">Шаг 1: выбор источников хешей<a href="#шаг-1-выбор-источников-хешей" class="hash-link" aria-label="Прямая ссылка на Шаг 1: выбор источников хешей" title="Прямая ссылка на Шаг 1: выбор источников хешей">​</a></h2>
<p>В первую очередь необходимо выбрать источники образцов спама для обучения. Основной принцип - использование для обучения спам-рассылок, которые приходят многим пользователям. Существует два основных подхода к решению подобной задачи:</p>
<ul>
<li>использование жалоб пользователей;</li>
<li>создание ловушек для спама (honeypot).</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="использование-жалоб-пользователей">Использование жалоб пользователей<a href="#использование-жалоб-пользователей" class="hash-link" aria-label="Прямая ссылка на Использование жалоб пользователей" title="Прямая ссылка на Использование жалоб пользователей">​</a></h3>
<p>Пользователи являются одним из ресурсов, позволяющих оценивать качество работы системы фильтрации спама, поэтому желательно предусмотреть механизм использования жалоб пользователей для обучения хранилища хешей. К сожалению, пользователи часто жалуются и на легитимные письма, на которые они сами же и подписались: рассылки магазинов, уведомления от систем бронирования билетов и даже на личные письма, которые им по каким-то причинам не нравятся. Многие пользователи просто не видят разницу между кнопками &quot;удалить&quot; и &quot;пожаловаться на спам&quot;. Возможно, хорошей идеей будет запросить у пользователя дополнительную информацию о жалобе, например, почему он считает, что это письмо спам, а так же обратить внимание пользователя на то, что он может отписаться от получения рассылок.</p>
<p>Другим способом решения этой проблемы является ручная обработка жалоб пользователей на спам или же комбинация методов: назначить больший вес письмам, обработанным вручную, и меньший - всем остальным жалобам.</p>
<p>В rspamd также есть две возможности, позволяющие отсеивать некоторые &quot;ложные&quot; срабатывания:</p>
<ol>
<li>вес хеша;</li>
<li>фильтры обучения.</li>
</ol>
<p>Первый метод довольно прост: давайте назначим каждой жалобе некоторый вес и при каждом обучении будем прибавлять его к сохраненному значению соответствующего хеша. При проверке мы не будем учитывать хеши, вес которых меньше заданного порога. Например, если вес жалобы <code>w=1</code>, а порог срабатывания <code>t=20</code>, то для начала срабатывания хеша необходимо как минимум 20 жалоб пользователей. Кроме этого, при проверке для хеша, превышающего пороговое значение, rspamd назначает не максимальные очки, а их величина плавно растет от нуля до максимума (до значения метрики) при изменении веса хеша от порогового до удвоенного порогового значения (t .. 2*t).</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-1.png" width="50%"></center>
<p>Второй метод - фильтры обучения - позволяет написать некоторые условия на языке Lua, которые запрещают обучение, скажем, для писем с определенного домена (например, facebook.com). Возможности фильтров достаточно обширны, но требуют ручной работы по их настройке.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="настройка-ловушек-спама">Настройка ловушек спама<a href="#настройка-ловушек-спама" class="hash-link" aria-label="Прямая ссылка на Настройка ловушек спама" title="Прямая ссылка на Настройка ловушек спама">​</a></h3>
<p>Для данного метода необходимо иметь такие почтовые адреса, на которые не приходит легитимная почта, зато приходит много спама. Основная идея заключается в том, чтобы &quot;засветить&quot; адрес в базах спамеров, не показывая его легитимным пользователям. Для этого можно, например, разместить на достаточно популярном веб-сайте элемент <em>iframe</em>, который не отображается пользователям (имеет свойство <em>hidden</em> или нулевой видимый размер), но содержит доступные ботам email-адреса ловушек. В последнее время этот метод стал не очень эффективен, так как спамеры научились обходить такие приемы.</p>
<p>Другой возможный способ создания ловушки - это поиск доменов, бывших ранее популярными, но не работающих в настоящее время (адреса из этих доменов находятся во многих спамерских базах). В этом случае нужны фильтры обучения, так как высока вероятность того, что в &quot;черный&quot; список попадут легитимные письма, например, от социальных сетей или служб рассылки.</p>
<p>В целом, создание собственных ловушек оправдано только в случае большой почтовой системы, так как это может быть затратно как в плане трудности сопровождения, так и в виде прямых материальных расходов на покупку доменов.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="шаг-2-настройка-хранилища">Шаг 2: Настройка хранилища<a href="#шаг-2-настройка-хранилища" class="hash-link" aria-label="Прямая ссылка на Шаг 2: Настройка хранилища" title="Прямая ссылка на Шаг 2: Настройка хранилища">​</a></h2>
<p>В данной главе я рассмотрю основные настройки хранилища и как оптимизировать его работу.</p>
<p><strong>Важное замечание:</strong> хранилище работает не с письмами, а с готовыми хешами. То есть, чтобы преобразовать письмо в его хеш нужен отдельный процесс сканера или контроллера:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-2.png" width="75%"></center>
<p>Функции хранилища:</p>
<ol>
<li>Хранение и проверка хешей</li>
<li>Транспортное шифрование протокола</li>
<li>Удаление устаревших хешей</li>
<li>Контроль доступа (как на запись, так и на чтение)</li>
<li>Репликация (с версии 1.3)</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="архитектура-хранилища">Архитектура хранилища<a href="#архитектура-хранилища" class="hash-link" aria-label="Прямая ссылка на Архитектура хранилища" title="Прямая ссылка на Архитектура хранилища">​</a></h3>
<p>Для хранения данных используется sqlite3, и это накладывает некоторые ограничения на архитектуру хранилища.</p>
<p>Во-первых, sqlite крайне плохо работает при конкурентных запросах на запись: в этом случае производительность СУБД падает на несколько порядков. Во-вторых, довольно затруднительно обеспечивать репликацию и масштабирование базы данных, так как для этого нужны сторонние инструменты.</p>
<p>В связи с этим, хранилище хешей rspamd всегда выполняет запись в БД строго из одного процесса. Для этого один из процессов ведет очередь обновлений, а остальные процессы просто передают запросы на запись от клиентов в эту общую очередь. По умолчанию очередь сбрасывается на диск один раз в минуту. Таким образом, хранилище рассчитано на профиль нагрузки с преобладанием запросов на чтение.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="устаревание-хешей">Устаревание хешей<a href="#устаревание-хешей" class="hash-link" aria-label="Прямая ссылка на Устаревание хешей" title="Прямая ссылка на Устаревание хешей">​</a></h3>
<p>Другой важной задачей хранилища является удаление устаревших хешей из базы. Так как обычно пордолжительность рассылок спама ограничена, то нет смысла хранить хеши постоянно. Разумным будет сопоставить количество хешей, которые приходят на обучение в течение определенного времени, с достаточным для их хранения размером оперативной памяти. Например, 400 тысяч хешей занимают около 100 мегабайт, а полтора миллиона хешей занимают уже полгигабайта.</p>
<p>Не рекомендуется допускать увеличение базы до объема, который превышает размер доступной оперативной памяти, из-за значительного ухудшения производительности. Кроме того, нет смысла хранить хеши дольше, чем приблизительно три месяца. Поэтому, если у вас небольшое количество хешей, пригодных для обучения, то лучше установить устаревание в 90 дней. В противном случае лучше установить более короткий период устаревания.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="пример-настройки">Пример настройки<a href="#пример-настройки" class="hash-link" aria-label="Прямая ссылка на Пример настройки" title="Прямая ссылка на Пример настройки">​</a></h3>
<p>За хранение нечетких хешей отвечает процесс rspamd под названием <code>fuzzy_storage</code>. Для включения и настройки этого процесса можно использовать локальный файл конфигурации rspamd: <code>etc/rspamd/rspamd.conf.local</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Socket to listen on (UDP and TCP from rspamd 1.3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bind_socket = &quot;*:11335&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Number of processes to serve this storage (useful for read scaling)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Backend (&quot;sqlite&quot; or &quot;redis&quot; - default &quot;sqlite&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;sqlite&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # sqlite: Where data file is stored (must be owned by rspamd user)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database = &quot;${DBDIR}/fuzzy.db&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Hashes storage time (3 months)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expire = 90d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Synchronize updates to the storage each minute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync = 1min;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="настройки-доступа">Настройки доступа<a href="#настройки-доступа" class="hash-link" aria-label="Прямая ссылка на Настройки доступа" title="Прямая ссылка на Настройки доступа">​</a></h3>
<p>По умолчанию rspamd не разрешает модифицировать данные в хранилище. Для того чтобы обучение было возможно, необходимо задать список доверенных IP-адресов и/или сетей. Как правило, лучше всего разрешить запись только с локальных адресов (127.0.0.1 и ::1), так как fuzzy storage использует портокол UDP, который не имеет защиты от подделки IP-адреса источника (что можно исправить путем настройки верификации обратного маршрута на маршрутизаторе, но это зачастую игнорируется системными администраторами):</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow_update = [&quot;127.0.0.1&quot;, &quot;::1&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # or 10.0.0.0/8, for internal network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Важное замечание:</strong> Если в списке серверов в конфигурации плагина <code>fuzzy_check</code> (см. далее) присутствует имя <code>localhost</code>, необходимо разрешить доступ как с адреса 127.0.0.1, так и с адреса ::1, так как резолвер возвращает поочередно все известные для имени хоста адреса.</p>
<p>Также для разграничения доступа может использоваться транспортное шифрование, которое мы рассмотрим далее.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="транспортное-шифрование">Транспортное шифрование<a href="#транспортное-шифрование" class="hash-link" aria-label="Прямая ссылка на Транспортное шифрование" title="Прямая ссылка на Транспортное шифрование">​</a></h3>
<p>Протокол работы с хранилищем хешей позволяет включать необязательное (opportunistic) или обязательное шифрование, основанное на криптосистеме с открытым ключом. Архитектура шифрования основана на конструкции cryptobox: <a href="https://nacl.cr.yp.to/box.html" target="_blank" rel="noopener noreferrer">https://nacl.cr.yp.to/box.html</a> и похожа на алгоритм end-to-end шифрования DNSCurve: <a href="https://dnscurve.org/" target="_blank" rel="noopener noreferrer">https://dnscurve.org/</a>.</p>
<p>Чтобы настроить транспортное шифрование, в первую очередь нужно создать пару ключей для сервера хранилища с помощью команды <code>rspamadm keypair -u</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;og3snn8s37znxz53mr5yyyzktt3d5uczxecsp3kkrs495p4iaxzy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;o6wnij9r4wegqjnd46dyifwgf5gwuqguqxzntseectroq7b3gwty&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id = &quot;f5yior1ag3csbzjiuuynff9tczknoj9s9b454kuonqknthrdbwbqj63h3g9dht97fhp4a5jgof1eiifshcsnnrbj73ak8hkq6sbrhed&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Данная команда создает <strong>уникальную</strong> пару ключей, в которой <strong>открытый</strong> ключ (public key) может быть скопирован вручную на хост клиента (например, через ssh) или же опубликован каким-либо способом, гарантирующим достоверность (например, заверен цифровой подписью или размещен на HTTPS-сайте). Закрытый ключ (private key) должен храниться в секрете.</p>
<p>Каждое хранилище может работать одновременно с произвольным числом ключей:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keypair = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Эта возможность полезна для создания закрытых хранилищ, где доступ разрешен только тем клиентам, которым известен один из открытых ключей:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-3.png" width="75%"></center>
<p>Для включения режима обязательного шифрования используется опция <code>encrypted_only</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;fuzzy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Same options as before ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypted_only = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keypair = [ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>В этом режиме клиенты, у которых нет действительного открытого ключа, не смогут обращаться к хранилищу.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="проверка-работы-хранилища">Проверка работы хранилища<a href="#проверка-работы-хранилища" class="hash-link" aria-label="Прямая ссылка на Проверка работы хранилища" title="Прямая ссылка на Проверка работы хранилища">​</a></h3>
<p>Для проверки работы хранилища можно использовать команду <code>rspamadm control fuzzystat</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Statistics for storage 73ee122ac2cfe0c4f12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">invalid_requests: 6.69M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_expired: 35.57k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_found: (v0.6: 0), (v0.8: 0), (v0.9: 0), (v1.0+: 20.10M)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_stored: 425.46k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_shingles: (v0.6: 0), (v0.8: 41.78k), (v0.9: 23.60M), (v1.0+: 380.87M)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fuzzy_checked: (v0.6: 0), (v0.8: 95.29k), (v0.9: 55.47M), (v1.0+: 1.01G)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Keys statistics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key id: icy63itbhhni8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Checked: 1.00G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Matched: 18.29M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Errors: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Added: 1.81M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Deleted: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IPs stat:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x.x.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Checked: 131.23M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Matched: 1.85M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Errors: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Added: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Deleted: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x.x.x.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Checked: 119.86M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span></code></pre></div></div>
<p>Сначала отображается общая статистика хранилища: количество сохраненных и устаревших хешей, а также распределение запросов по версиям протокола клиента:</p>
<ul>
<li><code>v0.6</code> - запросы от rspamd 0.6 - 0.8 (устаревшие версии, ограниченно совместимы)</li>
<li><code>v0.8</code> - запросы от rspamd 0.8 - 0.9 (частично совместимы)</li>
<li><code>v0.9</code> - незашифрованные запросы от rspamd 0.9+ (полностью совместимы)</li>
<li><code>v1.1</code> - зашифрованные запросы от rspamd 1.1+ (полностью совместимы)</li>
</ul>
<p>Далее по каждому из ключей, сконфигурированных в хранилище, отображается подробная статистика по последним IP-адресам клиентов, от которых были получены запросы. И в заключение можно увидеть общую статистику по IP-адресам.</p>
<p>для изменения вывода этой команды можно использовать следующие опции (например, <code>rspamadm control fuzzystat -n</code>):</p>
<ul>
<li><code>-n</code>: выводить &quot;сырые&quot; числа без сокращения</li>
<li><code>--short</code>: не выводить подробную статистику по ключам и IP-адресам</li>
<li><code>--no-keys</code>: не выводить статистику по ключам</li>
<li><code>--no-ips</code>: не выводить статистику по IP-адресам</li>
<li><code>--sort</code>: сортировать:
<ul>
<li><code>checked</code>: по числу проверенных хешей (по умолчанию)</li>
<li><code>matched</code>: по числу найденных хешей</li>
<li><code>errors</code>: по числу ошибочных запросов</li>
<li><code>ip</code>: по IP-адресу лексикографически</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="шаг-3-настройка-плагина-fuzzy_check">Шаг 3: Настройка плагина <code>fuzzy_check</code><a href="#шаг-3-настройка-плагина-fuzzy_check" class="hash-link" aria-label="Прямая ссылка на шаг-3-настройка-плагина-fuzzy_check" title="Прямая ссылка на шаг-3-настройка-плагина-fuzzy_check">​</a></h2>
<p>Плагин <code>fuzzy_check</code> используется процессами-сканерами для проверки писем и процессами-контроллерами для обучения хранилища.</p>
<p>Функции плагина:</p>
<ol>
<li>Обработка писем и создание хешей их отдельных частей</li>
<li>Выполнение запросов к хранилищу</li>
<li>Транспортное шифрование</li>
</ol>
<p>Обучение поизводится командой <code>rspamc fuzzy_add</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ rspamc -f 1 -w 10 fuzzy_add &lt;message|directory|stdin&gt;</span><br></span></code></pre></div></div>
<p>Где параметр <code>-w</code> задает вес хеша, который мы обсуждали ранее, а <code>-f</code> указывает номер флага.</p>
<p>Флаги позволяют хранить хеши различного происхождения в хранилище. Например, хеши спам-ловушек, хеши жалоб пользователей и хеши писем из &quot;белого&quot; списка. Каждый флаг может быть ассоциирован с собственным символом и, соответственно, иметь свой вес при проверке письма:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-4.png" width="75%"></center>
<p>Флаг можно указывать как по номеру:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ rspamc -f 1 -w 10 fuzzy_add &lt;message|directory|stdin&gt;</span><br></span></code></pre></div></div>
<p>так и по символу:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ rspamc -S FUZZY_DENIED -w 10 fuzzy_add &lt;message|directory|stdin&gt;</span><br></span></code></pre></div></div>
<p>Соответсвие символов флагам нужно настроить в секции <code>rule</code>.</p>
<p>Пример local.d/fuzzy_check.conf:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rule &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Fuzzy storage server list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servers = &quot;localhost:11335&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Default symbol for unknown flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol = &quot;LOCAL_FUZZY_UNKNOWN&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Additional mime types to store/check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mime_types = [&quot;*&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Hash weight threshold for all maps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_score = 20.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Whether we can learn this storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_only = no;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Ignore unknown flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    skip_unknown = yes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Hash generation algorithm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;mumhash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Use direct hash for short texts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    short_text_direct_hash = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Map flags to symbols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fuzzy_map = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_DENIED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # Local threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 20.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # Flag to match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_PROB {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOCAL_FUZZY_WHITE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_score = 2.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flag = 13;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Пример local.d/fuzzy_group.conf:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">max_score = 12.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">symbols = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_UNKNOWN&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 5.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Generic fuzzy hash match&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_DENIED&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 12.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Denied fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_PROB&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = 5.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Probable fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;LOCAL_FUZZY_WHITE&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        weight = -2.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description = &quot;Whitelisted fuzzy hash&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Рассмотрим некоторые полезные опции, которые можно настраивать в модуле.</p>
<p>Во-первых, <code>max_score</code> полезен для задания веса порога срабатывания данного хеша:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-1.png" width="50%"></center>
<p>Вторым полезным параметром является <code>mime_types</code>, который определяет, какие типы вложений проверять (и обучать!) в данном хранилище. Этот параметр представляет собой список допустимых типов в формате <code>[&quot;type/subtype&quot;, &quot;*/subtype&quot;, &quot;type/*&quot;, &quot;*&quot;]</code>, где <code>*</code> заменяет любой допустимый тип. Как правило, достаточно сохранять хеши всех вложений типа <code>application/*</code>. Текстовые части и вложенные изображения автоматически проверяются плагином <code>fuzzy_check</code> (то есть, нет нужды добавлять <code>image/*</code> в список проверяемых вложений). Стоит иметь в виду, что вложения и изображения проверяются на точное соответствие, в отличие от текстов, которые могут немного отличаться.</p>
<p>Очень важной является опция <code>read_only</code>, если вы хотите обучать ваше хранилище. По умолчанию <code>read_only=true</code>, что означает невозможность обучения хранилища:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read_only = true; # disallow learning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_only = false; # allow learning</span><br></span></code></pre></div></div>
<p>Параметр <code>encryption_key</code> задает <strong>открытый</strong> ключ хранилища и включает шифрование запросов.</p>
<p>Параметр <code>algorithm</code> определяет алгоритм генерации хешей из текстовых частей писем (для вложений и изображений всегда используется <a href="https://blake2.net/" target="_blank" rel="noopener noreferrer">blake2b</a>). Исторически в rspamd использовался алгоритм siphash. Однако он имеет определенные проблемы с производительностью, особенно на устаревшем &quot;железе&quot; (CPU до Intel Haswell). Поэтому при создании собственного хранилища стоит рассмотреть другие, более быстрые алгоритмы:</p>
<ul>
<li><code>xxhash</code></li>
<li><code>mumhash</code></li>
<li><code>fasthash</code></li>
</ul>
<p>Для большинства задач я рекомендую использовать <code>mumhash</code> или <code>fasthash</code>, которые демонстрируют отличную производительность на множестве платформ. Для оценки поризводительности вы можете скомпилировать набор тестов из исходного кода rspamd:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ make rspamd-test</span><br></span></code></pre></div></div>
<p>и запустить тест различных вариантов алгоритмов вычисления хешей на вашей платформе:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test/rspamd-test -p /rspamd/shingles</span><br></span></code></pre></div></div>
<p><strong>Важное замечание:</strong> невозможно изменить этот параметр без потери всех данных в хранилище, так как для работы с каждым хранилищем может одновременно использоваться только один алгоритм, а конвертировать один тип хеша в другой не представляется возможным, так как восстановление исходных данных по хешу принципиально невозможно.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="написание-скриптов-условий-для-обучения">Написание скриптов-условий для обучения<a href="#написание-скриптов-условий-для-обучения" class="hash-link" aria-label="Прямая ссылка на Написание скриптов-условий для обучения" title="Прямая ссылка на Написание скриптов-условий для обучения">​</a></h3>
<p>Так как плагин <code>fuzzy_check</code> отвечает в том числе и за обучение, то именно в его конфигурации задается скрипт, определяющий, какие сообщения будут поступать на обучение, а какие нет. Этот скрипт представляет собой функцию Lua с одним аргументом типа <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/lua/rspamd_task"><code>rspamd_task</code></a> и возвращает либо булево значение: <code>true</code> - обучать или <code>false</code> - не обучать, либо пару - булево значение и новый флаг, если в ходе выполнения скрипта выяснилось, что необходимо изменить исходный флаг обучения. Для задания условного скрипта служит параметр <code>learn_condition</code>, а  для записи скрипта удобнее всего использовать многострочный синтаксис <code>heredoc</code>, который поддерживается <code>UCL</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy check plugin configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">learn_condition = &lt;&lt;EOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return function(task)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return true -- Always learn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOD;</span><br></span></code></pre></div></div>
<p>Приведем практические примеры полезных скриптов. Например, часто бывает нужно запретить использовать для обучения письма, отправленные с некоторых доменов. Для этого можно задать такой скрипт:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> skip_domains </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;example.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;google.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> from </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;addr&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d </span><span class="token keyword" style="color:rgb(222, 71, 0)">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ipairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skip_domains</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;addr&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<p>В некоторых случаях полезно распределять обучение хешей по различным флагам в соответствии с их источником, который можно закодировать, например, в заголовке <code>X-Source</code>. Допустим, мы хотим иметь такое соответствие флагов и источников:</p>
<ul>
<li><code>honeypot</code> - &quot;черный&quot; список: 1</li>
<li><code>users_unfiltered</code> - &quot;серый&quot; список: 2</li>
<li><code>users_filtered</code> - &quot;черный&quot; список: 1</li>
<li><code>FP</code> - &quot;белый&quot; список: 3</li>
</ul>
<p>Тогда скрипт, осуществляющий такое распределение, может выглядеть следующим образом:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> skip_headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;X-Source&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> sources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        honeypot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        users_unfiltered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        users_filtered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FP </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> fl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sources</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> fl </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">fl </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Return true + new flag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">f </span><span class="token keyword" style="color:rgb(222, 71, 0)">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skip_headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> hdr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Check for interesting header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> h </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Call its handler and return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Do not learn if specified header is missing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="шаг-4-настройка-репликации-хешей">Шаг 4: Настройка репликации хешей<a href="#шаг-4-настройка-репликации-хешей" class="hash-link" aria-label="Прямая ссылка на Шаг 4: Настройка репликации хешей" title="Прямая ссылка на Шаг 4: Настройка репликации хешей">​</a></h2>
<p>Зачастую бывает нужно собирать хеши из различных источников или иметь локальную копию удаленного хранилища. Начиная с версии 1.3 в rspamd для решения этой задачи реализована поддержка репликации на уровне хранилища хешей:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-fuzzy-5.png" width="75%"></center>
<p>Передача хешей инициируется <strong>мастером</strong> репликации, который отправляет команды обновления хешей (добавление, модификацию или удаление) всем заданным слейвам. Таким образом, слейвы должны иметь возможность принимать соединение от мастера, что нужно учитывать при настройке межсетевых экранов.</p>
<p>Для установки соединения слейв должен прослушивать тот же порт 11335 (по умолчанию), но по протоколу TCP. Синхронизация мастера и слейва осуществляется по протоколу HTTP с транспортным шифрованием HTTPCrypt. Для предотвращения повторных или неверных обновлений слейв проверяет версию обновления, и, если она меньше или равна локальной, то обновление отвергается. В случае же, если мастер опережает слейв более чем на одну версию, в лог файле слейва выводится сообщение вида:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_fuzzy_mirror_process_update: remote revision: XX is newer more than 1 revision than ours: YY, cold sync is recommended</span><br></span></code></pre></div></div>
<p>В таком случае рекомендуется заново клонировать базу данных путем &quot;холодной&quot; синхронизации.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="холодная-синхронизация">Холодная синхронизация<a href="#холодная-синхронизация" class="hash-link" aria-label="Прямая ссылка на Холодная синхронизация" title="Прямая ссылка на Холодная синхронизация">​</a></h3>
<p>Данная процедура служит для инициализации нового слейва или восстановления репликации после потери связи мастера со слейвом.</p>
<p>Для выполнения синхронизации на хосте мастера нужно остановить сервис rspamd и сделать дамп базы данных хешей (rspamd можно и не останавливать, но если за время клонирования базы данных версия мастера увеличится более чем на 1, процедуру придется повторить):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sqlite3 /var/lib/rspamd/fuzzy.db &quot;.backup fuzzy.sql&quot;</span><br></span></code></pre></div></div>
<p>далее полученный файл <code>fuzzy.sql</code> копируется на все слейвы (rspamd на слейвах можно не останавливать):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sqlite3 /var/lib/rspamd/fuzzy.db &quot;.restore fuzzy.sql&quot;</span><br></span></code></pre></div></div>
<p>После чего можно запускать rspamd сначала на слейвах, а затем на мастере.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="конфигурирование-репликации">Конфигурирование репликации<a href="#конфигурирование-репликации" class="hash-link" aria-label="Прямая ссылка на Конфигурирование репликации" title="Прямая ссылка на Конфигурирование репликации">​</a></h3>
<p>Репликация настраивается в конфигурационном файле хранилища хешей - worker-fuzzy.inc. Мастер репликации настраивается следующим образом:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Local keypair (rspamadm keypair -u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync_keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;xxx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;ppp&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Remote slave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;slave1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hosts = &quot;slave1.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key = &quot;yyy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;slave2&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hosts = &quot;slave2.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key = &quot;zzz&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Немного остановлюсь на настройке ключей для шифрования. Обычно для установления шифрованных соединений rspamd не требует конфигурирования ключа на обеих сторонах - ключ клиента генерируется автоматически. Однако в данном случае клиентом выступает мастер, поэтому на слейвах можно задать конкретный (открытый) ключ, по которому они будут проверять команды обновления. Также можно задать допустимые IP-адреса мастера, но защита по ключу является более надежной (кроме того, эти методы можно комбинировать).</p>
<p>Настройка слейва выглядит похоже:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># We assume it is slave1 with pubkey &#x27;yyy&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync_keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubkey = &quot;yyy&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privkey = &quot;PPP&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding = &quot;base32&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;curve25519&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;kex&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Allow update from these hosts only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">masters = &quot;master.example.com&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Also limit updates to this specific public key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_key = &quot;xxx&quot;;</span><br></span></code></pre></div></div>
<p>Также на слейве можно настроить трансляцию флагов, получаемых с мастера, чтобы избежать коллизий с локальными хешами. Например, если мы хотим транслировать флаги <code>1</code>, <code>2</code> и <code>3</code> во флаги <code>10</code>, <code>20</code> и <code>30</code> соответственно, то можно написать такую конфигурацию:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Fuzzy storage worker configuration snippet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master_flags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;1&quot; = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;2&quot; = 20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;3&quot; = 30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/fuzzy_storage.ru.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Страница документа"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#введение" class="table-of-contents__link toc-highlight">Введение</a></li><li><a href="#шаг-1-выбор-источников-хешей" class="table-of-contents__link toc-highlight">Шаг 1: выбор источников хешей</a><ul><li><a href="#использование-жалоб-пользователей" class="table-of-contents__link toc-highlight">Использование жалоб пользователей</a></li><li><a href="#настройка-ловушек-спама" class="table-of-contents__link toc-highlight">Настройка ловушек спама</a></li></ul></li><li><a href="#шаг-2-настройка-хранилища" class="table-of-contents__link toc-highlight">Шаг 2: Настройка хранилища</a><ul><li><a href="#архитектура-хранилища" class="table-of-contents__link toc-highlight">Архитектура хранилища</a></li><li><a href="#устаревание-хешей" class="table-of-contents__link toc-highlight">Устаревание хешей</a></li><li><a href="#пример-настройки" class="table-of-contents__link toc-highlight">Пример настройки</a></li><li><a href="#настройки-доступа" class="table-of-contents__link toc-highlight">Настройки доступа</a></li><li><a href="#транспортное-шифрование" class="table-of-contents__link toc-highlight">Транспортное шифрование</a></li><li><a href="#проверка-работы-хранилища" class="table-of-contents__link toc-highlight">Проверка работы хранилища</a></li></ul></li><li><a href="#шаг-3-настройка-плагина-fuzzy_check" class="table-of-contents__link toc-highlight">Шаг 3: Настройка плагина <code>fuzzy_check</code></a><ul><li><a href="#написание-скриптов-условий-для-обучения" class="table-of-contents__link toc-highlight">Написание скриптов-условий для обучения</a></li></ul></li><li><a href="#шаг-4-настройка-репликации-хешей" class="table-of-contents__link toc-highlight">Шаг 4: Настройка репликации хешей</a><ul><li><a href="#холодная-синхронизация" class="table-of-contents__link toc-highlight">Холодная синхронизация</a></li><li><a href="#конфигурирование-репликации" class="table-of-contents__link toc-highlight">Конфигурирование репликации</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>