<!doctype html>
<html lang="ru" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Rspamd Performance Measures | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Rspamd Performance Measures | Rspamd Documentation"><meta data-rh="true" name="description" content="Preface"><meta data-rh="true" property="og:description" content="Preface"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-05-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/rspamd"><meta data-rh="true" property="article:tag" content="performance,benchmarks"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/blog/rspamd-performance" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/blog/rspamd-performance" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance","mainEntityOfPage":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance","url":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance","headline":"Rspamd Performance Measures","name":"Rspamd Performance Measures","description":"Preface","datePublished":"2019-05-16T00:00:00.000Z","author":{"@type":"Person","name":"Rspamd Team","description":"Rspamd Maintainers","url":"https://github.com/rspamd","image":"https://github.com/rspamd.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog","name":"Rspamd Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/runtime~main.beea35c1.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/main.d2abe2f4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png"><link rel="preload" as="image" href="https://github.com/rspamd.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">Documentation</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/usage_policy">Usage Policy</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Навигация по последним постам в блоге"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2019</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rspamd-performance">Rspamd Performance Measures</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Rspamd Performance Measures</h1><div class="container_mt6G margin-vert--md"><time datetime="2019-05-16T00:00:00.000Z">16 мая 2019 г.</time> · <!-- -->9 мин. чтения</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rspamd" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/rspamd.png" alt="Rspamd Team"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/rspamd" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Rspamd Team</span></a></div><small class="authorTitle_nd0D" title="Rspamd Maintainers">Rspamd Maintainers</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="#preface" class="hash-link" aria-label="Прямая ссылка на Preface" title="Прямая ссылка на Preface">​</a></h2>
<p>Rspamd has always been oriented on the performance but it was always quite hard to measure how fast it was as normally it runs <em>just fast enough</em>.</p>
<p>However, I was recently offered to process <a href="https://www.abusix.ai/" target="_blank" rel="noopener noreferrer">Abusix Intelligence</a> feeds using Rspamd. These feeds are used to improve Rspamd fuzzy storage quality, to feed URLs and Emails to the DNS black lists provided by Rspamd project and used in SURBL module.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-statement">Problem statement<a href="#problem-statement" class="hash-link" aria-label="Прямая ссылка на Problem statement" title="Прямая ссылка на Problem statement">​</a></h2>
<p>The amount of data that required to be processing is huge - it is about 100 millions of messages per day.</p>
<p>Here is an example to calculate connections count when processing these messages using Rspamd:</p>
<div class="term">
$ rspamc stat | \
  grep &#x27;Connections count&#x27; | \
  cut -d&#x27; &#x27; -f3 ; \
  sleep 10 ; \
  rspamc stat | \
  grep &#x27;Connections count&#x27; | \
  cut -d&#x27; &#x27; -f3
23548811
23564384
</div>
<!-- -->
<p>It means that over 10 seconds Rspamd has to process around 15 thousands of messages which gives us a rate of <strong>1500 messages per second</strong>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rspamd-setup">Rspamd setup<a href="#rspamd-setup" class="hash-link" aria-label="Прямая ссылка на Rspamd setup" title="Прямая ссылка на Rspamd setup">​</a></h2>
<p>The settings used to process this amount of messages are pretty similar to those that are provided by default.</p>
<p>There is also some significant amount of home-crafted scripts written in Lua to provide the following functionality:</p>
<ul>
<li>Provides deduplication to save time on processing of duplicates</li>
<li>Performs conditional checks for url and emails blacklisting:
<ul>
<li>checks if an url is in whitelists (around 5 whitelists stored in Redis are used)</li>
<li>check if an url is already listed</li>
<li>check if it matches any suspicious patterns</li>
</ul>
</li>
<li>Checks if a message should be learned on fuzzy storage (various conditions)</li>
<li>Stores messages in IMAP folders providing sorting, partitioning and sampling logic</li>
<li>Doing various HTTP and Redis queries for servicing purposes</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hardware">Hardware<a href="#hardware" class="hash-link" aria-label="Прямая ссылка на Hardware" title="Прямая ссылка на Hardware">​</a></h2>
<p>Now some words about hardware being used.</p>
<p>Previously we have set the same setup on a small instance of <a href="https://web.archive.org/web/20190319181059/https://www.hetzner.com/dedicated-rootserver/ax60-ssd" target="_blank" rel="noopener noreferrer">AX-60</a> and it was loaded for around 80%. We have decided to move to a more powerful server to have some margin for processing more emails and doing some experiments.</p>
<p>Hence, we now have an <a href="https://web.archive.org/web/20190319181053/https://www.hetzner.com/dedicated-rootserver/ax160-ssd" target="_blank" rel="noopener noreferrer">AX-160</a> AMD server rented in <a href="https://www.hetzner.com/" target="_blank" rel="noopener noreferrer">Hetzner</a>. This is quite a powerful machine and the current load pictures look like this one:</p>
<div class="term">
top - 14:36:26 up 23:26,  1 user,  load average: 15.76, 13.22, 12.46
Tasks: 511 total,   3 running, 508 sleeping,   0 stopped,   0 zombie
%Cpu(s): 14.1 us,  4.6 sy,  0.0 ni, 78.9 id,  0.0 wa,  0.0 hi,  2.4 si,  0.0 st
MiB Mem : 128802.5 total,  56985.7 free,  27897.5 used,  43919.3 buff/cache
MiB Swap:   4092.0 total,   3925.5 free,    166.5 used. 100018.6 avail Mem

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 14085 unbound   20   0 2058412   1.6g   6852 S 131.2   1.3   1478:04 unbound
 66509 _rspamd   20   0  806976 733336  23592 S  68.8   0.6 169:52.21 rspamd
 66498 _rspamd   20   0  780144 699540  23852 S  62.5   0.5 156:19.14 rspamd
 66502 _rspamd   20   0  816152 744352  23796 S  56.2   0.6 164:26.39 rspamd
 66468 _rspamd   20   0  773532 697084  23736 S  50.0   0.5 117:36.32 rspamd
 66491 _rspamd   20   0  806652 722340  23728 S  50.0   0.5 148:04.54 rspamd
 66476 _rspamd   20   0  767300 705996  23596 S  43.8   0.5 129:04.30 rspamd
 66481 _rspamd   20   0  797944 730528  23896 S  43.8   0.6 139:34.35 rspamd
 66443 _rspamd   20   0  727632 657104  23372 S  37.5   0.5  88:39.26 rspamd
 66451 _rspamd   20   0  742192 665196  23632 S  37.5   0.5  94:49.75 rspamd
 66456 _rspamd   20   0  790908 725784  23488 S  37.5   0.6 101:32.06 rspamd
 66463 _rspamd   20   0  771540 696064  23692 S  37.5   0.5 108:08.65 rspamd
 66487 _rspamd   20   0  780220 713024  23428 S  37.5   0.5 144:51.79 rspamd
 66447 _rspamd   20   0  762440 689592  23736 S  31.2   0.5  90:23.93 rspamd
 66455 _rspamd   20   0  763520 696108  23580 S  31.2   0.5  97:57.57 rspamd
 66464 _rspamd   20   0  764644 688724  23696 S  31.2   0.5 111:32.74 rspamd
 66469 _rspamd   20   0  756952 678704  23612 S  31.2   0.5 127:55.02 rspamd
127011 rbldns    20   0  358824 307700   2244 R  31.2   0.2  10:26.14 rbldnsd
 10767 redis     20   0 9912104   7.7g   2532 S  25.0   6.1 236:29.63 redis-server
 66438 _rspamd   20   0  746772 680624  23424 R  25.0   0.5  82:18.04 rspamd
 66433 _rspamd   20   0  751180 687244  23472 S  18.8   0.5  80:12.21 rspamd
 66437 _rspamd   20   0  737200 669428  23796 S  18.8   0.5  81:37.81 rspamd
 10671 stunnel4  20   0   24.0g  77252   3644 S  12.5   0.1 269:06.53 stunnel4
 26994 root      20   0   11900   3984   3072 R  12.5   0.0   0:00.02 top
 66442 _rspamd   20   0  808808 707020  23608 S  12.5   0.5  85:11.64 rspamd
 17821 clickho+  20   0   21.8g   3.9g  18964 S   6.2   3.1 116:13.04 clickhouse-serv
</div>
<!-- -->
<p>Rspamd is also being fed via proxy worker that runs on another host and performs initial data collection and emitting messages via the Internet providing transport encryption using HTTPCrypt. However, its CPU usage is quite negligible - it uses only a single CPU core by around 40% in average.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="results-analytics">Results analytics<a href="#results-analytics" class="hash-link" aria-label="Прямая ссылка на Results analytics" title="Прямая ссылка на Results analytics">​</a></h2>
<p>As you can see, this machine runs also <a href="https://clickhouse.yandex" target="_blank" rel="noopener noreferrer">Clickhouse</a>, Redis, own recursive resolver (Unbound), and it still has <strong>~80% idle</strong> processing these <strong>1500 messages per second</strong>.</p>
<p>If we look at the performance counters by attaching to some of the worker processes, we would see the following picture:</p>
<div class="term">
# timeout 30 perf record -p 66481
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 1.171 MB perf.data (29833 samples) ]
# perf report

# Overhead  Command  Shared Object            Symbol
# ........  .......  .......................  .......................................................................
#
     5.23%  rspamd   rspamd                   [.] lj_alloc_free
     3.35%  rspamd   rspamd                   [.] lj_str_new
     3.03%  rspamd   librspamd-server.so      [.] gc_sweep
     2.20%  rspamd   rspamd                   [.] lj_alloc_malloc
     1.94%  rspamd   rspamd                   [.] gc_sweep
     1.50%  rspamd   libc-2.28.so             [.] __strlen_avx2
     1.32%  rspamd   rspamd                   [.] release_unused_segments
     1.24%  rspamd   rspamd                   [.] lj_BC_TGETS
     1.17%  rspamd   libjemalloc.so.2         [.] free
     1.04%  rspamd   librspamd-server.so      [.] lj_BC_JLOOP
     1.03%  rspamd   librspamd-server.so      [.] propagatemark
     1.01%  rspamd   libpthread-2.28.so       [.] __pthread_mutex_lock
     1.01%  rspamd   libglib-2.0.so.0.5800.3  [.] g_hash_table_lookup
     0.94%  rspamd   libjemalloc.so.2         [.] malloc
     0.77%  rspamd   rspamd                   [.] lj_func_newL_gc
     0.76%  rspamd   rspamd                   [.] propagatemark
     0.75%  rspamd   rspamd                   [.] lj_tab_get
     0.69%  rspamd   libpthread-2.28.so       [.] __pthread_mutex_unlock_usercnt
     0.65%  rspamd   librspamd-server.so      [.] t1ha2_atonce
     0.61%  rspamd   librspamd-server.so      [.] newtab
     0.60%  rspamd   libicui18n.so.63.1       [.] icu_63::NGramParser::search
     0.59%  rspamd   [kernel.kallsyms]        [k] copy_user_generic_string
     0.58%  rspamd   librspamd-server.so      [.] match
     0.58%  rspamd   librspamd-server.so      [.] lj_tab_new1
     0.56%  rspamd   librspamd-server.so      [.] rspamd_task_find_symbol_result
     0.52%  rspamd   [kernel.kallsyms]        [k] _raw_spin_lock_irqsave
     0.48%  rspamd   librspamd-server.so      [.] rspamd_vprintf_common
     0.46%  rspamd   librspamd-server.so      [.] lj_str_new
     0.42%  rspamd   rspamd                   [.] index2adr
     0.42%  rspamd   rspamd                   [.] lj_BC_CALL
     0.42%  rspamd   libc-2.28.so             [.] __strcmp_avx2
     0.42%  rspamd   libc-2.28.so             [.] __memmove_avx_unaligned_erms
</div>
<!-- -->
<p>The top consumers are Lua allocator and garbage collector. Since we are using [Rspamd experimental package]({{ site.baseurl }}/downloads.html) on Debian Buster, then it is built with bundled <a href="https://luajit.org" target="_blank" rel="noopener noreferrer">LuaJIT 2.1 beta3</a> and Jemalloc allocator, however, it seems that there is some issue with this allocator in Debian Buster, so I had to load it manually via the following command:</p>
<div class="term">
# systemctl edit rspamd.service

[Service]
Environment=&quot;LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2&quot;
</div>
<!-- -->
<p>Followed by restarting of Rspamd.</p>
<p>It is interesting that this Rspamd setup accepts all connections encrypted using <a href="https://highsecure.ru/httpcrypt.pdf" target="_blank" rel="noopener noreferrer">HTTPCrypt</a> but <code>chacha_blocks_avx2</code> takes less than 0.16% of CPU according to <code>perf</code> report.</p>
<p>This particular instance of Rspamd is slightly tuned to use more memory to save some CPU cycles:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/options.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_gc_step = 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_gc_pause = 400;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">full_gc_iters = 10000;</span><br></span></code></pre></div></div>
<p>These options tell Rspamd to preserve Lua objects in memory for longer time, at the same time in this mode, we can also observe GC stats on workers that performs full GC loop each 10k messages being scanned:</p>
<div class="term">
$ tail -f /var/log/rspamd/rspamd.log | fgrep &#x27;full gc&#x27;

perform full gc cycle; memory stats: 58.66MiB allocated, 62.01MiB active, 6.08MiB metadata, 84.71MiB resident, 90.64MiB mapped; lua memory: 107377 kb -&gt; 38015 kb; 308.0022420035675 ms for gc iter
</div>
<!-- -->
<p>As you can see, full GC iter takes quite a significant time. However, it still keeps Lua memory usage sane. The ideas behind this GC mode have been taken from the generational GC idea in <a href="http://wiki.luajit.org/New-Garbage-Collector#gc-algorithms_generational-gc" target="_blank" rel="noopener noreferrer">LuaJIT Wiki</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resulting-graphs">Resulting graphs<a href="#resulting-graphs" class="hash-link" aria-label="Прямая ссылка на Resulting graphs" title="Прямая ссылка на Resulting graphs">​</a></h2>
<p>Here are some UI captures taken from a previous machine:</p>
<img decoding="async" loading="lazy" width="75%" class="img-fluid img_ev3q" src="/img/perf_webui1.png">
<img decoding="async" loading="lazy" width="75%" class="img-fluid img_ev3q" src="/img/perf_webui2.png">
<p>As you can observe, there was some HAM portion increase over the recent days, however, it was caused by adding new sampling logic and duplicates filtering to save CPU resources (these messages are marked as ham and excepted from scan).</p>
<p>There is also a <a href="https://clickhouse.yandex" target="_blank" rel="noopener noreferrer">Clickhouse</a> based dashboard that&#x27;s created using <a href="https://redash.io" target="_blank" rel="noopener noreferrer">Redash</a>:</p>
<img decoding="async" loading="lazy" width="75%" class="img-fluid img_ev3q" src="/img/perf_redash.png">
<p>Since we have Clickhouse on board, we can do various analytics. Here is an average scan time for messages:</p>
<div class="term">
:) select avg(ScanTimeVirtual) from rspamd where Date=today();

SELECT avg(ScanTimeVirtual)
FROM rspamd
WHERE Date = today()

┌─avg(ScanTimeVirtual)─┐
│    95.62269064131341 │
└──────────────────────┘
</div>
<!-- -->
<p>... and average size of messages:</p>
<div class="term">
:) select median(ScanTimeVirtual) from rspamd where Date=today();

:) select avg(Size) from rspamd where Date=today();

SELECT avg(Size)
FROM rspamd
WHERE Date = today()

┌──────────avg(Size)─┐
│ 1778.31            │
└────────────────────┘
</div>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a href="#conclusions" class="hash-link" aria-label="Прямая ссылка на Conclusions" title="Прямая ссылка на Conclusions">​</a></h2>
<p>So with this load rate (<strong>1500 messages per second</strong>) and with the average size of messages around 2Kb, Rspamd processes each message in around <strong>100ms in average</strong>. I hope these numbers could give one some impression about Rspamd performance in general.</p>
<p>I would like to give the main kudos to <a href="https://www.abusix.com" target="_blank" rel="noopener noreferrer">Abusix</a> who are constantly supporting Rspamd project and have generously provided their amazing spam feeds to improve Rspamd quality!</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Теги:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/tags/performance">performance</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/tags/benchmarks">benchmarks</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/blog/2019-05-16-rspamd-performance.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preface" class="table-of-contents__link toc-highlight">Preface</a></li><li><a href="#problem-statement" class="table-of-contents__link toc-highlight">Problem statement</a></li><li><a href="#rspamd-setup" class="table-of-contents__link toc-highlight">Rspamd setup</a></li><li><a href="#hardware" class="table-of-contents__link toc-highlight">Hardware</a></li><li><a href="#results-analytics" class="table-of-contents__link toc-highlight">Results analytics</a></li><li><a href="#resulting-graphs" class="table-of-contents__link toc-highlight">Resulting graphs</a></li><li><a href="#conclusions" class="table-of-contents__link toc-highlight">Conclusions</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>