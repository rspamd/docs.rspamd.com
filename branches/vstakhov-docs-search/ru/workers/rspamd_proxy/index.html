<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-workers/rspamd_proxy" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Proxy worker | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/rspamd_proxy"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Proxy worker | Rspamd Documentation"><meta data-rh="true" name="description" content="This worker provides various functionalities for building multi-layered systems and handling the Milter protocol. Here is a brief list of functions provided by the proxy worker:"><meta data-rh="true" property="og:description" content="This worker provides various functionalities for building multi-layered systems and handling the Milter protocol. Here is a brief list of functions provided by the proxy worker:"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/rspamd_proxy"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/workers/rspamd_proxy" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/rspamd_proxy" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/workers/rspamd_proxy" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Workers","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/"},{"@type":"ListItem","position":2,"name":"Proxy worker","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/rspamd_proxy"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/runtime~main.beea35c1.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/main.d2abe2f4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/">Workers</a><button aria-label="Collapse sidebar category &#x27;Workers&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/normal">Normal worker (scanner)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/controller">Controller worker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/rspamd_proxy">Proxy worker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/fuzzy_storage">Fuzzy storage worker</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></nav><button type="button" title="Свернуть сайдбар" aria-label="Свернуть сайдбар" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/"><span>Workers</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Proxy worker</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Rspamd proxy worker</h1></header>
<p>This worker provides various functionalities for building multi-layered systems and handling the Milter protocol. Here is a brief list of functions provided by the proxy worker:</p>
<ul>
<li>Forwarding messages to the scanning layer</li>
<li>Direct interaction with the MTA using the Milter protocol</li>
<li>Performing load balancing, retransmitting, and health checks for the scanning layer</li>
<li>Adding encryption and/or compression to scan requests</li>
<li>Mirroring some traffic to a test server</li>
<li>Comparing results of mirrored requests</li>
<li>Performing message scans autonomously (self-scan mode)</li>
</ul>
<p>The <code>hosts</code> option for the <code>upstream</code> and <code>mirror</code> can specify IP addresses or Unix domain sockets, as described in the <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/upstream">upstreams documentation</a>. If the port number is omitted, port 11333 is assumed.</p>
<p>For a full list of options, please refer to <code>rspamadm confighelp workers.rspamd_proxy</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="default-configuration">Default configuration<a href="#default-configuration" class="hash-link" aria-label="Прямая ссылка на Default configuration" title="Прямая ссылка на Default configuration">​</a></h2>
<p>The proxy worker&#x27;s most widely useful feature is its ability to communicate using the Milter protocol, and the default configuration is designed with this in mind. By default, the proxy worker is enabled and listening on <code>localhost:11332</code> in <code>milter</code> mode, with <code>localhost</code> configured as an upstream (refer to <code>$CONFDIR/worker-proxy.inc</code>).</p>
<p>This means that users who require Milter protocol support in their installations can use it straight out of the box.</p>
<p>For users who do not need Milter support, it&#x27;s generally more efficient to use normal workers directly and <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/#common-worker-options">disable</a> the proxy worker to save resources.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="milter-support">Milter support<a href="#milter-support" class="hash-link" aria-label="Прямая ссылка на Milter support" title="Прямая ссылка на Milter support">​</a></h2>
<p>Starting from Rspamd 1.6, the rspamd proxy worker supports the <code>milter</code> protocol, which is compatible with popular MTAs like Postfix and Sendmail. This new feature also marks the obsolescence of the <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/rmilter/">Rmilter</a> project in recognition of the improved integration method.</p>
<p>To enable Milter mode, use the <code>milter</code> boolean worker option. When enabled, the proxy communicates exclusively in the Milter protocol. If disabled, the proxy can be used with Rspamd&#x27;s native <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/developers/protocol">HTTP protocol</a> and the legacy protocol used by Exim.</p>
<p>It&#x27;s important to note that Milter support is available in the <code>rspamd_proxy</code> worker only. There are two ways to use the Milter protocol:</p>
<ul>
<li>Proxy mode (for large instances) with a dedicated scan layer</li>
<li>Self-scan mode (for small instances)</li>
</ul>
<p>If your setup doesn&#x27;t allow your MTA to reject emails, you can set <code>discard_on_reject</code> (available from version 1.6.2 onwards) to true to discard spam emails.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="self-scan-mode">Self-scan mode<a href="#self-scan-mode" class="hash-link" aria-label="Прямая ссылка на Self-scan mode" title="Прямая ссылка на Self-scan mode">​</a></h3>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd_milter_direct.png">
<p>In this mode, the <code>rspamd_proxy</code> worker scans messages independently and communicates directly with the MTA using the Milter protocol. The advantage of this mode is its simplicity. Below is a sample configuration for this mode:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/worker-proxy.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self_scan = yes; # Enable self-scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Proxy worker is listening on *:11332 by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#bind_socket = localhost:11332;</span><br></span></code></pre></div></div>
<p>Also you can disable<sup><a href="#fn1">1</a></sup> <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/normal">normal</a> worker to free up system resources as it is not necessary in <code>self-scan</code> mode:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/worker-normal.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enabled = false;</span><br></span></code></pre></div></div>
<p>But there is a drawback: since <code>rspamc</code> uses <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/normal">normal</a> worker by default you need to explicitly point it to <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/controller">controller</a> worker port (11334)<sup><a href="#fn1">2</a></sup>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc -h rspamd.example.org:11334 input-file</span><br></span></code></pre></div></div>
<p> </p>
<hr>
<p><a name="fn1">1.</a> The <code>enabled</code> option is available for workers since Rspamd 1.6.2, in  previous versions you can use <code>count = 0;</code> instead.</p>
<p><a name="fn1">2.</a> When connecting to local IP <code>rspamc</code> uses controller port by default (1.7+).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="proxy-mode">Proxy mode<a href="#proxy-mode" class="hash-link" aria-label="Прямая ссылка на Proxy mode" title="Прямая ссылка на Proxy mode">​</a></h3>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd_milter_proxy.png">
<p>In this mode, a dedicated layer of Rspamd scanners is employed, featuring load-balancing and optional encryption and/or compression. For this particular setup, the configuration may vary. Below is a concise example of proxy mode with four scanners, where two of them are allocated more resources to handle a higher volume of requests. Additionally, the local worker is disabled:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/worker-proxy.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream &quot;local&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disabled = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream &quot;scan&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = yes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts = &quot;round-robin:host1:11333:10,host2:11333:10,host3:11333:5,host4:11333:5&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key = &quot;...&quot;; # Public key for encryption, generated by rspamadm keypair (optional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compression = yes; # Use zstd compression (optional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings_id = &quot;name&quot;; # Apply a custom setting from the user settings module (optional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mirroring">Mirroring<a href="#mirroring" class="hash-link" aria-label="Прямая ссылка на Mirroring" title="Прямая ссылка на Mirroring">​</a></h2>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/rspamd-testing.jpg">
<p>The proxy can be utilized for testing purposes, including:</p>
<ul>
<li>evaluating new versions of Rspamd</li>
<li>testing new plugins</li>
<li>validating new rules</li>
<li>experimenting with configuration changes</li>
<li>assessing ML models</li>
</ul>
<p>In this mode, Rspamd mirrors a portion of its traffic to a test cluster. The scan results from the test cluster are disregarded when responding to clients. However, optional comparison scripts can be initiated to assess the mirrored results. Below is a sample configuration for this setup, with no utilization of milter mode in this example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/worker-proxy.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Main scan layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream &quot;scan&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;yes&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts = &quot;round-robin:host1:11333:10,host2:11333:10,host3:11333:5,host4:11333:5&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key = &quot;...&quot;; # Public key for encryption, generated by rspamadm keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compression = yes; # Use zstd compression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mirror &quot;test&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hosts = &quot;test:11333&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  probability = 0.1; # Mirror 10% of traffic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key = &quot;...&quot;; # Public key for encryption, generated by rspamadm keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compression = yes; # Use zstd compression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-settings">User settings<a href="#user-settings" class="hash-link" aria-label="Прямая ссылка на User settings" title="Прямая ссылка на User settings">​</a></h3>
<p>The proxy worker can apply a specific setting using the <code>settings_id</code> configured in an upstream through the <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/settings">user settings module</a>. Ensure that the user settings module includes a setting with the same name as defined in <code>settings_id</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="compare-scripts">Compare scripts<a href="#compare-scripts" class="hash-link" aria-label="Прямая ссылка на Compare scripts" title="Прямая ссылка на Compare scripts">​</a></h3>
<p>Comparison scripts are designed for executing straightforward actions with the results obtained from a mirror and the main cluster machine. These scripts do not support asynchronous requests, so your options are limited to logging or writing to files. Below is a basic example of such a script in the configuration:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/worker-proxy.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  script =&lt;&lt;EOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return function(results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  local log = require &quot;rspamd_logger&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for k,v in pairs(results) do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if type(v) == &#x27;table&#x27; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.infox(&quot;%s: %s&quot;, k, v[&#x27;score&#x27;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.infox(&quot;err: %s: %s&quot;, k, v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOD;</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/workers/rspamd_proxy.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/controller"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">Controller worker</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/fuzzy_storage"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">Fuzzy storage worker</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#default-configuration" class="table-of-contents__link toc-highlight">Default configuration</a></li><li><a href="#milter-support" class="table-of-contents__link toc-highlight">Milter support</a><ul><li><a href="#self-scan-mode" class="table-of-contents__link toc-highlight">Self-scan mode</a></li><li><a href="#proxy-mode" class="table-of-contents__link toc-highlight">Proxy mode</a></li></ul></li><li><a href="#mirroring" class="table-of-contents__link toc-highlight">Mirroring</a><ul><li><a href="#user-settings" class="table-of-contents__link toc-highlight">User settings</a></li><li><a href="#compare-scripts" class="table-of-contents__link toc-highlight">Compare scripts</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>