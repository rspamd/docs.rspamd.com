<!doctype html>
<html lang="ru" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-modules/multimap" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Multimap module | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/multimap"><meta data-rh="true" property="og:locale" content="ru"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Multimap module | Rspamd Documentation"><meta data-rh="true" name="description" content="{:.no_toc}"><meta data-rh="true" property="og:description" content="{:.no_toc}"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/multimap"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/multimap" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/multimap" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/modules/multimap" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Modules","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/"},{"@type":"ListItem","position":2,"name":"Multimap module","item":"https://rspamd.com/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/multimap"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/rss.xml" title="Rspamd Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog/atom.xml" title="Rspamd Documentation Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script><link rel="stylesheet" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/css/styles.121a41fd.css">
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/runtime~main.beea35c1.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/assets/js/main.d2abe2f4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/vstakhov-docs-search/ru/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Переключение между темным и светлым режимом (сейчас используется system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/">About Rspamd</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">Frequently asked questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/about/">About</a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Rspamd Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/">Configuration</a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/workers/">Workers</a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/">Modules</a><button aria-label="Collapse sidebar category &#x27;Modules&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/antivirus">Antivirus module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/arc">ARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/asn">ASN module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/bayes_expiry">Bayes expiry module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/chartable">Chartable module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/clickhouse">Clickhouse module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/dcc">DCC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/dkim">DKIM module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/dkim_signing">DKIM signing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/dmarc">DMARC module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/elastic">Elasticsearch module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/emails">Emails module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/external_relay">External Relay module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/external_services">External Services module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/force_actions">Force Actions module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/fuzzy_check">Fuzzy check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/gpt">GPT Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/greylisting">Greylisting module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/hfilter">Hfilter module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/history_redis">Redis history module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/ip_score">IP Score module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/known_senders">known_senders module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/maillist">Mailing lists module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/metadata_exporter">Metadata exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/metric_exporter">Metric exporter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/mid">MID module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/milter_headers">Milter headers module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/mime_types">Mime types modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/multimap">Multimap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/mx_check">MX Check module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/neural">Neural network module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/once_received">Once received module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/phishing">Phishing module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/ratelimit">Ratelimit module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/rbl">RBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/regexp">Regexp module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/replies">Replies module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/reputation">Reputation module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/rspamd_update">Rspamd update module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/spamassassin">SpamAssassin rules module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/spamtrap">Spamtrap module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/spf">SPF module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/surbl">SURBL module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/trie">Trie module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/url_redirector">URL redirector module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/whitelist">Whitelist module</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/lua/">Lua API</a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/">Tutorials</a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/developers/architecture">Developers</a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/other/rspamadm">Other</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></nav><button type="button" title="Свернуть сайдбар" aria-label="Свернуть сайдбар" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/"><span>Modules</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Multimap module</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><header><h1>Multimap module</h1></header>
<p>{:.no_toc}</p>
<p>The Multimap module has been specifically designed to handle rules that are based on various types of lists which are dynamically updated by Rspamd, and are referred to as <code>maps</code>. This module is particularly useful for organizing whitelists, blacklists, and other lists via files. Additionally, it is capable of loading remote lists using the <code>HTTP</code> and <code>HTTPS</code> protocols or the <code>RESP</code> (REdis Serialization Protocol). This article provides a detailed explanation of all the configuration options and features available in this module.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quick-start-guide">Quick Start Guide<a href="#quick-start-guide" class="hash-link" aria-label="Прямая ссылка на Quick Start Guide" title="Прямая ссылка на Quick Start Guide">​</a></h2>
<p>Here are common use cases for the Multimap module with basic examples:</p>
<ol>
<li>Block specific email senders:</li>
</ol>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BLOCKED_SENDERS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Note that it is SMTP from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # For MIME (or displayed) from, one can use `extract_from = &quot;mime&quot;;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extract_from = &quot;smtp&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/etc/rspamd/maps/blocked_senders.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Blocked sender addresses&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<ol start="2">
<li>Whitelist trusted IPs:</li>
</ol>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TRUSTED_IPS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;ip&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/etc/rspamd/maps/trusted_ips.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefilter = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;accept&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Trusted IP addresses&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<ol start="3">
<li>Block dangerous file extensions:</li>
</ol>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BLOCKED_EXTENSIONS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;filename&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;extension&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/etc/rspamd/maps/blocked_extensions.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 8.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Blocked file extensions&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-multimap-processing-works">How Multimap Processing Works<a href="#how-multimap-processing-works" class="hash-link" aria-label="Прямая ссылка на How Multimap Processing Works" title="Прямая ссылка на How Multimap Processing Works">​</a></h2>
<ol>
<li>Data Extraction → 2. Filtering → 3. Map Lookup → 4. Action/Scoring</li>
</ol>
<p>Example flow for a &quot;from&quot; type map:</p>
<ul>
<li>Extract: &quot;John Smith <a href="mailto:john@example.com" target="_blank" rel="noopener noreferrer">john@example.com</a>&quot;</li>
<li>Filter (email:domain): &quot;example.com&quot;</li>
<li>Lookup: Check if &quot;example.com&quot; exists in map</li>
<li>Result: Apply score or action if found</li>
</ul>
<p>Common combinations:</p>



































<table><thead><tr><th>Use Case</th><th>Type</th><th>Filter</th><th>Example Map Entry</th></tr></thead><tbody><tr><td>Block domains</td><td>from</td><td>email:domain</td><td>example.com</td></tr><tr><td>Block users</td><td>from</td><td>email:user</td><td>spammer</td></tr><tr><td>Block file types</td><td>filename</td><td>extension</td><td>.exe</td></tr><tr><td>Block URLs</td><td>url</td><td>tld</td><td>badsite.com</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="principles-of-work">Principles of work<a href="#principles-of-work" class="hash-link" aria-label="Прямая ссылка на Principles of work" title="Прямая ссылка на Principles of work">​</a></h2>
<p>This module defines rules that allows to extract multiple types of data (defined by <code>type</code>). The data extracted is transformed in the desired way (defined by <code>filter</code>) and is checked against the list of strings that is usually referred as <code>map</code>:</p>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/multimap_dia.png" width="75%"></center>
<p>It is a common mistake to use <code>type</code> instead of <code>filter</code> and vice-versa. To avoid confusing, please bear in mind that <code>type</code> is the main property of the map that defines which exact data is extracted.</p>
<p>Maps in Rspamd refer to files or HTTP links that are automatically monitored and reloaded if any changes occur. The following are examples of how maps can be defined:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;http://example.com/file&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;file:///etc/rspamd/file.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;/etc/rspamd/file.map&quot;;</span><br></span></code></pre></div></div>
<p>Rspamd offers the option to save traffic for HTTP maps using cached maps, while also respecting <code>304 Not modified responses</code>, Cache-Control headers, and ETags. Additionally, the maps data is shared between workers, and only the first controller worker is allowed to fetch remote maps.</p>
<p>By default, the configuration of this module actively utilises compound maps, which define a map as an array of sources with a local fallback location. While this redundancy may be unnecessary for user-defined maps, further details are available in the following <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq#what-are-maps">FAQ section</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Прямая ссылка на Troubleshooting" title="Прямая ссылка на Troubleshooting">​</a></h2>
<p>Common issues and solutions:</p>
<ol>
<li>Map not matching as expected
<ul>
<li>Check map format matches type (IP maps need CIDR notation)</li>
<li>Verify filter is appropriate (use <code>email:domain</code> vs <code>email:addr</code>)</li>
<li>Enable debug logging: <code>local.d/logging.inc</code>:</li>
</ul>
</li>
</ol>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  debug_modules = [&quot;multimap&quot;];</span><br></span></code></pre></div></div>
<ol start="2">
<li>
<p>Scores not working as expected</p>
<ul>
<li>Check if using prefilter (prefilters don&#x27;t use scores)</li>
<li>For content maps, consider multiple part matching</li>
<li>Verify symbol isn&#x27;t overridden in metrics</li>
</ul>
</li>
<li>
<p>Regular expressions not matching</p>
<ul>
<li>Verify <code>regexp = true</code> is set</li>
<li>Check regex syntax is Hyperscan-compatible</li>
<li>Test regex separately</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Прямая ссылка на Configuration" title="Прямая ссылка на Configuration">​</a></h2>
<p>The module includes a set of rules in the following format:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MAP_SYMBOL1 { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;type&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;url&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # [optional params...] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAP_SYMBOL2 { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;type&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;from&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # [optional params...] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>To define your own rules, it is advisable to do so in the <code>/etc/rspamd/local.d/multimap.conf</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-configuration-practices">Best Configuration Practices<a href="#best-configuration-practices" class="hash-link" aria-label="Прямая ссылка на Best Configuration Practices" title="Прямая ссылка на Best Configuration Practices">​</a></h2>
<ol>
<li>
<p>Map Organization</p>
<ul>
<li>Use meaningful filenames (e.g., blocked_senders.map vs list1.map)</li>
<li>Keep related maps in dedicated directories</li>
<li>Use comments in maps to document entries</li>
</ul>
</li>
<li>
<p>Performance Considerations</p>
<ul>
<li>Use prefilters for early accept/reject decisions</li>
<li>Prefer simple matches over complex regexes</li>
<li>Use CDB maps for large datasets</li>
<li>Consider Redis for frequently updated maps</li>
</ul>
</li>
<li>
<p>Security Recommendations</p>
<ul>
<li>Regularly audit map contents</li>
<li>Use HTTPS for remote maps</li>
<li>Implement redundancy for critical maps</li>
<li>Monitor map update frequency</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="map-attributes">Map Attributes<a href="#map-attributes" class="hash-link" aria-label="Прямая ссылка на Map Attributes" title="Прямая ссылка на Map Attributes">​</a></h3>
<p>Mandatory attributes are:</p>
<ul>
<li><code>type</code> - map <a href="#map-types">type</a></li>
<li><code>map</code> - <a href="#map-field-syntax">map data</a></li>
</ul>
<p>Optional map configuration attributes:</p>
<ul>
<li><code>prefilter</code> - defines if the map is used in <a href="#pre-filter-maps">prefilter mode</a></li>
<li><code>action</code> - for prefilter maps defines action set by map match</li>
<li><code>regexp</code> - set to <code>true</code> if your map contain <a href="#regexp-maps">regular expressions</a></li>
<li><code>symbols</code> - array of symbols that this map can insert (for key-value pairs), <a href="#multiple-symbol-maps">learn more</a>. Please bear in mind, that if you define this attribute, your map must have entries in form <code>key&lt;spaces&gt;value</code> to match a specific symbol.</li>
<li><code>score</code> - score of the symbol (can be redefined in the <code>metric</code> section)</li>
<li><code>description</code> - map description</li>
<li><code>message</code> - message returned to MTA on prefilter reject action being triggered</li>
<li><code>group</code> - group for the symbol (can be redefined in <code>metric</code>)</li>
<li><code>require_symbols</code> - expression of symbols that have to match for a specific message: <a href="#conditional-maps">learn more</a></li>
<li><code>filter</code> - match specific part of the input (for example, email domain): <a href="#map-filters">here</a> is the complete definition of maps filters</li>
<li><code>extract_from</code> - attribute extracts values of the sender/recipient from the SMTP dialog or the From/To header. To achieve this, set the value to <code>smtp</code>, <code>mime</code>, or <code>both</code> to match both sources. It&#x27;s important to note that <code>extract_from</code> is solely utilized in conjunction with the <code>from</code> or <code>rcpt</code> map <a href="#map-types">type</a>.</li>
</ul>
<p>When using header maps, it is essential to specify the exact <code>header</code> by utilizing the header option.</p>
<p>It is important to note that there is often confusion between the <code>type</code> and <code>filter</code> parameters for the multimap module. The general rule of thumb is that <code>type</code> refers to <em>what information</em> is checked in the map, such as URLs, IPs, and headers. On the other hand, the <code>filter</code> attribute refers to <em>how this information is transformed</em> before being checked, such as extracting domains.</p>
<p><strong>Selector</strong> maps are using <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/selectors">selectors</a>, which defines both extraction and transformation. Consequently, this type of map can be considered as the most basic and flexible. All other types of maps can be expressed using a selector map. Furthermore, it is possible to store <a href="#dependent-maps">dependent maps</a> in Redis using the selectors framework.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="map-field-syntax">Map field syntax<a href="#map-field-syntax" class="hash-link" aria-label="Прямая ссылка на Map field syntax" title="Прямая ссылка на Map field syntax">​</a></h3>





































<table><thead><tr><th style="text-align:left">Example</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>http://example.com/list</code></td><td style="text-align:left">HTTP map, reloaded using <code>If-Modified-Since</code>, can be signed</td></tr><tr><td style="text-align:left"><code>https://example.com/list</code></td><td style="text-align:left">HTTPS map - same as HTTP but with TLS enabled (with certificate check)</td></tr><tr><td style="text-align:left"><code>file:///path/to/list</code></td><td style="text-align:left">file map, reloaded on change, can be signed</td></tr><tr><td style="text-align:left"><code>/path/to/list</code></td><td style="text-align:left">shorter form of a file map</td></tr><tr><td style="text-align:left"><code>cdb://path/to/list.cdb</code></td><td style="text-align:left"><a href="https://www.corpit.ru/mjt/tinycdb.html" target="_blank" rel="noopener noreferrer">CDB</a> map in file, cannot be signed</td></tr><tr><td style="text-align:left"><code>redis://&lt;hashkey&gt;</code></td><td style="text-align:left">Redis map, read field in the hash stored at key</td></tr><tr><td style="text-align:left"><code>redis+selector://selector</code></td><td style="text-align:left">(from version 2.0) similar to the former one Redis map where a hash key is acquired by application of some <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/selectors">selector</a> that allows to create dependent maps</td></tr></tbody></table>
<p>A combination of files and HTTP can be used to create a resulting map that is a joint list of its elements, as shown in the following example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;https://maps.rspamd.com/rspamd/mime_types.inc.zst&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;${DBDIR}/mime_types.inc.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;fallback+file://${CONFDIR}/mime_types.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre></div></div>
<p>It is important to note that redis or cdb maps cannot be combined with generic maps.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="map-type-prefixes">Map Type Prefixes<a href="#map-type-prefixes" class="hash-link" aria-label="Прямая ссылка на Map Type Prefixes" title="Прямая ссылка на Map Type Prefixes">​</a></h3>
<p>Map content can be explicitly typed by prefixing the map path with a format specifier. For example:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;regexp;/path/to/file.re&quot;    # Treat content as regular expressions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">map = &quot;regexp_multi;/path/to/map&quot;  # Treat as regexps, match all possible entries</span><br></span></code></pre></div></div>
<p>Available format specifiers:</p>
<ul>
<li><code>regexp;</code> or <code>re;</code> - Content contains regular expressions</li>
<li><code>regexp_multi;</code> or <code>re_multi;</code> - Content contains regular expressions, match all possible entries</li>
<li><code>glob;</code> - Content contains glob patterns</li>
<li><code>glob_multi;</code> - Content contains glob patterns, match all possible entries</li>
<li><code>radix</code>; or <code>ipnet;</code> - Content contains IP/CIDR entries</li>
<li><code>set</code>; - Content treated as set members</li>
<li><code>hash;</code> or <code>plain;</code> - Content treated as hash table entries</li>
</ul>
<p>Note: Format specifiers are different from the <code>regexp = true;</code> and <code>multi = true;</code> options in map configuration. While they achieve similar results, format specifiers take precedence over configuration options.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="maps-content">Maps content<a href="#maps-content" class="hash-link" aria-label="Прямая ссылка на Maps content" title="Прямая ссылка на Maps content">​</a></h3>
<p>Maps can contain keys:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key2</span><br></span></code></pre></div></div>
<p>key-value pairs (for multi-symbols maps):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key1 value1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key2 value2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key3 value3:score</span><br></span></code></pre></div></div>
<p>any comments:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Single line comment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key2 # Embedded comment</span><br></span></code></pre></div></div>
<p>IP maps can also contain IPs or IP/network in CIDR notation</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.0.0.0/8</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-types">Map types<a href="#map-types" class="hash-link" aria-label="Прямая ссылка на Map types" title="Прямая ссылка на Map types">​</a></h2>
<p>Type attribute means what is matched with this map. The following types are supported:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="email-related-types">Email-related Types<a href="#email-related-types" class="hash-link" aria-label="Прямая ссылка на Email-related Types" title="Прямая ссылка на Email-related Types">​</a></h3>
<ul>
<li><code>from</code>: Filter senders (spam sources, newsletters)</li>
<li><code>rcpt</code>: Protect internal addresses, catch typos</li>
<li><code>header</code>: Custom header processing (X-Spam, List-Id)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-related-types">Content-related Types<a href="#content-related-types" class="hash-link" aria-label="Прямая ссылка на Content-related Types" title="Прямая ссылка на Content-related Types">​</a></h3>
<ul>
<li><code>content</code>: Pattern matching in message bodies</li>
<li><code>filename</code>: Attachment filtering</li>
<li><code>url</code>: Filtering of the URLs in the messages</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="connection-related-types">Connection-related Types<a href="#connection-related-types" class="hash-link" aria-label="Прямая ссылка на Connection-related Types" title="Прямая ссылка на Connection-related Types">​</a></h3>
<ul>
<li><code>ip</code>: IP/network filtering</li>
<li><code>asn</code>: Geographic/provider filtering</li>
<li><code>hostname</code>: HELO/SMTP validation</li>
</ul>













































































<table><thead><tr><th style="text-align:left">Type</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>asn</code></td><td style="text-align:left">matches ASN number passed by <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/asn">ASN module</a></td></tr><tr><td style="text-align:left"><code>content</code></td><td style="text-align:left">matches specific content of a message (e.g. headers, body or even a full message) against some map, usually regular expressions map</td></tr><tr><td style="text-align:left"><code>country</code></td><td style="text-align:left">matches country code of AS passed by <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/asn">ASN module</a></td></tr><tr><td style="text-align:left"><code>dnsbl</code></td><td style="text-align:left">matches IP of the host that performed message handoff against some DNS blacklist (consider using <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/rbl">RBL</a> module for this)</td></tr><tr><td style="text-align:left"><code>filename</code></td><td style="text-align:left">matches attachment filenames and filenames in archives against map. It also includes detected filename match from version 2.0. For example, if some attachment has <code>.png</code> extension but it has real type detected as <code>image/jpeg</code> then two checks would be performed: for the original attachment and for the detected one. This does not include files in archives as Rspamd does not extract them.</td></tr><tr><td style="text-align:left"><code>from</code></td><td style="text-align:left">matches <strong>envelope</strong> from (or header <code>From</code> if envelope from is absent)</td></tr><tr><td style="text-align:left"><code>header</code></td><td style="text-align:left">matches any header specified (must have <code>header = &quot;Header-Name&quot;</code> configuration attribute)</td></tr><tr><td style="text-align:left"><code>helo</code></td><td style="text-align:left">matches HELO of the message handoff session</td></tr><tr><td style="text-align:left"><code>hostname</code></td><td style="text-align:left">matches reverse DNS name of the host that performed message handoff</td></tr><tr><td style="text-align:left"><code>ip</code></td><td style="text-align:left">matches IP of the host that performed message handoff (against radix map)</td></tr><tr><td style="text-align:left"><code>mempool</code></td><td style="text-align:left">matches contents of a mempool variable (specified with <code>variable</code> parameter)</td></tr><tr><td style="text-align:left"><code>received</code></td><td style="text-align:left">(new in 1.5) matches elements of <code>Received</code> headers</td></tr><tr><td style="text-align:left"><code>rcpt</code></td><td style="text-align:left">matches any of  <strong>envelope</strong> rcpt or header <code>To</code> if envelope info is missing</td></tr><tr><td style="text-align:left"><code>selector</code></td><td style="text-align:left">applies generic <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration/selectors">selector</a> and check data returned in the specific map. This type must have <code>selector</code> option and an optional <code>delimiter</code> option that defines how to join multiple selectors (an empty string by default). If a selector returns multiple values, e.g. <code>urls</code>, then all values are checked. Normal filter logic can also be applied to the selector&#x27;s results.</td></tr><tr><td style="text-align:left"><code>symbol_options</code></td><td style="text-align:left">(new in 1.6.3) match &#x27;options&#x27; yielded by whichever symbol of interest (requires <code>target_symbol</code> parameter)</td></tr><tr><td style="text-align:left"><code>url</code></td><td style="text-align:left">matches URLs in messages against maps (this excludes by default images urls and urls extracted from content parts, e.g. PDF parts)</td></tr><tr><td style="text-align:left"><code>user</code></td><td style="text-align:left">matches authenticated username against maps</td></tr></tbody></table>
<p>DNS maps are considered legacy and it is not encouraged to use them in new projects. Instead, <a href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/rbl">rbl</a> should be used for that purpose.</p>
<p>Maps can also be specified as <a href="https://www.corpit.ru/mjt/tinycdb.html" target="_blank" rel="noopener noreferrer">CDB</a> databases, which might be useful for large maps:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SOME_SYMBOL {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map = &quot;cdb:///path/to/file.cdb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="regexp-maps">Regexp maps<a href="#regexp-maps" class="hash-link" aria-label="Прямая ссылка на Regexp maps" title="Прямая ссылка на Regexp maps">​</a></h2>
<p>All maps, except for <code>ip</code> and <code>dnsbl</code> maps, support the <code>regexp</code> mode. In this mode, all keys in maps are treated as regular expressions. For example:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Sole key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/example\d+\.com/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Key + value (test)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/other\d+\.com/i test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Comments are still enabled</span><br></span></code></pre></div></div>
<p>For performance considerations, it is recommended to use only expressions supported by <a href="https://intel.github.io/hyperscan/dev-reference/compilation.html#pattern-support" target="_blank" rel="noopener noreferrer">Hyperscan</a> as this engine provides fast performance without any additional cost. Currently, there is no way to distinguish which particular regexp was matched in case of multiple regexps being matched.</p>
<p>To enable the <code>regexp</code> mode, you should set the <code>regexp</code> option to <code>true</code>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SENDER_FROM_WHITELIST {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/from.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regexp = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="map-filters">Map filters<a href="#map-filters" class="hash-link" aria-label="Прямая ссылка на Map filters" title="Прямая ссылка на Map filters">​</a></h2>
<p>In Rspamd, it is also possible to apply filtering expressions before checking the value against a particular map. This is particularly useful for <code>header</code> rules. Filters can be specified using the <code>filter</code> option, and the following filters are supported:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-filters">Content filters<a href="#content-filters" class="hash-link" aria-label="Прямая ссылка на Content filters" title="Прямая ссылка на Content filters">​</a></h3>
<p>For content maps, the following filters are supported:</p>

































<table><thead><tr><th style="text-align:left">Content filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>body</code></td><td style="text-align:left">raw undecoded body content (with the exceptions of headers)</td></tr><tr><td style="text-align:left"><code>full</code></td><td style="text-align:left">raw undecoded content of a message (including headers)</td></tr><tr><td style="text-align:left"><code>headers</code></td><td style="text-align:left">undecoded headers</td></tr><tr><td style="text-align:left"><code>text</code></td><td style="text-align:left">decoded and converted text parts (without HTML tags but with newlines)</td></tr><tr><td style="text-align:left"><code>rawtext</code></td><td style="text-align:left">decoded but not converted text parts (with HTML tags and newlines)</td></tr><tr><td style="text-align:left"><code>oneline</code></td><td style="text-align:left">decoded and stripped text content (without HTML tags and newlines)</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-filter-scoring-behavior">Content Filter Scoring Behavior<a href="#content-filter-scoring-behavior" class="hash-link" aria-label="Прямая ссылка на Content Filter Scoring Behavior" title="Прямая ссылка на Content Filter Scoring Behavior">​</a></h3>
<ul>
<li><code>body</code> - applies regex over the whole raw message body with single scoring</li>
<li><code>text</code> - processes both text and HTML parts in multipart/alternative messages, which can result in double scoring</li>
<li><code>oneline</code> - similar to <code>text</code>, processes each text part separately</li>
</ul>
<p><strong>Note</strong>: Before Rspamd 3.11, for <code>text</code> and <code>oneline</code> filters, the final score may be higher than defined if the message contains multiple text parts (e.g., both plain text and HTML). The <code>one_shot = true;</code> option can be used to limit scoring to a single match, though this behaves per text part.</p>
<p><strong>Note</strong>: from Rspamd 3.11, this has been changed: only <strong>distinct</strong> parts are selected for matching. For example, if <code>text/plain</code> and <code>text/html</code> parts have the same text content, that content is matched only once.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="filename-filters">Filename filters<a href="#filename-filters" class="hash-link" aria-label="Прямая ссылка на Filename filters" title="Прямая ссылка на Filename filters">​</a></h3>
<p>Since version 2.0, Filename maps also check for detected filename matches. For instance, if an attachment has a <code>.png</code> extension, but its real type is detected as <code>image/jpeg</code>, two checks will be performed - one for the original attachment and one for the detected one. It is worth noting that Rspamd does not extract files in archives, so these files are not included in the checks.</p>
<p>Filename maps support the following set of filters:</p>

















<table><thead><tr><th style="text-align:left">Filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>extension</code></td><td style="text-align:left">matches file extension</td></tr><tr><td style="text-align:left"><code>regexp:/re/</code></td><td style="text-align:left">extract data from filename according to some regular expression</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="from-rcpt-and-header-filters">From, rcpt and header filters<a href="#from-rcpt-and-header-filters" class="hash-link" aria-label="Прямая ссылка на From, rcpt and header filters" title="Прямая ссылка на From, rcpt and header filters">​</a></h3>
<p>These are generic emails and headers filters:</p>

































<table><thead><tr><th style="text-align:left">Filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>email</code> or <code>email:addr</code></td><td style="text-align:left">parse header value and extract email address from it (<code>Somebody &lt;user@example.com&gt;</code> -&gt; <code>user@example.com</code>)</td></tr><tr><td style="text-align:left"><code>email:user</code></td><td style="text-align:left">parse header value as email address and extract user name from it (<code>Somebody &lt;user@example.com&gt;</code> -&gt; <code>user</code>)</td></tr><tr><td style="text-align:left"><code>email:domain</code></td><td style="text-align:left">parse header value as email address and extract domain part from it (<code>Somebody &lt;user@example.com&gt;</code> -&gt; <code>example.com</code>)</td></tr><tr><td style="text-align:left"><code>email:domain:tld</code></td><td style="text-align:left">parse header value as email address and extract effective second level domain from it (<code>Somebody &lt;user@foo.example.com&gt;</code> -&gt; <code>example.com</code>)</td></tr><tr><td style="text-align:left"><code>email:name</code></td><td style="text-align:left">parse header value as email address and extract displayed name from it (<code>Somebody &lt;user@example.com&gt;</code> -&gt; <code>Somebody</code>)</td></tr><tr><td style="text-align:left"><code>regexp:/re/</code></td><td style="text-align:left">extracts generic information using the specified regular expression</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="helo-hostname-filters">Helo, hostname filters<a href="#helo-hostname-filters" class="hash-link" aria-label="Прямая ссылка на Helo, hostname filters" title="Прямая ссылка на Helo, hostname filters">​</a></h3>





















<table><thead><tr><th style="text-align:left">Filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>tld</code></td><td style="text-align:left">matches eSLD (effective second level domain - a second-level domain or something that&#x27;s effectively so like <code>example.com</code> or <code>example.za.org</code>)</td></tr><tr><td style="text-align:left"><code>tld:regexp:/re/</code></td><td style="text-align:left">extracts generic information using the specified regular expression from the eSLD part</td></tr><tr><td style="text-align:left"><code>top</code></td><td style="text-align:left">matches TLD (top level domain) part of the helo/hostname</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mempool-filters">Mempool filters<a href="#mempool-filters" class="hash-link" aria-label="Прямая ссылка на Mempool filters" title="Прямая ссылка на Mempool filters">​</a></h3>
<ul>
<li><code>regexp:/re/</code> - extract data from mempool variable according to some regular expression</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="received-filters">Received filters<a href="#received-filters" class="hash-link" aria-label="Прямая ссылка на Received filters" title="Прямая ссылка на Received filters">​</a></h3>
<p>If no filter is specified <code>real_ip</code> is used by default.</p>

















































<table><thead><tr><th style="text-align:left">Filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>from_hostname</code></td><td style="text-align:left">string that represents hostname provided by a peer</td></tr><tr><td style="text-align:left"><code>from_ip</code></td><td style="text-align:left">IP address as provided by a peer</td></tr><tr><td style="text-align:left"><code>real_hostname</code></td><td style="text-align:left">hostname as resolved by MTA</td></tr><tr><td style="text-align:left"><code>real_ip</code></td><td style="text-align:left">IP as resolved by PTR request of MTA</td></tr><tr><td style="text-align:left"><code>by_hostname</code></td><td style="text-align:left">MTA hostname</td></tr><tr><td style="text-align:left"><code>proto</code></td><td style="text-align:left">protocol, e.g. ESMTP or ESMTPS</td></tr><tr><td style="text-align:left"><code>timestamp</code></td><td style="text-align:left">received timestamp</td></tr><tr><td style="text-align:left"><code>for</code></td><td style="text-align:left">for value (unparsed mailbox)</td></tr><tr><td style="text-align:left"><code>tld:from_hostname</code></td><td style="text-align:left">extract eSLD part from peer-provided hostname</td></tr><tr><td style="text-align:left"><code>tld:real_hostname</code></td><td style="text-align:left">extract eSLD part from MTA-verified hostname</td></tr></tbody></table>
<p>The <code>real_ip</code> and <code>from_ip</code> filters must be used in conjunction with IP maps.</p>
<p>Additionally to these filters, Received maps support the following configuration settings:</p>
<ul>
<li><code>min_pos</code> - Minimum position of Received header to match</li>
<li><code>max_pos</code> - Maximum position of Received header to match</li>
</ul>
<p>Negative values can be specified to match positions relative to the end of Received headers.</p>
<ul>
<li><code>flags</code> - One of more flags which MUST be present to match</li>
<li><code>nflags</code> - One or more flags which must NOT be present to match</li>
</ul>
<p>Currently available flags are <code>ssl</code> (hop used SSL) and <code>authenticated</code> (hop used SMTP authentication).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selector-options-filters">Selector options filters<a href="#selector-options-filters" class="hash-link" aria-label="Прямая ссылка на Selector options filters" title="Прямая ссылка на Selector options filters">​</a></h3>
<ul>
<li><code>regexp:/re/</code> - extract data from selector&#x27;s results according to some regular expression (usually not needed)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="symbol-options-filters">Symbol options filters<a href="#symbol-options-filters" class="hash-link" aria-label="Прямая ссылка на Symbol options filters" title="Прямая ссылка на Symbol options filters">​</a></h3>
<ul>
<li><code>regexp:/re/</code> - extract data from symbol options according to some regular expression</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="url-filters">URL filters<a href="#url-filters" class="hash-link" aria-label="Прямая ссылка на URL filters" title="Прямая ссылка на URL filters">​</a></h3>
<p>URL maps allows another set of filters (by default, <code>url</code> maps are matched using hostname part):</p>

























































<table><thead><tr><th style="text-align:left">Filter</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>full</code></td><td style="text-align:left">matches the complete URL (not the hostname)</td></tr><tr><td style="text-align:left"><code>full:regexp:/re/</code></td><td style="text-align:left">extracts generic information using the specified regular expression from the full URL text</td></tr><tr><td style="text-align:left"><code>is_obscured</code></td><td style="text-align:left">matches obscured URLs</td></tr><tr><td style="text-align:left"><code>is_phished</code></td><td style="text-align:left">matches hostname but if and only if the URL is phished (e.g. pretended to be from another domain)</td></tr><tr><td style="text-align:left"><code>is_redirected</code></td><td style="text-align:left">matches redirected URLs</td></tr><tr><td style="text-align:left"><code>path</code></td><td style="text-align:left">match path</td></tr><tr><td style="text-align:left"><code>query</code></td><td style="text-align:left">match query string</td></tr><tr><td style="text-align:left"><code>regexp:/re/</code></td><td style="text-align:left">extracts generic information using the specified regular expression from the hostname</td></tr><tr><td style="text-align:left"><code>tag:name</code></td><td style="text-align:left">matches full hostnames that have URL tag with <code>name</code></td></tr><tr><td style="text-align:left"><code>tld</code></td><td style="text-align:left">matches eSLD (effective second level domain - a second-level domain or something that&#x27;s effectively so like <code>example.com</code> or <code>example.za.org</code>)</td></tr><tr><td style="text-align:left"><code>tld:regexp:/re/</code></td><td style="text-align:left">extracts generic information using the specified regular expression from the eSLD part</td></tr><tr><td style="text-align:left"><code>top</code></td><td style="text-align:left">matches TLD (top level domain) part of the hostname</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-filter-maps">Pre-filter maps<a href="#pre-filter-maps" class="hash-link" aria-label="Прямая ссылка на Pre-filter maps" title="Прямая ссылка на Pre-filter maps">​</a></h2>
<p>To enable pre-filter support, you should specify <code>action</code> parameter which can take one of the
following values:</p>
<ul>
<li><code>accept</code> - accept the message (no action)</li>
<li><code>add header</code> or <code>add_header</code> - add a header to the message</li>
<li><code>rewrite subject</code> or <code>rewrite_subject</code> - change the subject</li>
<li><code>greylist</code> - greylist the message</li>
<li><code>reject</code> - drop the message</li>
</ul>
<p>If a map matches, no filters will be processed for a message. It is important to note that prefilter maps do not support multiple symbols or symbol conditions by design.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP_WHITELIST { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;ip&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/tmp/ip.map&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefilter = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;accept&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Better use RBL module instead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SPAMHAUS_PBL_BLACKLIST { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;dnsbl&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;pbl.spamhaus.org&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;PBL dns block list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefilter = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;reject&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-symbol-maps">Multiple symbol maps<a href="#multiple-symbol-maps" class="hash-link" aria-label="Прямая ссылка на Multiple symbol maps" title="Прямая ссылка на Multiple symbol maps">​</a></h2>
<p>Starting from version 1.3.1, it is now possible to define multiple symbols, scores and symbols options using the multimap module. To achieve this, all possible symbols should be defined using the <code>symbols</code> option in the multimap:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTENT_BLACKLISTED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;content&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;body&quot;; # can be headers, full, oneline, text, rawtext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/content.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbols = [&quot;CONTENT_BLACKLISTED1&quot;, &quot;CONTENT_BLACKLISTED2&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regexp = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 1.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In this example, you can use 3 symbols:</p>
<ul>
<li>CONTENT_BLACKLISTED</li>
<li>CONTENT_BLACKLISTED1</li>
<li>CONTENT_BLACKLISTED2</li>
</ul>
<p>the map:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Symbol + score (final score is rule.score * element score = 1 * 10 = 10)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/re1/ CONTENT_BLACKLISTED1:10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Symbol with default score (final score is rule.score = 1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/re2/ CONTENT_BLACKLISTED2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Just a default symbol with a default score.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/re3/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Options specified after the score (opt1, opt2 etc) will be displayed in square brackets in the log output and can be used to provide additional context about the match. For example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/phishing.com/ CONTENT_BLACKLISTED2:10:financial,urgent</span><br></span></code></pre></div></div>
<p>If symbols used in a map are not defined in the <code>symbols</code> attribute, they will be ignored and replaced with the default map symbol. In case the value of a key-value pair is missing, Rspamd will insert the default symbol with a dynamic weight of <code>1.0</code>. This weight is then multiplied by the metric score (which is set by <code>score</code> parameter or implicitly set to zero if this parameter is missing). <strong>Note</strong> if multimap rule has no score, then all dynamic weights will be multiplied by a default implicit score zero, meaning that all symbols can have only <strong>zero</strong> weight.</p>
<p>If the symbol names are unknown/dynamic, you can use the option <code>dynamic_symbols = true</code> to add all possible symbols from that map:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DYN_MULTIMAP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;hostname&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/maps/dynamic_symbols.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dynamic_symbols = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>And the map content:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">foo DYN_TEST1:10:opt1,opt2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar DYN_TEST2:20:opt3,opt4</span><br></span></code></pre></div></div>
<p>From Rspamd 3.11, the scoring rules for dynamic symbols are the same as for static. Before 3.11 there was a bug that the rule score was not taken into account.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-all-matches">Get all matches<a href="#get-all-matches" class="hash-link" aria-label="Прямая ссылка на Get all matches" title="Прямая ссылка на Get all matches">​</a></h3>
<p>If you want to match all possible regexps/globs in that list, not a single one, then you need to define <code>multi</code> flag for that map:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTENT_BLACKLISTED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;content&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;body&quot;; # can be headers, full, oneline, text, rawtext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/content.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbols = [&quot;CONTENT_BLACKLISTED1&quot;, &quot;CONTENT_BLACKLISTED2&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regexp = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  multi = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conditional-maps">Conditional maps<a href="#conditional-maps" class="hash-link" aria-label="Прямая ссылка на Conditional maps" title="Прямая ссылка на Conditional maps">​</a></h2>
<p>Starting from version 1.3.1, it is possible to create maps that depend on other rules and are only checked if certain conditions are met. For example, you may want to perform some whitelisting based on whether a message has a valid SPF policy, but not for messages that are sent to a mailing list. In this case, you can use the following map condition:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM_WHITELISTED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  require_symbols = &quot;R_SPF_ALLOW &amp; !MAILLIST&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;/some/list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In the <code>require_symbols</code> definition, any logical expression of other symbols can be used. Rspamd automatically adds a dependency for a multimap rule on all symbols required by that rule. Symbols added by post-filters cannot be used here, but pre-filter and normal filter symbols are allowed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="redis-for-maps">Redis for maps<a href="#redis-for-maps" class="hash-link" aria-label="Прямая ссылка на Redis for maps" title="Прямая ссылка на Redis for maps">​</a></h2>
<p>Starting from version 1.3.3, Rspamd allows working with maps stored in a Redis backend. Any external application can put data into the Redis database using the HSET command, for example:  <code>HSET hashkey test@example.org 1</code>. Once the data is in Redis, you can define a map using the protocol <code>redis://</code> and specify the hash key to read. Redis settings can be defined inside the <code>multimap</code> module as well.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="combined-maps">Combined maps<a href="#combined-maps" class="hash-link" aria-label="Прямая ссылка на Combined maps" title="Прямая ссылка на Combined maps">​</a></h2>
<p>From version 2.0, you can create maps with multiple values to be checked and joint via expression:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">COMBINED_MAP_AND {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;combined&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type = &quot;radix&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${TESTDIR}/configs/maps/ip.list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;ip&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${TESTDIR}/configs/maps/domains.list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;from:domain&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expression = &quot;from &amp; ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COMBINED_MAP_OR {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;combined&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type = &quot;radix&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${TESTDIR}/configs/maps/ip.list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;ip&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${TESTDIR}/configs/maps/domains.list&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;from:domain&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expression = &quot;from || ip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Combined maps support merely <strong>selectors</strong> syntax, not general multimap rules.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dependent-maps">Dependent maps<a href="#dependent-maps" class="hash-link" aria-label="Прямая ссылка на Dependent maps" title="Прямая ссылка на Dependent maps">​</a></h2>
<p>Version 2.0 introduces the capability to create dependent maps in Redis, where the map key is dependent on some other data extracted from the same message. This allows for the creation of per-user based whitelists, among other use cases.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Прямая ссылка на Examples" title="Прямая ссылка на Examples">​</a></h2>
<p>Here are some examples of multimap configurations:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BLACKLIST_FROM_DISPLAYNAME {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # To work with MIME From use `header` type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;header&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  header = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;email:name&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/example.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SENDER_FROM_WHITELIST_USER {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;email:user&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extract_from = &quot;smtp&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/from.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;accept&quot;; # Prefilter mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># With Redis backend, also you need specify servers for Redis.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SENDER_FROM_WHITELIST_USER {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;redis://hashkey&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SENDER_FROM_REGEXP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;header&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  header = &quot;from&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &#x27;regexp:/.*@/&#x27;; # `&quot;Jon&quot; &lt;jon@example.net&gt;` -&gt; `&quot;Jon&quot; &lt;jon@`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/from_re.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">URL_MAP {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;url&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;tld&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/url.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">URL_MAP_RE {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;url&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &#x27;tld:regexp:/\.[^.]+$/&#x27;; # Extracts the last component of URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;file:///tmp/url.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILENAME_BLACKLISTED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;filename&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;extension&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/filename.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;reject&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message = &quot;A restricted file type was found&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTENT_BLACKLISTED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;content&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;body&quot;; # can be headers, full, oneline, text, rawtext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/content.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbols = [&quot;CONTENT_BLACKLISTED1&quot;, &quot;CONTENT_BLACKLISTED2&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regexp = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ASN_BLACKLIST {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;asn&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/asnlist.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST_RECEIVED_HEADER_IP_IF_AUTHED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;received&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/rcvd_ip.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = &quot;real_ip&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_pos = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flags = [&quot;authenticated&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYMBOL_OPTIONS_DBL {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;symbol_options&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_symbol = &quot;DBL_ABUSE_REDIR&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  symbols = [&quot;INTERESTING_DOMAIN&quot;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;${LOCAL_CONFDIR}/dbl_redir_symbols.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHITELIST_HELO_RCPT {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;combined&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefilter = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action = &quot;accept&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${LOCAL_CONFDIR}/helo_smtp.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;helo&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rcpt = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      map = &quot;${LOCAL_CONFDIR}/rcpt_internal_subdomains.map&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector = &quot;rcpts:domain&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expression = &quot;helo &amp; rcpt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Example adopted from <a href="https://gist.github.com/kvaps/25507a87dc287e6a620e1eec2d60ebc1" target="_blank" rel="noopener noreferrer">@kvaps</a>:</p>
<ul>
<li><code>cd /etc/rspamd</code></li>
<li>create <code>local.d</code> folder if not exists</li>
<li><code>cd local.d</code></li>
<li>create <code>multimap.conf</code> in <code>/etc/rspamd/local.d/</code> folder if it does not exists</li>
<li>create lists:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">touch local_bl_from.map.inc local_bl_ip.map.inc local_bl_rcpt.map.inc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_wl_from.map.inc local_wl_ip.map.inc local_wl_rcpt.map.inc</span><br></span></code></pre></div></div>
<ul>
<li>change permissions:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">chmod o+w local_bl_from.map.inc local_bl_ip.map.inc local_bl_rcpt.map.inc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_wl_from.map.inc local_wl_ip.map.inc local_wl_rcpt.map.inc</span><br></span></code></pre></div></div>
<ul>
<li>edit <code>multimap.conf</code> (you should be in <code>/etc/rspamd/local.d/</code> folder)</li>
</ul>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Blacklists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_bl_ip { type = &quot;ip&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_bl_ip.map.inc&quot;; symbol = &quot;LOCAL_BL_IP&quot;; description = &quot;Local ip blacklist&quot;;score = 3;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_bl_from { type = &quot;from&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_bl_from.map.inc&quot;; symbol = &quot;LOCAL_BL_FROM&quot;; description = &quot;Local from blacklist&quot;;score = 3;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_bl_rcpt { type = &quot;rcpt&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_bl_rcpt.map.inc&quot;; symbol = &quot;LOCAL_BL_RCPT&quot;; description = &quot;Local rcpt blacklist&quot;;score = 3;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Whitelists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_wl_ip { type = &quot;ip&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_wl_ip.map.inc&quot;; symbol = &quot;LOCAL_WL_IP&quot;; description = &quot;Local ip whitelist&quot;;score = -5;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_wl_from { type = &quot;from&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_wl_from.map.inc&quot;; symbol = &quot;LOCAL_WL_FROM&quot;; description = &quot;Local from whitelist&quot;;score = -5;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_wl_rcpt { type = &quot;rcpt&quot;; map = &quot;$LOCAL_CONFDIR/local.d/local_wl_rcpt.map.inc&quot;; symbol = &quot;LOCAL_WL_RCPT&quot;; description = &quot;Local rcpt whitelist&quot;;score = -5;}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spamassassin-like-rules">SpamAssassin-like Rules<a href="#spamassassin-like-rules" class="hash-link" aria-label="Прямая ссылка на SpamAssassin-like Rules" title="Прямая ссылка на SpamAssassin-like Rules">​</a></h2>
<p>Starting from Rspamd 3.13, the multimap module supports SpamAssassin-like rule definitions with regular expressions and meta rules. This allows you to use familiar SpamAssassin syntax for creating complex rules with logical combinations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-1">Configuration<a href="#configuration-1" class="hash-link" aria-label="Прямая ссылка на Configuration" title="Прямая ссылка на Configuration">​</a></h3>
<p>To use SpamAssassin-like rules, set the map type to <code>regexp_rules</code>:</p>
<div class="language-ucl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ucl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">multimap {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # SpamAssassin-like rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CUSTOM_SA_RULES {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;regexp_rules&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map = &quot;/path/to/sa_rules.cf&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Custom SpamAssassin-like rules&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rule-format">Rule Format<a href="#rule-format" class="hash-link" aria-label="Прямая ссылка на Rule Format" title="Прямая ссылка на Rule Format">​</a></h3>
<p>The SpamAssassin-like map supports the following rule types:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="regular-expression-rules">Regular Expression Rules<a href="#regular-expression-rules" class="hash-link" aria-label="Прямая ссылка на Regular Expression Rules" title="Прямая ссылка на Regular Expression Rules">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Header rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header CUSTOM_HEADER_RULE Subject =~ /spam|phishing/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header FROM_FREEMAIL From =~ /\@(gmail|yahoo|hotmail)\.com$/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Body rules  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body CUSTOM_BODY_RULE /viagra|cialis/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rawbody CUSTOM_RAW_BODY /\bhidden\s+text\b/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># URI rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uri CUSTOM_URI_RULE /bit\.ly|tinyurl/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Full message rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">full CUSTOM_FULL_RULE /malicious\s+content/i</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="meta-rules">Meta Rules<a href="#meta-rules" class="hash-link" aria-label="Прямая ссылка на Meta Rules" title="Прямая ссылка на Meta Rules">​</a></h4>
<p>Meta rules combine multiple atoms using logical expressions:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Define meta rules using logical combinations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta SPAM_COMBO CUSTOM_HEADER_RULE &amp; CUSTOM_BODY_RULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta PHISHING_RULE FROM_FREEMAIL &amp; CUSTOM_URI_RULE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta COMPLEX_RULE (CUSTOM_HEADER_RULE | CUSTOM_BODY_RULE) &amp; !WHITELIST_RULE</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="score-rules">Score Rules<a href="#score-rules" class="hash-link" aria-label="Прямая ссылка на Score Rules" title="Прямая ссылка на Score Rules">​</a></h4>
<p>Set custom scores for rules:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Set scores for individual rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score CUSTOM_HEADER_RULE 2.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score SPAM_COMBO 5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score PHISHING_RULE 8.0</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description-rules">Description Rules<a href="#description-rules" class="hash-link" aria-label="Прямая ссылка на Description Rules" title="Прямая ссылка на Description Rules">​</a></h4>
<p>Set custom descriptions for rules:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Set descriptions for individual rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe CUSTOM_HEADER_RULE Detects suspicious header patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe SPAM_COMBO Combination rule for spam detection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe PHISHING_RULE Detects phishing attempts</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="supported-operators">Supported Operators<a href="#supported-operators" class="hash-link" aria-label="Прямая ссылка на Supported Operators" title="Прямая ссылка на Supported Operators">​</a></h3>
<ul>
<li><code>&amp;</code> - AND operation</li>
<li><code>|</code> - OR operation</li>
<li><code>!</code> - NOT operation</li>
<li><code>()</code> - Grouping</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="regular-expression-formats">Regular Expression Formats<a href="#regular-expression-formats" class="hash-link" aria-label="Прямая ссылка на Regular Expression Formats" title="Прямая ссылка на Regular Expression Formats">​</a></h3>
<p>Regular expressions can be specified in several formats:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Standard format with flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/pattern/flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Alternative format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m{pattern}flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Without delimiters (flags not supported)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pattern</span><br></span></code></pre></div></div>
<p>Supported flags: <code>g</code>, <code>i</code>, <code>m</code>, <code>x</code>, <code>s</code>, <code>u</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-configuration">Example Configuration<a href="#example-configuration" class="hash-link" aria-label="Прямая ссылка на Example Configuration" title="Прямая ссылка на Example Configuration">​</a></h3>
<div class="language-ucl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ucl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">multimap {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Main SA rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CUSTOM_SA_CHECKS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;regexp_rules&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map = &quot;file:///etc/rspamd/custom_sa.cf&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Custom SpamAssassin rules&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Content of <code>/etc/rspamd/custom_sa.cf</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Header checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header SUSPICIOUS_SUBJECT Subject =~ /urgent|winner|lottery/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header FROM_SUSPICIOUS From =~ /noreply@.+\.tk$/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Body checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body BODY_SUSPICIOUS /click.*here.*now/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body BODY_MONEY /\$\d+,?\d*\s*(million|thousand)/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># URI checks  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uri URI_SUSPICIOUS /bit\.ly|tinyurl|goo\.gl/i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Meta combinations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta SPAM_LIKELY SUSPICIOUS_SUBJECT &amp; BODY_SUSPICIOUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta PHISH_LIKELY FROM_SUSPICIOUS &amp; URI_SUSPICIOUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta MONEY_SCAM BODY_MONEY &amp; URI_SUSPICIOUS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Descriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe SUSPICIOUS_SUBJECT Detects urgent/lottery type subjects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe BODY_SUSPICIOUS Detects click-here type body content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe SPAM_LIKELY Combination of suspicious subject and body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe PHISH_LIKELY Suspicious sender with URL shorteners</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe MONEY_SCAM Money-related content with suspicious URLs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Scores</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score SUSPICIOUS_SUBJECT 1.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score BODY_SUSPICIOUS 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score SPAM_LIKELY 5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score PHISH_LIKELY 7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score MONEY_SCAM 8.5</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features<a href="#features" class="hash-link" aria-label="Прямая ссылка на Features" title="Прямая ссылка на Features">​</a></h3>
<ul>
<li><strong>Regular Expression Caching</strong>: All regular expressions are cached for optimal performance</li>
<li><strong>Meta Rule Support</strong>: Complex logical combinations of rules</li>
<li><strong>Dynamic Symbol Creation</strong>: Meta rules automatically create new symbols</li>
<li><strong>Score Management</strong>: Flexible scoring system</li>
<li><strong>Named Results</strong>: Full support for Rspamd&#x27;s named results system</li>
<li><strong>Negation Support</strong>: Header rules support <code>!~</code> for negation</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-considerations">Performance Considerations<a href="#performance-considerations" class="hash-link" aria-label="Прямая ссылка на Performance Considerations" title="Прямая ссылка на Performance Considerations">​</a></h3>
<ul>
<li>Regular expressions are compiled once and cached</li>
<li>Meta rules are evaluated lazily</li>
<li>Rules are processed line-by-line during map loading</li>
<li>All rules use Rspamd&#x27;s optimized regexp engine</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Прямая ссылка на Limitations" title="Прямая ссылка на Limitations">​</a></h3>
<ul>
<li>Function-based SpamAssassin rules (eval:) are not supported</li>
<li>Some advanced SpamAssassin features may not be available</li>
<li>Rules are processed in the order they appear in the file</li>
<li><strong>Symbol Removal</strong>: When symbols are removed between map updates, they remain in the symbol table until restart. Automatic cleanup of removed symbols will be implemented in a future version.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/multimap.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/mime_types"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">Mime types modules</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules/mx_check"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">MX Check module</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#quick-start-guide" class="table-of-contents__link toc-highlight">Quick Start Guide</a></li><li><a href="#how-multimap-processing-works" class="table-of-contents__link toc-highlight">How Multimap Processing Works</a></li><li><a href="#principles-of-work" class="table-of-contents__link toc-highlight">Principles of work</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#best-configuration-practices" class="table-of-contents__link toc-highlight">Best Configuration Practices</a><ul><li><a href="#map-attributes" class="table-of-contents__link toc-highlight">Map Attributes</a></li><li><a href="#map-field-syntax" class="table-of-contents__link toc-highlight">Map field syntax</a></li><li><a href="#map-type-prefixes" class="table-of-contents__link toc-highlight">Map Type Prefixes</a></li><li><a href="#maps-content" class="table-of-contents__link toc-highlight">Maps content</a></li></ul></li><li><a href="#map-types" class="table-of-contents__link toc-highlight">Map types</a><ul><li><a href="#email-related-types" class="table-of-contents__link toc-highlight">Email-related Types</a></li><li><a href="#content-related-types" class="table-of-contents__link toc-highlight">Content-related Types</a></li><li><a href="#connection-related-types" class="table-of-contents__link toc-highlight">Connection-related Types</a></li></ul></li><li><a href="#regexp-maps" class="table-of-contents__link toc-highlight">Regexp maps</a></li><li><a href="#map-filters" class="table-of-contents__link toc-highlight">Map filters</a><ul><li><a href="#content-filters" class="table-of-contents__link toc-highlight">Content filters</a></li><li><a href="#content-filter-scoring-behavior" class="table-of-contents__link toc-highlight">Content Filter Scoring Behavior</a></li><li><a href="#filename-filters" class="table-of-contents__link toc-highlight">Filename filters</a></li><li><a href="#from-rcpt-and-header-filters" class="table-of-contents__link toc-highlight">From, rcpt and header filters</a></li><li><a href="#helo-hostname-filters" class="table-of-contents__link toc-highlight">Helo, hostname filters</a></li><li><a href="#mempool-filters" class="table-of-contents__link toc-highlight">Mempool filters</a></li><li><a href="#received-filters" class="table-of-contents__link toc-highlight">Received filters</a></li><li><a href="#selector-options-filters" class="table-of-contents__link toc-highlight">Selector options filters</a></li><li><a href="#symbol-options-filters" class="table-of-contents__link toc-highlight">Symbol options filters</a></li><li><a href="#url-filters" class="table-of-contents__link toc-highlight">URL filters</a></li></ul></li><li><a href="#pre-filter-maps" class="table-of-contents__link toc-highlight">Pre-filter maps</a></li><li><a href="#multiple-symbol-maps" class="table-of-contents__link toc-highlight">Multiple symbol maps</a><ul><li><a href="#get-all-matches" class="table-of-contents__link toc-highlight">Get all matches</a></li></ul></li><li><a href="#conditional-maps" class="table-of-contents__link toc-highlight">Conditional maps</a></li><li><a href="#redis-for-maps" class="table-of-contents__link toc-highlight">Redis for maps</a></li><li><a href="#combined-maps" class="table-of-contents__link toc-highlight">Combined maps</a></li><li><a href="#dependent-maps" class="table-of-contents__link toc-highlight">Dependent maps</a></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a></li><li><a href="#spamassassin-like-rules" class="table-of-contents__link toc-highlight">SpamAssassin-like Rules</a><ul><li><a href="#configuration-1" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#rule-format" class="table-of-contents__link toc-highlight">Rule Format</a></li><li><a href="#supported-operators" class="table-of-contents__link toc-highlight">Supported Operators</a></li><li><a href="#regular-expression-formats" class="table-of-contents__link toc-highlight">Regular Expression Formats</a></li><li><a href="#example-configuration" class="table-of-contents__link toc-highlight">Example Configuration</a></li><li><a href="#features" class="table-of-contents__link toc-highlight">Features</a></li><li><a href="#performance-considerations" class="table-of-contents__link toc-highlight">Performance Considerations</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/vstakhov-docs-search/ru/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>