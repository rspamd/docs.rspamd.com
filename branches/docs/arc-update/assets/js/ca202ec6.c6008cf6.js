"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[7613],{28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>l});var r=s(96540);const i={},d=r.createContext(i);function t(e){const n=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(d.Provider,{value:n},e.children)}},64487:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"modules/neural","title":"Neural network module","description":"The neural network module performs post-classification of messages using a small neural network trained on features extracted from messages. It learns patterns from spam and ham samples and adjusts its scoring based on observed symbol combinations and message metadata.","source":"@site/docs/modules/neural.md","sourceDirName":"modules","slug":"/modules/neural","permalink":"/docs.rspamd.com/branches/docs/arc-update/modules/neural","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/neural.md","tags":[],"version":"current","frontMatter":{"title":"Neural network module"},"sidebar":"docs","previous":{"title":"MX Check module","permalink":"/docs.rspamd.com/branches/docs/arc-update/modules/mx_check"},"next":{"title":"Once received module","permalink":"/docs.rspamd.com/branches/docs/arc-update/modules/once_received"}}');var i=s(74848),d=s(28453);const t={title:"Neural network module"},l="Neural network module",c={},o=[{value:"Architecture overview",id:"architecture-overview",level:2},{value:"Feature extraction",id:"feature-extraction",level:2},{value:"1. Symbol scores",id:"1-symbol-scores",level:3},{value:"2. Metatokens",id:"2-metatokens",level:3},{value:"Dimensionality reduction with PCA",id:"dimensionality-reduction-with-pca",level:2},{value:"Feature providers",id:"feature-providers",level:2},{value:"Built-in providers",id:"built-in-providers",level:3},{value:"LLM provider",id:"llm-provider",level:3},{value:"Fusion options",id:"fusion-options",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Basic setup",id:"basic-setup",level:3},{value:"Configuration options",id:"configuration-options",level:3},{value:"Training options (<code>train</code> section)",id:"training-options-train-section",level:4},{value:"Network architecture options",id:"network-architecture-options",level:4},{value:"Scoring options",id:"scoring-options",level:4},{value:"Storage options",id:"storage-options",level:4},{value:"Other options",id:"other-options",level:4},{value:"Training modes",id:"training-modes",level:3},{value:"Balanced mode (default)",id:"balanced-mode-default",level:4},{value:"Proportional mode",id:"proportional-mode",level:4},{value:"Multiple rules",id:"multiple-rules",level:3},{value:"Settings integration",id:"settings-integration",level:3},{value:"Manual training",id:"manual-training",level:2},{value:"Via HTTP header",id:"via-http-header",level:3},{value:"Via controller endpoint",id:"via-controller-endpoint",level:3},{value:"Store pool only mode",id:"store-pool-only-mode",level:3},{value:"Redis key structure",id:"redis-key-structure",level:2},{value:"Profile index (Sorted Set)",id:"profile-index-sorted-set",level:3},{value:"ANN storage (Hash)",id:"ann-storage-hash",level:3},{value:"Training sets (Sets)",id:"training-sets-sets",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Check ANN status",id:"check-ann-status",level:3},{value:"Check training vector counts",id:"check-training-vector-counts",level:3},{value:"Debug logging",id:"debug-logging",level:3},{value:"Common issues",id:"common-issues",level:3},{value:"Symbol registration",id:"symbol-registration",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"neural-network-module",children:"Neural network module"})}),"\n",(0,i.jsx)(n.p,{children:"The neural network module performs post-classification of messages using a small neural network trained on features extracted from messages. It learns patterns from spam and ham samples and adjusts its scoring based on observed symbol combinations and message metadata."}),"\n",(0,i.jsxs)(n.p,{children:["Since Rspamd 2.0, the module uses ",(0,i.jsx)(n.a,{href:"https://github.com/attractivechaos/kann",children:"kann"}),", a lightweight neural network library compiled into Rspamd. Earlier versions (1.7-2.0) used ",(0,i.jsx)(n.code,{children:"libfann"}),", which is no longer supported."]}),"\n",(0,i.jsx)(n.h2,{id:"architecture-overview",children:"Architecture overview"}),"\n",(0,i.jsx)(n.p,{children:"The neural module operates as a distributed system where multiple Rspamd instances share neural network data through Redis:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Scanner Worker \u2502     \u2502  Scanner Worker \u2502     \u2502 Primary Controller \u2502\n\u2502  (inference)    \u2502     \u2502  (inference)    \u2502     \u2502 (training)         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                       \u2502                        \u2502\n         \u2502  load ANN             \u2502  load ANN              \u2502 train ANN\n         \u2502  store vectors        \u2502  store vectors         \u2502 cleanup old ANNs\n         \u2502                       \u2502                        \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                          \u2502    Redis    \u2502\n                          \u2502  (storage)  \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Scanner workers"})," periodically check Redis for updated neural networks and load them for inference. They also store training vectors when messages meet training criteria."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Primary controller worker"})," periodically checks if enough training vectors have accumulated and spawns training processes. It also cleans up old ANN profiles."]}),"\n",(0,i.jsx)(n.h2,{id:"feature-extraction",children:"Feature extraction"}),"\n",(0,i.jsx)(n.p,{children:"The neural network input is a numeric vector constructed from two sources:"}),"\n",(0,i.jsx)(n.h3,{id:"1-symbol-scores",children:"1. Symbol scores"}),"\n",(0,i.jsxs)(n.p,{children:["Each symbol in the current Rspamd configuration produces one input value. The value is typically the symbol's score normalized to a 0-1 range. Symbols marked with ",(0,i.jsx)(n.code,{children:"nostat"}),", ",(0,i.jsx)(n.code,{children:"idempotent"}),", ",(0,i.jsx)(n.code,{children:"skip"}),", or ",(0,i.jsx)(n.code,{children:"composite"})," flags are excluded, as are any symbols listed in ",(0,i.jsx)(n.code,{children:"blacklisted_symbols"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"2-metatokens",children:"2. Metatokens"}),"\n",(0,i.jsx)(n.p,{children:"Metatokens are 39+ numeric features extracted from message structure and content:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Category"}),(0,i.jsx)(n.th,{children:"Features"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Size"})}),(0,i.jsx)(n.td,{children:"Message size (bucketed)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Images"})}),(0,i.jsx)(n.td,{children:"Total count, PNG ratio, JPEG ratio, large images, small images"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Parts"})}),(0,i.jsx)(n.td,{children:"Text parts ratio, attachments ratio"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Encoding"})}),(0,i.jsx)(n.td,{children:"UTF-8 parts ratio, ASCII parts ratio"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Recipients"})}),(0,i.jsx)(n.td,{children:"MIME recipients count, SMTP recipients count"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Received"})}),(0,i.jsx)(n.td,{children:"Header count, invalid headers, time skew, secure relays"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"URLs"})}),(0,i.jsx)(n.td,{children:"URL count"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Words"})}),(0,i.jsx)(n.td,{children:"Average length, short words, spaces rate, double spaces, non-spaces, ASCII rate, non-ASCII rate, capitals rate, numerics rate"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"HTML links"})}),(0,i.jsx)(n.td,{children:"Link count, HTTP ratio, query ratio, same eTLD+1 ratio, domains per link, max links per domain"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"HTML forms"})}),(0,i.jsx)(n.td,{children:"Form count, unaffiliated POST ratio, affiliated POST ratio"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"CTA"})}),(0,i.jsx)(n.td,{children:"Affiliated flag, weight, affiliated links ratio, trackerish ratio"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Visibility"})}),(0,i.jsx)(n.td,{children:"Hidden text ratio, transparent ratio, hidden blocks, transparent blocks, offscreen blocks, meta refresh count"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"The metatoken schema has a version number (currently 3) that is included in the ANN key prefix. When metatokens change, new ANNs are automatically created."}),"\n",(0,i.jsx)(n.h2,{id:"dimensionality-reduction-with-pca",children:"Dimensionality reduction with PCA"}),"\n",(0,i.jsxs)(n.p,{children:["When ",(0,i.jsx)(n.code,{children:"max_inputs"})," is configured, the module uses Principal Component Analysis (PCA) to reduce the input vector size. This is useful for large symbol configurations where the full vector would be too large for efficient training."]}),"\n",(0,i.jsx)(n.p,{children:"PCA is computed during training by:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Building a scatter matrix from all training vectors"}),"\n",(0,i.jsx)(n.li,{children:"Computing eigenvalues and eigenvectors"}),"\n",(0,i.jsxs)(n.li,{children:["Selecting the top ",(0,i.jsx)(n.code,{children:"max_inputs"})," eigenvectors as the projection matrix"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The PCA matrix is stored alongside the ANN in Redis and applied during both training and inference."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"}),": PCA requires Rspamd to be compiled with BLAS support. Check with ",(0,i.jsx)(n.code,{children:"rspamd --version"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"feature-providers",children:"Feature providers"}),"\n",(0,i.jsx)(n.p,{children:"Starting from recent versions, the neural module supports pluggable feature providers that can supply additional input features beyond symbols and metatokens."}),"\n",(0,i.jsx)(n.h3,{id:"built-in-providers",children:"Built-in providers"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Provider"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"symbols"})}),(0,i.jsx)(n.td,{children:"Traditional symbols + metatokens vector (default)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"metatokens"})}),(0,i.jsx)(n.td,{children:"Metatokens only, without symbol scores"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"llm"})}),(0,i.jsx)(n.td,{children:"LLM-based embeddings from OpenAI or Ollama APIs"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"llm-provider",children:"LLM provider"}),"\n",(0,i.jsx)(n.p,{children:"The LLM provider requests text embeddings from an external API:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nrules {\n  default {\n    providers = [\n      {\n        type = "llm";\n        llm_type = "openai";  # or "ollama"\n        model = "text-embedding-3-small";\n        url = "https://api.openai.com/v1/embeddings";\n        api_key = "sk-...";\n        weight = 1.0;\n        cache_ttl = 86400;  # Cache embeddings for 1 day\n      }\n    ];\n    # When using LLM, autotrain is disabled; use manual training\n    train {\n      autotrain = false;\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["When LLM providers are configured, automatic training is suppressed unless manual training is explicitly requested via the ",(0,i.jsx)(n.code,{children:"ANN-Train"})," header."]}),"\n",(0,i.jsx)(n.h3,{id:"fusion-options",children:"Fusion options"}),"\n",(0,i.jsx)(n.p,{children:"When multiple providers are used, their outputs are concatenated into a single vector:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'fusion {\n  normalization = "zscore";  # none, unit, or zscore\n  include_meta = true;       # Include metatokens provider\n  meta_weight = 1.0;         # Weight for metatokens\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"basic-setup",children:"Basic setup"}),"\n",(0,i.jsx)(n.p,{children:"The module requires Redis and is disabled by default:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nservers = "127.0.0.1:6379";\nenabled = true;\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Define symbol scores in ",(0,i.jsx)(n.code,{children:"local.d/neural_group.conf"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural_group.conf\nsymbols = {\n  "NEURAL_SPAM" {\n    weight = 3.0;\n    description = "Neural network spam";\n  }\n  "NEURAL_HAM" {\n    weight = -3.0;\n    description = "Neural network ham";\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"configuration-options",children:"Configuration options"}),"\n",(0,i.jsxs)(n.h4,{id:"training-options-train-section",children:["Training options (",(0,i.jsx)(n.code,{children:"train"})," section)"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"max_trains"})}),(0,i.jsx)(n.td,{children:"1000"}),(0,i.jsx)(n.td,{children:"Number of spam+ham samples needed to start training"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"max_usages"})}),(0,i.jsx)(n.td,{children:"10"}),(0,i.jsx)(n.td,{children:"How many times an ANN can be retrained before creating new one"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"max_iterations"})}),(0,i.jsx)(n.td,{children:"25"}),(0,i.jsx)(n.td,{children:"Maximum training epochs"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"learning_rate"})}),(0,i.jsx)(n.td,{children:"0.01"}),(0,i.jsx)(n.td,{children:"Neural network learning rate"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"max_epoch"})}),(0,i.jsx)(n.td,{children:"1000"}),(0,i.jsx)(n.td,{children:"Alternative name for max_iterations"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mse"})}),(0,i.jsx)(n.td,{children:"0.001"}),(0,i.jsx)(n.td,{children:"Target mean squared error"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"autotrain"})}),(0,i.jsx)(n.td,{children:"true"}),(0,i.jsx)(n.td,{children:"Enable automatic training based on verdicts"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"train_prob"})}),(0,i.jsx)(n.td,{children:"1.0"}),(0,i.jsx)(n.td,{children:"Probability of storing a training sample (0-1)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"learn_threads"})}),(0,i.jsx)(n.td,{children:"1"}),(0,i.jsx)(n.td,{children:"Training threads (currently unused)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"learn_mode"})}),(0,i.jsx)(n.td,{children:'"balanced"'}),(0,i.jsxs)(n.td,{children:["Training mode: ",(0,i.jsx)(n.code,{children:"balanced"})," or ",(0,i.jsx)(n.code,{children:"proportional"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"classes_bias"})}),(0,i.jsx)(n.td,{children:"0.0"}),(0,i.jsx)(n.td,{children:"Allowed class imbalance in balanced mode (0-1)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"spam_skip_prob"})}),(0,i.jsx)(n.td,{children:"0.0"}),(0,i.jsx)(n.td,{children:"Spam skip probability in proportional mode"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ham_skip_prob"})}),(0,i.jsx)(n.td,{children:"0.0"}),(0,i.jsx)(n.td,{children:"Ham skip probability in proportional mode"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"spam_score"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"Score threshold for spam (overrides verdict)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ham_score"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"Score threshold for ham (overrides verdict)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"store_pool_only"})}),(0,i.jsx)(n.td,{children:"false"}),(0,i.jsx)(n.td,{children:"Store vectors without training (for external training)"})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"network-architecture-options",children:"Network architecture options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"hidden_layer_mult"})}),(0,i.jsx)(n.td,{children:"1.5"}),(0,i.jsx)(n.td,{children:"Hidden layer size = inputs \xd7 this multiplier"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"max_inputs"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"Enable PCA to reduce inputs to this size"})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"scoring-options",children:"Scoring options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"symbol_spam"})}),(0,i.jsx)(n.td,{children:'"NEURAL_SPAM"'}),(0,i.jsx)(n.td,{children:"Symbol inserted for spam classification"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"symbol_ham"})}),(0,i.jsx)(n.td,{children:'"NEURAL_HAM"'}),(0,i.jsx)(n.td,{children:"Symbol inserted for ham classification"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"spam_score_threshold"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"ANN output threshold for spam (0-1)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ham_score_threshold"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"ANN output threshold for ham (0-1)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"flat_threshold_curve"})}),(0,i.jsx)(n.td,{children:"false"}),(0,i.jsx)(n.td,{children:"Use binary 0/1 scores instead of ANN output"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"roc_enabled"})}),(0,i.jsx)(n.td,{children:"false"}),(0,i.jsx)(n.td,{children:"Compute optimal thresholds using ROC analysis"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"roc_misclassification_cost"})}),(0,i.jsx)(n.td,{children:"0.5"}),(0,i.jsx)(n.td,{children:"Cost weight for ROC threshold computation"})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"storage-options",children:"Storage options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ann_expire"})}),(0,i.jsx)(n.td,{children:"172800"}),(0,i.jsx)(n.td,{children:"ANN expiration time in seconds (2 days)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"watch_interval"})}),(0,i.jsx)(n.td,{children:"60.0"}),(0,i.jsx)(n.td,{children:"How often to check Redis for updates"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"lock_expire"})}),(0,i.jsx)(n.td,{children:"600"}),(0,i.jsx)(n.td,{children:"Training lock timeout in seconds"})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"other-options",children:"Other options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"blacklisted_symbols"})}),(0,i.jsx)(n.td,{children:"[]"}),(0,i.jsx)(n.td,{children:"Symbols to exclude from input vector"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"allowed_settings"})}),(0,i.jsx)(n.td,{children:"nil"}),(0,i.jsx)(n.td,{children:"Settings IDs that can train this rule"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"profile"})}),(0,i.jsx)(n.td,{children:"{}"}),(0,i.jsx)(n.td,{children:"Static symbol profiles per settings"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"training-modes",children:"Training modes"}),"\n",(0,i.jsx)(n.h4,{id:"balanced-mode-default",children:"Balanced mode (default)"}),"\n",(0,i.jsxs)(n.p,{children:["Maintains equal proportions of spam and ham samples. The ",(0,i.jsx)(n.code,{children:"classes_bias"})," parameter allows some imbalance:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"classes_bias = 0.0"}),": Strict 1:1 ratio"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"classes_bias = 0.25"}),": Allows up to 75%/25% imbalance"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"proportional-mode",children:"Proportional mode"}),"\n",(0,i.jsxs)(n.p,{children:["Uses ",(0,i.jsx)(n.code,{children:"spam_skip_prob"})," and ",(0,i.jsx)(n.code,{children:"ham_skip_prob"})," to probabilistically skip samples, allowing natural class distribution."]}),"\n",(0,i.jsx)(n.h3,{id:"multiple-rules",children:"Multiple rules"}),"\n",(0,i.jsx)(n.p,{children:"You can define multiple neural networks with different training parameters:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nrules {\n  "LONG" {\n    train {\n      max_trains = 5000;\n      max_usages = 200;\n    }\n    symbol_spam = "NEURAL_SPAM_LONG";\n    symbol_ham = "NEURAL_HAM_LONG";\n    ann_expire = 8640000;  # 100 days\n  }\n  "SHORT" {\n    train {\n      max_trains = 100;\n      max_usages = 2;\n    }\n    symbol_spam = "NEURAL_SPAM_SHORT";\n    symbol_ham = "NEURAL_HAM_SHORT";\n    ann_expire = 86400;  # 1 day\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"settings-integration",children:"Settings integration"}),"\n",(0,i.jsxs)(n.p,{children:["The module automatically creates separate ANNs for different ",(0,i.jsx)(n.a,{href:"/configuration/settings",children:"settings"})," IDs:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'rules {\n  default {\n    allowed_settings = ["inbound", "outbound"];\n    # or: allowed_settings = "all";\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Messages with different settings IDs train and use separate neural networks, which is useful for separating inbound and outbound mail processing."}),"\n",(0,i.jsx)(n.h2,{id:"manual-training",children:"Manual training"}),"\n",(0,i.jsx)(n.h3,{id:"via-http-header",children:"Via HTTP header"}),"\n",(0,i.jsxs)(n.p,{children:["Add ",(0,i.jsx)(n.code,{children:"ANN-Train: spam"})," or ",(0,i.jsx)(n.code,{children:"ANN-Train: ham"})," header to force training:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'rspamc --header "ANN-Train: spam" < spam_message.eml\nrspamc --header "ANN-Train: ham" < ham_message.eml\n'})}),"\n",(0,i.jsx)(n.h3,{id:"via-controller-endpoint",children:"Via controller endpoint"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"/plugins/neural/learn"})," endpoint accepts JSON POST:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:11334/plugins/neural/learn \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "rule": "default",\n    "spam_vec": [[0.1, 0.2, ...], [0.3, 0.4, ...]],\n    "ham_vec": [[0.5, 0.6, ...], [0.7, 0.8, ...]]\n  }\'\n'})}),"\n",(0,i.jsx)(n.h3,{id:"store-pool-only-mode",children:"Store pool only mode"}),"\n",(0,i.jsxs)(n.p,{children:["For external training pipelines, enable ",(0,i.jsx)(n.code,{children:"store_pool_only"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"train {\n  store_pool_only = true;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"This stores training vectors in the task cache as MessagePack, which can be exported to ClickHouse:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\nextra_columns = {\n  Neural_Vec = {\n    selector = "task_cache(\'neural_vec_mpack\')";\n    type = "String";\n    comment = "Training vector for neural";\n  }\n  Neural_Digest = {\n    selector = "task_cache(\'neural_profile_digest\')";\n    type = "String";\n    comment = "Digest of neural profile";\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"redis-key-structure",children:"Redis key structure"}),"\n",(0,i.jsx)(n.p,{children:"The neural module uses several Redis key patterns:"}),"\n",(0,i.jsx)(n.h3,{id:"profile-index-sorted-set",children:"Profile index (Sorted Set)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Key"}),": ",(0,i.jsx)(n.code,{children:"rn{plugin_ver}_{rule_prefix}_{metatoken_ver}_{settings_name}"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example"}),": ",(0,i.jsx)(n.code,{children:"rn3_default_3_default"})]}),"\n",(0,i.jsx)(n.p,{children:"Stores JSON-serialized profiles ranked by timestamp. Each profile contains:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"digest"}),": Symbol configuration hash"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"symbols"}),": Array of symbol names"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"version"}),": Profile version number"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"redis_key"}),": Key where ANN data is stored"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"providers_digest"}),": Hash of provider configuration (if providers used)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ann-storage-hash",children:"ANN storage (Hash)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Key"}),": ",(0,i.jsx)(n.code,{children:"{prefix}_{rule}_{settings}_{digest}_{version}"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example"}),": ",(0,i.jsx)(n.code,{children:"rn_default_default_a1b2c3d4_1"})]}),"\n",(0,i.jsx)(n.p,{children:"Hash fields:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ann"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:"Zstd-compressed neural network data"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"pca"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsxs)(n.td,{children:["Zstd-compressed PCA matrix (if ",(0,i.jsx)(n.code,{children:"max_inputs"})," set)"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"roc_thresholds"})}),(0,i.jsx)(n.td,{children:"JSON"}),(0,i.jsx)(n.td,{children:"Spam and ham thresholds from ROC analysis"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"providers_meta"})}),(0,i.jsx)(n.td,{children:"JSON"}),(0,i.jsx)(n.td,{children:"Provider metadata (dimensions, weights)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"norm_stats"})}),(0,i.jsx)(n.td,{children:"JSON"}),(0,i.jsx)(n.td,{children:"Normalization statistics (mean, std for zscore)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"lock"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:"Unix timestamp when training lock was acquired"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"hostname"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:"Hostname holding the training lock"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"training-sets-sets",children:"Training sets (Sets)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Keys"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{ann_key}_spam_set"})," - Set of zstd-compressed spam training vectors"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{ann_key}_ham_set"})," - Set of zstd-compressed ham training vectors"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Each vector is semicolon-separated numeric values, compressed with zstd."}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"check-ann-status",children:"Check ANN status"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'redis-cli ZRANGE "rn3_default_3_default" 0 -1 WITHSCORES\n'})}),"\n",(0,i.jsx)(n.h3,{id:"check-training-vector-counts",children:"Check training vector counts"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'redis-cli SCARD "rn_default_default_a1b2c3d4_1_spam_set"\nredis-cli SCARD "rn_default_default_a1b2c3d4_1_ham_set"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"debug-logging",children:"Debug logging"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/logging.inc\ndebug_modules = ["neural"];\n'})}),"\n",(0,i.jsx)(n.h3,{id:"common-issues",children:"Common issues"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"ANN not loading"}),": Check that symbols digest matches between workers. Different plugin configurations create incompatible ANNs."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Training not starting"}),": Verify both spam and ham sets have enough samples (",(0,i.jsx)(n.code,{children:"max_trains"}),"). Check for training locks."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Poor accuracy"}),": Ensure balanced training data. Consider adjusting ",(0,i.jsx)(n.code,{children:"classes_bias"})," or using ",(0,i.jsx)(n.code,{children:"roc_enabled"})," for automatic threshold tuning."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"High memory usage"}),": Use ",(0,i.jsx)(n.code,{children:"max_inputs"})," with PCA to reduce vector size for large symbol configurations."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"symbol-registration",children:"Symbol registration"}),"\n",(0,i.jsx)(n.p,{children:"The module registers the following symbols:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Symbol"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NEURAL_CHECK"})}),(0,i.jsx)(n.td,{children:"postfilter"}),(0,i.jsx)(n.td,{children:"Main scoring callback"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NEURAL_LEARN"})}),(0,i.jsx)(n.td,{children:"idempotent"}),(0,i.jsx)(n.td,{children:"Training vector storage callback"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NEURAL_SPAM"})}),(0,i.jsx)(n.td,{children:"virtual"}),(0,i.jsx)(n.td,{children:"Inserted when ANN classifies as spam"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NEURAL_HAM"})}),(0,i.jsx)(n.td,{children:"virtual"}),(0,i.jsx)(n.td,{children:"Inserted when ANN classifies as ham"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Custom symbol names can be configured per rule using ",(0,i.jsx)(n.code,{children:"symbol_spam"})," and ",(0,i.jsx)(n.code,{children:"symbol_ham"})," options."]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);