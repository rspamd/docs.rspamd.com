"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[8105],{740:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"modules/spamtrap","title":"Spamtrap module","description":"The spamtrap module enables you to catch trapped spam emails, and even those from a catch-all domain. Its main purpose is to facilitate learning bayes spam, and if you operate your own fuzzy storage, to learn a fuzzy flag with a fuzzy weight. If you only wish to tag these emails, you may add a score for this symbol in the metrics. Later on, you can use this information in other modules, such as forceactions or metadataexporter. Some examples are provided below.","source":"@site/docs/modules/spamtrap.md","sourceDirName":"modules","slug":"/modules/spamtrap","permalink":"/docs.rspamd.com/branches/master/ru/modules/spamtrap","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/spamtrap.md","tags":[],"version":"current","frontMatter":{"title":"Spamtrap module"},"sidebar":"docs","previous":{"title":"SpamAssassin rules module","permalink":"/docs.rspamd.com/branches/master/ru/modules/spamassassin"},"next":{"title":"SPF module","permalink":"/docs.rspamd.com/branches/master/ru/modules/spf"}}');var t=a(4848),r=a(8453);const i={title:"Spamtrap module"},o="Spamtrap module",l={},d=[{value:"Spamtrap setup",id:"spamtrap-setup",level:2},{value:"Module settings",id:"module-settings",level:3},{value:"User settings",id:"user-settings",level:2},{value:"Advanced: settings_redis example",id:"advanced-settings_redis-example",level:3},{value:"Advanced: Adding emails and domains to Redis",id:"advanced-adding-emails-and-domains-to-redis",level:3}];function c(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"spamtrap-module",children:"Spamtrap module"})}),"\n",(0,t.jsx)(s.p,{children:"The spamtrap module enables you to catch trapped spam emails, and even those from a catch-all domain. Its main purpose is to facilitate learning bayes spam, and if you operate your own fuzzy storage, to learn a fuzzy flag with a fuzzy weight. If you only wish to tag these emails, you may add a score for this symbol in the metrics. Later on, you can use this information in other modules, such as force_actions or metadata_exporter. Some examples are provided below."}),"\n",(0,t.jsx)(s.h2,{id:"spamtrap-setup",children:"Spamtrap setup"}),"\n",(0,t.jsx)(s.p,{children:"The spamtrap plugin can utilise either a map comprising regular expressions representing email addresses or domains, or Redis, where addresses are stored as keys with values that can take any form. You may opt to use either method. When specifying a map parameter, Redis is automatically disabled."}),"\n",(0,t.jsxs)(s.p,{children:["To use Redis - ",(0,t.jsx)(s.a,{href:"/configuration/redis",children:"see here"})," for information about configuring Redis."]}),"\n",(0,t.jsx)(s.p,{children:"An example of a map is shown below."}),"\n",(0,t.jsx)(s.h3,{id:"module-settings",children:"Module settings"}),"\n",(0,t.jsx)(s.p,{children:"Parameters for the spamtrap modules are listed here."}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"action"}),": You can optionally set an action"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"symbol"}),": The name of a symbol that will be inserted, if a match between\nrecipient and a spam trapped email/domain was found. Defaults to 'SPAMTRAP'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"score"}),": The score for this symbol. It defaults to neutral 0.0"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"learn_fuzzy"}),": A boolean that enables or disables fuzzy learning. Defaults to\n'false'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"learn_spam"}),": A boolean that enables or disables bayes spam learning. Defaults\nto 'false'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"fuzzy_flag"}),": Fuzzy flag, which must match with a defined flag in fuzzy_check\nfor a 'denied' rule"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"fuzzy_weight"}),": A weight factor for the fuzzy rule. It defaults to 10.0"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"key_prefix"}),": The Redis prefix which is used to find spamtrap records. It\ndefaults to 'sptr_'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"map"}),": You can define a regexp map, which automatically disables Redis for\nthis module"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"check_authed"}),": A boolean that enables spamtrap checks for authenticated users. Defaults to 'true'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"check_local"}),": A boolean that enables spamtrap checks for local networks. Defaults to 'true'"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"allow_multiple_rcpts"}),": A boolean that enables spamtrap checks if there are multiple recipients. Defaults to 'false'"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Configuration example ",(0,t.jsx)(s.code,{children:"/etc/rspamd/local.d/spamtrap.conf"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-hcl",children:'action = "no action";\nscore = 1.0;\nlearn_fuzzy = true;\nlearn_spam = true;\nmap = file://$LOCAL_CONFDIR/local.d/maps.d/spamtrap.map;\n\nenabled = true;\n'})}),"\n",(0,t.jsx)(s.p,{children:"An example of a map file is:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-text",children:"/^test@example\\.test$/\n/^.*@catchalldomain\\.test$/\n"})}),"\n",(0,t.jsx)(s.p,{children:"The first is a full email address, while the second is a catch-all domain."}),"\n",(0,t.jsx)(s.h2,{id:"user-settings",children:"User settings"}),"\n",(0,t.jsxs)(s.p,{children:["Please see ",(0,t.jsx)(s.a,{href:"/configuration/settings",children:"settings module documentation"})," for more information about using this module; some examples are provided below for convenience."]}),"\n",(0,t.jsx)(s.h3,{id:"advanced-settings_redis-example",children:"Advanced: settings_redis example"}),"\n",(0,t.jsxs)(s.p,{children:["The following is an example that you can use for the spamtrap module. It will look\nin Redis and collect settings for dealing with spam trapped emails or domains. You\ncan place this in ",(0,t.jsx)(s.code,{children:"/etc/rspamd/rspamd.conf.local"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-hcl",children:"# Return spamtrap e-mail addresses from Redis\nsettings_redis {\n        handlers = {\n                SPAMTRAP = <<EOD\nreturn function(task)\n        local rcpt = task:get_recipients('smtp')\n        if not (rcpt and #rcpt == 1) then\n                return\n        end\n        return 'sptr_' .. rcpt[1]['addr']:lower()\nend\nEOD;\n                SPAMTRAP_DOMAIN = <<EOD\nreturn function(task)\n        local rcpt = task:get_recipients('smtp')\n        if not (rcpt and #rcpt == 1) then\n                return\n        end\n        return 'sptr_' .. '@' .. rcpt[1]['domain']:lower()\nend\nEOD;\n        }\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"advanced-adding-emails-and-domains-to-redis",children:"Advanced: Adding emails and domains to Redis"}),"\n",(0,t.jsx)(s.p,{children:"There are various methods to add emails or domains to the Redis store. One approach would be to add them directly through 'redis-cli'. However, if you need to add multiple entries, a straightforward shell script could be useful:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'#!/bin/bash\n\nspamtrap_emails=(\n    "@some-catchall.test"\n    "address1@example.test"\n    "another@foobar.test"\n)\n\nfor name in ${spamtrap_emails[@]}; do\n    echo -n "$name: "\n    redis-cli SET \\\n        "sptr_$name" \\\n        \'{ groups_disabled = ["rbl", "antivirus", "dkim", "spf", "dmarc"]; }\'\ndone\n\nexit 0\n'})}),"\n",(0,t.jsx)(s.p,{children:"We disable specific groups to expedite testing. We do not request RBLs, check for viruses, or perform SPF, DKIM, and DMARC tests, as the majority of trapped spam emails would have already been identified by these rules. Our primary aim is to learn about fuzzy and bayes spam, hence these tests are omitted. You are welcome to include any other tests you deem appropriate."})]})}function m(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,s,a)=>{a.d(s,{R:()=>i,x:()=>o});var n=a(6540);const t={},r=n.createContext(t);function i(e){const s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);