"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[9471],{8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>t});var a=n(6540);const r={},d=a.createContext(r);function i(e){const s=a.useContext(d);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(d.Provider,{value:s},e.children)}},8795:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"modules/milter_headers","title":"Milter headers module","description":"{:.no_toc}","source":"@site/docs/modules/milter_headers.md","sourceDirName":"modules","slug":"/modules/milter_headers","permalink":"/docs.rspamd.com/branches/master/ru/modules/milter_headers","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/milter_headers.md","tags":[],"version":"current","frontMatter":{"title":"Milter headers module"},"sidebar":"docs","previous":{"title":"MID module","permalink":"/docs.rspamd.com/branches/master/ru/modules/mid"},"next":{"title":"Mime types modules","permalink":"/docs.rspamd.com/branches/master/ru/modules/mime_types"}}');var r=n(4848),d=n(8453);const i={title:"Milter headers module"},t="Milter headers module",l={},o=[{value:"Principles of operation",id:"principles-of-operation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Options",id:"options",level:2},{value:"extended_spam_headers",id:"extended_spam_headers",level:3},{value:"authenticated_headers (1.6.1+)",id:"authenticated_headers-161",level:3},{value:"remove_upstream_spam_flag (1.7.1+)",id:"remove_upstream_spam_flag-171",level:3},{value:"local_headers (1.6.1+)",id:"local_headers-161",level:3},{value:"skip_local (1.6.0+)",id:"skip_local-160",level:3},{value:"skip_all (2.8.0+)",id:"skip_all-280",level:3},{value:"skip_authenticated (1.6.0+)",id:"skip_authenticated-160",level:3},{value:"extended_headers_rcpt (1.6.2+)",id:"extended_headers_rcpt-162",level:3},{value:"use",id:"use",level:3},{value:"Removing headers",id:"removing-headers",level:2},{value:"Functions",id:"functions",level:2},{value:"authentication-results",id:"authentication-results",level:3},{value:"fuzzy-hashes (1.7.5+)",id:"fuzzy-hashes-175",level:3},{value:"remove-header (1.6.2+)",id:"remove-header-162",level:3},{value:"remove-headers (1.6.3+)",id:"remove-headers-163",level:3},{value:"remove-spam-flag (1.7.1+)",id:"remove-spam-flag-171",level:3},{value:"spam-header",id:"spam-header",level:3},{value:"stat-signature (1.6.3+)",id:"stat-signature-163",level:3},{value:"x-rspamd-queue-id (1.5.8+)",id:"x-rspamd-queue-id-158",level:3},{value:"x-spamd-result (1.5.8+)",id:"x-spamd-result-158",level:3},{value:"x-rspamd-server (1.5.8+)",id:"x-rspamd-server-158",level:3},{value:"x-spamd-bar",id:"x-spamd-bar",level:3},{value:"x-spam-level",id:"x-spam-level",level:3},{value:"x-spam-status",id:"x-spam-status",level:3},{value:"x-virus",id:"x-virus",level:3},{value:"Custom routines",id:"custom-routines",level:2},{value:"Scan results exposure prevention",id:"scan-results-exposure-prevention",level:2},{value:"Disabling DSN",id:"disabling-dsn",level:3},{value:"Postfix example",id:"postfix-example",level:3}];function c(e){const s={a:"a",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"milter-headers-module",children:"Milter headers module"})}),"\n",(0,r.jsx)(s.p,{children:"{:.no_toc}"}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"milter headers"})," module (formerly known as ",(0,r.jsx)(s.code,{children:"rmilter headers"}),") has been added in Rspamd 1.5 to provide a relatively simple way to configure adding/removing of headers via Rmilter (the alternative being to use the ",(0,r.jsx)(s.a,{href:"/lua/rspamd_task#me7351",children:"API"}),"). Despite its name, it is not tied to the ",(0,r.jsx)(s.code,{children:"milter"})," protocol and also works with supported mailservers that use the HTTP interface such as Haraka and OpenSMTPD."]}),"\n",(0,r.jsx)(s.h2,{id:"principles-of-operation",children:"Principles of operation"}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"milter headers"})," module offers several routines for adding/removing common headers, which can be selectively enabled and configured according to specific needs. Additionally, users have the flexibility to add their own custom routines to the configuration or add them directly from ",(0,r.jsx)(s.a,{href:"/lua/rspamd_task#m70081",children:"Lua"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'# local.d/milter_headers.conf:\n\n# Options\n\n# Add "extended Rspamd headers" (default false) (enables x-spamd-result, x-rspamd-server & x-rspamd-queue-id routines)\n# extended_spam_headers = true;\n\n# List of routines to enable for authenticated users (default empty); see also `skip_authenticated`\n# authenticated_headers = ["authentication-results"];\n\n# Set false to enable all used routines for authenticated users (default true)\n# skip_authenticated = true;\n\n# List of routines to enable for local IPs (default empty); see also `skip_local`\n# local_headers = ["x-spamd-bar"];\n\n# Set false to enable all used routines for local IPs (default true)\n# skip_local = true;\n\n# Routines to use- this is the only required setting (may be omitted if using extended_spam_headers)\nuse = ["x-spamd-bar", "authentication-results"];\n\n# this is where we may configure our selected routines\nroutines {\n  # settings for x-spamd-bar routine\n  x-spamd-bar {\n    # effectively disables negative spambar\n    negative = "";\n  }\n  # other routines...\n}\ncustom {\n  # user-defined routines: more on these later\n}\n'})}),"\n",(0,r.jsx)(s.h2,{id:"options",children:"Options"}),"\n",(0,r.jsx)(s.h3,{id:"extended_spam_headers",children:"extended_spam_headers"}),"\n",(0,r.jsxs)(s.p,{children:['Add "extended Rspamd headers" to messages ',(0,r.jsxs)(s.a,{href:"#scan-results-exposure-prevention",children:["NOT originated from authenticated users or ",(0,r.jsx)(s.code,{children:"our_networks"})]})," (default ",(0,r.jsx)(s.code,{children:"false"}),"). Enables the following routines: ",(0,r.jsx)(s.code,{children:"x-spamd-result"}),", ",(0,r.jsx)(s.code,{children:"x-rspamd-server"})," and ",(0,r.jsx)(s.code,{children:"x-rspamd-queue-id"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"extended_spam_headers = true;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"authenticated_headers-161",children:"authenticated_headers (1.6.1+)"}),"\n",(0,r.jsxs)(s.p,{children:["List of routines to be enabled for authenticated users (default ",(0,r.jsx)(s.code,{children:"empty"}),"). See also ",(0,r.jsx)(s.code,{children:"skip_authenticated"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'authenticated_headers = ["authentication-results"];\n'})}),"\n",(0,r.jsx)(s.h3,{id:"remove_upstream_spam_flag-171",children:"remove_upstream_spam_flag (1.7.1+)"}),"\n",(0,r.jsxs)(s.p,{children:["Set ",(0,r.jsx)(s.code,{children:"false"})," to keep pre-existing spam flag added by an upstream spam filter (default ",(0,r.jsx)(s.code,{children:"true"}),"). This will enable the ",(0,r.jsx)(s.code,{children:"remove-spam-flag"})," option."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"remove_upstream_spam_flag = true;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"local_headers-161",children:"local_headers (1.6.1+)"}),"\n",(0,r.jsxs)(s.p,{children:["List of routines to enable for local IPs (default ",(0,r.jsx)(s.code,{children:"empty"}),"). See also ",(0,r.jsx)(s.code,{children:"skip_local"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'local_headers = ["x-spamd-bar"];\n'})}),"\n",(0,r.jsx)(s.h3,{id:"skip_local-160",children:"skip_local (1.6.0+)"}),"\n",(0,r.jsxs)(s.p,{children:["Set false to always add headers for local IPs (default ",(0,r.jsx)(s.code,{children:"true"}),")."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"skip_local = true;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"skip_all-280",children:"skip_all (2.8.0+)"}),"\n",(0,r.jsxs)(s.p,{children:["Do not add extended headers for any messages (except those matching extended_headers_rcpt) (default ",(0,r.jsx)(s.code,{children:"false"}),")"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"skip_all = true;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"skip_authenticated-160",children:"skip_authenticated (1.6.0+)"}),"\n",(0,r.jsxs)(s.p,{children:["Set false to always add headers for authenticated users (default ",(0,r.jsx)(s.code,{children:"true"}),")"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"skip_authenticated = true;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"extended_headers_rcpt-162",children:"extended_headers_rcpt (1.6.2+)"}),"\n",(0,r.jsxs)(s.p,{children:["List of recipients (default ",(0,r.jsx)(s.code,{children:"empty"}),")."]}),"\n",(0,r.jsxs)(s.p,{children:["When ",(0,r.jsx)(s.a,{href:"#extended_spam_headers",children:(0,r.jsx)(s.code,{children:"extended_spam_headers"})})," is enabled, also add extended Rspamd headers to messages if ",(0,r.jsx)(s.strong,{children:"EVERY"})," envelope recipient match this list (e.g. a list of domains mail server responsible for)."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'extended_headers_rcpt = ["user1", "@example1.com", "user2@example2.com"];\n'})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"extended_headers_rcpt"})," has higher precedence than ",(0,r.jsx)(s.code,{children:"skip_local"}),", ",(0,r.jsx)(s.code,{children:"skip_authenticated"})," and ",(0,r.jsx)(s.code,{children:"skip_all"}),".",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.code,{children:"extended_headers_rcpt"})," paired with ",(0,r.jsx)(s.code,{children:"skip_all = true"})," can be used to only add extended headers to a map of specific recipients."]}),"\n",(0,r.jsx)(s.h3,{id:"use",children:"use"}),"\n",(0,r.jsxs)(s.p,{children:["Routines to use- this is the only required setting (may be omitted if using ",(0,r.jsx)(s.code,{children:"extended_spam_headers"}),")"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-spamd-bar", "authentication-results"];\n'})}),"\n",(0,r.jsx)(s.h2,{id:"removing-headers",children:"Removing headers"}),"\n",(0,r.jsxs)(s.p,{children:["Configuration dealing with removing headers commonly sets a numeric parameter which is typically set to ",(0,r.jsx)(s.code,{children:"0"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"0"})," means all headers with a given name should be removed.\n",(0,r.jsx)(s.code,{children:"1"})," means remove the first header with a given name, and so on\n",(0,r.jsx)(s.code,{children:"-1"})," means remove the last header with a given name, and so on"]}),"\n",(0,r.jsxs)(s.p,{children:["From version 3.9.0, this can be set to ",(0,r.jsx)(s.code,{children:"null"})," to indicate that foreign headers should not be removed."]}),"\n",(0,r.jsx)(s.h2,{id:"functions",children:"Functions"}),"\n",(0,r.jsx)(s.p,{children:"Available routines and their settings are as below, default values are as indicated:"}),"\n",(0,r.jsx)(s.h3,{id:"authentication-results",children:"authentication-results"}),"\n",(0,r.jsxs)(s.p,{children:["Add an ",(0,r.jsx)(s.a,{href:"https://tools.ietf.org/html/rfc7001",children:"authentication-results"})," header."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["authentication-results"];\n#authenticated_headers = ["authentication-results"]; # to add this header for authenticated users\n\nroutines {\n  authentication-results {\n    # Name of header\n    header = "Authentication-Results";\n    # Remove existing headers\n    remove = 1;\n    # Set this false not to add SMTP usernames in authentication-results\n    add_smtp_user = true;\n    # SPF/DKIM/DMARC symbols in case these are redefined\n    spf_symbols {\n      pass = "R_SPF_ALLOW";\n      fail = "R_SPF_FAIL";\n      softfail = "R_SPF_SOFTFAIL";\n      neutral = "R_SPF_NEUTRAL";\n      temperror = "R_SPF_DNSFAIL";\n      none = "R_SPF_NA";\n      permerror = "R_SPF_PERMFAIL";\n    }\n    dkim_symbols {\n      pass = "R_DKIM_ALLOW";\n      fail = "R_DKIM_REJECT";\n      temperror = "R_DKIM_TEMPFAIL";\n      none = "R_DKIM_NA";\n      permerror = "R_DKIM_PERMFAIL";\n    }\n    dmarc_symbols {\n      pass = "DMARC_POLICY_ALLOW";\n      permerror = "DMARC_BAD_POLICY";\n      temperror = "DMARC_DNSFAIL";\n      none = "DMARC_NA";\n      reject = "DMARC_POLICY_REJECT";\n      softfail = "DMARC_POLICY_SOFTFAIL";\n      quarantine = "DMARC_POLICY_QUARANTINE";\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"fuzzy-hashes-175",children:"fuzzy-hashes (1.7.5+)"}),"\n",(0,r.jsx)(s.p,{children:"For each matched fuzzy hash adds a header containing the hash."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["fuzzy-hashes"];\n\nroutines {\n  fuzzy-hashes {\n    header = "X-Rspamd-Fuzzy";\n    remove = 0;\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"remove-header-162",children:"remove-header (1.6.2+)"}),"\n",(0,r.jsxs)(s.p,{children:["Removes a header with the specified name (",(0,r.jsx)(s.code,{children:"header"})," MUST be specified):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["remove-header"];\n\nroutines {\n  remove-header {\n    header = "Remove-This";\n    remove = 0; # 0 means remove all, 1 means remove the first one , -1 remove the last and so on\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"remove-headers-163",children:"remove-headers (1.6.3+)"}),"\n",(0,r.jsxs)(s.p,{children:["Removes multiple headers (",(0,r.jsx)(s.code,{children:"headers"})," MUST be specified):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["remove-headers"];\n\nroutines {\n  remove-headers {\n    headers {\n      "Remove-This" = 0;\n      "This-Too" = 0;\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"remove-spam-flag-171",children:"remove-spam-flag (1.7.1+)"}),"\n",(0,r.jsx)(s.p,{children:"Removes pre-existing spam flag added by an upstream spam filter."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["remove-spam-flag"];\n\nroutines {\n  remove-spam-flag {\n    header = "X-Spam";\n  }\n}\n'})}),"\n",(0,r.jsxs)(s.p,{children:["Default name of the header to be removed is ",(0,r.jsx)(s.code,{children:"X-Spam"})," which can be manipulated using the ",(0,r.jsx)(s.code,{children:"header"})," setting."]}),"\n",(0,r.jsx)(s.h3,{id:"spam-header",children:"spam-header"}),"\n",(0,r.jsx)(s.p,{children:"Adds a predefined header to mail identified as spam."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["spam-header"];\n\nroutines {\n  spam-header {\n    header = "Deliver-To";\n    value = "Junk";\n    remove = 0;\n  }\n}\n'})}),"\n",(0,r.jsxs)(s.p,{children:["Default name/value of the added header is ",(0,r.jsx)(s.code,{children:"Deliver-To"}),"/",(0,r.jsx)(s.code,{children:"Junk"})," which can be manipulated using the ",(0,r.jsx)(s.code,{children:"header"})," and ",(0,r.jsx)(s.code,{children:"value"})," settings."]}),"\n",(0,r.jsx)(s.h3,{id:"stat-signature-163",children:"stat-signature (1.6.3+)"}),"\n",(0,r.jsx)(s.p,{children:"Attaches the stat signature to the message."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"use = [\"stat-signature\"];\n\nroutines {\n  stat-signature {\n    header = 'X-Stat-Signature';\n    remove = 0;\n  }\n}\n"})}),"\n",(0,r.jsx)(s.h3,{id:"x-rspamd-queue-id-158",children:"x-rspamd-queue-id (1.5.8+)"}),"\n",(0,r.jsxs)(s.p,{children:["Adds a header containing the Rspamd queue id of the message ",(0,r.jsxs)(s.a,{href:"#scan-results-exposure-prevention",children:["if it is NOT originated from authenticated users or ",(0,r.jsx)(s.code,{children:"our_networks"})]}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"use = [\"x-rspamd-queue-id\"];\n\nroutines {\n  x-rspamd-queue-id {\n    header = 'X-Rspamd-Queue-Id';\n    remove = 0;\n  }\n}\n"})}),"\n",(0,r.jsx)(s.h3,{id:"x-spamd-result-158",children:"x-spamd-result (1.5.8+)"}),"\n",(0,r.jsxs)(s.p,{children:["Adds a header containing the scan results ",(0,r.jsxs)(s.a,{href:"#scan-results-exposure-prevention",children:["if the message is NOT originated from authenticated users or ",(0,r.jsx)(s.code,{children:"our_networks"})]}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"use = [\"x-spamd-result\"];\n\nroutines {\n  x-spamd-result {\n    header = 'X-Spamd-Result';\n    remove = 0;\n  }\n}\n"})}),"\n",(0,r.jsx)(s.h3,{id:"x-rspamd-server-158",children:"x-rspamd-server (1.5.8+)"}),"\n",(0,r.jsxs)(s.p,{children:["Adds a header containing the local computer host name of the Rspamd server that checked out the message ",(0,r.jsxs)(s.a,{href:"#scan-results-exposure-prevention",children:["if it is NOT originated from authenticated users or ",(0,r.jsx)(s.code,{children:"our_networks"})]}),". Since Rspamd 2.4 the host name can be replaced with a user-defined string specified in the ",(0,r.jsx)(s.code,{children:"hostname"})," setting."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-rspamd-server"];\n\nroutines {\n  x-rspamd-server {\n    header = \'X-Rspamd-Server\';\n    remove = 0;\n    #hostname = "foo.com"; -- Local computer host name if unspecified (2.4+)\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"x-spamd-bar",children:"x-spamd-bar"}),"\n",(0,r.jsx)(s.p,{children:"Adds a visual indicator of spam/ham level."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-spamd-bar"];\n\nroutines {\n  x-spamd-bar {\n    header = "X-Spamd-Bar";\n    positive = "+";\n    negative = "-";\n    neutral = "/";\n    remove = 0;\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"x-spam-level",children:"x-spam-level"}),"\n",(0,r.jsx)(s.p,{children:"Another visual indicator of spam level- SpamAssassin style."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-spam-level"];\n\nroutines {\n  x-spamd-level {\n    header = "X-Spam-Level";\n    char = "*";\n    remove = 0;\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"x-spam-status",children:"x-spam-status"}),"\n",(0,r.jsx)(s.p,{children:"SpamAssassin-style X-Spam-Status header indicating spam status."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-spam-status"];\n\nroutines {\n  x-spam-status {\n    header = "X-Spam-Status";\n    remove = 0;\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"x-virus",children:"x-virus"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'use = ["x-virus"];\n\nroutines {\n  x-virus {\n    header = "X-Virus";\n    remove = 0;\n    # The following setting is an empty list by default and required to be set\n    # These are user-defined symbols added by the antivirus module\n    symbols = ["CLAM_VIRUS", "FPROT_VIRUS"];\n  }\n}\n'})}),"\n",(0,r.jsxs)(s.p,{children:["If the ",(0,r.jsx)(s.a,{href:"/modules/antivirus",children:"Antivirus module"})," detects any viruses in an email, the module adds a header that contains the names of the viruses detected by the configured scanners."]}),"\n",(0,r.jsx)(s.h2,{id:"custom-routines",children:"Custom routines"}),"\n",(0,r.jsxs)(s.p,{children:["User-defined routines can be defined in configuration in the ",(0,r.jsx)(s.code,{children:"custom"})," section, for example:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"use = [\"my_routine\"];\n\ncustom {\n  my_routine = <<EOD\n  return function(task, common_meta)\n    -- parameters are task and metadata from previous functions\n    return nil, -- no error\n    {['X-Foo'] = 'Bar'}, -- add header: X-Foo: Bar\n    {['X-Foo'] = 0 }, -- remove foreign X-Foo headers\n    {} -- metadata to return to other functions\n  end\nEOD;\n}\n"})}),"\n",(0,r.jsxs)(s.p,{children:["You can reference the key ",(0,r.jsx)(s.code,{children:"my_routine"})," in the ",(0,r.jsx)(s.code,{children:"use"})," setting, just like you would with other routines."]}),"\n",(0,r.jsx)(s.p,{children:"Here's a more complex example: If a specific symbol is added, the module will add an additional header:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"use = [\"my_routine\"];\n\ncustom {\n  my_routine = <<EOD\n  return function(task, common_meta)\n    -- parameters are task and metadata from previous functions\n\n    if task:has_symbol('SYMBOL') then\n      return nil, -- no error\n      {['X-Foo'] = 'Bar'}, -- set extra header\n      {['X-Foo'] = 0}, -- remove foreign X-Foo headers\n      {} -- metadata to return to other functions\n    end\n\n    return nil, -- no error\n    {}, -- need to fill the parameter\n    {['X-Foo'] = 0}, -- remove foreign X-Foo headers\n    {} -- metadata to return to other functions\n\n  end\nEOD;\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"scan-results-exposure-prevention",children:"Scan results exposure prevention"}),"\n",(0,r.jsxs)(s.p,{children:["To avoid exposing scan results in outbound email, the extended Rspamd headers routines (",(0,r.jsx)(s.code,{children:"x-spamd-result"}),", ",(0,r.jsx)(s.code,{children:"x-rspamd-server"})," and ",(0,r.jsx)(s.code,{children:"x-rspamd-queue-id"}),") only add headers if the message is ",(0,r.jsx)(s.strong,{children:"NOT"})," originated from authenticated users or ",(0,r.jsx)(s.code,{children:"our_networks"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["If desired, the ",(0,r.jsx)(s.a,{href:"#extended_headers_rcpt-162",children:(0,r.jsx)(s.code,{children:"extended_headers_rcpt"})})," option can be used to include the extended Rspamd headers in messages sent to specific recipients or domains, such as a list of domains the mail server is responsible for."]}),"\n",(0,r.jsx)(s.h3,{id:"disabling-dsn",children:"Disabling DSN"}),"\n",(0,r.jsxs)(s.p,{children:["Delivery status notification (DSN) reports for ",(0,r.jsx)(s.em,{children:"successful"})," email deliveries can include the original message headers, including Rspamd headers. The only way to prevent this is to stop offering DSN to foreign servers."]}),"\n",(0,r.jsx)(s.p,{children:"Additionally, disabling DSN can prevent the generation of backscatter."}),"\n",(0,r.jsx)(s.h3,{id:"postfix-example",children:"Postfix example"}),"\n",(0,r.jsxs)(s.p,{children:["The following configuration example restricts DSN requests to local subnets and authenticated users only. Note that the ",(0,r.jsx)(s.code,{children:"smtpd_discard_ehlo_keyword_address_maps"})," setting is applied to the ",(0,r.jsx)(s.code,{children:"smtp"})," service only, and not to ",(0,r.jsx)(s.code,{children:"smtps"})," or ",(0,r.jsx)(s.code,{children:"submission"}),"."]}),"\n",(0,r.jsx)(s.p,{children:"Make sure to modify the example below to match your subnet(s) accordingly."}),"\n",(0,r.jsx)(s.p,{children:"esmtp_access:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-conf",children:"# Allow DSN requests from local subnets only\n192.168.0.0/16  silent-discard\n10.10.0.0/16    silent-discard\n0.0.0.0/0       silent-discard, dsn\n::/0            silent-discard, dsn\n"})}),"\n",(0,r.jsx)(s.p,{children:"master.cf:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-conf",children:"# ==========================================================================\n# service type  private unpriv  chroot  wakeup  maxproc command + args\n#               (yes)   (yes)   (no)    (never) (100)\n# ==========================================================================\nsmtp      inet  n       -       n       -       1       postscreen\n  -o smtpd_discard_ehlo_keyword_address_maps=cidr:$config_directory/esmtp_access\n"})}),"\n",(0,r.jsx)(s.p,{children:"or globally\nmain.cf:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-conf",children:"smtpd_discard_ehlo_keyword_address_maps = \n        cidr:$config_directory/esmtp_access\n"})}),"\n",(0,r.jsx)(s.p,{children:"DSN can also be disabled for everyone with a shorter configuration change:\nmain.cf:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-conf",children:"# $config_directory/main.cf:\n    smtpd_discard_ehlo_keywords = silent-discard, dsn\n"})})]})}function h(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);