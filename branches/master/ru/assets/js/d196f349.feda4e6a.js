"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[7171],{4734:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"tutorials/redis_replication","title":"Multi-instance Redis replication","description":"This tutorial presents a step-by-step guide on setting up statistics and fuzzy storage replication on FreeBSD. The configuration procedures for other operating systems are quite similar.","source":"@site/docs/tutorials/redis_replication.md","sourceDirName":"tutorials","slug":"/tutorials/redis_replication","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/redis_replication","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/redis_replication.md","tags":[],"version":"current","frontMatter":{"title":"Multi-instance Redis replication"},"sidebar":"docs","previous":{"title":"Usage of fuzzy hashes","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/fuzzy_storage"},"next":{"title":"Setup stunnel to protect Redis","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/stunnel_setup"}}');var r=s(4848),c=s(8453);const t={title:"Multi-instance Redis replication"},a="Bayesian statistics and fuzzy storage replication with multi-instance Redis backend",l={},d=[{value:"Installation",id:"installation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Master instances configuration",id:"master-instances-configuration",level:2},{value:"Starting Redis on the master",id:"starting-redis-on-the-master",level:2},{value:"Setting up encrypted tunnel using stunnel",id:"setting-up-encrypted-tunnel-using-stunnel",level:2},{value:"Replica instances configuration",id:"replica-instances-configuration",level:2},{value:"Starting Redis on the replica",id:"starting-redis-on-the-replica",level:2},{value:"Checking",id:"checking",level:2},{value:"Rspamd configuration on the master",id:"rspamd-configuration-on-the-master",level:2},{value:"Rspamd configuration on the replica",id:"rspamd-configuration-on-the-replica",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"bayesian-statistics-and-fuzzy-storage-replication-with-multi-instance-redis-backend",children:"Bayesian statistics and fuzzy storage replication with multi-instance Redis backend"})}),"\n",(0,r.jsx)(n.p,{children:"This tutorial presents a step-by-step guide on setting up statistics and fuzzy storage replication on FreeBSD. The configuration procedures for other operating systems are quite similar."}),"\n",(0,r.jsxs)(n.p,{children:["The tutorial focuses on a centralized model where Bayesian classifier and fuzzy storage learning occur on a single host and are then distributed among Rspamd installations in remote locations. For the sake of simplicity, the tutorial covers replication to a single ",(0,r.jsx)(n.code,{children:"replica"})," database for each of the ",(0,r.jsx)(n.code,{children:"masters"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"To achieve this, we need to replicate the bayes and fuzzy storage backend data to the remote host. Since we don't want to mirror the entire Redis cache, we should use dedicated Redis instances. It would be wise to separate the bayes and fuzzy storage as well."}),"\n",(0,r.jsxs)(n.p,{children:["We will create three Redis instances on both the ",(0,r.jsx)(n.code,{children:"master"})," and ",(0,r.jsx)(n.code,{children:"replica"})," sides: ",(0,r.jsx)(n.code,{children:"bayes"}),", ",(0,r.jsx)(n.code,{children:"fuzzy"}),", and ",(0,r.jsx)(n.code,{children:"redis"})," for the remaining cache."]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"instance"}),(0,r.jsx)(n.th,{children:"Redis socket"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"redis"})}),(0,r.jsx)(n.td,{children:"localhost:6379"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"bayes"})}),(0,r.jsx)(n.td,{children:"localhost:6378"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fuzzy"})}),(0,r.jsx)(n.td,{children:"localhost:6377"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsxs)(n.p,{children:["To begin, install the ",(0,r.jsx)(n.code,{children:"databases/redis"})," package by executing the following command:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# pkg install redis\n"})}),"\n",(0,r.jsx)(n.p,{children:"Next, create separate working directories for the instances:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# cd /var/db/redis && mkdir bayes fuzzy && chown redis bayes fuzzy\n"})}),"\n",(0,r.jsxs)(n.p,{children:["To enable ",(0,r.jsx)(n.code,{children:"redis"})," and its specific instances, add the following lines to the ",(0,r.jsx)(n.code,{children:"/etc/rc.conf"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'redis_enable="YES"\nredis_profiles="redis bayes fuzzy"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["To enable log rotation for Redis, create a newsyslog configuration file named ",(0,r.jsx)(n.code,{children:"/usr/local/etc/newsyslog.conf.d/redis.newsyslog.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# logfilename          [owner:group]    mode count size when  flags [/pid_file] [sig_num]\n/var/log/redis/redis.log    redis:redis    644  5       100    *  J\n/var/log/redis/bayes.log    redis:redis    644  5       100    *  J\n/var/log/redis/fuzzy.log    redis:redis    644  5       100    *  J\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Generate the default configuration on both the ",(0,r.jsx)(n.code,{children:"master"})," and ",(0,r.jsx)(n.code,{children:"replica"})," hosts, which will be common for all instances:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"# cp /usr/local/etc/redis.conf.sample /usr/local/etc/redis.conf\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Due to security concerns, it is not advisable to expose Redis to external interfaces. Instead, configure Redis to listen on loopback interfaces and utilize stunnel to establish TLS tunnels between the ",(0,r.jsx)(n.code,{children:"replica"})," and ",(0,r.jsx)(n.code,{children:"master"})," hosts. However, please note that this approach also has its own security vulnerabilities. Therefore, ",(0,r.jsx)(n.strong,{children:"do not set up replication"})," if you cannot trust the users of the replica host."]}),"\n",(0,r.jsx)(n.p,{children:"Configure the listening sockets and memory limit (optional) as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-diff",children:"# diff -u1 /usr/local/etc/redis.conf.sample /usr/local/etc/redis.conf\n--- /usr/local/etc/redis.conf.sample    2016-11-03 06:30:49.000000000 +0300\n+++ /usr/local/etc/redis.conf   2016-11-27 13:10:43.671584000 +0300\n@@ -60,3 +60,3 @@\n # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n-bind 127.0.0.1\n+bind 127.0.0.1 ::1\n\n@@ -537,2 +537,3 @@\n # maxmemory <bytes>\n+maxmemory 200M\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Configure the ",(0,r.jsx)(n.code,{children:"redis"})," instance on both the ",(0,r.jsx)(n.code,{children:"master"})," and ",(0,r.jsx)(n.code,{children:"replica"})," hosts in a way that maintains compatibility with a single instance configuration. This ensures that if you already have a single instance database, it will continue to function properly."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/usr/local/etc/redis-redis.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"include /usr/local/etc/redis.conf\n"})}),"\n",(0,r.jsx)(n.h2,{id:"master-instances-configuration",children:"Master instances configuration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/usr/local/etc/redis-bayes.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"include /usr/local/etc/redis.conf\n\nport 6378\n\npidfile /var/run/redis/bayes.pid\nlogfile /var/log/redis/bayes.log\ndbfilename bayes.rdb\ndir /var/db/redis/bayes/\n\nmaxmemory 600M\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/usr/local/etc/redis-fuzzy.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"include /usr/local/etc/redis.conf\n\nport 6377\n\npidfile /var/run/redis/fuzzy.pid\nlogfile /var/log/redis/fuzzy.log\ndbfilename fuzzy.rdb\ndir /var/db/redis/fuzzy/\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If needed, the ",(0,r.jsx)(n.code,{children:"maxmemory"})," is adjusted for specific instances according to expected database size."]}),"\n",(0,r.jsx)(n.h2,{id:"starting-redis-on-the-master",children:"Starting Redis on the master"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"# service redis start"})}),"\n",(0,r.jsx)(n.h2,{id:"setting-up-encrypted-tunnel-using-stunnel",children:"Setting up encrypted tunnel using stunnel"}),"\n",(0,r.jsxs)(n.p,{children:["Please refer to the ",(0,r.jsx)(n.a,{href:"/tutorials/stunnel_setup/",children:"Setting up encrypted tunnel using stunnel"})," guide."]}),"\n",(0,r.jsx)(n.h2,{id:"replica-instances-configuration",children:"Replica instances configuration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/usr/local/etc/redis-bayes.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"include /usr/local/etc/redis.conf\n\nport 6378\n\npidfile /var/run/redis/bayes.pid\nlogfile /var/log/redis/bayes.log\ndbfilename bayes.rdb\ndir /var/db/redis/bayes/\n\nreplicaof localhost 6478\n\nmaxmemory 600M\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/usr/local/etc/redis-fuzzy.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"include /usr/local/etc/redis.conf\n\nport 6377\n\npidfile /var/run/redis/fuzzy.pid\nlogfile /var/log/redis/fuzzy.log\ndbfilename fuzzy.rdb\ndir /var/db/redis/fuzzy/\n\nreplicaof localhost 6477\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As ",(0,r.jsx)(n.code,{children:"replicas"})," do not connect to ",(0,r.jsx)(n.code,{children:"masters"})," directly, ",(0,r.jsx)(n.code,{children:"stunnel's"})," sockets are specified in the ",(0,r.jsx)(n.code,{children:"replicaof"})," directives."]}),"\n",(0,r.jsx)(n.h2,{id:"starting-redis-on-the-replica",children:"Starting Redis on the replica"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"# service redis start"})}),"\n",(0,r.jsx)(n.h2,{id:"checking",children:"Checking"}),"\n",(0,r.jsx)(n.p,{children:"Check replica instances logs. If resynchronization with the masters was successful, you are done."}),"\n",(0,r.jsx)(n.h2,{id:"rspamd-configuration-on-the-master",children:"Rspamd configuration on the master"}),"\n",(0,r.jsxs)(n.p,{children:["On the ",(0,r.jsx)(n.code,{children:"master"})," side configure Rspamd to use distinct Redis instances respectively:"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"local.d/redis.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'servers = "localhost";\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"local.d/classifier-bayes.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'backend = "redis";\nservers = "localhost:6378";\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"override.d/worker-fuzzy.inc"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'backend = "redis";\nservers = "localhost:6377";\n'})}),"\n",(0,r.jsx)(n.h2,{id:"rspamd-configuration-on-the-replica",children:"Rspamd configuration on the replica"}),"\n",(0,r.jsxs)(n.p,{children:["On the ",(0,r.jsx)(n.code,{children:"replica"})," side Rspamd should use local ",(0,r.jsx)(n.code,{children:"redis"})," instance for both reading and writing as it is not replicated."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"local.d/redis.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'servers = "localhost";\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Since local ",(0,r.jsx)(n.code,{children:"bayes"})," and ",(0,r.jsx)(n.code,{children:"fuzzy"})," Redis instances are replicas, Rspamd should use them for reading, but write to the replication ",(0,r.jsx)(n.code,{children:"master"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"local.d/classifier-bayes.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'backend = "redis";\nread_servers = "localhost:6378";\nwrite_servers = "localhost:6478";\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"override.d/worker-fuzzy.inc"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'backend = "redis";\nread_servers = "localhost:6377";\nwrite_servers = "localhost:6477";\n'})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>a});var i=s(6540);const r={},c=i.createContext(r);function t(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);