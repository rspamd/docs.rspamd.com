"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[9863],{5128:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"tutorials/stunnel_setup","title":"Setup stunnel to protect Redis","description":"To establish encrypted communication between Redis masters and slaves, we recommend using stunnel. Stunnel serves as a TLS encryption wrapper between the client and server.","source":"@site/docs/tutorials/stunnel_setup.md","sourceDirName":"tutorials","slug":"/tutorials/stunnel_setup","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/stunnel_setup","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/stunnel_setup.md","tags":[],"version":"current","frontMatter":{"title":"Setup stunnel to protect Redis"},"sidebar":"docs","previous":{"title":"Multi-instance Redis replication","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/redis_replication"},"next":{"title":"MTA integration","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/integration"}}');var i=s(4848),r=s(8453);const c={title:"Setup stunnel to protect Redis"},l="Setting up encrypted tunnel using stunnel",o={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Installation",id:"installation",level:2},{value:"Server configuration (master side)",id:"server-configuration-master-side",level:2},{value:"Client configuration (slave side)",id:"client-configuration-slave-side",level:2},{value:"Preshared keys",id:"preshared-keys",level:2},{value:"Starting stunnel",id:"starting-stunnel",level:2},{value:"Testing",id:"testing",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"setting-up-encrypted-tunnel-using-stunnel",children:"Setting up encrypted tunnel using stunnel"})}),"\n",(0,i.jsxs)(n.p,{children:["To establish encrypted communication between Redis masters and slaves, we recommend using ",(0,i.jsx)(n.a,{href:"https://www.stunnel.org",children:"stunnel"}),". Stunnel serves as a TLS encryption wrapper between the client and server."]}),"\n",(0,i.jsxs)(n.p,{children:["This tutorial provides a detailed explanation of installing and configuring ",(0,i.jsx)(n.code,{children:"stunnel"})," proxies on both the FreeBSD client and server."]}),"\n",(0,i.jsxs)(n.p,{children:["If you are using ",(0,i.jsx)(n.a,{href:"https://docs.digitalocean.com/products/databases/redis/",children:"DigitalOcean's managed Redis"}),", there is a ",(0,i.jsx)(n.a,{href:"https://www.digitalocean.com/community/tutorials/how-to-connect-to-managed-redis-over-tls-with-stunnel-and-redis-cli",children:"community tutorial"})," available as an alternative."]}),"\n",(0,i.jsx)(n.p,{children:"Although the configuration procedures for other operating systems are quite similar, this tutorial focuses on replication to a single client host to simplify the process. This configuration does not require individual pre-shared keys for each client."}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsxs)(n.p,{children:["Assuming we have 3 Redis instances on both ",(0,i.jsx)(n.code,{children:"server"})," and ",(0,i.jsx)(n.code,{children:"client"}),", listening sockets on the ",(0,i.jsx)(n.code,{children:"server"})," (master side):"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"instance"}),(0,i.jsx)(n.th,{children:"Redis socket"}),(0,i.jsx)(n.th,{children:"stunnel socket"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"redis"})}),(0,i.jsx)(n.td,{children:"localhost:6379"}),(0,i.jsx)(n.td,{children:"-"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"bayes"})}),(0,i.jsx)(n.td,{children:"localhost:6378"}),(0,i.jsx)(n.td,{children:"master.example.com:6478"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"fuzzy"})}),(0,i.jsx)(n.td,{children:"localhost:6377"}),(0,i.jsx)(n.td,{children:"master.example.com:6477"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Since the ",(0,i.jsx)(n.code,{children:"redis"})," instance should not be mirrored, we will replicate the ",(0,i.jsx)(n.code,{children:"fuzzy"})," and ",(0,i.jsx)(n.code,{children:"bayes"})," instances. Consequently, we need to set up two TLS tunnels."]}),"\n",(0,i.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsxs)(n.p,{children:["First install the ",(0,i.jsx)(n.code,{children:"security/stunnel"})," package:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# pkg install stunnel\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create pid-file directory:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# mkdir /var/run/stunnel && chown stunnel:stunnel /var/run/stunnel\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To enable ",(0,i.jsx)(n.code,{children:"stunnel"})," add the following lines to the ",(0,i.jsx)(n.code,{children:"/etc/rc.conf"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'stunnel_enable="YES"\nstunnel_pidfile="/var/run/stunnel/stunnel.pid"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"server-configuration-master-side",children:"Server configuration (master side)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/usr/local/etc/stunnel/stunnel.conf"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"setuid = stunnel\nsetgid = nogroup\n\npid = /var/run/stunnel/stunnel.pid\n\n[bayes]\naccept  = 6478\nconnect = 6378\nciphers = PSK\nPSKsecrets = /usr/local/etc/stunnel/psk.txt\n\n[fuzzy]\naccept  = 6477\nconnect = 6377\nciphers = PSK\nPSKsecrets = /usr/local/etc/stunnel/psk.txt\n"})}),"\n",(0,i.jsx)(n.h2,{id:"client-configuration-slave-side",children:"Client configuration (slave side)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/usr/local/etc/stunnel/stunnel.conf"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"setuid = stunnel\nsetgid = nogroup\n\npid = /var/run/stunnel/stunnel.pid\n\n[bayes]\nclient = yes\naccept  = localhost:6478\nconnect = master.example.com:6478\nciphers = PSK\nPSKsecrets = /usr/local/etc/stunnel/psk.txt\n\n[fuzzy]\nclient = yes\naccept  = localhost:6477\nconnect = master.example.com:6477\nciphers = PSK\nPSKsecrets = /usr/local/etc/stunnel/psk.txt\n"})}),"\n",(0,i.jsx)(n.h2,{id:"preshared-keys",children:"Preshared keys"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"/usr/local/etc/stunnel/psk.txt"})," .\nThe ",(0,i.jsx)(n.code,{children:"psk.txt"})," file contains one line for each client:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"test1:oaP4EishaeSaishei6rio6xeeph3az"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"Do not use example passwords."})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Since both the ",(0,i.jsx)(n.code,{children:"bayes"})," and ",(0,i.jsx)(n.code,{children:"fuzzy"})," Redis instances are located on the same host, we can use the same key for both of them."]}),"\n",(0,i.jsx)(n.p,{children:"Considering that this file contains sensitive information, it is crucial to maintain its secrecy by setting secure permissions on it:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"# chmod 600 /usr/local/etc/stunnel/psk.txt"})}),"\n",(0,i.jsx)(n.h2,{id:"starting-stunnel",children:"Starting stunnel"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"# service stunnel start"})}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsxs)(n.p,{children:["From the client host use the ",(0,i.jsx)(n.code,{children:"redis-cli"})," utility to connect to the remote instances:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# redis-cli -p 6477\n# redis-cli -p 6478\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now that the connection is established, you are ready to proceed with configuring replication between the Redis instances. You can follow the instructions provided in the ",(0,i.jsx)(n.a,{href:"/tutorials/redis_replication#rspamd-configuration-on-the-replica",children:"Redis replication configuration guide"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>l});var t=s(6540);const i={},r=t.createContext(i);function c(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);