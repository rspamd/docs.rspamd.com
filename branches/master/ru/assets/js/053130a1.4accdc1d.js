"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[1825],{1072(n,e,s){s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"modules/clickhouse","title":"Clickhouse module","description":"The Clickhouse module pushes message-related metadata to ClickHouse, an open-source column-oriented database management system optimized for real-time analytics. Collected data includes sender/recipient information, scores, and metadata such as DKIM/DMARC/SPF/Bayes/Fuzzy status, URLs, and attachments.","source":"@site/docs/modules/clickhouse.md","sourceDirName":"modules","slug":"/modules/clickhouse","permalink":"/docs.rspamd.com/branches/master/ru/modules/clickhouse","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/clickhouse.md","tags":[],"version":"current","frontMatter":{"title":"Clickhouse module"},"sidebar":"docs","previous":{"title":"Chartable module","permalink":"/docs.rspamd.com/branches/master/ru/modules/chartable"},"next":{"title":"DCC module","permalink":"/docs.rspamd.com/branches/master/ru/modules/dcc"}}');var d=s(4848),i=s(8453);const r={title:"Clickhouse module"},l="Clickhouse module",c={},a=[{value:"Configuration",id:"configuration",level:2},{value:"Basic configuration",id:"basic-configuration",level:3},{value:"Data collection limits",id:"data-collection-limits",level:3},{value:"IP masking",id:"ip-masking",level:3},{value:"Content options",id:"content-options",level:3},{value:"Subject storage",id:"subject-storage",level:3},{value:"Symbol mapping",id:"symbol-mapping",level:3},{value:"Filtering",id:"filtering",level:3},{value:"Retention policy",id:"retention-policy",level:3},{value:"Extra columns",id:"extra-columns",level:3},{value:"Schema additions",id:"schema-additions",level:3},{value:"Custom rules",id:"custom-rules",level:3},{value:"Dynamic extra tables API",id:"dynamic-extra-tables-api",level:2},{value:"API functions",id:"api-functions",level:3},{value:"Features",id:"features",level:3},{value:"Example usage",id:"example-usage",level:3},{value:"Registration options",id:"registration-options",level:3},{value:"Database schema",id:"database-schema",level:2},{value:"Query examples",id:"query-examples",level:2},{value:"Top spam sender domains",id:"top-spam-sender-domains",level:3},{value:"Failed DKIM by domain and IP",id:"failed-dkim-by-domain-and-ip",level:3},{value:"Top attachment types in spam",id:"top-attachment-types-in-spam",level:3},{value:"Mailing list statistics",id:"mailing-list-statistics",level:3},{value:"URL flags",id:"url-flags",level:2},{value:"Filter out image and PDF URLs",id:"filter-out-image-and-pdf-urls",level:3},{value:"Select only image URLs",id:"select-only-image-urls",level:3}];function o(n){const e={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(e.header,{children:(0,d.jsx)(e.h1,{id:"clickhouse-module",children:"Clickhouse module"})}),"\n",(0,d.jsxs)(e.p,{children:["The Clickhouse module pushes message-related metadata to ",(0,d.jsx)(e.a,{href:"https://clickhouse.com/",children:"ClickHouse"}),", an open-source column-oriented database management system optimized for real-time analytics. Collected data includes sender/recipient information, scores, and metadata such as DKIM/DMARC/SPF/Bayes/Fuzzy status, URLs, and attachments."]}),"\n",(0,d.jsxs)(e.p,{children:["This module enables you to build analytical dashboards using tools like ",(0,d.jsx)(e.a,{href:"https://redash.io",children:"Redash"})," or ",(0,d.jsx)(e.a,{href:"https://grafana.com/",children:"Grafana"}),"."]}),"\n",(0,d.jsx)(e.h2,{id:"configuration",children:"Configuration"}),"\n",(0,d.jsxs)(e.p,{children:["Settings go in ",(0,d.jsx)(e.code,{children:"/etc/rspamd/local.d/clickhouse.conf"}),"."]}),"\n",(0,d.jsx)(e.h3,{id:"basic-configuration",children:"Basic configuration"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\n# ClickHouse server address (required)\nserver = "localhost:8123";\n\n# Connection timeout in seconds\ntimeout = 5;\n\n# Periodic check timeout\ncheck_timeout = 10.0;\n\n# Database name\ndatabase = "default";\n\n# Authentication (optional)\n# user = "default";\n# password = "secret";\n\n# Use HTTPS\nuse_https = false;\n\n# Disable SSL certificate verification\nno_ssl_verify = false;\n\n# Enable gzip compression for data transfer (enabled by default)\nuse_gzip = true;\n'})}),"\n",(0,d.jsx)(e.h3,{id:"data-collection-limits",children:"Data collection limits"}),"\n",(0,d.jsx)(e.p,{children:"Controls when accumulated data is sent to ClickHouse:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:"# local.d/clickhouse.conf\n\nlimits {\n  # Send when this many rows accumulated (0 to disable)\n  max_rows = 1000;\n  \n  # Send when memory usage exceeds this limit\n  max_memory = 50mb;\n  \n  # Maximum time between sends\n  max_interval = 60s;\n}\n\n# Perform garbage collection after sending data\ncollect_garbage = false;\n"})}),"\n",(0,d.jsxs)(e.p,{children:[(0,d.jsx)(e.strong,{children:"Note:"})," The legacy ",(0,d.jsx)(e.code,{children:"limit"})," option is deprecated; use ",(0,d.jsx)(e.code,{children:"limits.max_rows"})," instead."]}),"\n",(0,d.jsx)(e.h3,{id:"ip-masking",children:"IP masking"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:"# local.d/clickhouse.conf\n\n# Bits to mask for IPv4 addresses (default: 19)\nipmask = 19;\n\n# Bits to mask for IPv6 addresses (default: 48)\nipmask6 = 48;\n"})}),"\n",(0,d.jsx)(e.h3,{id:"content-options",children:"Content options"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:"# local.d/clickhouse.conf\n\n# Store full URL paths (default: false, stores only hosts)\nfull_urls = false;\n\n# Store message digest/hash\nenable_digest = false;\n\n# Store symbols data (Names, Scores, Options, Groups)\nenable_symbols = false;\n\n# Store data for local/controller scans\nallow_local = false;\n"})}),"\n",(0,d.jsx)(e.h3,{id:"subject-storage",children:"Subject storage"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\n# Store email subject (default: false)\ninsert_subject = false;\n\n# Obfuscate subject with hash\nsubject_privacy = false;\n\n# Hash algorithm for obfuscation\nsubject_privacy_alg = "blake2";\n\n# Prefix for obfuscated subjects\nsubject_privacy_prefix = "obf";\n\n# Length of hash to use\nsubject_privacy_length = 16;\n'})}),"\n",(0,d.jsx)(e.h3,{id:"symbol-mapping",children:"Symbol mapping"}),"\n",(0,d.jsx)(e.p,{children:"Configure which symbols map to the Is* columns:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\n# Bayes classification\nbayes_spam_symbols = ["BAYES_SPAM"];\nbayes_ham_symbols = ["BAYES_HAM"];\n\n# Neural network classification\nann_symbols_spam = ["NEURAL_SPAM"];\nann_symbols_ham = ["NEURAL_HAM"];\n\n# Fuzzy check\nfuzzy_symbols = ["FUZZY_DENIED"];\n\n# Whitelist (affects IsWhitelist column)\nwhitelist_symbols = ["WHITELIST_DKIM", "WHITELIST_SPF_DKIM", "WHITELIST_DMARC"];\n\n# DKIM status\ndkim_allow_symbols = ["R_DKIM_ALLOW"];\ndkim_reject_symbols = ["R_DKIM_REJECT"];\ndkim_dnsfail_symbols = ["R_DKIM_TEMPFAIL", "R_DKIM_PERMFAIL"];\ndkim_na_symbols = ["R_DKIM_NA"];\n\n# DMARC status\ndmarc_allow_symbols = ["DMARC_POLICY_ALLOW"];\ndmarc_reject_symbols = ["DMARC_POLICY_REJECT"];\ndmarc_quarantine_symbols = ["DMARC_POLICY_QUARANTINE"];\ndmarc_softfail_symbols = ["DMARC_POLICY_SOFTFAIL"];\ndmarc_na_symbols = ["DMARC_NA"];\n\n# SPF status\nspf_allow_symbols = ["R_SPF_ALLOW"];\nspf_reject_symbols = ["R_SPF_FAIL"];\nspf_dnsfail_symbols = ["R_SPF_DNSFAIL", "R_SPF_PERMFAIL"];\nspf_neutral_symbols = ["R_SPF_NEUTRAL", "R_SPF_SOFTFAIL"];\nspf_na_symbols = ["R_SPF_NA"];\n'})}),"\n",(0,d.jsx)(e.h3,{id:"filtering",children:"Filtering"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\n# Symbols that prevent ClickHouse logging when present\nstop_symbols = [];\n\n# Map expressions to skip certain messages\n# exceptions = {\n#   symbol_options = {\n#     selector = "check_symbol_options";\n#     map = "/etc/rspamd/clickhouse_exceptions.map";\n#   };\n# };\n'})}),"\n",(0,d.jsx)(e.h3,{id:"retention-policy",children:"Retention policy"}),"\n",(0,d.jsx)(e.p,{children:"Automatic cleanup of old data for GDPR compliance:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\nretention {\n  # Enable retention (default: false)\n  enable = true;\n  \n  # Method: "drop" or "detach"\n  # See: https://clickhouse.com/docs/en/sql-reference/statements/alter/partition\n  method = "drop";\n  \n  # Keep data for this many months\n  period_months = 3;\n  \n  # How often to run cleanup\n  run_every = 7d;\n}\n'})}),"\n",(0,d.jsx)(e.h3,{id:"extra-columns",children:"Extra columns"}),"\n",(0,d.jsx)(e.p,{children:"Add custom columns using selectors (Rspamd 2.4+, ClickHouse 19.3+):"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\nextra_columns = {\n  Mime_From = {\n    selector = "from(\'mime\'):addr";\n    type = "String";\n    default_value = "";\n    comment = "MIME From address";\n  };\n  Mime_Rcpt = {\n    selector = "rcpts(\'mime\'):addr";\n    type = "Array(String)";\n  };\n};\n'})}),"\n",(0,d.jsx)(e.p,{children:"Or as an array for strict ordering:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'extra_columns = [\n  {\n    name = "Mime_From";\n    selector = "from(\'mime\'):addr";\n    type = "String";\n  },\n  {\n    name = "Mime_Rcpt";\n    selector = "rcpts(\'mime\'):addr";\n    type = "Array(String)";\n  }\n];\n'})}),"\n",(0,d.jsx)(e.h3,{id:"schema-additions",children:"Schema additions"}),"\n",(0,d.jsx)(e.p,{children:"Add custom SQL statements executed during schema setup:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\nschema_additions = [\n  "CREATE TABLE IF NOT EXISTS rspamd_custom (...) ENGINE = MergeTree() ...",\n];\n'})}),"\n",(0,d.jsx)(e.h3,{id:"custom-rules",children:"Custom rules"}),"\n",(0,d.jsx)(e.p,{children:"Define custom tables with their own schemas:"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\ncustom_rules {\n  my_rule {\n    schema = "CREATE TABLE IF NOT EXISTS my_table ...";\n    first_row = "return function() return \'INSERT INTO my_table ...\' end";\n    get_row = "return function(task) return {...} end";\n  };\n};\n'})}),"\n",(0,d.jsx)(e.h2,{id:"dynamic-extra-tables-api",children:"Dynamic extra tables API"}),"\n",(0,d.jsx)(e.p,{children:(0,d.jsx)(e.em,{children:"Available since version 3.14.3"})}),"\n",(0,d.jsx)(e.p,{children:"The Clickhouse module exposes a Lua API that allows other plugins to register custom tables at runtime. This enables plugins to store their own data in ClickHouse without modifying the core clickhouse configuration."}),"\n",(0,d.jsx)(e.h3,{id:"api-functions",children:"API functions"}),"\n",(0,d.jsxs)(e.p,{children:["Access via ",(0,d.jsx)(e.code,{children:"rspamd_plugins['clickhouse']"}),":"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"Function"}),(0,d.jsx)(e.th,{children:"Description"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"register_extra_table(opts)"})}),(0,d.jsx)(e.td,{children:"Register a new table with schema, insert query, and row callback"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"unregister_extra_table(name)"})}),(0,d.jsx)(e.td,{children:"Remove a registered table"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"get_extra_tables()"})}),(0,d.jsx)(e.td,{children:"List all registered tables"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"is_enabled()"})}),(0,d.jsx)(e.td,{children:"Check if clickhouse plugin is active"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"features",children:"Features"}),"\n",(0,d.jsxs)(e.ul,{children:["\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.strong,{children:"Lazy schema upload"}),": Table schema is created on first data flush, not at registration time"]}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.strong,{children:"Multi-row support"}),": ",(0,d.jsx)(e.code,{children:"get_row"})," callback can return a single row ",(0,d.jsx)(e.code,{children:"{...}"})," or an array of rows ",(0,d.jsx)(e.code,{children:"{{...}, {...}}"})]}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.strong,{children:"Per-table retention"}),": Each registered table can have independent retention period and method (drop/detach)"]}),"\n",(0,d.jsxs)(e.li,{children:[(0,d.jsx)(e.strong,{children:"Error resilience"}),": Callbacks are wrapped in pcall; errors are logged but don't affect other tables"]}),"\n"]}),"\n",(0,d.jsx)(e.h3,{id:"example-usage",children:"Example usage"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-lua",children:"rspamd_config:add_on_load(function(cfg, ev_base, worker)\n  if worker:is_scanner() and rspamd_plugins['clickhouse'] and \n     rspamd_plugins['clickhouse'].is_enabled() then\n    rspamd_plugins['clickhouse'].register_extra_table({\n      name = 'my_plugin_stats',\n      table_name = 'rspamd_my_plugin',\n      schema = [[CREATE TABLE IF NOT EXISTS rspamd_my_plugin (\n        Date Date, TS DateTime, MessageId String, CustomData String\n      ) ENGINE = MergeTree() PARTITION BY toMonday(Date) ORDER BY TS]],\n      insert_query = function() \n        return 'INSERT INTO rspamd_my_plugin (Date, TS, MessageId, CustomData)' \n      end,\n      get_row = function(task)\n        local ts = task:get_date({format = 'connect', gmt = true})\n        return { os.date('!%Y-%m-%d', ts), ts, task:get_message_id() or '', 'data' }\n      end,\n      retention = { enable = true, period_months = 3, method = 'detach' }\n    })\n  end\nend)\n"})}),"\n",(0,d.jsx)(e.h3,{id:"registration-options",children:"Registration options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"Option"}),(0,d.jsx)(e.th,{children:"Type"}),(0,d.jsx)(e.th,{children:"Description"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"name"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Unique identifier for the registration"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"table_name"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"ClickHouse table name"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"schema"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"CREATE TABLE statement"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"insert_query"})}),(0,d.jsx)(e.td,{children:"Function"}),(0,d.jsx)(e.td,{children:"Returns INSERT statement string"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"get_row"})}),(0,d.jsx)(e.td,{children:"Function"}),(0,d.jsx)(e.td,{children:"Returns row data for a task (single row or array)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"retention"})}),(0,d.jsx)(e.td,{children:"Table"}),(0,d.jsxs)(e.td,{children:["Optional retention settings: ",(0,d.jsx)(e.code,{children:"enable"}),", ",(0,d.jsx)(e.code,{children:"period_months"}),", ",(0,d.jsx)(e.code,{children:"method"})]})]})]})]}),"\n",(0,d.jsx)(e.h2,{id:"database-schema",children:"Database schema"}),"\n",(0,d.jsxs)(e.p,{children:["The module creates a ",(0,d.jsx)(e.code,{children:"rspamd"})," table with the following columns:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"Column"}),(0,d.jsx)(e.th,{children:"Type"}),(0,d.jsx)(e.th,{children:"Description"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Date"})}),(0,d.jsx)(e.td,{children:"Date"}),(0,d.jsx)(e.td,{children:"Date (used for partitioning)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"TS"})}),(0,d.jsx)(e.td,{children:"DateTime"}),(0,d.jsx)(e.td,{children:"Timestamp (UTC)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"From"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Envelope sender domain"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"MimeFrom"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"MIME From domain"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IP"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Sender IP (masked)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Helo"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"SMTP HELO hostname"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Score"})}),(0,d.jsx)(e.td,{children:"Float32"}),(0,d.jsx)(e.td,{children:"Message score"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"NRcpt"})}),(0,d.jsx)(e.td,{children:"UInt8"}),(0,d.jsx)(e.td,{children:"Number of recipients"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Size"})}),(0,d.jsx)(e.td,{children:"UInt32"}),(0,d.jsx)(e.td,{children:"Message size (bytes)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsWhitelist"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"Whitelist status"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsBayes"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"Bayes classification"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsFuzzy"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"Fuzzy check result"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsFann"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"Neural network result"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsDkim"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"DKIM status"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsDmarc"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"DMARC status"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"IsSpf"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"SPF status"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"NUrls"})}),(0,d.jsx)(e.td,{children:"Int32"}),(0,d.jsx)(e.td,{children:"Number of URLs"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Action"})}),(0,d.jsx)(e.td,{children:"Enum8"}),(0,d.jsx)(e.td,{children:"Rspamd action"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"CustomAction"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Custom action name"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"SMTPRecipients"})}),(0,d.jsx)(e.td,{children:"Array(String)"}),(0,d.jsx)(e.td,{children:"Envelope recipients"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"MimeRecipients"})}),(0,d.jsx)(e.td,{children:"Array(String)"}),(0,d.jsx)(e.td,{children:"MIME recipients"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"MessageId"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Message-ID"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"ListId"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"List-Id header"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Subject"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Subject (if enabled)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Attachments.*"})}),(0,d.jsx)(e.td,{children:"Arrays"}),(0,d.jsx)(e.td,{children:"Attachment info"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Urls.*"})}),(0,d.jsx)(e.td,{children:"Arrays"}),(0,d.jsx)(e.td,{children:"URL info"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Emails"})}),(0,d.jsx)(e.td,{children:"Array(String)"}),(0,d.jsx)(e.td,{children:"Extracted emails"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"ASN"})}),(0,d.jsx)(e.td,{children:"UInt32"}),(0,d.jsx)(e.td,{children:"AS number"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Country"})}),(0,d.jsx)(e.td,{children:"FixedString(2)"}),(0,d.jsx)(e.td,{children:"Country code"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Symbols.*"})}),(0,d.jsx)(e.td,{children:"Arrays"}),(0,d.jsx)(e.td,{children:"Symbol info (if enabled)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"Groups.*"})}),(0,d.jsx)(e.td,{children:"Arrays"}),(0,d.jsx)(e.td,{children:"Group scores (if enabled)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"ScanTimeReal"})}),(0,d.jsx)(e.td,{children:"UInt32"}),(0,d.jsx)(e.td,{children:"Scan time (ms)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"AuthUser"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Authenticated user"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:(0,d.jsx)(e.code,{children:"SettingsId"})}),(0,d.jsx)(e.td,{children:"String"}),(0,d.jsx)(e.td,{children:"Settings profile"})]})]})]}),"\n",(0,d.jsx)(e.h2,{id:"query-examples",children:"Query examples"}),"\n",(0,d.jsx)(e.h3,{id:"top-spam-sender-domains",children:"Top spam sender domains"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT From, count() AS c\nFROM rspamd\nWHERE Date = today() \n  AND Action IN ('reject', 'add header')\nGROUP BY From\nORDER BY c DESC\nLIMIT 10\n"})}),"\n",(0,d.jsx)(e.h3,{id:"failed-dkim-by-domain-and-ip",children:"Failed DKIM by domain and IP"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT From, IP, count() AS c\nFROM rspamd\nWHERE Date = today() AND IsDkim = 'reject'\nGROUP BY From, IP\nORDER BY c DESC\nLIMIT 10\n"})}),"\n",(0,d.jsx)(e.h3,{id:"top-attachment-types-in-spam",children:"Top attachment types in spam"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT count() AS c, d\nFROM rspamd\nARRAY JOIN Attachments.ContentType AS d\nWHERE Date = today() \n  AND Action IN ('reject', 'add header')\nGROUP BY d\nORDER BY c DESC\nLIMIT 5\n"})}),"\n",(0,d.jsx)(e.h3,{id:"mailing-list-statistics",children:"Mailing list statistics"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT ListId, IP, count() AS c\nFROM rspamd\nWHERE Date = today() AND ListId != ''\nGROUP BY ListId, IP\nORDER BY c DESC\nLIMIT 10\n"})}),"\n",(0,d.jsx)(e.h2,{id:"url-flags",children:"URL flags"}),"\n",(0,d.jsx)(e.p,{children:"Since version 2.8, URLs are stored with flags indicating their source. Use bit operations to filter:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"Bit"}),(0,d.jsx)(e.th,{children:"Flag"}),(0,d.jsx)(e.th,{children:"Description"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"0"}),(0,d.jsx)(e.td,{children:"PHISHED"}),(0,d.jsx)(e.td,{children:"URL is phished"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"1"}),(0,d.jsx)(e.td,{children:"NUMERIC"}),(0,d.jsx)(e.td,{children:"URL has numeric IP"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"4"}),(0,d.jsx)(e.td,{children:"HTML_DISPLAYED"}),(0,d.jsx)(e.td,{children:"From HTML display text"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"5"}),(0,d.jsx)(e.td,{children:"TEXT"}),(0,d.jsx)(e.td,{children:"From text part"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"6"}),(0,d.jsx)(e.td,{children:"SUBJECT"}),(0,d.jsx)(e.td,{children:"From subject"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"13"}),(0,d.jsx)(e.td,{children:"HAS_PORT"}),(0,d.jsx)(e.td,{children:"URL has explicit port"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"15"}),(0,d.jsx)(e.td,{children:"NO_SCHEMA"}),(0,d.jsx)(e.td,{children:"URL had no schema"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"18"}),(0,d.jsx)(e.td,{children:"DISPLAY_URL"}),(0,d.jsx)(e.td,{children:"Display URL"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"19"}),(0,d.jsx)(e.td,{children:"IMAGE"}),(0,d.jsx)(e.td,{children:"From img src"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"20"}),(0,d.jsx)(e.td,{children:"QUERY"}),(0,d.jsx)(e.td,{children:"Extracted from query string"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"21"}),(0,d.jsx)(e.td,{children:"CONTENT"}),(0,d.jsx)(e.td,{children:"From content (PDF)"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"22"}),(0,d.jsx)(e.td,{children:"NO_TLD"}),(0,d.jsx)(e.td,{children:"URL has no TLD"})]})]})]}),"\n",(0,d.jsx)(e.h3,{id:"filter-out-image-and-pdf-urls",children:"Filter out image and PDF URLs"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT\n  MessageId,\n  arrayMap(x -> x.1, \n    arrayFilter(x -> NOT bitTestAny(x.2, 19, 21), \n      arrayZip(Urls.Url, Urls.Flags))) AS regular_urls\nFROM rspamd\nWHERE Date = today()\n"})}),"\n",(0,d.jsx)(e.h3,{id:"select-only-image-urls",children:"Select only image URLs"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-sql",children:"SELECT Urls.Url\nFROM rspamd\nARRAY JOIN Urls\nWHERE Date = today() AND bitTest(Urls.Flags, 19)\n"})})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,d.jsx)(e,{...n,children:(0,d.jsx)(o,{...n})}):o(n)}},8453(n,e,s){s.d(e,{R:()=>r,x:()=>l});var t=s(6540);const d={},i=t.createContext(d);function r(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(d):n.components||d:r(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);