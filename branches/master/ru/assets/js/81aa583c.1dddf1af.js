"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[2561],{2848:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tutorials/integration","title":"MTA integration","description":"Rspamd provides flexible integration options with mail transfer agents (MTAs) through two primary methods: HTTP-based integration and Milter protocol integration. Each method has its advantages and is suitable for different deployment scenarios.","source":"@site/docs/tutorials/integration.md","sourceDirName":"tutorials","slug":"/tutorials/integration","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/integration","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/integration.md","tags":[],"version":"current","frontMatter":{"title":"MTA integration"},"sidebar":"docs","previous":{"title":"Setup stunnel to protect Redis","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/stunnel_setup"},"next":{"title":"Getting feedback from users with IMAPSieve","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/feedback_from_users_with_IMAPSieve"}}');var s=t(4848),r=t(8453);const a={title:"MTA integration"},o="MTA integration",d={},l=[{value:"Integration Methods Overview",id:"integration-methods-overview",level:2},{value:"HTTP-based Integration (Recommended)",id:"http-based-integration-recommended",level:3},{value:"Milter Protocol Integration",id:"milter-protocol-integration",level:3},{value:"Integration Architecture Diagrams",id:"integration-architecture-diagrams",level:2},{value:"HTTP-based Integration with HTTPS Security",id:"http-based-integration-with-https-security",level:3},{value:"Milter Protocol Integration",id:"milter-protocol-integration-1",level:3},{value:"Supported MTAs and Integration Methods",id:"supported-mtas-and-integration-methods",level:2},{value:"Using Rspamd with Postfix MTA",id:"using-rspamd-with-postfix-mta",level:2},{value:"Configuring Postfix",id:"configuring-postfix",level:3},{value:"Integration with exim MTA",id:"integration-with-exim-mta",level:2},{value:"Using Rspamd with Sendmail MTA",id:"using-rspamd-with-sendmail-mta",level:2},{value:"Integration with Haraka MTA",id:"integration-with-haraka-mta",level:2},{value:"Integration with EmailSuccess MTA",id:"integration-with-emailsuccess-mta",level:2},{value:"LDA mode",id:"lda-mode",level:2},{value:"Integration with Apache James",id:"integration-with-apache-james",level:2},{value:"Integration with Stalwart Mail Server",id:"integration-with-stalwart-mail-server",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"mta-integration",children:"MTA integration"})}),"\n",(0,s.jsxs)(n.p,{children:["Rspamd provides flexible integration options with mail transfer agents (MTAs) through two primary methods: ",(0,s.jsx)(n.strong,{children:"HTTP-based integration"})," and ",(0,s.jsx)(n.strong,{children:"Milter protocol integration"}),". Each method has its advantages and is suitable for different deployment scenarios."]}),"\n",(0,s.jsx)(n.h2,{id:"integration-methods-overview",children:"Integration Methods Overview"}),"\n",(0,s.jsx)(n.h3,{id:"http-based-integration-recommended",children:"HTTP-based Integration (Recommended)"}),"\n",(0,s.jsxs)(n.p,{children:["HTTP integration is the ",(0,s.jsx)(n.strong,{children:"preferred method"})," when supported by your MTA, offering several advantages:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enhanced Security"}),": Traffic can be secured using HTTPS through reverse proxies like nginx"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Encrypted Communication"}),": HTTPCrypt protocol support via libraries like the ",(0,s.jsx)(n.a,{href:"https://github.com/rspamd/rspamdclient-rs",children:"rspamdclient Rust library"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Scalability"}),": Better load balancing and horizontal scaling capabilities"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Network Flexibility"}),": Can work across different network segments and remote servers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Protocol Simplicity"}),": Standard HTTP/HTTPS protocols with JSON payloads"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"milter-protocol-integration",children:"Milter Protocol Integration"}),"\n",(0,s.jsx)(n.p,{children:"Milter integration is widely supported by traditional MTAs and offers:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Broad Compatibility"}),": Supported by Postfix, Sendmail, and other milter-compatible MTAs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Direct Integration"}),": Native integration without requiring HTTP libraries"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Real-time Processing"}),": Stream-based processing during SMTP session"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Legacy Support"}),": Works with older MTA configurations"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"integration-architecture-diagrams",children:"Integration Architecture Diagrams"}),"\n",(0,s.jsx)(n.h3,{id:"http-based-integration-with-https-security",children:"HTTP-based Integration with HTTPS Security"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    subgraph "Email Infrastructure"\n        MTA[Mail Transfer Agent]\n    end\n    \n    subgraph "Security Layer"\n        nginx[nginx Reverse Proxy]\n        tls{TLS Encryption}\n    end\n    \n    subgraph "Rspamd Core"\n        rspamd[Rspamd Endpoint]\n        redis[(Redis database)]\n    end\n    \n    subgraph "Alternative: HTTPCrypt"\n        client[rspamdclient Library]\n        crypt{HTTPCrypt}\n        rspamd2[Rspamd Endpoint]\n    end\n    \n    MTA --\x3e nginx\n    nginx --\x3e tls\n    tls --\x3e rspamd\n    rspamd --\x3e redis\n    \n    MTA -.-> client\n    client --\x3e crypt\n    crypt --\x3e rspamd2\n    rspamd2 --\x3e redis'}),"\n",(0,s.jsx)(n.h3,{id:"milter-protocol-integration-1",children:"Milter Protocol Integration"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    subgraph "Mail Infrastructure"\n        postfix[Postfix MTA]\n        sendmail[Sendmail MTA]\n    end\n    \n    subgraph "Rspamd Milter Layer"\n        proxy[Rspamd Proxy Worker]\n        milter{Milter Protocol}\n    end\n    \n    subgraph "Processing Core"\n        scanner[Scanner Worker]\n        modules[Analysis Modules]\n        redis[(Redis Database)]\n    end\n    \n    subgraph "Response"\n        actions[Actions]\n        response[SMTP Response]\n    end\n    \n    postfix --\x3e proxy\n    sendmail --\x3e proxy\n    proxy --\x3e milter\n    milter --\x3e scanner\n    scanner --\x3e modules\n    modules --\x3e redis\n    scanner --\x3e actions\n    actions --\x3e response\n    response --\x3e proxy'}),"\n",(0,s.jsx)(n.h2,{id:"supported-mtas-and-integration-methods",children:"Supported MTAs and Integration Methods"}),"\n",(0,s.jsx)(n.p,{children:"The table below shows integration options available for different MTAs:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"MTA"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"HTTP Integration"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"Milter Integration"}),(0,s.jsx)(n.th,{children:"License"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#integration-with-apache-james",children:"Apache James"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"Apache 2.0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Axigen"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{children:"Proprietary"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Communigate Pro"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"Proprietary"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#integration-with-emailsuccess-mta",children:"EmailSuccess"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"Proprietary"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#integration-with-exim-mta",children:(0,s.jsx)(n.strong,{children:"Exim"})})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"GPL v2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#integration-with-haraka-mta",children:"Haraka"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"MIT"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://maddy.email/reference/checks/rspamd",children:"Maddy"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"GPL v3"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://github.com/poolpOrg/filter-rspamd",children:"OpenSMTPD"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"ISC, BSD"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#using-rspamd-with-postfix-mta",children:(0,s.jsx)(n.strong,{children:"Postfix"})})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{children:"IBM Public License"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#using-rspamd-with-sendmail-mta",children:"Sendmail"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{children:"Sendmail License"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SmarterMail"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{children:"Proprietary"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"tutorials/integration#integration-with-stalwart-mail-server",children:"Stalwart Mail"})}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u274c"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u2705"}),(0,s.jsx)(n.td,{children:"AGPL v3 or Commercial"})]})]})]}),"\n",(0,s.jsxs)(n.admonition,{title:"Security Recommendation",type:"tip",children:[(0,s.jsx)(n.p,{children:"When using HTTP integration, always implement HTTPS encryption using either:"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"nginx reverse proxy"})," with TLS certificates"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"HTTPCrypt protocol"})," for end-to-end encryption"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"VPN or private networks"})," for additional network security"]}),"\n"]})]}),"\n",(0,s.jsxs)(n.p,{children:["In addition to the primary integration methods, ",(0,s.jsx)(n.a,{href:"tutorials/integration#lda-mode",children:"LDA mode"})," provides a versatile solution that can be employed by virtually any MTA for message processing."]}),"\n",(0,s.jsx)(n.h2,{id:"using-rspamd-with-postfix-mta",children:"Using Rspamd with Postfix MTA"}),"\n",(0,s.jsxs)(n.p,{children:["Starting with version 1.6, for integrating Rspamd with Postfix, it is recommended to utilize the Rspamd proxy worker in Milter mode, as described in ",(0,s.jsx)(n.a,{href:"workers/rspamd_proxy",children:"rspamd proxy worker"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"configuring-postfix",children:"Configuring Postfix"}),"\n",(0,s.jsx)(n.p,{children:"Configuring Postfix to scan messages using the milter protocol with the Rspamd daemon is straightforward:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"#smtpd_milters = unix:/var/lib/rspamd/milter.sock\n# or for TCP socket\nsmtpd_milters = inet:localhost:11332\n\n# skip mail without checks if something goes wrong\nmilter_default_action = accept\n\n# 6 is the default milter protocol version;\n# prior to Postfix 2.6 the default protocol was 2.\n# milter_protocol = 6\n"})}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-exim-mta",children:"Integration with exim MTA"}),"\n",(0,s.jsx)(n.p,{children:"Starting with version 4.86, Exim can integrate with Rspamd in a similar fashion as SpamAssassin. The diagram below illustrates the interaction between Exim and Rspamd:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"exim scheme",src:t(6190).A+"",title:"Rspamd and Exim interaction",width:"527",height:"294"})}),"\n",(0,s.jsxs)(n.p,{children:["For versions 4.70 through 4.84, integration can be enabled by applying a patch. In the Exim source directory, run the command: ",(0,s.jsx)(n.code,{children:"patch -p1 < ../rspamd/contrib/exim/patch-exim-src_spam.c.diff"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For version 4.85, the following command should be run from the ",(0,s.jsx)(n.code,{children:"contrib/exim"})," directory in the Rspamd source directory:\n",(0,s.jsx)(n.code,{children:"patch patch-exim-src_spam.c.diff < patch-exim-src_spam.c.diff.exim-4.85.diff"}),"\nThen, follow the steps above to apply the patch."]}),"\n",(0,s.jsxs)(n.p,{children:["For versions 4.86 and 4.87, it is advisable to apply a patch to disable half-closed sockets. Run the command:\n",(0,s.jsx)(n.code,{children:"patch -p1 < ../rspamd/contrib/exim/shutdown.patch"})]}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can set ",(0,s.jsx)(n.code,{children:"enable_shutdown_workaround = true"})," in ",(0,s.jsx)(n.code,{children:"$LOCAL_CONFDIR/local.d/options.inc"})]}),"\n",(0,s.jsx)(n.p,{children:"Here is an example of the Exim configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:'# This is the global (top) section of the configuration file\n# Please note the variant parameter in spamd_address setting\nspamd_address = 127.0.0.1 11333 variant=rspamd\n\nacl_smtp_data = acl_check_spam\n\nbegin acl\n\nacl_check_spam:\n  # do not scan messages submitted from our own hosts\n  # +relay_from_hosts is assumed to be a list of hosts in configuration\n  accept hosts = +relay_from_hosts\n\n  # skip scanning for authenticated users (if desired?)\n  accept authenticated = *\n\n  # scan the message with rspamd\n  warn spam = nobody:true\n  # This will set variables as follows:\n  # $spam_action is the action recommended by rspamd\n  # $spam_score is the message score (we unlikely need it)\n  # $spam_score_int is spam score multiplied by 10\n  # $spam_report lists symbols matched & protocol messages\n  # $spam_bar is a visual indicator of spam/ham level\n\n  # use greylisting available in rspamd v1.3+\n  defer message    = Please try again later\n        condition  = ${if eq{$spam_action}{soft reject}}\n\n  deny  message    = Message discarded as high-probability spam\n        condition  = ${if eq{$spam_action}{reject}}\n\n  # Remove foreign headers\n  warn remove_header = x-spam-bar : x-spam-score : x-spam-report : x-spam-status\n\n  # add spam-score and spam-report header when "add header" action is recommended by rspamd\n  warn\n    condition  = ${if eq{$spam_action}{add header}}\n    add_header = X-Spam-Score: $spam_score ($spam_bar)\n    add_header = X-Spam-Report: $spam_report\n\n  # add x-spam-status header if message is not ham\n  # do not match when $spam_action is empty (e.g. when rspamd is not running)\n  warn\n    ! condition  = ${if match{$spam_action}{^no action\\$|^greylist\\$|^\\$}}\n    add_header = X-Spam-Status: Yes\n\n  # add x-spam-bar header if score is positive\n  warn\n    condition = ${if >{$spam_score_int}{0}}\n    add_header = X-Spam-Bar: $spam_bar\n\n  accept\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For further information please refer to the ",(0,s.jsx)(n.a,{href:"https://www.exim.org/exim-html-current/doc/html/spec_html/",children:"Exim specification"}),", especially the ",(0,s.jsx)(n.a,{href:"https://www.exim.org/exim-html-current/doc/html/spec_html/ch-content_scanning_at_acl_time.html",children:"chapter about content scanning"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"using-rspamd-with-sendmail-mta",children:"Using Rspamd with Sendmail MTA"}),"\n",(0,s.jsx)(n.p,{children:"Sendmail can also utilize Rspamd through the milter protocol and the configuration process is similar to that of Postfix. An example of the Sendmail configuration is as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"MAIL_FILTER(`rspamd', `S=inet:11332@localhost, F=T')\ndefine(`confINPUT_MAIL_FILTERS', `rspamd')\n"})}),"\n",(0,s.jsx)(n.p,{children:"Once this is done, the standard procedure of compiling m4 to cf should be followed."}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-haraka-mta",children:"Integration with Haraka MTA"}),"\n",(0,s.jsxs)(n.p,{children:["The Haraka email server, version 2.7.0 and above, offers support for Rspamd through the ",(0,s.jsx)(n.a,{href:"https://haraka.github.io/plugins/rspamd/",children:"Haraka Rspamd plugin"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["To activate this feature: run ",(0,s.jsx)(n.code,{children:"npm install haraka-plugin-rspamd"}),", add ",(0,s.jsx)(n.code,{children:"rspamd"})," to the ",(0,s.jsx)(n.code,{children:"DATA"})," section of your ",(0,s.jsx)(n.code,{children:"config/plugins"})," file and create a ",(0,s.jsx)(n.code,{children:"config/rspamd.ini"})," file to suit your needs if needed."]}),"\n",(0,s.jsxs)(n.p,{children:["For more information, see the ",(0,s.jsx)(n.a,{href:"https://haraka.github.io/plugins/rspamd/",children:"Haraka rspamd plugin documentation"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-emailsuccess-mta",children:"Integration with EmailSuccess MTA"}),"\n",(0,s.jsxs)(n.p,{children:["Support for rspamd is available from ",(0,s.jsx)(n.a,{href:"https://www.emailsuccess.com/emailsuccess-introduces-rspamd-integration",children:"EmailSuccess v11.19"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["To enable it, navigate to the administration console and type ",(0,s.jsx)(n.code,{children:"filter-module-set rspamd enabled true"}),". Customize your filtering options using the ",(0,s.jsx)(n.code,{children:"filter-module-show rspamd"})," and ",(0,s.jsx)(n.code,{children:"filter-module-set rspamd"})," commands to suit your preferences."]}),"\n",(0,s.jsxs)(n.p,{children:["Additionally, you will need to enable the filter for each input interface (both SMTP and API) using the ",(0,s.jsx)(n.code,{children:"input-set INPUT1 filter enabled"}),", ",(0,s.jsx)(n.code,{children:"ws-set rest_filter true"})," and ",(0,s.jsx)(n.code,{children:"ws-set soap_filter true"})," commands."]}),"\n",(0,s.jsxs)(n.p,{children:["For further information, refer to the ",(0,s.jsx)(n.a,{href:"https://doc.emailsuccess.com",children:"EmailSuccess documentation"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"lda-mode",children:"LDA mode"}),"\n",(0,s.jsxs)(n.p,{children:["In LDA (Local Delivery Agent) mode, the MTA (Mail Transfer Agent) invokes the Rspamd client, ",(0,s.jsx)(n.code,{children:"rspamc"}),", a message using Rspamd and appends the scan results to the source message. The overall process is illustrated in the following image:"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"lda scheme",src:t(4406).A+"",title:"rspamd as LDA",width:"522",height:"534"})}),"\n",(0,s.jsxs)(n.p,{children:["To enable LDA mode, ",(0,s.jsx)(n.code,{children:"rspamc"})," has the following options available:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:'--exec "/path/to/lda params"'}),": executes the binary specified to deliver modified message"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--mime"}),": modify message instead of printing scan results only"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--json"}),": optionally add the full output as base64 encoded ",(0,s.jsx)(n.code,{children:"JSON"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Here is an example of using ",(0,s.jsx)(n.code,{children:"rspamc"})," + ",(0,s.jsx)(n.code,{children:"dovecot"})," as LDA implemented using ",(0,s.jsx)(n.code,{children:"fetchmail"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'mda "/usr/bin/rspamc --mime --exec \\"/usr/lib/dovecot/deliver -d %T\\""\n'})}),"\n",(0,s.jsxs)(n.p,{children:["In this mode, ",(0,s.jsx)(n.code,{children:"rspamc"})," cannot reject or greylist messages, but it appends the following headers that can be used for further filtering by means of the LDA (for example, ",(0,s.jsx)(n.code,{children:"sieve"})," or ",(0,s.jsx)(n.code,{children:"procmail"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"X-Spam-Scanner"}),": name and version of rspamd"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"X-Spam"}),": has value ",(0,s.jsx)(n.code,{children:"yes"})," if rspamd detects that a message as a spam (either ",(0,s.jsx)(n.code,{children:"reject"})," or ",(0,s.jsx)(n.code,{children:"add header"})," actions)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"X-Spam-Action"}),": the desired action for a message (e.g. ",(0,s.jsx)(n.code,{children:"no action"}),", ",(0,s.jsx)(n.code,{children:"add header"})," or ",(0,s.jsx)(n.code,{children:"reject"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"X-Spam-Result"}),": contains base64 encoded ",(0,s.jsx)(n.code,{children:"JSON"})," reply from rspamd if ",(0,s.jsx)(n.code,{children:"--json"})," option was given to ",(0,s.jsx)(n.code,{children:"rspamc"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"It's important to note that while this method can be used with any MTA (or even without an MTA), it has more overhead than other methods and cannot apply certain actions such as greylisting. However, greylisting could also be implemented using external tools."}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-apache-james",children:"Integration with Apache James"}),"\n",(0,s.jsx)(n.p,{children:"Apache James can integrate Rspamd as an extension by customizing its mailbox listeners and mailet processing."}),"\n",(0,s.jsx)(n.p,{children:"Specifically, James utilizes the HTTP API to communicate with Rspamd, allowing it to query Rspamd during email processing (receiving or sending) and then decide whether to reject or accept the email."}),"\n",(0,s.jsx)(n.p,{children:"Additionally, James can also be used as a feedback source for enriching Rspamd's spam/ham database, through live feedback (via mailbox listener) or through a CRON batch job (by calling web-admin tasks)."}),"\n",(0,s.jsxs)(n.p,{children:["For further information, please refer to the James' extensions for Rspamd documentation on ",(0,s.jsx)(n.a,{href:"https://github.com/apache/james-project/tree/master/third-party/rspamd",children:"GitHub"})]}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-stalwart-mail-server",children:"Integration with Stalwart Mail Server"}),"\n",(0,s.jsxs)(n.p,{children:["Rspamd can easily be integrated with Stalwart Mail Server using the ",(0,s.jsx)(n.code,{children:"milter"})," protocol. In order to enable Milter support in rspamd, follow the instructions in the ",(0,s.jsx)(n.a,{href:"workers/rspamd_proxy",children:"proxy worker"})," chapter."]}),"\n",(0,s.jsxs)(n.p,{children:["After setting up the proxy worker to handle milter requests, configure Stalwart Mail Server to use rspamd via milter by adding the following entries to the ",(0,s.jsx)(n.code,{children:"etc/config.toml"})," configuration file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[session.data.milter."rspamd"]\nenable = [ { if = "listener", eq = "smtp", then = true }, \n           { else = false } ]\nhostname = "127.0.0.1"\nport = 11332\n\n[session.data.milter."rspamd".options]\ntempfail-on-error = true\nmax-response-size = 52428800 # 50mb\nversion = 6\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For more details please refer to the ",(0,s.jsx)(n.a,{href:"https://stalw.art/docs/smtp/filter/milter",children:"milter filters"})," documentation for Stalwart Mail Server."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},4406:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/rspamd_lda-11d906b3ddebe794929ae3eb19f08d22.png"},6190:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/rspamd_exim-9851b80ef0b3872dec72fb36d909ae77.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(6540);const s={},r=i.createContext(s);function a(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);