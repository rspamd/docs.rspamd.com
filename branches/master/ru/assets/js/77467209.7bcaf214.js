"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[3609],{6573(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"tutorials/scanning_outbound","title":"Scanning outbound mail","description":"Why scan outbound mail","source":"@site/docs/tutorials/scanning_outbound.md","sourceDirName":"tutorials","slug":"/tutorials/scanning_outbound","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/scanning_outbound","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/tutorials/scanning_outbound.md","tags":[],"version":"current","frontMatter":{"title":"Scanning outbound mail"},"sidebar":"docs","previous":{"title":"Migrating from SpamAssassin","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/migrate_sa"},"next":{"title":"Usage of fuzzy hashes","permalink":"/docs.rspamd.com/branches/master/ru/tutorials/fuzzy_storage"}}');var t=s(4848),d=s(8453);const r={title:"Scanning outbound mail"},o="Scanning outbound mail",a={},c=[{value:"Why scan outbound mail",id:"why-scan-outbound-mail",level:2},{value:"What Rspamd considers outbound",id:"what-rspamd-considers-outbound",level:2},{value:"Module behaviour for outbound mail",id:"module-behaviour-for-outbound-mail",level:2},{value:"Checks disabled for outbound",id:"checks-disabled-for-outbound",level:3},{value:"Checks with modified behaviour for outbound",id:"checks-with-modified-behaviour-for-outbound",level:3},{value:"Modules unaffected by direction",id:"modules-unaffected-by-direction",level:3},{value:"Using settings to control outbound scanning",id:"using-settings-to-control-outbound-scanning",level:2},{value:"Separating inbound and outbound flows",id:"separating-inbound-and-outbound-flows",level:3},{value:"Using Settings-ID from MTA",id:"using-settings-id-from-mta",level:3},{value:"Rescoring symbols for outbound",id:"rescoring-symbols-for-outbound",level:3},{value:"Limiting checks for authenticated users",id:"limiting-checks-for-authenticated-users",level:3},{value:"MTA configuration",id:"mta-configuration",level:2},{value:"MTA with milter support (e.g. Postfix or Sendmail)",id:"mta-with-milter-support-eg-postfix-or-sendmail",level:3},{value:"Exim",id:"exim",level:3},{value:"Haraka",id:"haraka",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"scanning-outbound-mail",children:"Scanning outbound mail"})}),"\n",(0,t.jsx)(n.h2,{id:"why-scan-outbound-mail",children:"Why scan outbound mail"}),"\n",(0,t.jsx)(n.p,{children:"Sending outbound spam can have severe negative consequences on your system's email delivery capabilities. It is crucial to prevent the occurrence of spam and its associated issues. In the event of an outbreak of outbound spam, it may become necessary to initiate incident response measures, such as changing the passwords of affected accounts. Conducting human analysis to verify the authenticity of the spam may also be beneficial, but it is essential to consider privacy laws and company policies, as this analysis could potentially infringe upon them. To determine the appropriate actions for dealing with suspected outbound spam, it is advisable to seek advice from legal experts and involve relevant stakeholders. Please be aware that this document does not offer specific guidance on handling such emails, although it may be expanded in the future to include illustrative strategies."}),"\n",(0,t.jsx)(n.h2,{id:"what-rspamd-considers-outbound",children:"What Rspamd considers outbound"}),"\n",(0,t.jsxs)(n.p,{children:["Rspamd classifies a message as ",(0,t.jsx)(n.strong,{children:"outbound"})," (or locally originated) when at least one of the following conditions is true:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The message was sent by an ",(0,t.jsx)(n.strong,{children:"authenticated user"})," (i.e. SMTP AUTH was used and the MTA passed the user identity to Rspamd)."]}),"\n",(0,t.jsxs)(n.li,{children:["The message was received from an IP address listed in ",(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.a,{href:"/configuration/options",children:"local_addrs"})})," (by default this includes RFC 1918 private ranges and loopback addresses)."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["These two conditions are checked independently by most modules. Some modules only check one of them (e.g. ",(0,t.jsx)(n.a,{href:"/modules/ratelimit",children:"Ratelimit"})," only tracks authenticated users, not ",(0,t.jsx)(n.code,{children:"local_addrs"}),"). Each module typically exposes ",(0,t.jsx)(n.code,{children:"check_local"})," and ",(0,t.jsx)(n.code,{children:"check_authed"})," options (both default to ",(0,t.jsx)(n.code,{children:"false"}),") so you can override the default behaviour and force checks even for outbound mail."]}),"\n",(0,t.jsx)(n.h2,{id:"module-behaviour-for-outbound-mail",children:"Module behaviour for outbound mail"}),"\n",(0,t.jsxs)(n.p,{children:["With proper ",(0,t.jsx)(n.a,{href:"/tutorials/integration",children:"integration"}),", Rspamd can identify the authenticated user and source IP of a message. The following modules automatically adjust their behaviour for outbound mail:"]}),"\n",(0,t.jsx)(n.h3,{id:"checks-disabled-for-outbound",children:"Checks disabled for outbound"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Module"}),(0,t.jsx)(n.th,{children:"Behaviour"}),(0,t.jsx)(n.th,{children:"Override"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/asn",children:"ASN"})}),(0,t.jsx)(n.td,{children:"Disabled for local IPs"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/dkim",children:"DKIM checking"})}),(0,t.jsx)(n.td,{children:"Verification is disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/dmarc",children:"DMARC"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/greylisting",children:"Greylist"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/mx_check",children:"MX Check"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsx)(n.td,{children:"No override (hardcoded)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/once_received",children:"One Received header policy"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/spf",children:"SPF"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/whitelist",children:"Whitelist"})}),(0,t.jsx)(n.td,{children:"Disabled (DKIM/SPF/DMARC whitelisting is not applied)"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/p0f",children:"p0f"})}),(0,t.jsx)(n.td,{children:"Disabled for local IPs (OS fingerprinting is meaningless)"}),(0,t.jsx)(n.td,{children:"No override"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/spamtrap",children:"Spamtrap"})}),(0,t.jsx)(n.td,{children:"Disabled"}),(0,t.jsxs)(n.td,{children:["Set ",(0,t.jsx)(n.code,{children:"check_local = true"})," or ",(0,t.jsx)(n.code,{children:"check_authed = true"})]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"checks-with-modified-behaviour-for-outbound",children:"Checks with modified behaviour for outbound"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Module"}),(0,t.jsx)(n.th,{children:"Behaviour"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/dkim_signing",children:"DKIM signing"})}),(0,t.jsxs)(n.td,{children:["Signing is ",(0,t.jsx)(n.strong,{children:"enabled"})," when the appropriate key and rule are found"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/arc",children:"ARC signing"})}),(0,t.jsxs)(n.td,{children:["ARC signing is ",(0,t.jsx)(n.strong,{children:"enabled"})," similarly to DKIM signing"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/hfilter",children:"HFilter"})}),(0,t.jsx)(n.td,{children:"Only URL-checks are applied; header and received checks are skipped"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/ratelimit",children:"Ratelimit"})}),(0,t.jsxs)(n.td,{children:["Only the ",(0,t.jsx)(n.code,{children:"user"})," bucket is applied (to authenticated users only; does not use ",(0,t.jsx)(n.code,{children:"local_addrs"}),")"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/rbl",children:"RBL"})}),(0,t.jsxs)(n.td,{children:["Individual RBL rules are disabled according to their ",(0,t.jsx)(n.code,{children:"exclude_users"})," and ",(0,t.jsx)(n.code,{children:"exclude_local"})," settings (URL-based lists are typically checked for all directions)"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/replies",children:"Replies"})}),(0,t.jsxs)(n.td,{children:["Reply tracking works for outbound messages (stores message IDs from authenticated/local senders) but the forced action is ",(0,t.jsx)(n.strong,{children:"not"})," applied to outbound messages"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/milter_headers",children:"Milter Headers"})}),(0,t.jsxs)(n.td,{children:["Headers are ",(0,t.jsx)(n.strong,{children:"not"})," added by default for local or authenticated connections (",(0,t.jsx)(n.code,{children:"skip_local = true"}),", ",(0,t.jsx)(n.code,{children:"skip_authenticated = true"}),"); you can control which headers are still added via ",(0,t.jsx)(n.code,{children:"local_headers"})," and ",(0,t.jsx)(n.code,{children:"authenticated_headers"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"/modules/reputation",children:"Reputation"})}),(0,t.jsxs)(n.td,{children:["Supports separate ",(0,t.jsx)(n.code,{children:"outbound"})," and ",(0,t.jsx)(n.code,{children:"inbound"})," selectors per rule, allowing different reputation tracking for each direction"]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"modules-unaffected-by-direction",children:"Modules unaffected by direction"}),"\n",(0,t.jsxs)(n.p,{children:["Most other modules (e.g. ",(0,t.jsx)(n.a,{href:"/modules/antivirus",children:"Antivirus"}),", ",(0,t.jsx)(n.a,{href:"/modules/fuzzy_check",children:"Fuzzy check"}),", ",(0,t.jsx)(n.a,{href:"/modules/multimap",children:"Multimap"}),", ",(0,t.jsx)(n.a,{href:"/modules/neural",children:"Neural"}),", ",(0,t.jsx)(n.a,{href:"/modules/phishing",children:"Phishing"}),", ",(0,t.jsx)(n.a,{href:"/modules/mime_types",children:"MIME types"}),", ",(0,t.jsx)(n.a,{href:"/modules/external_services",children:"External services"}),") run for all messages regardless of direction. You can use the ",(0,t.jsx)(n.a,{href:"/configuration/settings",children:"Settings module"})," to selectively enable or disable any of these for outbound mail."]}),"\n",(0,t.jsx)(n.h2,{id:"using-settings-to-control-outbound-scanning",children:"Using settings to control outbound scanning"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.a,{href:"/configuration/settings",children:"settings module"})," provides a powerful way to customise Rspamd behaviour per direction. Settings can match on ",(0,t.jsx)(n.code,{children:"authenticated"}),", ",(0,t.jsx)(n.code,{children:"local"}),", ",(0,t.jsx)(n.code,{children:"user"}),", ",(0,t.jsx)(n.code,{children:"ip"}),", and other conditions, then apply custom scores, enable/disable specific symbols or groups, and override actions."]}),"\n",(0,t.jsx)(n.h3,{id:"separating-inbound-and-outbound-flows",children:"Separating inbound and outbound flows"}),"\n",(0,t.jsxs)(n.p,{children:["The simplest approach is to use ",(0,t.jsx)(n.code,{children:"authenticated = yes"})," or ",(0,t.jsx)(n.code,{children:"local = yes"})," matchers:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/settings.conf\n\noutbound {\n  priority = high;\n  authenticated = yes;\n  apply {\n    groups_disabled = ["rbl", "spf", "dmarc"];\n    actions {\n      greylist = null;\n    }\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"using-settings-id-from-mta",children:"Using Settings-ID from MTA"}),"\n",(0,t.jsxs)(n.p,{children:["For more precise control, you can pass a ",(0,t.jsx)(n.code,{children:"Settings-ID"})," header from your MTA to split inbound and outbound flows explicitly. This is the most performant approach since Rspamd can skip condition evaluation entirely:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/settings.conf\n\noutbound_scan {\n  id = "outbound";\n  apply {\n    groups_enabled = ["dkim", "ratelimit", "fuzzy", "neural"];\n    actions {\n      reject = 15.0;\n      "add header" = 6.0;\n    }\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Then in your MTA, set the header for outbound submissions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"# Postfix example (submission service in master.cf)\n-o smtpd_milter_maps=cdb:/etc/postfix/milter_settings\n\n# Or pass it directly\n-o milter_header_checks=pcre:/etc/postfix/milter_header_checks\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Or use ",(0,t.jsx)(n.code,{children:"rspamc"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'rspamc --header="settings-id=outbound" message.eml\n'})}),"\n",(0,t.jsx)(n.h3,{id:"rescoring-symbols-for-outbound",children:"Rescoring symbols for outbound"}),"\n",(0,t.jsx)(n.p,{children:"You can adjust symbol weights specifically for outbound mail:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:"# local.d/settings.conf\n\noutbound_rescoring {\n  priority = high;\n  authenticated = yes;\n  apply {\n    BAYES_SPAM = 8.0;   # Treat Bayes spam more seriously for outbound\n    NEURAL_SPAM = 6.0;\n    actions {\n      reject = 12.0;    # Lower reject threshold for outbound\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"limiting-checks-for-authenticated-users",children:"Limiting checks for authenticated users"}),"\n",(0,t.jsx)(n.p,{children:"To run only specific checks for authenticated users (e.g. only fuzzy, neural, and ratelimit):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/settings.conf\n\nauthenticated_minimal {\n  priority = high;\n  authenticated = yes;\n  apply {\n    groups_enabled = ["fuzzy", "neural", "ratelimit", "antivirus"];\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"mta-configuration",children:"MTA configuration"}),"\n",(0,t.jsx)(n.h3,{id:"mta-with-milter-support-eg-postfix-or-sendmail",children:"MTA with milter support (e.g. Postfix or Sendmail)"}),"\n",(0,t.jsxs)(n.p,{children:["To enable Rspamd to scan emails sent directly via ",(0,t.jsx)(n.code,{children:"sendmail"})," or other local delivery agents, you can include the ",(0,t.jsx)(n.code,{children:"non_smtpd_milters"})," setting in the configuration. This will direct the Rspamd proxy worker to perform the scanning. Here is an example configuration for Postfix MTA:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"# postfix/main.cf\nsmtpd_milters=inet:127.0.0.1:11332 # For inbound scan or outbound scan via SMTP\nnon_smtpd_milters=inet:127.0.0.1:11332 # For invocation via LDA\n"})}),"\n",(0,t.jsx)(n.h3,{id:"exim",children:"Exim"}),"\n",(0,t.jsx)(n.p,{children:"Here is an example configuration suitable for filtering outbound email."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'# Global options\nspamd_address = 127.0.0.1 11333 variant=rspamd\nacl_smtp_data = acl_check_data\n\nbegin acl\n\nacl_check_data:\n  # Set default value for a variable\n  warn\n    set acl_m_outspam = 0\n  # Always scan mail\n  warn\n    spam = nobody:true\n  # Honor "reject" action for inbound mail...\n  deny\n    ! authenticated = *\n    condition = ${if eq{$spam_action}{reject}}\n    message = Discarded high-probability spam\n  # If it\'s our user set acl_m_outspam = 1 instead\n  warn\n    authenticated = *\n    condition = ${if eq{$spam_action}{reject}}\n    set acl_m_outspam = 1\n  accept\n\nbegin routers\n\n# Apply special handling to messages with $acl_m_outspam==1\nredirect_outbound_spam:\n  driver = redirect\n  condition = ${if eq{$acl_m_outspam}{1}}\n  data = admin@example.com\n# <rest of configuration>\n'})}),"\n",(0,t.jsxs)(n.p,{children:["See the ",(0,t.jsx)(n.a,{href:"https://www.exim.org/exim-html-current/doc/html/spec_html/",children:"Exim specification"})," for more information."]}),"\n",(0,t.jsx)(n.h3,{id:"haraka",children:"Haraka"}),"\n",(0,t.jsxs)(n.p,{children:["To enable scanning of outbound mail set the following in ",(0,t.jsx)(n.code,{children:"config/rspamd.ini"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[check]\nauthenticated=true\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If you wish to honor ",(0,t.jsx)(n.code,{children:"reject"})," action for authenticated users set the following:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[reject]\nauthenticated=true\n"})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>r,x:()=>o});var i=s(6540);const t={},d=i.createContext(t);function r(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);