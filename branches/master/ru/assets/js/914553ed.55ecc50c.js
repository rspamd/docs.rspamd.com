"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[9099],{8256:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>c,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"modules/dkim_signing","title":"DKIM signing module","description":"{:.no_toc}","source":"@site/docs/modules/dkim_signing.md","sourceDirName":"modules","slug":"/modules/dkim_signing","permalink":"/docs.rspamd.com/branches/master/ru/modules/dkim_signing","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/dkim_signing.md","tags":[],"version":"current","frontMatter":{"title":"DKIM signing module"},"sidebar":"docs","previous":{"title":"DKIM module","permalink":"/docs.rspamd.com/branches/master/ru/modules/dkim"},"next":{"title":"DMARC module","permalink":"/docs.rspamd.com/branches/master/ru/modules/dmarc"}}');var t=s(4848),r=s(8453);const l={title:"DKIM signing module"},d="DKIM signing module",a={},o=[{value:"Principles of operation",id:"principles-of-operation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"DKIM key management",id:"dkim-key-management",level:2},{value:"Verifying your private keys",id:"verifying-your-private-keys",level:2},{value:"DKIM keys in Redis",id:"dkim-keys-in-redis",level:2},{value:"Using maps",id:"using-maps",level:2},{value:"Use of <code>signing_table</code>",id:"use-of-signing_table",level:2},{value:"HTTP headers based DKIM signing",id:"http-headers-based-dkim-signing",level:2},{value:"DKIM signing using Vault",id:"dkim-signing-using-vault",level:2},{value:"Sign headers",id:"sign-headers",level:2},{value:"Default sign_headers (after 1.9.3)",id:"default-sign_headers-after-193",level:3},{value:"Rules of headers sign",id:"rules-of-headers-sign",level:3},{value:"Issues using Sendmail on DKIM signing and verification",id:"issues-using-sendmail-on-dkim-signing-and-verification",level:2},{value:"Optimize signing only mode",id:"optimize-signing-only-mode",level:2}];function h(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"dkim-signing-module",children:"DKIM signing module"})}),"\n",(0,t.jsx)(n.p,{children:"{:.no_toc}"}),"\n",(0,t.jsxs)(n.p,{children:["The Rspamd 1.5 version has introduced a convenient method of configuring DKIM signing through the addition of the DKIM signing module. A more customizable option is available in the DKIM module through the ",(0,t.jsx)(n.a,{href:"/modules/dkim#dkim-signatures",children:"sign_condition"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["DKIM signing currently works with Milter based MTAs (Sendmail, Postfix), Haraka & Communigate. For DKIM signing to work, you must ",(0,t.jsx)(n.a,{href:"/tutorials/scanning_outbound",children:"scan outbound mail with rspamd"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"principles-of-operation",children:"Principles of operation"}),"\n",(0,t.jsx)(n.p,{children:"The DKIM signing module uses a predefined policy to determine which domains and selectors to use for signing. This policy can be modified with various settings. Here is a description of the default policy:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"In order to be eligible for signing, an email must either be received from an authenticated user, a reserved (local) IP address, or an address in the sign_networks map (if defined)."}),"\n",(0,t.jsx)(n.li,{children:"If the envelope from address is not empty, the effective second-level domain must match the MIME header From."}),"\n",(0,t.jsx)(n.li,{children:"If there is an authenticated user, it should be suffixed with @domain, where domain is what is seen in the envelope/header From address."}),"\n",(0,t.jsx)(n.li,{children:"The selector and path to the key are selected from the domain-specific configuration, if present. If not, the global configuration is used as a fallback."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The default global configuration (fallback mode) searches for keys at the defined path. This path is constructed using the eSLD normalized domain name of the header from and the default selector defined with selector (dkim). For example, the search path for ",(0,t.jsx)(n.a,{href:"mailto:user@test.example.com",children:"user@test.example.com"})," would be /var/lib/rspamd/dkim/example.com.dkim.key. If a key is found, the message will be signed."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Important notice"}),": when using file-based DKIM private keys, ensure that the Rspamd scanner processes (e.g. normal worker, controller, or a proxy in self-scan mode) have at least read access to the signing keys. This requires the keys to be accessible by the user or group ",(0,t.jsx)(n.code,{children:"_rspamd"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/dkim_signing.conf\n\n# If false, messages with empty envelope from are not signed\nallow_envfrom_empty = true;\n\n# If true, envelope/header domain mismatch is ignored\nallow_hdrfrom_mismatch = false;\n\n# If true, multiple from headers are allowed (but only first is used)\nallow_hdrfrom_multiple = false;\n\n# If true, username does not need to contain matching domain\nallow_username_mismatch = false;\n\n# Default path to key, can include \'$domain\' and \'$selector\' variables\npath = "/var/lib/rspamd/dkim/$domain.$selector.key";\n\n# Default selector to use\nselector = "dkim";\n\n# If false, messages from authenticated users are not selected for signing\nsign_authenticated = true;\n\n# If false, messages from local networks are not selected for signing\nsign_local = true;\n\n# Map file of IP addresses/subnets to consider for signing\n# sign_networks = "/some/file"; # or url\n\n# Symbol to add when message is signed\nsymbol = "DKIM_SIGNED";\n\n# Whether to fallback to global config\ntry_fallback = true;\n\n# Domain to use for DKIM signing: can be "header" (MIME From), "envelope" (SMTP From), "recipient" (SMTP To), "auth" (SMTP username) or directly specified domain name\nuse_domain = "header";\n\n# Domain to use for DKIM signing when sender is in sign_networks ("header"/"envelope"/"auth")\n#use_domain_sign_networks = "header";\n\n# Domain to use for DKIM signing when sender is a local IP ("header"/"envelope"/"auth")\n#use_domain_sign_local = "header";\n\n# Whether to normalise domains to eSLD\nuse_esld = true;\n\n# Whether to get keys from Redis\nuse_redis = false;\n\n# Hash for DKIM keys in Redis\nkey_prefix = "DKIM_KEYS";\n\n# map of domains -> names of selectors (since rspamd 1.5.3)\n#selector_map = "/etc/rspamd/dkim_selectors.map";\n\n# map of domains -> paths to keys (since rspamd 1.5.3)\n#path_map = "/etc/rspamd/dkim_paths.map";\n\n# If `true` get pubkey from DNS record and check if it matches private key\ncheck_pubkey = false;\n# Set to `false` if you want to skip signing if public and private keys mismatch\nallow_pubkey_mismatch = true;\n\n\n# Domain specific settings\ndomain {\n\n  # Domain name is used as key\n  example.com {\n\n    # Private key path\n    path = "/var/lib/rspamd/dkim/example.key";\n\n    # Selector\n    selector = "ds";\n\n  }\n\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"To disable DKIM signing (i.e. you use OpenDKIM, or signing is done elsewhere)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:"# local.d/dkim_signing.conf\nenabled = false;\n"})}),"\n",(0,t.jsx)(n.p,{children:"or"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:"# override.d/dkim_signing.conf\nenabled = false;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"dkim-key-management",children:"DKIM key management"}),"\n",(0,t.jsxs)(n.p,{children:["Rspamd always uses ",(0,t.jsx)(n.code,{children:"relaxed/relaxed"})," encoding with the ",(0,t.jsx)(n.code,{children:"rsa-sha256"})," signature algorithm, which is deemed to be the most suitable option for all cases. Upon successful signing, Rspamd adds a unique element, the ",(0,t.jsx)(n.code,{children:"DKIM-Signature"}),", to the output."]}),"\n",(0,t.jsxs)(n.p,{children:["To generate DKIM keys for your domain, utilize the in-built ",(0,t.jsx)(n.code,{children:"rspamadm dkim_keygen"})," utility:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'rspamadm dkim_keygen -s \'test\' -d example.com\n\n-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\ntest._domainkey IN TXT ( "v=DKIM1; k=rsa; "\n  "p=MIGJAoGBALBrq9K6yxAXHwircsTnDTsd2Kg426z02AnoKTvyYNqwYT5Dxa02lyOiAXloXVIJsyfuGOOoSx543D7DGWw0plgElHXKStXy1TZ7fJfbEtuc5RASIKqOAT1iHGfGB1SZzjt3a3vJBhoStjvLulw4h8NC2jep96/QGuK8G/3b/SJNAgMBAAE=" ) ;\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Between ",(0,t.jsx)(n.code,{children:"-----BEGIN PRIVATE KEY-----"})," and ",(0,t.jsx)(n.code,{children:"-----END PRIVATE KEY-----"})," is your DKIM private key (use the ",(0,t.jsx)(n.code,{children:"-k"})," switch to save to file). The second part is the public DNS TXT record that you should place in your DNS zone file. This command can also save both private and public parts to files."]}),"\n",(0,t.jsx)(n.p,{children:"For an RSA key of 2048 bits:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm dkim_keygen -s 'woosh' -b 2048 -d example.com -k example.private > example.txt\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"> example.txt"})," re-directs the DNS TXT record output to ",(0,t.jsx)(n.code,{children:"example.txt"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"-k example.private"})," saves your private key to the file ",(0,t.jsx)(n.code,{children:"example.private"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"-d example.com "})," specifies the domain as ",(0,t.jsx)(n.code,{children:"example.com"})," (currently meaningless)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"-b 2048"})," specifies a ",(0,t.jsx)(n.code,{children:"2048"})," bit key size (the standard default 1024 bit size is weak)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"-s 'woosh'"})," names the selector ",(0,t.jsx)(n.code,{children:"woosh"})," i.e. ",(0,t.jsx)(n.code,{children:"woosh._domainkey"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Or for an Ed25519 key:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm dkim_keygen -s 'woosh' -d example.com -t ed25519 -k woosh-ed25519.private > woosh-ed25519.txt\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"-t ed25519"})," specifies key type Ed25519"]}),"\n",(0,t.jsxs)(n.li,{children:["Note: using ",(0,t.jsx)(n.code,{children:"-b"})," together with Ed25519 has no effect. There is no variable key length with Ed25519."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Please note that as of September 2019, Ed25519 keys are not widely supported in software, making it inadvisable to exclusively use this key type in a production environment, as this may result in rejected emails. If you choose to use Ed25519 keys, it is recommended to pair them with an RSA key, providing a fallback option in case a recipient domain is unable to parse Ed25519 keys or signatures."}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-local.d/dkim_signing.conf",children:'domain {\n  alpha.example.org {\n    selectors [\n     {\n       path: ".../configs/dkim.key";\n       selector: "dkim";\n     },\n     {\n       path: ".../configs/dkim-eddsa.key";\n       selector: "eddsa";\n     }\n   ]\n }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"verifying-your-private-keys",children:"Verifying your private keys"}),"\n",(0,t.jsx)(n.p,{children:"To verify any generated private RSA key with OpenSSL (and also Ed25519 keys if your OpenSSL >= 1.1.1) you can use the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ openssl pkey -text -noout -in example.private\n\nPrivate-Key: (2048 bit)\nmodulus:\n    00:...\npublicExponent: 65537 (0x10001)\nprivateExponent:\n    00:...\nprime1:\n    00:...\nprime2:\n    00:...\nexponent1:\n    00:...\nexponent2:\n    00:...\ncoefficient:\n    00:...\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You have the option to configure the ",(0,t.jsx)(n.code,{children:"dkim_signing"})," module to verify that the published pubkey record matches the selected private key by setting the ",(0,t.jsx)(n.code,{children:"check_pubkey"})," option to ",(0,t.jsx)(n.code,{children:"true"})," (the default setting is ",(0,t.jsx)(n.code,{children:"false"}),"). Please be advised that this may result in an additional DNS request during the signing process."]}),"\n",(0,t.jsx)(n.h2,{id:"dkim-keys-in-redis",children:"DKIM keys in Redis"}),"\n",(0,t.jsx)(n.p,{children:"To use DKIM keys stored in Redis, add the following to your configuration::"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/dkim_signing.conf\nuse_redis = true;\nkey_prefix = "DKIM_KEYS";\nselector = "myselector";\n'})}),"\n",(0,t.jsxs)(n.p,{children:["... and populate the named hash with DKIM keys; for example the following Lua script could be run with ",(0,t.jsx)(n.code,{children:"redis-cli --eval"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"local key = [[-----BEGIN PRIVATE KEY-----\nMIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBANe3EETkiI1Exyrb\n+VzbMSt90K8MXJA0GcyNs6MFCs9JPaTh90Zu2l7ki7m5LTUx6350AR/3hcvwjSHC\nZjD6fvQ8/zfjN8kaLZ6DAaqtqSlpawIM+8glkuTEkIkpBED/OtDrba4Rd29iLFVu\nwQZXDtTjAAZKZPmtTZ5TXLrcCU6VAgMBAAECgYEA1BFvmBsIN8Gu/+6kNupya2xU\nNVM0yLu/xT5lpNV3LBO325oejAq8+d87kkl/LTW3a2jGFlQ0ICuLw+2mo24QUWRy\nv8if3oeBMlnLqHE+6wNjFVqo5sOjKzjO363xSXwXNUrBT7jDhnZcDN8w3/FecYKj\nifGTVtUs1SLsYwhlc8ECQQDuCRymLZQ/imPn5eFVIydwUzg8ptZlvoA7bfIxUL9B\nQRX33s59kLCilA0tTed8Dd+GnxsT93XOj1ApIfBwmTSlAkEA5/63PDsN7fH+WInq\nVD8nU07M9S8LcGDlPbVVBr2S2I78/iwrSDAYtbkU2vEbhFK/JuKNML2j8OkzV3v1\nQulfMQJBALDzhx+l/HHr3+8RPhx7QKNIyiKUaAdEwbDsP8IXY8YPq1QThu9jM1v4\nsX7/TdkzuvoppwiFykbe1NlvCH279p0CQCmTg4Ee0DtBcCSr6rvYaZLLf329RZ6J\nLuwlMCy6ErQOxBZFEiiovfTrS2qFZToMnkc4uLbwdY36LQJTq7unGTECQCCok8Lz\nBeZtAw+TJofpOM3F2Rlm2qXiBVBeubhRedsiljG0hpvvLJBMppnQ6r27p5Jk39Sm\naTRkxEKrxPWWLNM=\n-----END PRIVATE KEY-----]]\nredis.call('HMSET', 'DKIM_KEYS', 'myselector.example.com', key)\n"})}),"\n",(0,t.jsx)(n.p,{children:"The selector will be chosen as per usual (a domain-specific selector will be used if configured, otherwise the global setting is used)."}),"\n",(0,t.jsx)(n.h2,{id:"using-maps",children:"Using maps"}),"\n",(0,t.jsxs)(n.p,{children:["Starting from Rspamd 1.5.3, the ",(0,t.jsx)(n.code,{children:"selector_map"})," or ",(0,t.jsx)(n.code,{children:"path_map"})," can be used to determine the selectors and paths to private keys, respectively, using the DKIM signing domain as the key. If entries are found, they will override the default settings."]}),"\n",(0,t.jsx)(n.p,{children:"The following configuration provides a templated path for the DKIM signing key, a default selector, and a map that can be used to override the default selector, which in turn affects the effective path to the signing key. Any eligible email will be signed if a key with the appropriate name exists on disk."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/dkim_signing.conf\ntry_fallback = true;\npath = "/var/lib/rspamd/dkim/$domain.$selector.key";\nselector_map = "/etc/rspamd/dkim_selectors.map";\nselector = "dkim";\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In the following configuration, we attempt to sign only domains which are present in both ",(0,t.jsx)(n.code,{children:"selector_map"})," and ",(0,t.jsx)(n.code,{children:"path_map"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/dkim_signing.conf\ntry_fallback = false;\nselector_map = "/etc/rspamd/dkim_selectors.map";\npath_map = "/etc/rspamd/dkim_paths.map";\n'})}),"\n",(0,t.jsx)(n.p,{children:"Format of the maps should be as shown:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"$ head -1 /etc/rspamd/dkim_selectors.map\nexample.net dkim\n$ head -1 /etc/rspamd/dkim_paths.map\nexample.net /var/lib/rspamd/dkim/example.net.$selector.key\n"})}),"\n",(0,t.jsxs)(n.h2,{id:"use-of-signing_table",children:["Use of ",(0,t.jsx)(n.code,{children:"signing_table"})]}),"\n",(0,t.jsx)(n.p,{children:"From the version 1.9.2, Rspamd supports OpenDKIM compatible settings:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"signing_table"}),":"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Defines a table used to select one or more signatures to apply to a message based on the address found in the ",(0,t.jsx)(n.code,{children:"From:"})," header field. The keys in this table can vary based on the type of table used.\nThe values in this data set should include one field that contains a name found in the KeyTable (see above) that identifies which key should be used in generating the signature, and an optional second field naming the signer of the message that will be included in the ",(0,t.jsx)(n.code,{children:"i="})," tag in the generated signature.\nNote that the ",(0,t.jsx)(n.code,{children:"i="})," value will not be included in the signature if it conflicts with the signing domain (the ",(0,t.jsx)(n.code,{children:"d="})," value)."]}),"\n",(0,t.jsxs)(n.p,{children:["If the first field in the data set contains only a ",(0,t.jsx)(n.code,{children:"%"})," symbol, it will be replaced by the domain found in the ",(0,t.jsx)(n.code,{children:"From:"})," header field. Similarly, the optional second field can include a ",(0,t.jsx)(n.code,{children:"%"})," symbol that will be replaced by the domain found in the ",(0,t.jsx)(n.code,{children:"From:"})," header field."]}),"\n",(0,t.jsxs)(n.p,{children:["In Rspamd, this table is treated as ",(0,t.jsx)(n.code,{children:"refile"}),"! So you should use ",(0,t.jsx)(n.strong,{children:"glob"})," style regular expressions to do matching."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"key_table"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:'Gives the location of a file that maps key names to signing keys. This file, if present, overrides any KeyFile setting in the configuration file. The data set in this file associates each key name with three values: (a) the name of the domain to use in the signature\u2019s "d=" value; (b) the name of the selector to use in the signature\u2019s "s=" value; and (c) either a private key or a path to a file containing a private key.'}),"\n",(0,t.jsx)(n.p,{children:'If the first value consists solely of a percent sign ("%") character, it will be replaced by the apparent domain of the sender when generating a signature. If the third value starts with a slash ("/") character, or "./" or "../", then it is presumed to refer to a file from which the private key should be read, otherwise it is itself a PEM-encoded private key or a base64-encoded DER private key; a "%" in the third value in this case will be replaced by the apparent domain name of the sender.'}),"\n",(0,t.jsx)(n.p,{children:"The SigningTable (see below) is used to select records from this table to be used to add signatures based on the message sender."}),"\n",(0,t.jsx)(n.p,{children:"Rspamd also supports embedded tables as for all other maps in the config, e.g. here is a sample used for functional testing:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/dkim_signing.conf\nsigning_table = [\n  "*@cacophony.za.org cacophony.za.org",\n];\n\nkey_table = [\n  "cacophony.za.org %:eddsa:m5kGxtckRfsNe5EuYTe7bvkDjSh7LXaX3aXyIMPGLR0=",\n];\n'})}),"\n",(0,t.jsxs)(n.p,{children:["When using these options, they ",(0,t.jsx)(n.em,{children:"passthrough"})," all mismatch checks. The only meaningful setting is ",(0,t.jsx)(n.code,{children:"sign_networks"})," in this mode as it corresponds with OpenDKIM behaviour. Otherwise, Rspamd will perform signing based on matching of the Mime ",(0,t.jsx)(n.code,{children:"From"})," header with the entries in ",(0,t.jsx)(n.code,{children:"signing_table"})]}),"\n",(0,t.jsx)(n.h2,{id:"http-headers-based-dkim-signing",children:"HTTP headers based DKIM signing"}),"\n",(0,t.jsxs)(n.p,{children:["To simplify REST services integration, Rspamd offers the option of DKIM signing based solely on HTTP request headers. To utilize this feature, simply enable the ",(0,t.jsx)(n.code,{children:"use_http_headers"})," setting. When this mode is activated, Rspamd disregards all other methods of signing messages and only looks for the designated ",(0,t.jsx)(n.strong,{children:"request"})," headers (not email headers!):"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Header"}),(0,t.jsx)(n.th,{children:"Definition"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PerformDkimSign"})}),(0,t.jsxs)(n.td,{children:["Switch DKIM signing on (if ",(0,t.jsx)(n.code,{children:"Yes"}),")"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SignOnAuthFailed"})}),(0,t.jsx)(n.td,{children:"Sign messages with failed DKIM (dkim check must be performed before)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DkimDomain"})}),(0,t.jsx)(n.td,{children:"Dkim signing domain"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DkimSelector"})}),(0,t.jsx)(n.td,{children:"Selector for signing"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DkimPrivateKey"})}),(0,t.jsx)(n.td,{children:"Private key encoded in Base64"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["To ensure proper functionality, it's crucial to follow the mandatory header requirements and enable the ",(0,t.jsx)(n.code,{children:"DKIM_CHECK"})," in user settings. This will enable the automatic DKIM check dependency and allow for the use of the ",(0,t.jsx)(n.code,{children:"Setting"})," header, which facilitates bypassing of other checks. For further information, refer to the (see ",(0,t.jsx)(n.a,{href:"/configuration/settings",children:"Users settings"}),") documentation."]}),"\n",(0,t.jsx)(n.h2,{id:"dkim-signing-using-vault",children:"DKIM signing using Vault"}),"\n",(0,t.jsxs)(n.p,{children:["Starting from version 1.9.3, Rspamd has the capability to use ",(0,t.jsx)(n.a,{href:"https://www.vaultproject.io",children:"Hashicorp Vault"})," to securely store and manage DKIM keys. Vault usage provides secure and flexible storage of the private keys that can scale and use various backends to store sensible data (secrets)."]}),"\n",(0,t.jsxs)(n.p,{children:["To store DKIM keys using Vault, you must create a KV storage version 1. For more information, see the Vault Secrets Engine ",(0,t.jsx)(n.a,{href:"https://learn.hashicorp.com/vault/getting-started/secrets-engines",children:"guide"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["To integrate Vault-stored keys with Rspamd, simply add the following lines to your ",(0,t.jsx)(n.code,{children:"local.d/dkim_signing.conf"})," (or ",(0,t.jsx)(n.code,{children:"arc.conf"})," for ",(0,t.jsx)(n.a,{href:"/modules/arc",children:"ARC signing"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'use_vault = true;\n\nvault_domains = ["example.com"]; # or file/http map path\nvault_url = "http://127.0.0.1:8200"; # or https url if using production vault\nvault_token = "s.AhTThjWhKZAf97VowxG6blyu"; # as generated by vault tokens\n'})}),"\n",(0,t.jsx)(n.p,{children:"To store the vault token securely, you can use JINJA templates and environment/lua variables:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'use_vault = true;\n\nvault_domains = ["example.com"]; # or file/http map path\nvault_url = "http://127.0.0.1:8200"; # or https url if using production vault\nvault_token = "{= VAULT_TOKEN =}"; # as generated by vault tokens\n'})}),"\n",(0,t.jsx)(n.p,{children:"And start Rspamd with the environment variable:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'RSPAMD_VAULT_TOKEN="s.AhTThjWhKZAf97VowxG6blyu" rspamd ...\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Rspamd also provides keys management tools using ",(0,t.jsx)(n.code,{children:"rspamadm"})," command. It can do the following things:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Create new keys:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm vault create example.com\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Create or add new ed25519 keys:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm vault create --algorithm eddsa example.com\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Delete keys"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm vault del example.com\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Perform safe keys rotation:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rspamadm vault roll example.com\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Rspamd generates a new set of keys for each algorithm stored in vault. The new selectors are determined based on the key type and current date, such as ",(0,t.jsx)(n.code,{children:"rsa-20190501"}),". The previous keys are kept, but their expiration date is set to cease usage after the default ttl grace period of one day. During this grace period, Rspamd will sign messages using both the old and new selectors."]}),"\n",(0,t.jsx)(n.p,{children:"For example, if you have rsa-20190501 and ed25519-20190501 selectors and you want to roll them to 20190601, two new keys will be created: rsa-20190601 and ed25519-20190601. For the grace period, specifically until 20190602, Rspamd will produce four DKIM signatures to allow DNS rollover for the new key. This approach ensures a safe and secure key rotation process by providing ample time to address any DNS cache issues."}),"\n",(0,t.jsx)(n.p,{children:"The roll subcommand can also remove all expired keys from the vault."}),"\n",(0,t.jsx)(n.h2,{id:"sign-headers",children:"Sign headers"}),"\n",(0,t.jsx)(n.p,{children:"Rspamd allows you to change the headers that are required to be signed. From Rspamd 1.7.3, you can specify them using the sign_headers option. By default, Rspamd distinguishes between two types of headers:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Normal headers: These headers are signed as many times as you specify them. ",(0,t.jsx)(n.strong,{children:"Important security notice"}),": An attacker can add arbitrary headers with the same name before the signed headers and will still get a valid signature. This option is recommended for headers that are not visible to users, such as transport headers."]}),"\n",(0,t.jsxs)(n.li,{children:["Oversigned headers: These headers are signed ",(0,t.jsx)(n.code,{children:"N + 1"})," times ",(0,t.jsxs)(n.strong,{children:["even if ",(0,t.jsx)(n.code,{children:"N == 0"})]}),". Oversigned headers cannot be appended to a message without signature breaking. Displayed or meaningful headers are usually oversigned."]}),"\n",(0,t.jsxs)(n.li,{children:["Optionally oversigned headers (from 1.9.3): These headers are signed ",(0,t.jsx)(n.code,{children:"N + 1"})," times ",(0,t.jsxs)(n.strong,{children:["if ",(0,t.jsx)(n.code,{children:"N != 0"})," only."]})," Optionally oversigned headers cannot be appended to a message without signature breaking, if at least one header with such a name is presented in the original message. Displayed but optional headers are usually oversigned in this way."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Oversigned headers are prefixed with the (o) string. Optionally oversigned headers are prefixed with the (x) string."}),"\n",(0,t.jsx)(n.h3,{id:"default-sign_headers-after-193",children:"Default sign_headers (after 1.9.3)"}),"\n",(0,t.jsx)(n.p,{children:"For DKIM signing, Rspamd uses the following default list:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"(o)from:(x)sender:(o)reply-to:(o)subject:(x)date:(x)message-id:\n(o)to:(o)cc:(x)mime-version:(x)content-type:(x)content-transfer-encoding:\nresent-to:resent-cc:resent-from:resent-sender:resent-message-id:\n(x)in-reply-to:(x)references:list-id:list-help:list-owner:list-unsubscribe:\nlist-unsubscribe-post:list-subscribe:list-post:(x)openpgp:(x)autocrypt\n\t\n"})}),"\n",(0,t.jsx)(n.p,{children:"Here is the summary of the list above:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Header"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Sign type"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"From"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Strictly oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Sender"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Reply-To"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Strictly oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Subject"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Strictly oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Date"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Message-Id"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"To"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Strictly oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Cc"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Strictly oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Mime-Version"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Content-Type"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Content-Transfer-Encoding"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Resent-To"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Resent-Cc"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Resent-From"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Resent-Sender"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Resent-Message-Id"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"In-Reply-To"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"References"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Id"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Help"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Owner"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Unsubscribe"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Unsubscribe-Post"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Subscribe"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"List-Post"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Do not oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Openpgp"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"Autocrypt"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Conditionally oversign"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"rules-of-headers-sign",children:"Rules of headers sign"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"sign_headers"})," lists headers that are:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["signed ",(0,t.jsx)(n.code,{children:"n"})," times if they are present ",(0,t.jsx)(n.code,{children:"n"})," times"]}),"\n",(0,t.jsxs)(n.li,{children:["for the ",(0,t.jsx)(n.code,{children:"n = 0"})," case this would mean that headers are not signed if they are not present. Oversigned headers are still signed one time to prevent adding a header with this name. Optionally oversigned headers are excluded from that."]}),"\n",(0,t.jsxs)(n.li,{children:["headers listed as oversigned are signed ",(0,t.jsx)(n.code,{children:"n + 1"})," times"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"issues-using-sendmail-on-dkim-signing-and-verification",children:"Issues using Sendmail on DKIM signing and verification"}),"\n",(0,t.jsx)(n.p,{children:"This part of the documentation has been contributed by Dilyan Palauzov."}),"\n",(0,t.jsx)(n.p,{children:"When using the sendmail MTA in both signing and verifying mode, there are\na few issues of which to be aware that might cause operational problems\nand deserve consideration."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:'When the MTA will be used for relaying emails, e.g. delivering to other\nhosts using the aliases mechanism, it is important not to break\nsignatures inserted by the original sender.  This is particularly sensitive\nparticular when the sending domain has published a "reject" DMARC policy.'}),"\n",(0,t.jsx)(n.p,{children:"By default, sendmail quotes to address header fields when there are no\nquotes and the display part of the address contains a period or an\napostrophe.  However, Rspamd only observes the raw, unmodified form of\nthe header field, and so the content that gets verified and what gets\nsigned will not be the same, guaranteeing the attached signature is not\nvalid."}),"\n",(0,t.jsx)(n.p,{children:"To direct sendmail not to modify the headers, add this to your sendmail.mc:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:" conf(`confMUST_QUOTE_CHARS', `')\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"As stated in sendmail's KNOWNBUGS file, sendmail truncates header field\nvalues longer than 256 characters, which could mean truncating the domain\nof a long From: header field value and invalidating the signature.\nYou may wish to consider increasing MAXNAME in sendmail/conf.h to mitigate\nchanging the messages and invalidating their signatures.  This change\nrequires recompiling sendmail."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Similar to the first bullet above, sendmail may wrap very long single-line recipient\nfields for presentation purposes; for example:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"    To: very long name <a@example.org>,anotherloo...ong name b <b@example.org>\n"})}),"\n",(0,t.jsx)(n.p,{children:"... might be rewritten as:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"    To: very long name <a@example.org>,\n    \tanotherloo...ong name b <b@example.org>\n"})}),"\n",(0,t.jsx)(n.p,{children:"This rewrite is also done after Rspamd has seen the message, meaning\nthe signature Rspamd attaches to the message does not match the\ncontent it signed.  There is not a known configuration change to\nmitigate this mutation."}),"\n",(0,t.jsxs)(n.p,{children:["The only known mechanism for dealing with this is to have distinct\nsettings of Rspamd do the verifying (inbound) and signing (outbound)\nso that the version that arrives at the signing instance is already\nin the rewritten form, guaranteeing the input and output are the same\nand thus the signature matches the payload. You can do such a split using ",(0,t.jsx)(n.a,{href:"/configuration/settings",children:"user settings"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"optimize-signing-only-mode",children:"Optimize signing only mode"}),"\n",(0,t.jsxs)(n.p,{children:["If you intend to run Rspamd for DKIM signing only in certain conditions, then please use the ",(0,t.jsx)(n.a,{href:"/configuration/settings",children:"user settings"})," as following:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'# local.d/settings.conf\ndkim_signing {\n  ... # Add conditions to match this setting\n  apply {\n    symbols_enabled = ["DKIM_SIGNED"];\n    flags = ["skip_process"]; # Disable expensive MIME processing\n  }\n}\n'})})]})}function c(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>d});var i=s(6540);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);