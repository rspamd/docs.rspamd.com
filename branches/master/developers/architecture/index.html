<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developers/architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Rspamd Architecture | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/master/developers/architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Rspamd Architecture | Rspamd Documentation"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/master/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/master/developers/architecture"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/developers/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/ru/developers/architecture" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/developers/architecture" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Developers","item":"https://rspamd.com/docs.rspamd.com/branches/master/developers/architecture"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/master/blog/rss.xml" title="Rspamd Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/master/blog/atom.xml" title="Rspamd Blog Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script>

<link rel="alternate" type="application/rss+xml" title="Rspamd Changelog RSS" href="/rss/changelog.xml">
<link rel="alternate" type="application/rss+xml" title="Rspamd Blog RSS" href="/blog/rss.xml">
<link rel="alternate" type="application/atom+xml" title="Rspamd Blog Atom" href="/blog/atom.xml"><link rel="stylesheet" href="/docs.rspamd.com/branches/master/assets/css/styles.5200ff8d.css">
<script src="/docs.rspamd.com/branches/master/assets/js/runtime~main.3f93b6d6.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/master/assets/js/main.cdff81ac.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/">Documentation</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/about/">About</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/"><span title="About Rspamd" class="linkLabel_WmDU">About Rspamd</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/tutorials/migration"><span title="How-To Guides" class="categoryLinkLabel_W154">How-To Guides</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/faq"><span title="Frequently Asked Questions" class="linkLabel_WmDU">Frequently Asked Questions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/support"><span title="Rspamd Support" class="linkLabel_WmDU">Rspamd Support</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/downloads"><span title="Downloads" class="linkLabel_WmDU">Downloads</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/configuration/"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a><button aria-label="Expand sidebar category &#x27;Configuration&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/workers/"><span title="Workers" class="categoryLinkLabel_W154">Workers</span></a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/modules/"><span title="Modules" class="categoryLinkLabel_W154">Modules</span></a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/lua/"><span title="Lua API" class="categoryLinkLabel_W154">Lua API</span></a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible menu__list-item-collapsible--active"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" aria-current="page" href="/docs.rspamd.com/branches/master/developers/architecture"><span title="Developers" class="categoryLinkLabel_W154">Developers</span></a><button aria-label="Collapse sidebar category &#x27;Developers&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/master/developers/architecture"><span title="Rspamd Architecture" class="linkLabel_WmDU">Rspamd Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/protocol"><span title="Rspamd protocol" class="linkLabel_WmDU">Rspamd protocol</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/encryption"><span title="HTTPCrypt Encryption Protocol" class="linkLabel_WmDU">HTTPCrypt Encryption Protocol</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/sync_async"><span title="Coroutines and async calls" class="linkLabel_WmDU">Coroutines and async calls</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/writing_rules"><span title="Rule Writing Workshop" class="linkLabel_WmDU">Rule Writing Workshop</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/writing_tests"><span title="Writing tests for Rspamd" class="linkLabel_WmDU">Writing tests for Rspamd</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/controller_endpoints"><span title="Controller WebUI Endpoints Development Guide" class="linkLabel_WmDU">Controller WebUI Endpoints Development Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/developers/examples"><span title="Lua rules examples" class="linkLabel_WmDU">Lua rules examples</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/administration/rspamadm/"><span title="Administration Tools" class="categoryLinkLabel_W154">Administration Tools</span></a><button aria-label="Expand sidebar category &#x27;Administration Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/other/gtube_patterns"><span title="Other" class="categoryLinkLabel_W154">Other</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/blog"><span title="Blog" class="linkLabel_WmDU">Blog</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/branches/master/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Developers</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Rspamd Architecture</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>Rspamd is a high-performance email processing daemon designed to handle millions of messages per day with minimal resource usage. Its architecture is built on several key principles:</p>
<ul>
<li class=""><strong>Event-driven, non-blocking I/O</strong> for handling thousands of concurrent connections</li>
<li class=""><strong>Multi-process model</strong> with isolated worker processes for security and stability</li>
<li class=""><strong>Modular plugin system</strong> enabling flexible functionality extension</li>
<li class=""><strong>Async-first design</strong> for efficient external service integration</li>
<li class=""><strong>Memory efficiency</strong> through custom memory pool allocators</li>
<li class=""><strong>Zero-copy operations</strong> where possible to minimize overhead</li>
</ul>
<p>This document describes the internal architecture, core components, and design patterns used throughout Rspamd.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="process-model">Process Model<a href="#process-model" class="hash-link" aria-label="Direct link to Process Model" title="Direct link to Process Model" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Rspamd uses a <strong>master-worker process model</strong> similar to nginx, with one main process spawning multiple worker processes:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                      Main Process                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Configuration management                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Worker lifecycle management                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Signal handling                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - No message processing                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────┬───────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ├─────────────┬────────────┬────────────┬─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ▼             ▼            ▼            ▼             ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ┌───────────┐ ┌───────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          │  Normal   │ │  Normal   │ │  Proxy   │ │Controller│ │  Fuzzy   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          │ Worker 1  │ │ Worker 2  │ │  Worker  │ │  Worker  │ │  Worker  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          └───────────┘ └───────────┘ └──────────┘ └──────────┘ └──────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="main-process">Main Process<a href="#main-process" class="hash-link" aria-label="Direct link to Main Process" title="Direct link to Main Process" translate="no">​</a></h3>
<p>The main process is responsible for:</p>
<ol>
<li class=""><strong>Configuration Loading</strong>: Parses UCL configuration files and validates settings</li>
<li class=""><strong>Worker Spawning</strong>: Forks worker processes with appropriate privileges</li>
<li class=""><strong>Signal Handling</strong>: Responds to system signals (HUP, TERM, USR1, USR2)</li>
<li class=""><strong>Privilege Management</strong>: Drops privileges after binding to privileged ports</li>
<li class=""><strong>Worker Monitoring</strong>: Restarts crashed workers automatically</li>
<li class=""><strong>Log Coordination</strong>: Manages centralized logging</li>
</ol>
<p>The main process <strong>never processes messages</strong> directly, maintaining a clean separation of concerns.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="worker-types">Worker Types<a href="#worker-types" class="hash-link" aria-label="Direct link to Worker Types" title="Direct link to Worker Types" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="normal-worker">Normal Worker<a href="#normal-worker" class="hash-link" aria-label="Direct link to Normal Worker" title="Direct link to Normal Worker" translate="no">​</a></h4>
<p>The primary message processing worker that:</p>
<ul>
<li class="">Accepts HTTP connections with email messages</li>
<li class="">Performs spam/ham classification</li>
<li class="">Executes all configured rules and modules</li>
<li class="">Communicates with external services (Redis, DNS, RBLs)</li>
<li class="">Returns classification results via JSON</li>
</ul>
<p><strong>Configuration:</strong></p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:rgb(222, 71, 0)">worker</span><span class="token directive"> </span><span class="token directive string" style="color:#e3116c">&quot;normal&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">bind_socket</span><span class="token directive"> = </span><span class="token directive string" style="color:#e3116c">&quot;*:11333&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">count</span><span class="token directive"> = </span><span class="token directive number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Number of worker processes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .include(try=true,priority=1,duplicate=merge) &quot;$LOCAL_CONFDIR/local.d/worker-normal.inc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Typical deployment:</strong> 1-4 workers per CPU core, depending on workload.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="proxy-worker">Proxy Worker<a href="#proxy-worker" class="hash-link" aria-label="Direct link to Proxy Worker" title="Direct link to Proxy Worker" translate="no">​</a></h4>
<p>Provides Milter protocol bridging and load balancing:</p>
<ul>
<li class="">Accepts Milter protocol connections from MTAs</li>
<li class="">Translates Milter to Rspamd HTTP protocol</li>
<li class="">Can forward requests to multiple normal workers</li>
<li class="">Supports encryption (<a class="" href="/docs.rspamd.com/branches/master/developers/encryption">HTTPCrypt protocol</a>)</li>
<li class="">Handles connection pooling and retries</li>
</ul>
<p><strong>Use cases:</strong></p>
<ul>
<li class="">Postfix/Sendmail integration via Milter</li>
<li class="">Load balancing across multiple Rspamd instances</li>
<li class="">Encryption proxy for untrusted networks</li>
<li class="">Protocol translation for legacy systems</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="controller-worker">Controller Worker<a href="#controller-worker" class="hash-link" aria-label="Direct link to Controller Worker" title="Direct link to Controller Worker" translate="no">​</a></h4>
<p>Management and web interface worker:</p>
<ul>
<li class="">Serves WebUI for administration</li>
<li class="">Provides REST API for learning and configuration</li>
<li class="">Handles authentication with password/enable password</li>
<li class="">Supports read-only and read-write modes</li>
<li class="">Exposes metrics in OpenMetrics format</li>
</ul>
<p><strong>Security note:</strong> Should be bound to localhost or protected by firewall in production.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="fuzzy-storage-worker">Fuzzy Storage Worker<a href="#fuzzy-storage-worker" class="hash-link" aria-label="Direct link to Fuzzy Storage Worker" title="Direct link to Fuzzy Storage Worker" translate="no">​</a></h4>
<p>Specialized worker for fuzzy hash storage:</p>
<ul>
<li class="">Maintains database of fuzzy hashes for near-duplicate detection</li>
<li class="">Handles add/delete/check operations</li>
<li class="">Supports sharding and replication</li>
<li class="">Uses custom protocol over UDP/TCP</li>
<li class="">Implements expiration and rotation policies</li>
</ul>
<p>See <a class="" href="/docs.rspamd.com/branches/master/workers/fuzzy_storage">fuzzy_storage worker documentation</a> for details.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="event-driven-architecture">Event-Driven Architecture<a href="#event-driven-architecture" class="hash-link" aria-label="Direct link to Event-Driven Architecture" title="Direct link to Event-Driven Architecture" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="event-loop">Event Loop<a href="#event-loop" class="hash-link" aria-label="Direct link to Event Loop" title="Direct link to Event Loop" translate="no">​</a></h3>
<p>Rspamd uses <strong>libevent</strong> (or <strong>libev</strong> on some platforms) for event-driven I/O:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   Event Loop                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────┐  ┌────────────┐  ┌────────────┐        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ I/O Events │  │   Timers   │  │  Signals   │        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         │               │                │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         └───────────────┴────────────────┘              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    Event Queue                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         ┌───────────────┴───────────────┐              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         ▼                               ▼              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────┐                 ┌─────────────┐       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  Callbacks  │                 │  Callbacks  │       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────┘                 └─────────────┘       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="non-blocking-io">Non-Blocking I/O<a href="#non-blocking-io" class="hash-link" aria-label="Direct link to Non-Blocking I/O" title="Direct link to Non-Blocking I/O" translate="no">​</a></h3>
<p>All I/O operations in Rspamd are non-blocking:</p>
<ol>
<li class=""><strong>Network I/O</strong>: Socket operations return immediately, callbacks invoked when data available</li>
<li class=""><strong>DNS Queries</strong>: Asynchronous DNS resolution via c-ares library</li>
<li class=""><strong>Redis Operations</strong>: Non-blocking Redis client (hiredis) with connection pooling</li>
<li class=""><strong>External Services</strong>: HTTP requests to external services (RBLs, reputation APIs) are async</li>
</ol>
<p>This allows a single worker to handle hundreds of concurrent message scans without blocking.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="asynchronous-session-lifecycle">Asynchronous Session Lifecycle<a href="#asynchronous-session-lifecycle" class="hash-link" aria-label="Direct link to Asynchronous Session Lifecycle" title="Direct link to Asynchronous Session Lifecycle" translate="no">​</a></h3>
<p>A typical message processing session:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Client Connect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ Socket Accept (non-blocking)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ HTTP Request Parse (may require multiple reads)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ Message Processing Start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   ├─ DNS Queries (async, multiple in parallel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   ├─ Redis Lookups (async)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   ├─ External HTTP Requests (async)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   ├─ Rule Processing (CPU-bound, sync)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │   └─ Wait for all async operations to complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ Result Aggregation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ├─ HTTP Response Send (non-blocking)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     └─ Socket Close</span><br></span></code></pre></div></div>
<p>All blocking operations (DNS, Redis, HTTP) run concurrently, maximizing throughput.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="message-processing-pipeline">Message Processing Pipeline<a href="#message-processing-pipeline" class="hash-link" aria-label="Direct link to Message Processing Pipeline" title="Direct link to Message Processing Pipeline" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="high-level-flow">High-Level Flow<a href="#high-level-flow" class="hash-link" aria-label="Direct link to High-Level Flow" title="Direct link to High-Level Flow" translate="no">​</a></h3>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-object">Task Object<a href="#task-object" class="hash-link" aria-label="Direct link to Task Object" title="Direct link to Task Object" translate="no">​</a></h3>
<p>The <strong>task object</strong> is the central data structure representing a message being processed:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rspamd_task</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Message data */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rspamd_message</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Parsed MIME structure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">const</span><span class="token plain"> guchar </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// Raw message bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gsize msg_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                       </span><span class="token comment" style="color:#999988;font-style:italic">// Message length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Processing context */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rspamd_task_session</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Async session for pending operations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">event_base</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ev_base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Event loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Results */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GHashTable </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// Symbol results by metric</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">double</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// Current score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Metadata */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rspamd_inet_addr_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">from_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Sender IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gchar </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">deliver_to</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// Recipient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gchar </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                         </span><span class="token comment" style="color:#999988;font-style:italic">// SMTP AUTH user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Memory management */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">rspamd_mempool_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">task_pool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Memory pool for task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>Key characteristics:</strong></p>
<ul>
<li class=""><strong>Self-contained</strong>: All message data and processing state in one structure</li>
<li class=""><strong>Memory pool</strong>: All allocations use task-specific pool, freed at once when task completes</li>
<li class=""><strong>Async session</strong>: Tracks pending async operations (DNS, Redis, HTTP)</li>
<li class=""><strong>Zero-copy</strong>: Message data referenced from original buffer when possible</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="processing-phases">Processing Phases<a href="#processing-phases" class="hash-link" aria-label="Direct link to Processing Phases" title="Direct link to Processing Phases" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-pre-filters">1. Pre-filters<a href="#1-pre-filters" class="hash-link" aria-label="Direct link to 1. Pre-filters" title="Direct link to 1. Pre-filters" translate="no">​</a></h4>
<p>Run before main rule processing:</p>
<ul>
<li class=""><strong>Purpose</strong>: Early decisions, data preparation, short-circuit logic</li>
<li class=""><strong>Examples</strong>:
<ul>
<li class="">Whitelisting (bypass spam checks for trusted senders)</li>
<li class="">Rate limiting (temporary reject if limits exceeded)</li>
<li class="">Settings application (load user-specific configuration)</li>
</ul>
</li>
<li class=""><strong>Behavior</strong>: Can set <code>pre_result</code> to skip remaining processing</li>
</ul>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Example pre-filter in Lua</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_pre_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> ip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_from_ip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">is_trusted_ip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">set_pre_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;accept&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Trusted IP&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Skip further processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-filters-main-rules">2. Filters (Main Rules)<a href="#2-filters-main-rules" class="hash-link" aria-label="Direct link to 2. Filters (Main Rules)" title="Direct link to 2. Filters (Main Rules)" translate="no">​</a></h4>
<p>Core spam detection logic:</p>
<ul>
<li class=""><strong>Rule types</strong>: C modules and Lua plugins</li>
<li class=""><strong>Execution</strong>: Can be synchronous (CPU-bound) or asynchronous (I/O-bound)</li>
<li class=""><strong>Symbols</strong>: Each rule registers symbols with scores</li>
<li class=""><strong>Parallelism</strong>: Async rules execute concurrently</li>
</ul>
<p><strong>Common filter modules:</strong></p>


















































<table><thead><tr><th>Module</th><th>Type</th><th>Purpose</th></tr></thead><tbody><tr><td><code>spf</code></td><td>C</td><td>SPF validation</td></tr><tr><td><code>dkim</code></td><td>C</td><td>DKIM signature verification</td></tr><tr><td><code>regexp</code></td><td>C</td><td>High-performance regex matching</td></tr><tr><td><code>bayes</code></td><td>C</td><td>Statistical classification (OSB-Bayes)</td></tr><tr><td><code>multimap</code></td><td>Lua</td><td>Generic map-based rules</td></tr><tr><td><code>rbl</code></td><td>Lua</td><td>DNS blacklist queries</td></tr><tr><td><code>phishing</code></td><td>Lua</td><td>Phishing URL detection</td></tr><tr><td><code>neural</code></td><td>C</td><td>Neural network classification</td></tr></tbody></table>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-post-filters">3. Post-filters<a href="#3-post-filters" class="hash-link" aria-label="Direct link to 3. Post-filters" title="Direct link to 3. Post-filters" translate="no">​</a></h4>
<p>Run after all rules complete:</p>
<ul>
<li class=""><strong>Purpose</strong>: Final adjustments, actions, logging</li>
<li class=""><strong>Examples</strong>:
<ul>
<li class="">Composites (combine symbols into meta-symbols)</li>
<li class="">Force actions (override score-based actions)</li>
<li class="">Metadata export (send results to external systems)</li>
</ul>
</li>
<li class=""><strong>Behavior</strong>: Can modify final action</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-idempotent-filters">4. Idempotent Filters<a href="#4-idempotent-filters" class="hash-link" aria-label="Direct link to 4. Idempotent Filters" title="Direct link to 4. Idempotent Filters" translate="no">​</a></h4>
<p>Special filters that run after all other processing:</p>
<ul>
<li class=""><strong>Purpose</strong>: Generate metadata, extract information</li>
<li class=""><strong>Execution order</strong>: Run strictly after all filters, post-filters, and composites</li>
<li class=""><strong>Examples</strong>: Email extraction, URL extraction</li>
<li class=""><strong>Behavior</strong>: Never modify results, pure data extraction</li>
<li class=""><strong>Use case</strong>: Safe to call at any point in code, but actual execution is deferred until the end</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="async-session-management">Async Session Management<a href="#async-session-management" class="hash-link" aria-label="Direct link to Async Session Management" title="Direct link to Async Session Management" translate="no">​</a></h3>
<p>Rspamd uses an <strong>async session</strong> mechanism to track pending operations:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rspamd_async_session</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GHashTable </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Pending async events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">event_finalizer_t</span><span class="token plain"> fin</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Callback when all events complete</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">user_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// User data for finalizer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>How it works:</strong></p>
<ol>
<li class=""><strong>Register event</strong>: When starting async operation, register it with session</li>
<li class=""><strong>Track completion</strong>: Operation callback marks event as complete</li>
<li class=""><strong>Finalize</strong>: When all events complete, session finalizer is called</li>
<li class=""><strong>Timeout</strong>: If events don&#x27;t complete within timeout, force finalization</li>
</ol>
<p><strong>Example async DNS lookup:</strong></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Register async event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">session_event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rspamd_session_add_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dns_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dns&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Start DNS query</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rdns_make_request_full</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resolver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dns_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       timeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_retries</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// When DNS response arrives, dns_callback is invoked</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dns_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rdns_reply</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">struct</span><span class="token plain"> </span><span class="token class-name">rspamd_task</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Process DNS reply</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">process_dns_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Remove event from session (may trigger finalization)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rspamd_session_remove_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session_event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="module-system">Module System<a href="#module-system" class="hash-link" aria-label="Direct link to Module System" title="Direct link to Module System" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="module-architecture">Module Architecture<a href="#module-architecture" class="hash-link" aria-label="Direct link to Module Architecture" title="Direct link to Module Architecture" translate="no">​</a></h3>
<p>Rspamd modules are the primary extension mechanism:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    Module Interface                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  module_init()      - Initialize module structures      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  module_config()    - Parse configuration               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  module_reconfig()  - Apply config changes              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  module_attach()    - Register callbacks                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ├──────────────┬──────────────┬──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ▼              ▼              ▼              ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ┌────────┐    ┌─────────┐    ┌─────────┐   ┌─────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   C    │    │   Lua   │    │ Virtual │   │  Rule   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │ Module │    │  Module │    │ Module  │   │ Module  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └────────┘    └─────────┘    └─────────┘   └─────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="c-modules">C Modules<a href="#c-modules" class="hash-link" aria-label="Direct link to C Modules" title="Direct link to C Modules" translate="no">​</a></h3>
<p>Compiled into Rspamd binary or loaded as dynamic libraries:</p>
<p><strong>Advantages:</strong></p>
<ul>
<li class="">Maximum performance</li>
<li class="">Direct access to internals</li>
<li class="">Can hook into low-level events</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li class="">Requires compilation</li>
<li class="">Less flexible than Lua</li>
<li class="">Harder to maintain</li>
</ul>
<p><strong>Examples:</strong> <code>spf</code>, <code>dkim</code>, <code>regexp</code>, <code>chartable</code>, <code>fuzzy_check</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="lua-modules">Lua Modules<a href="#lua-modules" class="hash-link" aria-label="Direct link to Lua Modules" title="Direct link to Lua Modules" translate="no">​</a></h3>
<p>Written in Lua with full API access:</p>
<p><strong>Advantages:</strong></p>
<ul>
<li class="">Easy to write and modify</li>
<li class="">No compilation required</li>
<li class="">Hot-reload support</li>
<li class="">Full Rspamd API access</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li class="">Slightly slower than C (but JIT helps)</li>
<li class="">Limited to Lua API surface</li>
</ul>
<p><strong>Examples:</strong> <code>multimap</code>, <code>rbl</code>, <code>phishing</code>, <code>whitelist</code></p>
<p><strong>Module structure:</strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Module registration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> mod_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_module&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Configuration parsing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configure_module</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_all_opt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mod_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">not</span><span class="token plain"> opts </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">false</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Parse options</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Symbol callback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">my_symbol_callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Check message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">condition_met</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">insert_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;MY_SYMBOL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Register symbol</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MY_SYMBOL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;normal&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> my_symbol_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_group&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Module initialization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configure_module</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_module_option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mod_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;enabled&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;boolean&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="virtual-modules">Virtual Modules<a href="#virtual-modules" class="hash-link" aria-label="Direct link to Virtual Modules" title="Direct link to Virtual Modules" translate="no">​</a></h3>
<p>Modules without code, used for organizing symbols:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- In rspamd.conf.local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">group </span><span class="token string" style="color:#e3116c">&quot;my_virtual_module&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">symbols</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SYMBOL_ONE&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SYMBOL_TWO&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rule-modules">Rule Modules<a href="#rule-modules" class="hash-link" aria-label="Direct link to Rule Modules" title="Direct link to Rule Modules" translate="no">​</a></h3>
<p>Specialized modules for specific rule types:</p>
<ul>
<li class=""><strong>Regexp module</strong>: High-performance regex matching with PCRE/Hyperscan</li>
<li class=""><strong>Multimap module</strong>: Generic map-based checks (IP, domain, header matching)</li>
<li class=""><strong>Composites module</strong>: Combine symbols using boolean expressions</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="symbol-and-score-system">Symbol and Score System<a href="#symbol-and-score-system" class="hash-link" aria-label="Direct link to Symbol and Score System" title="Direct link to Symbol and Score System" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="symbol-registration">Symbol Registration<a href="#symbol-registration" class="hash-link" aria-label="Direct link to Symbol Registration" title="Direct link to Symbol Registration" translate="no">​</a></h3>
<p>Symbols are registered with metadata:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MY_SYMBOL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">-- Symbol name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;normal&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">-- Symbol type (normal, callback, virtual)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> my_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">-- Callback function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- Default score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_group&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">-- Group for organization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Checks X&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- Human-readable description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Execution control</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">-- Execution priority (higher = earlier)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    one_shot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">-- Execute only once per message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Async control</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;explicit_disable&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">-- Flags controlling behavior</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="symbol-dependencies">Symbol Dependencies<a href="#symbol-dependencies" class="hash-link" aria-label="Direct link to Symbol Dependencies" title="Direct link to Symbol Dependencies" translate="no">​</a></h3>
<p>Symbols can depend on other symbols:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_dependency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;DMARC_POLICY_ALLOW&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;R_DKIM_ALLOW&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This ensures <code>R_DKIM_ALLOW</code> runs before <code>DMARC_POLICY_ALLOW</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="score-calculation">Score Calculation<a href="#score-calculation" class="hash-link" aria-label="Direct link to Score Calculation" title="Direct link to Score Calculation" translate="no">​</a></h3>
<p>Final score is calculated as:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Total Score = Σ (symbol_score × symbol_weight × multiplier)</span><br></span></code></pre></div></div>
<p>Where:</p>
<ul>
<li class=""><strong>symbol_score</strong>: Base score from configuration</li>
<li class=""><strong>symbol_weight</strong>: Dynamic weight returned by symbol (typically 1.0)</li>
<li class=""><strong>multiplier</strong>: Per-symbol or per-group multiplier</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="metric-groups">Metric Groups<a href="#metric-groups" class="hash-link" aria-label="Direct link to Metric Groups" title="Direct link to Metric Groups" translate="no">​</a></h3>
<p>Symbols are organized into groups for management:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">group </span><span class="token string" style="color:#e3116c">&quot;spf&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Cap group&#x27;s contribution to total score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">symbols</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;R_SPF_ALLOW&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;R_SPF_FAIL&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;R_SPF_SOFTFAIL&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Groups allow:</p>
<ul>
<li class="">Score capping (max_score)</li>
<li class="">Group-wide enable/disable</li>
<li class="">Organizational hierarchy</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="statistical-modules">Statistical Modules<a href="#statistical-modules" class="hash-link" aria-label="Direct link to Statistical Modules" title="Direct link to Statistical Modules" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="bayesian-classifier">Bayesian Classifier<a href="#bayesian-classifier" class="hash-link" aria-label="Direct link to Bayesian Classifier" title="Direct link to Bayesian Classifier" translate="no">​</a></h3>
<p>Rspamd uses <strong>OSB-Bayes</strong> (Orthogonal Sparse Bigrams):</p>
<p><strong>Algorithm:</strong></p>
<ol>
<li class=""><strong>Tokenization</strong>: Extract tokens from message (words, headers, etc.)</li>
<li class=""><strong>Bigram generation</strong>: Create token pairs with positional information</li>
<li class=""><strong>Hashing</strong>: Hash bigrams into fixed-size feature space</li>
<li class=""><strong>Classification</strong>: Compare against learned spam/ham distributions</li>
</ol>
<p><strong>Storage backends:</strong></p>
<ul>
<li class=""><strong>Redis</strong>: Recommended for production (fast, scalable)</li>
<li class=""><strong>SQLite</strong>: Suitable for single-machine deployments</li>
<li class=""><strong>File</strong>: Legacy backend, not recommended</li>
</ul>
<p><strong>Learning:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Learn as spam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_spam &lt; spam_message.eml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Learn as ham</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_ham &lt; ham_message.eml</span><br></span></code></pre></div></div>
<p><strong>Auto-learning:</strong></p>
<p>Can automatically learn from high-confidence classifications:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classifier </span><span class="token string" style="color:#e3116c">&quot;bayes&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">tokenizer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;osb&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">cache</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;redis&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autolearn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">autolearn</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spam_threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Learn as spam if score &gt; 15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ham_threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">-- Learn as ham if score &lt; -5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="neural-networks-plugin">Neural Networks Plugin<a href="#neural-networks-plugin" class="hash-link" aria-label="Direct link to Neural Networks Plugin" title="Direct link to Neural Networks Plugin" translate="no">​</a></h3>
<p>Uses <strong>perceptron-based clustering</strong> with existing symbols as features:</p>
<p><strong>How it works:</strong></p>
<ol>
<li class=""><strong>Feature extraction</strong>: Use triggered symbols as input features</li>
<li class=""><strong>Training</strong>: Learn from explicit learning (via <code>/learnspam</code>) or auto-learning</li>
<li class=""><strong>Prediction</strong>: Output score based on symbol pattern</li>
<li class=""><strong>Multiple networks</strong>: Can train separate networks for different message types</li>
</ol>
<p><strong>Advantages over Bayes:</strong></p>
<ul>
<li class="">Learns from symbol patterns, not message content</li>
<li class="">Adapts to your specific rule configuration</li>
<li class="">Provides complementary signal to Bayes</li>
</ul>
<p><strong>Configuration:</strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">neural</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost:6379&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Redis </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> model storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">train</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_trains </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Train after </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> samples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        learning_rate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">rules</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;NEURAL_SPAM&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            spam_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ham_score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fuzzy-hashes">Fuzzy Hashes<a href="#fuzzy-hashes" class="hash-link" aria-label="Direct link to Fuzzy Hashes" title="Direct link to Fuzzy Hashes" translate="no">​</a></h3>
<p>Near-duplicate detection using fuzzy hashing:</p>
<p><strong>Algorithm:</strong></p>
<ul>
<li class="">Extracts text content from message</li>
<li class="">Computes multiple hashes (for text, images, attachments)</li>
<li class="">Compares against database of known spam/ham hashes</li>
<li class="">Returns match percentage</li>
</ul>
<p><strong>Use cases:</strong></p>
<ul>
<li class="">Bulk spam detection</li>
<li class="">Spam campaign identification</li>
<li class="">Shared reputation across multiple servers</li>
</ul>
<p>See <a class="" href="/docs.rspamd.com/branches/master/tutorials/fuzzy_storage">fuzzy storage documentation</a> for details.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="memory-management">Memory Management<a href="#memory-management" class="hash-link" aria-label="Direct link to Memory Management" title="Direct link to Memory Management" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="memory-pools">Memory Pools<a href="#memory-pools" class="hash-link" aria-label="Direct link to Memory Pools" title="Direct link to Memory Pools" translate="no">​</a></h3>
<p>Rspamd uses custom <strong>memory pools</strong> for efficient allocation:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">rspamd_mempool_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rspamd_mempool_new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;task&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Allocate from pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rspamd_mempool_alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// All allocations freed at once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rspamd_mempool_delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>Advantages:</strong></p>
<ol>
<li class=""><strong>No individual frees</strong>: Bulk deallocation when pool destroyed</li>
<li class=""><strong>Fast allocation</strong>: Simple bump-pointer allocation</li>
<li class=""><strong>Reduced fragmentation</strong>: Allocations from contiguous regions</li>
<li class=""><strong>Leak prevention</strong>: All memory freed with pool</li>
</ol>
<p><strong>Pool types:</strong></p>
<ul>
<li class=""><strong>Task pool</strong>: Per-message, destroyed after processing</li>
<li class=""><strong>Config pool</strong>: Lives for entire config lifetime</li>
<li class=""><strong>Module pools</strong>: Per-module, destroyed on module unload</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="zero-copy-operations">Zero-Copy Operations<a href="#zero-copy-operations" class="hash-link" aria-label="Direct link to Zero-Copy Operations" title="Direct link to Zero-Copy Operations" translate="no">​</a></h3>
<p>Where possible, Rspamd avoids copying data:</p>
<ul>
<li class=""><strong>Message body</strong>: References original buffer, no copy</li>
<li class=""><strong>Header values</strong>: Point into parsed message buffer</li>
<li class=""><strong>String views</strong>: Use pointer+length without allocating new strings</li>
</ul>
<p>This significantly reduces memory usage and improves cache efficiency.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="communication-and-protocols">Communication and Protocols<a href="#communication-and-protocols" class="hash-link" aria-label="Direct link to Communication and Protocols" title="Direct link to Communication and Protocols" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="http-protocol">HTTP Protocol<a href="#http-protocol" class="hash-link" aria-label="Direct link to HTTP Protocol" title="Direct link to HTTP Protocol" translate="no">​</a></h3>
<p>Rspamd uses HTTP as its primary protocol. See <a class="" href="/docs.rspamd.com/branches/master/developers/protocol">Protocol Documentation</a> for details.</p>
<p><strong>Request flow:</strong></p>
<ol>
<li class="">Client sends POST request with message body</li>
<li class="">HTTP headers contain metadata (IP, envelope, etc.)</li>
<li class="">Rspamd processes message</li>
<li class="">Returns JSON response with results</li>
</ol>
<p><strong>Compression:</strong></p>
<p>Supports <code>zstd</code> compression for large messages:</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /checkv2 HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Encoding: zstd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flags: zstd</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="httpcrypt-encryption">HTTPCrypt Encryption<a href="#httpcrypt-encryption" class="hash-link" aria-label="Direct link to HTTPCrypt Encryption" title="Direct link to HTTPCrypt Encryption" translate="no">​</a></h3>
<p>For secure communication, Rspamd supports the HTTPCrypt protocol. See <a class="" href="/docs.rspamd.com/branches/master/developers/encryption">Encryption Documentation</a> for complete details.</p>
<p><strong>Key features:</strong></p>
<ul>
<li class="">X25519 key exchange with forward secrecy</li>
<li class="">XChaCha20-Poly1305 authenticated encryption</li>
<li class="">Ephemeral keys per connection</li>
<li class="">Base32-encoded key identification</li>
</ul>
<p><strong>Usage:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Generate keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm keypair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Configure in worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker &quot;normal&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bind_socket = &quot;*:11333&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keypair {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pubkey = &quot;...&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        privkey = &quot;...&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="inter-process-communication">Inter-Process Communication<a href="#inter-process-communication" class="hash-link" aria-label="Direct link to Inter-Process Communication" title="Direct link to Inter-Process Communication" translate="no">​</a></h3>
<p>Workers communicate via:</p>
<ol>
<li class=""><strong>Shared memory</strong>: For statistics and counters (read-only)</li>
<li class=""><strong>Control socket</strong>: Commands from main process to workers</li>
<li class=""><strong>Redis</strong>: Shared state across workers and instances</li>
</ol>
<p>Workers are <strong>isolated</strong> - no direct IPC between worker processes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-system">Configuration System<a href="#configuration-system" class="hash-link" aria-label="Direct link to Configuration System" title="Direct link to Configuration System" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ucl-format">UCL Format<a href="#ucl-format" class="hash-link" aria-label="Direct link to UCL Format" title="Direct link to UCL Format" translate="no">​</a></h3>
<p>Rspamd uses <strong>UCL (Universal Configuration Language)</strong>:</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Comments start with #</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Simple values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:rgb(222, 71, 0)">key</span><span class="token directive"> = </span><span class="token directive string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:rgb(222, 71, 0)">number</span><span class="token directive"> = </span><span class="token directive number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:rgb(222, 71, 0)">boolean</span><span class="token directive"> = true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Objects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:rgb(222, 71, 0)">section</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:rgb(222, 71, 0)">nested_key</span><span class="token directive"> = </span><span class="token directive string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Arrays</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:rgb(222, 71, 0)">list</span><span class="token directive"> = [</span><span class="token directive string" style="color:#e3116c">&quot;item1&quot;</span><span class="token directive">, </span><span class="token directive string" style="color:#e3116c">&quot;item2&quot;</span><span class="token directive">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Includes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.include &quot;$CONFDIR/local.d/rspamd.local.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Macros</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.define MY_VAR &quot;value&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.define MY_LIST [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span><br></span></code></pre></div></div>
<p><strong>Features:</strong></p>
<ul>
<li class="">Nginx-like syntax (familiar to sysadmins)</li>
<li class="">Comments and macros</li>
<li class="">Includes with priority and merge modes</li>
<li class="">Type validation</li>
<li class="">Variable substitution</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-override">Configuration Override<a href="#configuration-override" class="hash-link" aria-label="Direct link to Configuration Override" title="Direct link to Configuration Override" translate="no">​</a></h3>
<p>Rspamd supports layered configuration:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/etc/rspamd/rspamd.conf              [base]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── /etc/rspamd/modules.d/*.conf [module defaults]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── /etc/rspamd/local.d/*.conf   [local overrides - merge]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── /etc/rspamd/override.d/*.conf [local overrides - replace]</span><br></span></code></pre></div></div>
<p><strong>Override modes:</strong></p>
<ul>
<li class=""><strong>local.d</strong>: Merges with existing configuration (recommended)</li>
<li class=""><strong>override.d</strong>: Completely replaces section (for advanced users)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="runtime-reloading">Runtime Reloading<a href="#runtime-reloading" class="hash-link" aria-label="Direct link to Runtime Reloading" title="Direct link to Runtime Reloading" translate="no">​</a></h3>
<p>Rspamd supports configuration reload without restart:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Send HUP signal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">killall -HUP rspamd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Or via rspamadm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamadm configtest  # Test config first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl reload rspamd</span><br></span></code></pre></div></div>
<p><strong>Reload process:</strong></p>
<ol>
<li class="">Main process receives SIGHUP</li>
<li class="">Parses new configuration</li>
<li class="">Validates configuration</li>
<li class="">Spawns new workers with new config</li>
<li class="">Waits for old workers to finish current tasks</li>
<li class="">Terminates old workers</li>
<li class="">Old workers drain connections gracefully</li>
</ol>
<p>No messages are dropped during reload.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-architecture">Performance Architecture<a href="#performance-architecture" class="hash-link" aria-label="Direct link to Performance Architecture" title="Direct link to Performance Architecture" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rule-scheduling">Rule Scheduling<a href="#rule-scheduling" class="hash-link" aria-label="Direct link to Rule Scheduling" title="Direct link to Rule Scheduling" translate="no">​</a></h3>
<p>Rspamd optimizes rule execution through intelligent scheduling:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="priority-based-execution">Priority-Based Execution<a href="#priority-based-execution" class="hash-link" aria-label="Direct link to Priority-Based Execution" title="Direct link to Priority-Based Execution" translate="no">​</a></h4>
<p>Rules with higher priority execute first:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;CRITICAL_CHECK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> high</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Numeric value, higher = earlier</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback_fn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Priority guidelines:</strong></p>
<ul>
<li class=""><strong>High priority</strong>: Fast rules that can short-circuit processing</li>
<li class=""><strong>Normal priority</strong>: Standard checks</li>
<li class=""><strong>Low priority</strong>: Expensive rules, run only if needed</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="frequency-optimization">Frequency Optimization<a href="#frequency-optimization" class="hash-link" aria-label="Direct link to Frequency Optimization" title="Direct link to Frequency Optimization" translate="no">​</a></h4>
<p>Frequently-triggered rules are cached and optimized:</p>
<ul>
<li class="">Hot rules kept in CPU cache</li>
<li class="">Common patterns compiled to bytecode</li>
<li class="">Regex compiled and cached</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="early-termination">Early Termination<a href="#early-termination" class="hash-link" aria-label="Direct link to Early Termination" title="Direct link to Early Termination" translate="no">​</a></h4>
<p>If score exceeds reject threshold significantly, remaining rules may be skipped:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">set_flag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;skip_process&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Stop processing</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="caching-strategy">Caching Strategy<a href="#caching-strategy" class="hash-link" aria-label="Direct link to Caching Strategy" title="Direct link to Caching Strategy" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="redis-caching">Redis Caching<a href="#redis-caching" class="hash-link" aria-label="Direct link to Redis Caching" title="Direct link to Redis Caching" translate="no">​</a></h4>
<p>Used for:</p>
<ul>
<li class="">Bayesian statistics</li>
<li class="">Neural network models</li>
<li class="">Reputation data</li>
<li class="">Greylisting state</li>
<li class="">Rate limiting counters</li>
</ul>
<p><strong>Connection pooling:</strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">redis</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost:6379&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 1s</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Connection pool settings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_connections </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    idle_timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 60s</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="dns-caching">DNS Caching<a href="#dns-caching" class="hash-link" aria-label="Direct link to DNS Caching" title="Direct link to DNS Caching" translate="no">​</a></h4>
<p>Built-in DNS cache reduces external queries:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">dns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> 1s</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retransmits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Cache settings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache_ttl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="negative-caching">Negative Caching<a href="#negative-caching" class="hash-link" aria-label="Direct link to Negative Caching" title="Direct link to Negative Caching" translate="no">​</a></h4>
<p>Failed lookups are cached to avoid repeated queries:</p>
<ul>
<li class="">DNS NXDOMAIN responses</li>
<li class="">Redis connection failures</li>
<li class="">RBL timeout results</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="connection-pooling">Connection Pooling<a href="#connection-pooling" class="hash-link" aria-label="Direct link to Connection Pooling" title="Direct link to Connection Pooling" translate="no">​</a></h3>
<p>Rspamd maintains connection pools for:</p>
<ol>
<li class=""><strong>Redis connections</strong>: Per-worker pool with configurable size</li>
<li class=""><strong>HTTP connections</strong>: Reused for external service calls</li>
<li class=""><strong>DNS sockets</strong>: Shared across all queries</li>
</ol>
<p>This reduces connection overhead and improves latency.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="security-architecture">Security Architecture<a href="#security-architecture" class="hash-link" aria-label="Direct link to Security Architecture" title="Direct link to Security Architecture" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="process-isolation">Process Isolation<a href="#process-isolation" class="hash-link" aria-label="Direct link to Process Isolation" title="Direct link to Process Isolation" translate="no">​</a></h3>
<p>Workers run with minimal privileges:</p>
<ol>
<li class="">Main process starts as root (to bind privileged ports)</li>
<li class="">After binding, drops privileges to <code>_rspamd</code> user</li>
<li class="">Workers inherit non-root privileges</li>
<li class="">Each worker has isolated memory space (no shared memory for processing)</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sandboxing">Sandboxing<a href="#sandboxing" class="hash-link" aria-label="Direct link to Sandboxing" title="Direct link to Sandboxing" translate="no">​</a></h3>
<p>On supported platforms, Rspamd can use:</p>
<ul>
<li class=""><strong>Capsicum</strong> (FreeBSD): Capability-based security</li>
<li class=""><strong>Seccomp</strong> (Linux): Syscall filtering</li>
<li class=""><strong>Pledge</strong> (OpenBSD): Promise-based restrictions</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="input-validation">Input Validation<a href="#input-validation" class="hash-link" aria-label="Direct link to Input Validation" title="Direct link to Input Validation" translate="no">​</a></h3>
<p>All external input is validated:</p>
<ul>
<li class="">HTTP headers parsed with strict validation</li>
<li class="">Message size limits enforced</li>
<li class="">MIME parsing with malformed input handling</li>
<li class="">Configuration validated before application</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="memory-safety">Memory Safety<a href="#memory-safety" class="hash-link" aria-label="Direct link to Memory Safety" title="Direct link to Memory Safety" translate="no">​</a></h3>
<ul>
<li class="">Memory pools prevent leaks and use-after-free</li>
<li class="">Bounds checking on all array accesses</li>
<li class="">String operations use length-aware functions</li>
<li class="">No dynamic SQL - all queries are parameterized</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="extensibility-points">Extensibility Points<a href="#extensibility-points" class="hash-link" aria-label="Direct link to Extensibility Points" title="Direct link to Extensibility Points" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="lua-api">Lua API<a href="#lua-api" class="hash-link" aria-label="Direct link to Lua API" title="Direct link to Lua API" translate="no">​</a></h3>
<p>Comprehensive Lua API provides access to:</p>
<ul>
<li class=""><strong>Message parsing</strong>: Headers, body, MIME parts, attachments</li>
<li class=""><strong>Network operations</strong>: HTTP requests, DNS queries, Redis commands</li>
<li class=""><strong>Symbol manipulation</strong>: Insert, modify, remove symbols</li>
<li class=""><strong>Configuration</strong>: Access and override settings</li>
<li class=""><strong>Utilities</strong>: Cryptography, encoding, hashing, string operations</li>
</ul>
<p>See <a class="" href="/docs.rspamd.com/branches/master/lua/index">Lua API documentation</a> for complete reference.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hooks-and-callbacks">Hooks and Callbacks<a href="#hooks-and-callbacks" class="hash-link" aria-label="Direct link to Hooks and Callbacks" title="Direct link to Hooks and Callbacks" translate="no">​</a></h3>
<p>Modules can register callbacks for various events:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Pre-filter: runs before main processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_pre_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Symbol: main processing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SYM&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Post-filter: runs after all rules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_post_filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Idempotent: runs after all other processing (filters, post-filters, composites)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_symbol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SYM&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;idempotent&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="external-service-integration">External Service Integration<a href="#external-service-integration" class="hash-link" aria-label="Direct link to External Service Integration" title="Direct link to External Service Integration" translate="no">​</a></h3>
<p>Easy integration with external services:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">check_external_service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">not</span><span class="token plain"> err </span><span class="token keyword" style="color:rgb(222, 71, 0)">and</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">-- Process response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parse_json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_spam </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">insert_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;EXTERNAL_SPAM&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rspamd_http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://api.example.com/check&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_content</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="monitoring-and-observability">Monitoring and Observability<a href="#monitoring-and-observability" class="hash-link" aria-label="Direct link to Monitoring and Observability" title="Direct link to Monitoring and Observability" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="metrics-export">Metrics Export<a href="#metrics-export" class="hash-link" aria-label="Direct link to Metrics Export" title="Direct link to Metrics Export" translate="no">​</a></h3>
<p>Rspamd exports metrics in OpenMetrics format:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:11334/metrics</span><br></span></code></pre></div></div>
<p><strong>Available metrics:</strong></p>
<ul>
<li class="">Message processing rates</li>
<li class="">Action distribution (reject, add header, etc.)</li>
<li class="">Module-specific statistics</li>
<li class="">Resource usage (memory, connections)</li>
<li class="">Latency histograms</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="logging">Logging<a href="#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging" translate="no">​</a></h3>
<p>Structured logging with multiple levels:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">logging</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/log/rspamd/rspamd.log&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    level </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Log format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_format </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">#</span><span class="token plain"> Colored output </span><span class="token keyword" style="color:rgb(222, 71, 0)">for</span><span class="token plain"> console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_color </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> yes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Log levels:</strong></p>
<ul>
<li class=""><code>error</code>: Critical errors only</li>
<li class=""><code>warning</code>: Important issues</li>
<li class=""><code>info</code>: Normal operations (default)</li>
<li class=""><code>debug</code>: Verbose debugging</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="history">History<a href="#history" class="hash-link" aria-label="Direct link to History" title="Direct link to History" translate="no">​</a></h3>
<p>Recent scan results are stored in memory (or Redis):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Via HTTP API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:11334/history</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Via rspamc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc history</span><br></span></code></pre></div></div>
<p>Useful for debugging and auditing.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="scalability-and-deployment-patterns">Scalability and Deployment Patterns<a href="#scalability-and-deployment-patterns" class="hash-link" aria-label="Direct link to Scalability and Deployment Patterns" title="Direct link to Scalability and Deployment Patterns" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="vertical-scaling">Vertical Scaling<a href="#vertical-scaling" class="hash-link" aria-label="Direct link to Vertical Scaling" title="Direct link to Vertical Scaling" translate="no">​</a></h3>
<p>Single-machine scaling:</p>
<ul>
<li class=""><strong>Worker count</strong>: 1-4 workers per CPU core</li>
<li class=""><strong>Memory</strong>: 256-512 MB per worker typical</li>
<li class=""><strong>Connections</strong>: Thousands per worker with async I/O</li>
</ul>
<p><strong>Recommended:</strong> Start with <code>count = num_cpus</code> and tune based on load.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="horizontal-scaling">Horizontal Scaling<a href="#horizontal-scaling" class="hash-link" aria-label="Direct link to Horizontal Scaling" title="Direct link to Horizontal Scaling" translate="no">​</a></h3>
<p>Multi-machine deployment patterns:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-proxy-based-load-balancing">1. Proxy-Based Load Balancing<a href="#1-proxy-based-load-balancing" class="hash-link" aria-label="Direct link to 1. Proxy-Based Load Balancing" title="Direct link to 1. Proxy-Based Load Balancing" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">              ┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              │     MTA      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              └──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              │ Rspamd Proxy │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              │  (mirror: Y) │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              └──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ┏━━━━━━━━━━━┻━━━━━━━━━━━┓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ▼ (master)              ▼ (mirror)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ┌─────────────┐          ┌─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │  Rspamd 1   │          │  Rspamd 2   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │  (normal)   │          │  (normal)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └─────────────┘          └─────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         └────────┬───────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ┌─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           │    Redis    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           └─────────────┘</span><br></span></code></pre></div></div>
<p><strong>Note:</strong> Proxy can be configured for load balancing or mirroring:</p>
<ul>
<li class=""><strong>Load balancing</strong>: Distributes requests (default)</li>
<li class=""><strong>Mirroring</strong>: Sends requests to all backends, uses first response</li>
</ul>
<p><strong>Pros:</strong></p>
<ul>
<li class="">Simple setup</li>
<li class="">Rspamd proxy handles load balancing</li>
<li class="">Automatic failover</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li class="">Proxy is single point of failure (can be replicated)</li>
<li class="">Additional network hop</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-dns-round-robin">2. DNS Round-Robin<a href="#2-dns-round-robin" class="hash-link" aria-label="Direct link to 2. DNS Round-Robin" title="Direct link to 2. DNS Round-Robin" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">         ┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │     MTA      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         └──────┬───────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         DNS: rspamd.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         → 10.0.1.1, 10.0.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ┏━━━━━━━━━━━┻━━━━━━━━━━━┓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ▼                        ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────┐      ┌─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Rspamd 1   │      │  Rspamd 2   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 10.0.1.1    │      │ 10.0.1.2    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────┘      └─────────────┘</span><br></span></code></pre></div></div>
<p><strong>Pros:</strong></p>
<ul>
<li class="">No single point of failure</li>
<li class="">Simple, no proxy needed</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li class="">Client must implement failover</li>
<li class="">No session affinity</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-hardware-load-balancer">3. Hardware Load Balancer<a href="#3-hardware-load-balancer" class="hash-link" aria-label="Direct link to 3. Hardware Load Balancer" title="Direct link to 3. Hardware Load Balancer" translate="no">​</a></h4>
<p>Use HAProxy, nginx, or hardware LB:</p>
<p><strong>Pros:</strong></p>
<ul>
<li class="">Enterprise-grade reliability</li>
<li class="">Advanced features (SSL termination, health checks)</li>
<li class="">Session affinity if needed</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li class="">Additional component to manage</li>
<li class="">More complex setup</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="shared-state">Shared State<a href="#shared-state" class="hash-link" aria-label="Direct link to Shared State" title="Direct link to Shared State" translate="no">​</a></h3>
<p>For multi-instance deployments, use Redis for:</p>
<ul>
<li class="">Bayesian statistics</li>
<li class="">Neural network models</li>
<li class="">Greylisting</li>
<li class="">Ratelimiting</li>
<li class="">Reputation</li>
</ul>
<p>All instances must connect to same Redis (or Redis cluster).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary" translate="no">​</a></h2>
<p>Rspamd&#x27;s architecture provides:</p>
<ul>
<li class=""><strong>High performance</strong> through event-driven, non-blocking I/O</li>
<li class=""><strong>Scalability</strong> via multi-process model and horizontal scaling</li>
<li class=""><strong>Flexibility</strong> through comprehensive Lua API and plugin system</li>
<li class=""><strong>Reliability</strong> with process isolation and graceful degradation</li>
<li class=""><strong>Security</strong> via sandboxing, input validation, and memory safety</li>
<li class=""><strong>Maintainability</strong> through modular design and runtime reloading</li>
</ul>
<p>This design allows Rspamd to handle millions of messages per day on modest hardware while remaining extensible and easy to customize.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Direct link to Further Reading" title="Direct link to Further Reading" translate="no">​</a></h2>
<ul>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/developers/protocol">Protocol Documentation</a> - HTTP/JSON protocol details</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/developers/encryption">Encryption Documentation</a> - HTTPCrypt encryption protocol</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/developers/sync_async">Sync/Async Model</a> - Deep dive into async processing</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/developers/writing_rules">Writing Rules</a> - Guide to creating custom rules</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/lua/index">Lua API Reference</a> - Complete API documentation</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/developers/architecture.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/master/lua/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lua API documentation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/master/developers/architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Rspamd Architecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#process-model" class="table-of-contents__link toc-highlight">Process Model</a><ul><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#main-process" class="table-of-contents__link toc-highlight">Main Process</a></li><li><a href="#worker-types" class="table-of-contents__link toc-highlight">Worker Types</a></li></ul></li><li><a href="#event-driven-architecture" class="table-of-contents__link toc-highlight">Event-Driven Architecture</a><ul><li><a href="#event-loop" class="table-of-contents__link toc-highlight">Event Loop</a></li><li><a href="#non-blocking-io" class="table-of-contents__link toc-highlight">Non-Blocking I/O</a></li><li><a href="#asynchronous-session-lifecycle" class="table-of-contents__link toc-highlight">Asynchronous Session Lifecycle</a></li></ul></li><li><a href="#message-processing-pipeline" class="table-of-contents__link toc-highlight">Message Processing Pipeline</a><ul><li><a href="#high-level-flow" class="table-of-contents__link toc-highlight">High-Level Flow</a></li><li><a href="#task-object" class="table-of-contents__link toc-highlight">Task Object</a></li><li><a href="#processing-phases" class="table-of-contents__link toc-highlight">Processing Phases</a></li><li><a href="#async-session-management" class="table-of-contents__link toc-highlight">Async Session Management</a></li></ul></li><li><a href="#module-system" class="table-of-contents__link toc-highlight">Module System</a><ul><li><a href="#module-architecture" class="table-of-contents__link toc-highlight">Module Architecture</a></li><li><a href="#c-modules" class="table-of-contents__link toc-highlight">C Modules</a></li><li><a href="#lua-modules" class="table-of-contents__link toc-highlight">Lua Modules</a></li><li><a href="#virtual-modules" class="table-of-contents__link toc-highlight">Virtual Modules</a></li><li><a href="#rule-modules" class="table-of-contents__link toc-highlight">Rule Modules</a></li></ul></li><li><a href="#symbol-and-score-system" class="table-of-contents__link toc-highlight">Symbol and Score System</a><ul><li><a href="#symbol-registration" class="table-of-contents__link toc-highlight">Symbol Registration</a></li><li><a href="#symbol-dependencies" class="table-of-contents__link toc-highlight">Symbol Dependencies</a></li><li><a href="#score-calculation" class="table-of-contents__link toc-highlight">Score Calculation</a></li><li><a href="#metric-groups" class="table-of-contents__link toc-highlight">Metric Groups</a></li></ul></li><li><a href="#statistical-modules" class="table-of-contents__link toc-highlight">Statistical Modules</a><ul><li><a href="#bayesian-classifier" class="table-of-contents__link toc-highlight">Bayesian Classifier</a></li><li><a href="#neural-networks-plugin" class="table-of-contents__link toc-highlight">Neural Networks Plugin</a></li><li><a href="#fuzzy-hashes" class="table-of-contents__link toc-highlight">Fuzzy Hashes</a></li></ul></li><li><a href="#memory-management" class="table-of-contents__link toc-highlight">Memory Management</a><ul><li><a href="#memory-pools" class="table-of-contents__link toc-highlight">Memory Pools</a></li><li><a href="#zero-copy-operations" class="table-of-contents__link toc-highlight">Zero-Copy Operations</a></li></ul></li><li><a href="#communication-and-protocols" class="table-of-contents__link toc-highlight">Communication and Protocols</a><ul><li><a href="#http-protocol" class="table-of-contents__link toc-highlight">HTTP Protocol</a></li><li><a href="#httpcrypt-encryption" class="table-of-contents__link toc-highlight">HTTPCrypt Encryption</a></li><li><a href="#inter-process-communication" class="table-of-contents__link toc-highlight">Inter-Process Communication</a></li></ul></li><li><a href="#configuration-system" class="table-of-contents__link toc-highlight">Configuration System</a><ul><li><a href="#ucl-format" class="table-of-contents__link toc-highlight">UCL Format</a></li><li><a href="#configuration-override" class="table-of-contents__link toc-highlight">Configuration Override</a></li><li><a href="#runtime-reloading" class="table-of-contents__link toc-highlight">Runtime Reloading</a></li></ul></li><li><a href="#performance-architecture" class="table-of-contents__link toc-highlight">Performance Architecture</a><ul><li><a href="#rule-scheduling" class="table-of-contents__link toc-highlight">Rule Scheduling</a></li><li><a href="#caching-strategy" class="table-of-contents__link toc-highlight">Caching Strategy</a></li><li><a href="#connection-pooling" class="table-of-contents__link toc-highlight">Connection Pooling</a></li></ul></li><li><a href="#security-architecture" class="table-of-contents__link toc-highlight">Security Architecture</a><ul><li><a href="#process-isolation" class="table-of-contents__link toc-highlight">Process Isolation</a></li><li><a href="#sandboxing" class="table-of-contents__link toc-highlight">Sandboxing</a></li><li><a href="#input-validation" class="table-of-contents__link toc-highlight">Input Validation</a></li><li><a href="#memory-safety" class="table-of-contents__link toc-highlight">Memory Safety</a></li></ul></li><li><a href="#extensibility-points" class="table-of-contents__link toc-highlight">Extensibility Points</a><ul><li><a href="#lua-api" class="table-of-contents__link toc-highlight">Lua API</a></li><li><a href="#hooks-and-callbacks" class="table-of-contents__link toc-highlight">Hooks and Callbacks</a></li><li><a href="#external-service-integration" class="table-of-contents__link toc-highlight">External Service Integration</a></li></ul></li><li><a href="#monitoring-and-observability" class="table-of-contents__link toc-highlight">Monitoring and Observability</a><ul><li><a href="#metrics-export" class="table-of-contents__link toc-highlight">Metrics Export</a></li><li><a href="#logging" class="table-of-contents__link toc-highlight">Logging</a></li><li><a href="#history" class="table-of-contents__link toc-highlight">History</a></li></ul></li><li><a href="#scalability-and-deployment-patterns" class="table-of-contents__link toc-highlight">Scalability and Deployment Patterns</a><ul><li><a href="#vertical-scaling" class="table-of-contents__link toc-highlight">Vertical Scaling</a></li><li><a href="#horizontal-scaling" class="table-of-contents__link toc-highlight">Horizontal Scaling</a></li><li><a href="#shared-state" class="table-of-contents__link toc-highlight">Shared State</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog">Blog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Subscribe</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/rss/changelog.xml">Changelog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/rss.xml">Blog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/atom.xml">Blog Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>