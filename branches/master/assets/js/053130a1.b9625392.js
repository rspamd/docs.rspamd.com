"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[1825],{1072:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>r,contentTitle:()=>i,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"modules/clickhouse","title":"Clickhouse module","description":"{:.no_toc}","source":"@site/docs/modules/clickhouse.md","sourceDirName":"modules","slug":"/modules/clickhouse","permalink":"/docs.rspamd.com/branches/master/modules/clickhouse","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/clickhouse.md","tags":[],"version":"current","frontMatter":{"title":"Clickhouse module"},"sidebar":"docs","previous":{"title":"Chartable module","permalink":"/docs.rspamd.com/branches/master/modules/chartable"},"next":{"title":"DCC module","permalink":"/docs.rspamd.com/branches/master/modules/dcc"}}');var o=n(4848),a=n(8453);const l={title:"Clickhouse module"},i="Clickhouse module",r={},c=[{value:"Module Configuration",id:"module-configuration",level:2},{value:"Main options",id:"main-options",level:4},{value:"Other options:",id:"other-options",level:4},{value:"Limits section (from Rspamd 2.1):",id:"limits-section-from-rspamd-21",level:4},{value:"Clickhouse retention",id:"clickhouse-retention",level:3},{value:"Subject privacy",id:"subject-privacy",level:3},{value:"Extra columns",id:"extra-columns",level:3},{value:"Clickhouse usage examples",id:"clickhouse-usage-examples",level:2},{value:"URLs storage",id:"urls-storage",level:2}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"clickhouse-module",children:"Clickhouse module"})}),"\n",(0,o.jsx)(s.p,{children:"{:.no_toc}"}),"\n",(0,o.jsxs)(s.p,{children:["The Clickhouse module pushes a range of message-related metadata to an instance of ",(0,o.jsx)(s.a,{href:"https://clickhouse.yandex/",children:"Clickhouse"}),", an open-source column-oriented database management system for real-time analytics. Information that could be collected includes: senders/recipients/scores of scanned messages and metadata such as DKIM/DMARC/bayes/fuzzy status & information about URLs and attachments."]}),"\n",(0,o.jsxs)(s.p,{children:["Additionally, this module enables you to construct your custom analytical dashboard using ",(0,o.jsx)(s.a,{href:"https://redash.io",children:"Redash"}),", similar to using Elastic and Kibana."]}),"\n",(0,o.jsx)(s.h2,{id:"module-configuration",children:"Module Configuration"}),"\n",(0,o.jsx)(s.p,{children:"Example configuration shown below, for the minimum working configuration you need to define Clickhouse servers:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-hcl",children:"# local.d/clickhouse.conf\n\n# Push update when 1000 records are collected (1000 if unset) (until 2.1, see limits section below for >2.1)\nlimit = 1000;\n# IP:port of Clickhouse server (\"localhost:8123\" if unset)\nserver = \"localhost:8123\";\n# Timeout to wait for response (5 seconds if unset)\ntimeout = 5;\n# How many bits of sending IP to mask in logs for IPv4 (19 if unset)\nipmask = 19;\n# How many bits of sending IP to mask in logs for IPv6 (48 if unset)\nipmask6 = 48;\n# Record URL paths? (default false)\nfull_urls = false;\n# This parameter points to a map of domain names\n# If a message has a domain in this map in From: header and DKIM signature,\n# record general metadata in a table named after the domain\n#from_tables = \"/etc/rspamd/clickhouse_from.map\";\n# store digest/hash of email (default false)\nenable_digest = false;\n# store Symbols.Names, Symbols.Scores, Symbols.Options, Groups.Names and Groups.Scores (default false)\nenable_symbols = false;\n# These are symbols of other checks in Rspamd\n# Set these if you use non-default symbol names (unlikely)\n#bayes_spam_symbols = [\"BAYES_SPAM\"];\n#bayes_ham_symbols = [\"BAYES_HAM\"];\n#ann_symbols_spam = {'NEURAL_SPAM'},\n#ann_symbols_ham = {'NEURAL_HAM'},\n#fuzzy_symbols = [\"FUZZY_DENIED\"];\n#whitelist_symbols = [\"WHITELIST_DKIM\", \"WHITELIST_SPF_DKIM\", \"WHITELIST_DMARC\"];\n#dkim_allow_symbols = [\"R_DKIM_ALLOW\"];\n#dkim_reject_symbols = [\"R_DKIM_REJECT\"];\n#dkim_dnsfail_symbols = {'R_DKIM_TEMPFAIL', 'R_DKIM_PERMFAIL'},\n#dkim_na_symbols = {'R_DKIM_NA'},\n#dmarc_allow_symbols = {'DMARC_POLICY_ALLOW'},\n#dmarc_reject_symbols = {'DMARC_POLICY_REJECT'},\n#dmarc_quarantine_symbols = {'DMARC_POLICY_QUARANTINE'},\n#dmarc_softfail_symbols = {'DMARC_POLICY_SOFTFAIL'},\n#dmarc_na_symbols = {'DMARC_NA'},\n#spf_allow_symbols = {'R_SPF_ALLOW'},\n#spf_reject_symbols = {'R_SPF_FAIL'},\n#spf_dnsfail_symbols = {'R_SPF_DNSFAIL', 'R_SPF_PERMFAIL'},\n#spf_neutral_symbols = {'R_DKIM_TEMPFAIL', 'R_DKIM_PERMFAIL'},\n#spf_na_symbols = {'R_SPF_NA'},\n# Subject related (from 1.9)\ninsert_subject = false; \n# Privacy is off\nsubject_privacy = false; \n# Default hash-algorithm to obfuscate subject\nsubject_privacy_alg = 'blake2';\n# Prefix to show it's obfuscated\nsubject_privacy_prefix = 'obf';\n# Cut the length of the hash\nsubject_privacy_length = 16;\n\n# Other options\n#database = 'default';\n#use_https = false;\n# Transport compression\n#use_gzip = true;\n# Store data for local scanes\n#allow_local = false;\n# Basic auth\n#user = null;\n#password = null;\n# Disable SSL verification\n#no_ssl_verify = false,\n\n# This section configures how long the data will be stored in ClickHouse\n#retention {\n#  # disabled by default\n#  enable = true;\n#  # drop | detach, please refer to ClickHouse docs for details\n#  # https://clickhouse.com/docs/en/sql-reference/statements/alter/partition\n#  method = \"drop\";\n#  # how many month the data should be kept in ClickHouse\n#  period_months = 3;\n#  # how often run the cleanup process\n#  run_every = 7d;\n#}\n# This section defines how often Rspamd will send data to Clickhouse (from 2.1)\n#limits {\n#  max_rows = 1000; # How many rows are allowed (0 for disable this)\n#  max_memory = 50mb; # How many memory should be occupied before sending collection\n#  max_interval = 60s; # Maximum collection interval\n#}\n"})}),"\n",(0,o.jsx)(s.h4,{id:"main-options",children:"Main options"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"limit = 1000;"}),": Set the push update limit to 1000 records (default is 1000)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:'server = "localhost:8123";'}),': Set the ClickHouse server\'s IP and port (default is "localhost:8123").']}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"timeout = 5;"}),": Set the timeout for waiting for a response (default is 5 seconds)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"ipmask = 19;"}),": Set the number of bits to mask in logs for IPv4 sender IPs (default is 19)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"ipmask6 = 48;"}),": Set the number of bits to mask in logs for IPv6 sender IPs (default is 48)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"full_urls = false;"}),": Disable recording URL paths (default is false)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"from_tables"}),": (Commented) Points to a map of domain names to record general metadata in a table named after the domain."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"enable_digest = false;"}),": Disable storing the email's digest/hash (default is false)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"enable_symbols = false;"}),": Disable storing Symbols.Names, Symbols.Scores, Symbols.Options, Groups.Names, and Groups.Scores (default is false)."]}),"\n"]}),"\n",(0,o.jsx)(s.h4,{id:"other-options",children:"Other options:"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"database"}),": Set the ClickHouse database name to be used for storing data (default is 'default')."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"use_https"}),": Set this option to 'true' to enable HTTPS communication with the ClickHouse server (default is 'false')."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"use_gzip"}),": Set this option to 'true' to enable transport compression when sending data to the ClickHouse server (default is 'false')."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"allow_local"}),": Set this option to 'true' to store data for local scans (default is 'false')."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"user"}),": Set the username for basic authentication when connecting to the ClickHouse server (default is 'null', which means no authentication)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"password"}),": Set the password for basic authentication when connecting to the ClickHouse server (default is 'null', which means no authentication)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"no_ssl_verify"}),": Set this option to 'true' to disable SSL certificate verification when connecting to the ClickHouse server over HTTPS (default is 'false', which means SSL certificate verification is enabled)."]}),"\n"]}),"\n",(0,o.jsx)(s.h4,{id:"limits-section-from-rspamd-21",children:"Limits section (from Rspamd 2.1):"}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"max_rows"}),": Set the maximum number of rows allowed before sending the collected data to the ClickHouse server. If this limit is reached, the data will be sent immediately. A value of 0 disables this limit (default is not set)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"max_memory"}),": Set the maximum amount of memory the collected data should occupy before sending it to the ClickHouse server. If this memory limit is reached, the data will be sent immediately. Use a value with a unit like '50mb' or '1gb' (default is not set)."]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"max_interval"}),": Set the maximum time interval between sending collected data to the ClickHouse server. After this interval is reached, the data will be sent regardless of the number of rows or the amount of memory occupied. Use a value with a unit like '60s', '5m', or '1h' (default is not set)."]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"These options allow you to control how often Rspamd sends data to the ClickHouse server based on the number of rows, memory usage, and time interval. By configuring these limits, you can optimize the performance and resource usage of your Rspamd and ClickHouse instances."}),"\n",(0,o.jsx)(s.h3,{id:"clickhouse-retention",children:"Clickhouse retention"}),"\n",(0,o.jsxs)(s.p,{children:["Privacy is a crucial consideration in many email systems. The Clickhouse dumps may contain sensitive client data. Rspamd supports automatic cleanup of the outdated data using ",(0,o.jsx)(s.strong,{children:"retention policies"}),". By default, data is not expired in Clickhouse, but expiration can be set to comply with regulations such as the General Data Protection Regulation (GDPR) as follows:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\nretention {\n  enable = true;\n  # drop | detach, please refer to ClickHouse docs for details\n  # https://clickhouse.com/docs/en/sql-reference/statements/alter/partition\n  method = "drop";\n  # how many month the data should be kept in ClickHouse\n  period_months = 3;\n  # how often run the cleanup process\n  run_every = 7d;\n}\n'})}),"\n",(0,o.jsxs)(s.p,{children:["To remove data for particular users, you might consider using of the ",(0,o.jsx)(s.a,{href:"https://clickhouse.com/docs/en/sql-reference/statements/alter#mutations",children:"Clickhouse mutations"})]}),"\n",(0,o.jsx)(s.h3,{id:"subject-privacy",children:"Subject privacy"}),"\n",(0,o.jsx)(s.p,{children:"Similarly to previous, from the version 1.9, you can store email subject in Clickhouse (disabled by default). The following settings are available:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-hcl",children:"insert_subject = false; \n# Privacy is off\nsubject_privacy = false; \n# Default hash-algorithm to obfuscate subject\nsubject_privacy_alg = 'blake2';\n# Prefix to show it's obfuscated\nsubject_privacy_prefix = 'obf';\n# Cut the length of the hash\nsubject_privacy_length = 16;\n"})}),"\n",(0,o.jsx)(s.p,{children:"You can use obfuscated subjects to group messages with a same subject for example."}),"\n",(0,o.jsx)(s.h3,{id:"extra-columns",children:"Extra columns"}),"\n",(0,o.jsx)(s.p,{children:"You can also extract additional data and add it to a set of extra columns. This feature is available from the version Rspamd 2.4 and Clickhouse 19.3."}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-hcl",children:'# local.d/clickhouse.conf\n\nextra_columns = {\n        Mime_From = {\n                selector = "from(\'mime\'):addr";\n                type = "String";\n                # this is the returning answer if the value is null \n                default_value = "none";\n                comment = "Mime from column";\n        }\n        Mime_Rcpt = {\n                selector = "rcpts(\'mime\'):addr";\n                type = "Array(String)";\n        }\n}\n'})}),"\n",(0,o.jsx)(s.h2,{id:"clickhouse-usage-examples",children:"Clickhouse usage examples"}),"\n",(0,o.jsx)(s.p,{children:"Clickhouse module is extremely useful to perform statistical researches for mail flows. For example, to find top sending domains for spam and ham:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n    From,\n    count() AS c\nFROM rspamd\nWHERE (Date = today()) AND ((Action = 'reject') OR (Action = 'add header'))\nGROUP BY From\nORDER BY c DESC\nLIMIT 10\n\n\u250c\u2500From\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500c\u2500\u2510\n\u2502 xxx.com         \u2502 152931 \u2502\n\u2502 xxx.com         \u2502 102123 \u2502\n\u2502 gmail.com       \u2502  60865 \u2502\n\u2502 yahoo.com       \u2502  58832 \u2502\n\u2502 xxx.com         \u2502  58082 \u2502\n...\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsx)(s.p,{children:"Or messages with failed DKIM and DMARC groupped by domain:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n    From,\n    IP,\n    count() AS c\nFROM rspamd\nWHERE (Date = today()) AND (IsDkim = 'reject')\nGROUP BY\n    From,\n    IP\nORDER BY c DESC\nLIMIT 10\n\n\u250c\u2500From\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500IP\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500c\u2500\u2510\n\u2502 xxx.xxx              \u2502 xx.xx.xx.xx    \u2502 27542 \u2502\n\u2502 xxx.xxx              \u2502 xx.yy.yy.yy    \u2502 24958 \u2502\n...\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsx)(s.p,{children:"Or perform some attachments analysis (e.g. top attachments types for Spam):"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n    count() AS c,\n    d\nFROM rspamd\nARRAY JOIN Attachments.ContentType AS d\nWHERE (Date = today()) AND ((Action = 'reject') OR (Action = 'add header'))\nGROUP BY d\nORDER BY c DESC\nLIMIT 5\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500c\u2500\u252c\u2500d\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ddd    \u2502 image/jpeg               \u2502\n\u2502 ddd    \u2502 image/png                \u2502\n\u2502 ddd    \u2502 application/octet-stream \u2502\n\u2502 ddd    \u2502 image/gif                \u2502\n\u2502 ddd    \u2502 application/msword       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsx)(s.p,{children:"Rspamd also provides the capability to send data copies for specific domains to separate tables, making analytics easier."}),"\n",(0,o.jsx)(s.p,{children:"For mailing lists, Rspamd sends list ids which allows to provide very precise statistics for each particular mailing list:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n    ListId,\n    IP,\n    count() AS c\nFROM rspamd\nWHERE (Date = today()) AND (ListId != '')\nGROUP BY\n    ListId,\n    IP\nORDER BY c DESC\nLIMIT 10\n\n\u250c\u2500ListId\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500IP\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500c\u2500\u2510\n\u2502 xxx                                  \u2502 xx.xx.xx.xx     \u2502 dddd   \u2502\n...\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsxs)(s.p,{children:["Using extra columns (see ",(0,o.jsx)(s.a,{href:"/modules/clickhouse#extra-columns",children:"Configuration"}),")"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n    From,\n    Mime_From,\n    Mime_Rcpt\nFROM rspamd\nWHERE (Date = today())\nGROUP BY From\nORDER BY TS From\nLIMIT 10\n\n\u250c\u2500From\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500Mime_From\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500Mime_Rcpt\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 example@example.com  \u2502 example@example.com   \u2502 ['test@example.com']      \u2502\n\u2502 test@test.com        \u2502 hello@test.com        \u2502 ['no@simple.test.com']    \u2502\n...\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsx)(s.h2,{id:"urls-storage",children:"URLs storage"}),"\n",(0,o.jsxs)(s.p,{children:["This text has been contributed by ",(0,o.jsx)(s.a,{href:"https://github.com/citrin",children:"Anton Yuzhaninov"})]}),"\n",(0,o.jsxs)(s.p,{children:["From version 2.8, Rspamd stores URLs from all sources, together with the corresponding flags.\nTo differentiate different types we've added ",(0,o.jsx)(s.code,{children:"Urls.Flags"})," column which will contain all flags as an integer."]}),"\n",(0,o.jsxs)(s.p,{children:["All currently used bit flags are listed here:\n",(0,o.jsx)(s.a,{href:"https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17",children:"https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17"})]}),"\n",(0,o.jsxs)(s.p,{children:["For example, to exclude ",(0,o.jsx)(s.code,{children:"img_src"})," and ",(0,o.jsx)(s.code,{children:"PDF"})," URLs and keep all other URLs (old behaviour) one needs to exclude Urls where ",(0,o.jsx)(s.code,{children:"bit 19"})," (img) or ",(0,o.jsx)(s.code,{children:"bit 21"})," (content == pdf) are set: ",(0,o.jsx)(s.code,{children:"bitTest(Flags, 19)"}),". If you don't mind having additional urls in ",(0,o.jsx)(s.code,{children:"Urls.Url"})," column you can continue use it as is."]}),"\n",(0,o.jsx)(s.p,{children:"Here are some examples explained:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"The first line (regular_urls) is what has been logged originally;"}),"\n",(0,o.jsx)(s.li,{children:"The second line - urls from html img tag src attribue"}),"\n",(0,o.jsx)(s.li,{children:"The third line - urls extracted by content module; currently, it contains only PDF Urls"}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Numbers ",(0,o.jsx)(s.code,{children:"19"}),", ",(0,o.jsx)(s.code,{children:"21"}),", ",(0,o.jsx)(s.code,{children:"22"})," correspond to flags ",(0,o.jsx)(s.code,{children:"RSPAMD_URL_FLAG_IMAGE"}),", ",(0,o.jsx)(s.code,{children:"RSPAMD_URL_FLAG_CONTENT"}),", ",(0,o.jsx)(s.code,{children:"RSPAMD_URL_FLAG_NO_TLD"}),": ",(0,o.jsx)(s.a,{href:"https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17",children:"https://github.com/rspamd/rspamd/blob/master/src/libserver/url.h#L17"})]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n       MessageId,\n       arrayMap(x -> x.1, arrayFilter(x -> NOT bitTestAny(x.2, 19, 21), arrayZip(Urls.Url, Urls.Flags))) AS regular_urls,\n       arrayMap(x -> x.1, arrayFilter(x -> bitTest(x.2, 19), arrayZip(Urls.Url, Urls.Flags))) AS img_src,\n       arrayMap(x -> x.1, arrayFilter(x -> bitTest(x.2, 21), arrayZip(Urls.Url, Urls.Flags))) AS pdf_urls\nFROM rspamd\nWHERE Date = '2021-02-26'\n      AND arrayExists(x -> bitTestAny(x, 19, 21, 22), Urls.Flags)\nLIMIT 250\n"})}),"\n",(0,o.jsxs)(s.p,{children:["Not all flags are equally interesting, but some are: for example ",(0,o.jsx)(s.code,{children:"bitTest(Urls.Flags, 1)"})," allows much faster select URls with IP than a regexp for ",(0,o.jsx)(s.code,{children:"Urls.Url"}),".\n",(0,o.jsx)(s.code,{children:"Bit 20"})," allows to select for urls that we extract from query args in other urls (e. g. Rspamd extracts ",(0,o.jsx)(s.code,{children:"to.com"})," in ",(0,o.jsx)(s.code,{children:"http://example.com/foo?redirect=http://to.com"}),"):"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"SELECT\n       Urls.Tld,\n       bitTest(Urls.Flags, 0) AS phished,\n       bitTest(Urls.Flags, 1) AS numeric,\n       bitTest(Urls.Flags, 4) AS html_disp,\n       bitTest(Urls.Flags, 5) AS txt,\n       bitTest(Urls.Flags, 6) AS subj,\n       bitTest(Urls.Flags, 13) AS has_port,\n       bitTest(Urls.Flags, 15) AS no_schema,\n       bitTest(Urls.Flags, 16) AS not_norm,\n       bitTest(Urls.Flags, 18) AS disp_url,\n       bitTest(Urls.Flags, 19) AS img_src,\n       bitTest(Urls.Flags, 20) AS from_query,\n       bitTest(Urls.Flags, 21) AS pdf,\n       bitTest(Urls.Flags, 22) AS no_tld,\n       Urls.Flags,\n       Urls.Url\nFROM rspamd ARRAY JOIN Urls\nWHERE Date >= today() - 1 AND TS >= subtractHours(now(), 1)\nAND bitTestAny(Urls.Flags, 19, 21)\nORDER BY TS\nLIMIT 250\n"})})]})}function h(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>i});var t=n(6540);const o={},a=t.createContext(o);function l(e){const s=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);