"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[755],{3558:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>o,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"modules/arc","title":"ARC module","description":"This module verifies and signs ARC (Authenticated Received Chain) signatures and seals for emails. ARC provides a mechanism for preserving email authentication results across trusted intermediaries, which is particularly useful for mailing lists and forwarding services that may modify messages in ways that break SPF and DKIM alignment.","source":"@site/docs/modules/arc.md","sourceDirName":"modules","slug":"/modules/arc","permalink":"/docs.rspamd.com/branches/master/modules/arc","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/arc.md","tags":[],"version":"current","frontMatter":{"title":"ARC module"},"sidebar":"docs","previous":{"title":"Antivirus module","permalink":"/docs.rspamd.com/branches/master/modules/antivirus"},"next":{"title":"ASN module","permalink":"/docs.rspamd.com/branches/master/modules/asn"}}');var d=s(74848),r=s(28453);const l={title:"ARC module"},t="ARC module",c={},a=[{value:"Symbols",id:"symbols",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Basic settings",id:"basic-settings",level:3},{value:"Domain selection",id:"domain-selection",level:3},{value:"Signing eligibility",id:"signing-eligibility",level:3},{value:"Header/envelope validation",id:"headerenvelope-validation",level:3},{value:"Trusted forwarders and whitelisting",id:"trusted-forwarders-and-whitelisting",level:3},{value:"Redis integration",id:"redis-integration",level:3},{value:"Vault integration",id:"vault-integration",level:3},{value:"Public key verification",id:"public-key-verification",level:3},{value:"Authentication results",id:"authentication-results",level:3},{value:"HTTP headers (for proxy integration)",id:"http-headers-for-proxy-integration",level:3},{value:"Basic configuration example",id:"basic-configuration-example",level:2},{value:"Trusted ARC forwarders",id:"trusted-arc-forwarders",level:2},{value:"Handling broken ARC implementations",id:"handling-broken-arc-implementations",level:2},{value:"ARC keys in Redis",id:"arc-keys-in-redis",level:2},{value:"Using maps for selectors and paths",id:"using-maps-for-selectors-and-paths",level:2},{value:"Vault integration",id:"vault-integration-1",level:2},{value:"Sign headers",id:"sign-headers",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"arc-module",children:"ARC module"})}),"\n",(0,d.jsxs)(n.p,{children:["This module verifies and signs ",(0,d.jsx)(n.a,{href:"https://arc-spec.org/",children:"ARC"})," (Authenticated Received Chain) signatures and seals for emails. ARC provides a mechanism for preserving email authentication results across trusted intermediaries, which is particularly useful for mailing lists and forwarding services that may modify messages in ways that break SPF and DKIM alignment."]}),"\n",(0,d.jsxs)(n.p,{children:["The ARC standard is defined in ",(0,d.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc8617",children:"RFC 8617"}),". An overview presentation is available at ",(0,d.jsx)(n.a,{href:"https://dmarc.org/presentations/ARC-Overview-2016Q2-v03.pdf",children:"https://dmarc.org/presentations/ARC-Overview-2016Q2-v03.pdf"}),"."]}),"\n",(0,d.jsxs)(n.p,{children:["Rspamd supports both ARC verification and signing since version 1.6. It uses the ",(0,d.jsx)(n.a,{href:"/modules/dkim",children:"dkim"})," module internally for cryptographic operations."]}),"\n",(0,d.jsx)(n.h2,{id:"symbols",children:"Symbols"}),"\n",(0,d.jsx)(n.p,{children:"The module registers the following symbols:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Symbol"}),(0,d.jsx)(n.th,{children:"Score"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_ALLOW"})}),(0,d.jsx)(n.td,{children:"-1.0"}),(0,d.jsx)(n.td,{children:"Valid ARC chain found"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_REJECT"})}),(0,d.jsx)(n.td,{children:"2.0"}),(0,d.jsx)(n.td,{children:"ARC chain validation failed"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_INVALID"})}),(0,d.jsx)(n.td,{children:"1.0"}),(0,d.jsx)(n.td,{children:"ARC chain structure is invalid"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_DNSFAIL"})}),(0,d.jsx)(n.td,{children:"0.0"}),(0,d.jsx)(n.td,{children:"DNS lookup failed during validation"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_NA"})}),(0,d.jsx)(n.td,{children:"0.0"}),(0,d.jsx)(n.td,{children:"No ARC headers present"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_ALLOW_TRUSTED"})}),(0,d.jsx)(n.td,{children:"-2.0"}),(0,d.jsxs)(n.td,{children:["Valid ARC chain from a trusted forwarder (requires ",(0,d.jsx)(n.code,{children:"whitelisted_signers_map"}),")"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_SIGNED"})}),(0,d.jsx)(n.td,{children:"0.0"}),(0,d.jsx)(n.td,{children:"Message was signed with ARC"})]})]})]}),"\n",(0,d.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,d.jsxs)(n.p,{children:["Settings should be added to ",(0,d.jsx)(n.code,{children:"/etc/rspamd/local.d/arc.conf"}),"."]}),"\n",(0,d.jsx)(n.h3,{id:"basic-settings",children:"Basic settings"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"selector"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"arc"})}),(0,d.jsx)(n.td,{children:"Default selector for ARC signing"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"path"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"${DBDIR}/arc/$domain.$selector.key"})}),(0,d.jsxs)(n.td,{children:["Path to signing key (supports ",(0,d.jsx)(n.code,{children:"$domain"})," and ",(0,d.jsx)(n.code,{children:"$selector"})," variables)"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"sign_symbol"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ARC_SIGNED"})}),(0,d.jsx)(n.td,{children:"Symbol added when message is signed"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"try_fallback"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Fall back to global config if domain-specific config not found"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"domain-selection",children:"Domain selection"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_domain"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"header"})}),(0,d.jsxs)(n.td,{children:["Domain source: ",(0,d.jsx)(n.code,{children:"header"})," (MIME From), ",(0,d.jsx)(n.code,{children:"envelope"})," (SMTP From), ",(0,d.jsx)(n.code,{children:"recipient"})," (SMTP To), ",(0,d.jsx)(n.code,{children:"auth"})," (authenticated user), or explicit domain name"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_esld"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Normalize domains to effective second-level domain (eSLD)"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_domain_sign_networks"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsxs)(n.td,{children:["Override ",(0,d.jsx)(n.code,{children:"use_domain"})," for sign_networks"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_domain_sign_local"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsxs)(n.td,{children:["Override ",(0,d.jsx)(n.code,{children:"use_domain"})," for local IPs"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_domain_sign_inbound"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsxs)(n.td,{children:["Override ",(0,d.jsx)(n.code,{children:"use_domain"})," for inbound mail"]})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_domain_custom"})}),(0,d.jsx)(n.td,{children:"string/function"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Custom Lua function to determine signing domain"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"signing-eligibility",children:"Signing eligibility"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"sign_authenticated"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Sign messages from authenticated users"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"sign_local"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Sign messages from local IP addresses"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"sign_inbound"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Sign inbound messages (not local, not authenticated)"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"sign_networks"})}),(0,d.jsx)(n.td,{children:"map"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Map of networks eligible for signing"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"skip_spam_sign"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Skip signing if message is marked as spam"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allowed_ids"})}),(0,d.jsx)(n.td,{children:"table"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"List of settings IDs that allow signing"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"forbidden_ids"})}),(0,d.jsx)(n.td,{children:"table"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"List of settings IDs that forbid signing"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"headerenvelope-validation",children:"Header/envelope validation"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_envfrom_empty"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Allow signing with empty envelope From"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_hdrfrom_mismatch"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Allow envelope/header From domain mismatch"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_hdrfrom_mismatch_local"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Allow mismatch for local IPs"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_hdrfrom_mismatch_sign_networks"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Allow mismatch for sign_networks"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_hdrfrom_multiple"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Allow multiple From headers (only first is used)"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_username_mismatch"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Allow authenticated user domain to differ from signing domain"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"trusted-forwarders-and-whitelisting",children:"Trusted forwarders and whitelisting"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"whitelisted_signers_map"})}),(0,d.jsx)(n.td,{children:"map"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Map of trusted ARC forwarder domains"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"whitelist"})}),(0,d.jsx)(n.td,{children:"map"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Map of domains with broken ARC implementations to trust despite validation failures"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"adjust_dmarc"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"true"})}),(0,d.jsx)(n.td,{children:"Adjust DMARC score when trusted forwarder provides valid ARC chain"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"redis-integration",children:"Redis integration"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_redis"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Load signing keys from Redis"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"key_prefix"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"arc_keys"})}),(0,d.jsx)(n.td,{children:"Redis hash name for keys"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"selector_prefix"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Redis hash name for selectors (optional)"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"vault-integration",children:"Vault integration"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_vault"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Load signing keys from HashiCorp Vault"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"vault_url"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Vault server URL"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"vault_token"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Vault authentication token"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"vault_path"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"dkim"})}),(0,d.jsx)(n.td,{children:"Path in Vault for keys"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"vault_kv_version"})}),(0,d.jsx)(n.td,{children:"number"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"1"})}),(0,d.jsx)(n.td,{children:"Vault KV secrets engine version (1 or 2)"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"vault_domains"})}),(0,d.jsx)(n.td,{children:"map"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"Map of domains to look up in Vault"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"public-key-verification",children:"Public key verification"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"check_pubkey"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Verify public key exists before signing"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_pubkey_mismatch"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Continue signing even if public key lookup fails"})]})]})]}),"\n",(0,d.jsx)(n.h3,{id:"authentication-results",children:"Authentication results"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsx)(n.tbody,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"reuse_auth_results"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Reuse existing Authentication-Results header instead of generating new one"})]})})]}),"\n",(0,d.jsx)(n.h3,{id:"http-headers-for-proxy-integration",children:"HTTP headers (for proxy integration)"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"Option"}),(0,d.jsx)(n.th,{children:"Type"}),(0,d.jsx)(n.th,{children:"Default"}),(0,d.jsx)(n.th,{children:"Description"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"use_http_headers"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Get signing parameters from HTTP request headers"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"http_sign_header"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"PerformDkimSign"})}),(0,d.jsx)(n.td,{children:"Header indicating signing should be performed"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"http_domain_header"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"DkimDomain"})}),(0,d.jsx)(n.td,{children:"Header containing domain"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"http_selector_header"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"DkimSelector"})}),(0,d.jsx)(n.td,{children:"Header containing selector"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"http_key_header"})}),(0,d.jsx)(n.td,{children:"string"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"DkimPrivateKey"})}),(0,d.jsx)(n.td,{children:"Header containing private key"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"allow_headers_fallback"})}),(0,d.jsx)(n.td,{children:"boolean"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"false"})}),(0,d.jsx)(n.td,{children:"Fall back to normal signing if headers missing"})]})]})]}),"\n",(0,d.jsx)(n.h2,{id:"basic-configuration-example",children:"Basic configuration example"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\n\n# Default signing selector\nselector = "arc";\n\n# Path template for keys\npath = "${DBDIR}/arc/$domain.$selector.key";\n\n# Sign mail from authenticated users and local networks\nsign_authenticated = true;\nsign_local = true;\n\n# Use header From domain for signing\nuse_domain = "header";\nuse_esld = true;\n\n# Domain-specific configuration\ndomain {\n  example.com {\n    path = "${DBDIR}/arc/example.com.key";\n    selector = "arc2024";\n  }\n}\n'})}),"\n",(0,d.jsx)(n.h2,{id:"trusted-arc-forwarders",children:"Trusted ARC forwarders"}),"\n",(0,d.jsxs)(n.p,{children:["The ",(0,d.jsx)(n.code,{children:"whitelisted_signers_map"})," setting allows you to configure trusted ARC forwarders. When an email has a valid ARC chain that includes a signature from one of these trusted domains, Rspamd will:"]}),"\n",(0,d.jsxs)(n.ol,{children:["\n",(0,d.jsxs)(n.li,{children:["Add the ",(0,d.jsx)(n.code,{children:"ARC_ALLOW_TRUSTED"})," symbol with a score of -2.0"]}),"\n",(0,d.jsxs)(n.li,{children:["If ",(0,d.jsx)(n.code,{children:"adjust_dmarc"})," is enabled (default), reduce the impact of DMARC failures"]}),"\n"]}),"\n",(0,d.jsx)(n.p,{children:"This is particularly useful for legitimate email forwarding services that may alter messages in ways that break DKIM signatures, but can be trusted based on their ARC signatures."}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\n\n# Inline array\nwhitelisted_signers_map = ["mailgun.org", "sendgrid.net", "amazonses.com"];\n\n# Or file-based map\nwhitelisted_signers_map = "file:///etc/rspamd/maps/arc_trusted_signers.map";\n\n# Adjust DMARC policy for trusted forwarders (enabled by default)\nadjust_dmarc = true;\n'})}),"\n",(0,d.jsx)(n.p,{children:"For file-based maps, create a simple text file with one domain per line:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"mailgun.org\nsendgrid.net\namazonses.com\n"})}),"\n",(0,d.jsx)(n.h2,{id:"handling-broken-arc-implementations",children:"Handling broken ARC implementations"}),"\n",(0,d.jsxs)(n.p,{children:["Some email services have broken ARC implementations that fail validation despite being legitimate forwarders. The ",(0,d.jsx)(n.code,{children:"whitelist"})," option allows ARC chain validation to continue despite failures from specified domains."]}),"\n",(0,d.jsx)(n.p,{children:"When a domain is in the whitelist:"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"ARC signature/seal validation failures for that domain are logged but treated as valid"}),"\n",(0,d.jsx)(n.li,{children:"The ARC chain validation continues to the next step"}),"\n",(0,d.jsx)(n.li,{children:"This preserves the security of the overall chain while accommodating known bugs"}),"\n"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\n\n# Domains with known broken ARC implementations\nwhitelist = ["broken-forwarder.com", "buggy-arc.example"];\n\n# Or file-based map\nwhitelist = "file:///etc/rspamd/maps/arc_whitelist.map";\n'})}),"\n",(0,d.jsx)(n.h2,{id:"arc-keys-in-redis",children:"ARC keys in Redis"}),"\n",(0,d.jsx)(n.p,{children:"To store ARC signing keys in Redis:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\nuse_redis = true;\nkey_prefix = "arc_keys";\nselector = "myselector";\n'})}),"\n",(0,d.jsxs)(n.p,{children:["Populate the hash with keys using the format ",(0,d.jsx)(n.code,{children:"selector.domain"}),":"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-lua",children:"-- Run with: redis-cli --eval script.lua\nlocal key = [[-----BEGIN PRIVATE KEY-----\nMIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBANe3EETkiI1Exyrb\n...\n-----END PRIVATE KEY-----]]\nredis.call('HMSET', 'arc_keys', 'myselector.example.com', key)\n"})}),"\n",(0,d.jsx)(n.h2,{id:"using-maps-for-selectors-and-paths",children:"Using maps for selectors and paths"}),"\n",(0,d.jsxs)(n.p,{children:["Use ",(0,d.jsx)(n.code,{children:"selector_map"})," and ",(0,d.jsx)(n.code,{children:"path_map"})," to configure per-domain selectors and key paths:"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\ntry_fallback = true;\npath = "${DBDIR}/arc/$domain.$selector.key";\nselector_map = "/etc/rspamd/arc_selectors.map";\nselector = "arc";\n'})}),"\n",(0,d.jsx)(n.p,{children:"Map format (domain followed by value):"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"example.net arc2024\nexample.org default\n"})}),"\n",(0,d.jsx)(n.p,{children:"For paths:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"example.net /var/lib/rspamd/arc/example.net.$selector.key\nexample.org /etc/rspamd/arc/example.org.key\n"})}),"\n",(0,d.jsx)(n.p,{children:"To require explicit configuration for each domain (no fallback):"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\ntry_fallback = false;\nselector_map = "/etc/rspamd/arc_selectors.map";\npath_map = "/etc/rspamd/arc_paths.map";\n'})}),"\n",(0,d.jsx)(n.h2,{id:"vault-integration-1",children:"Vault integration"}),"\n",(0,d.jsx)(n.p,{children:"For HashiCorp Vault integration:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\nuse_vault = true;\nvault_url = "https://vault.example.com:8200";\nvault_token = "your-vault-token";\nvault_path = "secret/dkim";\nvault_kv_version = 2;\n\n# Optional: restrict to specific domains\nvault_domains = ["example.com", "example.org"];\n'})}),"\n",(0,d.jsxs)(n.p,{children:["Expected Vault secret structure at ",(0,d.jsx)(n.code,{children:"secret/dkim/example.com"}),":"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-json",children:'{\n  "selectors": [\n    {\n      "selector": "arc2024",\n      "domain": "example.com",\n      "key": "-----BEGIN PRIVATE KEY-----\\n...",\n      "valid_start": 1704067200,\n      "valid_end": 1735689600\n    }\n  ]\n}\n'})}),"\n",(0,d.jsx)(n.h2,{id:"sign-headers",children:"Sign headers"}),"\n",(0,d.jsx)(n.p,{children:"From version 1.8.4, Rspamd uses a specific set of headers for ARC signing. The default can be overridden:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-hcl",children:'# local.d/arc.conf\nsign_headers = "(o)from:(o)sender:(o)reply-to:(o)subject:(o)date:(o)message-id:(o)to:(o)cc:(o)mime-version:(o)content-type:(o)content-transfer-encoding:resent-to:resent-cc:resent-from:resent-sender:resent-message-id:(o)in-reply-to:(o)references:list-id:list-owner:list-unsubscribe:list-subscribe:list-post:dkim-signature";\n'})}),"\n",(0,d.jsxs)(n.p,{children:["The ",(0,d.jsx)(n.code,{children:"(o)"})," prefix indicates optional headers (included only if present)."]})]})}function o(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(h,{...e})}):h(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>t});var i=s(96540);const d={},r=i.createContext(d);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);