"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[8560],{8369:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"developers/writing_tests","title":"Writing tests for Rspamd","description":"Testing is a crucial aspect of ensuring the stability of a product. In the case of Rspamd, there has historically been a lack of comprehensive testing, but we are actively working to improve this. We welcome and greatly appreciate any contributions from the community.","source":"@site/docs/developers/writing_tests.md","sourceDirName":"developers","slug":"/developers/writing_tests","permalink":"/docs.rspamd.com/branches/master/developers/writing_tests","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/developers/writing_tests.md","tags":[],"version":"current","frontMatter":{"title":"Writing tests for Rspamd"},"sidebar":"docs","previous":{"title":"Writing Rspamd rules","permalink":"/docs.rspamd.com/branches/master/developers/writing_rules"},"next":{"title":"Controller WebUI Endpoints Development Guide","permalink":"/docs.rspamd.com/branches/master/developers/controller_endpoints"}}');var i=t(4848),r=t(8453);const a={title:"Writing tests for Rspamd"},o="Writing tests for Rspamd",c={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Unit tests",id:"unit-tests",level:2},{value:"Functional tests",id:"functional-tests",level:2},{value:"Functional tests structure",id:"functional-tests-structure",level:3},{value:"Test case structure",id:"test-case-structure",level:3},{value:"General advice on making test cases for Rspamd",id:"general-advice-on-making-test-cases-for-rspamd",level:3}];function l(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"writing-tests-for-rspamd",children:"Writing tests for Rspamd"})}),"\n",(0,i.jsx)(s.p,{children:"Testing is a crucial aspect of ensuring the stability of a product. In the case of Rspamd, there has historically been a lack of comprehensive testing, but we are actively working to improve this. We welcome and greatly appreciate any contributions from the community."}),"\n",(0,i.jsx)(s.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(s.p,{children:"Rspamd has two types of tests:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Unit tests - those type of tests are intended to test some particular function in Rspamd and are written in Lua + FFI (if testing plain C function) using ",(0,i.jsx)(s.a,{href:"https://github.com/norman/telescope",children:"Telescope framework"}),";"]}),"\n",(0,i.jsxs)(s.li,{children:["Functional tests - are used to test the whole daemon behaviour with complex setup involving custom configuration, external services, such as Redis, and so on. Functional tests are written using ",(0,i.jsx)(s.a,{href:"https://robotframework.org/",children:"Robot Framework"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"unit-tests",children:"Unit tests"}),"\n",(0,i.jsxs)(s.p,{children:["Unit tests are located in the ",(0,i.jsx)(s.code,{children:"test/lua/unit"})," directory. Each test defines a testing context, which contains main definitions utilized by all test cases. For instance, it includes ",(0,i.jsx)(s.a,{href:"https://luajit.org/ext_ffi.html",children:"FFI (Foreign Function Interface)"})," definitions."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-lua",children:'context("Inet addr check functions", function()\n  local ffi = require("ffi")\n\n  ffi.cdef[[\n  typedef struct rspamd_inet_addr_s rspamd_inet_addr_t;\n  bool rspamd_parse_inet_address (rspamd_inet_addr_t **target,\n    const char *src);\n  void rspamd_inet_address_free (rspamd_inet_addr_t *addr);\n  ]]\n  \n  ...\nend)\n'})}),"\n",(0,i.jsx)(s.p,{children:"Then, there could be some test cases:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-lua",children:"  local cases = {\n    {'192.168.1.1', true},\n    {'2a01:4f8:190:43b5::99', true},\n    {'256.1.1.1', false},\n    {'/tmp/socket', true},\n    {'./socket', true},\n    {'[fe80::f919:8b26:ff93:3092%5]', true},\n    {'[fe80::f919:8b26:ff93:3092]', true},\n  }\n\n  for i,c in ipairs(cases) do\n    test(\"Create inet addr from string \" .. i, function()\n      local ip = ffi.new(\"rspamd_inet_addr_t* [1]\");\n      local res = ffi.C.rspamd_parse_inet_address(ip, c[1])\n      assert_equal(res, c[2], \"Expect \" .. tostring(c[2]) .. \" while parsing \" .. c[1])\n      if res then\n        ffi.C.rspamd_inet_address_free(ip[0])\n      end\n    end)\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Please note that a single ",(0,i.jsx)(s.code,{children:"test"})," invocation should define one specific case."]}),"\n",(0,i.jsxs)(s.p,{children:["Running unit tests requires building a special ",(0,i.jsx)(s.code,{children:"rspamd-test"})," target. If you use ",(0,i.jsx)(s.code,{children:"make"})," to build Rspamd from the sources, you can do so by running ",(0,i.jsx)(s.code,{children:"make rspamd-test"}),". This will create the ",(0,i.jsx)(s.code,{children:"test/rspamd-test"})," binary in your build directory."]}),"\n",(0,i.jsxs)(s.p,{children:["To run unit tests, simply execute ",(0,i.jsx)(s.code,{children:"test/rspamd-test -p /rspamd/lua"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"However, it's important to note that it's currently not possible to execute specific unit tests individually."}),"\n",(0,i.jsx)(s.h2,{id:"functional-tests",children:"Functional tests"}),"\n",(0,i.jsxs)(s.p,{children:["Functional tests are designed to assess the entire Rspamd setup, and before diving into them, it's important to familiarize yourself with the ",(0,i.jsx)(s.a,{href:"https://robotframework.org/",children:"Robot Framework"}),", which is used to write these tests."]}),"\n",(0,i.jsxs)(s.p,{children:["Functional tests are located in the ",(0,i.jsx)(s.code,{children:"test/functional"})," directory. To run them, you'll need to first ",(0,i.jsx)(s.strong,{children:"install"})," Rspamd on your system or within a container. After installation, you can execute the tests manually using a command like this:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"RSPAMD_INSTALLROOT=/usr/local robot -s '280*' ~/rspamd/test/functional/cases\n"})}),"\n",(0,i.jsx)(s.p,{children:"Here's what these components do:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"RSPAMD_INSTALLROOT"})," - a prefix where Rspamd is installed (e.g. ",(0,i.jsx)(s.code,{children:"/usr"})," for the vast majority of Linux installations)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"-s"})," - pattern to match tests (may be skipped if all tests are needed)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"~/rspamd/test/functional/cases"})," - directory where test cases are placed"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["It's worth noting that functional tests are also executed by ",(0,i.jsx)(s.a,{href:"https://github.com/rspamd/rspamd/actions",children:"Github Actions"}),", which includes testing for pull requests submitted on the GitHub repository."]}),"\n",(0,i.jsx)(s.h3,{id:"functional-tests-structure",children:"Functional tests structure"}),"\n",(0,i.jsx)(s.p,{children:"Each test usually has 3 components:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Test case (written in Robot) that lives in ",(0,i.jsx)(s.code,{children:"test/functional/cases"})]}),"\n",(0,i.jsxs)(s.li,{children:["Some configuration that lives in ",(0,i.jsx)(s.code,{children:"test/functional/configs"})]}),"\n",(0,i.jsxs)(s.li,{children:["Messages to scan in ",(0,i.jsx)(s.code,{children:"test/functional/messages"})]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["In many cases, you may also require specific Lua code, which should be located in the ",(0,i.jsx)(s.code,{children:"test/functional/lua"})," directory. For more complex setups, such as when you need to simulate fake or real external services, you might need to write some Python code. This Python code should be placed in the ",(0,i.jsx)(s.code,{children:"test/functional/lib"})," directory and, for simulating fake services, in ",(0,i.jsx)(s.code,{children:"test/functional/util"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"You can find numerous examples of how to run these fake servers in the existing tests, providing valuable guidance for your testing needs."}),"\n",(0,i.jsx)(s.h3,{id:"test-case-structure",children:"Test case structure"}),"\n",(0,i.jsxs)(s.p,{children:["Each test is enclosed within some specific test case. Test case consist of ",(0,i.jsx)(s.code,{children:"setup"}),", ",(0,i.jsx)(s.code,{children:"set of tests"})," and ",(0,i.jsx)(s.code,{children:"teardown"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["General testing advice on the Robot Framework is listed ",(0,i.jsx)(s.a,{href:"https://github.com/robotframework/HowToWriteGoodTestCases/blob/master/HowToWriteGoodTestCases.rst",children:"here"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"Test case has also a preamble that defines some common variables and setup + teardown procedures:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"*** Settings ***\nSuite Setup     Rbl Setup\nSuite Teardown  Rbl Teardown\nLibrary         ${TESTDIR}/lib/rspamd.py\nResource        ${TESTDIR}/lib/rspamd.robot\nVariables       ${TESTDIR}/lib/vars.py\n\n*** Variables ***\n${CONFIG}       ${TESTDIR}/configs/plugins.conf\n${MESSAGE}      ${TESTDIR}/messages/spam_message.eml\n${RSPAMD_SCOPE}  Suite\n${URL_TLD}      ${TESTDIR}/../lua/unit/test_tld.dat\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Setup procedure starts Rspamd using specific config file, teardown procedure, in turn, switches everything off. Both are listed in the ",(0,i.jsx)(s.code,{children:"Keywords"})," section:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"*** Keywords ***\nRbl Setup\n  ${PLUGIN_CONFIG} =  Get File  ${TESTDIR}/configs/rbl.conf\n  Set Suite Variable  ${PLUGIN_CONFIG}\n  Generic Setup  PLUGIN_CONFIG\n\nRbl Teardown\n  Normal Teardown\n  Terminate All Processes    kill=True\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Test cases are listed within ",(0,i.jsx)(s.code,{children:"*** Test Cases ***"})," section:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"*** Test Cases ***\nRBL FROM MISS\n  ${result} =  Scan Message With Rspamc  ${MESSAGE}  -i  1.2.3.4\n  Check Rspamc  ${result}  FAKE_RBL_CODE_2  inverse=True\n\nRBL FROM HIT\n  ${result} =  Scan Message With Rspamc  ${MESSAGE}  -i  4.3.2.1\n  Check Rspamc  ${result}  FAKE_RBL_CODE_2\n"})}),"\n",(0,i.jsx)(s.h3,{id:"general-advice-on-making-test-cases-for-rspamd",children:"General advice on making test cases for Rspamd"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Always use fake DNS records:"}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-hcl",children:'dns {\n fake_records = [\n { # ed25519\n   name = "test._domainkey.example.com";\n   type = txt;\n   replies = ["k=ed25519; p=yi50DjK5O9pqbFpNHklsv9lqaS0ArSYu02qp1S0DW1Y="];\n },\n ...\n ]\n}\n'})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Use fake servers to emulate large software (e.g. a virus scanner)"}),"\n",(0,i.jsx)(s.li,{children:"Try to reduce external dependencies, DNS requests, TCP requests etc"}),"\n",(0,i.jsx)(s.li,{children:"Push all tests that require some specific config within a single test suite to avoid setup/teardown cost on testing"}),"\n",(0,i.jsxs)(s.li,{children:["Logs for tests are saved in ",(0,i.jsx)(s.code,{children:"$(CURDIR)/robot-save"}),": you can find the exact configuration and the full debug logs for all tests; test name is enclosed in queue id of the messages to simplify logs reading"]}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,s,t)=>{t.d(s,{R:()=>a,x:()=>o});var n=t(6540);const i={},r=n.createContext(i);function a(e){const s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);