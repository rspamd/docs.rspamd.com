"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[119],{3952(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>o,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"modules/fuzzy_check","title":"Fuzzy check module","description":"The fuzzycheck module queries fuzzy storage workers to find messages matching known fuzzy patterns. It also handles learning (adding hashes to storage) when triggered via rspamc or the controller API.","source":"@site/docs/modules/fuzzy_check.md","sourceDirName":"modules","slug":"/modules/fuzzy_check","permalink":"/docs.rspamd.com/branches/master/modules/fuzzy_check","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/fuzzy_check.md","tags":[],"version":"current","frontMatter":{"title":"Fuzzy check module"},"sidebar":"docs","previous":{"title":"Force Actions module","permalink":"/docs.rspamd.com/branches/master/modules/force_actions"},"next":{"title":"GPT Plugin","permalink":"/docs.rspamd.com/branches/master/modules/gpt"}}');var r=s(4848),t=s(8453);const l={title:"Fuzzy check module"},c="Fuzzy check module",d={},a=[{value:"How Fuzzy Matching Works",id:"how-fuzzy-matching-works",level:2},{value:"Text Fuzzy Matching",id:"text-fuzzy-matching",level:3},{value:"Attachment and Image Matching",id:"attachment-and-image-matching",level:3},{value:"HTML Structure Matching (Since 3.14.0)",id:"html-structure-matching-since-3140",level:3},{value:"Basic Configuration",id:"basic-configuration",level:2},{value:"Understanding Scores and Thresholds",id:"understanding-scores-and-thresholds",level:2},{value:"Hash Weight (Hits)",id:"hash-weight-hits",level:3},{value:"<code>max_score</code> / <code>hits_limit</code> Parameter",id:"max_score--hits_limit-parameter",level:3},{value:"<code>max_hits</code> Parameter",id:"max_hits-parameter",level:3},{value:"Module Configuration Reference",id:"module-configuration-reference",level:2},{value:"Global Options",id:"global-options",level:3},{value:"Rule Options",id:"rule-options",level:3},{value:"Flag Mapping",id:"flag-mapping",level:3},{value:"Structured Checks Configuration (Since 3.14)",id:"structured-checks-configuration-since-314",level:2},{value:"HTML Structure Fuzzy Hashing",id:"html-structure-fuzzy-hashing",level:2},{value:"Why HTML Fuzzy?",id:"why-html-fuzzy",level:3},{value:"How It Works",id:"how-it-works",level:3},{value:"HTML Token Format",id:"html-token-format",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Use Cases",id:"use-cases",level:3},{value:"Learning Conditions",id:"learning-conditions",level:2},{value:"Learning Commands",id:"learning-commands",level:2},{value:"Rspamd.com Fuzzy Feeds",id:"rspamdcom-fuzzy-feeds",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"See Also",id:"see-also",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"fuzzy-check-module",children:"Fuzzy check module"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"fuzzy_check"})," module queries ",(0,r.jsx)(n.a,{href:"/workers/fuzzy_storage",children:"fuzzy storage workers"})," to find messages matching known fuzzy patterns. It also handles learning (adding hashes to storage) when triggered via ",(0,r.jsx)(n.code,{children:"rspamc"})," or the controller API."]}),"\n",(0,r.jsxs)(n.p,{children:["For a comprehensive guide on setting up fuzzy storage, configuring hash sources, and deployment strategies, see the ",(0,r.jsx)(n.a,{href:"/tutorials/fuzzy_storage",children:"Fuzzy Storage Tutorial"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"how-fuzzy-matching-works",children:"How Fuzzy Matching Works"}),"\n",(0,r.jsx)(n.p,{children:"Fuzzy hashing allows detection of similar (not just identical) messages. This is particularly effective against spam campaigns where the same message template is sent to many recipients with minor variations."}),"\n",(0,r.jsx)(n.h3,{id:"text-fuzzy-matching",children:"Text Fuzzy Matching"}),"\n",(0,r.jsxs)(n.p,{children:["Rspamd uses the ",(0,r.jsx)(n.strong,{children:"shingles algorithm"})," for text matching:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Text is split into overlapping word sequences (trigrams/3-grams)"}),"\n",(0,r.jsx)(n.li,{children:"Each sequence is hashed using multiple hash functions (32 hashes per shingle)"}),"\n",(0,r.jsx)(n.li,{children:"These shingles are stored and later compared probabilistically"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When a new message arrives, its shingles are compared against stored patterns. The similarity score reflects how many shingles match, allowing detection of messages that are similar but not identical."}),"\n",(0,r.jsxs)(n.p,{children:["For technical details on the shingles algorithm, see the ",(0,r.jsx)(n.a,{href:"https://dl.acm.org/doi/10.5555/283554.283370",children:"original research paper"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"attachment-and-image-matching",children:"Attachment and Image Matching"}),"\n",(0,r.jsxs)(n.p,{children:["Unlike text, attachments and images use ",(0,r.jsx)(n.strong,{children:"exact matching"})," via blake2b digests. A hash is computed for the entire content and matched exactly against stored hashes."]}),"\n",(0,r.jsx)(n.h3,{id:"html-structure-matching-since-3140",children:"HTML Structure Matching (Since 3.14.0)"}),"\n",(0,r.jsx)(n.p,{children:"HTML fuzzy matching detects similar emails based on DOM structure, layout, and link patterns\u2014independent of text content. This is particularly useful for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Spam campaigns"}),": Same HTML template with personalized text"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phishing detection"}),": Copied legitimate HTML with different CTA (Call-To-Action) links"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Newsletter grouping"}),": Same template with different weekly content"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"#html-structure-fuzzy-hashing",children:"HTML Structure Fuzzy Hashing"})," below for details."]}),"\n",(0,r.jsx)(n.h2,{id:"basic-configuration",children:"Basic Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"fuzzy_check"})," module is configured in ",(0,r.jsx)(n.code,{children:"/etc/rspamd/local.d/fuzzy_check.conf"}),". Each fuzzy storage is defined as a ",(0,r.jsx)(n.code,{children:"rule"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "FUZZY_EXAMPLE" {\n  # Server(s) to query - required\n  servers = "localhost:11335";\n\n  # Hash algorithm: mumhash (default), fasthash, xxhash, siphash\n  algorithm = "mumhash";\n\n  # Allow learning to this storage (default: true = read-only)\n  read_only = false;\n\n  # Map flags to symbols\n  fuzzy_map = {\n    FUZZY_DENIED {\n      flag = 1;\n      max_score = 20.0;\n    }\n    FUZZY_PROB {\n      flag = 2;\n      max_score = 10.0;\n    }\n    FUZZY_WHITE {\n      flag = 3;\n      max_score = 2.0;\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"understanding-scores-and-thresholds",children:"Understanding Scores and Thresholds"}),"\n",(0,r.jsx)(n.p,{children:"Fuzzy matching involves two distinct scoring concepts that are often confused:"}),"\n",(0,r.jsx)(n.h3,{id:"hash-weight-hits",children:"Hash Weight (Hits)"}),"\n",(0,r.jsxs)(n.p,{children:["Each hash in storage has a ",(0,r.jsx)(n.strong,{children:"weight"}),' (also called "hits") that accumulates as users report the same content:']}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["When you run ",(0,r.jsx)(n.code,{children:"rspamc -w 10 fuzzy_add message.eml"}),", you add weight 10 to the hash"]}),"\n",(0,r.jsx)(n.li,{children:"If 50 users report the same spam with weight 1 each, the hash weight becomes 50"}),"\n",(0,r.jsx)(n.li,{children:"Higher weights indicate more confidence that the content is spam (or ham)"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"max_score--hits_limit-parameter",children:[(0,r.jsx)(n.code,{children:"max_score"})," / ",(0,r.jsx)(n.code,{children:"hits_limit"})," Parameter"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"max_score"})," parameter (being renamed to ",(0,r.jsx)(n.code,{children:"hits_limit"})," in future versions) defines the ",(0,r.jsx)(n.strong,{children:"hash weight threshold"})," for symbol activation:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"FUZZY_DENIED {\n  flag = 1;\n  max_score = 20.0;  # Hash weight must reach 20 for full symbol score\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How it works:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Hash Weight"}),(0,r.jsx)(n.th,{children:"Symbol Score (if metric weight = 10.0)"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"< 20"}),(0,r.jsx)(n.td,{children:"0 (below threshold)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"20"}),(0,r.jsx)(n.td,{children:"~5.0 (threshold reached, partial)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"40 (2\xd7max)"}),(0,r.jsx)(n.td,{children:"10.0 (full score)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"100+"}),(0,r.jsx)(n.td,{children:"10.0 (capped at full score)"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"The score increases gradually from threshold to 2\xd7 threshold using a hyperbolic tangent function:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"if weight < max_score:\n    symbol_score = 0\nelse:\n    symbol_score = tanh((weight - max_score) / max_score) \xd7 metric_weight\n"})}),"\n",(0,r.jsx)(n.p,{children:"This prevents a single report from triggering the maximum score while ensuring well-confirmed spam gets full weight."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," The parameter is being renamed from ",(0,r.jsx)(n.code,{children:"max_score"})," to ",(0,r.jsx)(n.code,{children:"hits_limit"})," to better reflect its purpose. Both names are currently accepted for backward compatibility. See ",(0,r.jsx)(n.a,{href:"https://github.com/rspamd/rspamd/commit/7fd47dad2f9e8b63b5bc6d9576e96c8a329b4737",children:"commit 7fd47da"}),"."]}),"\n",(0,r.jsxs)(n.h3,{id:"max_hits-parameter",children:[(0,r.jsx)(n.code,{children:"max_hits"})," Parameter"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"max_hits"})," parameter limits how many times a single fuzzy rule can match within one message:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "FUZZY_CUSTOM" {\n  max_hits = 4;  # Maximum 4 fuzzy matches per message for this rule\n  ...\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"This is useful when a message contains multiple parts (attachments, embedded images) that might each match different fuzzy hashes. Without a limit, a message with 10 spam attachments could accumulate 10\xd7 the intended score."}),"\n",(0,r.jsx)(n.h2,{id:"module-configuration-reference",children:"Module Configuration Reference"}),"\n",(0,r.jsx)(n.h3,{id:"global-options",children:"Global Options"}),"\n",(0,r.jsx)(n.p,{children:"These options apply to all rules unless overridden:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'fuzzy_check {\n  # Minimum bytes for attachments/images to be checked\n  min_bytes = 1k;\n\n  # Minimum pixel dimensions for images\n  min_height = 32;\n  min_width = 32;\n\n  # Minimum words for text parts (default: check all)\n  min_length = 0;\n\n  # Multiplier for min_bytes when checking text parts\n  text_multiplier = 4.0;\n\n  # Maximum retransmissions before giving up\n  retransmits = 1;\n\n  # Timeout for fuzzy server response\n  timeout = 2s;\n\n  # Default symbol if no flags match\n  symbol = "FUZZY_UNKNOWN";\n\n  # IPs that bypass all fuzzy checks\n  whitelist = "/path/to/whitelist.map";\n\n  # Maximum errors before upstream is marked dead\n  max_errors = 3;\n\n  # Time before re-checking failed upstream\n  revive_time = 60s;\n\n  rule { ... }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"rule-options",children:"Rule Options"}),"\n",(0,r.jsxs)(n.p,{children:["Each ",(0,r.jsx)(n.code,{children:"rule"})," section defines a fuzzy storage connection:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"servers"})}),(0,r.jsx)(n.td,{children:"string/array"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.strong,{children:"Required."})," Fuzzy storage server(s). Supports ",(0,r.jsx)(n.a,{href:"/configuration/upstream",children:"upstream"})," syntax for load balancing."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"algorithm"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"mumhash"})}),(0,r.jsxs)(n.td,{children:["Hash algorithm: ",(0,r.jsx)(n.code,{children:"mumhash"}),", ",(0,r.jsx)(n.code,{children:"fasthash"})," (or ",(0,r.jsx)(n.code,{children:"fast"}),"), ",(0,r.jsx)(n.code,{children:"xxhash"}),", ",(0,r.jsx)(n.code,{children:"siphash"})," (or ",(0,r.jsx)(n.code,{children:"old"}),")."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"encryption_key"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Public key for transport encryption (base32)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fuzzy_key"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Key for hash generation (private storages)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fuzzy_shingles_key"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Key for shingles generation (private storages)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fuzzy_map"})}),(0,r.jsx)(n.td,{children:"object"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsxs)(n.td,{children:["Maps flags to symbols. See ",(0,r.jsx)(n.a,{href:"#flag-mapping",children:"Flag Mapping"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_score"})}),(0,r.jsx)(n.td,{children:"float"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Global threshold for this rule (deprecated, use per-flag)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_hits"})}),(0,r.jsx)(n.td,{children:"int"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Maximum matches per message for this rule."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"mime_types"})}),(0,r.jsx)(n.td,{children:"array"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsxs)(n.td,{children:["MIME types to check: ",(0,r.jsx)(n.code,{children:'["*"]'}),", ",(0,r.jsx)(n.code,{children:'["application/*"]'}),", etc."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"read_only"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"true"})}),(0,r.jsxs)(n.td,{children:["If ",(0,r.jsx)(n.code,{children:"false"}),", allow learning to this storage."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"skip_unknown"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsxs)(n.td,{children:["If ",(0,r.jsx)(n.code,{children:"true"}),", don't add default symbol for unmatched flags."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Default symbol for this rule."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"short_text_direct_hash"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsxs)(n.td,{children:["Use exact hash for texts shorter than ",(0,r.jsx)(n.code,{children:"min_length"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"skip_hashes"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Map of hashes to skip (whitelist)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"headers"})}),(0,r.jsx)(n.td,{children:"array"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:"Headers to include in hash generation."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"learn_condition"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsxs)(n.td,{children:["Lua script to filter learning. See ",(0,r.jsx)(n.a,{href:"#learning-conditions",children:"Learning Conditions"}),"."]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"flag-mapping",children:"Flag Mapping"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"fuzzy_map"})," connects storage flags to Rspamd symbols:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"fuzzy_map = {\n  SYMBOL_NAME {\n    flag = 1;              # Storage flag number\n    max_score = 20.0;      # Weight threshold (alias: hits_limit)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Different flags allow a single storage to contain multiple hash categories:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Flag"}),(0,r.jsx)(n.th,{children:"Purpose"}),(0,r.jsx)(n.th,{children:"Example Symbol"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"1"}),(0,r.jsx)(n.td,{children:"Confirmed spam (blacklist)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FUZZY_DENIED"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2"}),(0,r.jsx)(n.td,{children:"Probable spam"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FUZZY_PROB"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"3"}),(0,r.jsx)(n.td,{children:"Legitimate content (whitelist)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FUZZY_WHITE"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["When learning, specify the flag with ",(0,r.jsx)(n.code,{children:"-f"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamc -f 1 -w 10 fuzzy_add spam_message.eml      # Add to blacklist\nrspamc -f 3 -w 5 fuzzy_add legitimate.eml          # Add to whitelist\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Or use the symbol name with ",(0,r.jsx)(n.code,{children:"-S"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamc -S FUZZY_DENIED -w 10 fuzzy_add spam_message.eml\n"})}),"\n",(0,r.jsx)(n.h2,{id:"structured-checks-configuration-since-314",children:"Structured Checks Configuration (Since 3.14)"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"checks"})," object provides structured configuration for different content types:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "FUZZY_CUSTOM" {\n  servers = "127.0.0.1:11335";\n\n  checks = {\n    text {\n      enabled = true;\n      min_length = 64;            # Minimum words\n      text_multiplier = 4.0;      # Divide min_bytes by this for text\n      short_text_direct_hash = true;\n    }\n    html {\n      enabled = true;\n      min_html_tags = 15;\n      weight = 1.2;               # Score multiplier for HTML matches\n    }\n    image {\n      enabled = false;            # Equivalent to skip_images = true\n      min_height = 32;\n      min_width = 32;\n    }\n    archive {\n      enabled = true;             # Check files inside archives\n    }\n  }\n\n  fuzzy_map = { ... }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Legacy boolean options (",(0,r.jsx)(n.code,{children:"text_hashes"}),", ",(0,r.jsx)(n.code,{children:"html_shingles"}),", ",(0,r.jsx)(n.code,{children:"skip_images"}),", ",(0,r.jsx)(n.code,{children:"scan_archives"}),") are still supported and merged with the structured configuration."]}),"\n",(0,r.jsx)(n.h2,{id:"html-structure-fuzzy-hashing",children:"HTML Structure Fuzzy Hashing"}),"\n",(0,r.jsx)(n.p,{children:"Since version 3.14.0, Rspamd can match emails based on HTML structure rather than text content."}),"\n",(0,r.jsx)(n.h3,{id:"why-html-fuzzy",children:"Why HTML Fuzzy?"}),"\n",(0,r.jsx)(n.p,{children:"Many emails share HTML templates while varying text:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Use Case"}),(0,r.jsx)(n.th,{children:"Text Fuzzy"}),(0,r.jsx)(n.th,{children:"HTML Fuzzy"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Spam campaign with personalized text"}),(0,r.jsx)(n.td,{children:"Misses (text varies)"}),(0,r.jsx)(n.td,{children:"Catches (same template)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Newsletter with weekly content"}),(0,r.jsx)(n.td,{children:"Misses (content changes)"}),(0,r.jsx)(n.td,{children:"Catches (same structure)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Phishing copying legitimate brand"}),(0,r.jsx)(n.td,{children:"May match (similar text)"}),(0,r.jsx)(n.td,{children:"Detects via CTA mismatch"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,r.jsx)(n.p,{children:"HTML fuzzy generates multiple hash components:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Component"}),(0,r.jsx)(n.th,{children:"Weight"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Structure shingles"}),(0,r.jsx)(n.td,{children:"50%"}),(0,r.jsx)(n.td,{children:"DOM tag sequence with classes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"CTA domains"}),(0,r.jsx)(n.td,{children:"30%"}),(0,r.jsx)(n.td,{children:"Call-to-action link destinations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"All domains"}),(0,r.jsx)(n.td,{children:"15%"}),(0,r.jsx)(n.td,{children:"Top-10 link domains"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Features"}),(0,r.jsx)(n.td,{children:"5%"}),(0,r.jsx)(n.td,{children:"Tag count, link count, DOM depth"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"CTA domain verification"})," is critical for phishing detection:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Legitimate Amazon email:\n  Structure: [div.header \u2192 a@amazon.com \u2192 div.content \u2192 a.button@amazon.com]\n  CTA: amazon.com\n\nPhishing attempt:\n  Structure: [div.header \u2192 a@evil.com \u2192 div.content \u2192 a.button@evil.com]\n  CTA: evil.com\n\nResult: Despite identical DOM structure, CTA mismatch heavily penalizes\nsimilarity (\xd70.3), exposing the phishing attempt.\n"})}),"\n",(0,r.jsx)(n.h3,{id:"html-token-format",children:"HTML Token Format"}),"\n",(0,r.jsxs)(n.p,{children:["Each HTML tag becomes a token: ",(0,r.jsx)(n.code,{children:"tagname[.class][@domain]"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"div.header"}),' \u2014 div with "header" class']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"a.button@example.com"}),' \u2014 link with "button" class to example.com']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"img@cdn.example.com"})," \u2014 image from cdn.example.com"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"form@evil.com"})," \u2014 form posting to evil.com"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Normalization:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Only first CSS class used (multiple classes cause instability)"}),"\n",(0,r.jsxs)(n.li,{children:["Tracking classes filtered (",(0,r.jsx)(n.code,{children:"utm_*"}),", ",(0,r.jsx)(n.code,{children:"analytics_*"}),", etc.)"]}),"\n",(0,r.jsx)(n.li,{children:"Dynamic classes ignored (GUIDs, timestamps)"}),"\n",(0,r.jsx)(n.li,{children:"Domains normalized to eTLD+1"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "HTML_FUZZY" {\n  servers = "localhost:11335";\n  algorithm = "mumhash";\n\n  checks = {\n    html {\n      enabled = true;\n      min_html_tags = 15;    # Minimum tags to generate hash\n      weight = 1.2;          # Score multiplier\n    }\n    text {\n      enabled = true;        # Can enable both\n    }\n  }\n\n  fuzzy_map = {\n    FUZZY_HTML_SPAM {\n      flag = 100;\n      max_score = 20.0;\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Options:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"enabled"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Enable HTML fuzzy for this rule"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"min_html_tags"})}),(0,r.jsx)(n.td,{children:"10"}),(0,r.jsx)(n.td,{children:"Minimum tags required (prevents simple HTML false positives)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"weight"})}),(0,r.jsx)(n.td,{children:"1.0"}),(0,r.jsx)(n.td,{children:"Score multiplier for HTML matches"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Minimum complexity requirements:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["At least ",(0,r.jsx)(n.code,{children:"min_html_tags"})," tags"]}),"\n",(0,r.jsx)(n.li,{children:"At least 2 links"}),"\n",(0,r.jsx)(n.li,{children:"At least DOM depth 3"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phishing detection:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "PHISHING" {\n  checks = {\n    html {\n      enabled = true;\n      min_html_tags = 20;   # Brands use complex HTML\n      weight = 1.5;         # Prioritize structure\n    }\n  }\n  fuzzy_map = {\n    FUZZY_LEGIT_BRAND { flag = 1; max_score = 20.0; }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Learn legitimate brand templates, then detect copies with different CTAs."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Spam campaigns:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rule "SPAM_CAMPAIGNS" {\n  checks = {\n    html {\n      enabled = true;\n      min_html_tags = 15;\n      weight = 1.0;\n    }\n  }\n  fuzzy_map = {\n    FUZZY_SPAM_TEMPLATE { flag = 200; max_score = 15.0; }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Learn one sample from a campaign, catch all variations."}),"\n",(0,r.jsxs)(n.p,{children:["For deployment strategies and best practices, see ",(0,r.jsx)(n.a,{href:"/tutorials/fuzzy_storage#html-fuzzy-for-phishing-detection",children:"HTML Fuzzy for Phishing Detection"})," in the tutorial."]}),"\n",(0,r.jsx)(n.h2,{id:"learning-conditions",children:"Learning Conditions"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"learn_condition"})," parameter accepts a Lua script that controls whether a message should be learned:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"rule \"FUZZY_FILTERED\" {\n  servers = \"localhost:11335\";\n\n  learn_condition = <<EOD\nreturn function(task)\n  -- Skip learning for certain domains\n  local dominated = {'example.com', 'trusted.org'}\n  local from = task:get_from()\n\n  if from and from[1] and from[1]['addr'] then\n    for _, d in ipairs(dominated) do\n      if string.find(from[1]['addr'], d) then\n        return false  -- Don't learn\n      end\n    end\n  end\n\n  return true  -- Learn this message\nend\nEOD;\n\n  fuzzy_map = { ... }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"The function can also return a modified flag:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-lua",children:"return function(task)\n  local source = task:get_header('X-Source')\n  local flag_map = {\n    honeypot = 1,\n    user_report = 2,\n    whitelist = 3\n  }\n\n  if source and flag_map[source] then\n    return true, flag_map[source]  -- Learn with modified flag\n  end\n\n  return false  -- Don't learn without valid source\nend\n"})}),"\n",(0,r.jsx)(n.h2,{id:"learning-commands",children:"Learning Commands"}),"\n",(0,r.jsx)(n.p,{children:"Learning requires:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"read_only = false"})," in the rule configuration"]}),"\n",(0,r.jsxs)(n.li,{children:["Controller access (check ",(0,r.jsx)(n.code,{children:"enable_password"})," or ",(0,r.jsx)(n.code,{children:"secure_ip"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Fuzzy storage allowing updates (",(0,r.jsx)(n.code,{children:"allow_update"})," in worker-fuzzy.inc)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Add hashes:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamc -f <flag> -w <weight> fuzzy_add <message|directory>\nrspamc -S <SYMBOL> -w <weight> fuzzy_add <message|directory>\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Remove hashes:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamc -f <flag> fuzzy_del <message|directory>\nrspamc -f <flag> fuzzy_delhash <hash-id>\n"})}),"\n",(0,r.jsx)(n.p,{children:"The hash-id can be found in Rspamd logs when a fuzzy match occurs."}),"\n",(0,r.jsxs)(n.p,{children:["For detailed learning setup, sources selection, and best practices, see ",(0,r.jsx)(n.a,{href:"/tutorials/fuzzy_storage#step-3-configuring-fuzzy_check-plugin",children:"Training fuzzy_check"})," in the tutorial."]}),"\n",(0,r.jsx)(n.h2,{id:"rspamdcom-fuzzy-feeds",children:"Rspamd.com Fuzzy Feeds"}),"\n",(0,r.jsxs)(n.p,{children:["By default, Rspamd uses fuzzy feeds from rspamd.com. These are enabled in the default configuration and require compliance with the ",(0,r.jsx)(n.a,{href:"/other/usage_policy",children:"usage policy"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["If your usage is blocked, the ",(0,r.jsx)(n.code,{children:"FUZZY_BLOCKED"})," symbol will appear (with zero weight, not affecting mail processing)."]}),"\n",(0,r.jsx)(n.p,{children:"To test connectivity to the public fuzzy storage:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamadm fuzzyping\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If you see packet loss or no replies, check your firewall allows ",(0,r.jsx)(n.strong,{children:"UDP port 1335"})," outbound."]}),"\n",(0,r.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# /etc/rspamd/local.d/fuzzy_check.conf\n\n# Global settings\nfuzzy_check {\n  min_bytes = 1k;\n  timeout = 2s;\n  retransmits = 1;\n}\n\n# Local fuzzy storage\nrule "LOCAL" {\n  servers = "localhost:11335";\n  algorithm = "mumhash";\n  read_only = false;\n  skip_unknown = true;\n\n  checks = {\n    text {\n      enabled = true;\n      min_length = 32;\n      short_text_direct_hash = true;\n    }\n    html {\n      enabled = true;\n      min_html_tags = 15;\n    }\n    image {\n      enabled = true;\n      min_width = 32;\n      min_height = 32;\n    }\n    archive {\n      enabled = true;\n    }\n  }\n\n  fuzzy_map = {\n    LOCAL_FUZZY_DENIED {\n      flag = 1;\n      max_score = 20.0;\n    }\n    LOCAL_FUZZY_PROB {\n      flag = 2;\n      max_score = 10.0;\n    }\n    LOCAL_FUZZY_WHITE {\n      flag = 3;\n      max_score = 5.0;\n    }\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Define symbol weights in ",(0,r.jsx)(n.code,{children:"/etc/rspamd/local.d/fuzzy_group.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'max_score = 12.0;\n\nsymbols = {\n  "LOCAL_FUZZY_DENIED" {\n    weight = 12.0;\n    description = "Denied fuzzy hash";\n  }\n  "LOCAL_FUZZY_PROB" {\n    weight = 5.0;\n    description = "Probable spam fuzzy hash";\n  }\n  "LOCAL_FUZZY_WHITE" {\n    weight = -2.0;\n    description = "Whitelisted fuzzy hash";\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/tutorials/fuzzy_storage",children:"Fuzzy Storage Tutorial"})," \u2014 Comprehensive setup guide"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/workers/fuzzy_storage",children:"Fuzzy Storage Worker"})," \u2014 Storage worker configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/other/usage_policy",children:"Usage Policy"})," \u2014 Rspamd.com feeds policy"]}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const r={},t=i.createContext(r);function l(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);