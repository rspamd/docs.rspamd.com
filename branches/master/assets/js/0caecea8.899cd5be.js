"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[9301],{28453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var t=s(96540);const i={},a=t.createContext(i);function r(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:n},e.children)}},91016:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"modules/external_services","title":"External Services module","description":"The External Services module, which has been available since Rspamd 1.9.0, enables integration with a range of external services.","source":"@site/docs/modules/external_services.md","sourceDirName":"modules","slug":"/modules/external_services","permalink":"/docs.rspamd.com/branches/master/modules/external_services","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/external_services.md","tags":[],"version":"current","frontMatter":{"title":"External Services module"},"sidebar":"docs","previous":{"title":"External Relay module","permalink":"/docs.rspamd.com/branches/master/modules/external_relay"},"next":{"title":"Force Actions module","permalink":"/docs.rspamd.com/branches/master/modules/force_actions"}}');var i=s(74848),a=s(28453);const r={title:"External Services module"},o="External Services module",l={},c=[{value:"Configuration",id:"configuration",level:2},{value:"ICAP protocol specific details",id:"icap-protocol-specific-details",level:2},{value:"oletools specific details",id:"oletools-specific-details",level:2},{value:"oletools default mode",id:"oletools-default-mode",level:3},{value:"oletools extended mode",id:"oletools-extended-mode",level:3},{value:"DCC specific details",id:"dcc-specific-details",level:2},{value:"Module configuration",id:"module-configuration",level:3},{value:"Pyzor specific details",id:"pyzor-specific-details",level:2},{value:"Razor specific details",id:"razor-specific-details",level:2},{value:"VadeSecure specific details",id:"vadesecure-specific-details",level:2},{value:"SpamAssassin specific details",id:"spamassassin-specific-details",level:2},{value:"Spamd setup",id:"spamd-setup",level:3},{value:"spamassassin module default setup",id:"spamassassin-module-default-setup",level:3},{value:"spamassassin module extended setup",id:"spamassassin-module-extended-setup",level:3},{value:"Virustotal details",id:"virustotal-details",level:2},{value:"Cloudmark specific details",id:"cloudmark-specific-details",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"external-services-module",children:"External Services module"})}),"\n",(0,i.jsx)(n.p,{children:"The External Services module, which has been available since Rspamd 1.9.0, enables integration with a range of external services."}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.p,{children:"To configure an external service, rules must be defined. If the service detects one or more threats, the configured symbol (such as ICAP_VIRUS) will be set with a description of the threats. If this symbol is set, the reject action will be triggered."}),"\n",(0,i.jsx)(n.p,{children:"In case of connection errors or failures reported by the external service, the fail symbol (e.g. ICAP_VIRUS_FAIL) will be set with an error message as its description. Patterns can be used for both symbols to assign a dedicated symbol for any threat name or error message."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"...\n  patterns {\n    # symbol_name = \"pattern\";\n    JUST_EICAR = '^Eicar-Test-Signature$';\n  }\n  patterns_fail { # 1.9.0+\n    # symbol_name = \"pattern\";\n    ICAP_LIMITS_EXCEEDED = '^Container size violation$';\n  }\n...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["By default, the complete email will be sent to the external service system. You can and you have to change this behavior for some services by setting ",(0,i.jsx)(n.code,{children:"scan_mime_parts = true;"})," to send all mime parts detected as attachments separately. If you also want to scan text mimes and images using the AV scanner, you can set the ",(0,i.jsx)(n.code,{children:"scan_text_mime"})," or ",(0,i.jsx)(n.code,{children:"scan_image_mime"}),' parameter to "true".']}),"\n",(0,i.jsx)(n.p,{children:"Furthermore, there are two types of MIME part filters available:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'...\n  mime_parts_filter_regex {\n    FILE1 = "^invoice\\.xls$"\n    DOC1 = "application\\/msword";\n    DOC2 = "application\\/vnd\\.ms-word.*";\n    GEN2 = "application\\/vnd\\.openxmlformats-officedocument.*";\n  }\n  # Mime-Part filename extension matching (no regex)\n  mime_parts_filter_ext {\n    doc = "doc";\n    docx = "docx";\n  }\n...\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"mime_parts_filter_regex"})," will match on the content-type detected by rspamd or mime part header or the declared filename of an attachment or an archive file listing. ",(0,i.jsx)(n.code,{children:"mime_parts_filter_ext"})," will only match the extension of the declared filename or an archives file list."]}),"\n",(0,i.jsx)(n.p,{children:"Apart from the default settings, specific configuration options need to be set for each rule as described below."}),"\n",(0,i.jsxs)(n.p,{children:["By default, if ",(0,i.jsx)(n.a,{href:"/configuration/redis",children:"Redis"})," is configured globally and ",(0,i.jsx)(n.code,{children:"external_services"})," is not disabled in the Redis configuration, the results will be cached in Redis based on message checksums."]}),"\n",(0,i.jsxs)(n.p,{children:["To add settings, modify the ",(0,i.jsx)(n.code,{children:"/etc/rspamd/local.d/external_services.conf"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\n# multiple scanners could be checked, for each we create a configuration block with an arbitrary name\nicap {\n  servers = "127.0.0.1:1344";\n\n  # symbol to add (add it to metric if you want non-zero weight)\n  symbol = "ICAP_VIRUS";\n\n  # type of scanner: "icap", "oletools", "dcc" or "vadesecure"\n  type = "icap";\n\n  # Scan mime_parts separately - otherwise the complete mail will be transferred\n  #scan_mime_parts = true;\n  #scan_text_mime = false;\n  #scan_image_mime = false;\n\n  # filter attachments by content-type, filename or filename extension\n  # setting a filter will also enable scan_mime_parts = true;\n  mime_parts_filter_regex {\n    FILE1 = "^invoice\\.xls$"\n    DOC1 = "application\\/msword";\n  }\n  mime_parts_filter_ext {\n    doc = "doc";\n    docx = "docx";\n  }\n\n  # If set force this action if any threat is found (default unset: no action is forced)\n  # action = "reject";\n\n  # If `max_size` is set, messages > n bytes in size are not scanned\n  #max_size = 20000000;\n\n  # If set true, log message is emitted for clean messages\n  #log_clean = false;\n\n  # if `patterns` is specified threat name will be matched against provided regexes and the related\n  # symbol will be yielded if a match is found. If no match is found, default symbol is yielded.\n  patterns {\n    # symbol_name = "pattern";\n    JUST_EICAR = \'^Eicar-Test-Signature$\';\n  }\n  # same as above, but matching on the _FAIL symbol\n  patterns_fail {\n    # symbol_name = "pattern";\n  }\n  # In version 1.7.0+ patterns could be extended\n  #patterns = {SANE_MAL = \'Sanesecurity\\.Malware\\.*\', CLAM_UNOFFICIAL = \'UNOFFICIAL$\'};\n\n  # `whitelist` points to a map of IP addresses. Mail from these addresses is not scanned.\n  whitelist = "/etc/rspamd/antivirus.wl";\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"icap-protocol-specific-details",children:"ICAP protocol specific details"}),"\n",(0,i.jsx)(n.p,{children:"ICAP servers are typically utilized by HTTP proxies or file servers to scan HTTP requests or files. In Rspamd, only the RESPMOD method is supported. In addition to the X-Infection-Found and X-Virus-ID headers, Rspamd also attempts to evaluate other uncommon headers."}),"\n",(0,i.jsx)(n.p,{children:"Starting from version 3.2, Rspamd supports the complete ICAP protocol, which includes encapsulated HTTP headers. It is also capable of evaluating encapsulated HTTP return codes."}),"\n",(0,i.jsx)(n.p,{children:"This module has been tested with the following ICAP implementations:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Checkpoint Sandblast"}),"\n",(0,i.jsx)(n.li,{children:"ClamAV (using c-icap server and squidclamav)"}),"\n",(0,i.jsx)(n.li,{children:"ESET Server Security for Linux 9.0"}),"\n",(0,i.jsx)(n.li,{children:"F-Secure Internet Gatekeeper"}),"\n",(0,i.jsx)(n.li,{children:"Kaspersky Scan Engine 2.0"}),"\n",(0,i.jsx)(n.li,{children:"Kaspersky Web Traffic Security 6.0"}),"\n",(0,i.jsx)(n.li,{children:"McAfee Web Gateway 9/10/11"}),"\n",(0,i.jsx)(n.li,{children:"Metadefender ICAP"}),"\n",(0,i.jsx)(n.li,{children:"Sophos (via SAVDI)"}),"\n",(0,i.jsx)(n.li,{children:"Symantec Protection Engine for Cloud Services (Rspamd <3.2, >=3.2 untested)"}),"\n",(0,i.jsx)(n.li,{children:"Trend Micro InterScan Web Security Virtual Appliance (IWSVA)"}),"\n",(0,i.jsx)(n.li,{children:"Trend Micro IWSVA 6.0"}),"\n",(0,i.jsx)(n.li,{children:"Trend Micro Web Gateway"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Please report other working or non-working icap implementations."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\nclamav_icap {\n  ...\n  scheme = "squidclamav";\n  type = "icap";\n  ...\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"Scan requests are send to an icap URL (e.g. icap://127.0.0.1:1344/squidclamav). herefore, a scheme is required to communicate with the ICAP server in addition to the host and port. Since ICAP servers often have multiple schemes, it is necessary to choose one with RESPMOD support."}),"\n",(0,i.jsxs)(n.p,{children:["If typical error responses are encountered, such as ",(0,i.jsx)(n.code,{children:"X-Infection-Found: Type=2; Resolution=2; Threat=Encrypted container violation;"}),", they will be reported as a fail symbol (e.g. CLAM_ICAP_FAIL(0.00){Encrypted container violation})."]}),"\n",(0,i.jsx)(n.p,{children:"Depending on the ICAP software there are some extra options available:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\nicap {\n  user_agent = "Rspamd"; # Use none, extended or a self defined name\n  x_client_header = true; # Add X-Client-IP: $IP header\n  x_rcpt_header = true; # Add X-Rcpt-To: $SMTP_RCPT header\n  x_from_header = true; # Add X-Mail-From: $SMTP_FROM header\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"Here some configuration examples for ICAP capable products:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\n# C-ICAP Squidclamav\nsquidclamav {\n  type = "icap";\n  scheme = "squidclamav";\n  ...\n}\n\n# Checkpoint Sandblast\nsandblast {\n  type = "icap";\n  scheme = "sandblast";\n  ...\n}\n\n# ESET Gateway Security / Antivirus for Linux\neset {\n  type = "icap";\n  scheme = "scan";\n  ...\n}\n\n# F-Secure Internet Gatekeeper\nf-secure {\n  type = "icap";\n  scheme = "respmod";\n  x_client_header = true;\n  x_rcpt_header = true;\n  x_from_header = true;\n  ...\n}\n\n# Kaspersky Scan Engine 2.0 (as configured in kavicapd.xml):\nkaspersky {\n  type = "icap";\n  scheme = "resp";\n  x_client_header = true;\n  ...\n}\n\n# Kaspersky Web Traffic Security\nkaspersky {\n  type = "icap";\n  scheme = "av/respmod";\n  x_client_header = true;\n  ...\n}\n\n# McAfee Web Gateway 9/10/11 (Headers must be activated with personal extra Rules)\nmcafee {\n  type = "icap";\n  scheme = "respmod";\n  x_client_header = true;\n  ...\n}\n\n# Metadefender ICAP\nmetadefender {\n  type = "icap";\n  scheme = ""\n  x_client_header = true;\n}\n\n# Sophos SAVDI example:\nsophos {\n  type = "icap";\n  # scheme as configured in savdi.conf (name option in service section)\n  scheme = "respmod";\n  ...\n}\n\n# Symantec Protection Engine for Cloud Services\nsymantec {\n  type = "icap";\n  scheme = "avscan";\n  ...\n}\n\n# Trend Micro IWSVA example (X-Virus-ID/X-Infection-Found headers must be activated):\ntrend_micro {\n  type = "icap";\n  scheme = "avscan";\n  x_client_header = true;\n  ...\n}\n\n# Trend Micro Web Gateway example (X-Virus-ID/X-Infection-Found headers must be activated):\ntrend_micro {\n  type = "icap";\n  scheme = "interscan";\n  x_client_header = true;\n  ...\n}\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"oletools-specific-details",children:"oletools specific details"}),"\n",(0,i.jsx)(n.p,{children:"Oletools is an excellent Python module for scanning and analyzing office documents containing macros. Macro-viruses typically use an auto-exec function to load when the document is opened, as well as functions for executing code in a shell or saving files to the system. Oletools classifies harmful functions as either AutoExec or Suspicious. In the default mode, the Oletools module sets the result when at least one AutoExec and one Suspicious function are used."}),"\n",(0,i.jsxs)(n.p,{children:["Please keep in mind that Oletools is not an antivirus scanner. It only analyzes macros. Additionally, there are legitimate office files that contain AutoExec and Suspicious functions. Furthermore, some macro viruses do not use AutoExec functions. If you want more detailed control over the behavior of the Oletools module, please refer to the extended mode below. You may also want to refer to the olevba documentation at ",(0,i.jsx)(n.a,{href:"https://github.com/decalage2/oletools/wiki/olevba",children:"https://github.com/decalage2/oletools/wiki/olevba"})]}),"\n",(0,i.jsx)(n.p,{children:"The default behavior of Oletools is useful if you do not want to block all office files with macros, but rather files with macros that use functions typically seen in macro viruses."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"}),": Some Word files may have the .doc extension but actually use the Rich Text Format (RTF), which has its own security vulnerabilities. Currently, oletools returns a RETURN_OPEN_ERROR for RTF files, but this issue will be resolved in a future release."]}),"\n",(0,i.jsxs)(n.p,{children:["To use oletools with Rspamd, you need to install a wrapper daemon called ",(0,i.jsx)(n.a,{href:"https://github.com/HeinleinSupport/olefy",children:"olefy"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Olefy communicates with Rspamd over TCP and utilizes olevba to generate a report on an office file."}),"\n",(0,i.jsx)(n.h3,{id:"oletools-default-mode",children:"oletools default mode"}),"\n",(0,i.jsxs)(n.p,{children:["In order to send only office files to the olevba analyzer enable scan_mime_parts (needed for versions < 1.9.5) set mime_parts_filter_regex and mime_parts_filter_ext like shown below (maybe this list is still incomplete). It is worth noting that sometimes office files may be sent with the generic content-type ",(0,i.jsx)(n.code,{children:"application/octet-stream"}),". You can enable the ",(0,i.jsx)(n.code,{children:"UNKNOWN"})," option to capture these, but this may also capture non-office file attachments such as images, PDFs, and so on. Attempting to send non-office files to olevba will result in error messages."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\noletools {\n  ...\n  # default olefy settings\n  servers = "127.0.0.1:10050"\n\n  # needs to be set explicitly for Rspamd < 1.9.5\n  scan_mime_parts = true;\n\n  # mime-part regex matching in content-type or filename\n  mime_parts_filter_regex {\n    #UNKNOWN = "application\\/octet-stream";\n    DOC2 = "application\\/msword";\n    DOC3 = "application\\/vnd\\.ms-word.*";\n    XLS = "application\\/vnd\\.ms-excel.*";\n    PPT = "application\\/vnd\\.ms-powerpoint.*";\n    GENERIC = "application\\/vnd\\.openxmlformats-officedocument.*";\n  }\n  # mime-part filename extension matching (no regex)\n  mime_parts_filter_ext {\n    doc = "doc";\n    dot = "dot";\n    docx = "docx";\n    dotx = "dotx";\n    docm = "docm";\n    dotm = "dotm";\n    xls = "xls";\n    xlt = "xlt";\n    xla = "xla";\n    xlsx = "xlsx";\n    xltx = "xltx";\n    xlsm = "xlsm";\n    xltm = "xltm";\n    xlam = "xlam";\n    xlsb = "xlsb";\n    ppt = "ppt";\n    pot = "pot";\n    pps = "pps";\n    ppa = "ppa";\n    pptx = "pptx";\n    potx = "potx";\n    ppsx = "ppsx";\n    ppam = "ppam";\n    pptm = "pptm";\n    potm = "potm";\n    ppsm = "ppsm";\n  }\n  ...\n}\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["By default, when using the oletools module, a symbol description will be set as ",(0,i.jsx)(n.code,{children:"OLETOOLS(1.00)[AutoExec + Suspicious (Document_open,Shell,Chr)]"}),". The words inside the brackets are the macro functions reported by olevba."]}),"\n",(0,i.jsx)(n.p,{children:"If you enable debug mode for external_services the oletools module will also report the description of a function as reported by olevba."}),"\n",(0,i.jsx)(n.h3,{id:"oletools-extended-mode",children:"oletools extended mode"}),"\n",(0,i.jsxs)(n.p,{children:["In extended mode, the oletools module does not trigger on specific categories but always sets a threat string with all the found flags whenever a macro is detected. These flags are sorted alphabetically and displayed at the same position every time they are set. Additionally, all reported functions are set as individual threats. For instance, ",(0,i.jsx)(n.code,{children:"OLETOOLS (4.00)[A----MS-, Document_open, Shell, Chr]"}),"indicates four threats reported: one for the flag list and one for each reported function. Note that the symbol score is counted four times. If you want to modify this behavior, you can use ",(0,i.jsx)(n.code,{children:"one_shot = true"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services_group.conf\n...\n  "OLETOOLS" {\n    weight = 1.0;\n    description = "OLETOOLS found a Macro";\n    one_shot = true;\n  }\n...\n'})}),"\n",(0,i.jsx)(n.p,{children:"By having the flags and functions as individual threats, it becomes possible to use the pattern configuration to convert the reported threats into symbols that can be utilized in force_actions or composites."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# local.d/external_services.conf\n\noletools {\n  ...\n\n  extended = true;\n\n  patterns {\n    # catch Macro, AutoExec, Suspicious and Hex Strings\n    BAD_MACRO_MYFLAGS   = '^A..H.MS.$';\n    BAD_MACRO_RISKY_IOC = '^A...IMS.$';\n    BAD_MACRO_SHELL     = '^Shell$';\n  }\n  ...\n}\n\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can then use those patterns in the group configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services_group.conf\ndescription = "Oletools content rules";\nsymbols = {\n...\n  "OLETOOLS" {\n    weight = 1.0;\n    description = "OLETOOLS found a Macro";\n    one_shot = true;\n  },\n  "BAD_MACRO_MYFLAGS" {\n    weight = 5.0;\n    description = "Suspicious hex strings in office document";\n  },\n  "BAD_MACRO_RISKY_IOC" {\n    weight = 10.0;\n    description = "Risky macro in office document";\n  }\n...\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"A little help for the 8 flags:"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ABDHIMSV"})," or ",(0,i.jsx)(n.code,{children:"A-------"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"A=Auto-executable (auto-executable macros)"}),"\n",(0,i.jsx)(n.li,{children:"B=Base64 strings (Base64-encoded strings (potential obfuscation))"}),"\n",(0,i.jsx)(n.li,{children:"D=Dridex strings (Dridex-encoded strings (potential obfuscation))"}),"\n",(0,i.jsx)(n.li,{children:"H=Hex strings (hex-encoded strings (potential obfuscation))"}),"\n",(0,i.jsx)(n.li,{children:"I=IOCs (macro contains IP, URL or executable filename)"}),"\n",(0,i.jsx)(n.li,{children:"M=Macros (contains VBA Macros)"}),"\n",(0,i.jsx)(n.li,{children:"S=Suspicious keywords (suspicious VBA keywords)"}),"\n",(0,i.jsx)(n.li,{children:"V=VBA strings (VBA string expressions (potential obfuscation))"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Note that in versions <= 2.7, flags were ordered but stacked to the right in the flag string. For instance, if flags ",(0,i.jsx)(n.code,{children:"A"}),", ",(0,i.jsx)(n.code,{children:"I"}),", ",(0,i.jsx)(n.code,{children:"M"})," and ",(0,i.jsx)(n.code,{children:"S"})," are be set, the resulting flag string would be ",(0,i.jsx)(n.code,{children:"----AIMS"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"dcc-specific-details",children:"DCC specific details"}),"\n",(0,i.jsxs)(n.p,{children:["This modules performs ",(0,i.jsx)(n.a,{href:"https://www.dcc-servers.net/dcc/",children:"DCC"})," lookups to determine\nthe ",(0,i.jsx)(n.em,{children:"bulkiness"})," of a message (e.g. how many recipients have seen it)."]}),"\n",(0,i.jsx)(n.p,{children:"This is particularly valuable in composite rules, such as when a message is from a freemail domain AND it is identified as bulk by DCC, making it easier to classify it as spam and assign a higher weight to it."}),"\n",(0,i.jsx)(n.p,{children:"Before enabling this module, kindly review the License terms on the DCC website."}),"\n",(0,i.jsx)(n.h3,{id:"module-configuration",children:"Module configuration"}),"\n",(0,i.jsxs)(n.p,{children:["This module requires that you have the ",(0,i.jsx)(n.code,{children:"dccifd"})," daemon configured, running and\nworking correctly.  To do this you must download and build the [latest DCC client]\n(",(0,i.jsx)(n.a,{href:"https://www.dcc-servers.net/dcc/source/dcc.tar.Z",children:"https://www.dcc-servers.net/dcc/source/dcc.tar.Z"}),"). Once installed, edit\n",(0,i.jsx)(n.code,{children:"/var/dcc/dcc_conf"})," set ",(0,i.jsx)(n.code,{children:"DCCIFD_ENABLE=on"})," and set ",(0,i.jsx)(n.code,{children:"DCCM_LOG_AT=NEVER"})," and\n",(0,i.jsx)(n.code,{children:"DCCM_REJECT_AT=MANY"}),". Maybe you want DCC to listen to a TCP socket by setting ",(0,i.jsx)(n.code,{children:'DCCIFD_ARGS="-SHELO -Smail_host -SSender -SList-ID -p *,10045,127.0.0.0/8"'}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Then start the daemon by running ",(0,i.jsx)(n.code,{children:"/var/dcc/libexec/rcDCC start"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Once the ",(0,i.jsx)(n.code,{children:"dccifd"})," daemon is started it will listen on the UNIX domain socket /var/dcc/dccifd or on localhost port 10045\nand all you have to do is tell the rspamd where ",(0,i.jsx)(n.code,{children:"dccifd"})," is listening."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\ndcc {\n  ...\n  #servers = "/var/dcc/dccifd" # use unix socket\n  #servers = "127.0.0.1:10045" # use tcp socket\n  ...\n}\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["DCC identifies bulky mails by creating hash and therefor DCC needs the complete message to work properly. ",(0,i.jsx)(n.code,{children:"scan_mime_parts = false"})," is already set in the defaults."]}),"\n",(0,i.jsxs)(n.p,{children:["Any messages that DCC returns a ",(0,i.jsx)(n.em,{children:"reject"})," result for (based on the configured ",(0,i.jsx)(n.code,{children:"DCCM_REJECT_AT"}),"\nvalue) will cause the symbol ",(0,i.jsx)(n.code,{children:"DCC_REJECT"})," to fire. ",(0,i.jsx)(n.code,{children:"DCC_BULK"})," will be calculated from the body, fuz1, fuz2 return values and has a dynamic score."]}),"\n",(0,i.jsx)(n.h2,{id:"pyzor-specific-details",children:"Pyzor specific details"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"Requires rspamd >2.8"})}),"\n",(0,i.jsx)(n.p,{children:'Pyzor is a bulk email scanner similar to Razor2 and DCC, which doesn\'t identify spam but instead identifies how often a message (hash) has been seen or how "bulky" a message is.'}),"\n",(0,i.jsxs)(n.p,{children:["To integrate Pyzor with Rspamd, a wrapper isn't needed as it will be exposed to Rspamd through a systemd socket. To install Pyzor on CentOS/Rocky Linux, run the command ",(0,i.jsx)(n.code,{children:"yum install pyzor"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"After installing Pyzor, enable the module by:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n...\npyzor {\n  # default pyzor settings\n  servers = "127.0.0.1:5953"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Restart rspamd ",(0,i.jsx)(n.code,{children:"systemctl restart rspamd"})]}),"\n",(0,i.jsx)(n.p,{children:"Add the systemd socket and service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# /usr/lib/systemd/system/pyzor.socket\n\n[Unit]\nDescription=Pyzor socket\n\n[Socket]\nListenStream=127.0.0.1:5953\nAccept=yes\n\n[Install]\nWantedBy=sockets.target\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# /usr/lib/systemd/system/pyzor@.service\n\n[Unit]\nDescription=Pyzor Socket Service\nRequires=pyzor.socket\n\n[Service]\nType=simple\nExecStart=-/usr/bin/pyzor check\nStandardInput=socket\nStandardError=journal\nTimeoutStopSec=10\n\nUser=_rspamd\nNoNewPrivileges=true\nPrivateDevices=true\nPrivateTmp=true\nPrivateUsers=true\nProtectControlGroups=true\nProtectHome=true\nProtectKernelModules=true\nProtectKernelTunables=true\nProtectSystem=strict\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Reload systemd ",(0,i.jsx)(n.code,{children:"systemctl daemon-reload"})," and enable/start pyzor socket ",(0,i.jsx)(n.code,{children:"systemctl enable pyzor.socket && systemctl start pyzor.socket"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"pyzor.socket"})," will call ",(0,i.jsx)(n.code,{children:"pyzor@.service"})," so there is no need to enable/start ",(0,i.jsx)(n.code,{children:"pyzor@.service"})]}),"\n",(0,i.jsxs)(n.p,{children:["Since Pyzor is executed as ",(0,i.jsx)(n.code,{children:"_rspamd"})," you probably have to create the Pyzor home directory ",(0,i.jsx)(n.code,{children:"mkdir /var/lib/rspamd/.pyzor"}),", alternatively create a dedicated Pyzor user and edit ",(0,i.jsx)(n.code,{children:"pyzor@.service"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Once Pyzor is running, the ",(0,i.jsx)(n.code,{children:"PYZOR"})," symbol weight is calculated dynamically based on the number of times a message has been seen and whitelisted by Pyzor (Count - WL-Count of default_score in percent)"]}),"\n",(0,i.jsx)(n.h2,{id:"razor-specific-details",children:"Razor specific details"}),"\n",(0,i.jsx)(n.p,{children:'Razor is, like Pyzor and DCC, a bulk email scanner that doesn\'t detect spam but how often a message (hash) has been seen, or how "bulky" a message is.'}),"\n",(0,i.jsx)(n.p,{children:"To expose Razor to rspamd, a systemd socket is used, and a wrapper is not required."}),"\n",(0,i.jsxs)(n.p,{children:["To install Razor on CentOS/Rocky Linux, run the command yum install ",(0,i.jsx)(n.code,{children:"perl-Razor-Agent"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"After installation, enable the module by modifying the configuration file."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n...\nrazor {\n  # default razor settings\n  servers = "127.0.0.1:11342"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Restart rspamd ",(0,i.jsx)(n.code,{children:"systemctl restart rspamd"})]}),"\n",(0,i.jsx)(n.p,{children:"Add the systemd socket and service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# /usr/lib/systemd/system/razor.socket\n\n[Unit]\nDescription=Razor socket\n\n[Socket]\nListenStream=127.0.0.1:11342\nAccept=yes\n\n[Install]\nWantedBy=sockets.target\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# /usr/lib/systemd/system/razor@.service\n\n[Unit]\nDescription=Razor Socket Service\nRequires=razor.socket\n\n[Service]\nType=simple\nExecStart=/bin/sh -c \'/usr/bin/razor-check && /usr/bin/echo -n "spam" || /usr/bin/echo -n "ham"\'\nStandardInput=socket\nStandardError=journal\nTimeoutStopSec=10\n\nUser=_rspamd\nNoNewPrivileges=true\nPrivateDevices=true\nPrivateTmp=true\nPrivateUsers=true\nProtectControlGroups=true\nProtectHome=true\nProtectKernelModules=true\nProtectKernelTunables=true\nProtectSystem=strict\n\n[Install]\nWantedBy=multi-user.target\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Reload systemd ",(0,i.jsx)(n.code,{children:"systemctl daemon-reload"})," and enable/start razor socket ",(0,i.jsx)(n.code,{children:"systemctl enable razor.socket && systemctl start razor.socket"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"razor.socket"})," will call ",(0,i.jsx)(n.code,{children:"razor@.service"})," so there is no need to enable/start ",(0,i.jsx)(n.code,{children:"razor@.service"})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"RAZOR"})," symbole will be added based on the exit code of Razor (0 = SPAM or 1 = HAM)"]}),"\n",(0,i.jsx)(n.h2,{id:"vadesecure-specific-details",children:"VadeSecure specific details"}),"\n",(0,i.jsxs)(n.p,{children:["To use the VadeSecure module, a valid installation of Filterd from ",(0,i.jsx)(n.a,{href:"https://www.vadesecure.com/en/isp-products/",children:"VadeSecure"})," is required. Please ",(0,i.jsx)(n.a,{href:"https://www.vadesecure.com",children:"contact VadeSecure"})," to obtain a valid trial or commercial license to get this product."]}),"\n",(0,i.jsxs)(n.p,{children:["Once installed, you can use VadeSecure to adjust symbols based on the category returned by Filterd. The default settings for this module are listed below and can be redefined in the ",(0,i.jsx)(n.code,{children:"local.d/external_services.conf"})," file as needed:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"vadesecure {\n  servers = 127.0.0.1,\n  default_port = 23808,\n  url = '/api/v1/scan',\n  use_https = false,\n  timeout = 5.0,\n  log_clean = false,\n  retransmits = 1,\n  cache_expire = 7200,\n  message = '${SCANNER}: spam message found: \"${VIRUS}\"',\n  detection_category = \"hash\",\n  default_score = 1,\n  action = false,\n  log_spamcause = true,\n  symbol_fail = 'VADE_FAIL',\n  symbol = 'VADE_CHECK',\n  symbols = {\n    clean = {\n      symbol = 'VADE_CLEAN',\n      score = -0.5,\n      description = 'VadeSecure decided message to be clean'\n    },\n    spam = {\n      high = {\n        symbol = 'VADE_SPAM_HIGH',\n        score = 8.0,\n        description = 'VadeSecure decided message to be clearly spam'\n      },\n      medium = {\n        symbol = 'VADE_SPAM_MEDIUM',\n        score = 5.0,\n        description = 'VadeSecure decided message to be highly likely spam'\n      },\n      low = {\n        symbol = 'VADE_SPAM_LOW',\n        score = 2.0,\n        description = 'VadeSecure decided message to be likely spam'\n      },\n    },\n    malware = {\n      symbol = 'VADE_MALWARE',\n      score = 8.0,\n      description = 'VadeSecure decided message to be malware'\n    },\n    scam = {\n      symbol = 'VADE_SCAM',\n      score = 7.0,\n      description = 'VadeSecure decided message to be scam'\n    },\n    phishing = {\n      symbol = 'VADE_PHISHING',\n      score = 8.0,\n      description = 'VadeSecure decided message to be phishing'\n    },\n    commercial =  {\n      symbol = 'VADE_COMMERCIAL',\n      score = 0.0,\n      description = 'VadeSecure decided message to be commercial message'\n    },\n    community =  {\n      symbol = 'VADE_COMMUNITY',\n      score = 0.0,\n      description = 'VadeSecure decided message to be community message'\n    },\n    transactional =  {\n      symbol = 'VADE_TRANSACTIONAL',\n      score = 0.0,\n      description = 'VadeSecure decided message to be transactional message'\n    },\n    suspect = {\n      symbol = 'VADE_SUSPECT',\n      score = 3.0,\n      description = 'VadeSecure decided message to be suspicious message'\n    },\n    bounce = {\n      symbol = 'VADE_BOUNCE',\n      score = 0.0,\n      description = 'VadeSecure decided message to be bounce message'\n    },\n    other = 'VADE_OTHER',\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can define subcategories for symbols if needed (see ",(0,i.jsx)(n.code,{children:"spam"})," example above)."]}),"\n",(0,i.jsx)(n.h2,{id:"spamassassin-specific-details",children:"SpamAssassin specific details"}),"\n",(0,i.jsx)(n.p,{children:"Note that the SpamAssassin module in External Services requires the use of the spamd daemon. However, please keep in mind that there is also a dedicated SpamAssassin module for Rspamd, which offers different benefits. The dedicated module can load SpamAssassin rules directly into the Rspamd environment, whereas the External Services module communicates with a separate SpamAssassin installation."}),"\n",(0,i.jsx)(n.p,{children:"It's worth noting that compared to Rspamd, SpamAssassin is much more CPU-intensive and may slow down your server. If you only need to use your existing SpamAssassin rules, the dedicated module is a better option, or you could transfer your rules into multimaps and/or composites."}),"\n",(0,i.jsx)(n.p,{children:"However, the External Services module offers the benefit of supporting all SpamAssassin features and plugins, such as iXHash. If you're using the Neural Network plugin, you may not want to import thousands of extra symbols into Rspamd. Additionally, this module could be a good choice for a soft migration from a SpamAssassin setup to Rspamd."}),"\n",(0,i.jsx)(n.h3,{id:"spamd-setup",children:"Spamd setup"}),"\n",(0,i.jsx)(n.p,{children:"Enable the spamassassin spamd daemon to listen on a socket or a TCP port. To improve performance, you may want to consider disabling any unused plugins or remote checks by editing the configuration files located in /etc/mail/spamassassin."}),"\n",(0,i.jsx)(n.h3,{id:"spamassassin-module-default-setup",children:"spamassassin module default setup"}),"\n",(0,i.jsxs)(n.p,{children:["By default, no special configuration is required for this module. It will automatically set all reported SpamAssassin symbols as strings into the Rspamd SPAMD symbol, and the score reported by spamd will be set as the dynamic score. If you specify a weight for the symbol, it will be used as a multiplier. So, the total score will be calculated as ",(0,i.jsx)(n.code,{children:"dynamic_score * weight"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\nspamassassin {\n  symbol = "SPAMD"\n  type = "spamassassin";\n  servers = "127.0.0.1:783";\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"spamassassin-module-extended-setup",children:"spamassassin module extended setup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# local.d/external_services.conf\n\nspamassassin {\n  ...\n  extended = true;\n  ...\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When setting ",(0,i.jsx)(n.code,{children:"extended = true"})," the module will set all reported symbols as dedicated threats. However, keep in mind that in the extended configuration, the score is calculated by multiplying the number of threats with the dynamic score and weight, resulting in the total score. If you want to change this behavior, you can ",(0,i.jsx)(n.code,{children:"set one_shot = true"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services_group.conf\nsymbols = {\n...\n  "SPAMD" {\n    weight = 1.0;\n    description = "SPAMD found symbols";\n    one_shot = true;\n  }\n...\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Having every symbol set as dedicated threat it is possible to set a Rspamd symbol for reported spamassassin symbols using patters."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\nspamassassin {\n  ...\n  patterns {\n    # symbol_name = "pattern";\n    SPAMD_NIXSPAM_IXHASH = "^NIXSPAM_IXHASH$";\n    SPAMD_GENERIC_IXHASH = "^GENERIC_IXHASH$";\n  }\n  ...\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"virustotal-details",children:"Virustotal details"}),"\n",(0,i.jsxs)(n.p,{children:["To receive results, Rspamd utilizes the ",(0,i.jsx)(n.a,{href:"https://virustotal.readme.io/v2.0/reference/file-report",children:(0,i.jsx)(n.code,{children:"file/report"})})," endpoint of Virustotal. However, due to the strict policies of Virustotal, it is crucial that you have set your own key in the plugin configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:"# local.d/antivirus.conf\nvirustotal {\n  # Obtained from Virustotal\n  apikey = \"xxx\";\n  # Change if you use private mirror or another API\n  #url = 'https://www.virustotal.com/vtapi/v2/file';\n  # Minimum required to get scored\n  #minimum_engines = 3;\n  # After this number we set max score\n  #full_score_engines = 7;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Due to the strict policies of Virustotal, Rspamd does not return the full result. Instead, it only provides the number of engines that matched and the MD5 hash, which can be used to view the full report on the Virustotal website."}),"\n",(0,i.jsx)(n.h2,{id:"cloudmark-specific-details",children:"Cloudmark specific details"}),"\n",(0,i.jsx)(n.p,{children:"The cloudmark external service requires Cloudmark Authority Server, refer to the cloudmark website for information."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services.conf\n\ncloudmark {\n  type = "cloudmark";\n  servers = "127.0.0.1:2780";\n  use_https = false;\n  action = "process"\n  timeout = 5.0;\n  # add X-CMAE-Score header to the email\n  add_score_header = true;\n  # add additional cloudmark headers to the email \n  add_headers = true;\n  # log clean messages as well\n  log_clean = false;\n  # the threshold at which you consider message spam\n  score_threshold = 90;\n  # maximum message size to scan, 0 to disable and send every message\n  max_message = 0;\n  # symbol to use when scan detects spam\n  symbol_spam = \'CLOUDMARK_SPAM\';\n  # a table with match { [score_threshold] = symbol, ... }\n  # this allows you to score different thresholds\n  scores_symbols = {\n    100: "CLOUDMARK100",\n    95: "CLOUDMARK95",\n    0: "CLOUDMARK0"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"You can configure symbol scores in the external_services_group.yml"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-hcl",children:'# local.d/external_services_group.conf\nsymbols =  {\n  CLOUDMARK_SPAM {\n    weight = 5.0;\n    description = "Spam detected by Cloudmark";\n  }\n  CLOUDMARK100 {\n    weight = 2.0;\n    description = "Spam detected by Cloudmark";\n  }\n  CLOUDMARK95 {\n    weight = 1.0;\n    description = "Spam detected by Cloudmark";\n  }\n  CLOUDMARK0 {\n    weight = 0.0;\n    description = "Cloudmark HAM";\n  }\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);