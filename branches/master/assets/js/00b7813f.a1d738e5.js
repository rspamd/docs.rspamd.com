"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[4696],{28453:(e,s,t)=>{t.d(s,{R:()=>i,x:()=>o});var n=t(96540);const r={},d=n.createContext(r);function i(e){const s=n.useContext(d);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(d.Provider,{value:s},e.children)}},51114:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"modules/rspamd_update","title":"Rspamd update module","description":"This module enables you to load rspamd rules, adjust symbol scores, and implement actions without restarting the full daemon. The rspamd_update method facilitates the backporting of new rules and score changes without the need to update rspamd itself. This feature can be particularly useful if you wish to use the stable version of rspamd while simultaneously improving the quality of filtering.","source":"@site/docs/modules/rspamd_update.md","sourceDirName":"modules","slug":"/modules/rspamd_update","permalink":"/docs.rspamd.com/branches/master/modules/rspamd_update","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/rspamd_update.md","tags":[],"version":"current","frontMatter":{"title":"Rspamd update module"},"sidebar":"docs","previous":{"title":"Reputation module","permalink":"/docs.rspamd.com/branches/master/modules/reputation"},"next":{"title":"SpamAssassin rules module","permalink":"/docs.rspamd.com/branches/master/modules/spamassassin"}}');var r=t(74848),d=t(28453);const i={title:"Rspamd update module"},o="Rspamd update module",a={},l=[{value:"Security considerations",id:"security-considerations",level:2},{value:"Module configuration",id:"module-configuration",level:2},{value:"Updates structure",id:"updates-structure",level:2}];function c(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"rspamd-update-module",children:"Rspamd update module"})}),"\n",(0,r.jsxs)(s.p,{children:["This module enables you to load rspamd rules, adjust symbol scores, and implement actions without restarting the full daemon. The ",(0,r.jsx)(s.code,{children:"rspamd_update"})," method facilitates the backporting of new rules and score changes without the need to update rspamd itself. This feature can be particularly useful if you wish to use the stable version of rspamd while simultaneously improving the quality of filtering."]}),"\n",(0,r.jsx)(s.h2,{id:"security-considerations",children:"Security considerations"}),"\n",(0,r.jsxs)(s.p,{children:["The Rspamd update module can execute Lua code, which is run with the scanner's privileges, typically under the ",(0,r.jsx)(s.code,{children:"_rspamd"})," or ",(0,r.jsx)(s.code,{children:"nobody"})," user. Therefore, it's important to avoid using untrusted sources of updates. Rspamd supports digital signatures to validate the authenticity of updates downloaded using the using ",(0,r.jsx)(s.a,{href:"https://ed25519.cr.yp.to/",children:"EdDSA"})," signatures scheme.\nFor your own updates that are loaded from the filesystem or from some trusted network you might use unsigned files, however, signing is recommended even in this case."]}),"\n",(0,r.jsxs)(s.p,{children:["For your own updates that are loaded from the file system or a trusted network, you might be able to use unsigned files. However, we recommend that you sign even in this scenario. To sign a map, you can use ",(0,r.jsx)(s.code,{children:"rspamadm signtool"}),", and to generate a signing keypair, use ",(0,r.jsx)(s.code,{children:"rspamadm keypair -s -u"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'keypair {\n   pubkey = "zo4sejrs9e5idqjp8rn6r3ow3x38o8hi5pyngnz6ktdzgmamy48y";\n   privkey = "pwq38sby3yi68xyeeuup788z6suqk3fugrbrxieri637bypqejnqbipt1ec9tsm8h14qerhj1bju91xyxamz5yrcrq7in8qpsozywxy";\n   id = "bs4zx9tcf1cs5ed5mt4ox8za54984frudpzzny3jwdp8mkt3feh7nz795erfhij16b66piupje4wooa5dmpdzxeh5mi68u688ixu3yd";\n   encoding = "base32";\n   algorithm = "curve25519";\n   type = "sign";\n}\n'})}),"\n",(0,r.jsxs)(s.p,{children:["Then you can use ",(0,r.jsx)(s.code,{children:"signtool"})," to edit map's file:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"rspamadm signtool -e --editor=vim -k <keypair_file> <map_file>\n"})}),"\n",(0,r.jsxs)(s.p,{children:["To enforce signing policies you should add ",(0,r.jsx)(s.code,{children:"sign+"})," string to your map definition:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'map = "sign+http://example.com/map"\n'})}),"\n",(0,r.jsxs)(s.p,{children:["To specify trusted key you could either put ",(0,r.jsx)(s.strong,{children:"public"})," key from the keypair to ",(0,r.jsx)(s.code,{children:"local.d/options.inc"})," file as following:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'trusted_keys = ["<public key string>"];\n'})}),"\n",(0,r.jsxs)(s.p,{children:["or add it as ",(0,r.jsx)(s.code,{children:"key"})," definition to the map string:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'map = "sign+key=<key_string>+http://example.com/map"\n'})}),"\n",(0,r.jsx)(s.h2,{id:"module-configuration",children:"Module configuration"}),"\n",(0,r.jsx)(s.p,{children:"The module itself has very few parameters:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"key"}),": use this key (base32 encoded) as trusted key"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["All other keys are threated as rules to load maps. By default, Rspamd tries to load signed updates from ",(0,r.jsx)(s.code,{children:"rspamd.com"})," site using trusted key ",(0,r.jsx)(s.code,{children:"qxuogdh5eghytji1utkkte1dn3n81c3y5twe61uzoddzwqzuxxyb"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:'rspamd_update {\n    rules = "sign+http://rspamd.com/update/rspamd-${BRANCH_VERSION}.ucl";\n    key = "qxuogdh5eghytji1utkkte1dn3n81c3y5twe61uzoddzwqzuxxyb";\n}\n'})}),"\n",(0,r.jsx)(s.h2,{id:"updates-structure",children:"Updates structure"}),"\n",(0,r.jsx)(s.p,{children:"Update files are quite simple: they have 3 sections:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"symbols"})," - list of new scores for symbols that are already in rspamd (loaded with ",(0,r.jsx)(s.code,{children:"priority = 1"})," to override default settings)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"actions"})," - list of scores for actions (also loaded with ",(0,r.jsx)(s.code,{children:"priority = 1"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rules"})," - list of lua code fragments to load into rspamd, they can use ",(0,r.jsx)(s.code,{children:"rspamd_config"})," global to register new rules"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Here is an example of update file:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-hcl",children:"rules = {\n\ttest =<<EOD\nrspamd_config.TEST = {\n\tcallback = function(task) return true end,\n\tscore = 1.0,\n\tdescription = 'test',\n}\nEOD\n}\nactions = {\n\tgreylist = 3.4,\n}\nsymbols = {\n\tR_DKIM_ALLOW = -0.5,\n}\n"})})]})}function u(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);