"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[6051],{5300(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"modules/antivirus","title":"Antivirus module","description":"The Antivirus module, available from Rspamd version 1.4, integrates with various virus scanners. Currently, the following scanners are supported:","source":"@site/docs/modules/antivirus.md","sourceDirName":"modules","slug":"/modules/antivirus","permalink":"/docs.rspamd.com/branches/master/modules/antivirus","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/antivirus.md","tags":[],"version":"current","frontMatter":{"title":"Antivirus module"},"sidebar":"docs","previous":{"title":"Modules documentation","permalink":"/docs.rspamd.com/branches/master/modules/"},"next":{"title":"ARC module","permalink":"/docs.rspamd.com/branches/master/modules/arc"}}');var r=s(4848),d=s(8453);const t={title:"Antivirus module"},c="Antivirus module",l={},o=[{value:"Configuration",id:"configuration",level:2},{value:"Common configuration options",id:"common-configuration-options",level:3},{value:"Pattern matching",id:"pattern-matching",level:3},{value:"MIME part filtering",id:"mime-part-filtering",level:3},{value:"Redis caching",id:"redis-caching",level:3},{value:"ClamAV",id:"clamav",level:2},{value:"Sophos SAVDI",id:"sophos-savdi",level:2},{value:"Avira SAVAPI",id:"avira-savapi",level:2},{value:"Kaspersky",id:"kaspersky",level:2},{value:"Kaspersky Scan Engine",id:"kaspersky-scan-engine",level:2},{value:"Avast",id:"avast",level:2},{value:"VirusTotal",id:"virustotal",level:2},{value:"MetaDefender Cloud",id:"metadefender-cloud",level:2},{value:"ICAP Protocol",id:"icap-protocol",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"antivirus-module",children:"Antivirus module"})}),"\n",(0,r.jsx)(n.p,{children:"The Antivirus module, available from Rspamd version 1.4, integrates with various virus scanners. Currently, the following scanners are supported:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.avast.com/business/products/antivirus-for-linux",children:"Avast Antivirus"})," (via socket protocol)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://oem.avira.com/en/solutions/anti-malware#SAV",children:"Avira"})," (via SAVAPI)"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.clamav.net",children:"ClamAV"})}),"\n",(0,r.jsx)(n.li,{children:"F-Prot (End-of-Life as of 31-July-2021)"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.kaspersky.com/small-to-medium-business-security/linux-mail-server",children:"Kaspersky antivirus"})," (from 1.8.3)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.kaspersky.com/scan-engine",children:"Kaspersky Scan Engine"})," (from 2.0)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://metadefender.opswat.com/",children:"MetaDefender Cloud"})," (hash-based lookups)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.sophos.com/",children:"Sophos"})," (via SAVDI)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.virustotal.com/",children:"VirusTotal"})," (hash-based lookups)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["The configuration for an antivirus setup is accomplished by defining rules. If the antivirus reports one or more viruses, the configured symbol (e.g. ",(0,r.jsx)(n.code,{children:"CLAM_VIRUS"}),") will be set, with the virus name as the description. If set, the configured action will be triggered."]}),"\n",(0,r.jsxs)(n.p,{children:["In case of errors during the connection or if the antivirus reports failures, the fail symbol (e.g. ",(0,r.jsx)(n.code,{children:"CLAM_VIRUS_FAIL"}),") will be set, with the error message as the description. The ",(0,r.jsx)(n.a,{href:"/modules/force_actions",children:"force_actions"})," module can be used to perform a ",(0,r.jsx)(n.code,{children:"soft reject"})," if the antivirus has failed to scan the email, such as during a database reloading."]}),"\n",(0,r.jsxs)(n.p,{children:["In addition to the ",(0,r.jsx)(n.code,{children:"SYMBOLNAME"})," and ",(0,r.jsx)(n.code,{children:"SYMBOLNAME_FAIL"})," symbols, there are two special symbols indicating that the scanner has reported encrypted parts or parts with Office macros: ",(0,r.jsx)(n.code,{children:"SYMBOLNAME_ENCRYPTED"})," and ",(0,r.jsx)(n.code,{children:"SYMBOLNAME_MACRO"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Settings should be added to ",(0,r.jsx)(n.code,{children:"/etc/rspamd/local.d/antivirus.conf"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"common-configuration-options",children:"Common configuration options"}),"\n",(0,r.jsx)(n.p,{children:"All scanner types support these common options:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"type"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(required)"}),(0,r.jsxs)(n.td,{children:["Scanner type: ",(0,r.jsx)(n.code,{children:"clamav"}),", ",(0,r.jsx)(n.code,{children:"fprot"}),", ",(0,r.jsx)(n.code,{children:"sophos"}),", ",(0,r.jsx)(n.code,{children:"savapi"}),", ",(0,r.jsx)(n.code,{children:"kaspersky"}),", ",(0,r.jsx)(n.code,{children:"kaspersky_se"}),", ",(0,r.jsx)(n.code,{children:"avast"}),", ",(0,r.jsx)(n.code,{children:"virustotal"}),", ",(0,r.jsx)(n.code,{children:"metadefender"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(auto)"}),(0,r.jsx)(n.td,{children:"Symbol to set when virus is found"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_fail"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{SYMBOL}_FAIL"})}),(0,r.jsx)(n.td,{children:"Symbol to set on scan failure"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_encrypted"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{SYMBOL}_ENCRYPTED"})}),(0,r.jsx)(n.td,{children:"Symbol to set for encrypted content"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_macro"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{SYMBOL}_MACRO"})}),(0,r.jsx)(n.td,{children:"Symbol to set for Office macros"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"servers"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(required)"}),(0,r.jsxs)(n.td,{children:["Server address(es), can be TCP (",(0,r.jsx)(n.code,{children:"host:port"}),") or Unix socket path"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"timeout"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(varies)"}),(0,r.jsx)(n.td,{children:"Connection timeout in seconds"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"retransmits"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(varies)"}),(0,r.jsx)(n.td,{children:"Number of retry attempts on failure"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_size"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Skip scanning for messages larger than this (bytes)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"min_size"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Skip scanning for messages smaller than this (bytes)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"scan_mime_parts"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"true"})}),(0,r.jsx)(n.td,{children:"Scan attachments separately instead of whole message"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"scan_text_mime"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Include text parts when scanning mime parts"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"scan_image_mime"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Include image parts when scanning mime parts"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"log_clean"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Log messages when content is clean"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"action"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsxs)(n.td,{children:["Force this action when virus found (e.g., ",(0,r.jsx)(n.code,{children:"reject"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"message"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(varies)"}),(0,r.jsxs)(n.td,{children:["Custom rejection message, supports ",(0,r.jsx)(n.code,{children:"${SCANNER}"})," and ",(0,r.jsx)(n.code,{children:"${VIRUS}"})," variables"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"whitelist"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Path to map of IP addresses to skip scanning"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"patterns"})}),(0,r.jsx)(n.td,{children:"table"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Regex patterns to map virus names to custom symbols"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"patterns_fail"})}),(0,r.jsx)(n.td,{children:"table"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Regex patterns to map error messages to custom symbols"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"prefix"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(auto)"}),(0,r.jsx)(n.td,{children:"Redis cache key prefix"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"cache_expire"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"3600"}),(0,r.jsx)(n.td,{children:"Redis cache expiration time in seconds"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"no_cache"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Disable Redis caching"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"dynamic_scan"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Skip scanning if message already exceeds 2x reject threshold"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"text_part_min_words"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Minimum words required in text parts to scan"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"show_attachments"})}),(0,r.jsx)(n.td,{children:"boolean"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsx)(n.td,{children:"Include attachment filename in symbol options"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_type"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"normal"})}),(0,r.jsxs)(n.td,{children:["Set to ",(0,r.jsx)(n.code,{children:"postfilter"})," to run after other filters"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"score"})}),(0,r.jsx)(n.td,{children:"number"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Score to assign to the symbol"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"description"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"(none)"}),(0,r.jsx)(n.td,{children:"Description for the symbol"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"group"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"antivirus"})}),(0,r.jsx)(n.td,{children:"Symbol group"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"pattern-matching",children:"Pattern matching"}),"\n",(0,r.jsxs)(n.p,{children:["For virus, encrypted, and macro symbols, patterns can be used to set a dedicated symbol based on the virus name or error message. For failure symbols, use ",(0,r.jsx)(n.code,{children:"patterns_fail"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"patterns {\n  # symbol_name = \"regex_pattern\";\n  JUST_EICAR = '^Eicar-Test-Signature$';\n  SANE_MAL = 'Sanesecurity\\.Malware\\.*';\n  CLAM_UNOFFICIAL = 'UNOFFICIAL$';\n}\npatterns_fail {\n  # symbol_name = \"regex_pattern\";\n  CLAM_LIMITS_EXCEEDED = '^Heuristics\\.Limits\\.Exceeded$';\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"mime-part-filtering",children:"MIME part filtering"}),"\n",(0,r.jsx)(n.p,{children:"From version 3.5, you can filter which mime parts are sent to the scanner using regex patterns or file extensions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# Match content-type or filename with regex\nmime_parts_filter_regex {\n  FILE1 = "^invoice\\.xls$";\n  DOC1 = "application\\/msword";\n  DOC2 = "application\\/vnd\\.ms-word.*";\n  GEN2 = "application\\/vnd\\.openxmlformats-officedocument.*";\n}\n# Match filename extension (no regex)\nmime_parts_filter_ext {\n  doc = "doc";\n  docx = "docx";\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"mime_parts_filter_regex"})," option matches the content-type detected by Rspamd, mime part headers, or the declared filename of an attachment. This also works for files within archives. The ",(0,r.jsx)(n.code,{children:"mime_parts_filter_ext"})," option matches the extension of the declared filename or files within archives."]}),"\n",(0,r.jsx)(n.p,{children:"When any filter is defined, only matching parts are scanned. Without filters, all attachments are scanned."}),"\n",(0,r.jsx)(n.h3,{id:"redis-caching",children:"Redis caching"}),"\n",(0,r.jsxs)(n.p,{children:["By default, if ",(0,r.jsx)(n.a,{href:"/configuration/redis",children:"Redis"})," is configured globally and the ",(0,r.jsx)(n.code,{children:"antivirus"})," option is not explicitly disabled in the Redis configuration, scan results are cached using message checksums. Configure ",(0,r.jsx)(n.code,{children:"cache_expire"})," to control the TTL."]}),"\n",(0,r.jsx)(n.h2,{id:"clamav",children:"ClamAV"}),"\n",(0,r.jsxs)(n.p,{children:["ClamAV is the most commonly used open-source antivirus scanner. It communicates via the ",(0,r.jsx)(n.code,{children:"INSTREAM"})," protocol."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific defaults:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"default_port"}),": 3310"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"timeout"}),": 5.0 seconds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"retransmits"}),": 2"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cache_expire"}),": 3600 seconds"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nclamav {\n  # If set, force this action when any virus is found\n  # action = "reject";\n  # message = \'${SCANNER}: virus found: "${VIRUS}"\';\n  \n  # Scan attachments separately (recommended)\n  scan_mime_parts = true;\n  \n  # Include text/image parts (useful for Sanesecurity databases)\n  # scan_text_mime = false;\n  # scan_image_mime = false;\n  \n  # Skip messages larger than this size\n  # max_size = 20000000;\n  \n  symbol = "CLAM_VIRUS";\n  type = "clamav";\n  \n  # Log clean results\n  # log_clean = false;\n  \n  # Server address (TCP or Unix socket)\n  servers = "127.0.0.1:3310";\n  \n  # Pattern-based symbol mapping\n  patterns {\n    JUST_EICAR = \'^Eicar-Test-Signature$\';\n  }\n  \n  # Whitelist IPs that should not be scanned\n  # whitelist = "/etc/rspamd/antivirus.wl";\n  \n  # Replace this exact string with EICAR for testing\n  # eicar_fake_pattern = \'testpatterneicar\';\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"sophos-savdi",children:"Sophos SAVDI"}),"\n",(0,r.jsx)(n.p,{children:"Sophos SAVDI is a daemon that extends Sophos Anti-Virus for Linux to be reachable via TCP sockets using the SSSP protocol. Both Sophos Anti-Virus for Linux and the Sophos SAVDI daemon must be installed."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific defaults:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"default_port"}),": 4010"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"timeout"}),": 15.0 seconds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"retransmits"}),": 2"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["A sample SAVDI configuration is available at ",(0,r.jsx)(n.a,{href:"https://gist.github.com/c-rosenberg/671b0a5d8b1b5a937e3e161f8515c666",children:"this gist"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nsophos {\n  symbol = "SOPHOS_VIRUS";\n  type = "sophos";\n  servers = "127.0.0.1:4010";\n  scan_mime_parts = true;\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["SAVDI automatically reports encrypted files (",(0,r.jsx)(n.code,{children:"FAIL 0212"}),") and oversized files (",(0,r.jsx)(n.code,{children:"REJ 4"}),") which Rspamd handles appropriately."]}),"\n",(0,r.jsx)(n.h2,{id:"avira-savapi",children:"Avira SAVAPI"}),"\n",(0,r.jsxs)(n.p,{children:["SAVAPI is Avira's scanning interface. By default, it uses a Unix socket, but TCP is recommended for better reliability. Set ",(0,r.jsx)(n.code,{children:"ListenAddress"})," in savapi.conf to configure TCP mode."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific defaults:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"default_port"}),": 4444"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"timeout"}),": 15.0 seconds"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," You must set ",(0,r.jsx)(n.code,{children:"product_id"})," to match your HBEDV.key file ID."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nsavapi {\n  symbol = "SAVAPI_VIRUS";\n  type = "savapi";\n  servers = "127.0.0.1:4444";\n  product_id = 12345;  # Required - must match your license key\n  scan_mime_parts = true;\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"kaspersky",children:"Kaspersky"}),"\n",(0,r.jsxs)(n.p,{children:["Kaspersky Anti-Virus for Linux Mail Server uses a Unix socket for local scans. Rspamd must have write access to the socket (add the rspamd user to ",(0,r.jsx)(n.code,{children:"klusers"})," group)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," Rspamd writes data to temporary files in ",(0,r.jsx)(n.code,{children:"tmpdir"})," (default ",(0,r.jsx)(n.code,{children:"/tmp"}),"). This directory must be readable by the ",(0,r.jsx)(n.code,{children:"klusers"})," user/group."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nkaspersky {\n  symbol = "KAS_VIRUS";\n  type = "kaspersky";\n  servers = "/var/run/klms/rds_av";\n  max_size = 2048000;\n  scan_mime_parts = true;\n  tmpdir = "/tmp";  # Must be accessible to both rspamd and klusers\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"To grant access:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"usermod -G klusers _rspamd\n"})}),"\n",(0,r.jsx)(n.h2,{id:"kaspersky-scan-engine",children:"Kaspersky Scan Engine"}),"\n",(0,r.jsxs)(n.p,{children:["Kaspersky Scan Engine uses HTTP REST API version 1.0 (",(0,r.jsx)(n.a,{href:"https://help.kaspersky.com/ScanEngine/1.0/en-US/181038.htm",children:"documentation"}),"). It supports both TCP stream and file modes."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific options:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"use_files"}),": Set to ",(0,r.jsx)(n.code,{children:"true"})," to use file mode (only recommended with fast tmpfs storage)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"use_https"}),": Set to ",(0,r.jsx)(n.code,{children:"true"})," to enable SSL"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nkaspersky_se {\n  symbol = "KAS_SE_VIRUS";\n  type = "kaspersky_se";\n  servers = "127.0.0.1:1234";  # Required, Unix sockets not supported\n  max_size = 2048000;\n  timeout = 5.0;\n  scan_mime_parts = true;\n  use_files = false;  # Use TCP stream mode (recommended)\n  use_https = false;  # Enable for SSL\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"avast",children:"Avast"}),"\n",(0,r.jsx)(n.p,{children:"Avast for Linux uses a socket-based protocol. The scanner saves content to temporary files before scanning."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific defaults:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"timeout"}),": 4.0 seconds"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"retransmits"}),": 1"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tmpdir"}),": ",(0,r.jsx)(n.code,{children:"/tmp"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\navast {\n  symbol = "AVAST_VIRUS";\n  type = "avast";\n  servers = "/var/run/avast/scan.sock";  # Unix socket path\n  scan_mime_parts = true;\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"virustotal",children:"VirusTotal"}),"\n",(0,r.jsxs)(n.p,{children:["VirusTotal integration performs hash-based lookups against their database. ",(0,r.jsx)(n.strong,{children:"An API key is required."})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific options:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"apikey"}),": Your VirusTotal API key (required)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"url"}),": API endpoint (default: ",(0,r.jsx)(n.code,{children:"https://www.virustotal.com/vtapi/v2/file"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"minimum_engines"}),": Minimum detections required to trigger (default: 3)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"low_category"}),": Threshold for low threat category (default: 5)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"medium_category"}),": Threshold for medium threat category (default: 10)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"symbols"}),": Category-based symbol configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This scanner uses hash lookups (MD5), so it only detects known threats. It produces category-based symbols instead of a single virus symbol:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"VIRUSTOTAL_CLEAN"}),": No detections (negative score)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"VIRUSTOTAL_LOW"}),": Few detections (minimum_engines to low_category-1)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"VIRUSTOTAL_MEDIUM"}),": Moderate detections (low_category to medium_category-1)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"VIRUSTOTAL_HIGH"}),": Many detections (medium_category and above)"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nvirustotal {\n  type = "virustotal";\n  apikey = "your-api-key-here";  # Required\n  \n  scan_mime_parts = true;\n  \n  # Minimum detections to consider as threat\n  minimum_engines = 3;\n  \n  # Category thresholds\n  low_category = 5;\n  medium_category = 10;\n  \n  # Custom symbols and scores\n  symbols = {\n    clean = {\n      symbol = "VIRUSTOTAL_CLEAN";\n      score = -0.5;\n      description = "VirusTotal: attachment is clean";\n    };\n    low = {\n      symbol = "VIRUSTOTAL_LOW";\n      score = 2.0;\n      description = "VirusTotal: low threat level";\n    };\n    medium = {\n      symbol = "VIRUSTOTAL_MEDIUM";\n      score = 5.0;\n      description = "VirusTotal: medium threat level";\n    };\n    high = {\n      symbol = "VIRUSTOTAL_HIGH";\n      score = 8.0;\n      description = "VirusTotal: high threat level";\n    };\n  };\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," VirusTotal has rate limits on their API. Consider ",(0,r.jsx)(n.code,{children:"cache_expire"})," settings to minimize API calls."]}),"\n",(0,r.jsx)(n.h2,{id:"metadefender-cloud",children:"MetaDefender Cloud"}),"\n",(0,r.jsxs)(n.p,{children:["MetaDefender Cloud by OPSWAT performs hash-based lookups (SHA256) against multiple antivirus engines. ",(0,r.jsx)(n.strong,{children:"An API key is required."})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scanner-specific options:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"apikey"}),": Your MetaDefender API key (required)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"url"}),": API endpoint (default: ",(0,r.jsx)(n.code,{children:"https://api.metadefender.com/v4/hash"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"minimum_engines"}),": Minimum detections required to trigger (default: 3)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"low_category"}),": Threshold for low threat category (default: 5)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"medium_category"}),": Threshold for medium threat category (default: 10)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"symbols"}),": Category-based symbol configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Like VirusTotal, this scanner uses hash lookups and produces category-based symbols:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"METADEFENDER_CLEAN"}),": No detections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"METADEFENDER_LOW"}),": Few detections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"METADEFENDER_MEDIUM"}),": Moderate detections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"METADEFENDER_HIGH"}),": Many detections"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/antivirus.conf\n\nmetadefender {\n  type = "metadefender";\n  apikey = "your-api-key-here";  # Required\n  \n  scan_mime_parts = true;\n  \n  minimum_engines = 3;\n  low_category = 5;\n  medium_category = 10;\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"icap-protocol",children:"ICAP Protocol"}),"\n",(0,r.jsxs)(n.p,{children:["Generic antivirus support via ICAP protocol is available through the ",(0,r.jsx)(n.a,{href:"/modules/external_services#icap-protocol-specific-details",children:"external_services"})," module."]}),"\n",(0,r.jsx)(n.p,{children:"The following products have been tested with Rspamd via ICAP:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Checkpoint Sandblast"}),"\n",(0,r.jsx)(n.li,{children:"ClamAV (using c-icap server and squidclamav)"}),"\n",(0,r.jsx)(n.li,{children:"ESET Server Security for Linux 9.0"}),"\n",(0,r.jsx)(n.li,{children:"F-Secure Internet Gatekeeper"}),"\n",(0,r.jsx)(n.li,{children:"Kaspersky Scan Engine 2.0"}),"\n",(0,r.jsx)(n.li,{children:"Kaspersky Web Traffic Security 6.0"}),"\n",(0,r.jsx)(n.li,{children:"McAfee Web Gateway 9/10/11"}),"\n",(0,r.jsx)(n.li,{children:"Metadefender ICAP"}),"\n",(0,r.jsx)(n.li,{children:"Sophos (via SAVDI)"}),"\n",(0,r.jsx)(n.li,{children:"Symantec Protection Engine for Cloud Services"}),"\n",(0,r.jsx)(n.li,{children:"Trend Micro InterScan Web Security Virtual Appliance (IWSVA)"}),"\n",(0,r.jsx)(n.li,{children:"Trend Micro Web Gateway"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>c});var i=s(6540);const r={},d=i.createContext(r);function t(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);