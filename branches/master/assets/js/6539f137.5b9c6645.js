"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[1469],{132(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"developers/protocol","title":"Rspamd protocol","description":"Protocol basics","source":"@site/docs/developers/protocol.md","sourceDirName":"developers","slug":"/developers/protocol","permalink":"/docs.rspamd.com/branches/master/developers/protocol","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/developers/protocol.md","tags":[],"version":"current","frontMatter":{"title":"Rspamd protocol"},"sidebar":"docs","previous":{"title":"Rspamd Architecture","permalink":"/docs.rspamd.com/branches/master/developers/architecture"},"next":{"title":"HTTPCrypt Encryption Protocol","permalink":"/docs.rspamd.com/branches/master/developers/encryption"}}');var r=s(4848),i=s(8453);const a={title:"Rspamd protocol"},d="Rspamd protocol",o={},l=[{value:"Protocol basics",id:"protocol-basics",level:2},{value:"Rspamd HTTP request",id:"rspamd-http-request",level:2},{value:"Rspamd protocol encryption",id:"rspamd-protocol-encryption",level:2},{value:"HTTP request",id:"http-request",level:3},{value:"HTTP headers",id:"http-headers",level:3},{value:"Rspamd HTTP reply",id:"rspamd-http-reply",level:2},{value:"Response headers",id:"response-headers",level:3},{value:"Milter headers",id:"milter-headers",level:2},{value:"Adding headers",id:"adding-headers",level:3},{value:"Removing headers",id:"removing-headers",level:3},{value:"Complete example",id:"complete-example",level:3},{value:"Body block (rewritten message)",id:"body-block-rewritten-message",level:2},{value:"How it works",id:"how-it-works",level:3},{value:"Example with body block",id:"example-with-body-block",level:3},{value:"Parsing the response",id:"parsing-the-response",level:3},{value:"Use cases",id:"use-cases",level:3},{value:"When is a message considered &quot;rewritten&quot;?",id:"when-is-a-message-considered-rewritten",level:3},{value:"Client-side implementation",id:"client-side-implementation",level:3},{value:"Compression",id:"compression",level:2},{value:"Requesting Compressed Responses",id:"requesting-compressed-responses",level:3},{value:"Sending Compressed Requests",id:"sending-compressed-requests",level:3},{value:"Response with Compression",id:"response-with-compression",level:3},{value:"Client Implementation Example",id:"client-implementation-example",level:3},{value:"Compression with Dictionaries",id:"compression-with-dictionaries",level:3},{value:"Performance Considerations",id:"performance-considerations",level:3},{value:"Curl example",id:"curl-example",level:2},{value:"Protocol v3 (Multipart)",id:"protocol-v3-multipart",level:2},{value:"Endpoint",id:"endpoint",level:3},{value:"Key Advantages over v2",id:"key-advantages-over-v2",level:3},{value:"Request Format",id:"request-format",level:3},{value:"Metadata Part",id:"metadata-part",level:4},{value:"Message Part",id:"message-part",level:4},{value:"Per-Part Compression",id:"per-part-compression",level:4},{value:"Example Request",id:"example-request",level:4},{value:"Response Format",id:"response-format",level:3},{value:"Result Format Selection",id:"result-format-selection",level:4},{value:"Example Response",id:"example-response",level:4},{value:"Compression Layers",id:"compression-layers",level:3},{value:"Encryption",id:"encryption",level:3},{value:"Proxy Forwarding",id:"proxy-forwarding",level:3},{value:"rspamc Client Usage",id:"rspamc-client-usage",level:3},{value:"Client Implementation Examples",id:"client-implementation-examples",level:3},{value:"Basic Python Example",id:"basic-python-example",level:4},{value:"Using Compression (zstd)",id:"using-compression-zstd",level:4},{value:"Using MessagePack",id:"using-messagepack",level:4},{value:"Combined: Compression + MessagePack",id:"combined-compression--messagepack",level:4},{value:"Curl Examples",id:"curl-examples",level:4},{value:"Backward Compatibility",id:"backward-compatibility",level:3},{value:"Normal worker HTTP endpoints",id:"normal-worker-http-endpoints",level:2},{value:"Controller HTTP endpoints",id:"controller-http-endpoints",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"rspamd-protocol",children:"Rspamd protocol"})}),"\n",(0,r.jsx)(n.h2,{id:"protocol-basics",children:"Protocol basics"}),"\n",(0,r.jsx)(n.p,{children:"Rspamd employs the HTTP protocol, specifically versions 1.0 or 1.1. Rspamd defines some headers which allow the passing of extra information about a scanned message, such as envelope data, IP address or SMTP SASL authentication data, etc. Rspamd supports normal and chunked encoded HTTP requests."}),"\n",(0,r.jsx)(n.h2,{id:"rspamd-http-request",children:"Rspamd HTTP request"}),"\n",(0,r.jsx)(n.p,{children:"Rspamd encourages the use of the HTTP protocol due to its universality and compatibility with virtually every programming language, without the need for obscure libraries. A typical HTTP request takes the following form:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"  POST /checkv2 HTTP/1.0\n  Content-Length: 26969\n  From: smtp@example.com\n  Pass: all\n  Ip: 95.211.146.161\n  Helo: localhost.localdomain\n  Hostname: localhost\n\n  <your message goes here>\n"})}),"\n",(0,r.jsx)(n.p,{children:"For added flexibility, chunked encoding can be utilized, streamlining data transfer, particularly when the message length is unknown."}),"\n",(0,r.jsx)(n.h2,{id:"rspamd-protocol-encryption",children:"Rspamd protocol encryption"}),"\n",(0,r.jsxs)(n.p,{children:["Rspamd supports encryption by means of lightweight protocol called HTTPCrypt. For comprehensive technical details about the cryptographic primitives, key exchange, and protocol implementation, see the ",(0,r.jsx)(n.a,{href:"/docs.rspamd.com/branches/master/developers/encryption",children:"Encryption Documentation"}),". You can also find the original protocol specification in this ",(0,r.jsx)(n.a,{href:"https://highsecure.ru/httpcrypt.pdf",children:"paper"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["To enable encryption, you need to generate a keypair and configure it in the corresponding worker's section (e.g. ",(0,r.jsx)(n.code,{children:"worker-controller.inc"})," or ",(0,r.jsx)(n.code,{children:"worker-normal.inc"})," or, even, in ",(0,r.jsx)(n.code,{children:"worker-proxy.inc"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'$ rspamadm keypair\n\nkeypair {\n    privkey = "e4gr3yuw4xiy6dikdpqus8cmxj8c6pqstt448ycwhewhhrtxdahy";\n    id = "gnyieumi6sp6d3ykkukep9yuaq13q4u6xycmiqaw7iahsrz97acpposod1x8zogynnishtgxr47o815dgsz9t69d66jcm1drjei4a5d";\n    pubkey = "fg8uwtce9sta43sdwzddb11iez5thcskiufj4ug8esyfniqq5iiy";\n    type = "kex";\n    algorithm = "curve25519";\n    encoding = "base32";\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Regrettably, the HTTPCrypt protocol hasn't gained widespread adoption among popular libraries. Nonetheless, you can effectively utilize it with the ",(0,r.jsx)(n.code,{children:"rspamc"})," client and various internal clients, including Rspamd's proxy, which can serve as an encryption bridge for conducting spam scans via Rspamd.\nMoreover, you have the option to employ Nginx for SSL termination on behalf of Rspamd. While Rspamd's client-side components (e.g., proxy or ",(0,r.jsx)(n.code,{children:"rspamc"}),") offer native support for SSL encryption, it's important to note that SSL support on the server side is not currently available."]}),"\n",(0,r.jsx)(n.h3,{id:"http-request",children:"HTTP request"}),"\n",(0,r.jsxs)(n.p,{children:["Normally, you should just use ",(0,r.jsx)(n.code,{children:"/checkv2"})," here. However, if you want to communicate with the controller then you might want to use ",(0,r.jsx)(n.a,{href:"#controller-http-endpoints",children:"controller commands"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"http-headers",children:"HTTP headers"}),"\n",(0,r.jsx)(n.p,{children:"To minimize redundant processing, Rspamd enables an MTA to transmit pre-processed message data using HTTP headers. Rspamd accommodates the following non-standard HTTP headers:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Header"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Deliver-To"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines actual delivery recipient of message. Can be used for personalized statistics and for user specific options."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"IP"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines IP from which this message is received."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Helo"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines SMTP helo"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Hostname"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines resolved hostname"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Flags"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Supported from version 2.0: Defines output flags as a commas separated list: ",(0,r.jsx)(n.code,{children:"pass_all"})," (pass all filters), ",(0,r.jsx)(n.code,{children:"groups"})," (return symbols groups), ",(0,r.jsx)(n.code,{children:"zstd"})," (compressed input/output), ",(0,r.jsx)(n.code,{children:"no_log"})," (do not log task), ",(0,r.jsx)(n.code,{children:"milter"})," (apply milter protocol related hacks), ",(0,r.jsx)(n.code,{children:"profile"})," (profile performance for this task), ",(0,r.jsx)(n.code,{children:"body_block"})," (accept rewritten body as a separate part of reply, see ",(0,r.jsx)(n.a,{href:"#body-block-rewritten-message",children:"Body block section"}),"), ",(0,r.jsx)(n.code,{children:"ext_urls"})," (extended urls information), ",(0,r.jsx)(n.code,{children:"skip"})," (skip all filters processing), ",(0,r.jsx)(n.code,{children:"skip_process"})," (skip mime parsing/processing)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"From"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines SMTP mail from command data"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Queue-Id"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines SMTP queue id for message (can be used instead of message id in logging)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Raw"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["If set to ",(0,r.jsx)(n.code,{children:"yes"}),", then Rspamd assumes that the content is not MIME and treat it as raw data."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Rcpt"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines SMTP recipient (there may be several ",(0,r.jsx)(n.code,{children:"Rcpt"})," headers)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Pass"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["If this header has ",(0,r.jsx)(n.code,{children:"all"})," value, all filters would be checked for this message."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Subject"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines subject of message (is used for non-mime messages)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"User"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines username for authenticated SMTP client."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Settings-ID"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines ",(0,r.jsx)(n.a,{href:"/configuration/settings",children:"settings id"})," to apply."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Settings"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines list of rules (",(0,r.jsx)(n.a,{href:"/configuration/settings",children:"settings"})," ",(0,r.jsx)(n.code,{children:"apply"})," part) as raw json block to apply."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"User-Agent"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines user agent (special processing if it is ",(0,r.jsx)(n.code,{children:"rspamc"}),")."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"MTA-Tag"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"MTA defined tag (can be used in settings)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"MTA-Name"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines MTA name, used in ",(0,r.jsx)(n.code,{children:"Authentication-Results"})," routines."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"TLS-Cipher"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines TLS cipher name."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"TLS-Version"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Defines TLS version."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"TLS-Cert-Issuer"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines Cert issuer, can be used in conjunction with ",(0,r.jsx)(n.code,{children:"client_ca_name"})," in ",(0,r.jsx)(n.a,{href:"/workers/rspamd_proxy",children:"proxy worker"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"URL-Format"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Supported from version 1.9: return all URLs and email if this header is ",(0,r.jsx)(n.code,{children:"extended"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Filename"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Hint for filename if used with some file."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Log"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["If set to ",(0,r.jsx)(n.code,{children:"no"})," or ",(0,r.jsx)(n.code,{children:"false"}),", disables logging for this task (equivalent to ",(0,r.jsx)(n.code,{children:"no_log"})," flag)."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Log-Tag"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Sets custom log tag for the task. Useful for correlating logs across different systems (e.g., using MTA's Queue-ID). See ",(0,r.jsx)(n.a,{href:"/configuration/logging#log-tag-propagation-in-proxy-mode",children:"logging documentation"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Milter"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["If set to ",(0,r.jsx)(n.code,{children:"yes"}),", enables milter-specific processing behaviors."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Mailer"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines the mailer software name (received from MTA via milter ",(0,r.jsx)(n.code,{children:"{rcpt_mailer}"})," macro)."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Compression"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["Specifies input compression algorithm (e.g., ",(0,r.jsx)(n.code,{children:"zstd"}),"). Used with compressed message content."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.code,{children:"Profile"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["If set to ",(0,r.jsx)(n.code,{children:"yes"}),", enables performance profiling for this task."]})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Controller also defines certain headers, which you can find detailed information about ",(0,r.jsx)(n.a,{href:"#controller-http-endpoints",children:"here"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Furthermore, Rspamd supports standard HTTP headers like ",(0,r.jsx)(n.code,{children:"Content-Length"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"rspamd-http-reply",children:"Rspamd HTTP reply"}),"\n",(0,r.jsxs)(n.p,{children:["The response from Rspamd is encoded in ",(0,r.jsx)(n.code,{children:"JSON"})," format. Here's an example of a typical HTTP reply:"]}),"\n",(0,r.jsx)(n.p,{children:"HTTP/1.1 200 OK\nConnection: close\nServer: rspamd/0.9.0\nDate: Mon, 30 Mar 2015 16:19:35 GMT\nContent-Length: 825\nContent-Type: application/json"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "is_skipped": false,\n    "score": 5.2,\n    "required_score": 7,\n    "action": "add header",\n    "symbols": {\n        "DATE_IN_PAST": {\n            "name": "DATE_IN_PAST",\n            "score": 0.1\n        },\n        "FORGED_SENDER": {\n            "name": "FORGED_SENDER",\n            "score": 5\n        },\n        "TEST": {\n            "name": "TEST",\n            "score": 100500\n        },\n        "FUZZY_DENIED": {\n            "name": "FUZZY_DENIED",\n            "score": 0,\n            "options": [\n                "1: 1.00 / 1.00",\n                "1: 1.00 / 1.00"\n            ]\n        },\n        "HFILTER_HELO_5": {\n            "name": "HFILTER_HELO_5",\n            "score": 0.1\n        }\n    },\n    "urls": [\n        "www.example.com",\n        "another.example.com"\n    ],\n    "emails": [\n        "user@example.com"\n    ],\n    "message-id": "4E699308EFABE14EB3F18A1BB025456988527794@example"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["For convenience, the reply is LINTed using ",(0,r.jsx)(n.a,{href:"https://jsonlint.com",children:"JSONLint"}),". The actual response is compressed for efficiency."]}),"\n",(0,r.jsx)(n.p,{children:"Each response contains the following fields:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"is_skipped"})," - boolean flag that is ",(0,r.jsx)(n.code,{children:"true"})," if a message has been skipped due to settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"score"})," - floating-point value representing the effective score of message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"required_score"})," - floating-point value meaning the threshold value for the metric"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"action"})," - recommended action for a message:\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"no action"})," - message is likely ham (please notice space, not an underscore)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"greylist"})," - message should be greylisted"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add header"})," - message is suspicious and should be marked as spam (please notice space, not an underscore)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"rewrite subject"})," - message is suspicious and should have subject rewritten"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"soft reject"})," - message should be temporary rejected (for example, due to rate limit exhausting)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reject"})," - message should be rejected as spam"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"symbols"})," - all symbols added during a message's processing, indexed by symbol names:\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"})," - name of symbol"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"score"})," - final score"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"options"})," - array of symbol options as an array of strings"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Additional keys that could be in the reply include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"subject"})," - if action is ",(0,r.jsx)(n.code,{children:"rewrite subject"})," this value defines the desired subject for a message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"urls"})," - a list of URLs found in a message (only hostnames)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"emails"})," - a list of emails found in a message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"message-id"})," - ID of message (useful for logging)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"messages"})," - object containing optional messages added by Rspamd filters (such as ",(0,r.jsx)(n.code,{children:"SPF"}),") - The value of the ",(0,r.jsx)(n.code,{children:"smtp_message"})," key is intended to be returned as SMTP response text by the MTA"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"response-headers",children:"Response headers"}),"\n",(0,r.jsx)(n.p,{children:"In addition to the JSON body, Rspamd may include special HTTP headers in the response:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Message-Offset"})," - When the ",(0,r.jsx)(n.code,{children:"body_block"})," flag is set and the message was modified, this header contains the byte offset where the JSON response ends and the rewritten message body begins. See ",(0,r.jsx)(n.a,{href:"#body-block-rewritten-message",children:"Body block section"})," for details."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Compression"})," - Indicates the compression algorithm used (e.g., ",(0,r.jsx)(n.code,{children:"zstd"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Content-Encoding"})," - Mirror of the compression header for standard HTTP clients"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"milter-headers",children:"Milter headers"}),"\n",(0,r.jsxs)(n.p,{children:["This section of the response is utilized to manipulate headers and the SMTP session. It is located under the ",(0,r.jsx)(n.code,{children:"milter"})," key in the response. Here are the potential elements within this object:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add_headers"}),": headers to add (object, indexed by header name)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"remove_headers"}),": headers to remove (object, indexed by header name)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"change_from"}),": change SMTP from value (plain string)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reject"}),": custom rejection (plain string value), e.g. ",(0,r.jsx)(n.code,{children:'reject="discard"'})," or ",(0,r.jsx)(n.code,{children:'reject="quarantine"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"spam_header"}),": custom spam header (plain string - header name)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"no_action"}),": instead of doing any action to a message, just add header ",(0,r.jsx)(n.code,{children:"X-Rspamd-Action"})," equal to that action and accept message (boolean value)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add_rcpt"}),": (from 1.8.0) add new recipients (array of strings)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"del_rcpt"}),": (from 1.8.0) delete recipients (array of strings)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"adding-headers",children:"Adding headers"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"add_headers"})," element has the following format:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "<header_name>": {\n        "value": "<header_value>",\n        "order": 0\n    },\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Where ",(0,r.jsx)(n.code,{children:"<header_name>"})," represents header's name, ",(0,r.jsx)(n.code,{children:"<header_value>"})," - value, and ",(0,r.jsx)(n.code,{children:"order"})," the order of insertion (e.g. 0 will be the first header)."]}),"\n",(0,r.jsx)(n.h3,{id:"removing-headers",children:"Removing headers"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"remove_headers"})," element has the following format:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "<header_name>": 1\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Where ",(0,r.jsx)(n.code,{children:"<header_name>"})," represents header's name, and the value is the order of the header to remove (starting from 1). There are special treatment for orders ",(0,r.jsx)(n.code,{children:"0"})," and negative order:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["if order is equal to zero, then it means that *",(0,r.jsx)(n.em,{children:"all"})," headers with this name should be removed"]}),"\n",(0,r.jsxs)(n.li,{children:["if order is negative, it means that the ",(0,r.jsx)(n.code,{children:"N"}),"th header from the ",(0,r.jsx)(n.strong,{children:"end"})," should be removed (where ",(0,r.jsx)(n.code,{children:"N"})," is ",(0,r.jsx)(n.code,{children:"abs(order)"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"complete-example",children:"Complete example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n    "milter":\n    {\n        "add_headers": {\n            "ArcMessageSignature": {\n                "value": "some_value with JSON\\nencoded values",\n                "order": 0\n            },\n        },\n        "remove_headers": {\n            "DKIM-Signature": -1\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"body-block-rewritten-message",children:"Body block (rewritten message)"}),"\n",(0,r.jsxs)(n.p,{children:["When a message is modified by Rspamd (for example, by Lua plugins via ",(0,r.jsx)(n.code,{children:"task:set_message()"})," or ARC signing), the client can request that the modified message body be included in the response. This is controlled by the ",(0,r.jsx)(n.code,{children:"body_block"})," flag."]}),"\n",(0,r.jsx)(n.h3,{id:"how-it-works",children:"How it works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Request"}),": The client includes ",(0,r.jsx)(n.code,{children:"body_block"})," in the ",(0,r.jsx)(n.code,{children:"Flags"})," header (e.g., ",(0,r.jsx)(n.code,{children:"Flags: body_block"})," or ",(0,r.jsx)(n.code,{children:"Flags: milter,body_block"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Response"}),": If the message was modified (indicated by the internal ",(0,r.jsx)(n.code,{children:"MESSAGE_REWRITE"})," flag), the response contains:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A ",(0,r.jsx)(n.code,{children:"Message-Offset"})," header indicating the byte position where the rewritten body begins"]}),"\n",(0,r.jsx)(n.li,{children:"The standard JSON response up to the offset"}),"\n",(0,r.jsx)(n.li,{children:"The rewritten message body after the offset"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Message format"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"For milter protocol"})," (",(0,r.jsx)(n.code,{children:"milter"})," flag present): Only the message body is included (without headers)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"For standard protocol"}),": The complete modified message is included (headers + body)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example-with-body-block",children:"Example with body block"}),"\n",(0,r.jsx)(n.p,{children:"Request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"POST /checkv2 HTTP/1.1\nContent-Length: 1500\nFlags: body_block\nFrom: sender@example.com\nRcpt: recipient@example.com\n\n[message content]\n"})}),"\n",(0,r.jsx)(n.p,{children:"Response when message was modified:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'HTTP/1.1 200 OK\nContent-Type: application/json\nMessage-Offset: 523\nContent-Length: 2100\n\n{"action":"no action","score":0.5,"required_score":15.0,"symbols":{...},"message-id":"test@example.com"}\n[rewritten message body starts here at byte 523]\nFrom: sender@example.com\nTo: recipient@example.com\nSubject: Test message\nDKIM-Signature: v=1; a=rsa-sha256; ...\n\nModified message body content...\n'})}),"\n",(0,r.jsx)(n.p,{children:"In this example:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The JSON response ends at byte position 523"}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"Message-Offset"})," header tells the client where to split the response"]}),"\n",(0,r.jsx)(n.li,{children:"Everything after byte 523 is the rewritten message"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"parsing-the-response",children:"Parsing the response"}),"\n",(0,r.jsx)(n.p,{children:"To parse a response with body block:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Read the ",(0,r.jsx)(n.code,{children:"Message-Offset"})," header value (e.g., ",(0,r.jsx)(n.code,{children:"523"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Parse bytes 0 to offset-1 as JSON (e.g., bytes 0-522)"}),"\n",(0,r.jsx)(n.li,{children:"Use bytes from offset to end as the rewritten message body (e.g., bytes 523-2099)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"use-cases",children:"Use cases"}),"\n",(0,r.jsx)(n.p,{children:"This feature is primarily used in:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rspamd proxy worker"})," with milter protocol for message modifications"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"MTA integrations"})," that need to apply message modifications (DKIM signing, ARC sealing, header modifications)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Custom processing pipelines"})," where message rewriting is performed by Lua modules"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"when-is-a-message-considered-rewritten",children:'When is a message considered "rewritten"?'}),"\n",(0,r.jsx)(n.p,{children:"A message is marked as rewritten when:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A Lua plugin calls ",(0,r.jsx)(n.code,{children:"task:set_message()"})," with new content"]}),"\n",(0,r.jsxs)(n.li,{children:["A Lua plugin calls ",(0,r.jsx)(n.code,{children:"task:set_flag('message_rewrite')"})," explicitly"]}),"\n",(0,r.jsx)(n.li,{children:"Internal modules modify the message structure (e.g., ARC module adding signatures)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"client-side-implementation",children:"Client-side implementation"}),"\n",(0,r.jsx)(n.p,{children:"Example Python code to parse a body block response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport json\n\nresponse = requests.post('http://localhost:11333/checkv2',\n                        headers={'Flags': 'body_block'},\n                        data=message_content)\n\nmessage_offset = response.headers.get('Message-Offset')\nif message_offset:\n    offset = int(message_offset)\n    json_part = response.content[:offset]\n    body_part = response.content[offset:]\n    \n    result = json.loads(json_part)\n    modified_message = body_part.decode('utf-8')\n    \n    print(f\"Scan result: {result}\")\n    print(f\"Modified message: {modified_message}\")\nelse:\n    # No message modification, response is pure JSON\n    result = response.json()\n    print(f\"Scan result: {result}\")\n"})}),"\n",(0,r.jsx)(n.h2,{id:"compression",children:"Compression"}),"\n",(0,r.jsx)(n.p,{children:"Rspamd supports Zstandard (zstd) compression for both requests and responses. Compression can significantly reduce bandwidth usage, especially for large messages or high-volume deployments."}),"\n",(0,r.jsx)(n.h3,{id:"requesting-compressed-responses",children:"Requesting Compressed Responses"}),"\n",(0,r.jsx)(n.p,{children:"There are two ways to request compressed responses from Rspamd:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Method 1: Using the Flags header"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"POST /checkv2 HTTP/1.1\nFlags: zstd\nContent-Length: 1500\n\n<message content>\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Method 2: Using standard Accept-Encoding header"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"POST /checkv2 HTTP/1.1\nAccept-Encoding: zstd\nContent-Length: 1500\n\n<message content>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sending-compressed-requests",children:"Sending Compressed Requests"}),"\n",(0,r.jsxs)(n.p,{children:["To send a compressed message body, include the ",(0,r.jsx)(n.code,{children:"Compression"})," header:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"POST /checkv2 HTTP/1.1\nCompression: zstd\nContent-Encoding: zstd\nContent-Length: 850\n\n<zstd-compressed message content>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Rspamd automatically detects zstd-compressed content by checking the magic bytes (",(0,r.jsx)(n.code,{children:"0x28 0xb5 0x2f 0xfd"}),") at the start of the body, but it's recommended to always include the ",(0,r.jsx)(n.code,{children:"Compression"})," header for clarity."]}),"\n",(0,r.jsx)(n.h3,{id:"response-with-compression",children:"Response with Compression"}),"\n",(0,r.jsx)(n.p,{children:"When compression is enabled, the response includes compression headers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"HTTP/1.1 200 OK\nContent-Type: application/json\nCompression: zstd\nContent-Encoding: zstd\nContent-Length: 245\n\n<zstd-compressed JSON response>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"client-implementation-example",children:"Client Implementation Example"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Python example using zstandard library:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport zstandard as zstd\nimport json\n\n# Compress request\ncctx = zstd.ZstdCompressor()\nmessage = open('message.eml', 'rb').read()\ncompressed_message = cctx.compress(message)\n\n# Send compressed request, request compressed response\nresponse = requests.post(\n    'http://localhost:11333/checkv2',\n    headers={\n        'Compression': 'zstd',\n        'Content-Encoding': 'zstd',\n        'Accept-Encoding': 'zstd',\n    },\n    data=compressed_message\n)\n\n# Decompress response if compressed\nif response.headers.get('Content-Encoding') == 'zstd':\n    dctx = zstd.ZstdDecompressor()\n    result = json.loads(dctx.decompress(response.content))\nelse:\n    result = response.json()\n\nprint(result)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Using rspamc with compression:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"rspamc -z message.eml  # Enable zstd compression\n"})}),"\n",(0,r.jsx)(n.h3,{id:"compression-with-dictionaries",children:"Compression with Dictionaries"}),"\n",(0,r.jsxs)(n.p,{children:["Rspamd supports zstd dictionary compression for even better compression ratios on typical email content. Dictionary IDs are communicated via the ",(0,r.jsx)(n.code,{children:"Dictionary"})," header. This is primarily used internally by the rspamd proxy when communicating with backend workers."]}),"\n",(0,r.jsx)(n.h3,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compression adds CPU overhead but reduces network I/O"}),"\n",(0,r.jsx)(n.li,{children:"Recommended for remote Rspamd servers or high-latency connections"}),"\n",(0,r.jsx)(n.li,{children:"For local Unix socket connections, compression overhead may outweigh benefits"}),"\n",(0,r.jsx)(n.li,{children:"Typical compression ratios for email messages: 3:1 to 10:1"}),"\n",(0,r.jsx)(n.li,{children:"JSON responses typically compress very well (5:1 to 20:1)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"curl-example",children:"Curl example"}),"\n",(0,r.jsxs)(n.p,{children:["To check a message without rspamc:\n",(0,r.jsx)(n.code,{children:"curl --data-binary @- http://localhost:11333/symbols < file.eml"})]}),"\n",(0,r.jsx)(n.p,{children:"To check with compression (requires zstd command-line tool):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'zstd -c message.eml | curl --data-binary @- \\\n  -H "Compression: zstd" \\\n  -H "Content-Encoding: zstd" \\\n  http://localhost:11333/checkv2\n'})}),"\n",(0,r.jsx)(n.h2,{id:"protocol-v3-multipart",children:"Protocol v3 (Multipart)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Available from Rspamd 3.15"})}),"\n",(0,r.jsx)(n.p,{children:"Protocol v3 introduces a modern multipart-based wire protocol that replaces the legacy header-based request format with a structured multipart approach. It addresses limitations of the v2 protocol while maintaining backward compatibility."}),"\n",(0,r.jsx)(n.h3,{id:"endpoint",children:"Endpoint"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"URL"}),": ",(0,r.jsx)(n.code,{children:"POST /checkv3"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Content-Type"}),": ",(0,r.jsx)(n.code,{children:'multipart/form-data; boundary="<boundary>"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Available on"}),": Normal worker and proxy worker"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"key-advantages-over-v2",children:"Key Advantages over v2"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Structured metadata"}),": JSON/msgpack metadata replaces fragile per-header encoding"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Binary-safe"}),": Message body is a proper MIME part with no header-length limits"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Per-part compression"}),": Individual parts can be compressed independently with zstd"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Body return"}),": Rewritten messages returned as a named multipart part (no offset arithmetic)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Msgpack support"}),": More compact wire format for high-throughput integrations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Zero-copy response"}),": Server uses piecewise writev for efficient response serialization"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"request-format",children:"Request Format"}),"\n",(0,r.jsxs)(n.p,{children:["The request body is ",(0,r.jsx)(n.code,{children:"multipart/form-data"})," with these named parts:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Part name"}),(0,r.jsx)(n.th,{children:"Content-Type"}),(0,r.jsx)(n.th,{children:"Required"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"metadata"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"application/json"})," or ",(0,r.jsx)(n.code,{children:"application/x-msgpack"})]}),(0,r.jsx)(n.td,{children:"Optional"}),(0,r.jsx)(n.td,{children:"Scan settings, IP, HELO, sender, recipients, etc. Same fields as v2 request headers but structured as JSON/msgpack object"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"message"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"application/octet-stream"})," or specified MIME type"]}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"The email message to scan"})]})]})]}),"\n",(0,r.jsx)(n.h4,{id:"metadata-part",children:"Metadata Part"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"metadata"})," part replaces the per-header approach used in v1/v2 (e.g., ",(0,r.jsx)(n.code,{children:"IP:"}),", ",(0,r.jsx)(n.code,{children:"Helo:"}),", ",(0,r.jsx)(n.code,{children:"From:"}),", ",(0,r.jsx)(n.code,{children:"Rcpt:"}),", ",(0,r.jsx)(n.code,{children:"Settings:"})," headers). All the same fields are accepted in the JSON/msgpack object:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "ip": "192.168.1.1",\n  "helo": "mail.example.com",\n  "from": "sender@example.com",\n  "rcpt": ["recipient1@example.com", "recipient2@example.com"],\n  "hostname": "client.example.com",\n  "user": "authenticated-user",\n  "settings_id": "custom-settings",\n  "flags": ["body_block", "milter"],\n  "queue_id": "ABC123"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["For a complete list of supported metadata fields, see the ",(0,r.jsx)(n.a,{href:"#http-headers",children:"HTTP headers section"})," - the same fields apply but in JSON format instead of HTTP headers."]}),"\n",(0,r.jsx)(n.h4,{id:"message-part",children:"Message Part"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"message"})," part contains the email message to scan. The Content-Type of this part is passed through as the ",(0,r.jsx)(n.code,{children:"mime_type"})," parameter if it is not ",(0,r.jsx)(n.code,{children:"application/octet-stream"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"per-part-compression",children:"Per-Part Compression"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important"}),": Only the ",(0,r.jsx)(n.code,{children:"message"})," part supports ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"})," compression. The ",(0,r.jsx)(n.code,{children:"metadata"})," part does NOT support compression and must be sent as raw JSON or msgpack."]}),"\n",(0,r.jsx)(n.p,{children:"Compression support by part:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"metadata part"}),": No compression support (always raw JSON/msgpack)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"message part"}),": Supports ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["When the message part has ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"}),", Rspamd automatically decompresses it before scanning."]}),"\n",(0,r.jsx)(n.h4,{id:"example-request",children:"Example Request"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'POST /checkv3 HTTP/1.1\nHost: localhost:11333\nContent-Type: multipart/form-data; boundary="boundary123"\nContent-Length: 1234\n\n--boundary123\nContent-Disposition: form-data; name="metadata"\nContent-Type: application/json\n\n{\n  "ip": "192.168.1.100",\n  "from": "sender@example.com",\n  "rcpt": ["recipient@example.com"],\n  "flags": ["body_block"]\n}\n--boundary123\nContent-Disposition: form-data; name="message"\nContent-Type: application/octet-stream\n\nFrom: sender@example.com\nTo: recipient@example.com\nSubject: Test message\n\nThis is a test message.\n--boundary123--\n'})}),"\n",(0,r.jsx)(n.h3,{id:"response-format",children:"Response Format"}),"\n",(0,r.jsxs)(n.p,{children:["The response is ",(0,r.jsx)(n.code,{children:"multipart/mixed"})," with named parts:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Content-Type"}),": ",(0,r.jsx)(n.code,{children:'multipart/mixed; boundary="<boundary>"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"HTTP status"}),": ",(0,r.jsx)(n.code,{children:"200"})," on success"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Response parts:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Part name"}),(0,r.jsx)(n.th,{children:"Content-Type"}),(0,r.jsx)(n.th,{children:"Always present"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"result"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"application/json"})," or ",(0,r.jsx)(n.code,{children:"application/x-msgpack"})]}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"Scan results (same JSON schema as v2 response)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"body"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"application/octet-stream"})}),(0,r.jsx)(n.td,{children:"Only if message was rewritten"}),(0,r.jsx)(n.td,{children:"Rewritten message body (e.g., DKIM-signed or modified)"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Each part may have ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"})," if per-part compression was applied by the server. Clients must check and decompress individually."]}),"\n",(0,r.jsx)(n.h4,{id:"result-format-selection",children:"Result Format Selection"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"result"})," part format (JSON vs msgpack) is controlled by:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Request Accept header"}),": Set ",(0,r.jsx)(n.code,{children:"Accept: application/x-msgpack"})," for msgpack"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Default"}),": JSON"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"example-response",children:"Example Response"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'HTTP/1.1 200 OK\nContent-Type: multipart/mixed; boundary="response789"\nContent-Length: 2345\n\n--response789\nContent-Disposition: form-data; name="result"\nContent-Type: application/json\n\n{\n  "action": "no action",\n  "score": 0.5,\n  "required_score": 15.0,\n  "symbols": {\n    "DKIM_SIGNED": {"score": 0.0}\n  },\n  "message-id": "test@example.com"\n}\n--response789\nContent-Disposition: form-data; name="body"\nContent-Type: application/octet-stream\n\nFrom: sender@example.com\nTo: recipient@example.com\nSubject: Test message\nDKIM-Signature: v=1; a=rsa-sha256; ...\n\nThis is a test message.\n--response789--\n'})}),"\n",(0,r.jsx)(n.h3,{id:"compression-layers",children:"Compression Layers"}),"\n",(0,r.jsx)(n.p,{children:"Protocol v3 supports two layers of compression:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Per-part compression"}),": Individual parts can have ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Request"}),": Only the ",(0,r.jsx)(n.code,{children:"message"})," part supports compression (metadata does NOT)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Response"}),": Both ",(0,r.jsx)(n.code,{children:"result"})," and ",(0,r.jsx)(n.code,{children:"body"})," parts support compression"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Whole-body compression"})," (via proxy): When going through rspamd_proxy, the proxy may apply ",(0,r.jsx)(n.code,{children:"Compression: zstd"})," to the entire HTTP response body, wrapping the multipart content"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Request compression support:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Part"}),(0,r.jsx)(n.th,{children:"Compression Supported"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"metadata"}),(0,r.jsx)(n.td,{children:"\u274c No (always raw JSON/msgpack)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"message"}),(0,r.jsx)(n.td,{children:"\u2705 Yes (zstd)"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response compression support:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Part"}),(0,r.jsx)(n.th,{children:"Compression Supported"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"result"}),(0,r.jsx)(n.td,{children:"\u2705 Yes (zstd)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"body"}),(0,r.jsx)(n.td,{children:"\u2705 Yes (zstd)"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"Clients must:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["First decompress the whole HTTP body if ",(0,r.jsx)(n.code,{children:"Compression: zstd"})," header is present"]}),"\n",(0,r.jsx)(n.li,{children:"Then parse the multipart structure"}),"\n",(0,r.jsxs)(n.li,{children:["Finally decompress individual parts that have ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"encryption",children:"Encryption"}),"\n",(0,r.jsx)(n.p,{children:"V3 supports rspamd HTTP encryption (HTTPCrypt). When encryption is enabled:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The entire multipart body is encrypted in-place using ",(0,r.jsx)(n.code,{children:"rspamd_cryptobox_encryptv_nm_inplace"})]}),"\n",(0,r.jsx)(n.li,{children:"The zero-copy iov path ensures all body segments are writable for in-place encryption"}),"\n",(0,r.jsx)(n.li,{children:"Decryption happens at the HTTP layer before the multipart parser processes the data"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For encryption setup, see the ",(0,r.jsx)(n.a,{href:"#rspamd-protocol-encryption",children:"Protocol encryption section"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"proxy-forwarding",children:"Proxy Forwarding"}),"\n",(0,r.jsx)(n.p,{children:"V3 works transparently through rspamd_proxy:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"For local upstreams"}),": Proxy uses shared memory forwarding (GET + Shm headers). The backend reads the multipart body from the shared memory segment."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"For remote upstreams"}),": Proxy forwards the POST body directly."]}),"\n",(0,r.jsx)(n.li,{children:"The proxy preserves the original Content-Type (including boundary) when relaying the response."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"rspamc-client-usage",children:"rspamc Client Usage"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"rspamc"})," client supports Protocol v3 with these flags:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Flag"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"--protocol-v3"})," or ",(0,r.jsx)(n.code,{children:"-3"})]}),(0,r.jsx)(n.td,{children:"Use the v3 multipart protocol instead of legacy"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"--msgpack"})}),(0,r.jsxs)(n.td,{children:["Use msgpack encoding for metadata and result parts (requires ",(0,r.jsx)(n.code,{children:"--protocol-v3"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-z"})}),(0,r.jsx)(n.td,{children:"Enable zstd compression (works with v3, compresses the message part)"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Basic v3 usage\nrspamc --protocol-v3 scan message.eml\n\n# With msgpack and compression\nrspamc --protocol-v3 --msgpack -z scan message.eml\n\n# Short form\nrspamc -3 -z message.eml\n\n# Via remote host\nrspamc -3 -h localhost:11333 message.eml\n"})}),"\n",(0,r.jsx)(n.h3,{id:"client-implementation-examples",children:"Client Implementation Examples"}),"\n",(0,r.jsx)(n.h4,{id:"basic-python-example",children:"Basic Python Example"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Python example using requests:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport json\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\ndef scan_message_v3(message_content, metadata=None):\n    # Prepare metadata\n    if metadata is None:\n        metadata = {\n            \"ip\": \"127.0.0.1\",\n            \"from\": \"test@example.com\",\n            \"rcpt\": [\"recipient@example.com\"]\n        }\n\n    # Build multipart request\n    mp = MIMEMultipart('form-data')\n\n    # Add metadata part\n    metadata_part = MIMEApplication(\n        json.dumps(metadata),\n        'json',\n        name='metadata'\n    )\n    metadata_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='metadata'\n    )\n    mp.attach(metadata_part)\n\n    # Add message part\n    message_part = MIMEApplication(\n        message_content,\n        'octet-stream',\n        name='message'\n    )\n    message_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='message'\n    )\n    mp.attach(message_part)\n\n    # Send request\n    response = requests.post(\n        'http://localhost:11333/checkv3',\n        data=mp.as_string().split('\\n\\n', 1)[1],  # Skip MIME headers\n        headers={\n            'Content-Type': mp.get_content_type() +\n                          f'; boundary=\"{mp.get_boundary()}\"'\n        }\n    )\n\n    # Parse multipart response\n    from email import message_from_bytes\n    resp_msg = message_from_bytes(response.content)\n\n    result = None\n    body = None\n\n    for part in resp_msg.walk():\n        name = part.get_param('name', header='content-disposition')\n        if name == 'result':\n            result = json.loads(part.get_payload(decode=True))\n        elif name == 'body':\n            body = part.get_payload(decode=True)\n\n    return result, body\n\n# Usage\nwith open('message.eml', 'rb') as f:\n    message = f.read()\n\nresult, modified_body = scan_message_v3(message)\nprint(f\"Action: {result['action']}, Score: {result['score']}\")\nif modified_body:\n    print(\"Message was modified by Rspamd\")\n"})}),"\n",(0,r.jsx)(n.h4,{id:"using-compression-zstd",children:"Using Compression (zstd)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Python example with zstd compression:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport json\nimport zstandard as zstd\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\ndef scan_message_v3_compressed(message_content, metadata=None):\n    # Prepare metadata\n    if metadata is None:\n        metadata = {\n            \"ip\": \"127.0.0.1\",\n            \"from\": \"test@example.com\",\n            \"rcpt\": [\"recipient@example.com\"]\n        }\n\n    # Build multipart request\n    mp = MIMEMultipart('form-data')\n\n    # Add metadata part (uncompressed)\n    metadata_part = MIMEApplication(\n        json.dumps(metadata),\n        'json',\n        name='metadata'\n    )\n    metadata_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='metadata'\n    )\n    mp.attach(metadata_part)\n\n    # Compress message with zstd\n    cctx = zstd.ZstdCompressor(level=3)\n    compressed_message = cctx.compress(message_content)\n\n    # Add compressed message part\n    message_part = MIMEApplication(\n        compressed_message,\n        'octet-stream',\n        name='message'\n    )\n    message_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='message'\n    )\n    message_part.add_header('Content-Encoding', 'zstd')\n    mp.attach(message_part)\n\n    # Send request\n    response = requests.post(\n        'http://localhost:11333/checkv3',\n        data=mp.as_string().split('\\n\\n', 1)[1],\n        headers={\n            'Content-Type': mp.get_content_type() +\n                          f'; boundary=\"{mp.get_boundary()}\"'\n        }\n    )\n\n    # Parse response (may also be compressed)\n    from email import message_from_bytes\n    resp_msg = message_from_bytes(response.content)\n\n    dctx = zstd.ZstdDecompressor()\n    result = None\n    body = None\n\n    for part in resp_msg.walk():\n        name = part.get_param('name', header='content-disposition')\n        payload = part.get_payload(decode=True)\n\n        # Check if part is compressed\n        if part.get('Content-Encoding') == 'zstd':\n            payload = dctx.decompress(payload)\n\n        if name == 'result':\n            result = json.loads(payload)\n        elif name == 'body':\n            body = payload\n\n    return result, body\n\n# Usage\nwith open('large_message.eml', 'rb') as f:\n    message = f.read()\n\nprint(f\"Original size: {len(message)} bytes\")\nresult, modified_body = scan_message_v3_compressed(message)\nprint(f\"Action: {result['action']}, Score: {result['score']}\")\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Compression ratio example:"})}),"\n",(0,r.jsx)(n.p,{children:"For a typical email message, you can expect:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Text-heavy emails"}),": 5:1 to 10:1 compression ratio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"HTML emails"}),": 8:1 to 15:1 compression ratio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Large attachments"}),": Varies by content type"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Using rspamc with compression\nrspamc -3 -z large_message.eml\n\n# Monitor compression savings\n# Before: Content-Length: 125000\n# After:  Content-Length: 12500 (10:1 ratio)\n"})}),"\n",(0,r.jsx)(n.h4,{id:"using-messagepack",children:"Using MessagePack"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Python example with msgpack encoding:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport msgpack\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\ndef scan_message_v3_msgpack(message_content, metadata=None):\n    # Prepare metadata\n    if metadata is None:\n        metadata = {\n            \"ip\": \"127.0.0.1\",\n            \"from\": \"test@example.com\",\n            \"rcpt\": [\"recipient@example.com\"]\n        }\n\n    # Build multipart request\n    mp = MIMEMultipart('form-data')\n\n    # Add metadata part using msgpack\n    metadata_bytes = msgpack.packb(metadata)\n    metadata_part = MIMEApplication(\n        metadata_bytes,\n        'x-msgpack',\n        name='metadata'\n    )\n    metadata_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='metadata'\n    )\n    mp.attach(metadata_part)\n\n    # Add message part\n    message_part = MIMEApplication(\n        message_content,\n        'octet-stream',\n        name='message'\n    )\n    message_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='message'\n    )\n    mp.attach(message_part)\n\n    # Send request with msgpack Accept header\n    response = requests.post(\n        'http://localhost:11333/checkv3',\n        data=mp.as_string().split('\\n\\n', 1)[1],\n        headers={\n            'Content-Type': mp.get_content_type() +\n                          f'; boundary=\"{mp.get_boundary()}\"',\n            'Accept': 'application/x-msgpack'\n        }\n    )\n\n    # Parse msgpack response\n    from email import message_from_bytes\n    resp_msg = message_from_bytes(response.content)\n\n    result = None\n    body = None\n\n    for part in resp_msg.walk():\n        name = part.get_param('name', header='content-disposition')\n        payload = part.get_payload(decode=True)\n\n        if name == 'result':\n            # Response is in msgpack format\n            if part.get_content_type() == 'application/x-msgpack':\n                result = msgpack.unpackb(payload, raw=False)\n            else:\n                result = json.loads(payload)\n        elif name == 'body':\n            body = payload\n\n    return result, body\n\n# Usage\nwith open('message.eml', 'rb') as f:\n    message = f.read()\n\nresult, modified_body = scan_message_v3_msgpack(message)\nprint(f\"Action: {result['action']}, Score: {result['score']}\")\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Using rspamc with msgpack:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Enable msgpack encoding for both request and response\nrspamc --protocol-v3 --msgpack scan message.eml\n\n# Short form\nrspamc -3 --msgpack message.eml\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"MessagePack advantages:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Size"}),": 20-30% smaller than JSON for typical scan results"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Speed"}),": 2-3x faster parsing than JSON"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Binary-safe"}),": No escaping issues with binary data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ideal for"}),": High-throughput integrations processing thousands of messages per second"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"combined-compression--messagepack",children:"Combined: Compression + MessagePack"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Python example with both compression and msgpack:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import requests\nimport msgpack\nimport zstandard as zstd\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\ndef scan_message_v3_optimized(message_content, metadata=None):\n    \"\"\"\n    Optimized v3 scan using both msgpack and compression.\n    Ideal for high-volume deployments.\n\n    Note: Only the message part is compressed. The metadata part\n    does NOT support compression and is sent as raw msgpack.\n    \"\"\"\n    if metadata is None:\n        metadata = {\n            \"ip\": \"127.0.0.1\",\n            \"from\": \"test@example.com\",\n            \"rcpt\": [\"recipient@example.com\"]\n        }\n\n    # Build multipart request\n    mp = MIMEMultipart('form-data')\n    cctx = zstd.ZstdCompressor(level=3)\n\n    # Add msgpack metadata (uncompressed - compression not supported)\n    metadata_bytes = msgpack.packb(metadata)\n\n    metadata_part = MIMEApplication(\n        metadata_bytes,\n        'x-msgpack',\n        name='metadata'\n    )\n    metadata_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='metadata'\n    )\n    # Note: Do NOT add Content-Encoding header for metadata\n    mp.attach(metadata_part)\n\n    # Add compressed message\n    compressed_message = cctx.compress(message_content)\n\n    message_part = MIMEApplication(\n        compressed_message,\n        'octet-stream',\n        name='message'\n    )\n    message_part.add_header(\n        'Content-Disposition',\n        'form-data',\n        name='message'\n    )\n    message_part.add_header('Content-Encoding', 'zstd')\n    mp.attach(message_part)\n\n    # Send request\n    response = requests.post(\n        'http://localhost:11333/checkv3',\n        data=mp.as_string().split('\\n\\n', 1)[1],\n        headers={\n            'Content-Type': mp.get_content_type() +\n                          f'; boundary=\"{mp.get_boundary()}\"',\n            'Accept': 'application/x-msgpack'\n        }\n    )\n\n    # Parse response\n    from email import message_from_bytes\n    resp_msg = message_from_bytes(response.content)\n\n    dctx = zstd.ZstdDecompressor()\n    result = None\n    body = None\n\n    for part in resp_msg.walk():\n        name = part.get_param('name', header='content-disposition')\n        payload = part.get_payload(decode=True)\n\n        # Decompress if needed\n        if part.get('Content-Encoding') == 'zstd':\n            payload = dctx.decompress(payload)\n\n        if name == 'result':\n            if part.get_content_type() == 'application/x-msgpack':\n                result = msgpack.unpackb(payload, raw=False)\n            else:\n                result = json.loads(payload)\n        elif name == 'body':\n            body = payload\n\n    return result, body\n\n# Usage\nwith open('message.eml', 'rb') as f:\n    message = f.read()\n\nresult, modified_body = scan_message_v3_optimized(message)\nprint(f\"Action: {result['action']}, Score: {result['score']}\")\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Using rspamc with both features:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Maximum optimization: msgpack + compression\nrspamc --protocol-v3 --msgpack -z scan message.eml\n\n# Short form\nrspamc -3 --msgpack -z message.eml\n\n# Batch scanning with optimization\nfor msg in *.eml; do\n    rspamc -3 --msgpack -z "$msg"\ndone\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Performance comparison:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Configuration"}),(0,r.jsx)(n.th,{children:"Request Size"}),(0,r.jsx)(n.th,{children:"Response Size"}),(0,r.jsx)(n.th,{children:"Parse Time"}),(0,r.jsx)(n.th,{children:"Throughput"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"v2 JSON"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"baseline"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"v3 JSON"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"95%"}),(0,r.jsx)(n.td,{children:"+5%"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"v3 + compression"}),(0,r.jsx)(n.td,{children:"15%"}),(0,r.jsx)(n.td,{children:"20%"}),(0,r.jsx)(n.td,{children:"90%"}),(0,r.jsx)(n.td,{children:"+35%"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"v3 + msgpack"}),(0,r.jsx)(n.td,{children:"100%"}),(0,r.jsx)(n.td,{children:"75%"}),(0,r.jsx)(n.td,{children:"70%"}),(0,r.jsx)(n.td,{children:"+25%"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"v3 + msgpack + compression"}),(0,r.jsx)(n.td,{children:"12%"}),(0,r.jsx)(n.td,{children:"15%"}),(0,r.jsx)(n.td,{children:"65%"}),(0,r.jsx)(n.td,{children:"+50%"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Recommended configurations:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Local deployments"})," (Unix socket): Use plain v3 JSON (compression overhead not worth it)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Remote deployments"})," (network): Use v3 + compression"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"High-volume integrations"})," (1000+ msg/sec): Use v3 + msgpack + compression"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Low-latency requirements"}),": Use v3 + msgpack (no compression)"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"curl-examples",children:"Curl Examples"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Basic v3 request with curl:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Create multipart request manually\nBOUNDARY="----RspamdBoundary$$"\n\ncurl -X POST http://localhost:11333/checkv3 \\\n  -H "Content-Type: multipart/form-data; boundary=$BOUNDARY" \\\n  --data-binary @- <<EOF\n--$BOUNDARY\nContent-Disposition: form-data; name="metadata"\nContent-Type: application/json\n\n{"ip":"192.168.1.1","from":"sender@example.com","rcpt":["rcpt@example.com"]}\n--$BOUNDARY\nContent-Disposition: form-data; name="message"\nContent-Type: application/octet-stream\n\n$(cat message.eml)\n--$BOUNDARY--\nEOF\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"With compression:"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important"}),": The multipart parser only supports ",(0,r.jsx)(n.code,{children:"Content-Encoding: zstd"})," for decompression. It does NOT support base64 decoding from ",(0,r.jsx)(n.code,{children:"Content-Transfer-Encoding"}),". You must send binary zstd-compressed data directly."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Method 1: Using a temporary file (recommended)\nBOUNDARY="----RspamdBoundary$$"\nCOMPRESSED_FILE=$(mktemp)\nzstd -c message.eml > "$COMPRESSED_FILE"\n\ncurl -X POST http://localhost:11333/checkv3 \\\n  -H "Content-Type: multipart/form-data; boundary=$BOUNDARY" \\\n  --data-binary @- <<EOF\n--$BOUNDARY\nContent-Disposition: form-data; name="metadata"\nContent-Type: application/json\n\n{"ip":"192.168.1.1","from":"sender@example.com"}\n--$BOUNDARY\nContent-Disposition: form-data; name="message"\nContent-Type: application/octet-stream\nContent-Encoding: zstd\n\n$(cat "$COMPRESSED_FILE")\n--$BOUNDARY--\nEOF\n\nrm "$COMPRESSED_FILE"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Alternative: Using a helper script"})}),"\n",(0,r.jsx)(n.p,{children:"For more complex scenarios, use a script that properly constructs the multipart body:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# send_v3.sh - Send v3 request with proper multipart encoding\n\nMESSAGE_FILE="$1"\nBOUNDARY="----RspamdBoundary$$"\nTMPDIR=$(mktemp -d)\n\n# Compress message\nzstd -c "$MESSAGE_FILE" > "$TMPDIR/message.zst"\n\n# Build multipart body\ncat > "$TMPDIR/request.txt" <<EOF\n--$BOUNDARY\nContent-Disposition: form-data; name="metadata"\nContent-Type: application/json\n\n{"ip":"192.168.1.1","from":"test@example.com","rcpt":["rcpt@example.com"]}\n--$BOUNDARY\nContent-Disposition: form-data; name="message"\nContent-Type: application/octet-stream\nContent-Encoding: zstd\n\nEOF\n\n# Append binary compressed data\ncat "$TMPDIR/message.zst" >> "$TMPDIR/request.txt"\n\n# Append closing boundary\necho -e "\\n--$BOUNDARY--" >> "$TMPDIR/request.txt"\n\n# Send request\ncurl -X POST http://localhost:11333/checkv3 \\\n  -H "Content-Type: multipart/form-data; boundary=$BOUNDARY" \\\n  --data-binary "@$TMPDIR/request.txt"\n\n# Cleanup\nrm -rf "$TMPDIR"\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Using rspamc (simplest approach):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Let rspamc handle all the multipart encoding\nrspamc -3 -z message.eml\n\n# This is equivalent to the complex curl commands above\n"})}),"\n",(0,r.jsx)(n.h3,{id:"backward-compatibility",children:"Backward Compatibility"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/checkv3"})," is a new endpoint; existing ",(0,r.jsx)(n.code,{children:"/check"}),", ",(0,r.jsx)(n.code,{children:"/checkv2"}),", ",(0,r.jsx)(n.code,{children:"/symbols"})," endpoints are unchanged"]}),"\n",(0,r.jsx)(n.li,{children:"The v2 JSON response schema is identical \u2014 only the transport wrapper changes"}),"\n",(0,r.jsx)(n.li,{children:"Proxy supports v3 alongside all legacy protocols (HTTP, SPAMC, RSPAMC)"}),"\n",(0,r.jsx)(n.li,{children:"Clients can continue using v2 indefinitely; v3 is opt-in"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"normal-worker-http-endpoints",children:"Normal worker HTTP endpoints"}),"\n",(0,r.jsxs)(n.p,{children:["The following endpoints are valid on the normal worker and accept ",(0,r.jsx)(n.code,{children:"POST"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/checkv2"})," - Checks message and return action (v2 protocol)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/checkv3"})," - Checks message and return action (v3 multipart protocol, from Rspamd 3.15)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The below endpoints all use ",(0,r.jsx)(n.code,{children:"GET"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/ping"})," - Returns just a ",(0,r.jsx)(n.code,{children:"pong"})," HTTP reply (could be used for monitoring)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"controller-http-endpoints",children:"Controller HTTP endpoints"}),"\n",(0,r.jsxs)(n.p,{children:["The following endpoints are valid merely on the controller. All of these may require ",(0,r.jsx)(n.code,{children:"Password"})," header to be sent depending on configuration (passing this as query string works too)."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/fuzzyadd"})," - Adds message to fuzzy storage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/fuzzydel"})," - Removes message from fuzzy storage"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["These accept ",(0,r.jsx)(n.code,{children:"POST"}),". Headers which must be set are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Flag"}),": flag identifying fuzzy storage"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Weight"}),": weight to add to hashes"]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/learnspam"})," - Trains bayes classifier on spam message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/learnham"})," - Trains bayes classifier on ham message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/checkv2"})," - Checks message and return action (same as normal worker)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["These also accept ",(0,r.jsx)(n.code,{children:"POST"}),". Headers which may be set are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Classifier"}),": classifier name to be learned. If not specified, all available classifiers will be learned."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The following endpoints all use ",(0,r.jsx)(n.code,{children:"GET"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/errors"})," - Returns error messages from ring buffer"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/stat"})," - Returns statistics"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/statreset"})," - Returns statistics and reset countes"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/graph?type=<hourly|daily|weekly|monthly>"})," - Plots throughput graph"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/history"})," - Returns rolling history"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/historyreset"})," - Returns rolling history and resets its elements afterwards"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/actions"})," - Returns thresholds for actions"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/symbols"})," - Returns symbols in metric & their scores"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/maps"})," - Returns list of maps"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/neighbours"})," - Returns list of known peers"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/errors"})," - Returns a content of erros ring buffer"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/getmap"})," - Fetches contents of map according to ID passed in ",(0,r.jsx)(n.code,{children:"Map:"})," header"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/fuzzydelhash"})," - Deletes entries from fuzzy according to content of ",(0,r.jsx)(n.code,{children:"Hash:"})," header(s)"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/plugins"})," - Returns list of plugins or plugin specific stuff"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/ping"})," - Returns just a ",(0,r.jsx)(n.code,{children:"pong"})," HTTP reply (could be used for monitoring)"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"/metrics"})," - Returns OpenMetrics data"]}),"\n",(0,r.jsxs)(n.p,{children:["Sample response of ",(0,r.jsx)(n.code,{children:"/metrics"})," endpoint:"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'    # HELP rspamd_build_info A metric with a constant \'1\' value labeled by version from which rspamd was built.\n  # TYPE rspamd_build_info gauge\n  rspamd_build_info{version="3.2"} 1\n  # HELP rspamd_config A metric with a constant \'1\' value labeled by id of the current config.\n  # TYPE rspamd_config gauge\n  rspamd_config{id="nzpuz9fm3jk1xncp3q136cudb3qycb7sygxjcko89ya69i8zs3879wbifxh9wfoip7ur8or6dx1crry9px36j9x36btbndjtxug9kub"} 1\n  # HELP rspamd_scan_time_average Average messages scan time.\n  # TYPE rspamd_scan_time_average gauge\n  rspamd_scan_time_average 0.15881561463879001\n  # HELP process_start_time_seconds Start time of the process since unix epoch in seconds.\n  # TYPE process_start_time_seconds gauge\n  process_start_time_seconds 1663651459\n  # HELP rspamd_read_only Whether the rspamd instance is read-only.\n  # TYPE rspamd_read_only gauge\n  rspamd_read_only 0\n  # HELP rspamd_scanned_total Scanned messages.\n  # TYPE rspamd_scanned_total counter\n  rspamd_scanned_total 5978\n  # HELP rspamd_learned_total Learned messages.\n  # TYPE rspamd_learned_total counter\n  rspamd_learned_total 5937\n  # HELP rspamd_spam_total Messages classified as spam.\n  # TYPE rspamd_spam_total counter\n  rspamd_spam_total 5978\n  # HELP rspamd_ham_total Messages classified as spam.\n  # TYPE rspamd_ham_total counter\n  rspamd_ham_total 0\n  # HELP rspamd_connections Active connections.\n  # TYPE rspamd_connections gauge\n  rspamd_connections 0\n  # HELP rspamd_control_connections_total Control connections.\n  # TYPE rspamd_control_connections_total gauge\n  rspamd_control_connections_total 45399\n  # HELP rspamd_pools_allocated Pools allocated.\n  # TYPE rspamd_pools_allocated gauge\n  rspamd_pools_allocated 45585\n  # HELP rspamd_pools_freed Pools freed.\n  # TYPE rspamd_pools_freed gauge\n  rspamd_pools_freed 45542\n  # HELP rspamd_allocated_bytes Bytes allocated.\n  # TYPE rspamd_allocated_bytes gauge\n  rspamd_allocated_bytes 60537276\n  # HELP rspamd_chunks_allocated Memory pools: current chunks allocated.\n  # TYPE rspamd_chunks_allocated gauge\n  rspamd_chunks_allocated 374\n  # HELP rspamd_shared_chunks_allocated Memory pools: current shared chunks allocated.\n  # TYPE rspamd_shared_chunks_allocated gauge\n  rspamd_shared_chunks_allocated 15\n  # HELP rspamd_chunks_freed Memory pools: current chunks freed.\n  # TYPE rspamd_chunks_freed gauge\n  rspamd_chunks_freed 0\n  # HELP rspamd_chunks_oversized Memory pools: current chunks oversized (needs extra allocation/fragmentation).\n  # TYPE rspamd_chunks_oversized gauge\n  rspamd_chunks_oversized 1550\n  # HELP rspamd_fragmented Memory pools: fragmented memory waste.\n  # TYPE rspamd_fragmented gauge\n  rspamd_fragmented 0\n  # HELP rspamd_learns_total Total learns.\n  # TYPE rspamd_learns_total counter\n  rspamd_learns_total 9526\n  # HELP rspamd_actions_total Actions labelled by action type.\n  # TYPE rspamd_actions_total counter\n  rspamd_actions_total{type="reject"} 0\n  rspamd_actions_total{type="soft reject"} 0\n  rspamd_actions_total{type="rewrite subject"} 0\n  rspamd_actions_total{type="add header"} 5978\n  rspamd_actions_total{type="greylist"} 0\n  rspamd_actions_total{type="no action"} 0\n  # HELP rspamd_statfiles_revision Stat files revision.\n  # TYPE rspamd_statfiles_revision gauge\n  rspamd_statfiles_revision{symbol="BAYES_SPAM",type="redis"} 9429\n  rspamd_statfiles_revision{symbol="BAYES_HAM",type="redis"} 97\n  # HELP rspamd_statfiles_used Stat files used.\n  # TYPE rspamd_statfiles_used gauge\n  rspamd_statfiles_used{symbol="BAYES_SPAM",type="redis"} 0\n  rspamd_statfiles_used{symbol="BAYES_HAM",type="redis"} 0\n  # HELP rspamd_statfiles_totals Stat files total.\n  # TYPE rspamd_statfiles_totals gauge\n  rspamd_statfiles_totals{symbol="BAYES_SPAM",type="redis"} 0\n  rspamd_statfiles_totals{symbol="BAYES_HAM",type="redis"} 0\n  # HELP rspamd_statfiles_size Stat files size.\n  # TYPE rspamd_statfiles_size gauge\n  rspamd_statfiles_size{symbol="BAYES_SPAM",type="redis"} 0\n  rspamd_statfiles_size{symbol="BAYES_HAM",type="redis"} 0\n  # HELP rspamd_statfiles_languages Stat files languages.\n  # TYPE rspamd_statfiles_languages gauge\n  rspamd_statfiles_languages{symbol="BAYES_SPAM",type="redis"} 0\n  rspamd_statfiles_languages{symbol="BAYES_HAM",type="redis"} 0\n  # HELP rspamd_statfiles_users Stat files users.\n  # TYPE rspamd_statfiles_users gauge\n  rspamd_statfiles_users{symbol="BAYES_SPAM",type="redis"} 1\n  rspamd_statfiles_users{symbol="BAYES_HAM",type="redis"} 1\n  # HELP rspamd_fuzzy_stat Fuzzy stat labelled by storage.\n  # TYPE rspamd_fuzzy_stat gauge\n  rspamd_fuzzy_stat{storage="rspamd.com"} 1768011131\n  # EOF\n'})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>d});var t=s(6540);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);