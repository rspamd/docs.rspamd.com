"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[7613],{4487(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"modules/neural","title":"Neural network module","description":"The neural network module performs post-classification of messages using a small neural network. It operates in two fundamentally different modes depending on configuration:","source":"@site/docs/modules/neural.md","sourceDirName":"modules","slug":"/modules/neural","permalink":"/docs.rspamd.com/branches/master/modules/neural","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/modules/neural.md","tags":[],"version":"current","frontMatter":{"title":"Neural network module"},"sidebar":"docs","previous":{"title":"MX Check module","permalink":"/docs.rspamd.com/branches/master/modules/mx_check"},"next":{"title":"Once received module","permalink":"/docs.rspamd.com/branches/master/modules/once_received"}}');var r=s(4848),l=s(8453);const d={title:"Neural network module"},t="Neural network module",c={},a=[{value:"Architecture overview",id:"architecture-overview",level:2},{value:"Input vectors: what the network learns from",id:"input-vectors-what-the-network-learns-from",level:2},{value:"Symbol-based mode (default)",id:"symbol-based-mode-default",level:3},{value:"1. Metatokens (message metadata)",id:"1-metatokens-message-metadata",level:4},{value:"2. Symbol scores",id:"2-symbol-scores",level:4},{value:"LLM embedding mode",id:"llm-embedding-mode",level:3},{value:"Fusion mode",id:"fusion-mode",level:3},{value:"Symbol profiles",id:"symbol-profiles",level:2},{value:"How profiles work",id:"how-profiles-work",level:3},{value:"Profile matching",id:"profile-matching",level:3},{value:"Static profiles",id:"static-profiles",level:3},{value:"Training lifecycle",id:"training-lifecycle",level:2},{value:"Automatic training (default)",id:"automatic-training-default",level:3},{value:"Manual training",id:"manual-training",level:3},{value:"Training balance",id:"training-balance",level:3},{value:"Balanced mode (default)",id:"balanced-mode-default",level:4},{value:"Proportional mode",id:"proportional-mode",level:4},{value:"When training triggers",id:"when-training-triggers",level:3},{value:"ANN versioning and retraining",id:"ann-versioning-and-retraining",level:3},{value:"Training process",id:"training-process",level:2},{value:"Process flow",id:"process-flow",level:3},{value:"Training isolation",id:"training-isolation",level:3},{value:"Distributed locking",id:"distributed-locking",level:3},{value:"Dimensionality reduction (PCA)",id:"dimensionality-reduction-pca",level:3},{value:"Redis storage structure",id:"redis-storage-structure",level:2},{value:"Profile index (Sorted Set)",id:"profile-index-sorted-set",level:3},{value:"ANN storage (Hash)",id:"ann-storage-hash",level:3},{value:"Training vectors (Sets)",id:"training-vectors-sets",level:3},{value:"Key lifecycle",id:"key-lifecycle",level:3},{value:"Configuration reference",id:"configuration-reference",level:2},{value:"Basic setup",id:"basic-setup",level:3},{value:"Training options",id:"training-options",level:3},{value:"Network architecture",id:"network-architecture",level:3},{value:"Scoring options",id:"scoring-options",level:3},{value:"Storage options",id:"storage-options",level:3},{value:"Provider options",id:"provider-options",level:3},{value:"Fusion options",id:"fusion-options",level:3},{value:"Other options",id:"other-options",level:3},{value:"Example configurations",id:"example-configurations",level:2},{value:"Basic setup (symbol-based)",id:"basic-setup-symbol-based",level:3},{value:"Multiple rules with different training windows",id:"multiple-rules-with-different-training-windows",level:3},{value:"LLM embedding mode",id:"llm-embedding-mode-1",level:3},{value:"Settings integration",id:"settings-integration",level:3},{value:"External training pipeline",id:"external-training-pipeline",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Check ANN status",id:"check-ann-status",level:3},{value:"Check training progress",id:"check-training-progress",level:3},{value:"Debug logging",id:"debug-logging",level:3},{value:"Common issues",id:"common-issues",level:3},{value:"Symbol registration",id:"symbol-registration",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"neural-network-module",children:"Neural network module"})}),"\n",(0,r.jsx)(n.p,{children:"The neural network module performs post-classification of messages using a small neural network. It operates in two fundamentally different modes depending on configuration:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Symbol-based mode"})," (default): The neural network learns patterns from which Rspamd filters triggered on messages. This is essentially a ",(0,r.jsx)(n.strong,{children:"clustering classifier"}),' that groups messages by their filter fingerprint, not their content. It learns "messages that trigger filters X, Y, Z together are usually spam."']}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"LLM embedding mode"}),": When configured with an LLM provider, the neural network receives text embeddings from an external API. This is a ",(0,r.jsx)(n.strong,{children:"true content classifier"})," that learns from actual message text, independent of which filters triggered."]}),"\n",(0,r.jsxs)(n.p,{children:["Since Rspamd 2.0, the module uses ",(0,r.jsx)(n.a,{href:"https://github.com/attractivechaos/kann",children:"kann"}),", a lightweight neural network library compiled into Rspamd. Earlier versions (1.7-2.0) used ",(0,r.jsx)(n.code,{children:"libfann"}),", which is no longer supported."]}),"\n",(0,r.jsx)(n.h2,{id:"architecture-overview",children:"Architecture overview"}),"\n",(0,r.jsx)(n.p,{children:"The neural module operates as a distributed system where multiple Rspamd instances share neural network data through Redis:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Scanner Worker \u2502     \u2502  Scanner Worker \u2502     \u2502 Primary Controller  \u2502\n\u2502  (inference)    \u2502     \u2502  (inference)    \u2502     \u2502 (training)          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                       \u2502                        \u2502\n         \u2502  load ANN             \u2502  load ANN              \u2502 train ANN\n         \u2502  store vectors        \u2502  store vectors         \u2502 cleanup old ANNs\n         \u2502                       \u2502                        \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                          \u2502    Redis    \u2502\n                          \u2502  (storage)  \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Scanner workers"})," periodically check Redis for updated neural networks and load them for inference. They also store training vectors when messages meet training criteria."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Primary controller worker"})," (only one per cluster) periodically checks if enough training vectors have accumulated and spawns training processes. It also cleans up old ANN profiles."]}),"\n",(0,r.jsx)(n.h2,{id:"input-vectors-what-the-network-learns-from",children:"Input vectors: what the network learns from"}),"\n",(0,r.jsx)(n.p,{children:"The neural network input is a numeric vector whose composition depends on the configured mode."}),"\n",(0,r.jsx)(n.h3,{id:"symbol-based-mode-default",children:"Symbol-based mode (default)"}),"\n",(0,r.jsx)(n.p,{children:"In symbol-based mode, the input vector contains:"}),"\n",(0,r.jsx)(n.h4,{id:"1-metatokens-message-metadata",children:"1. Metatokens (message metadata)"}),"\n",(0,r.jsx)(n.p,{children:"Metatokens are 39+ numeric features extracted from message structure:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Category"}),(0,r.jsx)(n.th,{children:"Features"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Size"})}),(0,r.jsx)(n.td,{children:"Message size (bucketed)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Images"})}),(0,r.jsx)(n.td,{children:"Total count, PNG ratio, JPEG ratio, large images, small images"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Parts"})}),(0,r.jsx)(n.td,{children:"Text parts ratio, attachments ratio"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Encoding"})}),(0,r.jsx)(n.td,{children:"UTF-8 parts ratio, ASCII parts ratio"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Recipients"})}),(0,r.jsx)(n.td,{children:"MIME recipients count, SMTP recipients count"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Received"})}),(0,r.jsx)(n.td,{children:"Header count, invalid headers, time skew, secure relays"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"URLs"})}),(0,r.jsx)(n.td,{children:"URL count"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Words"})}),(0,r.jsx)(n.td,{children:"Average length, short words, spaces rate, double spaces, non-spaces, ASCII rate, non-ASCII rate, capitals rate, numerics rate"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"HTML links"})}),(0,r.jsx)(n.td,{children:"Link count, HTTP ratio, query ratio, same eTLD+1 ratio, domains per link, max links per domain"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"HTML forms"})}),(0,r.jsx)(n.td,{children:"Form count, unaffiliated POST ratio, affiliated POST ratio"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"CTA"})}),(0,r.jsx)(n.td,{children:"Affiliated flag, weight, affiliated links ratio, trackerish ratio"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Visibility"})}),(0,r.jsx)(n.td,{children:"Hidden text ratio, transparent ratio, hidden blocks, transparent blocks, offscreen blocks, meta refresh count"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"The metatoken schema has a version number (currently 3) that is included in the ANN key prefix. When metatokens change, new ANNs are automatically created."}),"\n",(0,r.jsx)(n.h4,{id:"2-symbol-scores",children:"2. Symbol scores"}),"\n",(0,r.jsx)(n.p,{children:"Each symbol in the current Rspamd configuration produces one input value. The value is typically the symbol's score normalized to a 0-1 range. Symbols are automatically filtered:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Excluded symbols:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Symbols with ",(0,r.jsx)(n.code,{children:"nostat"})," flag (statistical symbols like Bayes)"]}),"\n",(0,r.jsxs)(n.li,{children:["Symbols with ",(0,r.jsx)(n.code,{children:"idempotent"})," flag (side-effect only)"]}),"\n",(0,r.jsxs)(n.li,{children:["Symbols with ",(0,r.jsx)(n.code,{children:"skip"})," flag"]}),"\n",(0,r.jsxs)(n.li,{children:["Symbols with ",(0,r.jsx)(n.code,{children:"composite"})," flag (meta-rules)"]}),"\n",(0,r.jsxs)(n.li,{children:["Symbols listed in ",(0,r.jsx)(n.code,{children:"blacklisted_symbols"})," configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Why this is clustering, not content classification:"})}),"\n",(0,r.jsx)(n.p,{children:'The symbol-based input vector doesn\'t contain any actual message content. It only records which filters triggered and with what scores. The neural network learns correlations between filter patterns, effectively clustering messages by their "filter fingerprint." Two completely different messages might produce identical vectors if they trigger the same set of filters.'}),"\n",(0,r.jsx)(n.h3,{id:"llm-embedding-mode",children:"LLM embedding mode"}),"\n",(0,r.jsx)(n.p,{children:"When configured with an LLM provider, the input vector comes from an external embedding API:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'providers = [\n  {\n    type = "llm";\n    llm_type = "openai";  # or "ollama"\n    model = "text-embedding-3-small";\n    url = "https://api.openai.com/v1/embeddings";\n    api_key = "sk-...";\n  }\n];\n'})}),"\n",(0,r.jsx)(n.p,{children:"The LLM provider:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Extracts text content from the message"}),"\n",(0,r.jsx)(n.li,{children:"Sends it to the embedding API"}),"\n",(0,r.jsx)(n.li,{children:"Receives a high-dimensional vector representing the text's semantic content"}),"\n",(0,r.jsx)(n.li,{children:"Caches embeddings in Redis to avoid redundant API calls"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["This mode enables ",(0,r.jsx)(n.strong,{children:"true content-based classification"})," because the embedding vector represents actual message content, not just which filters triggered."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," When LLM providers are configured, automatic training is disabled. You must use manual training via the ",(0,r.jsx)(n.code,{children:"ANN-Train"})," header to control training quality."]}),"\n",(0,r.jsx)(n.h3,{id:"fusion-mode",children:"Fusion mode"}),"\n",(0,r.jsx)(n.p,{children:"Multiple providers can be combined:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'providers = [\n  { type = "llm"; llm_type = "openai"; model = "text-embedding-3-small"; }\n];\nfusion {\n  include_meta = true;       # Include metatokens\n  meta_weight = 1.0;\n  normalization = "zscore";  # none, unit, or zscore\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Vectors from all providers are concatenated. Use ",(0,r.jsx)(n.code,{children:"normalization"})," to scale vectors to comparable ranges."]}),"\n",(0,r.jsx)(n.h2,{id:"symbol-profiles",children:"Symbol profiles"}),"\n",(0,r.jsx)(n.p,{children:"Symbol profiles determine which symbols are included in the ANN's input vector. This is critical for ANN compatibility across workers."}),"\n",(0,r.jsx)(n.h3,{id:"how-profiles-work",children:"How profiles work"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Collection"}),": At startup, each rule collects its symbol profile from either:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Static configuration in ",(0,r.jsx)(n.code,{children:"profile"})," section"]}),"\n",(0,r.jsx)(n.li,{children:"Dynamic extraction from symcache (default)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Filtering"}),": Symbols with excluded flags are removed"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Sorting and hashing"}),": Symbols are sorted alphabetically and hashed to produce a ",(0,r.jsx)(n.code,{children:"digest"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Profile storage"}),": The profile (symbols list + digest) is stored in Redis alongside the ANN"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"profile-matching",children:"Profile matching"}),"\n",(0,r.jsx)(n.p,{children:"When loading ANNs from Redis:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Compare local symbol profile digest with stored profiles"}),"\n",(0,r.jsx)(n.li,{children:"If exact match: load the ANN"}),"\n",(0,r.jsx)(n.li,{children:"If within 30% symbol difference: load with distance penalty"}),"\n",(0,r.jsx)(n.li,{children:"If too different: don't load (incompatible configuration)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This allows some flexibility when configurations change slightly, but prevents using ANNs trained with completely different symbol sets."}),"\n",(0,r.jsx)(n.h3,{id:"static-profiles",children:"Static profiles"}),"\n",(0,r.jsx)(n.p,{children:"For stable deployments, you can define static profiles:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'profile = {\n  default = ["SYMBOL_1", "SYMBOL_2", "SYMBOL_3"];\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Static profiles aren't filtered, giving you complete control over which symbols are included."}),"\n",(0,r.jsx)(n.h2,{id:"training-lifecycle",children:"Training lifecycle"}),"\n",(0,r.jsx)(n.h3,{id:"automatic-training-default",children:"Automatic training (default)"}),"\n",(0,r.jsxs)(n.p,{children:["When ",(0,r.jsx)(n.code,{children:"autotrain = true"})," (default), the module automatically decides which messages to learn from:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Verdict-based"}),": Learn spam from messages with ",(0,r.jsx)(n.code,{children:"spam"})," or ",(0,r.jsx)(n.code,{children:"junk"})," verdict; learn ham from ",(0,r.jsx)(n.code,{children:"ham"})," verdict"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Score-based"}),": If ",(0,r.jsx)(n.code,{children:"spam_score"})," or ",(0,r.jsx)(n.code,{children:"ham_score"})," is set, use score thresholds instead of verdicts"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"train {\n  autotrain = true;\n  spam_score = 10.0;  # Learn as spam if score >= 10\n  ham_score = -1.0;   # Learn as ham if score <= -1\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"manual-training",children:"Manual training"}),"\n",(0,r.jsx)(n.p,{children:"Force training via HTTP header:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'rspamc --header "ANN-Train: spam" < spam_message.eml\nrspamc --header "ANN-Train: ham" < ham_message.eml\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Manual training bypasses all automatic training decisions. This is ",(0,r.jsx)(n.strong,{children:"required"})," when using LLM providers, since automatic training is suppressed to ensure training quality."]}),"\n",(0,r.jsx)(n.h3,{id:"training-balance",children:"Training balance"}),"\n",(0,r.jsx)(n.p,{children:"Neural networks perform poorly when training classes are imbalanced. The module maintains balance through two modes:"}),"\n",(0,r.jsx)(n.h4,{id:"balanced-mode-default",children:"Balanced mode (default)"}),"\n",(0,r.jsx)(n.p,{children:"Maintains approximately equal spam and ham samples:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'train {\n  learn_mode = "balanced";\n  classes_bias = 0.0;  # Strict 1:1 ratio\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"classes_bias"})," parameter allows some imbalance:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"0.0"}),": Strict 1:1 ratio"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"0.25"}),": Allows up to 75%/25% imbalance"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When one class exceeds the other, additional samples of the majority class are probabilistically skipped to maintain balance."}),"\n",(0,r.jsx)(n.h4,{id:"proportional-mode",children:"Proportional mode"}),"\n",(0,r.jsx)(n.p,{children:"Uses explicit skip probabilities:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'train {\n  learn_mode = "proportional";\n  spam_skip_prob = 0.0;\n  ham_skip_prob = 0.5;  # Skip 50% of ham samples\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"when-training-triggers",children:"When training triggers"}),"\n",(0,r.jsxs)(n.p,{children:["Training starts when ",(0,r.jsx)(n.strong,{children:"both"})," conditions are met:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["At least one class has ",(0,r.jsx)(n.code,{children:"max_trains"})," samples"]}),"\n",(0,r.jsxs)(n.li,{children:["In balanced mode: all classes have at least ",(0,r.jsx)(n.code,{children:"max_trains * (1 - classes_bias)"})," samples"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"train {\n  max_trains = 1000;  # Need 1000 samples to train\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ann-versioning-and-retraining",children:"ANN versioning and retraining"}),"\n",(0,r.jsx)(n.p,{children:"Each ANN has a version number. When training completes:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Version is incremented"}),"\n",(0,r.jsx)(n.li,{children:"New ANN is stored with new version"}),"\n",(0,r.jsx)(n.li,{children:"Old training vectors expire (10 minutes grace period)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"max_usages"})," parameter controls how many times an ANN profile can be retrained:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"train {\n  max_usages = 10;  # Retrain up to 10 times, then create new profile\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["After ",(0,r.jsx)(n.code,{children:"max_usages"})," retrains, a new profile with version 0 is created, starting fresh."]}),"\n",(0,r.jsx)(n.h2,{id:"training-process",children:"Training process"}),"\n",(0,r.jsxs)(n.p,{children:["Training runs exclusively on the ",(0,r.jsx)(n.strong,{children:"primary controller worker"})," to prevent conflicts."]}),"\n",(0,r.jsx)(n.h3,{id:"process-flow",children:"Process flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Primary Controller                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 1. Periodic check (watch_interval)                               \u2502\n\u2502    \u2514\u2500> Check spam_set and ham_set sizes                          \u2502\n\u2502                                                                  \u2502\n\u2502 2. If enough samples:                                            \u2502\n\u2502    \u2514\u2500> Acquire lock in Redis (atomic)                            \u2502\n\u2502        \u2514\u2500> If locked by another host, skip                       \u2502\n\u2502                                                                  \u2502\n\u2502 3. Load training vectors from Redis                              \u2502\n\u2502    \u2514\u2500> SMEMBERS spam_set, ham_set                                \u2502\n\u2502    \u2514\u2500> Decompress (zstd) and parse each vector                   \u2502\n\u2502                                                                  \u2502\n\u2502 4. Spawn child process for training                              \u2502\n\u2502    \u2514\u2500> Parent extends lock every 30 seconds                      \u2502\n\u2502    \u2514\u2500> Child performs actual training epochs                     \u2502\n\u2502                                                                  \u2502\n\u2502 5. On completion:                                                \u2502\n\u2502    \u2514\u2500> Save ANN to Redis                                         \u2502\n\u2502    \u2514\u2500> Release lock                                              \u2502\n\u2502    \u2514\u2500> Expire old training vectors (10 min grace)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h3,{id:"training-isolation",children:"Training isolation"}),"\n",(0,r.jsxs)(n.p,{children:["Training runs in a ",(0,r.jsx)(n.strong,{children:"separate child process"})," spawned via ",(0,r.jsx)(n.code,{children:"worker:spawn_process"}),". This:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Prevents training from blocking mail processing"}),"\n",(0,r.jsx)(n.li,{children:"Isolates potential crashes"}),"\n",(0,r.jsx)(n.li,{children:"Allows CPU-intensive training without affecting latency"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"distributed-locking",children:"Distributed locking"}),"\n",(0,r.jsx)(n.p,{children:"Only one Rspamd instance can train at a time:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-lua",children:"-- Lock structure in Redis hash\nHSET ann_key lock <timestamp>\nHSET ann_key hostname <hostname>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Lock timeout is ",(0,r.jsx)(n.code,{children:"lock_expire"})," (default 600 seconds). The training process extends the lock every 30 seconds. If a process crashes, the lock eventually expires."]}),"\n",(0,r.jsx)(n.h3,{id:"dimensionality-reduction-pca",children:"Dimensionality reduction (PCA)"}),"\n",(0,r.jsx)(n.p,{children:"For large symbol configurations, you can reduce input vector size:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:"max_inputs = 100;  # Reduce to 100 dimensions via PCA\n"})}),"\n",(0,r.jsx)(n.p,{children:"PCA is computed during training:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Build scatter matrix from all training vectors"}),"\n",(0,r.jsx)(n.li,{children:"Compute eigenvalues and eigenvectors"}),"\n",(0,r.jsxs)(n.li,{children:["Select top ",(0,r.jsx)(n.code,{children:"max_inputs"})," eigenvectors as projection matrix"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note"}),": PCA requires Rspamd compiled with BLAS support. Check with ",(0,r.jsx)(n.code,{children:"rspamd --version"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"redis-storage-structure",children:"Redis storage structure"}),"\n",(0,r.jsx)(n.h3,{id:"profile-index-sorted-set",children:"Profile index (Sorted Set)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key pattern"}),": ",(0,r.jsx)(n.code,{children:"rn{plugin_ver}_{rule_prefix}_{metatoken_ver}_{settings_name}"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example"}),": ",(0,r.jsx)(n.code,{children:"rn3_default_3_default"})]}),"\n",(0,r.jsx)(n.p,{children:"Stores JSON-serialized profiles ranked by timestamp (most recent = highest rank):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "digest": "a1b2c3d4",\n  "symbols": ["SYMBOL_1", "SYMBOL_2", ...],\n  "version": 5,\n  "redis_key": "rn_default_default_a1b2c3d4_5",\n  "providers_digest": "e5f6g7h8"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"max_profiles"})," setting (default 3) limits how many profiles are kept. Older profiles are automatically deleted."]}),"\n",(0,r.jsx)(n.h3,{id:"ann-storage-hash",children:"ANN storage (Hash)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key pattern"}),": ",(0,r.jsx)(n.code,{children:"{prefix}_{rule}_{settings}_{digest}_{version}"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example"}),": ",(0,r.jsx)(n.code,{children:"rn_default_default_a1b2c3d4_5"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Field"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ann"})}),(0,r.jsx)(n.td,{children:"binary"}),(0,r.jsx)(n.td,{children:"Zstd-compressed neural network data (kann format)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pca"})}),(0,r.jsx)(n.td,{children:"binary"}),(0,r.jsxs)(n.td,{children:["Zstd-compressed PCA matrix (if ",(0,r.jsx)(n.code,{children:"max_inputs"})," set)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"roc_thresholds"})}),(0,r.jsx)(n.td,{children:"JSON"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"[spam_threshold, ham_threshold]"})," from ROC analysis"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"providers_meta"})}),(0,r.jsx)(n.td,{children:"JSON"}),(0,r.jsx)(n.td,{children:"Provider metadata (dimensions, weights)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"norm_stats"})}),(0,r.jsx)(n.td,{children:"JSON"}),(0,r.jsxs)(n.td,{children:["Normalization stats ",(0,r.jsx)(n.code,{children:"{mode, mean, std}"})," for zscore"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"lock"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"Unix timestamp when training lock acquired"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hostname"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"Hostname holding the training lock"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Expiration"}),": ",(0,r.jsx)(n.code,{children:"ann_expire"})," (default 2 days). Accessed ANNs have their rank updated to prevent expiration."]}),"\n",(0,r.jsx)(n.h3,{id:"training-vectors-sets",children:"Training vectors (Sets)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key patterns"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"{ann_key}_spam_set"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"{ann_key}_ham_set"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Each set contains zstd-compressed training vectors. Vector format: semicolon-separated numeric values."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Expiration"}),": After training completes, old training sets expire in 10 minutes (grace period for other workers to finish writing)."]}),"\n",(0,r.jsx)(n.h3,{id:"key-lifecycle",children:"Key lifecycle"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Key Lifecycle                                \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  Profile Created    Training Vectors    Training Triggers       \u2502\n\u2502       \u2502                  \u2502                    \u2502                 \u2502\n\u2502       v                  v                    v                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 Profile \u2502       \u2502 spam_set \u2502        \u2502 Lock     \u2502             \u2502\n\u2502  \u2502 (ZADD)  \u2502       \u2502 ham_set  \u2502        \u2502 acquired \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502 (SADD)   \u2502        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2502       \u2502            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502                  \u2502\n\u2502       \u2502                  \u2502                   \u2502                  \u2502\n\u2502       \u2502                  \u2502            Training completes        \u2502\n\u2502       \u2502                  \u2502                   \u2502                  \u2502\n\u2502       v                  v                   v                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 New ver \u2502       \u2502 EXPIRE   \u2502        \u2502 New ANN  \u2502             \u2502\n\u2502  \u2502 profile \u2502       \u2502 10 min   \u2502        \u2502 stored   \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2502       \u2502                  \u2502                   \u2502                  \u2502\n\u2502       \u2502                  v                   \u2502                  \u2502\n\u2502       \u2502            Keys deleted              \u2502                  \u2502\n\u2502       \u2502                                      \u2502                  \u2502\n\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502                          \u2502                                      \u2502\n\u2502                    Cleanup runs                                 \u2502\n\u2502                    (max_profiles)                               \u2502\n\u2502                          \u2502                                      \u2502\n\u2502                          v                                      \u2502\n\u2502                    Old profiles                                 \u2502\n\u2502                    deleted                                      \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration-reference",children:"Configuration reference"}),"\n",(0,r.jsx)(n.h3,{id:"basic-setup",children:"Basic setup"}),"\n",(0,r.jsx)(n.p,{children:"The module requires Redis and is disabled by default:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nservers = "127.0.0.1:6379";\nenabled = true;\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Define symbol scores in ",(0,r.jsx)(n.code,{children:"local.d/neural_group.conf"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural_group.conf\nsymbols = {\n  "NEURAL_SPAM" {\n    weight = 3.0;\n    description = "Neural network spam";\n  }\n  "NEURAL_HAM" {\n    weight = -3.0;\n    description = "Neural network ham";\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"training-options",children:"Training options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_trains"})}),(0,r.jsx)(n.td,{children:"1000"}),(0,r.jsx)(n.td,{children:"Samples needed per class to start training"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_usages"})}),(0,r.jsx)(n.td,{children:"10"}),(0,r.jsx)(n.td,{children:"Retrains before creating new profile"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_iterations"})}),(0,r.jsx)(n.td,{children:"25"}),(0,r.jsx)(n.td,{children:"Training epochs per run"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"learning_rate"})}),(0,r.jsx)(n.td,{children:"0.01"}),(0,r.jsx)(n.td,{children:"Neural network learning rate"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"mse"})}),(0,r.jsx)(n.td,{children:"0.001"}),(0,r.jsx)(n.td,{children:"Target mean squared error"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"autotrain"})}),(0,r.jsx)(n.td,{children:"true"}),(0,r.jsx)(n.td,{children:"Enable automatic training"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"train_prob"})}),(0,r.jsx)(n.td,{children:"1.0"}),(0,r.jsx)(n.td,{children:"Probability of storing each sample (0-1)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"learn_mode"})}),(0,r.jsx)(n.td,{children:'"balanced"'}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"balanced"})," or ",(0,r.jsx)(n.code,{children:"proportional"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"classes_bias"})}),(0,r.jsx)(n.td,{children:"0.0"}),(0,r.jsx)(n.td,{children:"Allowed imbalance in balanced mode (0-1)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"spam_skip_prob"})}),(0,r.jsx)(n.td,{children:"0.0"}),(0,r.jsx)(n.td,{children:"Spam skip rate in proportional mode"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ham_skip_prob"})}),(0,r.jsx)(n.td,{children:"0.0"}),(0,r.jsx)(n.td,{children:"Ham skip rate in proportional mode"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"spam_score"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Score threshold for spam (overrides verdict)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ham_score"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Score threshold for ham (overrides verdict)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"store_pool_only"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Store vectors without training"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"network-architecture",children:"Network architecture"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hidden_layer_mult"})}),(0,r.jsx)(n.td,{children:"1.5"}),(0,r.jsx)(n.td,{children:"Hidden layer size multiplier"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"max_inputs"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Enable PCA to reduce dimensions"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"scoring-options",children:"Scoring options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_spam"})}),(0,r.jsx)(n.td,{children:'"NEURAL_SPAM"'}),(0,r.jsx)(n.td,{children:"Symbol for spam classification"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"symbol_ham"})}),(0,r.jsx)(n.td,{children:'"NEURAL_HAM"'}),(0,r.jsx)(n.td,{children:"Symbol for ham classification"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"spam_score_threshold"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Output threshold for spam (0-1)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ham_score_threshold"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Output threshold for ham (0-1)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"flat_threshold_curve"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Use binary 0/1 scores"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"roc_enabled"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Compute thresholds via ROC analysis"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"roc_misclassification_cost"})}),(0,r.jsx)(n.td,{children:"0.5"}),(0,r.jsx)(n.td,{children:"Cost weight for ROC computation"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"storage-options",children:"Storage options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ann_expire"})}),(0,r.jsx)(n.td,{children:"172800"}),(0,r.jsx)(n.td,{children:"ANN TTL in seconds (2 days)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"watch_interval"})}),(0,r.jsx)(n.td,{children:"60.0"}),(0,r.jsx)(n.td,{children:"Redis check interval"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"lock_expire"})}),(0,r.jsx)(n.td,{children:"600"}),(0,r.jsx)(n.td,{children:"Training lock timeout"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"provider-options",children:"Provider options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"providers"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"List of feature provider configs"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"disable_symbols_input"})}),(0,r.jsx)(n.td,{children:"false"}),(0,r.jsx)(n.td,{children:"Don't use symbols provider"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"fusion-options",children:"Fusion options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fusion.normalization"})}),(0,r.jsx)(n.td,{children:'"none"'}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"none"}),", ",(0,r.jsx)(n.code,{children:"unit"}),", or ",(0,r.jsx)(n.code,{children:"zscore"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fusion.include_meta"})}),(0,r.jsx)(n.td,{children:"true"}),(0,r.jsx)(n.td,{children:"Include metatokens with providers"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fusion.meta_weight"})}),(0,r.jsx)(n.td,{children:"1.0"}),(0,r.jsx)(n.td,{children:"Weight for metatokens"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"other-options",children:"Other options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"blacklisted_symbols"})}),(0,r.jsx)(n.td,{children:"[]"}),(0,r.jsx)(n.td,{children:"Symbols to exclude"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"allowed_settings"})}),(0,r.jsx)(n.td,{children:"nil"}),(0,r.jsx)(n.td,{children:"Settings IDs that can train"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"profile"})}),(0,r.jsx)(n.td,{children:"{}"}),(0,r.jsx)(n.td,{children:"Static symbol profiles"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"example-configurations",children:"Example configurations"}),"\n",(0,r.jsx)(n.h3,{id:"basic-setup-symbol-based",children:"Basic setup (symbol-based)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nservers = "127.0.0.1:6379";\nenabled = true;\n\nrules {\n  default {\n    train {\n      max_trains = 1000;\n      max_usages = 10;\n      learning_rate = 0.01;\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"multiple-rules-with-different-training-windows",children:"Multiple rules with different training windows"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rules {\n  "SHORT" {\n    train {\n      max_trains = 100;\n      max_usages = 2;\n    }\n    symbol_spam = "NEURAL_SPAM_SHORT";\n    symbol_ham = "NEURAL_HAM_SHORT";\n    ann_expire = 86400;  # 1 day\n  }\n  "LONG" {\n    train {\n      max_trains = 5000;\n      max_usages = 200;\n    }\n    symbol_spam = "NEURAL_SPAM_LONG";\n    symbol_ham = "NEURAL_HAM_LONG";\n    ann_expire = 8640000;  # 100 days\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"llm-embedding-mode-1",children:"LLM embedding mode"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rules {\n  default {\n    providers = [\n      {\n        type = "llm";\n        llm_type = "openai";\n        model = "text-embedding-3-small";\n        url = "https://api.openai.com/v1/embeddings";\n        api_key = "sk-...";\n        cache_ttl = 86400;\n      }\n    ];\n    fusion {\n      include_meta = true;\n      normalization = "zscore";\n    }\n    train {\n      autotrain = false;  # Required for LLM - use manual training\n      max_trains = 500;\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"settings-integration",children:"Settings integration"}),"\n",(0,r.jsx)(n.p,{children:"Separate ANNs for different mail flows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'rules {\n  default {\n    allowed_settings = ["inbound", "outbound"];\n    # Creates separate ANNs: rn3_default_3_inbound, rn3_default_3_outbound\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"external-training-pipeline",children:"External training pipeline"}),"\n",(0,r.jsx)(n.p,{children:"Store vectors for external processing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/neural.conf\nrules {\n  default {\n    train {\n      store_pool_only = true;\n    }\n  }\n}\n\n# local.d/clickhouse.conf\nextra_columns = {\n  Neural_Vec = {\n    selector = "task_cache(\'neural_vec_mpack\')";\n    type = "String";\n  }\n  Neural_Digest = {\n    selector = "task_cache(\'neural_profile_digest\')";\n    type = "String";\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"check-ann-status",children:"Check ANN status"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# List profiles (most recent first)\nredis-cli ZREVRANGE "rn3_default_3_default" 0 -1 WITHSCORES\n\n# Check specific ANN exists\nredis-cli HGETALL "rn_default_default_a1b2c3d4_1"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"check-training-progress",children:"Check training progress"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Training vector counts\nredis-cli SCARD "rn_default_default_a1b2c3d4_1_spam_set"\nredis-cli SCARD "rn_default_default_a1b2c3d4_1_ham_set"\n\n# Check if locked\nredis-cli HGET "rn_default_default_a1b2c3d4_1" lock\nredis-cli HGET "rn_default_default_a1b2c3d4_1" hostname\n'})}),"\n",(0,r.jsx)(n.h3,{id:"debug-logging",children:"Debug logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'# local.d/logging.inc\ndebug_modules = ["neural"];\n'})}),"\n",(0,r.jsx)(n.h3,{id:"common-issues",children:"Common issues"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"ANN not loading across workers:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Different symbol configurations produce different digests"}),"\n",(0,r.jsx)(n.li,{children:"Check that all workers have identical plugin configurations"}),"\n",(0,r.jsx)(n.li,{children:"Use static profiles for stable deployments"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Training not starting:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify both spam and ham sets have enough samples"}),"\n",(0,r.jsxs)(n.li,{children:["Check for stale training locks (older than ",(0,r.jsx)(n.code,{children:"lock_expire"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure primary controller is running"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Poor classification accuracy:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Check training data balance with SCARD commands"}),"\n",(0,r.jsxs)(n.li,{children:["Consider enabling ",(0,r.jsx)(n.code,{children:"roc_enabled"})," for automatic threshold tuning"]}),"\n",(0,r.jsx)(n.li,{children:"In symbol mode: ensure meaningful symbols aren't blacklisted"}),"\n",(0,r.jsx)(n.li,{children:"In LLM mode: verify embedding API is returning valid vectors"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"High memory usage:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"max_inputs"})," with PCA for large symbol configurations"]}),"\n",(0,r.jsxs)(n.li,{children:["Reduce ",(0,r.jsx)(n.code,{children:"max_trains"})," to use smaller training batches"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Vectors not being stored:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Check ",(0,r.jsx)(n.code,{children:"autotrain"})," is enabled (or use manual training)"]}),"\n",(0,r.jsx)(n.li,{children:"Verify message isn't skipped (passthrough verdict, rspamc scan)"}),"\n",(0,r.jsxs)(n.li,{children:["Check ",(0,r.jsx)(n.code,{children:"allow_local"})," if scanning from localhost"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"symbol-registration",children:"Symbol registration"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Symbol"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NEURAL_CHECK"})}),(0,r.jsx)(n.td,{children:"postfilter"}),(0,r.jsx)(n.td,{children:"Main scoring callback"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NEURAL_LEARN"})}),(0,r.jsx)(n.td,{children:"idempotent"}),(0,r.jsx)(n.td,{children:"Training vector storage"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NEURAL_SPAM"})}),(0,r.jsx)(n.td,{children:"virtual"}),(0,r.jsx)(n.td,{children:"ANN classified as spam"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NEURAL_HAM"})}),(0,r.jsx)(n.td,{children:"virtual"}),(0,r.jsx)(n.td,{children:"ANN classified as ham"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Custom symbols can be configured per rule using ",(0,r.jsx)(n.code,{children:"symbol_spam"})," and ",(0,r.jsx)(n.code,{children:"symbol_ham"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,n,s){s.d(n,{R:()=>d,x:()=>t});var i=s(6540);const r={},l=i.createContext(r);function d(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);