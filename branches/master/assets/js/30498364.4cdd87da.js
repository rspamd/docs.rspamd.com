"use strict";(self.webpackChunkrspamd_docs=self.webpackChunkrspamd_docs||[]).push([[8258],{21757:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"administration/rspamadm/dkim-management","title":"DKIM Key Management","description":"These commands provide comprehensive DKIM key generation, storage, and rotation capabilities, including integration with Hashicorp Vault for enterprise key management.","source":"@site/docs/administration/rspamadm/dkim-management.md","sourceDirName":"administration/rspamadm","slug":"/administration/rspamadm/dkim-management","permalink":"/docs.rspamd.com/branches/master/administration/rspamadm/dkim-management","draft":false,"unlisted":false,"editUrl":"https://github.com/rspamd/docs.rspamd.com/edit/master/docs/administration/rspamadm/dkim-management.md","tags":[],"version":"current","frontMatter":{"title":"DKIM Key Management"},"sidebar":"docs","previous":{"title":"DNS & SPF Management","permalink":"/docs.rspamd.com/branches/master/administration/rspamadm/dns-tools"},"next":{"title":"Cryptography & Security","permalink":"/docs.rspamd.com/branches/master/administration/rspamadm/cryptography"}}');var a=i(74848),r=i(28453);const l={title:"DKIM Key Management"},t="DKIM Key Management",o={},d=[{value:"dkim_keygen",id:"dkim_keygen",level:2},{value:"Purpose",id:"purpose",level:3},{value:"Common Scenarios",id:"common-scenarios",level:3},{value:"Basic Key Generation",id:"basic-key-generation",level:4},{value:"Generate for Specific Domain and Selector",id:"generate-for-specific-domain-and-selector",level:4},{value:"Example Output",id:"example-output",level:3},{value:"Options",id:"options",level:3},{value:"Key Type Recommendations",id:"key-type-recommendations",level:3},{value:"Use Cases",id:"use-cases",level:3},{value:"Workflow Example",id:"workflow-example",level:3},{value:"vault",id:"vault",level:2},{value:"Purpose",id:"purpose-1",level:3},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Common Scenarios",id:"common-scenarios-1",level:3},{value:"List Keys in Vault",id:"list-keys-in-vault",level:4},{value:"Show Key Details",id:"show-key-details",level:4},{value:"Create New Key in Vault",id:"create-new-key-in-vault",level:4},{value:"Key Rotation",id:"key-rotation",level:4},{value:"Delete Keys",id:"delete-keys",level:4},{value:"Options",id:"options-1",level:3},{value:"Vault Key Structure",id:"vault-key-structure",level:3},{value:"Enterprise Key Management Workflow",id:"enterprise-key-management-workflow",level:3},{value:"Initial Setup",id:"initial-setup",level:4},{value:"Automated Rotation",id:"automated-rotation",level:4},{value:"Multi-Server Deployment",id:"multi-server-deployment",level:4},{value:"Vault KV Version Support",id:"vault-kv-version-support",level:3},{value:"Security Best Practices",id:"security-best-practices",level:3},{value:"Example Vault Policy",id:"example-vault-policy",level:3},{value:"signtool",id:"signtool",level:2},{value:"Purpose",id:"purpose-2",level:3},{value:"Common Scenarios",id:"common-scenarios-2",level:3},{value:"Create Signing Keypair",id:"create-signing-keypair",level:4},{value:"Sign a File",id:"sign-a-file",level:4},{value:"Sign with Custom Suffix",id:"sign-with-custom-suffix",level:4},{value:"Verify Signature",id:"verify-signature",level:4},{value:"Extract Public Key",id:"extract-public-key",level:4},{value:"Options",id:"options-2",level:3},{value:"Use Cases",id:"use-cases-1",level:3},{value:"Workflow for Map Signing",id:"workflow-for-map-signing",level:3},{value:"Practical Examples",id:"practical-examples",level:2},{value:"Complete DKIM Setup for New Domain",id:"complete-dkim-setup-for-new-domain",level:3},{value:"Vault-Based Multi-Domain Setup",id:"vault-based-multi-domain-setup",level:3},{value:"Quarterly Key Rotation",id:"quarterly-key-rotation",level:3},{value:"Tips and Best Practices",id:"tips-and-best-practices",level:2},{value:"DKIM Key Management",id:"dkim-key-management-1",level:3},{value:"Vault Usage",id:"vault-usage",level:3},{value:"Security",id:"security",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"dkim-key-management",children:"DKIM Key Management"})}),"\n",(0,a.jsx)(n.p,{children:"These commands provide comprehensive DKIM key generation, storage, and rotation capabilities, including integration with Hashicorp Vault for enterprise key management."}),"\n",(0,a.jsx)(n.h2,{id:"dkim_keygen",children:"dkim_keygen"}),"\n",(0,a.jsx)(n.p,{children:"Generate DKIM keypairs."}),"\n",(0,a.jsx)(n.h3,{id:"purpose",children:"Purpose"}),"\n",(0,a.jsx)(n.p,{children:"Create DKIM private and public keys for email signing. Supports both RSA and Ed25519 algorithms."}),"\n",(0,a.jsx)(n.h3,{id:"common-scenarios",children:"Common Scenarios"}),"\n",(0,a.jsx)(n.h4,{id:"basic-key-generation",children:"Basic Key Generation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Generate default 1024-bit RSA key\nrspamadm dkim_keygen\n\n# Generate 2048-bit RSA key\nrspamadm dkim_keygen -b 2048\n\n# Generate Ed25519 key (recommended for new deployments)\nrspamadm dkim_keygen -t ed25519\n"})}),"\n",(0,a.jsx)(n.h4,{id:"generate-for-specific-domain-and-selector",children:"Generate for Specific Domain and Selector"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Generate key for domain with selector\nrspamadm dkim_keygen -d example.com -s default\n\n# Save private key to file\nrspamadm dkim_keygen -d example.com -s mail -k /etc/rspamd/dkim/example.com.key\n"})}),"\n",(0,a.jsx)(n.p,{children:"Output includes:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Private key (PEM format)"}),"\n",(0,a.jsx)(n.li,{children:"Public key formatted for DNS TXT record"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"example-output",children:"Example Output"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'-----BEGIN PRIVATE KEY-----\nMIIBVAIBADANBgkqhkiG9w0BAQEFAASCAT4wggE6AgEAAkEA...\n[private key content]\n-----END PRIVATE KEY-----\n\ndefault._domainkey.example.com. IN TXT ( "v=DKIM1; k=rsa; "\n    "p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC..." )\n'})}),"\n",(0,a.jsx)(n.h3,{id:"options",children:"Options"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'-d, --domain <domain>      Domain name\n-s, --selector <selector>  DKIM selector (default: "default")\n-k, --privkey <file>      Save private key to file\n-b, --bits <bits>         Key length in bits (default: 1024)\n-t, --type <rsa|ed25519>  Key type (default: rsa)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"key-type-recommendations",children:"Key Type Recommendations"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"RSA Keys:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Standard: 1024-bit (fast, widely supported)"}),"\n",(0,a.jsx)(n.li,{children:"Recommended: 2048-bit (more secure, slower)"}),"\n",(0,a.jsx)(n.li,{children:"Maximum: 4096-bit (very secure, compatibility issues)"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Ed25519 Keys:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Modern elliptic curve algorithm"}),"\n",(0,a.jsx)(n.li,{children:"Smaller key size (256-bit equivalent to 3072-bit RSA)"}),"\n",(0,a.jsx)(n.li,{children:"Faster signing and verification"}),"\n",(0,a.jsx)(n.li,{children:"Not universally supported by older systems"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Initial DKIM Setup"}),": Generate keys for new domains"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Key Rotation"}),": Create new keys periodically"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Multi-Domain"}),": Generate keys for each domain"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Selector Rotation"}),": Create multiple selectors for gradual rollover"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"workflow-example",children:"Workflow Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\nDOMAIN="example.com"\nSELECTOR="$(date +%Y%m)"  # Selector based on year-month\nKEY_DIR="/etc/rspamd/dkim"\n\n# Generate key\nrspamadm dkim_keygen -d "$DOMAIN" -s "$SELECTOR" -b 2048 \\\n  -k "$KEY_DIR/$DOMAIN.$SELECTOR.key" \\\n  > "$KEY_DIR/$DOMAIN.$SELECTOR.dns"\n\n# Display DNS record to add\necho "Add this DNS record:"\ncat "$KEY_DIR/$DOMAIN.$SELECTOR.dns"\n\n# Set permissions\nchmod 600 "$KEY_DIR/$DOMAIN.$SELECTOR.key"\nchown rspamd:rspamd "$KEY_DIR/$DOMAIN.$SELECTOR.key"\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"vault",children:"vault"}),"\n",(0,a.jsx)(n.p,{children:"Integrate with Hashicorp Vault for DKIM key management."}),"\n",(0,a.jsx)(n.h3,{id:"purpose-1",children:"Purpose"}),"\n",(0,a.jsx)(n.p,{children:"Store and manage DKIM keys in Hashicorp Vault, enabling centralized key management, automatic rotation, and secure key storage for multi-server deployments."}),"\n",(0,a.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Hashicorp Vault installed and running"}),"\n",(0,a.jsxs)(n.li,{children:["Environment variables set:\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"VAULT_ADDR"})," - Vault server address (e.g., ",(0,a.jsx)(n.code,{children:"https://vault.example.com:8200"}),")"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"VAULT_TOKEN"})," - Authentication token"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'export VAULT_ADDR="https://vault.example.com:8200"\nexport VAULT_TOKEN="your-token-here"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"common-scenarios-1",children:"Common Scenarios"}),"\n",(0,a.jsx)(n.h4,{id:"list-keys-in-vault",children:"List Keys in Vault"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# List all DKIM keys\nrspamadm vault list\n\n# List keys in custom path\nrspamadm vault list -p dkim-keys\n"})}),"\n",(0,a.jsx)(n.h4,{id:"show-key-details",children:"Show Key Details"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Show key for domain\nrspamadm vault show example.com\n\n# Show with UCL output\nrspamadm vault show example.com -o ucl\n\n# Show as JSON\nrspamadm vault show example.com -o json\n\n# Show as YAML\nrspamadm vault show example.com -o yaml\n"})}),"\n",(0,a.jsx)(n.h4,{id:"create-new-key-in-vault",children:"Create New Key in Vault"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Create RSA key\nrspamadm vault newkey example.com -s default\n\n# Create Ed25519 key\nrspamadm vault newkey example.com -s default -A ed25519\n\n# Create 2048-bit RSA key\nrspamadm vault newkey example.com -s mail -b 2048\n\n# Create with expiration\nrspamadm vault newkey example.com -s default -x 365  # Expires in 365 days\n\n# Rewrite existing key\nrspamadm vault newkey example.com -s default -r\n"})}),"\n",(0,a.jsx)(n.h4,{id:"key-rotation",children:"Key Rotation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Perform automatic key rollover\nrspamadm vault roll example.com\n"})}),"\n",(0,a.jsx)(n.p,{children:"This creates a new key with a new selector and marks the old key for gradual deprecation."}),"\n",(0,a.jsx)(n.h4,{id:"delete-keys",children:"Delete Keys"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Delete key for domain\nrspamadm vault delete example.com\n\n# Delete multiple domains\nrspamadm vault delete example.com example.org example.net\n"})}),"\n",(0,a.jsx)(n.h3,{id:"options-1",children:"Options"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"-a, --addr <addr>          Vault address (or use VAULT_ADDR env)\n-t, --token <token>        Vault token (or use VAULT_TOKEN env)\n-p, --path <path>          Vault path (default: dkim)\n-o, --output <type>        Output format: ucl, json, json-compact, yaml\n-k, --kv-version <1|2>     Vault KV store version (default: 1)\n-s, --silent               Suppress extra output\n\nnewkey options:\n-s, --selector <selector>  DKIM selector\n-A, --algorithm <type>     Key type: rsa, ed25519\n-b, --bits <bits>         Key length for RSA\n-x, --expire <days>       Expiration in days\n-r, --rewrite             Overwrite existing key\n"})}),"\n",(0,a.jsx)(n.h3,{id:"vault-key-structure",children:"Vault Key Structure"}),"\n",(0,a.jsx)(n.p,{children:"Keys are stored in Vault with this structure:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "domain": "example.com",\n  "selector": "default",\n  "type": "rsa",\n  "bits": 2048,\n  "private_key": "-----BEGIN PRIVATE KEY-----\\n...",\n  "public_key": "v=DKIM1; k=rsa; p=...",\n  "created": "2025-11-20T10:30:00Z",\n  "expire": "2026-11-20T10:30:00Z"\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"enterprise-key-management-workflow",children:"Enterprise Key Management Workflow"}),"\n",(0,a.jsx)(n.h4,{id:"initial-setup",children:"Initial Setup"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Set Vault environment\nexport VAULT_ADDR="https://vault.company.com:8200"\nexport VAULT_TOKEN="$(cat ~/.vault-token)"\n\n# List current keys\nrspamadm vault list -o json > current-keys.json\n\n# Create keys for all company domains\nfor domain in example.com example.org example.net; do\n  rspamadm vault newkey "$domain" -s $(date +%Y%m) -b 2048\ndone\n'})}),"\n",(0,a.jsx)(n.h4,{id:"automated-rotation",children:"Automated Rotation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# Rotate DKIM keys quarterly\n\nexport VAULT_ADDR="https://vault.company.com:8200"\nexport VAULT_TOKEN="$(vault login -token-only -method=aws)"\n\nDOMAINS=$(rspamadm vault list -o json | jq -r \'.[]\')\n\nfor domain in $DOMAINS; do\n  echo "Rotating key for $domain"\n  rspamadm vault roll "$domain"\n  \n  # Extract DNS record\n  rspamadm vault show "$domain" -o json | \\\n    jq -r \'.public_key\' | \\\n    mail -s "Update DNS for $domain" dns-team@company.com\ndone\n'})}),"\n",(0,a.jsx)(n.h4,{id:"multi-server-deployment",children:"Multi-Server Deployment"}),"\n",(0,a.jsx)(n.p,{children:"Vault allows multiple Rspamd servers to access the same keys:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Configure Rspamd"})," to read from Vault (in ",(0,a.jsx)(n.code,{children:"dkim_signing.conf"}),"):"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",children:'dkim_signing {\n  use_vault = true;\n  vault_url = "https://vault.company.com:8200";\n  vault_token = "${VAULT_TOKEN}";\n  vault_path = "dkim";\n}\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"All servers fetch keys from Vault"})," - no key distribution needed"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Rotate centrally"})," using ",(0,a.jsx)(n.code,{children:"rspamadm vault roll"})]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"vault-kv-version-support",children:"Vault KV Version Support"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"KV Version 1"})," (default):"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Simple key-value storage"}),"\n",(0,a.jsxs)(n.li,{children:["Path: ",(0,a.jsx)(n.code,{children:"secret/dkim/example.com"})]}),"\n",(0,a.jsx)(n.li,{children:"No versioning"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"KV Version 2"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Versioned secrets"}),"\n",(0,a.jsxs)(n.li,{children:["Path: ",(0,a.jsx)(n.code,{children:"secret/data/dkim/example.com"})]}),"\n",(0,a.jsx)(n.li,{children:"Metadata stored separately"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Use ",(0,a.jsx)(n.code,{children:"-k 2"})," for KV v2:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"rspamadm vault list -k 2\n"})}),"\n",(0,a.jsx)(n.h3,{id:"security-best-practices",children:"Security Best Practices"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use VAULT_TOKEN env"})," - Don't pass tokens on command line"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Set appropriate Vault policies"})," - Limit access to DKIM path"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Enable audit logging"})," - Track key access"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use token TTL"})," - Rotate Vault tokens regularly"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"TLS required"})," - Always use HTTPS for Vault"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Key expiration"})," - Set expiration dates on keys"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"example-vault-policy",children:"Example Vault Policy"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",children:'# DKIM key management policy\npath "secret/dkim/*" {\n  capabilities = ["create", "read", "update", "delete", "list"]\n}\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"signtool",children:"signtool"}),"\n",(0,a.jsx)(n.p,{children:"Sign and verify files using keypairs."}),"\n",(0,a.jsx)(n.h3,{id:"purpose-2",children:"Purpose"}),"\n",(0,a.jsx)(n.p,{children:"Sign files for integrity verification, commonly used with Rspamd map updates."}),"\n",(0,a.jsx)(n.h3,{id:"common-scenarios-2",children:"Common Scenarios"}),"\n",(0,a.jsx)(n.h4,{id:"create-signing-keypair",children:"Create Signing Keypair"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Generate keypair for signing\nrspamadm keypair -s -u > signing-keypair.key\n"})}),"\n",(0,a.jsx)(n.h4,{id:"sign-a-file",children:"Sign a File"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Sign file interactively with editor\nrspamadm signtool -e --editor=vim -k signing-keypair.key map.txt\n\n# This opens editor, saves, and adds signature\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The signed file gets a ",(0,a.jsx)(n.code,{children:".sig"})," suffix by default."]}),"\n",(0,a.jsx)(n.h4,{id:"sign-with-custom-suffix",children:"Sign with Custom Suffix"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Save signature in separate file\nrspamadm signtool -S .signature -k signing-keypair.key map.txt\n\n# Creates: map.txt.signature\n"})}),"\n",(0,a.jsx)(n.h4,{id:"verify-signature",children:"Verify Signature"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Verify with public key (base32 encoded)\nrspamadm signtool -v -p <base32-pubkey> map.txt\n\n# Verify with public key from file\nrspamadm signtool -v -P pubkey.txt map.txt\n"})}),"\n",(0,a.jsx)(n.h4,{id:"extract-public-key",children:"Extract Public Key"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Extract public key from keypair\nrspamadm signtool -k signing-keypair.key --pubout pubkey.txt\n"})}),"\n",(0,a.jsx)(n.h3,{id:"options-2",children:"Options"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"-k, --keypair <file>      Keypair file for signing\n-v, --verify              Verify signature mode\n-p, --pubkey <key>        Base32 encoded public key\n-P, --pubfile <file>      File containing public key\n-S, --suffix <suffix>     Signature file suffix (default: .sig)\n-e, --edit                Open editor before signing\n--editor <editor>         Editor to use (default: $EDITOR)\n-q, --quiet               Quiet mode\n-o, --openssl             Use OpenSSL NIST P-256 keys\n--pubout <file>           Export public key to file\n"})}),"\n",(0,a.jsx)(n.h3,{id:"use-cases-1",children:"Use Cases"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Map File Updates:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Sign updated maps before distribution"}),"\n",(0,a.jsx)(n.li,{children:"Verify maps before loading"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Configuration Distribution:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Sign configuration snippets"}),"\n",(0,a.jsx)(n.li,{children:"Verify on remote servers"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"workflow-for-map-signing",children:"Workflow for Map Signing"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# Sign and distribute updated map\n\nMAP_FILE="blacklist.map"\nKEYPAIR="map-signing.key"\nSERVERS="server1 server2 server3"\n\n# Sign the map\nrspamadm signtool -k "$KEYPAIR" "$MAP_FILE"\n\n# Distribute to servers\nfor server in $SERVERS; do\n  scp "$MAP_FILE" "$MAP_FILE.sig" "$server:/etc/rspamd/maps/"\n  ssh "$server" "systemctl reload rspamd"\ndone\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"practical-examples",children:"Practical Examples"}),"\n",(0,a.jsx)(n.h3,{id:"complete-dkim-setup-for-new-domain",children:"Complete DKIM Setup for New Domain"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\nDOMAIN="newdomain.com"\nSELECTOR="mail"\nKEY_DIR="/etc/rspamd/dkim"\n\nmkdir -p "$KEY_DIR"\n\n# Generate key\necho "Generating DKIM key for $DOMAIN..."\nrspamadm dkim_keygen -d "$DOMAIN" -s "$SELECTOR" -b 2048 \\\n  -k "$KEY_DIR/$DOMAIN.key"  > "$KEY_DIR/$DOMAIN.dns"\n\n# Set permissions\nchmod 600 "$KEY_DIR/$DOMAIN.key"\nchown rspamd:rspamd "$KEY_DIR/$DOMAIN.key"\n\n# Show DNS record\necho -e "\\n=== Add this DNS record ==="\ncat "$KEY_DIR/$DOMAIN.dns"\n\n# Test signing (requires message.eml)\nif [ -f "test-message.eml" ]; then\n  rspamadm mime sign -d "$DOMAIN" -s "$SELECTOR" \\\n    -k "$KEY_DIR/$DOMAIN.key" test-message.eml > signed.eml\n  echo -e "\\nTest message signed successfully"\nfi\n'})}),"\n",(0,a.jsx)(n.h3,{id:"vault-based-multi-domain-setup",children:"Vault-Based Multi-Domain Setup"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# Setup DKIM keys in Vault for multiple domains\n\nexport VAULT_ADDR="https://vault.example.com:8200"\nexport VAULT_TOKEN="your-token"\n\nDOMAINS=(\n  "example.com"\n  "example.org"\n  "example.net"\n  "mail.example.com"\n)\n\nSELECTOR=$(date +%Y%m)\n\nfor domain in "${DOMAINS[@]}"; do\n  echo "Creating key for $domain with selector $SELECTOR"\n  \n  # Create key in Vault\n  rspamadm vault newkey "$domain" -s "$SELECTOR" -b 2048 -x 365\n  \n  # Extract DNS record\n  echo "=== DNS Record for $domain ==="\n  rspamadm vault show "$domain" -o json | \\\n    jq -r \'.public_key\' | \\\n    awk -v sel="$SELECTOR" -v dom="$domain" \\\n      \'{printf "%s._domainkey.%s. IN TXT \\"%s\\"\\n", sel, dom, $0}\'\n  echo\ndone\n'})}),"\n",(0,a.jsx)(n.h3,{id:"quarterly-key-rotation",children:"Quarterly Key Rotation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# Automated quarterly DKIM rotation\n\nDOMAINS="example.com example.org example.net"\nOLD_SELECTOR=$(date -d "3 months ago" +%Y%m)\nNEW_SELECTOR=$(date +%Y%m)\n\nfor domain in $DOMAINS; do\n  echo "Rotating $domain: $OLD_SELECTOR -> $NEW_SELECTOR"\n  \n  # Generate new key\n  rspamadm dkim_keygen -d "$domain" -s "$NEW_SELECTOR" -b 2048 \\\n    -k "/etc/rspamd/dkim/$domain.$NEW_SELECTOR.key" \\\n    > "/tmp/$domain.$NEW_SELECTOR.dns"\n  \n  # Update Rspamd config to use new selector\n  # (This step depends on your configuration management)\n  \n  # Email DNS team\n  mail -s "DKIM rotation: $domain" dns-team@example.com < \\\n    "/tmp/$domain.$NEW_SELECTOR.dns"\n  \n  echo "Keep old key active for 7 days, then remove DNS record"\ndone\n'})}),"\n",(0,a.jsx)(n.h2,{id:"tips-and-best-practices",children:"Tips and Best Practices"}),"\n",(0,a.jsx)(n.h3,{id:"dkim-key-management-1",children:"DKIM Key Management"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Regular rotation"})," - Rotate keys every 3-6 months"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Multiple selectors"})," - Use dated selectors for easy tracking (e.g., ",(0,a.jsx)(n.code,{children:"202511"}),")"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Key length"})," - Use 2048-bit RSA for good security/compatibility balance"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Consider Ed25519"})," - For new deployments with modern infrastructure"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Backup keys"})," - Keep secure backups of private keys"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Document selectors"})," - Maintain a record of which selector is active"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"vault-usage",children:"Vault Usage"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Centralized management"})," - Use Vault for multi-server deployments"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Automated rotation"})," - Script quarterly rotations"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Access control"})," - Use Vault policies to restrict access"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Audit logging"})," - Enable Vault audit logs"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Token management"})," - Use short-lived tokens with renewal"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"security",children:"Security"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Protect private keys"})," - Permissions 600, owner rspamd"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Separate keys per domain"})," - Don't reuse keys"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Monitor DKIM failures"})," - Check DMARC reports"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Gradual rollover"})," - Keep old keys active during transition"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Test before deployment"})," - Use ",(0,a.jsx)(n.code,{children:"mime sign"})," to verify"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/docs.rspamd.com/branches/master/administration/rspamadm/email-manipulation",children:"Email Manipulation"})," - ",(0,a.jsx)(n.code,{children:"mime sign"})," command"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/docs.rspamd.com/branches/master/administration/rspamadm/cryptography",children:"Cryptography"})," - Keypair management"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/docs.rspamd.com/branches/master/administration/rspamadm/configuration",children:"Configuration"})," - DKIM signing configuration"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"/modules/dkim_signing",children:"DKIM Module"})," - Rspamd DKIM signing module"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>t});var s=i(96540);const a={},r=s.createContext(a);function l(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);