<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-configuration/statistic" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Statistics settings | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/master/configuration/statistic"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Statistics settings | Rspamd Documentation"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/master/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/statistic"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/statistic" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/ru/configuration/statistic" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/statistic" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Configuration","item":"https://rspamd.com/docs.rspamd.com/branches/master/configuration/"},{"@type":"ListItem","position":2,"name":"Statistics settings","item":"https://rspamd.com/docs.rspamd.com/branches/master/configuration/statistic"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/master/blog/rss.xml" title="Rspamd Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/master/blog/atom.xml" title="Rspamd Blog Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script>

<link rel="alternate" type="application/rss+xml" title="Rspamd Changelog RSS" href="/rss/changelog.xml">
<link rel="alternate" type="application/rss+xml" title="Rspamd Blog RSS" href="/blog/rss.xml">
<link rel="alternate" type="application/atom+xml" title="Rspamd Blog Atom" href="/blog/atom.xml"><link rel="stylesheet" href="/docs.rspamd.com/branches/master/assets/css/styles.10e2e935.css">
<script src="/docs.rspamd.com/branches/master/assets/js/runtime~main.f494d69a.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/master/assets/js/main.1373e0e0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="theme-announcement-bar announcementBar_mb4j" style="background-color:#fee2e2;color:#991b1b" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⚠️ <strong>URGENT: Service Disruption Notice</strong> - Rspamd public fuzzy service and DNSBL RBL feed were temporarily suspended on Oct 18, 2025 due to hosting provider issues. <a href="/blog/2025/10/18/incident-disclosure" style="text-decoration: underline;">Read full incident disclosure</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/about/">About</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/"><span title="About Rspamd" class="linkLabel_WmDU">About Rspamd</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/tutorials/migration"><span title="How-To Guides" class="categoryLinkLabel_W154">How-To Guides</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/faq"><span title="Frequently asked questions" class="linkLabel_WmDU">Frequently asked questions</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/about/"><span title="About" class="categoryLinkLabel_W154">About</span></a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/support"><span title="Rspamd Support" class="linkLabel_WmDU">Rspamd Support</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/downloads"><span title="Downloads" class="linkLabel_WmDU">Downloads</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/master/configuration/"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a><button aria-label="Collapse sidebar category &#x27;Configuration&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/settings"><span title="User settings" class="linkLabel_WmDU">User settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/metrics"><span title="Actions and scores" class="linkLabel_WmDU">Actions and scores</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/logging"><span title="Logging settings" class="linkLabel_WmDU">Logging settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/options"><span title="Common options" class="linkLabel_WmDU">Common options</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/composites"><span title="Composite symbols" class="linkLabel_WmDU">Composite symbols</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/maps"><span title="Rspamd maps" class="linkLabel_WmDU">Rspamd maps</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/selectors"><span title="Selectors" class="linkLabel_WmDU">Selectors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/statistic"><span title="Statistics settings" class="linkLabel_WmDU">Statistics settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/redis"><span title="Redis configuration" class="linkLabel_WmDU">Redis configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/upstream"><span title="Upstreams configuration" class="linkLabel_WmDU">Upstreams configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/ucl"><span title="Universal configuration language (UCL)" class="linkLabel_WmDU">Universal configuration language (UCL)</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/workers/"><span title="Workers" class="categoryLinkLabel_W154">Workers</span></a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/modules/"><span title="Modules" class="categoryLinkLabel_W154">Modules</span></a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/lua/"><span title="Lua API" class="categoryLinkLabel_W154">Lua API</span></a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/developers/architecture"><span title="Developers" class="categoryLinkLabel_W154">Developers</span></a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/other/rspamadm"><span title="Other" class="categoryLinkLabel_W154">Other</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/blog"><span title="Blog" class="linkLabel_WmDU">Blog</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/branches/master/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/master/configuration/"><span>Configuration</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Statistics settings</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Rspamd statistic settings</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>Rspamd utilizes statistics to determine the classification of messages into either spam or ham categories. This classification process is based on the Bayesian theorem, which combines probabilities to assess the likelihood of a message belonging to a particular class, such as <code>spam</code> or <code>ham</code>. The following factors play a role in determining this probability:</p>
<ul>
<li class="">the probability of a specific token to be spam or ham (which means efficiently count of a token&#x27;s occurrences in spam and ham messages)</li>
<li class="">the probability of a specific token to appear in a message (which efficiently means frequency of a token divided by a number of tokens in a message)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="statistics-architecture">Statistics Architecture<a href="#statistics-architecture" class="hash-link" aria-label="Direct link to Statistics Architecture" title="Direct link to Statistics Architecture" translate="no">​</a></h2>
<p>However, Rspamd employs more advanced techniques to combine probabilities, including sparsed bigrams (OSB) and the inverse chi-square distribution.</p>
<p>The <code>OSB</code> algorithm goes beyond considering single words as tokens and instead takes into account combinations of words, taking into consideration their positions. This schema is visually represented in the following diagram:</p>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" width="50%" src="/img/rspamd-schemes.004.png">
<p>The main drawback of this approach is the increased number of tokens, which is multiplied by the size of the window. In Rspamd, we use a window size of 5 tokens, resulting in the number of tokens being approximately <strong>5 times larger</strong> than the number of words.</p>
<p>Statistical tokens are stored in statfiles, which are then mapped to specific backends. This architecture is visually represented in the following diagram:</p>
<img decoding="async" loading="lazy" class="img-fluid img_ev3q" width="50%" src="/img/rspamd-schemes.005.png">
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="statistics-configuration">Statistics Configuration<a href="#statistics-configuration" class="hash-link" aria-label="Direct link to Statistics Configuration" title="Direct link to Statistics Configuration" translate="no">​</a></h2>
<p>Starting from Rspamd 2.0, we recommend using <code>redis</code> as the backend and <code>osb</code> as the tokenizer, which are set as the default settings.</p>
<p>The default configuration settings can be found in the <code>$CONFDIR/statistic.conf</code> file.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classifier &quot;bayes&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # name = &quot;custom&quot;;  # &#x27;name&#x27; parameter must be set if multiple classifiers are defined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tokenizer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;osb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_schema = true; # Always use new schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store_tokens = false; # Redefine if storing of tokens is desired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  signatures = false; # Store learn signatures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #per_user = true; # Enable per user classifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_tokens = 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;redis&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_learns = 200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol = &quot;BAYES_HAM&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spam = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol = &quot;BAYES_SPAM&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spam = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  learn_condition = &#x27;return require(&quot;lua_bayes_learn&quot;).can_learn&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Autolearn sample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # autolearn {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #  spam_threshold = 6.0; # When to learn spam (score &gt;= threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #  ham_threshold = -0.5; # When to learn ham (score &lt;= threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #  check_balance = true; # Check spam and ham balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #  min_balance = 0.9; # Keep diff for spam/ham learns for at least this value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .include(try=true; priority=1) &quot;$LOCAL_CONFDIR/local.d/classifier-bayes.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .include(try=true; priority=10) &quot;$LOCAL_CONFDIR/override.d/classifier-bayes.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.include(try=true; priority=1) &quot;$LOCAL_CONFDIR/local.d/statistic.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.include(try=true; priority=10) &quot;$LOCAL_CONFDIR/override.d/statistic.conf&quot;</span><br></span></code></pre></div></div>
<p>You are also recommended to use the <a class="" href="/docs.rspamd.com/branches/master/modules/bayes_expiry"><code>bayes_expiry</code> module</a> to maintain your statistics database.</p>
<p>Please note that <code>statistic.conf</code> includes the configuration from <code>classifier-bayes.conf</code> for your convenience.</p>
<p>In most setups (where a single classifier is used) you can tune the bayes classifier in <code>local.d/classifier-bayes.conf</code>, and <code>statistic.conf</code> can remain unmodified.</p>
<p>However, if you need to define multiple classifiers, you should create a <code>local.d/statistic.conf</code> file. There you must describe each classifier section explicitly: each classifier <strong>must</strong> have its own <code>name</code> and define <strong>all options</strong> of the default configuration as no fallback will be applied. A common use case for this setup is when one classifier is configured as <code>per_user</code> and another is not.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="multi-class-bayes-313">Multi-class Bayes (3.13+)<a href="#multi-class-bayes-313" class="hash-link" aria-label="Direct link to Multi-class Bayes (3.13+)" title="Direct link to Multi-class Bayes (3.13+)" translate="no">​</a></h2>
<p>Starting with Rspamd 3.13, the Bayes classifier supports multiple classes (e.g. newsletters, transactional, phishing) in addition to the classic binary spam/ham. For production setups we strongly recommend keeping spam/ham as a separate classifier and adding another classifier for non-binary classes. This preserves clear decision making for actions (reject, add header, etc.) while allowing additional categorisation.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration-model-and-incompatibilities">Configuration model and incompatibilities<a href="#configuration-model-and-incompatibilities" class="hash-link" aria-label="Direct link to Configuration model and incompatibilities" title="Direct link to Configuration model and incompatibilities" translate="no">​</a></h3>
<ul>
<li class="">In a multi-class classifier every <code>statfile</code> must define <code>class = &quot;&lt;name&gt;&quot;</code>.</li>
<li class="">Do not mix <code>spam = true/false</code> with <code>class = &quot;...&quot;</code> in the same classifier.</li>
<li class="">A multi-class classifier must have at least two classes (two or more <code>statfile</code> sections with distinct <code>class</code>).</li>
<li class=""><code>min_learns</code> (if set) is applied per class.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="recommended-layout-two-separate-classifiers">Recommended layout: two separate classifiers<a href="#recommended-layout-two-separate-classifiers" class="hash-link" aria-label="Direct link to Recommended layout: two separate classifiers" title="Direct link to Recommended layout: two separate classifiers" translate="no">​</a></h3>
<p>Create two classifiers in <code>local.d/statistic.conf</code>: one strictly binary (spam/ham), and a second one for other classes.</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/statistic.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 1) Binary classifier: spam/ham only (reuses existing data if you already have it)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">classifier &quot;bayes&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;bayes_binary&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tokenizer { name = &quot;osb&quot;; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;redis&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_tokens = 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_learns = 200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile { symbol = &quot;BAYES_HAM&quot;; spam = false; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile { symbol = &quot;BAYES_SPAM&quot;; spam = true; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  learn_condition = &#x27;return require(&quot;lua_bayes_learn&quot;).can_learn&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2) Multi-class classifier: additional categories (builds its own data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">classifier &quot;bayes&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;bayes_multi&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tokenizer { name = &quot;osb&quot;; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;redis&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_tokens = 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min_learns = 200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Define non-binary classes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile { symbol = &quot;BAYES_NEWSLETTER&quot;; class = &quot;newsletter&quot;; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile { symbol = &quot;BAYES_TRANSACTIONAL&quot;; class = &quot;transactional&quot;; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statfile { symbol = &quot;BAYES_PHISHING&quot;; class = &quot;phishing&quot;; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Optional:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # per_user = true;  # enable per-user multi-class stats if desired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  learn_condition = &#x27;return require(&quot;lua_bayes_learn&quot;).can_learn&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="learning">Learning<a href="#learning" class="hash-link" aria-label="Direct link to Learning" title="Direct link to Learning" translate="no">​</a></h3>
<ul>
<li class="">Binary classifier (unchanged):</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_spam message.eml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_ham message.eml</span><br></span></code></pre></div></div>
<ul>
<li class="">Multi-class classifier (new command format):</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_class:newsletter newsletter.eml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rspamc learn_class:transactional order_confirmation.eml</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="backwards-compatibility-existing-bayes-database">Backwards compatibility (existing Bayes database)<a href="#backwards-compatibility-existing-bayes-database" class="hash-link" aria-label="Direct link to Backwards compatibility (existing Bayes database)" title="Direct link to Backwards compatibility (existing Bayes database)" translate="no">​</a></h3>
<ul>
<li class="">If you already have Bayes data for spam/ham in Redis, keep your existing binary classifier section intact (same symbols, same backend parameters). No relearning is needed for spam/ham.</li>
<li class="">Add the new <code>bayes_multi</code> classifier alongside it as shown above. It will build its own database independently from the binary classifier.</li>
<li class="">Avoid changing symbol names or backend addressing for the binary classifier to ensure it continues using the old database.</li>
</ul>
<p>See the Migration notes for 3.13.0 for a concise upgrade checklist.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="classifier-and-headers">Classifier and headers<a href="#classifier-and-headers" class="hash-link" aria-label="Direct link to Classifier and headers" title="Direct link to Classifier and headers" translate="no">​</a></h3>
<p>The classifier in Rspamd learns headers that are specifically defined in the <code>classify_headers</code> section of the <code>options.inc </code>file. Therefore, there is no need to remove any additional headers (e.g., X-Spam) before the learning process, as these headers will not be utilized for classification purposes. Rspamd also takes into account the <code>Subject</code> header, which is tokenized according to the aforementioned rules. Additionally, Rspamd considers various meta-tokens, such as message size or the number of attachments, which are extracted from the messages for further analysis.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="redis-statistics">Redis statistics<a href="#redis-statistics" class="hash-link" aria-label="Direct link to Redis statistics" title="Direct link to Redis statistics" translate="no">​</a></h2>
<p>Supported parameters for the Redis backend are:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="required-parameters">Required parameters<a href="#required-parameters" class="hash-link" aria-label="Direct link to Required parameters" title="Direct link to Required parameters" translate="no">​</a></h3>
<ul>
<li class=""><code>name</code>: Unique name of the classifier. Must be set when multiple classifiers are defined; otherwise, optional.</li>
<li class=""><code>tokenizer</code>: Currently, only OSB is supported. Must be set as shown in the default configuration.</li>
<li class=""><code>new_schema</code>: Must be set to <code>true</code>.</li>
<li class=""><code>backend</code>: Must be set to <code>&quot;redis&quot;</code>.</li>
<li class=""><code>learn_condition</code>: Lua function that verifies that learning is needed. The default function <strong>must</strong> be set if you have not written your own. Omitting <code>learn_condition</code> from <code>statistic.conf</code> will lead to losing protection from overlearning.</li>
<li class=""><code>servers</code>: IP or hostname with a port for the Redis server. Use an IP for the loopback interface if you have defined localhost in /etc/hosts for IPv4 and IPv6, or your Redis server will not be found!</li>
<li class=""><code>min_tokens</code>: Minimum number of words required for statistics processing.</li>
<li class=""><code>statfile</code>: Defines keys for spam and ham mails.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="optional-parameters">Optional parameters<a href="#optional-parameters" class="hash-link" aria-label="Direct link to Optional parameters" title="Direct link to Optional parameters" translate="no">​</a></h3>
<ul>
<li class="">
<p><code>write_servers</code>: For write-only Redis servers (usually masters).</p>
</li>
<li class="">
<p><code>read_servers</code>: For read-only Redis servers (usually replicas).</p>
</li>
<li class="">
<p><code>password</code>: Password for the Redis server.</p>
</li>
<li class="">
<p><code>db</code>: Database to use, <strong>must be a non-negative integer</strong> (though it is recommended to use dedicated Redis instances and not databases in Redis).</p>
</li>
<li class="">
<p><code>min_learns</code>: Minimum learn to count for <strong>both</strong> spam and ham classes to perform classification.</p>
</li>
<li class="">
<p><strong><code>autolearn {}</code></strong>: This section defines the behavior of automatic learning for spam and ham messages based on specific thresholds and balance settings. It includes the following options:</p>
<ul>
<li class=""><code>spam_threshold</code> (No default value): Specifies the score threshold above which a message is considered spam and is eligible for automatic spam learning. If a message’s score exceeds this threshold, it will be learned as spam. If not set, autolearning for spam will depend on the verdict of the message.</li>
<li class=""><code>ham_threshold</code> (No default value): Specifies the score threshold below which a message is considered ham and is eligible for automatic ham learning. If a message’s score is below this threshold, it will be learned as ham. If not set, autolearning for ham will depend on the verdict of the message.</li>
<li class=""><code>check_balance</code> (Default: <code>true</code>): Enables checking of the balance between spam and ham learns. If the balance is too skewed, learning will be skipped based on the ratio defined by <code>min_balance</code>.</li>
<li class=""><code>min_balance</code> (Default: <code>0.9</code>): Ensures balance between spam and ham learns. If the ratio of spam learns to ham learns (or vice versa) exceeds <code>1 / min_balance</code>, learning for the more frequent type is skipped until the other type catches up. For example, with the default value of <code>0.9</code>, learning is skipped if one type exceeds the other by a ratio of approximately <code>1.11</code> (1/0.9). This helps prevent bias in the learning process.</li>
</ul>
<p>For further details, see the <a href="#autolearning" class="">Autolearning section</a>.</p>
</li>
<li class="">
<p><code>per_user</code>: For more details, see the Per-user statistics section.</p>
</li>
<li class="">
<p><code>cache_prefix</code>: Prefix used to create keys where to store hashes of already learned IDs, defaults to <code>&quot;learned_ids&quot;</code>.</p>
</li>
<li class="">
<p><code>cache_max_elt</code>: Amount of elements to store in one <code>learned_ids</code> key.</p>
</li>
<li class="">
<p><code>cache_max_keys</code>: Amount of <code>learned_ids</code> keys to store.</p>
</li>
<li class="">
<p><code>cache_elt_len</code>: Length of hash to store in one element of <code>learned_ids</code>.</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="autolearning">Autolearning<a href="#autolearning" class="hash-link" aria-label="Direct link to Autolearning" title="Direct link to Autolearning" translate="no">​</a></h2>
<p>Starting from version 1.1, Rspamd introduces autolearning functionality for statfiles. Autolearning occurs after all rules, including statistics, have been processed. However, it only applies if the same symbol has not already been added. For example, if <code>BAYES_SPAM</code> is already present in the checking results, the message will not be learned as spam.</p>
<p>There are three options available for specifying autolearning:</p>
<ul>
<li class=""><code>autolearn = true</code>: autolearning is performing as spam if a message has <code>reject</code> action and as ham if a message has <strong>negative</strong> score</li>
<li class=""><code>autolearn = [-5, 5]</code>: autolearn as ham if the score is less than <code>-5</code> and as spam if the score is more than <code>5</code></li>
<li class=""><code>autolearn = &quot;return function(task) ... end&quot;</code>: use the following Lua function to detect if autolearn is needed (function should return &#x27;ham&#x27; if learn as ham is needed and string &#x27;spam&#x27; if learn as spam is needed, if no learning is needed then a function can return anything including <code>nil</code>)</li>
</ul>
<p>Redis backend is highly recommended for autolearning purposes due to its ability to handle high concurrency levels when multiple writers are synchronized properly. Using Redis as the backend ensures efficient and reliable autolearning functionality.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="per-user-statistics">Per-user statistics<a href="#per-user-statistics" class="hash-link" aria-label="Direct link to Per-user statistics" title="Direct link to Per-user statistics" translate="no">​</a></h3>
<p>To enable per-user statistics, you can add the <code>per_user = true</code> property to the configuration of the classifier. However, it is <em>important</em> to ensure that Rspamd is called at the final delivery stage (e.g., LDA mode) to avoid issues with multi-recipient messages. When dealing with multi-recipient messages, Rspamd will use the first recipient for user-based statistics.</p>
<p>Rspamd prioritizes SMTP recipients over MIME ones and gives preference to the special LDA header called <code>Delivered-To</code>, which can be appended using the <code>-d</code> option for <code>rspamc</code>. This allows for more accurate per-user statistics in your configuration.</p>
<p>You can change per-user statistics to per-domain (or any other) by utilizing a Lua function. The function should return the user as a string or <code>nil</code> as a fallback. For example:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">per_user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">EOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> rcpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_recipients</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;any&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> rcpt </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> first_rcpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rcpt</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">if</span><span class="token plain"> first_rcpt</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;domain&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> first_rcpt</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;domain&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOD</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="sharding">Sharding<a href="#sharding" class="hash-link" aria-label="Direct link to Sharding" title="Direct link to Sharding" translate="no">​</a></h4>
<p>Starting from version 3.9, per-user statistics can be sharded across different Redis servers using the <a class="" href="/docs.rspamd.com/branches/master/configuration/upstream#hash-algorithm">hash algorithm</a>.</p>
<p>Example of using two stand-alone master shards without read replicas:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">servers = &quot;hash:bayes-peruser-0-master,bayes-peruser-1-master&quot;;</span><br></span></code></pre></div></div>
<p>Example of using a setup with three master-replica shards:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">write_servers = &quot;hash:bayes-peruser-0-master,bayes-peruser-1-master,bayes-peruser-2-master&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_servers = &quot;hash:bayes-peruser-0-replica,bayes-peruser-1-replica,bayes-peruser-2-replica&quot;;</span><br></span></code></pre></div></div>
<p>Important notes:</p>
<ol>
<li class="">Changing the shard count requires dropping all Bayes statistics, so please make decisions wisely.</li>
<li class="">Each replica should have the same position in <code>read_servers</code> as its master in <code>write_servers</code>; otherwise, this will result in misaligned read-write hash slot assignments.</li>
<li class="">You can&#x27;t use more than one replica per master in a sharded setup; this will result in misaligned read-write hash slot assignments.</li>
<li class="">Redis Sentinel cannot be used for a sharded setup.</li>
<li class="">In the controller, you will see incorrect <code>Bayesian statistics</code> for the count of learns and users.</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/configuration/statistic.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/master/configuration/selectors"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Selectors</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/master/configuration/redis"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Redis configuration</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#statistics-architecture" class="table-of-contents__link toc-highlight">Statistics Architecture</a></li><li><a href="#statistics-configuration" class="table-of-contents__link toc-highlight">Statistics Configuration</a></li><li><a href="#multi-class-bayes-313" class="table-of-contents__link toc-highlight">Multi-class Bayes (3.13+)</a><ul><li><a href="#configuration-model-and-incompatibilities" class="table-of-contents__link toc-highlight">Configuration model and incompatibilities</a></li><li><a href="#recommended-layout-two-separate-classifiers" class="table-of-contents__link toc-highlight">Recommended layout: two separate classifiers</a></li><li><a href="#learning" class="table-of-contents__link toc-highlight">Learning</a></li><li><a href="#backwards-compatibility-existing-bayes-database" class="table-of-contents__link toc-highlight">Backwards compatibility (existing Bayes database)</a></li><li><a href="#classifier-and-headers" class="table-of-contents__link toc-highlight">Classifier and headers</a></li></ul></li><li><a href="#redis-statistics" class="table-of-contents__link toc-highlight">Redis statistics</a><ul><li><a href="#required-parameters" class="table-of-contents__link toc-highlight">Required parameters</a></li><li><a href="#optional-parameters" class="table-of-contents__link toc-highlight">Optional parameters</a></li></ul></li><li><a href="#autolearning" class="table-of-contents__link toc-highlight">Autolearning</a><ul><li><a href="#per-user-statistics" class="table-of-contents__link toc-highlight">Per-user statistics</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog">Blog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Subscribe</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/rss/changelog.xml">Changelog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/rss.xml">Blog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/atom.xml">Blog Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>