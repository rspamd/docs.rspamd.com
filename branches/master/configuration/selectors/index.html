<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-configuration/selectors" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Selectors | Rspamd Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rspamd.com/docs.rspamd.com/branches/master/configuration/selectors"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ru"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Selectors | Rspamd Documentation"><meta data-rh="true" name="description" content="Rspamd selectors is a Lua framework that allows functional extraction and processing of data from messages."><meta data-rh="true" property="og:description" content="Rspamd selectors is a Lua framework that allows functional extraction and processing of data from messages."><link data-rh="true" rel="icon" href="/docs.rspamd.com/branches/master/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/selectors"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/selectors" hreflang="en"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/ru/configuration/selectors" hreflang="ru"><link data-rh="true" rel="alternate" href="https://rspamd.com/docs.rspamd.com/branches/master/configuration/selectors" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Configuration","item":"https://rspamd.com/docs.rspamd.com/branches/master/configuration/"},{"@type":"ListItem","position":2,"name":"Selectors","item":"https://rspamd.com/docs.rspamd.com/branches/master/configuration/selectors"}]}</script><link rel="alternate" type="application/rss+xml" href="/docs.rspamd.com/branches/master/blog/rss.xml" title="Rspamd Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.rspamd.com/branches/master/blog/atom.xml" title="Rspamd Blog Atom Feed">




<script>window.SEARCH_BACKEND_CONFIG={endpoint:"/api"}</script>

<link rel="alternate" type="application/rss+xml" title="Rspamd Changelog RSS" href="/rss/changelog.xml">
<link rel="alternate" type="application/rss+xml" title="Rspamd Blog RSS" href="/blog/rss.xml">
<link rel="alternate" type="application/atom+xml" title="Rspamd Blog Atom" href="/blog/atom.xml"><link rel="stylesheet" href="/docs.rspamd.com/branches/master/assets/css/styles.10e2e935.css">
<script src="/docs.rspamd.com/branches/master/assets/js/runtime~main.f494d69a.js" defer="defer"></script>
<script src="/docs.rspamd.com/branches/master/assets/js/main.1373e0e0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png"><link rel="preload" as="image" href="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="theme-announcement-bar announcementBar_mb4j" style="background-color:#fee2e2;color:#991b1b" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⚠️ <strong>URGENT: Service Disruption Notice</strong> - Rspamd public fuzzy service and DNSBL RBL feed were temporarily suspended on Oct 18, 2025 due to hosting provider issues. <a href="/blog/2025/10/18/incident-disclosure" style="text-decoration: underline;">Read full incident disclosure</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.rspamd.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_black.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs.rspamd.com/branches/master/img/rspamd_logo_navbar.png" alt="Rspamd Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/about/">About</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/tutorials/">Tutorials</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/modules/">Modules</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/other/usage_policy">Usage Policy</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/support">Support</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.rspamd.com/branches/master/downloads">Downloads</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/blog">Blog</a><a class="navbar__item navbar__link" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div><div class="elasticsearch-search-container"><form class="elasticsearch-search-form"><div class="elasticsearch-search-input-container"><input type="text" placeholder="Search documentation..." class="elasticsearch-search-input" aria-label="Search documentation" value=""><div class="elasticsearch-search-shortcut"><span>⌘K</span></div></div></form></div></div><div class="navbar__item"><div id="font-size-control-mount"></div></div><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/"><span title="About Rspamd" class="linkLabel_WmDU">About Rspamd</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/getting-started/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/tutorials/migration"><span title="How-To Guides" class="categoryLinkLabel_W154">How-To Guides</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/faq"><span title="Frequently asked questions" class="linkLabel_WmDU">Frequently asked questions</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/about/"><span title="About" class="categoryLinkLabel_W154">About</span></a><button aria-label="Expand sidebar category &#x27;About&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/support"><span title="Rspamd Support" class="linkLabel_WmDU">Rspamd Support</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/downloads"><span title="Downloads" class="linkLabel_WmDU">Downloads</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs.rspamd.com/branches/master/configuration/"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a><button aria-label="Collapse sidebar category &#x27;Configuration&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/settings"><span title="User settings" class="linkLabel_WmDU">User settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/metrics"><span title="Actions and scores" class="linkLabel_WmDU">Actions and scores</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/logging"><span title="Logging settings" class="linkLabel_WmDU">Logging settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/options"><span title="Common options" class="linkLabel_WmDU">Common options</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/composites"><span title="Composite symbols" class="linkLabel_WmDU">Composite symbols</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/maps"><span title="Rspamd maps" class="linkLabel_WmDU">Rspamd maps</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/selectors"><span title="Selectors" class="linkLabel_WmDU">Selectors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/statistic"><span title="Statistics settings" class="linkLabel_WmDU">Statistics settings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/redis"><span title="Redis configuration" class="linkLabel_WmDU">Redis configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/upstream"><span title="Upstreams configuration" class="linkLabel_WmDU">Upstreams configuration</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs.rspamd.com/branches/master/configuration/ucl"><span title="Universal configuration language (UCL)" class="linkLabel_WmDU">Universal configuration language (UCL)</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/workers/"><span title="Workers" class="categoryLinkLabel_W154">Workers</span></a><button aria-label="Expand sidebar category &#x27;Workers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/modules/"><span title="Modules" class="categoryLinkLabel_W154">Modules</span></a><button aria-label="Expand sidebar category &#x27;Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/lua/"><span title="Lua API" class="categoryLinkLabel_W154">Lua API</span></a><button aria-label="Expand sidebar category &#x27;Lua API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs.rspamd.com/branches/master/developers/architecture"><span title="Developers" class="categoryLinkLabel_W154">Developers</span></a><button aria-label="Expand sidebar category &#x27;Developers&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs.rspamd.com/branches/master/other/rspamadm"><span title="Other" class="categoryLinkLabel_W154">Other</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs.rspamd.com/branches/master/blog"><span title="Blog" class="linkLabel_WmDU">Blog</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs.rspamd.com/branches/master/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs.rspamd.com/branches/master/configuration/"><span>Configuration</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Selectors</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Rspamd selectors settings</h1></header>
<p>Rspamd selectors is a Lua framework that allows functional extraction and processing of data from messages.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<center><img decoding="async" loading="lazy" class="img-fluid img_ev3q" src="/img/selectors.png" width="50%"></center>
<p>Starting from version 1.8, Rspamd introduces a framework designed for data extraction from messages and its subsequent utilization in plugins via transform functions. This functionality allows for a variety of operations. For instance, you can retrieve the SMTP from address and convert it to lowercase using the following selector:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtp_from.lower</span><br></span></code></pre></div></div>
<p>Similarly, you can obtain a lowercased digest of the subject and then truncate it to 16 hexadecimal characters:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">header(&#x27;Subject&#x27;).lower.digest(&#x27;hex&#x27;).substring(1, 16)</span><br></span></code></pre></div></div>
<p>Additionally, you have the capability to work with lists, such as lists of URLs:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">urls:get_tld</span><br></span></code></pre></div></div>
<p>Afterwards, these values can be used in various plugins:</p>
<ul>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/modules/multimap"><code>multimap</code></a> - map type equal to <code>selector</code></li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/modules/ratelimit"><code>ratelimit</code></a> - rate bucket description with <code>selector</code> field</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/modules/reputation"><code>reputation</code></a> - generic selector rules</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/modules/regexp"><code>regexp</code></a> - regular expressions based on selector&#x27;s data</li>
<li class=""><a class="" href="/docs.rspamd.com/branches/master/modules/rbl"><code>rbl</code></a> - allows selectors in data queries</li>
<li class="">[<code>clustering</code>] - TBD</li>
</ul>
<p>Here is an example of Rspamd multimap rule that uses selectors to block bad Sendgrid senders using <a href="https://www.invaluement.com/serviceproviderdnsbl/" target="_blank" rel="noopener noreferrer" class="">Invaluement SPBL</a>:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># local.d/multimap.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INVALUEMENT_SENDGRID_ID {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;selector&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector = &#x27;header(&quot;X-SG-EID&quot;).id;from(&quot;smtp&quot;,&quot;orig&quot;).regexp(&quot;/^&lt;?bounces\+(\d+)\-[^@]+@/i&quot;).last&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;https://www.invaluement.com/spdata/sendgrid-id-dnsbl.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 6.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INVALUEMENT_SENDGRID_DOMAIN {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;selector&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map = &quot;https://www.invaluement.com/spdata/sendgrid-envelopefromdomain-dnsbl.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector = &#x27;header(&quot;X-SG-EID&quot;).id;from(&quot;smtp&quot;,&quot;orig&quot;):domain.get_tld&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 6.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>As evident from this rule, it skillfully employs a combination of map expressions and selectors to retrieve and modify data for queries within maps.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="selectors-syntax">Selectors syntax<a href="#selectors-syntax" class="hash-link" aria-label="Direct link to Selectors syntax" title="Direct link to Selectors syntax" translate="no">​</a></h2>
<p>A selector typically consists of two key components:</p>
<ol>
<li class="">Data identification (such as <code>header</code> or <code>urls</code>)</li>
<li class="">An optional data transformation method, separated by a colon (<code>:</code>)</li>
<li class="">A transformation pipeline, where multiple functions are linked with dot operators (<code>.</code>)</li>
</ol>
<p>Additionally, you can merge several selectors by using a semicolon (<code>;</code>) as a delimiter:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtp_from.addr.lower;ip.addr</span><br></span></code></pre></div></div>
<p>Both the data identification and transformation functions allow the use of arguments separated by commas. To simplify escaping, single and double quotation marks are supported:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">header(&#x27;Subject&#x27;).regexp(&quot;^A-Z{10,}.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header(&#x27;Subject&#x27;).regexp(&quot;^A-Z{10,}\&quot;&#x27;.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">header(&#x27;Subject&#x27;).regexp(&#x27;^A-Z{10,}&quot;\&#x27;.*&#x27;)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="operators--vs--order-matters">Operators: &#x27;:&#x27; vs &#x27;.&#x27; (order matters)<a href="#operators--vs--order-matters" class="hash-link" aria-label="Direct link to Operators: &#x27;:&#x27; vs &#x27;.&#x27; (order matters)" title="Direct link to Operators: &#x27;:&#x27; vs &#x27;.&#x27; (order matters)" translate="no">​</a></h3>
<p>A selector has a strict order of parts:</p>
<ul>
<li class="">extractor [: method]</li>
<li class="">[. transform] [. transform] ...</li>
</ul>
<p>Key rules:</p>
<ul>
<li class=""><strong><code>:</code> (method) goes immediately after the extractor and can appear at most once.</strong> It is used to access a field on a table or call a method on a userdata object returned by the extractor. If the extractor returns a list, the method is applied element-wise.</li>
<li class=""><strong><code>.</code> (transform) chains after that</strong> and applies selector transforms (e.g. <code>lower</code>, <code>first</code>, <code>regexp</code>, ...). Transforms generally work on simple types (<code>string</code>, <code>string_list</code>) and many are also mapped over lists.</li>
<li class=""><strong>You cannot place <code>:</code> after you started <code>.</code> transforms.</strong> The grammar allows the optional method only right after the extractor.</li>
<li class=""><strong>Names after <code>:</code> must be object fields/methods, not transforms.</strong> Typical examples: <code>from:addr</code>, <code>from(&#x27;mime&#x27;):name</code>, <code>urls:get_tld</code>, <code>ip:to_string</code>.</li>
</ul>
<p>Examples:</p>
<ul>
<li class="">Works: <code>from:addr.lower</code> — take MIME/SMTP From object, get its <code>addr</code> field, then lowercase it.</li>
<li class="">Works: <code>rcpts:domain.first</code> — take list of recipients, get <code>domain</code> for each, then take the first domain.</li>
<li class="">Does NOT work: <code>rcpts:first.domain</code> — <code>first</code> is a transform (not a method), and <code>domain</code> is a method (not a transform). Also, <code>:</code> can only appear right after the extractor.</li>
<li class="">Does NOT work: <code>from.lower:addr</code> — place the method before transforms: <code>from:addr.lower</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-transformation-method">Data transformation method<a href="#data-transformation-method" class="hash-link" aria-label="Direct link to Data transformation method" title="Direct link to Data transformation method" translate="no">​</a></h3>
<p>Certain data extractors yield intricate objects or lists of such objects, including:</p>
<ul>
<li class="">table</li>
<li class="">userdata (Lua object)</li>
</ul>
<p>To convert these complex entities into simpler ones (strings or string lists), there are two approaches: implicit conversion and employing the method or table key extraction.</p>
<ol>
<li class="">
<p>For objects, implicit conversion involves invoking the <code>tostring</code> function, while the method call is straightforward. The following are equivalent: <code>ip:to_string.lower</code> and <code>ip.lower</code>. Nevertheless, different methods of the objects can be called: <code>urls:get_tld</code> will return a list of strings containing all eSLD parts of URLs in the message. An exception to this rule (starting from 2.7) is <code>rspamd_text</code>, which can be traversed within the selector pipeline without any conversion. This exemption aims to retain large strings to prevent Lua string interning and excessive allocation.</p>
</li>
<li class="">
<p>For tables, explicit conversion simply extracts the specified key, such as <code>from:addr</code> or <code>from(&#x27;mime&#x27;):name</code>. Implicit conversion is slightly more intricate:</p>
<ul>
<li class="">If the table contains a field named <code>value</code>, it is used for implicit conversion.</li>
<li class="">If not, and there is a field named <code>addr</code> in the table, it is used for implicit conversion.</li>
<li class="">If neither of the above conditions are met, <code>table.concat(t, &#x27; &#x27;)</code> is used for implicit conversion.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="null-values">Null values<a href="#null-values" class="hash-link" aria-label="Direct link to Null values" title="Direct link to Null values" translate="no">​</a></h3>
<p>If a data transformation function or <strong>any</strong> transform function returns <code>nil</code>, the selector is entirely disregarded. This characteristic is employed in functions like <code>in</code> and <code>not_in</code>. An illustrative configuration for the <code>ratelimit</code> module that combines the <code>in</code> transformation with <code>id</code> to exclude the original string is as follows:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user_workdays </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user.lower;time(&#x27;connect&#x27;, &#x27;!%w&#x27;).in(1, 2, 3, 4, 5).id(&#x27;work&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10 / 1m&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user_weekends </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user.lower;time(&#x27;connect&#x27;, &#x27;!%w&#x27;).in(6, 7).id(&#x27;weekends&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1 / 1m&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>In this example, during weekends, the <code>user_workdays</code> selector will be entirely disregarded, and conversely, during working days, the <code>user_weekends</code> selector will not be utilized.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="selectors-combinations">Selectors combinations<a href="#selectors-combinations" class="hash-link" aria-label="Direct link to Selectors combinations" title="Direct link to Selectors combinations" translate="no">​</a></h2>
<p>In the previous example, the selector comprised multiple components:</p>
<ul>
<li class=""><code>user.lower</code> - extracts the authenticated username and converts it to lowercase</li>
<li class=""><code>time(&#x27;connect&#x27;, &#x27;!%w&#x27;).in(6, 7).id(&#x27;weekends&#x27;)</code> - if the connection time falls within the specified range, it returns the string &#x27;weekends&#x27;</li>
</ul>
<p>These two elements are separated by the <code>;</code> symbol. Modules will utilize these elements as a concatenated string, for instance, <code>user@example.com:weekends</code> (the <code>:</code> symbol serves as a separator and is employed by the ratelimit module).</p>
<p>However, what if you want to achieve the same functionality for, let&#x27;s say, recipients:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rcpt_weekends </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rcpts.take_n(5).lower;time(&#x27;connect&#x27;, &#x27;!%w&#x27;).in(6, 7).id(&#x27;weekends&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1 / 1m&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>In this instance, we&#x27;re taking up to <code>5</code> recipients, extracting the address part, converting it to lowercase, and combining it with the string <code>weekends</code> if the condition is met. When a list of elements is concatenated with a string, this string is appended (or prepended) to each element of the list, resulting in the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rcpt1:weekends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt2:weekends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt3:weekends</span><br></span></code></pre></div></div>
<p>It also works if you want to add a prefix and a suffix:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rcpt_weekends </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id(&#x27;rcpt&#x27;);rcpts:addr.take_n(5).lower;time(&#x27;connect&#x27;, &#x27;!%w&#x27;).in(6, 7).id(&#x27;weekends&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1 / 1m&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This configuration will be transformed into:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt1:weekends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt2:weekends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt3:weekends</span><br></span></code></pre></div></div>
<p>However, combining lists with different numbers of entries is not recommended – in this case, the shortest of the lists will be used:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;rcpt&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">rcpts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">take_n</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><br></span></code></pre></div></div>
<p>This will result in a list that might have up to 5 elements and will be concatenated with the prefix:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt1:example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt2:example2.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt:rcpt3:example3.com</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-definition-functions">Data definition functions<a href="#data-definition-functions" class="hash-link" aria-label="Direct link to Data definition functions" title="Direct link to Data definition functions" translate="no">​</a></h2>
<p>The data definition part specifies what needs to be extracted. Here is the list of methods currently supported by Rspamd:</p>















































































































































































<table><thead><tr><th style="text-align:left">Extraction method</th><th style="text-align:center">Version</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>asn</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get AS number (ASN module must be executed first)</td></tr><tr><td style="text-align:left"><code>attachments</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get list of all attachments digests</td></tr><tr><td style="text-align:left"><code>country</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get country (ASN module must be executed first)</td></tr><tr><td style="text-align:left"><code>digest</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get content digest</td></tr><tr><td style="text-align:left"><code>emails</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get list of all emails. If no arguments specified, returns list of url objects. Otherwise, calls a specific method, e.g. <code>get_user</code></td></tr><tr><td style="text-align:left"><code>files</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get all attachments files</td></tr><tr><td style="text-align:left"><code>from</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get MIME or SMTP from (e.g. <code>from(&#x27;smtp&#x27;)</code> or <code>from(&#x27;mime&#x27;)</code>, uses any type by default)</td></tr><tr><td style="text-align:left"><code>header</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get header with the name that is expected as an argument. The optional second argument accepts list of flags:{::nomarkdown}<ul><li class=""><code>full</code>: returns all headers with this name with all data (like task:get_header_full())</li><li class=""><code>strong</code>: use case sensitive match when matching header&#x27;s name</li></ul>{:/}</td></tr><tr><td style="text-align:left"><code>helo</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get helo value</td></tr><tr><td style="text-align:left"><code>id</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Return value from function&#x27;s argument or an empty string, For example, <code>id(&#x27;Something&#x27;)</code> returns a string &#x27;Something&#x27;</td></tr><tr><td style="text-align:left"><code>ip</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get source IP address</td></tr><tr><td style="text-align:left"><code>languages</code></td><td style="text-align:center">1.9+</td><td style="text-align:left">Get languages met in a message</td></tr><tr><td style="text-align:left"><code>list</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Returns a list of values from its arguments or an empty list</td></tr><tr><td style="text-align:left"><code>messageid</code></td><td style="text-align:center">2.6+</td><td style="text-align:left">Get message ID</td></tr><tr><td style="text-align:left"><code>pool_var</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get specific pool var. The first argument must be variable name, the second argument is optional and defines the type (string by default)</td></tr><tr><td style="text-align:left"><code>queueid</code></td><td style="text-align:center">2.6+</td><td style="text-align:left">Get queue ID</td></tr><tr><td style="text-align:left"><code>rcpts</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get MIME or SMTP rcpts (e.g. <code>rcpts(&#x27;smtp&#x27;)</code> or <code>rcpts(&#x27;mime&#x27;)</code>, uses any type by default)</td></tr><tr><td style="text-align:left"><code>received</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get list of received headers. If no arguments specified, returns list of tables. Otherwise, selects a specific element, e.g. <code>by_hostname</code></td></tr><tr><td style="text-align:left"><code>request_header</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get specific HTTP request header. The first argument must be header name.</td></tr><tr><td style="text-align:left"><code>symbol</code></td><td style="text-align:center">2.6+</td><td style="text-align:left">Get symbol with the name that is expected as first argument. Returns the symbol table (like task:get_symbol())</td></tr><tr><td style="text-align:left"><code>time</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get task timestamp. The first argument is type:{::nomarkdown}<ul><li class=""><code>connect</code>: connection timestamp (default)</li><li class=""><code>message</code>: timestamp as defined by <code>Date</code> header</li></ul>{:/}The second argument is optional time format, see <a href="https://web.archive.org/web/20231130145520/https://pgl.yoyo.org/luai/i/os.date" target="_blank" rel="noopener noreferrer" class="">os.date</a> description</td></tr><tr><td style="text-align:left"><code>to</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get principal recipient</td></tr><tr><td style="text-align:left"><code>uid</code></td><td style="text-align:center">2.6+</td><td style="text-align:left">Get ID of the task being processed</td></tr><tr><td style="text-align:left"><code>urls</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get list of all urls. If no arguments specified, returns list of url objects. Otherwise, calls a specific method, e.g. <code>get_tld</code></td></tr><tr><td style="text-align:left"><code>user</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Get authenticated user name</td></tr><tr><td style="text-align:left"><code>specific_urls</code></td><td style="text-align:center">—</td><td style="text-align:left">Get most specific URLs; accepts options (e.g. <code>limit</code>, <code>need_content</code>, <code>exclude_flags</code>)</td></tr><tr><td style="text-align:left"><code>specific_urls_filter_map</code></td><td style="text-align:center">—</td><td style="text-align:left">Get most specific URLs filtered by a named map (from <code>lua_selectors.maps</code>)</td></tr><tr><td style="text-align:left"><code>urls_filtered</code></td><td style="text-align:center">—</td><td style="text-align:left">Get URLs filtered by flags include/exclude</td></tr><tr><td style="text-align:left"><code>words</code></td><td style="text-align:center">—</td><td style="text-align:left">Get words from text parts (<code>stem</code>, <code>raw</code>, <code>norm</code>, <code>full</code>)</td></tr><tr><td style="text-align:left"><code>task_cache</code></td><td style="text-align:center">—</td><td style="text-align:left">Get value by key from task cache</td></tr><tr><td style="text-align:left"><code>scan_result</code></td><td style="text-align:center">—</td><td style="text-align:left">Get full scan result table (default or shadow)</td></tr><tr><td style="text-align:left"><code>metatokens</code></td><td style="text-align:center">—</td><td style="text-align:left">Get metatokens for a message as strings</td></tr><tr><td style="text-align:left"><code>rspamd_hostname</code></td><td style="text-align:center">—</td><td style="text-align:left">Get hostname of the filter server</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="transformation-functions">Transformation functions<a href="#transformation-functions" class="hash-link" aria-label="Direct link to Transformation functions" title="Direct link to Transformation functions" translate="no">​</a></h2>

















































































































































































































<table><thead><tr><th style="text-align:left">Transform method</th><th style="text-align:center">Version</th><th style="text-align:left">Description</th><th style="text-align:left">Example</th></tr></thead><tbody><tr><td style="text-align:left"><code>append</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Appends a string or a strings list</td><td style="text-align:left"><code>from:addr.append(&#x27;:tag&#x27;)</code></td></tr><tr><td style="text-align:left"><code>apply_map</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Returns a value from a named map or nil</td><td style="text-align:left"><code>id(&#x27;key&#x27;).apply_map(test_map)</code></td></tr><tr><td style="text-align:left"><code>digest</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Create a digest from a string</td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).digest(&#x27;hex&#x27;,&#x27;sha256&#x27;)</code></td></tr><tr><td style="text-align:left"><code>drop_n</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Returns list without the first n elements</td><td style="text-align:left"><code>rcpts:addr.drop_n(1)</code></td></tr><tr><td style="text-align:left"><code>equal</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Boolean equal; returns input or nil</td><td style="text-align:left"><code>user.equal(&#x27;postmaster&#x27;)</code></td></tr><tr><td style="text-align:left"><code>filter_map</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Keep input if it exists in map</td><td style="text-align:left"><code>id(&#x27;key&#x27;).filter_map(test_map)</code></td></tr><tr><td style="text-align:left"><code>first</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Returns the first element of a list</td><td style="text-align:left"><code>rcpts:addr.first</code></td></tr><tr><td style="text-align:left"><code>id</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Drop input, return arguments</td><td style="text-align:left"><code>time(&#x27;connect&#x27;,&#x27;!%w&#x27;).in(6,7).id(&#x27;weekends&#x27;)</code></td></tr><tr><td style="text-align:left"><code>in</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Keep input if it is in args</td><td style="text-align:left"><code>from:domain.in(&#x27;example.com&#x27;,&#x27;example.org&#x27;)</code></td></tr><tr><td style="text-align:left"><code>inverse</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Returns nil if input is non-empty</td><td style="text-align:left"><code>user.inverse(&#x27;nouser&#x27;)</code></td></tr><tr><td style="text-align:left"><code>ipmask</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Apply mask to IP (v4/v6)</td><td style="text-align:left"><code>ip.ipmask(24)</code></td></tr><tr><td style="text-align:left"><code>join</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Join strings with separator</td><td style="text-align:left"><code>rcpts:addr.take_n(3).join(&#x27;,&#x27;)</code></td></tr><tr><td style="text-align:left"><code>last</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Returns the last element of a list</td><td style="text-align:left"><code>rcpts:addr.last</code></td></tr><tr><td style="text-align:left"><code>lower</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Lowercase string</td><td style="text-align:left"><code>from:addr.lower</code></td></tr><tr><td style="text-align:left"><code>not_in</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Keep input if not in args</td><td style="text-align:left"><code>from:domain.not_in(&#x27;bad.com&#x27;)</code></td></tr><tr><td style="text-align:left"><code>nth</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Returns n-th element</td><td style="text-align:left"><code>rcpts:addr.nth(2)</code></td></tr><tr><td style="text-align:left"><code>prepend</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Prepend string(s)</td><td style="text-align:left"><code>from:addr.prepend(&#x27;sender:&#x27;)</code></td></tr><tr><td style="text-align:left"><code>regexp</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Regexp matching</td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).regexp(&#x27;/viagra/i&#x27;)</code></td></tr><tr><td style="text-align:left"><code>sort</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Sort strings lexicographically</td><td style="text-align:left"><code>rcpts:addr.sort</code></td></tr><tr><td style="text-align:left"><code>substring</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Extract substring</td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).substring(1,16)</code></td></tr><tr><td style="text-align:left"><code>take_n</code></td><td style="text-align:center">1.8+</td><td style="text-align:left">Take first n elements</td><td style="text-align:left"><code>rcpts:addr.take_n(5)</code></td></tr><tr><td style="text-align:left"><code>to_ascii</code></td><td style="text-align:center">2.6+</td><td style="text-align:left">Replace non-ASCII bytes</td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).to_ascii(&#x27;?&#x27;)</code></td></tr><tr><td style="text-align:left"><code>uniq</code></td><td style="text-align:center">2.0+</td><td style="text-align:left">Unique elements (hash-based)</td><td style="text-align:left"><code>urls:get_tld.uniq</code></td></tr><tr><td style="text-align:left"><code>lower_utf8</code></td><td style="text-align:center">—</td><td style="text-align:left">Lowercase UTF‑8 string</td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).lower_utf8</code></td></tr><tr><td style="text-align:left"><code>join_nth</code></td><td style="text-align:center">—</td><td style="text-align:left">Join by chunks of N</td><td style="text-align:left"><code>list(&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;).join_nth(2,&#x27;:&#x27;)</code></td></tr><tr><td style="text-align:left"><code>join_tables</code></td><td style="text-align:center">—</td><td style="text-align:left">Join list of tables into strings</td><td style="text-align:left"><code>header(&#x27;Received&#x27;,&#x27;full&#x27;).join_tables(&#x27; &#x27;)</code></td></tr><tr><td style="text-align:left"><code>get_tld</code></td><td style="text-align:center">—</td><td style="text-align:left">Extract eSLD from hostname string</td><td style="text-align:left"><code>rcpts:domain.get_tld</code></td></tr><tr><td style="text-align:left"><code>pack_numbers</code></td><td style="text-align:center">—</td><td style="text-align:left">Pack list of numbers into string</td><td style="text-align:left"><code>list(&#x27;10&#x27;,&#x27;20&#x27;).pack_numbers(&#x27;I&#x27;)</code></td></tr><tr><td style="text-align:left"><code>filter_string_nils</code></td><td style="text-align:center">—</td><td style="text-align:left">Remove &#x27;nil&#x27; strings from list</td><td style="text-align:left"><code>list(&#x27;a&#x27;,&#x27;nil&#x27;,&#x27;b&#x27;).filter_string_nils</code></td></tr><tr><td style="text-align:left"><code>apply_methods</code></td><td style="text-align:center">—</td><td style="text-align:left">Call methods on userdata; return results</td><td style="text-align:left"><code>urls.first.apply_methods(&#x27;get_tld&#x27;,&#x27;get_host&#x27;)</code></td></tr><tr><td style="text-align:left"><code>filter_method</code></td><td style="text-align:center">—</td><td style="text-align:left">Keep userdata where method is truthy</td><td style="text-align:left"><code>urls.filter_method(&#x27;is_redirected&#x27;)</code></td></tr><tr><td style="text-align:left"><code>except_map</code></td><td style="text-align:center">—</td><td style="text-align:left">Keep input if it is NOT in map</td><td style="text-align:left"><code>id(&#x27;key&#x27;).except_map(test_map)</code></td></tr><tr><td style="text-align:left"><code>match</code></td><td style="text-align:center">—</td><td style="text-align:left">Alias of <code>regexp</code></td><td style="text-align:left"><code>header(&#x27;Subject&#x27;).match(&#x27;/re/i&#x27;)</code></td></tr></tbody></table>
<p>You can access the latest list of all selector functions and also test Rspamd selector pipelines through the integrated Web Interface. This provides you with a convenient way to explore and experiment with Rspamd&#x27;s selector capabilities.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="maps-in-transformations">Maps in transformations<a href="#maps-in-transformations" class="hash-link" aria-label="Direct link to Maps in transformations" title="Direct link to Maps in transformations" translate="no">​</a></h3>
<p>Starting from version 2.0, Rspamd introduces support for using maps within selectors. This is achieved by incorporating maps into a designated <code>lua_selectors.maps</code> table or by using the helper <code>lua_selectors.add_map(name, map)</code>. The table should consist of name-value pairs where the <code>name</code> represents the symbolic name of the map, which can be employed in extraction or transformation functions, and the <code>value</code> is the output of <code>lua_maps.map_add_from_ucl</code>. To illustrate this concept:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> lua_selectors </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;lua_selectors&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> lua_maps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;lua_maps&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Either assign directly to the maps table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_selectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lua_maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map_add_from_ucl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;key value&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;key1 value1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;key3 value1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hash&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test selectors maps&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Or register via helper (equivalent)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_selectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;test_map2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lua_maps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map_add_from_ucl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;x 1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;y 2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;hash&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;another selectors map&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> samples </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;map filter&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id(&#x27;key&#x27;).filter_map(test_map)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;key&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;map apply&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id(&#x27;key&#x27;).apply_map(test_map)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;value&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;map filter list&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;list(&#x27;key&#x27;, &#x27;key1&#x27;, &#x27;key2&#x27;).filter_map(test_map)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;key&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;key1&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;map apply list&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;list(&#x27;key&#x27;, &#x27;key1&#x27;, &#x27;key2&#x27;, &#x27;key3&#x27;).apply_map(test_map)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;value&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;value1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;value1&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;map apply list uniq&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      selector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;list(&#x27;key&#x27;, &#x27;key1&#x27;, &#x27;key2&#x27;, &#x27;key3&#x27;).apply_map(test_map).uniq&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;value&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;value1&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Available map-aware transforms:</p>
<ul>
<li class=""><code>filter_map(map_name)</code> – keep input only if it exists in the named map</li>
<li class=""><code>apply_map(map_name)</code> – replace input with the corresponding map value</li>
<li class=""><code>except_map(map_name)</code> – keep input only if it does NOT exist in the named map</li>
</ul>
<p>Map-aware extractors:</p>
<ul>
<li class=""><code>specific_urls_filter_map(map_name, opts)</code> – extract most specific URLs filtered by the named map</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="type-safety">Type safety<a href="#type-safety" class="hash-link" aria-label="Direct link to Type safety" title="Direct link to Type safety" translate="no">​</a></h2>
<p>All selectors provide type safety controls. It means that Rspamd checks if types within pipeline match each other. For example, <code>rcpts</code> extractor returns a list of addresses, and <code>from</code> returns a single address. If you need to lowercase this address you need to convert it to a string as the first step. This could be done by getting a specific element of this address, e.g. <code>from.addr</code> -&gt; this returns a <code>string</code> (you could also get <code>from.name</code> to get a displayed name, for example). Each processor has its own list of the accepted types.</p>
<p>However, even when dealing with recipients, where <code>rcpt</code> generates a list of addresses, you can still employ the same pipeline, such as <code>rcpts.addr.lower</code>. This versatility is possible because many processors can be functionally applied like a map:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">elt1 -&gt; f(elt1) -&gt; elt1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elt2 -&gt; f(elt2) -&gt; elt2&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elt3 -&gt; f(elt3) -&gt; elt3&#x27;</span><br></span></code></pre></div></div>
<p>Hence, a list of elements of type <code>t</code> undergoes an element-wise transformation using processor <code>f</code>, creating a new list of type <code>t1</code> (which can be the same as <code>t</code>). The length of the resulting list remains unchanged.</p>
<p>To enhance convenience, the ultimate values can be implicitly converted to their string representation. This is particularly applicable to URLs, email addresses, and IP addresses, all of which can be seamlessly converted to strings.</p>
<p>In general, you need not be overly concerned about type safety unless you encounter actual type errors. This mechanism serves to safeguard the selectors framework from inadvertent user errors.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="common-pitfalls">Common pitfalls<a href="#common-pitfalls" class="hash-link" aria-label="Direct link to Common pitfalls" title="Direct link to Common pitfalls" translate="no">​</a></h2>
<ul>
<li class=""><strong>Mixing <code>:</code> and <code>.</code> order</strong>: <code>:</code> must be right after the extractor and only once. Use <code>rcpts:domain.first</code>, not <code>rcpts:first.domain</code>.</li>
<li class=""><strong>Calling methods as transforms (or vice versa)</strong>: <code>domain</code>, <code>addr</code>, <code>name</code>, <code>get_tld</code>, <code>to_string</code> are methods/fields (use with <code>:</code>). <code>first</code>, <code>last</code>, <code>lower</code>, <code>uniq</code>, <code>regexp</code> are transforms (use with <code>.</code>).</li>
<li class=""><strong>Forgetting to convert complex types</strong>: If you need a string, either use a method (<code>from:addr</code>) or rely on implicit conversion where applicable. Transforms generally expect strings or lists of strings.</li>
<li class=""><strong>List length mismatches when combining</strong>: When combining multiple list selectors with <code>;</code>, the shortest list determines the number of results (see examples above).</li>
<li class=""><strong>Nil semantics</strong>: If any step returns <code>nil</code>, the entire selector is ignored. Boolean-style transforms like <code>in</code>/<code>not_in</code> exploit this to include or exclude parts.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="own-selectors">Own selectors<a href="#own-selectors" class="hash-link" aria-label="Direct link to Own selectors" title="Direct link to Own selectors" translate="no">​</a></h2>
<p>You have the option to incorporate your custom extractors and processing functions. However, it&#x27;s crucial to implement this setup before utilizing these selectors in any other context. For instance, the execution of <code>rspamd.local.lua</code> precedes the initialization of plugins, making it a secure location to register your functions. Here is a small example about how to register your own extractors and processors.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:rgb(222, 71, 0)">local</span><span class="token plain"> lua_selectors </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> require </span><span class="token string" style="color:#e3116c">&quot;lua_selectors&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Import module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_selectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">register_extractor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get_something&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- mandatory field</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- result + type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Sample extractor&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_selectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">register_processor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;append_string&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  types </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;string&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- accepted types</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  process </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">..</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args </span><span class="token keyword" style="color:rgb(222, 71, 0)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- result + type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;string&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- can be used in map like invocation, always return &#x27;string&#x27; type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Adds all arguments to the input string&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List processor example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lua_selectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">register_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;take_second&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  types </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;list&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- accepted types</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  process </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:rgb(222, 71, 0)">return</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;^(.*)_list$&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- second element and list type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:rgb(222, 71, 0)">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  desctiption </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Returns the second element of the list&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>You can use these functions in your selectors subsequently.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="regular-expressions-selectors">Regular expressions selectors<a href="#regular-expressions-selectors" class="hash-link" aria-label="Direct link to Regular expressions selectors" title="Direct link to Regular expressions selectors" translate="no">​</a></h2>
<p>You can also leverage selectors with Rspamd&#x27;s <a class="" href="/docs.rspamd.com/branches/master/modules/regexp">regexp module</a>. This approach allows you to utilize the data extracted and processed by the selector framework to match it against various regular expressions.</p>
<p>To start, you&#x27;ll need to register a selector in the regexp module. You can achieve this by adding the following code to your <code>rspamd.local.lua</code> file:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_re_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;test&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;user.lower;header(Subject).lower&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The first argument denotes the symbolic name of the selector, which you will subsequently use to reference it in regular expression rules. The second argument entails the selector in the usual syntax. The last argument, which is optional, designates the character used to concatenate the different selector parts. In this manner, the selector generates a value by joining the authenticated user and the <code>Subject</code> header&#x27;s value using a space character.</p>
<p>Following this, you can refer to this selector in your regular expression rules. The order in which you use the selector&#x27;s name and its registration in the code doesn&#x27;t impact its functionality.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;regexp&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;TEST_SELECTOR_RE&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test=/user some subject/$&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100500</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The syntax for regular expressions involving selectors bears some resemblance to header regular expressions. You begin by stating the selector&#x27;s name, followed by <code>=</code> and the actual regular expression, concluded with <code>$</code> to signify the type. The omission of the <code>$</code> sign alerts Rspamd that you are specifying a header regular expression, rather than a selector-based one. It is essential to include this symbol to ensure clarity. Alternatively, you can utilize the extended syntax for the re type:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;regexp&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;TEST_SELECTOR_RE&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test=/user some subject/{selector}&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100500</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>If a selector yields multiple values, such as recipients, the corresponding regular expression will be matched against all the elements within that list. Consequently, it becomes crucial to incorporate the <code>one_shot</code> option to prevent inadvertent insertion of multiple symbols:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rspamd_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">register_re_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;test_rcpt&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;rcpts.addr.lower;header(Subject).lower&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;regexp&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;TEST_SELECTOR_RCPT&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  re </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test_rcpt=/user@example.com some subject/{selector}&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100500</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  one_shot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(222, 71, 0)">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>It&#x27;s noteworthy that data retrieved through selectors is internally cached, allowing you to safely reuse it across multiple regular expressions (in case of <code>Hyperscan</code> support multiple regular expressions will also be composed as usually).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/rspamd/docs.rspamd.com/edit/master/docs/configuration/selectors.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs.rspamd.com/branches/master/configuration/maps"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Rspamd maps</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs.rspamd.com/branches/master/configuration/statistic"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Statistics settings</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#selectors-syntax" class="table-of-contents__link toc-highlight">Selectors syntax</a><ul><li><a href="#operators--vs--order-matters" class="table-of-contents__link toc-highlight">Operators: &#39;:&#39; vs &#39;.&#39; (order matters)</a></li><li><a href="#data-transformation-method" class="table-of-contents__link toc-highlight">Data transformation method</a></li><li><a href="#null-values" class="table-of-contents__link toc-highlight">Null values</a></li></ul></li><li><a href="#selectors-combinations" class="table-of-contents__link toc-highlight">Selectors combinations</a></li><li><a href="#data-definition-functions" class="table-of-contents__link toc-highlight">Data definition functions</a></li><li><a href="#transformation-functions" class="table-of-contents__link toc-highlight">Transformation functions</a><ul><li><a href="#maps-in-transformations" class="table-of-contents__link toc-highlight">Maps in transformations</a></li></ul></li><li><a href="#type-safety" class="table-of-contents__link toc-highlight">Type safety</a></li><li><a href="#common-pitfalls" class="table-of-contents__link toc-highlight">Common pitfalls</a></li><li><a href="#own-selectors" class="table-of-contents__link toc-highlight">Own selectors</a></li><li><a href="#regular-expressions-selectors" class="table-of-contents__link toc-highlight">Regular expressions selectors</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/quickstart">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/configuration">Configuration</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/modules">Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials">Tutorials</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/downloads">Downloads</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/faq">FAQ</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/support">Support</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/changelog">Changelog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/rspamd/rspamd" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/tutorials/site_contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog">Blog</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Subscribe</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/rss/changelog.xml">Changelog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/rss.xml">Blog RSS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs.rspamd.com/branches/master/blog/atom.xml">Blog Atom</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Rspamd Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>